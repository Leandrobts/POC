<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PS4 12.00 FUZZY CONSTRUCTOR HUNTER</title>
    <style>
        body { background: #111; color: #0f0; font-family: 'Consolas', monospace; padding: 20px; text-align: center; }
        textarea { width: 95%; height: 500px; background: #000; color: #fff; border: 1px solid #555; margin-top: 10px; font-size: 13px; }
        button { padding: 15px 30px; background: #004488; color: #fff; border: none; cursor: pointer; font-weight: bold; margin: 10px; }
        .highlight { color: #ffff00; }
    </style>
</head>
<body>
    <h1>FUZZY CONSTRUCTOR HUNTER</h1>
    <p>Alvo: Região da VTable <b>0x3837CC8</b></p>
    <input type="file" id="fileInput" />
    <br>
    <button onclick="scanFuzzy()">VARREDURA DE PROXIMIDADE</button>
    <textarea id="output" readonly>Aguardando...</textarea>

    <script>
        function scanFuzzy() {
            const file = document.getElementById('fileInput').files[0];
            if(!file) return alert("Selecione o arquivo!");

            const reader = new FileReader();
            document.getElementById('output').value = "Varrendo código... (Isso é rápido)";

            reader.onload = function(e) {
                const view = new DataView(e.target.result);
                const len = view.byteLength;
                
                // O endereço da VTable que encontramos
                const VTABLE_TARGET = 0x3837CC8;
                
                // Margem de erro (Para pegar RTTI ou Offset ajustado)
                const RANGE = 64; // +/- 64 bytes
                
                let log = `=== BUSCA FUZZY (Alvo: 0x${VTABLE_TARGET.toString(16)} +/- ${RANGE}) ===\n\n`;
                let found = false;

                // Varre a seção de código (primeiros 10MB)
                // Procurando instruções LEA (48 8D) ou MOV (48 8B) que usem RIP-Relative
                const CODE_LIMIT = Math.min(len, 0x1000000);

                for (let i = 0; i < CODE_LIMIT; i++) {
                    const b1 = view.getUint8(i);
                    const b2 = view.getUint8(i+1);
                    
                    // Padrão: 48 8D (LEA) ou 48 8B (MOV)
                    if (b1 === 0x48 && (b2 === 0x8D || b2 === 0x8B)) {
                        // Offset 32-bit
                        const offset = view.getInt32(i + 3, true);
                        const nextInstr = i + 7;
                        const dest = nextInstr + offset;
                        
                        // Verifica se o destino cai na zona da VTable
                        if (dest >= (VTABLE_TARGET - RANGE) && dest <= (VTABLE_TARGET + RANGE)) {
                            found = true;
                            log += `[ENCONTRADO] Código em 0x${i.toString(16).toUpperCase()} aponta para 0x${dest.toString(16).toUpperCase()}\n`;
                            log += `   (Distância da VTable exata: ${dest - VTABLE_TARGET} bytes)\n`;
                            
                            // AGORA: Procura o tamanho (MOV EDI, SIZE) nos 100 bytes anteriores
                            let sizeLog = analyzeSize(view, i);
                            log(sizeLog);
                            log("---------------------------------------------------\n");
                        }
                    }
                }

                if (!found) log("[-] Nenhuma referência encontrada mesmo com margem.");
                
                document.getElementById('output').value = log;
            };
            reader.readAsArrayBuffer(file);
        }

        function analyzeSize(view, refOffset) {
            let msg = "";
            const start = Math.max(0, refOffset - 100);
            
            for (let k = refOffset; k > start; k--) {
                const b = view.getUint8(k);
                
                // BF = MOV EDI (Arg 1)
                if (b === 0xBF) {
                    const size = view.getInt32(k+1, true);
                    if (size >= 0x20 && size <= 0x800) {
                        msg += `   >>> TAMANHO ENCONTRADO: 0x${size.toString(16).toUpperCase()} (${size} bytes) em 0x${k.toString(16).toUpperCase()}\n`;
                    }
                }
                // BE = MOV ESI (Arg 2)
                else if (b === 0xBE) {
                    const size = view.getInt32(k+1, true);
                    if (size >= 0x20 && size <= 0x800) {
                        msg += `   >>> Alternativa (ESI): 0x${size.toString(16).toUpperCase()} (${size} bytes)\n`;
                    }
                }
            }
            return msg;
        }
        
        function log(txt) {
            // Função auxiliar para append string
            return txt; 
        }
    </script>
</body>
</html>
