<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PS4 12.00 Object Size Hunter</title>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; padding: 20px; text-align: center; }
        textarea { width: 90%; height: 400px; background: #111; color: #fff; border: 1px solid #555; margin-top: 15px; }
        button { padding: 15px 30px; background: #004400; color: #fff; border: 1px solid #0f0; cursor: pointer; font-weight: bold; }
        .highlight { color: #ff00ff; }
    </style>
</head>
<body>

    <h1>SIZE HUNTER (WebKit)</h1>
    <h3>Alvo: Descobrir sizeof(SharedWorker)</h3>
    <p>Carregue: <b>1200_libSceNKWebKit.sprx.elf</b></p>
    
    <input type="file" id="fileInput" />
    <br><br>
    <button onclick="analyzeSize()">ENCONTRAR TAMANHO</button>
    <textarea id="output" readonly>Aguardando...</textarea>

    <script>
        function analyzeSize() {
            const file = document.getElementById('fileInput').files[0];
            if(!file) return alert("Selecione o arquivo!");

            const reader = new FileReader();
            document.getElementById('output').value = "Analisando binário...";

            reader.onload = function(e) {
                const view = new DataView(e.target.result);
                const bytes = new Uint8Array(e.target.result);
                let log = "=== RELATÓRIO DE TAMANHO (SharedWorker) ===\n\n";

                // O offset de código que você encontrou anteriormente
                const TARGET_CODE_REF = 0x839A9B;
                
                // Vamos olhar para trás (Backwards Scan) a partir da referência da string.
                // Geralmente: Aloca Memória (Size) -> Chama Construtor -> Usa String (Nome)
                // Procuramos padrão: BF XX 00 00 00 (MOV EDI, XX)
                
                log(`Analisando arredores de 0x${TARGET_CODE_REF.toString(16).toUpperCase()}...\n`);
                
                // Varre 2000 bytes antes da referência
                const startSearch = Math.max(0, TARGET_CODE_REF - 2000);
                const endSearch = TARGET_CODE_REF;
                
                let candidates = [];

                for(let i = endSearch; i > startSearch; i--) {
                    // Padrão x64 para 'MOV EDI, IMM32' (usado para passar tamanho para malloc/fastMalloc)
                    // Opcode: BF
                    if (bytes[i] === 0xBF) {
                        const size = view.getInt32(i + 1, true); // Little Endian
                        
                        // Filtro de Sanidade: Objetos SharedWorker costumam ter entre 64 (0x40) e 512 (0x200) bytes
                        if (size > 0x20 && size <= 0x400) {
                            // Verifica se é seguido ou precedido por uma CALL (E8)
                            // (Heurística simples)
                            let dist = TARGET_CODE_REF - i;
                            candidates.push({ offset: i, size: size, dist: dist });
                        }
                    }
                }

                if (candidates.length === 0) {
                    log("[-] Nenhum padrão de alocação óbvio encontrado perto da referência.\n");
                } else {
                    log(`[+] Encontrados ${candidates.length} candidatos a tamanho!\n`);
                    log("Os mais prováveis (mais próximos da referência):\n");
                    
                    // Ordena por proximidade
                    candidates.sort((a, b) => a.dist - b.dist);

                    candidates.slice(0, 5).forEach(c => {
                        log(`   OFFSET: 0x${c.offset.toString(16).toUpperCase()}`);
                        log(`   SIZE:   0x${c.size.toString(16).toUpperCase()} (${c.size} bytes)`);
                        log(`   DIST:   ${c.dist} bytes antes da string\n`);
                        log("   -------------------------------------\n");
                    });

                    log("\nRECOMENDAÇÃO: Use o tamanho do primeiro candidato no seu exploit (Spray).");
                }

                document.getElementById('output').value = log;
            };
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>
