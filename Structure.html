<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PS4 12.00 RELATIVE VTABLE SCANNER</title>
    <style>
        body { background: #050505; color: #00ff00; font-family: 'Consolas', monospace; padding: 20px; text-align: center; }
        textarea { width: 95%; height: 500px; background: #111; color: #e0e0e0; border: 1px solid #333; margin-top: 15px; font-size: 13px; }
        button { padding: 15px 30px; background: #440044; color: #fff; border: 1px solid #f0f; cursor: pointer; font-weight: bold; font-size: 16px; }
        .highlight { color: #ff00ff; font-weight: bold; }
    </style>
</head>
<body>
    <h1>RELATIVE VTABLE SCANNER</h1>
    <p>Alvo: Função SharedWorker (Zona <b>0x839A00</b>)</p>
    <input type="file" id="fileInput" />
    <br><br>
    <button onclick="scanRelative()">INICIAR MATEMÁTICA REVERSA</button>
    <textarea id="output" readonly>Aguardando...</textarea>

    <script>
        function scanRelative() {
            const file = document.getElementById('fileInput').files[0];
            if(!file) return alert("Selecione o arquivo ELF!");

            const reader = new FileReader();
            document.getElementById('output').value = "Calculando offsets relativos em 70MB... Aguarde...";

            reader.onload = function(e) {
                const view = new DataView(e.target.result);
                const len = view.byteLength;
                
                // A zona onde sabemos que o código do SharedWorker está (baseado no seu Hex Dump anterior)
                // O código começa por volta de 0x8398A0 e vai até 0x839AD0
                const FUNC_START = 0x839800;
                const FUNC_END   = 0x839B00;
                
                let log = `=== SCANNER RELATIVO (Alvo: 0x${FUNC_START.toString(16)} - 0x${FUNC_END.toString(16)}) ===\n\n`;
                let foundCount = 0;

                // Varre o arquivo inteiro procurando inteiros de 32 bits (alinhados a 4 bytes)
                // A maioria das VTables relativas são arrays de int32.
                
                // Otimização: Começamos a busca na seção .data (geralmente após o código)
                // Mas vamos varrer tudo para garantir.
                
                for (let i = 0; i < len - 4; i += 4) {
                    try {
                        // Lê valor de 32 bits com sinal (pode ser negativo se a vtable estiver depois do código)
                        const offset = view.getInt32(i, true); // Little Endian
                        
                        // A Lógica Relativa: Destino = Posição Atual (i) + Offset
                        const dest = i + offset;
                        
                        // Verifica se o destino cai dentro da função do SharedWorker
                        if (dest >= FUNC_START && dest <= FUNC_END) {
                            foundCount++;
                            log += `[CANDIDATO ENCONTRADO]\n`;
                            log += `   OFFSET NO ARQUIVO (Endereço VTable): 0x${i.toString(16).toUpperCase()}\n`;
                            log += `   VALOR (Offset Relativo):             0x${offset.toString(16).toUpperCase()}\n`;
                            log += `   APONTA PARA (Código):                0x${dest.toString(16).toUpperCase()}\n`;
                            
                            // Verifica se é uma sequência (VTable real tem vários ponteiros seguidos)
                            // Vamos olhar o próximo valor (+4)
                            if (i + 8 < len) {
                                const nextOff = view.getInt32(i+4, true);
                                const nextDest = (i+4) + nextOff;
                                log += `   [Vizinho +4] Aponta para: 0x${nextDest.toString(16).toUpperCase()}\n`;
                            }
                            
                            log += `   -----------------------------------------------------\n`;
                        }
                    } catch(e){}
                }

                if (foundCount === 0) {
                    log += "[-] Nenhum ponteiro relativo encontrado.\n";
                    log += "    Possibilidade: A VTable usa um 'Base Address' diferente da sua própria posição.\n";
                } else {
                    log(`\n[SUCESSO] Encontrados ${foundCount} candidatos.\n`);
                    log("O Offset da VTable é o número 'OFFSET NO ARQUIVO'.");
                }

                document.getElementById('output').value = log;
            };
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>
