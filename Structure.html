<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PS4 12.00 VTABLE HUNTER V2</title>
    <style>
        body { background: #111; color: #0f0; font-family: 'Consolas', monospace; padding: 20px; text-align: center; }
        textarea { width: 90%; height: 500px; background: #000; color: #fff; border: 1px solid #555; margin-top: 10px; font-size: 12px; }
        button { padding: 15px 30px; background: #006600; color: #fff; border: 1px solid #0f0; cursor: pointer; font-weight: bold; margin: 10px; }
    </style>
</head>
<body>
    <h1>VTABLE HUNTER V2 (Function Start)</h1>
    <p>Alvo: SharedWorker (Ref: 0x839A98)</p>
    <input type="file" id="fileInput" />
    <br>
    <button onclick="startScan()">LOCALIZAR VTABLE</button>
    <textarea id="output" readonly>Aguardando...</textarea>

    <script>
        function startScan() {
            const file = document.getElementById('fileInput').files[0];
            if(!file) return alert("Selecione o arquivo!");

            const reader = new FileReader();
            document.getElementById('output').value = "Analisando...";

            reader.onload = function(e) {
                const view = new DataView(e.target.result);
                const bytes = new Uint8Array(e.target.result);
                let log = "=== RASTREAMENTO DE VTABLE (SharedWorker) ===\n\n";

                // O ponto onde o código usa a string "SharedWorker"
                const CODE_REF = 0x839A98; 
                log += `[1] Referência de código: 0x${CODE_REF.toString(16).toUpperCase()}\n`;

                // 2. Encontrar o Início da Função (Prologue Hunter)
                // Procuramos para trás por padrões de início de função x64:
                // 55 48 89 E5 (push rbp; mov rbp, rsp)
                // 56 41 57 (push rsi; push r15...)
                
                let funcStart = -1;
                // Varre até 500 bytes para trás
                for(let i = CODE_REF; i > CODE_REF - 500; i--) {
                    // Padrão clássico: PUSH RBP; MOV RBP, RSP
                    if (bytes[i] === 0x55 && bytes[i+1] === 0x48 && bytes[i+2] === 0x89 && bytes[i+3] === 0xE5) {
                        funcStart = i;
                        log += `[2] Provável início de função encontrado em: 0x${i.toString(16).toUpperCase()}\n`;
                        break; 
                    }
                }

                if (funcStart === -1) {
                    log("[-] Não achei o prólogo padrão (55 48 89 E5). Tentando heurística de padding (CC CC)...\n");
                    // Tenta achar alinhamento de função (INT3 / NOPs)
                    for(let i = CODE_REF; i > CODE_REF - 500; i--) {
                        if (bytes[i] === 0xCC && bytes[i-1] === 0xCC) {
                            funcStart = i + 1;
                            log += `[2] Início detectado após padding em: 0x${funcStart.toString(16).toUpperCase()}\n`;
                            break;
                        }
                    }
                }

                if (funcStart !== -1) {
                    // 3. Encontrar quem aponta para o Início da Função (A VTable)
                    log(`[3] Procurando ponteiros para 0x${funcStart.toString(16).toUpperCase()}...\n`);
                    
                    const targetBig = BigInt(funcStart);
                    let foundVt = false;

                    // Varre o arquivo procurando esse endereço (8 bytes)
                    // Alinhado a 8 bytes
                    for(let i = 0; i < view.byteLength - 8; i+=8) {
                        try {
                            const val = view.getBigUint64(i, true); // Little Endian
                            if (val === targetBig) {
                                foundVt = true;
                                log += `\n>>> [!!!] PONTEIRO ENCONTRADO EM: 0x${i.toString(16).toUpperCase()} [!!!] <<<\n`;
                                log += `    Este endereço (0x${i.toString(16).toUpperCase()}) contém o ponteiro para a função do SharedWorker.\n`;
                                log += `    É muito provável que este seja um slot da VTable.\n`;
                                
                                // Tenta identificar o INÍCIO da VTable
                                // Em C++, a VTable começa com [Offset to Top] [RTTI Ptr] [Func1] [Func2]...
                                // Se este é o primeiro método virtual, a VTable começa 16 bytes antes (-0x10).
                                // Se é o segundo, -0x18, etc.
                                
                                // Vamos assumir que é um dos primeiros.
                                log(`    OFFSET POTENCIAL DA VTABLE (BASE): 0x${(i - 16).toString(16).toUpperCase()} (Estimado)\n`);
                                log(`    ANOTE ESTE NÚMERO: 0x${i.toString(16).toUpperCase()}\n`);
                            }
                        } catch(e){}
                    }

                    if (!foundVt) {
                        log("[-] Nenhum ponteiro direto encontrado. A VTable pode usar offsets relativos (PIC).");
                    }
                } else {
                    log("[-] Falha ao encontrar início da função.");
                }

                document.getElementById('output').value = log;
            };
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>
