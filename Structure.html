<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PS4 12.00 VTABLE PATTERN SCAN</title>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; padding: 20px; text-align: center; }
        textarea { width: 95%; height: 500px; background: #111; color: #eee; border: 1px solid #444; margin-top: 15px; }
        button { padding: 15px 40px; background: #550088; color: #fff; border: none; cursor: pointer; font-weight: bold; font-size: 16px; margin: 10px; }
    </style>
</head>
<body>
    <h1>VTABLE PATTERN SCANNER</h1>
    <p>Busca heurística por tabelas de funções virtuais (EventTarget/Worker)</p>
    <input type="file" id="fileInput" />
    <br>
    <button onclick="scanPatterns()">INICIAR SCAN DE PADRÕES</button>
    <textarea id="output" readonly>Aguardando...</textarea>

    <script>
        function log(msg) {
            document.getElementById('output').value += msg + "\n";
        }

        function scanPatterns() {
            const file = document.getElementById('fileInput').files[0];
            if(!file) return alert("Selecione o arquivo!");

            const reader = new FileReader();
            document.getElementById('output').value = "Escaneando padrões de VTable...\n";

            reader.onload = function(e) {
                const view = new DataView(e.target.result);
                const len = view.byteLength;
                
                // Limites aproximados da seção .data / .rdata
                // Em ELFs grandes, geralmente começa após o código.
                // Vamos chutar que o código acaba em 20MB e os dados começam lá.
                const START_SCAN = 0x1000000; 
                
                let candidates = [];

                // Varre de 8 em 8 bytes (Ponteiros)
                for (let i = START_SCAN; i < len - 64; i += 8) {
                    // Heurística de VTable:
                    // Uma VTable é uma sequência de ponteiros que apontam para a seção de CÓDIGO (Text).
                    // O Text Segment geralmente vai de 0x0 a 0x2000000 (32MB).
                    
                    let isVtable = true;
                    let ptrs = [];
                    
                    // Verifica se os próximos 6 qwords parecem ponteiros de função válidos
                    for (let k = 0; k < 6; k++) {
                        const ptr = Number(view.getBigUint64(i + (k*8), true));
                        // Checa se aponta para uma região de código válida (ex: < 15MB) e é alinhado
                        if (ptr < 0x400 || ptr > 0x1500000 || (ptr % 2 !== 0)) {
                            isVtable = false;
                            break;
                        }
                        ptrs.push(ptr);
                    }

                    if (isVtable) {
                        // Verifica se os ponteiros estão "próximos" (funções da mesma classe costumam estar perto)
                        let spread = Math.max(...ptrs) - Math.min(...ptrs);
                        if (spread < 0x50000) { // Funções espalhadas por no máximo 300KB
                            candidates.push({ offset: i, ptrs: ptrs });
                            i += 48; // Pula esta tabela
                        }
                    }
                }

                log(`Encontrados ${candidates.length} candidatos a VTable.\n`);
                log("Filtrando pelos candidatos mais prováveis (Perto das strings de Worker)...\n");

                // String Refs conhecidas (do seu scan anterior)
                const STR_REFS = [0x2B1B91B, 0x2B1B921, 0x2D094F1]; // SharedWorker, Worker, MessagePort

                candidates.forEach(c => {
                    // Checa se algum dos ponteiros da tabela aponta para código perto das strings?
                    // Não, a string é dados. O código aponta para a string.
                    // A VTable aponta para o código.
                    
                    // Vamos mostrar apenas as VTables que estão na região de dados comum (ex: 0x2XXXXXX)
                    if (c.offset > 0x2000000 && c.offset < 0x3000000) {
                        log(`[CANDIDATO] VTable em: 0x${c.offset.toString(16).toUpperCase()}`);
                        log(`   Aponta para funções: 0x${c.ptrs[0].toString(16)}, 0x${c.ptrs[1].toString(16)}...`);
                        log("------------------------------------------------");
                    }
                });
            };
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>
