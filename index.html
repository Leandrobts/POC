<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit Lifecycle Diagnostic</title>
<style>
body { font-family: monospace; }
iframe { width: 100%; height: 320px; border: 1px solid black; }
pre { background:#eee; padding:10px; }
</style>
</head>
<body>

<h2>PARENT LOGGER</h2>
<pre id="log"></pre>

<iframe id="f"></iframe>

<script>
const log = m => document.getElementById("log").textContent += m + "\n";
log("[PARENT] Loaded");

window.addEventListener("message", e => log("[MSG] " + e.data));

document.getElementById("f").srcdoc = `
<!DOCTYPE html>
<html>
<body>
<button onclick="start()">START</button>
<pre id="l"></pre>

<script>
let counts = {
  blur:0, focus:0,
  visibility:0,
  pagehide:0, pageshow:0,
  fullscreen:0
};

function send(m){ parent.postMessage(m, "*"); }

function dump(tag){
  send(tag + " " + JSON.stringify(counts));
}

function start(){
  send("[START] clicked");

  document.addEventListener("visibilitychange", () => {
    counts.visibility++;
    send("[EVENT] visibilitychange -> " + document.visibilityState);
  });

  window.addEventListener("blur", () => {
    counts.blur++;
    send("[EVENT] blur #" + counts.blur);
    dump("[COUNTS@BLUR]");
    teardown();
  });

  window.addEventListener("focus", () => {
    counts.focus++;
    send("[EVENT] focus");
  });

  window.addEventListener("pagehide", e => {
    counts.pagehide++;
    send("[EVENT] pagehide persisted=" + e.persisted);
  });

  window.addEventListener("pageshow", e => {
    counts.pageshow++;
    send("[EVENT] pageshow persisted=" + e.persisted);
  });

  document.addEventListener("fullscreenchange", () => {
    counts.fullscreen++;
    send("[EVENT] fullscreenchange active=" + !!document.fullscreenElement);
  });

  document.documentElement.webkitRequestFullscreen();
  send("[STATE] fullscreen requested");
}

function teardown(){
  send("[TEARDOWN] Phase 1: remove handlers");
  window.onblur = null;
  window.onfocus = null;

  dump("[COUNTS@PHASE1]");

  send("[TEARDOWN] Phase 2: exit fullscreen");
  try { document.webkitExitFullscreen(); } catch(e){}

  dump("[COUNTS@PHASE2]");

  send("[TEARDOWN] Phase 3: document.write");
  dump("[COUNTS@BEFORE_WRITE]");

  document.open();
  document.write("<html><body>teardown</body></html>");
  document.close();
}
<\/script>
</body>
</html>
`;
</script>

</body>
</html>
