<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 Memory Corruption Tests</title>
</head>
<body>
    <h1>PS4 Memory Corruption Tests (No DoS)</h1>
    
    <button onclick="test01()">01: ArrayBuffer Detach UAF</button>
    <button onclick="test02()">02: TypedArray View Confusion</button>
    <button onclick="test03()">03: Array Butterfly Realloc</button>
    <button onclick="test04()">04: Object Structure Transition</button>
    <button onclick="test05()">05: Prototype Corruption</button>
    <button onclick="test06()">06: Getter Side Effect</button>
    <button onclick="test07()">07: Array Sort Comparator</button>
    <button onclick="test08()">08: String Rope Confusion</button>
    <button onclick="test09()">09: RegExp LastIndex Corrupt</button>
    <button onclick="test10()">10: DOM Node Detached Access</button>
    <button onclick="test11()">11: Event Listener UAF</button>
    <button onclick="test12()">12: Range Extract UAF</button>
    <button onclick="test13()">13: TextNode Split Corruption</button>
    <button onclick="test14()">14: Attribute Node Stale</button>
    <button onclick="test15()">15: Canvas Backing Store</button>
    <button onclick="test16()">16: ImageData Detach Race</button>
    <button onclick="test17()">17: Worker Buffer Transfer</button>
    <button onclick="test18()">18: MessagePort Close UAF</button>
    <button onclick="test19()">19: Blob Slice Corruption</button>
    <button onclick="test20()">20: FileReader Result UAF</button>
    <button onclick="test21()">21: History State Reference</button>
    <button onclick="test22()">22: URL Object Revoke</button>
    <button onclick="test23()">23: Promise Then Mutation</button>
    <button onclick="test24()">24: Proxy Handler Confuse</button>
    <button onclick="test25()">25: Map Iterator Invalidate</button>
    <button onclick="test26()">26: Set Iterator Delete</button>
    <button onclick="test27()">27: WeakMap Key GC</button>
    <button onclick="test28()">28: Symbol Property Access</button>
    <button onclick="test29()">29: Generator Yield UAF</button>
    <button onclick="test30()">30: Async Await Confusion</button>
    <button onclick="test31()">31: DataView Endian Mix</button>
    <button onclick="test32()">32: ArrayBuffer Slice Overlap</button>
    <button onclick="test33()">33: SharedWorker Proxy Race</button>
    <button onclick="test34()">34: Document Write Detach</button>
    <button onclick="test35()">35: Iframe ContentDocument</button>
    <button onclick="test36()">36: FormData Entry Stale</button>
    <button onclick="test37()">37: NodeList Live Mutation</button>
    <button onclick="test38()">38: HTMLCollection Stale</button>
    <button onclick="test39()">39: NamedNodeMap Sync</button>
    <button onclick="test40()">40: CSSStyleSheet Rule UAF</button>
    <button onclick="test41()">41: ComputedStyle Detach</button>
    <button onclick="test42()">42: MutationObserver Callback</button>
    <button onclick="test43()">43: IntersectionObserver Entry</button>
    <button onclick="test44()">44: ResizeObserver Entry</button>
    <button onclick="test45()">45: TreeWalker Reference</button>
    <button onclick="test46()">46: NodeIterator Reference</button>
    <button onclick="test47()">47: XPathResult Snapshot</button>
    <button onclick="test48()">48: Selection Range Stale</button>
    <button onclick="test49()">49: Clipboard Data Access</button>
    <button onclick="test50()">50: StorageEvent Origin</button>

    <script>
        function test01() {
            const buffer = new ArrayBuffer(8192);
            const view = new Uint8Array(buffer);
            view[0] = 0x41;
            
            const w = new Worker(URL.createObjectURL(new Blob(["onmessage=e=>{}"], {type:"text/javascript"})));
            w.postMessage(buffer, [buffer]);
            
            setTimeout(() => {
                try {
                    view[0] = 0x42;
                    const val = view[0];
                } catch(e) {}
                w.terminate();
            }, 10);
        }

        function test02() {
            const buffer = new ArrayBuffer(1024);
            const u8 = new Uint8Array(buffer);
            const u32 = new Uint32Array(buffer);
            const f64 = new Float64Array(buffer);
            
            u32[0] = 0xDEADBEEF;
            f64[0] = 3.14159;
            const confused = u32[0];
            
            u8[0] = 0xFF;
            const check = u32[0];
        }

        function test03() {
            const arr = [1, 2, 3];
            
            for (let i = 0; i < 10; i++) {
                arr.push(i);
            }
            
            arr.length = 3;
            arr.length = 100;
            
            arr[50] = {
                valueOf: function() {
                    arr.length = 0;
                    return 42;
                }
            };
            
            arr.sort();
        }

        function test04() {
            const obj = {a: 1, b: 2, c: 3};
            
            delete obj.b;
            obj.b = {nested: new ArrayBuffer(512)};
            
            delete obj.c;
            obj.d = 4;
            
            Object.defineProperty(obj, 'e', {
                get: function() {
                    delete obj.a;
                    return 5;
                }
            });
            
            const val = obj.e;
        }

        function test05() {
            const proto = {x: 1};
            const obj = Object.create(proto);
            
            Object.defineProperty(obj, 'trigger', {
                get: function() {
                    Object.setPrototypeOf(this, null);
                    return this.x;
                }
            });
            
            const val = obj.trigger;
        }

        function test06() {
            const target = {val: 1};
            
            Object.defineProperty(target, 'prop', {
                get: function() {
                    delete target.val;
                    target.val = new Uint8Array(100);
                    return target.val;
                },
                set: function(v) {
                    target.buffer = new ArrayBuffer(v);
                }
            });
            
            target.prop = 1024;
            const result = target.prop;
        }

        function test07() {
            const arr = [1, 2, 3, 4, 5];
            const buffer = new ArrayBuffer(1024);
            
            arr.sort((a, b) => {
                arr.length = 0;
                arr.push(new Uint8Array(buffer));
                return a - b;
            });
        }

        function test08() {
            let str1 = 'A'.repeat(1000);
            let str2 = 'B'.repeat(1000);
            
            let rope = str1 + str2;
            
            str1 = null;
            str2 = null;
            
            const char = rope[500];
        }

        function test09() {
            const regex = /test/g;
            
            const obj = {
                toString: function() {
                    regex.lastIndex = 1000;
                    return "test";
                }
            };
            
            regex.test(obj);
        }

        function test10() {
            const container = document.createElement('div');
            const child = document.createElement('span');
            container.appendChild(child);
            document.body.appendChild(container);
            
            document.body.removeChild(container);
            
            setTimeout(() => {
                child.textContent = "UAF";
                const text = child.textContent;
            }, 10);
        }

        function test11() {
            const elem = document.createElement('div');
            document.body.appendChild(elem);
            
            const handler = function() {
                document.body.removeChild(elem);
                elem.textContent = "Modified";
            };
            
            elem.addEventListener('click', handler);
            elem.click();
        }

        function test12() {
            const container = document.createElement('div');
            for (let i = 0; i < 10; i++) {
                container.appendChild(document.createElement('span'));
            }
            document.body.appendChild(container);
            
            const range = document.createRange();
            range.selectNodeContents(container);
            const fragment = range.extractContents();
            
            document.body.removeChild(container);
            
            setTimeout(() => {
                fragment.firstChild.textContent = "UAF";
            }, 10);
        }

        function test13() {
            const textNode = document.createTextNode('A'.repeat(100));
            const container = document.createElement('div');
            container.appendChild(textNode);
            document.body.appendChild(container);
            
            const split = textNode.splitText(50);
            
            document.body.removeChild(container);
            
            setTimeout(() => {
                split.textContent = "Modified";
            }, 10);
        }

        function test14() {
            const elem = document.createElement('div');
            elem.setAttribute('data-test', 'value');
            document.body.appendChild(elem);
            
            const attr = elem.attributes[0];
            
            document.body.removeChild(elem);
            
            setTimeout(() => {
                attr.value = "Modified";
                const val = attr.value;
            }, 10);
        }

        function test15() {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            const imageData = ctx.createImageData(512, 512);
            const data = imageData.data;
            data[0] = 0xFF;
            
            canvas.width = 256;
            
            setTimeout(() => {
                data[0] = 0xAA;
                const val = data[0];
            }, 10);
        }

        function test16() {
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 256;
            const ctx = canvas.getContext('2d');
            
            const imageData = ctx.getImageData(0, 0, 256, 256);
            
            canvas.width = 512;
            
            ctx.putImageData(imageData, 0, 0);
        }

        function test17() {
            const buffer = new ArrayBuffer(1024);
            const view = new Uint8Array(buffer);
            const subarray = view.subarray(0, 512);
            
            const w = new Worker(URL.createObjectURL(new Blob(["onmessage=e=>{}"], {type:"text/javascript"})));
            w.postMessage(buffer, [buffer]);
            
            setTimeout(() => {
                subarray[0] = 0xFF;
                w.terminate();
            }, 10);
        }

        function test18() {
            const mc = new MessageChannel();
            
            mc.port1.onmessage = function(e) {
                mc.port1.close();
                mc.port1.postMessage("UAF");
            };
            
            mc.port1.start();
            mc.port2.postMessage("trigger");
        }

        function test19() {
            const original = new Blob([new Uint8Array([0x41, 0x42, 0x43, 0x44])]);
            const slice = original.slice(0, 2);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const result = new Uint8Array(e.target.result);
                result[0] = 0xFF;
            };
            reader.readAsArrayBuffer(slice);
        }

        function test20() {
            const blob = new Blob([new Uint8Array(100)]);
            const reader = new FileReader();
            
            reader.onload = function(e) {
                reader.abort();
                const result = e.target.result;
            };
            
            reader.readAsArrayBuffer(blob);
        }

        function test21() {
            const state = {
                buffer: new ArrayBuffer(1024),
                view: null
            };
            
            state.view = new Uint8Array(state.buffer);
            
            history.pushState(state, '', '#test');
            
            setTimeout(() => {
                const current = history.state;
                if (current) {
                    current.view[0] = 0xFF;
                }
            }, 10);
        }

        function test22() {
            const blob = new Blob([new Uint8Array(100)]);
            const url = URL.createObjectURL(blob);
            
            URL.revokeObjectURL(url);
            
            setTimeout(() => {
                const img = new Image();
                img.src = url;
            }, 10);
        }

        function test23() {
            const obj = {data: new ArrayBuffer(512)};
            
            Promise.resolve(obj).then(result => {
                obj.data = null;
                const view = new Uint8Array(result.data);
                view[0] = 0xFF;
            });
        }

        function test24() {
            const target = {value: 1};
            
            const handler = {
                get: function(obj, prop) {
                    if (prop === 'trigger') {
                        delete obj.value;
                        obj.value = new ArrayBuffer(1024);
                    }
                    return obj[prop];
                }
            };
            
            const proxy = new Proxy(target, handler);
            const val = proxy.trigger;
            const check = proxy.value;
        }

        function test25() {
            const map = new Map();
            map.set('a', {buffer: new ArrayBuffer(512)});
            map.set('b', 2);
            
            const iter = map[Symbol.iterator]();
            
            map.delete('a');
            map.set('c', 3);
            
            iter.next();
        }

        function test26() {
            const set = new Set();
            const obj = {data: new ArrayBuffer(512)};
            set.add(obj);
            set.add(2);
            
            const iter = set[Symbol.iterator]();
            
            set.delete(obj);
            set.add(3);
            
            iter.next();
        }

        function test27() {
            const wm = new WeakMap();
            let key = {id: 1};
            wm.set(key, {buffer: new ArrayBuffer(1024)});
            
            const ref = wm.get(key);
            key = null;
            
            setTimeout(() => {
                const view = new Uint8Array(ref.buffer);
                view[0] = 0xFF;
            }, 100);
        }

        function test28() {
            const sym = Symbol('test');
            const obj = {};
            
            Object.defineProperty(obj, sym, {
                get: function() {
                    delete obj[sym];
                    obj[sym] = new ArrayBuffer(512);
                    return obj[sym];
                }
            });
            
            const val = obj[sym];
        }

        function test29() {
            const buffer = new ArrayBuffer(512);
            
            function* gen() {
                const view = new Uint8Array(buffer);
                yield view;
                view[0] = 0xFF;
            }
            
            const g = gen();
            const result = g.next().value;
            g.next();
        }

        function test30() {
            const buffer = new ArrayBuffer(512);
            
            async function test() {
                const view = new Uint8Array(buffer);
                await Promise.resolve();
                view[0] = 0xFF;
            }
            
            test();
        }

        function test31() {
            const buffer = new ArrayBuffer(16);
            const dv = new DataView(buffer);
            
            dv.setUint32(0, 0xDEADBEEF, true);
            const le = dv.getUint32(0, true);
            const be = dv.getUint32(0, false);
        }

        function test32() {
            const buffer = new ArrayBuffer(1024);
            const view = new Uint8Array(buffer);
            
            const slice1 = buffer.slice(0, 512);
            const slice2 = buffer.slice(256, 768);
            
            const v1 = new Uint8Array(slice1);
            const v2 = new Uint8Array(slice2);
            
            v1[256] = 0xFF;
            const check = v2[0];
        }

        function test33() {
            const code = `
                let port;
                onmessage = e => {
                    port = e.ports[0];
                    setInterval(() => {
                        try { port.postMessage('ping'); } catch(e) {}
                    }, 10);
                }
            `;
            
            const w = new SharedWorker(URL.createObjectURL(new Blob([code], {type:"text/javascript"})), 'test');
            const mc = new MessageChannel();
            
            w.port.start();
            w.port.postMessage('init', [mc.port2]);
            
            setTimeout(() => {
                mc.port1.close();
            }, 20);
        }

        function test34() {
            const iframe = document.createElement('iframe');
            document.body.appendChild(iframe);
            
            const doc = iframe.contentDocument;
            doc.open();
            doc.write('<div id="test">Content</div>');
            
            document.body.removeChild(iframe);
            
            setTimeout(() => {
                doc.write('<div>More</div>');
            }, 10);
        }

        function test35() {
            const iframe = document.createElement('iframe');
            document.body.appendChild(iframe);
            
            const doc = iframe.contentDocument;
            const elem = doc.createElement('div');
            doc.body.appendChild(elem);
            
            document.body.removeChild(iframe);
            
            setTimeout(() => {
                elem.textContent = "UAF";
            }, 10);
        }

        function test36() {
            const fd = new FormData();
            const blob = new Blob([new Uint8Array(100)]);
            fd.append('file', blob);
            
            const entries = Array.from(fd.entries());
            
            fd.delete('file');
            
            setTimeout(() => {
                const entry = entries[0];
                if (entry) {
                    const file = entry[1];
                }
            }, 10);
        }

        function test37() {
            const container = document.createElement('div');
            for (let i = 0; i < 5; i++) {
                container.appendChild(document.createElement('span'));
            }
            document.body.appendChild(container);
            
            const nodeList = container.childNodes;
            const snapshot = Array.from(nodeList);
            
            container.removeChild(container.firstChild);
            
            snapshot[0].textContent = "Modified";
        }

        function test38() {
            const container = document.createElement('div');
            for (let i = 0; i < 5; i++) {
                container.appendChild(document.createElement('span'));
            }
            document.body.appendChild(container);
            
            const collection = container.children;
            const first = collection[0];
            
            container.removeChild(first);
            
            setTimeout(() => {
                first.textContent = "UAF";
            }, 10);
        }

        function test39() {
            const elem = document.createElement('div');
            elem.setAttribute('a', '1');
            elem.setAttribute('b', '2');
            
            const attrs = elem.attributes;
            const attrA = attrs[0];
            
            elem.removeAttribute('a');
            
            setTimeout(() => {
                attrA.value = "Modified";
            }, 10);
        }

        function test40() {
            const style = document.createElement('style');
            document.head.appendChild(style);
            
            style.sheet.insertRule('.test { color: red; }', 0);
            const rule = style.sheet.cssRules[0];
            
            style.sheet.deleteRule(0);
            
            setTimeout(() => {
                rule.style.color = "blue";
            }, 10);
        }

        function test41() {
            const elem = document.createElement('div');
            elem.style.width = '100px';
            document.body.appendChild(elem);
            
            const computed = window.getComputedStyle(elem);
            const width = computed.width;
            
            document.body.removeChild(elem);
            
            setTimeout(() => {
                const newWidth = computed.width;
            }, 10);
        }

        function test42() {
            const target = document.createElement('div');
            document.body.appendChild(target);
            
            let record = null;
            
            const observer = new MutationObserver(mutations => {
                record = mutations[0];
                document.body.removeChild(target);
            });
            
            observer.observe(target, {childList: true});
            target.appendChild(document.createElement('span'));
            
            setTimeout(() => {
                if (record) {
                    const node = record.target;
                }
            }, 10);
        }

        function test43() {
            if (!window.IntersectionObserver) return;
            
            const elem = document.createElement('div');
            document.body.appendChild(elem);
            
            let entry = null;
            
            const observer = new IntersectionObserver(entries => {
                entry = entries[0];
                document.body.removeChild(elem);
            });
            
            observer.observe(elem);
            
            setTimeout(() => {
                if (entry) {
                    const target = entry.target;
                }
            }, 10);
        }

        function test44() {
            if (!window.ResizeObserver) return;
            
            const elem = document.createElement('div');
            elem.style.width = '100px';
            document.body.appendChild(elem);
            
            let entry = null;
            
            const observer = new ResizeObserver(entries => {
                entry = entries[0];
                document.body.removeChild(elem);
            });
            
            observer.observe(elem);
            elem.style.width = '200px';
            
            setTimeout(() => {
                if (entry) {
                    const target = entry.target;
                }
            }, 10);
        }

        function test45() {
            const container = document.createElement('div');
            for (let i = 0; i < 5; i++) {
                container.appendChild(document.createElement('span'));
            }
            document.body.appendChild(container);
            
            const walker = document.createTreeWalker(container, NodeFilter.SHOW_ELEMENT);
            const first = walker.nextNode();
            
            document.body.removeChild(container);
            
            setTimeout(() => {
                walker.nextNode();
            }, 10);
        }

        function test46() {
            const container = document.createElement('div');
            for (let i = 0; i < 5; i++) {
                container.appendChild(document.createElement('span'));
            }
            document.body.appendChild(container);
            
            const iterator = document.createNodeIterator(container, NodeFilter.SHOW_ELEMENT);
            const first = iterator.nextNode();
            
            document.body.removeChild(container);
            
            setTimeout(() => {
                iterator.nextNode();
            }, 10);
        }

        function test47() {
            if (!document.evaluate) return;
            
            const container = document.createElement('div');
            for (let i = 0; i < 5; i++) {
                container.appendChild(document.createElement('span'));
            }
            document.body.appendChild(container);
            
            const result = document.evaluate('//span', container, null, XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
            
            document.body.removeChild(container);
            
            setTimeout(() => {
                const node = result.snapshotItem(0);
                if (node) node.textContent = "UAF";
            }, 10);
        }

        function test48() {
            const container = document.createElement('div');
            container.contentEditable = true;
            container.innerHTML = 'Test content';
            document.body.appendChild(container);
            
            const range = document.createRange();
            range.selectNodeContents(container);
            
            const selection = window.getSelection();
            selection.addRange(range);
            
            document.body.removeChild(container);
            
            setTimeout(() => {
                range.deleteContents();
            }, 10);
        }

        function test49() {
            const textarea = document.createElement('textarea');
            textarea.value = 'Test';
            document.body.appendChild(textarea);
            
            let clipData = null;
            
            document.addEventListener('copy', function handler(e) {
                clipData = e.clipboardData;
                document.removeEventListener('copy', handler);
            }, {once: true});
            
            textarea.select();
            document.execCommand('copy');
            
            setTimeout(() => {
                if (clipData) {
                    clipData.setData('text/plain', 'Modified');
                }
            }, 10);
        }

        function test50() {
            let event = null;
            
            window.addEventListener('storage', function(e) {
                event = e;
            }, {once: true});
            
            localStorage.setItem('test', 'value');
            
            setTimeout(() => {
                if (event) {
                    const url = event.url;
                    const key = event.key;
                }
            }, 10);
        }
    </script>
</body>
</html>
