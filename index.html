
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>History API – Matrix A1–A7 Verification</title>
<style>
body { font-family: monospace; background:#111; color:#0f0; }
button { margin:4px; padding:6px; }
pre { background:#000; padding:8px; height:300px; overflow:auto; }
</style>
</head>
<body>

<h2>History / Navigation – Test Matrix A1–A7</h2>

<button onclick="A1()">A1 – Sequência mínima</button>
<button onclick="A2()">A2 – Payload mínimo</button>
<button onclick="A3()">A3 – URLs distintas</button>
<button onclick="A4()">A4 – Timing / Race</button>
<button onclick="A5()">A5 – GC antes do back</button>
<button onclick="A6()">A6 – Retenção artificial</button>
<button onclick="A7()">A7 – Heartbeat do crash</button>

<pre id="log"></pre>

<script>
const logEl = document.getElementById("log");
function log(m){ logEl.textContent += m + "\n"; }

/* GC PRESSURE */
function forceGC() {
    log("[GC] Pressionando GC...");
    let junk = [];
    for (let i = 0; i < 20000; i++) {
        junk.push(new ArrayBuffer(1024 * 50));
    }
}

/* ============================
   A1 – Sequência mínima
   ============================ */
function A1() {
    log("\n[A1] push → replace → back");
    history.pushState({a:1}, "", "#a1");
    history.replaceState({b:2}, "", "#a2");
    log("[A1] Antes do back()");
    history.back();
    log("[A1] Após back() (se logar, não crashou)");
}

/* ============================
   A2 – Payload mínimo
   ============================ */
function A2() {
    log("\n[A2] Payload {}");
    history.pushState({}, "", "#p0");
    history.replaceState({}, "", "#p1");
    history.back();
    log("[A2] Executado");
}

/* ============================
   A3 – URLs distintas
   ============================ */
function A3() {
    log("\n[A3] URLs distintas");
    history.pushState({x:1}, "", "#u" + Math.random());
    history.replaceState({y:2}, "", "#v" + Math.random());
    history.back();
    log("[A3] Executado");
}

/* ============================
   A4 – Timing / Race
   ============================ */
function A4() {
    log("\n[A4] back() com setTimeout(0)");
    history.pushState({r:1}, "", "#r1");
    history.replaceState({r:2}, "", "#r2");
    setTimeout(() => {
        log("[A4] back() async");
        history.back();
        log("[A4] Após back()");
    }, 0);
}

/* ============================
   A5 – GC antes do rollback
   ============================ */
function A5() {
    log("\n[A5] GC antes do back()");
    history.pushState({g:1}, "", "#g1");
    history.replaceState({g:2}, "", "#g2");
    forceGC();
    log("[A5] GC feito, chamando back()");
    history.back();
    log("[A5] Após back()");
}

/* ============================
   A6 – Retenção artificial
   ============================ */
let retainedState;
function A6() {
    log("\n[A6] Retendo referências");
    let state = {k:1};
    retainedState = state;
    history.pushState(state, "", "#k1");
    history.replaceState(state, "", "#k2");
    log("[A6] Referência retida");
    history.back();
    log("[A6] Após back()");
}

/* ============================
   A7 – Heartbeat do crash
   ============================ */
function A7() {
    log("\n[A7] Heartbeat detalhado");
    log("[A7] Step 1: push");
    history.pushState({h:1}, "", "#h1");

    log("[A7] Step 2: replace");
    history.replaceState({h:2}, "", "#h2");

    log("[A7] Step 3: GC");
    forceGC();

    log("[A7] Step 4: back()");
    history.back();

    log("[A7] Step 5: END (se aparecer, não crashou)");
}
</script>

</body>
</html>
