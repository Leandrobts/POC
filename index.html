<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – State vs Fragment Split</title>

</head>

<body>
<h2>PS4 WebKit – State vs Fragment Split</h2>

<button onclick="runR1()">R1 – FRAGMENT muda / STATE FIXO</button>
<button onclick="runR2()">R2 – FRAGMENT FIXO / STATE muda</button>
<button onclick="runR3()">R3 – BASELINE (ambos mudam)</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m, cls=""){
    const s = document.createElement("span");
    if(cls) s.className = cls;
    s.textContent = m + "\n";
    logEl.appendChild(s);
    logEl.scrollTop = logEl.scrollHeight;
}
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

const BASE = 977;
const STEP = 14461;
const ITERS = 50;

// ---------------------------
// Core runner
// mode:
//  1 = fragment muda / state fixo
//  2 = fragment fixo / state muda
//  3 = ambos mudam (baseline)
// ---------------------------
async function run(mode){
    logEl.textContent = "";
    log(`=== START MODE ${mode} ===`, "crit");
    log("BASE=977 STEP=14461 ITERS=50\n");

    let size = BASE;

    // Estado fixo (R1)
    const fixedState = { tag: "FIXED_STATE", x: 1 };

    for(let i=0;i<ITERS;i++){
        let fragment;
        let state;

        // Fragment alternante apenas no trecho crítico
        if(i >= 46){
            fragment = (i % 2 === 0) ? "A".repeat(32) : "B".repeat(size);
        } else {
            fragment = "A".repeat(size);
        }

        // Seleção por modo
        if(mode === 1){
            // R1: fragment muda, state fixo
            state = fixedState;
        } else if(mode === 2){
            // R2: fragment fixo, state muda
            fragment = "#FIXED_FRAGMENT";
            state = { i, pad: "S".repeat(size) };
        } else {
            // R3: ambos mudam (baseline)
            state = { i, pad: "S".repeat(size) };
        }

        log(`[ITER ${i}] frag_len=${fragment.length} state_len=${JSON.stringify(state).length}`);

        history.pushState(state, "", "#"+fragment);
        history.replaceState(state, "", "#"+fragment);

        if(i % 6 === 0){
            setTimeout(()=>history.back(), 0);
            log("  history.back() ASYNC", "warn");
        }

        size += STEP;
        await sleep(3);
    }

    log("\n=== END (should not reach if crash occurs) ===", "ok");
}

function runR1(){ run(1); }
function runR2(){ run(2); }
function runR3(){ run(3); }

log("Ready.");
log("Run one route at a time.");
</script>
</body>
</html>

