<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – STEP 6 (Interleaving Precision)</title>
<style>
body { font-family: monospace; background:#111; color:#ddd; }
button { margin:6px; padding:8px; }
#log {
  white-space: pre-wrap;
  border:1px solid #333;
  padding:8px;
  height:420px;
  overflow:auto;
}
.warn { color:#ffb000; }
.crit { color:#ff5555; }
.ok { color:#66ff66; }
</style>
</head>
<body>

<h2>STEP 6 – Interleaving Precision Test</h2>
<p>
Objetivo: identificar <b>EXATAMENTE</b> qual operação e qual iteração
corrompem o estado interno do HistoryController.
</p>

<button onclick="runTest('sync')">RUN – BACK SYNC</button>
<button onclick="runTest('async')">RUN – BACK ASYNC</button>
<button onclick="runTest('no-replace')">RUN – NO replaceState</button>
<button onclick="clearLog()">Clear</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(msg, cls="") {
  const t = new Date().toLocaleTimeString();
  logEl.innerHTML += `[${t}] ${msg}\n`;
  logEl.scrollTop = logEl.scrollHeight;
}
function clearLog(){ logEl.textContent=""; }

/* ======= PARÂMETROS CRÍTICOS ======= */
const BASE = 977;
const STEP = 14461;
const MAX_ITERS = 60;

/* ======= CORE TEST ======= */
async function runTest(mode){
  clearLog();
  log(`=== STEP 6 START (${mode}) ===`, "crit");

  let size = BASE;

  try {
    for(let i=0;i<MAX_ITERS;i++){
      log(`\n[ITER ${i}] size=${size}`, "warn");

      // pushState
      log(" pushState()");
      history.pushState({i}, "", "#"+("A".repeat(size)));

      // replaceState (optional)
      if(mode !== "no-replace"){
        log(" replaceState()");
        history.replaceState({i}, "", "#"+("B".repeat(size >> 1)));
      }

      // history.back interleaving
      if(i % 5 === 0){
        if(mode === "async"){
          log(" history.back() ASYNC");
          setTimeout(() => {
            try {
              history.back();
            } catch(e){}
          }, 0);
        } else {
          log(" history.back() SYNC");
          history.back();
        }
      }

      size += STEP;

      // pequeno delay para reduzir ruído
      await new Promise(r => setTimeout(r, 40));
    }

    log("\nCompleted without crash.", "ok");

  } catch(e) {
    log(`\nEXCEPTION CAUGHT: ${e}`, "crit");
  }
}

/* ======= READY ======= */
log("Loaded.");
log("Known crash range ~ ITER 44–46.");
log("Goal: identify exact operation causing state corruption.", "ok");
</script>

</body>
</html>

