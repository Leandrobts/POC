<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 Suite v540000: The Stabilizer</title>
<style>
    body { background: #000; color: #0f0; font-family: monospace; text-align: center; padding: 10px; }
    h1 { border-bottom: 2px solid #0f0; color: #fff; }
    .status { 
        border: 2px solid #fff; padding: 15px; margin-bottom: 20px; 
        font-size: 1.2em; background: #020; color: #fff; font-weight: bold;
    }
    .inst { color: #ff0; font-size: 0.9em; margin-bottom: 10px; }
    
    button {
        display: block; width: 100%; padding: 25px; margin: 15px 0;
        background: #040; color: #fff; border: 2px solid #0f0;
        font-size: 20px; font-weight: bold; cursor: pointer; text-transform: uppercase;
    }
    button:hover { background: #0f0; color: #000; }
    
    #stage { background: #111; height: 100px; border: 1px solid #555; margin-top: 20px; position: relative; }
    
    /* Alvos idênticos para o Flicker */
    .target { 
        width: 100%; height: 100%; 
        position: absolute; top: 0; left: 0;
        display: flex; align-items: center; justify-content: center;
        font-size: 2em; font-weight: bold;
    }
    #t1 { background: red; color: black; }
    #t2 { background: blue; color: white; }
</style>
</head>
<body>

<h1>v540000: THE STABILIZER</h1>

<div class="status" id="msg">
    ALVO: ESTABILIZAR A RACE CONDITION<br>
    CLIQUE NO BOTÃO -> APERTE "QUADRADO" REPETIDAMENTE
</div>

<div class="inst">
    O script vai alternar elementos muito rápido.<br>
    Tente entrar em Fullscreen no meio dessa tempestade.
</div>

<button onclick="stabilize(s01)">01. Element Swap Flicker (Race)</button>

<button onclick="stabilize(s02)">02. ID/Class Toggle Flicker</button>

<button onclick="stabilize(s03)">03. Iframe Load/Unload Flicker</button>

<div id="stage">ALVO</div>

<script>
    const Stage = document.getElementById('stage');
    
    // Spray Global
    let spray = [];
    const spray_pattern = new Float64Array(100).fill(1.123456789e-100);

    function stabilize(vectorFunc) {
        Stage.innerHTML = "";
        spray = [];
        
        // Inicia o loop de caos
        vectorFunc(Stage);
    }

    // =================================================================
    // 01. Element Swap Flicker
    // Tenta replicar o seu sucesso anterior.
    // Troca o elemento A pelo elemento B a cada frame.
    // Quando você aperta Quadrado, o browser tenta dar fullscreen em algo que sumiu.
    // =================================================================
    function s01(stage) {
        // Cria dois elementos visualmente idênticos (ou quase)
        const t1 = document.createElement('div');
        t1.id = 't1'; t1.className = 'target'; t1.innerText = "ALVO A";
        
        const t2 = document.createElement('div');
        t2.id = 't2'; t2.className = 'target'; t2.innerText = "ALVO B";

        // Adiciona o primeiro
        stage.appendChild(t1);

        let active = t1;
        let counter = 0;

        function loop() {
            counter++;
            
            // A TROCA RÁPIDA
            if (active === t1) {
                t1.remove();        // Remove A (Free)
                stage.appendChild(t2); // Adiciona B
                active = t2;
                
                // Tenta confundir o ponteiro do Fullscreen
                // Se o usuário apertou quadrado AGORA, o browser foca no t1
                // mas o t1 foi removido.
            } else {
                t2.remove();
                stage.appendChild(t1);
                active = t1;
            }

            // Aloca e libera memória para aumentar a chance de corrupção
            if(counter % 10 === 0) spray.push(new Uint32Array(1024).fill(0x41414141));
            if(spray.length > 500) spray = []; // Limpa para evitar OOM

            requestAnimationFrame(loop);
        }
        
        // Inicia o loop
        loop();
        
        // Retorna dummy para não quebrar a lógica
        return t1;
    }

    // =================================================================
    // 02. ID/Class Toggle Flicker
    // Em vez de remover o elemento, mudamos sua identidade (ID/Class).
    // O navegador usa o ID para rastrear o elemento em Fullscreen.
    // =================================================================
    function s02(stage) {
        const t = document.createElement('div');
        t.className = 'target';
        t.style.background = "green";
        t.innerText = "ID FLICKER";
        stage.appendChild(t);

        function loop() {
            // Alterna o ID furiosamente
            if (t.id === "fullscreen-target") {
                t.id = "invalid-target";
                t.style.display = "none"; // Também esconde para forçar Reflow
            } else {
                t.id = "fullscreen-target";
                t.style.display = "flex";
            }
            
            // Spray leve
            const x = new Uint32Array(100);
            
            requestAnimationFrame(loop);
        }
        loop();
        return t;
    }

    // =================================================================
    // 03. Iframe Load/Unload Flicker
    // Carrega e descarrega um iframe.
    // Apertar Fullscreen num iframe que está descarregando (Unload)
    // é um vetor clássico de crash.
    // =================================================================
    function s03(stage) {
        let ifr = document.createElement('iframe');
        ifr.className = 'target';
        stage.appendChild(ifr);

        function loop() {
            // Ciclo de Destruição e Recriação
            // Isso é mais lento que o div swap, mas envolve processos mais pesados
            
            // 1. Navega para destruir contexto
            ifr.src = "about:blank";
            
            // 2. Remove do DOM
            ifr.remove();
            
            // 3. Cria novo
            ifr = document.createElement('iframe');
            ifr.className = 'target';
            // Coloca conteúdo pesado
            ifr.srcdoc = "<h1>CLICK SQUARE HERE</h1>";
            stage.appendChild(ifr);
            
            // Recursão com pequeno delay (para dar tempo do usuário clicar)
            setTimeout(loop, 100); 
        }
        loop();
        return ifr;
    }

</script>
</body>
</html>
