
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit Float64Array Registration Audit</title>
<style>
body { font-family: monospace; }
iframe { width: 100%; height: 280px; border: 1px solid #000; }
button { margin: 4px; }
</style>
</head>
<body>

<h2>PARENT LOGGER</h2>
<pre id="log"></pre>

<button onclick="runTest('A')">START TEST A (no registration)</button>
<button onclick="runTest('B')">START TEST B (DataView)</button>
<button onclick="runTest('C')">START TEST C (postMessage transfer)</button>
<button onclick="runTest('D')">START TEST D (structuredClone)</button>

<div id="frameHolder"></div>

<script>
var logEl = document.getElementById("log");

function log(msg) {
  logEl.textContent += msg + "\n";
}

log("[PARENT] Loaded");

function runTest(mode) {
  log("\n=== START TEST " + mode + " ===");

  var holder = document.getElementById("frameHolder");
  holder.innerHTML = "";

  var iframe = document.createElement("iframe");
  holder.appendChild(iframe);

  var doc = iframe.contentWindow.document;
  iframe.contentWindow.TEST_MODE = mode;

  doc.open();
  doc.write(
    '<!DOCTYPE html>' +
    '<html><body>' +
    '<button id="start">RUN TEST ' + mode + '</button>' +

    '<script>' +
    'var send = function(m){ parent.postMessage("[MSG] " + m, "*"); };' +
    'var f64 = null;' +
    'var spray = [];' +

    'document.getElementById("start").onclick = function(){' +
      'send("[ALLOC] Float64Array length=8");' +
      'f64 = new Float64Array(8);' +
      'f64[0] = 13.37;' +

      'for(var i=0;i<500;i++){ var s=new Float64Array(16); s[0]=1.1; spray.push(s); }' +
      'send("[SPRAY] Float64Array spray alive=" + spray.length);' +

      'send("[SNAPSHOT] before fullscreen");' +
      'send(" f64.length = " + f64.length);' +
      'send(" f64[0] = " + f64[0]);' +

      'try{' +
        'if(window.TEST_MODE==="B"){ send("[REGISTER] DataView"); window.dv=new DataView(f64.buffer); }' +
        'if(window.TEST_MODE==="C"){ send("[REGISTER] postMessage transfer"); window.postMessage(f64.buffer,"*",[f64.buffer]); }' +
        'if(window.TEST_MODE==="D"){ send("[REGISTER] structuredClone"); window.clone=structuredClone(f64); }' +
      '}catch(e){ send("[REGISTER ERROR] "+e); }' +

      'document.documentElement.webkitRequestFullscreen();' +
      'send("[STATE] fullscreen requested");' +
    '};' +

    'window.onblur = function(){' +
      'send("[EVENT] blur detected");' +
      'try{' +
        'send("[SNAPSHOT] after blur");' +
        'send(" f64.length = " + f64.length);' +
        'send(" f64[0] = " + f64[0]);' +
      '}catch(e){ send(" f64 access error"); }' +
      'send("[TEARDOWN] document.write iframe");' +
      'document.open(); document.write("<h1>teardown</h1>"); document.close();' +
    '};' +
    '<\/script>' +

    '</body></html>'
  );
  doc.close();
}

window.addEventListener("message", function(e){
  log(e.data);
});
</script>

</body>
</html>
