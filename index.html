<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit Fullscreen Blur – Final Isolation Tests</title>
<style>
body { font-family: monospace; }
iframe { width: 100%; height: 420px; border: 1px solid #000; }
button { margin: 4px; }
pre { background: #f0f0f0; padding: 6px; height: 260px; overflow:auto; }
</style>
</head>
<body>

<h2>PARENT LOGGER</h2>
<pre id="log"></pre>

<h3>Tests</h3>
<button onclick="loadTest('E')">START TEST E – No document.write</button>
<button onclick="loadTest('F')">START TEST F – Delayed document.write</button>
<button onclick="loadTest('G')">START TEST G – Array AFTER blur</button>

<iframe id="frame"></iframe>

<script>
const log = msg => {
  document.getElementById('log').textContent += msg + "\n";
};

log("[PARENT] Loaded");

function loadTest(testId) {
  log("\n=== START TEST " + testId + " ===");

  const iframe = document.getElementById("frame");

  iframe.srcdoc = `
<!DOCTYPE html>
<html>
<body>
<button id="start">START</button>

<script>
const parentLog = m => parent.postMessage(m, "*");

parentLog("[IFRAME] Loaded");

let f64 = null;
let spray = [];
let didBlur = false;

document.getElementById("start").onclick = () => {
  parentLog("[START] clicked");

  if ("${testId}" !== "G") {
    f64 = new Float64Array(8);
    f64[0] = 13.37;
    for (let i = 0; i < 500; i++) spray.push(new Float64Array(8));
    parentLog("[ALLOC] Float64Array + spray created");
  }

  parentLog("[STATE] requesting fullscreen");
  document.documentElement.webkitRequestFullscreen();
};

window.onblur = () => {
  didBlur = true;
  parentLog("[EVENT] blur detected");

  if ("${testId}" === "G") {
    f64 = new Float64Array(8);
    f64[0] = 13.37;
    for (let i = 0; i < 500; i++) spray.push(new Float64Array(8));
    parentLog("[ALLOC] Float64Array CREATED AFTER BLUR");
  }

  parentLog("[SNAPSHOT]");
  parentLog(" f64.length=" + (f64 ? f64.length : "null"));
  parentLog(" f64[0]=" + (f64 ? f64[0] : "null"));

  if ("${testId}" === "F") {
    parentLog("[TEST F] scheduling delayed document.write");
    setTimeout(() => {
      parentLog("[TEARDOWN] document.write iframe");
      document.open();
      document.write("<html><body>teardown</body></html>");
      document.close();
    }, 150);
  }

  if ("${testId}" === "E") {
    parentLog("[TEST E] iframe kept alive – NO document.write");
  }
};
</script>
</body>
</html>
`;
}

window.addEventListener("message", e => log("[MSG] " + e.data));
</script>

</body>
</html>
