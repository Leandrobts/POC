<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 Memory Corruption Tests 101-150 (GC Pressure)</title>
</head>
<body>
    <h1>PS4 Memory Corruption Tests 101-150</h1>
    <h2>Memory Corruption with GC Pressure (No DoS)</h2>
    
    <button onclick="test101()">101: WeakMap GC Reference</button>
    <button onclick="test102()">102: WeakSet Collection Race</button>
    <button onclick="test103()">103: Closure Scope Chain</button>
    <button onclick="test104()">104: Event Listener GC</button>
    <button onclick="test105()">105: Promise Chain GC</button>
    <button onclick="test106()">106: Generator Suspend GC</button>
    <button onclick="test107()">107: Async Function GC</button>
    <button onclick="test108()">108: ArrayBuffer Transfer GC</button>
    <button onclick="test109()">109: TypedArray Subarray GC</button>
    <button onclick="test110()">110: DataView Reference GC</button>
    <button onclick="test111()">111: Blob Slice GC</button>
    <button onclick="test112()">112: URL CreateObject GC</button>
    <button onclick="test113()">113: Worker Message GC</button>
    <button onclick="test114()">114: MessageChannel GC</button>
    <button onclick="test115()">115: DOM Node Cycle GC</button>
    <button onclick="test116()">116: Event Target Cycle</button>
    <button onclick="test117()">117: Range Boundary GC</button>
    <button onclick="test118()">118: Selection Anchor GC</button>
    <button onclick="test119()">119: MutationRecord GC</button>
    <button onclick="test120()">120: IntersectionEntry GC</button>
    <button onclick="test121()">121: Canvas Context GC</button>
    <button onclick="test122()">122: ImageData Buffer GC</button>
    <button onclick="test123()">123: Canvas Pattern GC</button>
    <button onclick="test124()">124: Audio Buffer GC</button>
    <button onclick="test125()">125: Media Stream GC</button>
    <button onclick="test126()">126: Animation Frame GC</button>
    <button onclick="test127()">127: CSS Animation GC</button>
    <button onclick="test128()">128: Transition Callback GC</button>
    <button onclick="test129()">129: Observer Callback GC</button>
    <button onclick="test130()">130: Proxy Trap GC</button>
    <button onclick="test131()">131: Getter Cache GC</button>
    <button onclick="test132()">132: Setter Side Effect GC</button>
    <button onclick="test133()">133: Prototype Chain GC</button>
    <button onclick="test134()">134: Constructor Instance GC</button>
    <button onclick="test135()">135: Symbol Registry GC</button>
    <button onclick="test136()">136: Map Iterator GC</button>
    <button onclick="test137()">137: Set Iterator GC</button>
    <button onclick="test138()">138: Array Iterator GC</button>
    <button onclick="test139()">139: String Iterator GC</button>
    <button onclick="test140()">140: RegExp Match GC</button>
    <button onclick="test141()">141: JSON Parse GC</button>
    <button onclick="test142()">142: FormData Entry GC</button>
    <button onclick="test143()">143: Headers Iterator GC</button>
    <button onclick="test144()">144: URLSearchParams GC</button>
    <button onclick="test145()">145: Storage Event GC</button>
    <button onclick="test146()">146: Crypto Result GC</button>
    <button onclick="test147()">147: FileReader Result GC</button>
    <button onclick="test148()">148: XHR Response GC</button>
    <button onclick="test149()">149: Fetch Response GC</button>
    <button onclick="test150()">150: IFrame Window GC</button>

    <script>
        function forceGC() {
            const garbage = [];
            for (let i = 0; i < 100; i++) {
                garbage.push(new ArrayBuffer(10240));
            }
        }

        function test101() {
            const wm = new WeakMap();
            let key = {id: 1, buffer: new ArrayBuffer(2048)};
            
            wm.set(key, {data: new Uint8Array(1024)});
            const value = wm.get(key);
            
            key = null;
            forceGC();
            
            setTimeout(() => {
                try {
                    value.data[0] = 0xFF;
                } catch(e) {}
            }, 50);
        }

        function test102() {
            const ws = new WeakSet();
            let obj = {id: 1, buffer: new ArrayBuffer(2048)};
            
            ws.add(obj);
            const hasObj = ws.has(obj);
            
            obj = null;
            forceGC();
            
            setTimeout(() => {
                const check = ws.has({id: 1});
            }, 50);
        }

        function test103() {
            let buffer = new ArrayBuffer(2048);
            
            function createClosure() {
                const view = new Uint8Array(buffer);
                return function() {
                    return view[0];
                };
            }
            
            const closure = createClosure();
            buffer = null;
            forceGC();
            
            setTimeout(() => {
                const val = closure();
            }, 50);
        }

        function test104() {
            const elem = document.createElement('div');
            let handler = function(e) {
                const buffer = new ArrayBuffer(2048);
            };
            
            elem.addEventListener('click', handler);
            document.body.appendChild(elem);
            
            handler = null;
            forceGC();
            
            setTimeout(() => {
                elem.click();
                document.body.removeChild(elem);
            }, 50);
        }

        function test105() {
            let obj = {buffer: new ArrayBuffer(2048)};
            
            const promise = Promise.resolve(obj).then(result => {
                return result.buffer;
            });
            
            obj = null;
            forceGC();
            
            promise.then(buffer => {
                const view = new Uint8Array(buffer);
                view[0] = 0xFF;
            });
        }

        function test106() {
            let buffer = new ArrayBuffer(2048);
            
            function* gen() {
                const view = new Uint8Array(buffer);
                yield view;
                buffer = null;
                forceGC();
                yield view;
            }
            
            const g = gen();
            const first = g.next().value;
            
            setTimeout(() => {
                const second = g.next().value;
                second[0] = 0xFF;
            }, 50);
        }

        function test107() {
            let buffer = new ArrayBuffer(2048);
            
            async function test() {
                const view = new Uint8Array(buffer);
                buffer = null;
                forceGC();
                await Promise.resolve();
                view[0] = 0xFF;
            }
            
            test();
        }

        function test108() {
            let buffer = new ArrayBuffer(2048);
            const view = new Uint8Array(buffer);
            
            const w = new Worker(URL.createObjectURL(new Blob(["onmessage=e=>{}"], {type:"text/javascript"})));
            w.postMessage(buffer, [buffer]);
            
            buffer = null;
            forceGC();
            
            setTimeout(() => {
                try {
                    view[0] = 0xFF;
                } catch(e) {}
                w.terminate();
            }, 50);
        }

        function test109() {
            let buffer = new ArrayBuffer(4096);
            const view = new Uint8Array(buffer);
            const subarray = view.subarray(1024, 2048);
            
            buffer = null;
            forceGC();
            
            setTimeout(() => {
                subarray[0] = 0xFF;
            }, 50);
        }

        function test110() {
            let buffer = new ArrayBuffer(2048);
            const dv = new DataView(buffer);
            
            dv.setUint32(0, 0xDEADBEEF, true);
            
            buffer = null;
            forceGC();
            
            setTimeout(() => {
                const val = dv.getUint32(0, true);
            }, 50);
        }

        function test111() {
            let blob = new Blob([new Uint8Array(2048)]);
            const slice = blob.slice(0, 1024);
            
            blob = null;
            forceGC();
            
            setTimeout(() => {
                const reader = new FileReader();
                reader.onload = e => {
                    const result = new Uint8Array(e.target.result);
                };
                reader.readAsArrayBuffer(slice);
            }, 50);
        }

        function test112() {
            let blob = new Blob([new Uint8Array(2048)]);
            const url = URL.createObjectURL(blob);
            
            blob = null;
            forceGC();
            
            setTimeout(() => {
                const img = new Image();
                img.src = url;
            }, 50);
        }

        function test113() {
            const code = `onmessage=e=>{postMessage(e.data);}`;
            const w = new Worker(URL.createObjectURL(new Blob([code], {type:"text/javascript"})));
            
            let buffer = new ArrayBuffer(2048);
            w.postMessage(buffer, [buffer]);
            
            buffer = null;
            forceGC();
            
            w.onmessage = e => {
                const view = new Uint8Array(e.data);
                view[0] = 0xFF;
            };
            
            setTimeout(() => w.terminate(), 100);
        }

        function test114() {
            let mc = new MessageChannel();
            const port1 = mc.port1;
            const port2 = mc.port2;
            
            port1.start();
            port2.postMessage({buffer: new ArrayBuffer(2048)});
            
            mc = null;
            forceGC();
            
            port1.onmessage = e => {
                const view = new Uint8Array(e.data.buffer);
                view[0] = 0xFF;
            };
        }

        function test115() {
            let parent = document.createElement('div');
            const child = document.createElement('span');
            
            parent.appendChild(child);
            child.parentRef = parent;
            
            document.body.appendChild(parent);
            document.body.removeChild(parent);
            
            parent = null;
            forceGC();
            
            setTimeout(() => {
                child.textContent = "UAF";
            }, 50);
        }

        function test116() {
            let elem = document.createElement('div');
            const listener = function() {
                elem.data = new ArrayBuffer(2048);
            };
            
            elem.addEventListener('click', listener);
            document.body.appendChild(elem);
            document.body.removeChild(elem);
            
            elem = null;
            forceGC();
            
            setTimeout(() => {
                try {
                    listener();
                } catch(e) {}
            }, 50);
        }

        function test117() {
            let container = document.createElement('div');
            container.innerHTML = 'Test content';
            document.body.appendChild(container);
            
            const range = document.createRange();
            range.selectNodeContents(container);
            
            document.body.removeChild(container);
            container = null;
            forceGC();
            
            setTimeout(() => {
                try {
                    range.deleteContents();
                } catch(e) {}
            }, 50);
        }

        function test118() {
            let container = document.createElement('div');
            container.contentEditable = true;
            container.innerHTML = 'Selection test';
            document.body.appendChild(container);
            
            const selection = window.getSelection();
            const range = document.createRange();
            range.selectNodeContents(container);
            selection.addRange(range);
            
            document.body.removeChild(container);
            container = null;
            forceGC();
            
            setTimeout(() => {
                try {
                    const anchor = selection.anchorNode;
                } catch(e) {}
            }, 50);
        }

        function test119() {
            let target = document.createElement('div');
            document.body.appendChild(target);
            
            let records = [];
            
            const observer = new MutationObserver(mutations => {
                records = mutations;
            });
            
            observer.observe(target, {childList: true});
            target.appendChild(document.createElement('span'));
            
            document.body.removeChild(target);
            target = null;
            forceGC();
            
            setTimeout(() => {
                if (records.length > 0) {
                    const node = records[0].target;
                }
            }, 50);
        }

        function test120() {
            if (!window.IntersectionObserver) return;
            
            let elem = document.createElement('div');
            document.body.appendChild(elem);
            
            let entries = [];
            
            const observer = new IntersectionObserver(e => {
                entries = e;
            });
            
            observer.observe(elem);
            
            setTimeout(() => {
                document.body.removeChild(elem);
                elem = null;
                forceGC();
                
                setTimeout(() => {
                    if (entries.length > 0) {
                        const target = entries[0].target;
                    }
                }, 50);
            }, 50);
        }

        function test121() {
            let canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            ctx.fillRect(0, 0, 512, 512);
            
            canvas = null;
            forceGC();
            
            setTimeout(() => {
                try {
                    ctx.fillRect(100, 100, 200, 200);
                } catch(e) {}
            }, 50);
        }

        function test122() {
            let canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 256;
            const ctx = canvas.getContext('2d');
            
            const imageData = ctx.getImageData(0, 0, 256, 256);
            
            canvas = null;
            forceGC();
            
            setTimeout(() => {
                const data = imageData.data;
                data[0] = 0xFF;
            }, 50);
        }

        function test123() {
            let patternCanvas = document.createElement('canvas');
            patternCanvas.width = 64;
            patternCanvas.height = 64;
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const pattern = ctx.createPattern(patternCanvas, 'repeat');
            
            patternCanvas = null;
            forceGC();
            
            setTimeout(() => {
                ctx.fillStyle = pattern;
                ctx.fillRect(0, 0, 256, 256);
            }, 50);
        }

        function test124() {
            if (!window.AudioContext && !window.webkitAudioContext) return;
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            
            let ctx = new AudioContext();
            const buffer = ctx.createBuffer(1, 1024, ctx.sampleRate);
            const data = buffer.getChannelData(0);
            
            ctx = null;
            forceGC();
            
            setTimeout(() => {
                data[0] = 0.5;
            }, 50);
        }

        function test125() {
            if (!navigator.mediaDevices) return;
            
            let stream = null;
            
            navigator.mediaDevices.getUserMedia({audio: true, video: false})
                .then(s => {
                    stream = s;
                    const tracks = stream.getTracks();
                    
                    stream = null;
                    forceGC();
                    
                    setTimeout(() => {
                        tracks[0].stop();
                    }, 50);
                })
                .catch(e => {});
        }

        function test126() {
            let callback = function(timestamp) {
                const buffer = new ArrayBuffer(2048);
            };
            
            const id = requestAnimationFrame(callback);
            
            callback = null;
            forceGC();
            
            setTimeout(() => {
                cancelAnimationFrame(id);
            }, 50);
        }

        function test127() {
            let elem = document.createElement('div');
            elem.style.width = '100px';
            document.body.appendChild(elem);
            
            const animation = elem.animate([
                {width: '100px'},
                {width: '200px'}
            ], 1000);
            
            document.body.removeChild(elem);
            elem = null;
            forceGC();
            
            setTimeout(() => {
                try {
                    animation.play();
                } catch(e) {}
            }, 50);
        }

        function test128() {
            let elem = document.createElement('div');
            elem.style.transition = 'width 0.1s';
            elem.style.width = '100px';
            document.body.appendChild(elem);
            
            elem.addEventListener('transitionend', function(e) {
                const buffer = new ArrayBuffer(2048);
            });
            
            elem.style.width = '200px';
            
            setTimeout(() => {
                document.body.removeChild(elem);
                elem = null;
                forceGC();
            }, 50);
        }

        function test129() {
            if (!window.ResizeObserver) return;
            
            let elem = document.createElement('div');
            elem.style.width = '100px';
            document.body.appendChild(elem);
            
            let entries = [];
            
            const observer = new ResizeObserver(e => {
                entries = e;
            });
            
            observer.observe(elem);
            elem.style.width = '200px';
            
            setTimeout(() => {
                document.body.removeChild(elem);
                elem = null;
                forceGC();
                
                setTimeout(() => {
                    if (entries.length > 0) {
                        const target = entries[0].target;
                    }
                }, 50);
            }, 50);
        }

        function test130() {
            let target = {buffer: new ArrayBuffer(2048)};
            
            const handler = {
                get: function(obj, prop) {
                    forceGC();
                    return obj[prop];
                }
            };
            
            const proxy = new Proxy(target, handler);
            target = null;
            
            setTimeout(() => {
                const val = proxy.buffer;
            }, 50);
        }

        function test131() {
            let data = new ArrayBuffer(2048);
            
            const obj = {};
            Object.defineProperty(obj, 'prop', {
                get: function() {
                    forceGC();
                    return data;
                }
            });
            
            data = null;
            
            setTimeout(() => {
                const val = obj.prop;
            }, 50);
        }

        function test132() {
            let buffer = new ArrayBuffer(2048);
            
            const obj = {};
            Object.defineProperty(obj, 'prop', {
                set: function(val) {
                    forceGC();
                    buffer = val;
                }
            });
            
            buffer = null;
            
            setTimeout(() => {
                obj.prop = new ArrayBuffer(1024);
            }, 50);
        }

        function test133() {
            let proto = {data: new ArrayBuffer(2048)};
            const obj = Object.create(proto);
            
            proto = null;
            forceGC();
            
            setTimeout(() => {
                const val = obj.data;
            }, 50);
        }

        function test134() {
            function Constructor() {
                this.buffer = new ArrayBuffer(2048);
            }
            
            let instance = new Constructor();
            Constructor = null;
            forceGC();
            
            setTimeout(() => {
                instance.buffer = new ArrayBuffer(1024);
                instance = null;
            }, 50);
        }

        function test135() {
            const sym = Symbol.for('test');
            let obj = {[sym]: new ArrayBuffer(2048)};
            
            obj = null;
            forceGC();
            
            setTimeout(() => {
                const retrieved = Symbol.for('test');
                const newObj = {[retrieved]: new ArrayBuffer(1024)};
            }, 50);
        }

        function test136() {
            let map = new Map();
            map.set('key', {buffer: new ArrayBuffer(2048)});
            
            const iterator = map.entries();
            
            map = null;
            forceGC();
            
            setTimeout(() => {
                const entry = iterator.next();
                if (!entry.done) {
                    const value = entry.value[1];
                }
            }, 50);
        }

        function test137() {
            let set = new Set();
            set.add({buffer: new ArrayBuffer(2048)});
            
            const iterator = set.values();
            
            set = null;
            forceGC();
            
            setTimeout(() => {
                const entry = iterator.next();
                if (!entry.done) {
                    const value = entry.value;
                }
            }, 50);
        }

        function test138() {
            let arr = [{buffer: new ArrayBuffer(2048)}, 2, 3];
            const iterator = arr[Symbol.iterator]();
            
            arr = null;
            forceGC();
            
            setTimeout(() => {
                const entry = iterator.next();
                if (!entry.done) {
                    const value = entry.value;
                }
            }, 50);
        }

        function test139() {
            let str = 'Test string with content';
            const iterator = str[Symbol.iterator]();
            
            str = null;
            forceGC();
            
            setTimeout(() => {
                const entry = iterator.next();
                if (!entry.done) {
                    const char = entry.value;
                }
            }, 50);
        }

        function test140() {
            const regex = /test/g;
            let str = 'test test test';
            
            const match = regex.exec(str);
            
            str = null;
            forceGC();
            
            setTimeout(() => {
                if (match) {
                    const text = match[0];
                }
            }, 50);
        }

        function test141() {
            const json = '{"data":{"buffer":"test"}}';
            let parsed = JSON.parse(json);
            
            const ref = parsed.data;
            parsed = null;
            forceGC();
            
            setTimeout(() => {
                const val = ref.buffer;
            }, 50);
        }

        function test142() {
            let fd = new FormData();
            fd.append('file', new Blob([new Uint8Array(2048)]));
            
            const entries = Array.from(fd.entries());
            
            fd = null;
            forceGC();
            
            setTimeout(() => {
                const entry = entries[0];
                if (entry) {
                    const file = entry[1];
                }
            }, 50);
        }

        function test143() {
            let headers = new Headers();
            headers.append('X-Test', 'value');
            
            const iterator = headers.entries();
            
            headers = null;
            forceGC();
            
            setTimeout(() => {
                const entry = iterator.next();
                if (!entry.done) {
                    const value = entry.value;
                }
            }, 50);
        }

        function test144() {
            let params = new URLSearchParams('key=value&test=data');
            const iterator = params.entries();
            
            params = null;
            forceGC();
            
            setTimeout(() => {
                const entry = iterator.next();
                if (!entry.done) {
                    const value = entry.value;
                }
            }, 50);
        }

        function test145() {
            let storageEvent = null;
            
            window.addEventListener('storage', function(e) {
                storageEvent = e;
                forceGC();
            }, {once: true});
            
            localStorage.setItem('test', 'value');
            
            setTimeout(() => {
                if (storageEvent) {
                    const key = storageEvent.key;
                }
            }, 50);
        }

        function test146() {
            if (!crypto.subtle) return;
            
            const data = new Uint8Array(1024);
            
            crypto.subtle.digest('SHA-256', data).then(hash => {
                const view = new Uint8Array(hash);
                forceGC();
                
                setTimeout(() => {
                    view[0] = 0xFF;
                }, 50);
            });
        }

        function test147() {
            let blob = new Blob([new Uint8Array(2048)]);
            const reader = new FileReader();
            
            reader.onload = function(e) {
                blob = null;
                forceGC();
                
                setTimeout(() => {
                    const result = e.target.result;
                    const view = new Uint8Array(result);
                    view[0] = 0xFF;
                }, 50);
            };
            
            reader.readAsArrayBuffer(blob);
        }

        function test148() {
            const xhr = new XMLHttpRequest();
            xhr.responseType = 'arraybuffer';
            
            xhr.onload = function() {
                const buffer = xhr.response;
                forceGC();
                
                setTimeout(() => {
                    const view = new Uint8Array(buffer);
                    view[0] = 0xFF;
                }, 50);
            };
            
            xhr.open('GET', 'data:application/octet-stream;base64,AAAA', true);
            xhr.send();
        }

        function test149() {
            if (!window.fetch) return;
            
            fetch('data:application/octet-stream;base64,AAAA')
                .then(response => response.arrayBuffer())
                .then(buffer => {
                    forceGC();
                    
                    setTimeout(() => {
                        const view = new Uint8Array(buffer);
                        view[0] = 0xFF;
                    }, 50);
                })
                .catch(e => {});
        }

        function test150() {
            let iframe = document.createElement('iframe');
            document.body.appendChild(iframe);
            
            const win = iframe.contentWindow;
            const doc = iframe.contentDocument;
            
            document.body.removeChild(iframe);
            iframe = null;
            forceGC();
            
            setTimeout(() => {
                try {
                    const elem = doc.createElement('div');
                } catch(e) {}
            }, 50);
        }
    </script>
</body>
</html>
