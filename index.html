<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit Float64Array Investigation</title>
<style>
body {
    background: black;
    color: #0f0;
    font-family: monospace;
}
button {
    font-size: 16px;
    margin: 5px;
}
#log {
    white-space: pre-wrap;
    margin-top: 10px;
}
iframe {
    width: 100%;
    height: 320px;
    border: 1px solid #0f0;
}
</style>
</head>

<body>

<h2>PS4 WebKit – Fullscreen + Blur + Float64Array</h2>

<button onclick="startTest('A')">TEST A – Control</button>
<button onclick="startTest('B')">TEST B – DataView</button>
<button onclick="startTest('C')">TEST C – postMessage</button>
<button onclick="startTest('D')">TEST D – structuredClone</button>

<div id="log"></div>
<iframe id="frame"></iframe>

<script>
function log(m) {
    document.getElementById("log").textContent += m + "\n";
}

log("[PARENT] Loaded");

function startTest(mode) {
    document.getElementById("log").textContent = "";
    log("=== START TEST " + mode + " ===");

    var iframe = document.getElementById("frame");
    iframe.onload = null;
    iframe.src = "about:blank";

    iframe.onload = function () {
        iframe.contentWindow.name = mode;
        var d = iframe.contentDocument;
        d.open();
        d.write(getIframeHTML());
        d.close();
    };
}

function getIframeHTML() {
return '<!DOCTYPE html>' +
'<html><body style="background:black;color:#0f0;font-family:monospace;">' +
'<pre id="ilog"></pre>' +
'<button id="start">START</button>' +

'<script>' +
'var log = function(m){document.getElementById("ilog").textContent+=m+"\\n";};' +
'var f64=null; var buffer=null; var spray=[];' +

'log("[IFRAME] Loaded");' +

'function snapshot(tag){' +
' log("[SNAPSHOT] "+tag);' +
' try{' +
'  log(" f64.length = "+(f64?f64.length:null));' +
'  log(" f64[0] = "+(f64?f64[0]:null));' +
'  log(" buffer.byteLength = "+(buffer?buffer.byteLength:null));' +
' }catch(e){log(" snapshot exception");}' +
'}' +

'document.getElementById("start").onclick=function(){' +
' log("[START] clicked");' +

' buffer = new ArrayBuffer(64);' +
' f64 = new Float64Array(buffer);' +
' f64[0] = 13.37;' +

' for(var i=0;i<500;i++){spray.push(new Float64Array(8));}' +

' log("[ALLOC] Float64Array length="+f64.length);' +
' log("[SPRAY] alive="+spray.length);' +

' snapshot("before register");' +

' var mode = window.name;' +

' if(mode==="B"){log("[REGISTER] DataView"); window.dv=new DataView(buffer);}' +
' if(mode==="C"){log("[REGISTER] postMessage"); parent.postMessage(buffer,"*",[buffer]);}' +
' if(mode==="D"){log("[REGISTER] structuredClone"); try{structuredClone(f64);}catch(e){log(" structuredClone exception");}}' +

' snapshot("before fullscreen");' +
' document.documentElement.webkitRequestFullscreen();' +
'};' +

'document.addEventListener("blur",function(){' +
' log("[EVENT] blur detected");' +
' snapshot("after blur");' +
' log("[TEARDOWN] document.write iframe");' +
' document.open(); document.write("<h3>teardown</h3>"); document.close();' +
'});' +

'<\/script>' +
'</body></html>';
}
</script>

</body>
</html>
