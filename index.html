<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PS4 Scheduler Stress Tuner</title>
    
</head>
<body>

    <h1>SCHEDULER AFFINITY TUNER</h1>

    <div class="control-panel">
        <div class="input-group">
            <label>Threads (Multiplicador):</label>
            <input type="number" id="mult" value="8"> <span>x CPU Cores</span>
        </div>
        <div class="input-group">
            <label>Spawn por Tick:</label>
            <input type="number" id="rate" value="10"> <span>Workers</span>
        </div>
        <div class="input-group">
            <label>Velocidade (ms):</label>
            <input type="number" id="speed" value="4"> <span>ms (Menor = Mais Rápido)</span>
        </div>
        
        <br>
        <button id="btn-start" onclick="toggleStress()">INICIAR ATAQUE</button>
    </div>

    <div id="status">PARADO</div>
    <div id="stats">Workers Ativos: 0 | Ciclos: 0</div>

    <script>
        let isRunning = false;
        let timer = null;
        let workers = [];
        let cycle = 0;
        
        // Worker Blob: Mantém a thread ocupada
        const blob = new Blob(["setInterval(()=>{}, 100)"], {type:'text/javascript'});
        const url = URL.createObjectURL(blob);

        function toggleStress() {
            const btn = document.getElementById('btn-start');
            const status = document.getElementById('status');

            if (isRunning) {
                // PARAR
                clearInterval(timer);
                killAll();
                isRunning = false;
                btn.innerText = "INICIAR ATAQUE";
                btn.style.background = "#c00";
                status.innerText = "PARADO (Limpando...)";
                status.style.color = "#888";
            } else {
                // INICIAR
                const mult = parseInt(document.getElementById('mult').value);
                const rate = parseInt(document.getElementById('rate').value);
                const speed = parseInt(document.getElementById('speed').value);

                isRunning = true;
                btn.innerText = "PARAR";
                btn.style.background = "#333";
                status.innerText = "EXECUTANDO... (Aguarde o Crash)";
                status.style.color = "#f00";
                
                runLoop(mult, rate, speed);
            }
        }

        function runLoop(multiplier, spawnRate, intervalMs) {
            const maxWorkers = navigator.hardwareConcurrency * multiplier;
            
            timer = setInterval(() => {
                try {
                    // 1. Fase de Spawn (Criação Agressiva)
                    for(let i=0; i < spawnRate; i++) {
                        workers.push(new Worker(url));
                    }

                    // 2. Fase de Kill (Churning)
                    // Se passar do limite, mata METADE de uma vez para causar choque no Scheduler
                    if(workers.length > maxWorkers) {
                        let killCount = 0;
                        while(workers.length > (maxWorkers / 2)) {
                            const w = workers.shift();
                            w.terminate();
                            killCount++;
                        }
                        cycle++;
                    }

                    // Atualiza stats na tela
                    document.getElementById('stats').innerText = 
                        `Workers Ativos: ${workers.length} | Ciclos de Churn: ${cycle}`;

                } catch(e) {
                    // Se falhar a alocação, geralmente estamos perto do crash
                    // Apenas limpamos um pouco para continuar batendo
                    if(workers.length > 10) workers.shift().terminate();
                }
            }, intervalMs);
        }

        function killAll() {
            workers.forEach(w => w.terminate());
            workers = [];
            cycle = 0;
            document.getElementById('stats').innerText = "Workers Ativos: 0 | Sistema Limpo";
        }
    </script>
</body>
</html>
