<!DOCTYPE html>
<html>
<head>
    <title>PS4 Fuzzer (URL Fix)</title>
    <style>
        body { background-color: #000; color: #0f0; font-family: monospace; padding: 20px; font-size: 18px; }
        .box { border: 1px solid #444; padding: 15px; margin-bottom: 10px; }
        button { font-size: 18px; padding: 10px; cursor: pointer; background: #222; color: #fff; border: 1px solid #555; }
        .info { color: cyan; }
        .danger { color: #ff5555; font-weight: bold; }
    </style>
</head>
<body>

    <h3>PS4 IPC Fuzzer v2 (Auto-Reset URL)</h3>

    <div class="box">
        <div>Status: <span id="status">Aguardando...</span></div>
        <div id="log" style="margin-top:10px;">Pronto.</div>
    </div>

    <div class="box">
        <strong>Possível Ponto de Crash:</strong><br>
        <span id="last-attempt" class="danger">Nenhum registro.</span>
    </div>

    <button onclick="startFuzz()">INICIAR</button>
    <button onclick="stopFuzz()">PARAR</button>
    <button onclick="resetData()">LIMPAR DADOS</button>

    <script>
        // --- CONFIGURAÇÕES ---
        const START_SIZE = 1000;      // Tamanho inicial
        const STEP_SIZE = 512;        // Aumenta 512 bytes por vez
        const DELAY_MS = 1500;        // Tempo entre testes

        // Captura a URL original "limpa" (ex: http://192.168.1.5/index.html)
        // Isso garante que o reload sempre volte para o arquivo certo.
        const ORIGINAL_URL = window.location.href.split('?')[0].split('#')[0];

        // Elementos da tela
        const logEl = document.getElementById('log');
        const statusEl = document.getElementById('status');
        const lastEl = document.getElementById('last-attempt');

        // Carrega dados salvos
        let currentSize = parseInt(localStorage.getItem('fuzz_size')) || START_SIZE;
        let lastCrash = localStorage.getItem('fuzz_last_crash');
        let isRunning = localStorage.getItem('fuzz_active') === 'true';

        // Mostra o último tamanho que talvez tenha crashado o console
        if (lastCrash) {
            lastEl.innerText = lastCrash + " bytes";
        }

        // Se estava rodando antes, continua automaticamente
        if (isRunning) {
            runTest();
        }

        function startFuzz() {
            localStorage.setItem('fuzz_active', 'true');
            // Força recarregar na URL limpa para garantir
            window.location.href = ORIGINAL_URL;
        }

        function stopFuzz() {
            localStorage.setItem('fuzz_active', 'false');
            statusEl.innerText = "PARADO.";
            clearTimeout(window.fuzzTimer);
        }

        function resetData() {
            localStorage.clear();
            location.reload();
        }

        function runTest() {
            statusEl.innerText = "RODANDO";
            
            // 1. Salva o tamanho ATUAL como o "suspeito de crash"
            localStorage.setItem('fuzz_last_crash', currentSize);
            
            // 2. Calcula o PRÓXIMO tamanho para o futuro
            localStorage.setItem('fuzz_size', currentSize + STEP_SIZE);

            logEl.innerText = "Testando payload: " + currentSize + " bytes...";

            window.fuzzTimer = setTimeout(() => {
                try {
                    const payload = "/" + "A".repeat(currentSize);

                    // --- O TESTE DE CRASH ---
                    // Se o console travar, ele morre aqui.
                    history.pushState({}, "crash_test", payload);
                    
                    // --- SE NÃO TRAVOU, LIMPA A BAGUNÇA ---
                    logEl.innerText = "Sobreviveu. Resetando URL...";

                    // Truque: Usa replaceState para voltar a URL visualmente para algo limpo
                    // ou simplesmente força o navegador a ir para a ORIGINAL_URL
                    history.replaceState({}, "clean", "fuzz_clean"); 
                    
                    // Redireciona forçadamente para a URL original salva no início
                    window.location.href = ORIGINAL_URL;

                } catch (e) {
                    // Se der erro de JS (ex: URL muito longa pro padrão WebKit), 
                    // apenas loga e tenta o próximo.
                    console.log(e);
                    window.location.href = ORIGINAL_URL;
                }
            }, DELAY_MS);
        }
    </script>
</body>
</html>
