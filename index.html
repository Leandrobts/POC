<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 12.00 Layout Fuzzer</title>
    <style>
        body { background-color: #000000; color: #ffffff; font-family: monospace; padding: 20px; }
        button { 
            display: block; 
            width: 100%; 
            padding: 15px; 
            margin-bottom: 10px; 
            background: #ffffff; 
            color: #000000; 
            border: 1px solid #ffffff; 
            font-size: 16px; 
            cursor: pointer; 
            font-weight: bold;
        }
        button:active { background: #cccccc; }
        #log { border-top: 1px solid #fff; padding-top: 10px; margin-top: 20px; }
    </style>
</head>
<body>

    <h1>PS4 Layout Engine Fuzzer</h1>
    <p>Target: WebCore Rendering Logic (MathML / CSS / Tables)</p>

    <button onclick="runMathML()">TESTE 1: MathML Recursion (Render Crash)</button>
    <button onclick="runCSSOverflow()">TESTE 2: CSS Calc Integer Overflow</button>
    <button onclick="runTableChaos()">TESTE 3: Table Colspan UAF</button>

    <div id="log">Status: Aguardando comando...</div>
    
    <div id="sandbox" style="visibility: hidden; position: absolute;"></div>

    <script>
        function log(msg) { document.getElementById('log').innerText = msg; }
        const sandbox = document.getElementById('sandbox');

        // --- TESTE 1: MathML (Matemática Complexa) ---
        // Tenta quebrar o cálculo de layout de frações aninhadas
        function runMathML() {
            log("Iniciando MathML Nesting...");
            sandbox.innerHTML = "";
            
            setTimeout(() => {
                try {
                    // Cria uma estrutura MathML profunda
                    let content = "<math><mfrac>";
                    // Aninha frações dentro de raízes quadradas repetidamente
                    for(let i=0; i<500; i++) {
                        content += "<msqrt><mi>x</mi><mn>" + i + "</mn></msqrt>";
                    }
                    content += "</mfrac></math>";
                    sandbox.innerHTML = content;

                    // Força o navegador a renderizar isso visivelmente
                    sandbox.style.visibility = "visible";
                    sandbox.style.fontSize = "500px"; // Tamanho absurdo para forçar recálculo

                    // Alterna display para forçar 'Reflow' (recálculo de geometria)
                    let toggle = 0;
                    let interval = setInterval(() => {
                        toggle++;
                        sandbox.style.display = (toggle % 2 === 0) ? "none" : "block";
                        if(toggle > 20) {
                            clearInterval(interval);
                            sandbox.style.visibility = "hidden";
                            log("Teste MathML finalizado (Sem crash).");
                        }
                    }, 50);

                } catch(e) { log("Erro: " + e.message); }
            }, 500);
        }

        // --- TESTE 2: CSS Integer Overflow ---
        // Tenta usar calc() para gerar um número maior que a memória permite (Integer Overflow)
        function runCSSOverflow() {
            log("Iniciando CSS Calc Overflow...");
            sandbox.innerHTML = '<div id="boom">TEXT</div>';
            const el = document.getElementById('boom');
            
            setTimeout(() => {
                try {
                    // Define uma variável CSS gigante
                    // Tenta fazer o WebKit calcular uma margem impossível
                    el.style.setProperty('--giant', '999999999999999999999px');
                    
                    // Aplica transformações complexas baseadas nesse valor
                    // Se o PS4 usar int32 para layout, isso vira número negativo e crasha
                    el.style.width = "calc(var(--giant) * 20)";
                    el.style.padding = "calc(var(--giant) / 2)";
                    el.style.transform = "rotate(calc(var(--giant) * 1deg))";
                    
                    // Força leitura de layout (Reflow)
                    let x = el.offsetWidth;
                    log("Layout calculado: " + x + " (Se não crashou, foi tratado).");
                    
                } catch(e) { log("Erro: " + e.message); }
            }, 500);
        }

        // --- TESTE 3: Table Colspan UAF ---
        // Cria tabelas complexas e remove células durante a renderização
        function runTableChaos() {
            log("Iniciando Table Colspan Attack...");
            sandbox.innerHTML = "";
            sandbox.style.visibility = "visible";

            try {
                const table = document.createElement('table');
                table.style.border = "1px solid white";
                sandbox.appendChild(table);

                // 1. Cria linhas e colunas
                for(let r=0; r<50; r++) {
                    const tr = table.insertRow();
                    for(let c=0; c<50; c++) {
                        const td = tr.insertCell();
                        td.innerText = "X";
                        // Aleatoriamente aplica colspan (mesclar colunas)
                        if(Math.random() > 0.8) td.colSpan = 5;
                    }
                }

                log("Tabela criada. Iniciando destruição...");

                // 2. Destruição rápida para causar UAF no renderizador
                let i = 0;
                let interval = setInterval(() => {
                    i++;
                    if (table.rows.length > 0) {
                        // Deleta uma linha aleatória
                        const idx = Math.floor(Math.random() * table.rows.length);
                        table.deleteRow(idx);
                        
                        // Força recálculo de estilo pesado
                        table.style.borderSpacing = i + "px";
                    } else {
                        clearInterval(interval);
                        log("Teste de Tabela finalizado.");
                        sandbox.style.visibility = "hidden";
                    }
                }, 10); // Muito rápido (10ms)

            } catch(e) { log("Erro: " + e.message); }
        }

    </script>
</body>
</html>
