<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – Subsystem Teardown Audit</title>
<style>
body {
    background:#000;
    color:#0f0;
    font-family: monospace;
}
#log {
    white-space: pre-wrap;
    border-top: 1px solid #0f0;
    margin-top: 10px;
    padding-top: 10px;
}
iframe {
    width: 100%;
    height: 200px;
    border: 1px solid #0f0;
}
</style>
</head>

<body>

<h2>Main Document (Observer)</h2>
<p>This page never enters fullscreen and never reloads.</p>

<iframe id="sandbox"></iframe>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(msg) {
    logEl.textContent += msg + "\n";
}

window.addEventListener("message", function(e) {
    if (typeof e.data === "string") {
        log(e.data);
    }
});

/* Load iframe content dynamically */
const iframe = document.getElementById("sandbox");
iframe.srcdoc = `
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
body {
    background:#111;
    color:#fff;
    font-family: monospace;
}
button {
    font-size:16px;
    padding:10px;
}
</style>
</head>
<body>

<h3>Iframe (Victim Context)</h3>
<button id="startBtn">START TEST</button>

<script>
function send(msg) {
    parent.postMessage(msg, "*");
}

/* Subsystem refs */
let canvas, ctx;
let audioCtx, osc;
let videoEl;
let fontFace;

function setupSubsystems() {
    send("[*] Setting up subsystems");

    try {
        canvas = document.createElement("canvas");
        canvas.width = 128;
        canvas.height = 128;
        ctx = canvas.getContext("2d");
        ctx.fillRect(0,0,128,128);
        send("[+] Canvas ready");
    } catch(e) {
        send("[-] Canvas failed");
    }

    try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        osc = audioCtx.createOscillator();
        osc.connect(audioCtx.destination);
        osc.start();
        send("[+] AudioContext ready");
    } catch(e) {
        send("[-] AudioContext failed");
    }

    try {
        videoEl = document.createElement("video");
        send("[+] Video element created");
    } catch(e) {
        send("[-] Video failed");
    }

    try {
        fontFace = new FontFace(
            "AuditFont",
            "url(data:font/woff;base64,d09GRgABAAAAAA==)"
        );
        document.fonts.add(fontFace);
        fontFace.load();
        send("[+] FontFace loaded");
    } catch(e) {
        send("[-] FontFace failed");
    }
}

function test(label, fn) {
    try {
        fn();
        send("[OK] " + label);
    } catch(e) {
        send("[FAIL] " + label);
    }
}

function postBlurTests() {
    send("================================");
    send("[!] BLUR DETECTED – POST-BLUR TESTS");
    send("================================");

    test("Canvas draw", () => {
        ctx.fillRect(10,10,20,20);
    });

    test("Audio freq set", () => {
        osc.frequency.value = 660;
    });

    test("Video currentTime read", () => {
        let t = videoEl.currentTime;
    });

    test("FontFace status", () => {
        let s = fontFace.status;
    });

    send("[*] Tests done – tearing down iframe");

    /* Kill ONLY the iframe */
    document.open();
    document.write("<html><body>iframe destroyed</body></html>");
    document.close();
}

document.getElementById("startBtn").onclick = function() {
    send("[*] START pressed");
    setupSubsystems();

    const el = document.documentElement;
    if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
    else if (el.requestFullscreen) el.requestFullscreen();

    window.onblur = function() {
        postBlurTests();
    };
};
<\/script>

</body>
</html>
`;
</script>

</body>
</html>
