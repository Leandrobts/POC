<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PS4 FW 12.00 WebKit Probe</title>
    <style>
        body { background-color: #1a1a1a; color: #00ff00; font-family: 'Courier New', monospace; padding: 20px; font-size: 16px; }
        h1 { border-bottom: 2px solid #00ff00; padding-bottom: 10px; }
        .btn { background: #333; color: #fff; border: 1px solid #fff; padding: 10px 20px; cursor: pointer; margin: 5px; font-size: 16px; }
        .btn:hover { background: #555; }
        #logArea { background: #000; border: 1px solid #333; padding: 10px; height: 400px; overflow-y: scroll; margin-top: 20px; white-space: pre-wrap; }
        .vuln { color: #ff3333; font-weight: bold; }
        .info { color: #00ccff; }
        .safe { color: #00ff00; }
        .warn { color: #ffff00; }
    </style>
</head>
<body>

    <h1>PS4 WebKit Probe (Target: FW 12.xx)</h1>
    <p>Ferramenta de Diagnóstico para Pesquisa HackerOne.</p>
    
    <button class="btn" onclick="runFingerprint()">1. Identificar Versão (Fingerprint)</button>
    <button class="btn" onclick="testTypeConfusion()">2. Teste CVE-2024-23222 (JIT Confusion)</button>
    <button class="btn" onclick="testUAFStress()">3. Teste UAF (DOM Stress)</button>
    <button class="btn" onclick="runAll()">RODAR TUDO (Pode Crashar)</button>

    <div id="logArea">Aguardando início dos testes...</div>

    <script>
        const logArea = document.getElementById('logArea');

        function log(msg, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `<span class="${type}">[${timestamp}] ${msg}</span>\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        // --- 1. FINGERPRINTING (Identificação precisa) ---
        function runFingerprint() {
            log("--- Iniciando Fingerprint ---", 'info');
            log(`User Agent: ${navigator.userAgent}`, 'info');
            
            // Verificação de Features para estimar a idade do WebKit
            let score = 0;
            
            // Array.at (Safari 15.4 - Março 2022)
            if (Array.prototype.at) { log("Suporte a Array.at: SIM (WebKit >= 2022)", 'safe'); score++; }
            else { log("Suporte a Array.at: NÃO (WebKit Antigo)", 'warn'); }

            // Regex Lookbehind (Safari 16.4 - Março 2023)
            try {
                new RegExp('(?<=a)b');
                log("Suporte a Regex Lookbehind: SIM (WebKit >= 2023)", 'safe'); score++;
            } catch(e) {
                log("Suporte a Regex Lookbehind: NÃO (WebKit < 2023)", 'warn');
            }

            // Object.groupBy (Safari 17.4 - Março 2024 - CRÍTICO PARA 12.00)
            if (Object.groupBy) { 
                log("Suporte a Object.groupBy: SIM (WebKit Moderno 2024+)", 'safe'); 
                log("AVISO: Se tiver isso, muitas CVEs de 2023 já foram corrigidas.", 'warn');
            } else {
                log("Suporte a Object.groupBy: NÃO (WebKit < Março 2024)", 'vuln');
                log(">>> ALERTA: Base de código potencial para CVE-2024-xxxx detectada!", 'vuln');
            }
        }

        // --- 2. PROBE PARA CVE-2024-23222 (Simulação de Type Confusion) ---
        // Este teste tenta confundir o JIT (Just-In-Time Compiler) sem explodir o kernel.
        function testTypeConfusion() {
            log("--- Iniciando Probe CVE-2024-23222 (Type Confusion) ---", 'info');
            log("Tentando forçar otimização incorreta no DFG JIT...", 'info');

            try {
                // Criamos uma função "quente" para o JIT otimizar
                function jitTrigger(arr, trigger) {
                    // O acesso ao array dentro de um loop é onde o JIT tenta ser esperto
                    let x = 0;
                    for (let i = 0; i < 10000; i++) {
                        // Shift remove o primeiro elemento e desloca tudo.
                        // Vulnerabilidades passadas ocorriam quando o tipo do array mudava durante o shift
                        if (trigger && i === 9000) {
                            arr[0] = {}; // Mudança de tipo no meio da execução (Int -> Object)
                        }
                        x += arr[0]; 
                    }
                    return x;
                }

                // Fase de aquecimento (Warm-up) - Ensina ao JIT que o array é só de números
                let arrTypes = [1.1, 2.2, 3.3];
                for (let i = 0; i < 5000; i++) jitTrigger(arrTypes, false);

                log("JIT aquecido. Tentando gatilho de confusão...", 'warn');

                // Fase de Gatilho
                let vulnArray = [1.1, 2.2, 3.3];
                try {
                    jitTrigger(vulnArray, true);
                    log("Teste concluído sem crash imediato.", 'safe');
                    log("NOTA: Se o navegador ficou lento ou instável agora, é um bom sinal.", 'info');
                } catch (e) {
                    log(`Erro detectado (Isso é bom): ${e.message}`, 'vuln');
                }

            } catch(e) {
                log("Erro geral no teste: " + e.message, 'warn');
            }
        }

        // --- 3. PROBE PARA UAF (Use-After-Free Stress) ---
        // Simula o comportamento da CVE-2024-44308 (Gerenciamento de memória/GC)
        function testUAFStress() {
            log("--- Iniciando Probe UAF Stress (Garbage Collector) ---", 'info');
            log("Alocando e liberando elementos DOM rapidamente...", 'info');
            
            const root = document.createElement('div');
            let spray = [];
            const iterations = 5000; // Ajuste para mais se o PS4 aguentar

            try {
                for (let i = 0; i < iterations; i++) {
                    let el = document.createElement('div');
                    el.setAttribute('id', 'pwn_' + i);
                    
                    // Adiciona um listener (comum em falhas UAF)
                    el.addEventListener('click', function() { console.log('Click'); });
                    
                    root.appendChild(el);
                    spray.push(el);

                    // A cada 100, remove e força referência nula
                    if (i % 100 === 0) {
                        for (let j = 0; j < 50; j++) {
                            if(spray.length > 0) {
                                let temp = spray.pop();
                                temp.remove();
                                temp = null; // Tenta forçar o Garbage Collector
                            }
                        }
                    }
                }
                
                log(`Stress test concluído com ${iterations} ciclos.`, 'safe');
                log("Se o navegador não travou, a gestão de memória está estável.", 'info');

            } catch (e) {
                log(`CRASH/ERRO durante Stress Test: ${e.message}`, 'vuln');
            }
        }

        function runAll() {
            runFingerprint();
            setTimeout(testTypeConfusion, 1000);
            setTimeout(testUAFStress, 3000);
        }

    </script>
</body>
</html>
