<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PS4 Memory Sonar</title>
    
</head>
<body>
    <h1>MEMORY SONAR (DIAGNÓSTICO)</h1>
    <h3>Monitorando estabilidade do Heap em tempo real</h3>
    <button onclick="start_sonar()">LIGAR SONAR</button>
    <div id="log"></div>

    <script>
        function log(msg) {
            document.getElementById("log").innerHTML += `<div>[${Date.now()}] ${msg}</div>`;
        }

        var workers = [];
        var last_time = Date.now();

        async function start_sonar() {
            // 1. Criar workers até o limite seguro (390)
            log("Enchendo base (0-390)...");
            for(let i=0; i<390; i++) {
                try {
                    let w = new SharedWorker("data:text/javascript,1", "base"+i);
                    w.port.start();
                    workers.push(w);
                } catch(e){}
            }

            log("Entrando na Zona Crítica. Monitorando latência...");

            // 2. Adicionar um por um e medir o impacto no sistema
            var p_count = 0;
            var sonar_interval = setInterval(() => {
                
                // Medir Latência (Lag do Navegador)
                var now = Date.now();
                var delta = now - last_time;
                last_time = now;

                // Se o delta for muito maior que o intervalo (200ms), o sistema está sofrendo
                var lag = delta - 200;
                var status = "OK";
                if (lag > 50) status = "LENTIDÃO LEVE";
                if (lag > 200) status = "LAG PESADO (GC ATIVO?)";
                if (lag > 500) status = "TRAVAMENTO IMINENTE";

                if (p_count > 16) { // Passou do 406 (Crash certo)
                    clearInterval(sonar_interval);
                    return;
                }

                try {
                    let id = 391 + p_count;
                    let w = new SharedWorker("data:text/javascript,1", "sensor_"+id);
                    w.port.start();
                    workers.push(w);
                    
                    log(`Worker ${id} criado. Lag: ${lag}ms. Status: ${status}`);
                    
                    // Tenta conversar com o worker anterior para ver se ele ainda está vivo
                    if (workers.length > 2) {
                        let prev = workers[workers.length - 2];
                        try {
                            prev.port.postMessage("ping");
                        } catch(e) {
                            log(`ALERTA: Worker anterior (${id-1}) morreu ou corrompeu!`);
                        }
                    }

                } catch(e) {
                    log(`ERRO FATAL na alocação ${391+p_count}: ${e}`);
                    // Se der erro de memória aqui, é o limite exato.
                }

                p_count++;

            }, 200); 
        }
    </script>
</body>
</html>
