<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – Passo 6: Crash Boundary Detector</title>
<style>
body {
    background: #000;
    color: #0f0;
    font-family: monospace;
    white-space: pre-wrap;
}
button {
    font-size: 16px;
    margin: 4px;
}
</style>
</head>
<body>

<h2>PS4 WebKit – Passo 6</h2>
<h3>Detecção do Momento Exato do Crash</h3>

<button onclick="runReplace()">Teste: pushState + replaceState</button>
<button onclick="runBackSync()">Teste: pushState + back (sync)</button>
<button onclick="runBackAsync()">Teste: pushState + back (async)</button>

<pre id="log"></pre>

<script>
const logEl = document.getElementById("log");

function log(msg) {
    logEl.textContent += msg + "\n";
    logEl.scrollTop = logEl.scrollHeight;
}

/* CONFIGURAÇÃO CRÍTICA */
const START_ITER = 01;
const END_ITER   = 55;
const BASE_SIZE  = 550000;
const STEP_SIZE  = 15000;

/* Payload previsível */
function makePayload(size) {
    return "A".repeat(size);
}

function runReplace() {
    log("=== TESTE replaceState ===");
    runTest("replace");
}

function runBackSync() {
    log("=== TESTE back SYNC ===");
    runTest("back_sync");
}

function runBackAsync() {
    log("=== TESTE back ASYNC ===");
    runTest("back_async");
}

function runTest(mode) {
    let iter = START_ITER;

    function step() {
        if (iter > END_ITER) {
            log("Teste concluído sem crash.");
            return;
        }

        const size = BASE_SIZE + (iter * STEP_SIZE);
        const payload = makePayload(size);

        log("");
        log("[ITER " + iter + "] size=" + size);
        log("pushState()");

        try {
            history.pushState({ data: payload }, "", "#i" + iter);
        } catch (e) {
            log("EXCEPTION pushState: " + e);
            return;
        }

        if (mode === "replace") {
            log("replaceState()");
            try {
                history.replaceState({ data: payload }, "", "#r" + iter);
            } catch (e) {
                log("EXCEPTION replaceState: " + e);
                return;
            }
        }

        if (mode === "back_sync") {
            log("history.back() [sync]");
            history.back();
        }

        if (mode === "back_async") {
            log("history.back() [async]");
            setTimeout(() => {
                history.back();
            }, 0);
        }

        iter++;
        setTimeout(step, 30);
    }

    step();
}
</script>

</body>
</html>

