<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PS4 12.00 DOM Crusher (No-JIT)</title>
    <style>
        body { background-color: #000; color: #0f0; font-family: monospace; padding: 20px; }
        .log { border: 1px solid #333; height: 300px; overflow-y: scroll; padding: 5px; margin-top: 10px; }
        /* CSS Complexo para forçar recálculo pesado */
        .complex-style { 
            transform: rotate(1deg); 
            opacity: 0.9; 
            transition: all 0.1s;
            display: flex;
        }
    </style>
</head>
<body>
    <h1>PS4 DOM Crusher (Focus: WebCore Lifecycle)</h1>
    <p>Status: WebKit < Mar 2024 Confirmado via Object.groupBy</p>
    
    <button onclick="startDOMStorm()">INICIAR DOM STORM</button>
    <button onclick="testLargeAllocation()">TESTE DE MEMÓRIA (OOM)</button>
    
    <div id="console" class="log">Log de execução...</div>

    <script>
        const logDiv = document.getElementById('console');
        function log(msg) {
            logDiv.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // --- TESTE 1: DOM STORM (Tentativa de UAF em Renderização) ---
        // Cria estruturas HTML profundas e as destroi enquanto força recálculo de estilo
        function startDOMStorm() {
            log("Iniciando DOM Storm (500 ciclos)...");
            let container = document.createElement('div');
            document.body.appendChild(container);

            let errors = 0;

            // Usamos setInterval para não travar a UI imediatamente
            let i = 0;
            let interval = setInterval(() => {
                if (i >= 500) {
                    clearInterval(interval);
                    log("DOM Storm finalizado. Se não crashou, o WebCore aguentou.");
                    container.remove();
                    return;
                }

                try {
                    // 1. Cria aninhamento profundo (Deep Nesting)
                    let root = document.createElement('div');
                    let current = root;
                    for(let d=0; d<50; d++) { // 50 níveis de profundidade
                        let child = document.createElement('div');
                        child.className = 'complex-style';
                        child.textContent = 'x';
                        current.appendChild(child);
                        current = child;
                    }
                    container.appendChild(root);

                    // 2. Força recálculo de layout (Reflow)
                    let height = container.offsetHeight; 

                    // 3. Destruição rápida e tentativa de acesso
                    container.innerHTML = ''; // Limpa tudo brutalmente
                    
                    // Tenta acessar algo que acabou de ser limpo (UAF trigger comum)
                    if (root.firstChild) {
                        let tmp = root.firstChild.offsetHeight; 
                    }

                } catch(e) {
                    errors++;
                }
                i++;
                if(i % 50 === 0) log(`Ciclo ${i}... Memória OK.`);
            }, 10);
        }

        // --- TESTE 2: LARGE ALLOCATION (Erro de Tratamento de Memória) ---
        // Tenta alocar memória contígua para ver como o PS4 lida com falha de alocação
        function testLargeAllocation() {
            log("Tentando alocação massiva de ArrayBuffer...");
            let arr = [];
            try {
                for(let k=0; k<10; k++) {
                    // Tenta alocar blocos de 100MB
                    let buffer = new ArrayBuffer(1024 * 1024 * 100); 
                    arr.push(buffer);
                    log(`Alocado bloco ${k+1} (100MB). Total: ${(k+1)*100}MB`);
                }
            } catch(e) {
                log(`Fim da memória atingido: ${e.message}`);
                log("O navegador lidou com o erro ou fechou?");
            }
        }
    </script>
</body>
</html>
