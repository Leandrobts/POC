<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit - Popup Fullscreen Advanced</title>
</head>
<body>

<h1>PS4 WebKit - Popup + Fullscreen Advanced Tests</h1>

<h2>Testes Avançados (Edge Cases)</h2>

<button onclick="test11()">Teste 11: Fullscreen em Elemento Específico + Alert</button><br>
<button onclick="test12()">Teste 12: Alert com String Gigante + Fullscreen</button><br>
<button onclick="test13()">Teste 13: Fullscreen -> Alert -> Back Button</button><br>
<button onclick="test14()">Teste 14: Múltiplos Elementos em Fullscreen</button><br>
<button onclick="test15()">Teste 15: Alert Durante fullscreenchange Event</button><br>
<button onclick="test16()">Teste 16: Prompt com Input Longo + Fullscreen</button><br>
<button onclick="test17()">Teste 17: Canvas Fullscreen + Alert</button><br>
<button onclick="test18()">Teste 18: Fullscreen Rejected + Alert</button><br>
<button onclick="test19()">Teste 19: History.pushState + Alert + Fullscreen</button><br>
<button onclick="test20()">Teste 20: Double Fullscreen Request + Alert</button><br>

<h2>Testes Extremos</h2>
<button onclick="testRapidFire()">Rapid Fire: 100x Alert + Fullscreen</button><br>
<button onclick="testMemoryPressure()">Memory Pressure + Popups</button><br>
<button onclick="testRaceCondition()">Race Condition Extremo</button><br>

<h2>Controles</h2>
<button onclick="runAllAdvanced()">Executar Todos os Avançados</button>
<button onclick="stopTests()">Parar</button>
<button onclick="clearLog()">Limpar Log</button>

<h2>Log</h2>
<pre id="log"></pre>

<div id="testDiv">Este é um div de teste</div>
<canvas id="testCanvas" width="100" height="100"></canvas>

<script>
let running = false;

function log(msg) {
    const logEl = document.getElementById('log');
    const ts = new Date().toLocaleTimeString();
    logEl.textContent += `[${ts}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
}

function clearLog() {
    document.getElementById('log').textContent = '';
    log('Log limpo');
}

function stopTests() {
    running = false;
    log('TESTES PARADOS');
}

// ============================================
// TESTE 11: Fullscreen em Elemento Específico
// ============================================
function test11() {
    log('--- TESTE 11: Fullscreen em Elemento Específico + Alert ---');
    
    const div = document.getElementById('testDiv');
    
    try {
        div.requestFullscreen();
        log('[OK] Fullscreen no div solicitado');
        
        setTimeout(() => {
            alert('Alert durante fullscreen de elemento específico!');
            log('[OK] Alert fechado');
        }, 500);
        
    } catch(e) {
        log('[ERRO] ' + e.message);
    }
}

// ============================================
// TESTE 12: Alert com String Gigante
// ============================================
function test12() {
    log('--- TESTE 12: Alert com String Gigante + Fullscreen ---');
    
    const bigString = 'A'.repeat(10000);
    
    try {
        alert(bigString);
        log('[OK] Alert com 10000 caracteres fechado');
        
        document.documentElement.requestFullscreen();
        log('[OK] Fullscreen após alert gigante');
        
    } catch(e) {
        log('[ERRO] ' + e.message);
    }
}

// ============================================
// TESTE 13: Fullscreen -> Alert -> Back Button
// ============================================
async function test13() {
    log('--- TESTE 13: Fullscreen -> Alert -> History Back ---');
    
    try {
        // Adicionar entrada no histórico
        history.pushState({}, '', '#test');
        log('[INFO] History entry criada');
        
        // Fullscreen
        await document.documentElement.requestFullscreen();
        log('[OK] Fullscreen ativado');
        
        // Alert
        alert('Pressione OK para voltar no histórico');
        
        // Back
        history.back();
        log('[OK] History.back() executado durante fullscreen');
        
    } catch(e) {
        log('[ERRO] ' + e.message);
    }
}

// ============================================
// TESTE 14: Múltiplos Elementos Fullscreen
// ============================================
async function test14() {
    log('--- TESTE 14: Múltiplos Elementos em Fullscreen ---');
    
    const div = document.getElementById('testDiv');
    const canvas = document.getElementById('testCanvas');
    
    try {
        // Primeiro elemento
        await div.requestFullscreen();
        log('[OK] Div em fullscreen');
        
        alert('Div em fullscreen. Tentando canvas agora...');
        
        // Tentar segundo elemento (deve falhar)
        await canvas.requestFullscreen();
        log('[OK] Canvas em fullscreen (sobrescreveu div?)');
        
    } catch(e) {
        log('[ERRO] ' + e.message);
    }
}

// ============================================
// TESTE 15: Alert Durante fullscreenchange
// ============================================
function test15() {
    log('--- TESTE 15: Alert Durante fullscreenchange Event ---');
    
    // Event listener
    document.addEventListener('fullscreenchange', function handler() {
        log('[EVENT] fullscreenchange disparado');
        alert('Alert dentro do evento fullscreenchange!');
        document.removeEventListener('fullscreenchange', handler);
    });
    
    try {
        document.documentElement.requestFullscreen();
        log('[OK] Fullscreen solicitado');
    } catch(e) {
        log('[ERRO] ' + e.message);
    }
}

// ============================================
// TESTE 16: Prompt com Input Longo
// ============================================
function test16() {
    log('--- TESTE 16: Prompt com Input Longo + Fullscreen ---');
    
    const longString = 'X'.repeat(1000);
    const input = prompt('Digite algo:', longString);
    
    log('[INFO] Prompt input length: ' + (input ? input.length : 0));
    
    try {
        document.documentElement.requestFullscreen();
        log('[OK] Fullscreen após prompt longo');
    } catch(e) {
        log('[ERRO] ' + e.message);
    }
}

// ============================================
// TESTE 17: Canvas Fullscreen + Alert
// ============================================
async function test17() {
    log('--- TESTE 17: Canvas Fullscreen + Alert ---');
    
    const canvas = document.getElementById('testCanvas');
    const ctx = canvas.getContext('2d');
    
    // Desenhar algo
    ctx.fillStyle = 'red';
    ctx.fillRect(0, 0, 100, 100);
    log('[INFO] Canvas desenhado');
    
    try {
        await canvas.requestFullscreen();
        log('[OK] Canvas em fullscreen');
        
        alert('Canvas em fullscreen! Vê alguma coisa?');
        
        await document.exitFullscreen();
        log('[OK] Saiu do fullscreen');
        
    } catch(e) {
        log('[ERRO] ' + e.message);
    }
}

// ============================================
// TESTE 18: Fullscreen Rejected + Alert
// ============================================
async function test18() {
    log('--- TESTE 18: Fullscreen Rejected + Alert ---');
    
    try {
        // Tentar fullscreen sem user gesture (pode falhar)
        setTimeout(async () => {
            try {
                await document.documentElement.requestFullscreen();
                log('[OK] Fullscreen funcionou sem gesture');
            } catch(e) {
                log('[ESPERADO] Fullscreen rejeitado: ' + e.message);
                alert('Fullscreen foi rejeitado! Erro: ' + e.message);
            }
        }, 1000);
        
    } catch(e) {
        log('[ERRO] ' + e.message);
    }
}

// ============================================
// TESTE 19: History + Alert + Fullscreen
// ============================================
async function test19() {
    log('--- TESTE 19: History.pushState + Alert + Fullscreen ---');
    
    try {
        // Loop de history
        for (let i = 0; i < 5; i++) {
            history.pushState({}, '', '#history' + i);
            log('[INFO] History entry ' + i);
        }
        
        alert('5 entradas de histórico criadas!');
        
        await document.documentElement.requestFullscreen();
        log('[OK] Fullscreen após history manipulation');
        
        // Back durante fullscreen
        for (let i = 0; i < 5; i++) {
            history.back();
            log('[INFO] History.back() ' + i);
        }
        
    } catch(e) {
        log('[ERRO] ' + e.message);
    }
}

// ============================================
// TESTE 20: Double Fullscreen Request
// ============================================
function test20() {
    log('--- TESTE 20: Double Fullscreen Request + Alert ---');
    
    try {
        // Primeira solicitação
        document.documentElement.requestFullscreen();
        log('[INFO] Primeira solicitação de fullscreen');
        
        // Segunda solicitação imediata
        document.documentElement.requestFullscreen();
        log('[INFO] Segunda solicitação de fullscreen');
        
        alert('Duas solicitações de fullscreen feitas!');
        
    } catch(e) {
        log('[ERRO] ' + e.message);
    }
}

// ============================================
// TESTE EXTREMO: Rapid Fire
// ============================================
async function testRapidFire() {
    if (!confirm('AVISO: 100 alerts + fullscreen!\n\nContinuar?')) return;
    
    log('=== RAPID FIRE: 100x Alert + Fullscreen ===');
    running = true;
    
    for (let i = 0; i < 100 && running; i++) {
        try {
            alert('Alert ' + (i+1) + '/100');
            
            if (i % 10 === 0) {
                await document.documentElement.requestFullscreen();
                log('[' + i + '] Fullscreen ativado');
                
                await new Promise(r => setTimeout(r, 100));
                
                await document.exitFullscreen();
                log('[' + i + '] Fullscreen desativado');
            }
            
        } catch(e) {
            log('[CRASH ' + i + '] ' + e.message);
            
            localStorage.setItem('ps4_rapid_crash', JSON.stringify({
                iteration: i,
                error: e.message,
                timestamp: new Date().toISOString()
            }));
            
            break;
        }
    }
    
    log('=== RAPID FIRE COMPLETO ===');
    running = false;
}

// ============================================
// TESTE EXTREMO: Memory Pressure
// ============================================
async function testMemoryPressure() {
    if (!confirm('AVISO: Vai criar pressão de memória!\n\nContinuar?')) return;
    
    log('=== MEMORY PRESSURE + POPUPS ===');
    
    try {
        // Criar arrays grandes
        const arrays = [];
        for (let i = 0; i < 100; i++) {
            arrays.push(new Array(10000).fill('X'.repeat(1000)));
            
            if (i % 20 === 0) {
                alert('Arrays criados: ' + i);
                log('[INFO] ' + i + ' arrays criados');
            }
        }
        
        log('[INFO] Memory pressure criada');
        
        // Fullscreen com pressão de memória
        await document.documentElement.requestFullscreen();
        log('[OK] Fullscreen com memory pressure');
        
        alert('Fullscreen ativo com memory pressure!');
        
    } catch(e) {
        log('[CRASH] ' + e.message);
    }
}

// ============================================
// TESTE EXTREMO: Race Condition
// ============================================
async function testRaceCondition() {
    if (!confirm('AVISO: Race condition extremo!\n\nContinuar?')) return;
    
    log('=== RACE CONDITION EXTREMO ===');
    running = true;
    
    let iteration = 0;
    
    while (running && iteration < 50) {
        iteration++;
        
        try {
            // Múltiplas operações simultâneas
            setTimeout(() => alert('Alert assíncrono ' + iteration), 10);
            setTimeout(() => document.documentElement.requestFullscreen(), 20);
            setTimeout(() => document.exitFullscreen().catch(()=>{}), 30);
            setTimeout(() => history.pushState({}, '', '#race' + iteration), 40);
            
            log('[' + iteration + '] Race disparado');
            
            await new Promise(r => setTimeout(r, 100));
            
        } catch(e) {
            log('[CRASH ' + iteration + '] ' + e.message);
            break;
        }
    }
    
    log('=== RACE CONDITION COMPLETO ===');
    running = false;
}

// ============================================
// EXECUTAR TODOS
// ============================================
async function runAllAdvanced() {
    log('=== EXECUTANDO TODOS OS TESTES AVANÇADOS ===');
    running = true;
    
    const tests = [
        test11, test12, test13, test14, test15,
        test16, test17, test18, test19, test20
    ];
    
    for (let i = 0; i < tests.length; i++) {
        if (!running) break;
        
        log(`\nTeste ${i+11}/${i+20}...`);
        
        try {
            await tests[i]();
        } catch(e) {
            log('[CRASH] ' + e.message);
        }
        
        await new Promise(r => setTimeout(r, 2000));
        
        // Cleanup
        try {
            if (document.fullscreenElement) {
                await document.exitFullscreen();
            }
        } catch(e) {}
    }
    
    log('\n=== TODOS OS TESTES AVANÇADOS CONCLUÍDOS ===');
    running = false;
}

// ============================================
// INIT
// ============================================
log('PS4 WebKit - Popup + Fullscreen Advanced Tests');
log('20 testes avançados + 3 testes extremos');
log('');

if (document.documentElement.requestFullscreen) {
    log('[OK] Fullscreen API disponível');
} else {
    log('[ERRO] Fullscreen API NÃO disponível!');
}

// Verificar crashes anteriores
const rapidCrash = localStorage.getItem('ps4_rapid_crash');
if (rapidCrash) {
    log('[AVISO] Crash no Rapid Fire: ' + rapidCrash);
}
</script>

</body>
</html>
