<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>WebKit Sanity & Verification Suite</title>
<style>
body { background:#000; color:#0f0; font-family:monospace; }
.pass { color:#0f0; }
.warn { color:#ff0; }
.fail { color:#f00; }
</style>
</head>
<body>

<h2>WebKit Sanity & Verification Suite</h2>
<pre id="log"></pre>

<script>
const logEl = document.getElementById("log");
function log(msg, cls="pass") {
  logEl.innerHTML += `%c${msg}\n`;
  console.log(msg);
}

function forceGC() {
  const junk = [];
  for(let i=0;i<3000;i++) junk.push(new ArrayBuffer(1024*1024));
}

function sanityCheck(name, setupFn, testFn) {
  log(`\n[TEST] ${name}`, "warn");

  let score = 0;

  const { node, cleanup } = setupFn();

  // 1. DOM invariants
  try {
    if (node.parentNode !== null) score++;
    if (node.isConnected === true) score++;
  } catch(e){}

  // 2. API consistency
  try {
    const r = document.createRange();
    r.selectNode(node);
    score++;
  } catch(e){}

  // 3. Identity stability
  const sym = Symbol("marker");
  try {
    node[sym] = 0x1337;
    if (node[sym] === 0x1337) score++;
  } catch(e){}

  // 4. GC lifetime
  forceGC();
  try {
    if (node.nodeType) score++;
  } catch(e){}

  // 5. Cross-system leakage
  try {
    testFn(node);
    score++;
  } catch(e){}

  cleanup();

  if (score >= 3) {
    log(`[RESULT] INVESTIGAR (score=${score})`, "fail");
  } else if (score === 2) {
    log(`[RESULT] ANOMALIA LEVE (score=${score})`, "warn");
  } else {
    log(`[RESULT] COMPORTAMENTO ESPERADO (score=${score})`, "pass");
  }
}

/* ===================== TESTES PROMISSORES ===================== */

// TEST 24 – Range / Selection
sanityCheck(
  "TEST 24 – Range on Removed Node",
  () => {
    const d = document.createElement("div");
    d.textContent = "X";
    document.body.appendChild(d);
    document.body.removeChild(d);
    return {
      node: d,
      cleanup: () => {}
    };
  },
  (node) => {
    const sel = window.getSelection();
    const r = document.createRange();
    r.selectNode(node);
    sel.removeAllRanges();
    sel.addRange(r);
  }
);

// TEST 39 – Shadow DOM
sanityCheck(
  "TEST 39 – Shadow DOM After Host Removal",
  () => {
    const host = document.createElement("div");
    const shadow = host.attachShadow({mode:"open"});
    shadow.innerHTML = "<span>test</span>";
    document.body.appendChild(host);
    document.body.removeChild(host);
    return {
      node: shadow,
      cleanup: () => {}
    };
  },
  (shadow) => {
    shadow.querySelector("span").textContent;
  }
);

// TEST 46 – TreeWalker
sanityCheck(
  "TEST 46 – TreeWalker Detached Tree",
  () => {
    const root = document.createElement("div");
    root.innerHTML = "<span></span><span></span>";
    document.body.appendChild(root);
    document.body.removeChild(root);
    return {
      node: root,
      cleanup: () => {}
    };
  },
  (node) => {
    const walker = document.createTreeWalker(node, NodeFilter.SHOW_ELEMENT);
    walker.nextNode();
  }
);

// TEST 42 – String Boundary
sanityCheck(
  "TEST 42 – String Concat Boundary",
  () => {
    const s = "A".repeat(0x10000);
    return {
      node: s,
      cleanup: () => {}
    };
  },
  (s) => {
    const x = s + "B";
    if (x.length !== s.length + 1) throw "String corruption";
  }
);

log("\n=== SANITY SUITE FINALIZADA ===", "warn");
</script>

</body>
</html>

