<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 Sleeper Threads</title>
    <style>body{background:#000;color:#0ff;font-family:monospace;padding:20px;}</style>
</head>
<body>
    <h1>Técnica Sleeper (Atomics)</h1>
    <p>Tentativa de passar de 418 colocando threads para dormir.</p>
    <div id="count" style="font-size:80px">0</div>
    <button onclick="runSleeper()" style="font-size:20px;padding:20px;width:100%">INICIAR</button>

    <script>
        // SharedArrayBuffer é necessário para Atomics
        // Se o PS4 não suportar, vai dar erro no log (o que já é uma resposta)
        try {
            const sab = new SharedArrayBuffer(1024);
            const int32 = new Int32Array(sab);
        } catch(e) {
            alert("SharedArrayBuffer não suportado! Esta técnica não funcionará.");
        }

        const workerCode = `
            self.onmessage = function(e) {
                const int32 = new Int32Array(e.data);
                // A thread entra em coma aqui. O Kernel para de agendar CPU para ela.
                // Ela fica esperando um sinal que nunca virá.
                Atomics.wait(int32, 0, 0); 
            };
        `;
        const url = URL.createObjectURL(new Blob([workerCode], {type:"text/javascript"}));
        
        let workers = [];

        function runSleeper() {
            const sab = new SharedArrayBuffer(1024);
            
            let interval = setInterval(() => {
                let w = new Worker(url);
                // Envia o buffer para ela dormir imediatamente
                w.postMessage(sab);
                workers.push(w);
                
                document.getElementById('count').innerText = workers.length;

                // Se passar de 450, VENCEMOS O LIMITE!
                if(workers.length > 450) {
                    clearInterval(interval);
                    document.body.style.backgroundColor = "green";
                    alert("SUCESSO! Passamos do 418 usando Sleep!");
                }
            }, 30); // Criação moderada
        }
    </script>
</body>
</html>
