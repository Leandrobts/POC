<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>WebKit Crash Suite 11–20</title>
<style>
body { font-family: monospace; }
button { margin:4px; }
#log { border:1px solid #888; height:260px; overflow:auto; white-space:pre; }
</style>
</head>
<body>

<h2>WebKit Memory Corruption – Tests 11–20</h2>

<button onclick="t11()">TEST 11</button>
<button onclick="t12()">TEST 12</button>
<button onclick="t13()">TEST 13</button>
<button onclick="t14()">TEST 14</button>
<button onclick="t15()">TEST 15</button>
<button onclick="t16()">TEST 16</button>
<button onclick="t17()">TEST 17</button>
<button onclick="t18()">TEST 18</button>
<button onclick="t19()">TEST 19</button>
<button onclick="t20()">TEST 20</button>

<hr>
<div id="log"></div>

<script>
function log(m){
  const l=document.getElementById("log");
  l.textContent += `[${new Date().toLocaleTimeString()}] ${m}\n`;
  l.scrollTop=l.scrollHeight;
}

/* =========================================================
 * TEST 11 — DOM TreeWalker After Free
 * Classe: DOM UAF / iterator lifetime
 * =======================================================*/
function t11(){
  log("TEST 11 iniciado");
  try{
    const root=document.createElement("div");
    for(let i=0;i<2000;i++){ // BOUNDARY
      const c=document.createElement("span");
      c.textContent="X".repeat(100);
      root.appendChild(c);
    }
    document.body.appendChild(root);
    const walker=document.createTreeWalker(root, NodeFilter.SHOW_ELEMENT);
    document.body.removeChild(root);
    while(walker.nextNode()){}
  }catch(e){ log(e); }
}

/* =========================================================
 * TEST 12 — ResizeObserver + Node Removal
 * Classe: Layout / observer UAF
 * =======================================================*/
function t12(){
  log("TEST 12 iniciado");
  try{
    const d=document.createElement("div");
    d.style.width="100px";
    d.style.height="100px";
    document.body.appendChild(d);
    const ro=new ResizeObserver(()=>{ d.offsetWidth; });
    ro.observe(d);
    document.body.removeChild(d);
    d.style.width="200px";
  }catch(e){ log(e); }
}

/* =========================================================
 * TEST 13 — OffscreenCanvas Transfer Abuse
 * Classe: Backing store / cross-thread lifetime
 * =======================================================*/
function t13(){
  log("TEST 13 iniciado");
  try{
    const off=new OffscreenCanvas(4096,4096); // BOUNDARY
    const ctx=off.getContext("2d");
    ctx.fillRect(0,0,4096,4096);
    const w=new Worker(URL.createObjectURL(new Blob([`
      onmessage=e=>{
        const c=e.data;
        const x=c.getContext("2d");
        x.getImageData(0,0,4096,4096);
      };
    `],{type:"text/javascript"})));
    w.postMessage(off,[off]);
    ctx.getImageData(0,0,4096,4096);
  }catch(e){ log(e); }
}

/* =========================================================
 * TEST 14 — NodeIterator After GC Pressure
 * Classe: DOM UAF + GC
 * =======================================================*/
function t14(){
  log("TEST 14 iniciado");
  try{
    const d=document.createElement("div");
    d.innerHTML="<span>A</span>".repeat(2000);
    document.body.appendChild(d);
    const it=document.createNodeIterator(d, NodeFilter.SHOW_TEXT);
    document.body.removeChild(d);
    for(let i=0;i<4000;i++) new ArrayBuffer(1024*256);
    while(it.nextNode()){}
  }catch(e){ log(e); }
}

/* =========================================================
 * TEST 15 — CSSStyleSheet Replace Abuse
 * Classe: Style engine corruption
 * =======================================================*/
function t15(){
  log("TEST 15 iniciado");
  try{
    const sheet=new CSSStyleSheet();
    document.adoptedStyleSheets=[sheet];
    sheet.replaceSync("div{color:red;}");
    document.adoptedStyleSheets=[];
    sheet.replaceSync("span{color:blue;}".repeat(5000)); // BOUNDARY
  }catch(e){ log(e); }
}

/* =========================================================
 * TEST 16 — MutationObserver + Reinsert Loop
 * Classe: Refcount / observer lifetime
 * =======================================================*/
function t16(){
  log("TEST 16 iniciado");
  try{
    const d=document.createElement("div");
    document.body.appendChild(d);
    const mo=new MutationObserver(()=>{
      document.body.removeChild(d);
      document.body.appendChild(d);
    });
    mo.observe(document.body,{childList:true});
    document.body.removeChild(d);
  }catch(e){ log(e); }
}

/* =========================================================
 * TEST 17 — AudioNode Disconnect Reuse
 * Classe: Media graph corruption
 * =======================================================*/
function t17(){
  log("TEST 17 iniciado");
  try{
    const ctx=new AudioContext();
    const osc=ctx.createOscillator();
    osc.connect(ctx.destination);
    osc.start();
    osc.disconnect();
    osc.disconnect();
    osc.connect(ctx.destination);
  }catch(e){ log(e); }
}

/* =========================================================
 * TEST 18 — History Flood + GC
 * Classe: State object lifetime
 * =======================================================*/
function t18(){
  log("TEST 18 iniciado");
  try{
    for(let i=0;i<3000;i++){ // BOUNDARY
      history.pushState({x:"A".repeat(10000)}, "", "#"+i);
    }
    for(let i=0;i<4000;i++) new ArrayBuffer(1024*512);
    history.back();
  }catch(e){ log(e); }
}

/* =========================================================
 * TEST 19 — DocumentFragment Reparent Abuse
 * Classe: DOM lifetime corruption
 * =======================================================*/
function t19(){
  log("TEST 19 iniciado");
  try{
    const frag=document.createDocumentFragment();
    for(let i=0;i<2000;i++){
      const t=document.createTextNode("Z".repeat(50));
      frag.appendChild(t);
    }
    document.body.appendChild(frag);
    document.body.removeChild(document.body.firstChild);
    document.body.appendChild(frag);
  }catch(e){ log(e); }
}

/* =========================================================
 * TEST 20 — Mixed API Lifetime Stress
 * Classe: Cross-subsystem corruption
 * =======================================================*/
function t20(){
  log("TEST 20 iniciado");
  try{
    const d=document.createElement("div");
    d.textContent="X".repeat(25000);
    document.body.appendChild(d);
    const r=document.createRange();
    r.selectNodeContents(d);
    document.body.removeChild(d);

    const c=document.createElement("canvas");
    c.width=c.height=4096;
    c.getContext("2d").getImageData(0,0,4096,4096);

    getSelection().addRange(r);
  }catch(e){ log(e); }
}

log("Crash Suite 11–20 carregada. Execute um teste por vez.");
</script>
</body>
</html>

