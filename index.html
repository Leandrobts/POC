<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 Browser Security Tests - UAF/Race Conditions</title>
</head>
<body>

<h1>PlayStation 4 Browser - UAF & Race Condition Tests</h1>
<p>Security Research - Bug Bounty Testing</p>
<p>User Agent: PlayStation 4/12.00 WebKit/605.1.15</p>

<hr>

<h2>Test 1: DOM Node UAF via removeChild</h2>
<div id="test1">
<button onclick="test1()">Run Test 1</button>
<div id="container1"></div>
</div>
<script>
function test1() {
  var c = document.getElementById('container1');
  var d = document.createElement('div');
  c.appendChild(d);
  var ref = d;
  c.removeChild(d);
  ref.innerHTML = 'accessing freed memory';
  setTimeout(function() { ref.click(); }, 10);
}
</script>

<hr>

<h2>Test 2: Event Listener UAF</h2>
<div id="test2">
<button onclick="test2()">Run Test 2</button>
</div>
<script>
function test2() {
  var btn = document.createElement('button');
  document.body.appendChild(btn);
  var handler = function() { console.log('click'); };
  btn.addEventListener('click', handler);
  document.body.removeChild(btn);
  btn.click();
}
</script>

<hr>

<h2>Test 3: Range Object UAF</h2>
<div id="test3">
<button onclick="test3()">Run Test 3</button>
<p id="range-target">Text for range testing</p>
</div>
<script>
function test3() {
  var p = document.getElementById('range-target');
  var r = document.createRange();
  r.selectNode(p);
  p.parentNode.removeChild(p);
  r.cloneContents();
  r.extractContents();
}
</script>

<hr>

<h2>Test 4: TextNode UAF</h2>
<div id="test4">
<button onclick="test4()">Run Test 4</button>
</div>
<script>
function test4() {
  var txt = document.createTextNode('test');
  var div = document.createElement('div');
  div.appendChild(txt);
  document.body.appendChild(div);
  var ref = txt;
  div.removeChild(txt);
  ref.nodeValue = 'modified after free';
}
</script>

<hr>

<h2>Test 5: DocumentFragment UAF</h2>
<div id="test5">
<button onclick="test5()">Run Test 5</button>
</div>
<script>
function test5() {
  var frag = document.createDocumentFragment();
  var div = document.createElement('div');
  frag.appendChild(div);
  var ref = div;
  document.body.appendChild(frag);
  ref.innerHTML = 'uaf test';
}
</script>

<hr>

<h2>Test 6: Attribute Node UAF</h2>
<div id="test6">
<button onclick="test6()">Run Test 6</button>
</div>
<script>
function test6() {
  var el = document.createElement('div');
  el.setAttribute('data-test', 'value');
  var attr = el.attributes[0];
  el.removeAttribute('data-test');
  attr.value = 'modified';
}
</script>

<hr>

<h2>Test 7: Form Element UAF</h2>
<div id="test7">
<button onclick="test7()">Run Test 7</button>
</div>
<script>
function test7() {
  var form = document.createElement('form');
  var input = document.createElement('input');
  form.appendChild(input);
  document.body.appendChild(form);
  var ref = input;
  form.removeChild(input);
  ref.value = 'test';
}
</script>

<hr>

<h2>Test 8: Canvas Context UAF</h2>
<div id="test8">
<button onclick="test8()">Run Test 8</button>
</div>
<script>
function test8() {
  var canvas = document.createElement('canvas');
  document.body.appendChild(canvas);
  var ctx = canvas.getContext('2d');
  document.body.removeChild(canvas);
  ctx.fillRect(0, 0, 100, 100);
}
</script>

<hr>

<h2>Test 9: Image Element UAF</h2>
<div id="test9">
<button onclick="test9()">Run Test 9</button>
</div>
<script>
function test9() {
  var img = new Image();
  img.onload = function() { console.log('loaded'); };
  document.body.appendChild(img);
  var ref = img;
  document.body.removeChild(img);
  ref.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==';
}
</script>

<hr>

<h2>Test 10: Selection Object UAF</h2>
<div id="test10">
<button onclick="test10()">Run Test 10</button>
<p id="sel-target">Selection test text</p>
</div>
<script>
function test10() {
  var sel = window.getSelection();
  var p = document.getElementById('sel-target');
  sel.selectAllChildren(p);
  p.parentNode.removeChild(p);
  sel.deleteFromDocument();
}
</script>

<hr>

<h2>Test 11: Race Condition - Rapid appendChild/removeChild</h2>
<div id="test11">
<button onclick="test11()">Run Test 11</button>
</div>
<script>
function test11() {
  var div = document.createElement('div');
  for(var i = 0; i < 1000; i++) {
    document.body.appendChild(div);
    document.body.removeChild(div);
  }
}
</script>

<hr>

<h2>Test 12: Race Condition - Parallel DOM Mutations</h2>
<div id="test12">
<button onclick="test12()">Run Test 12</button>
</div>
<script>
function test12() {
  var div = document.createElement('div');
  document.body.appendChild(div);
  setTimeout(function() { div.innerHTML = 'A'; }, 0);
  setTimeout(function() { div.innerHTML = 'B'; }, 0);
  setTimeout(function() { document.body.removeChild(div); }, 0);
}
</script>

<hr>

<h2>Test 13: Race Condition - Event Handler Removal</h2>
<div id="test13">
<button onclick="test13()">Run Test 13</button>
</div>
<script>
function test13() {
  var btn = document.createElement('button');
  var handler = function() { console.log('click'); };
  document.body.appendChild(btn);
  for(var i = 0; i < 500; i++) {
    btn.addEventListener('click', handler);
    btn.removeEventListener('click', handler);
  }
  btn.click();
}
</script>

<hr>

<h2>Test 14: XMLHttpRequest UAF</h2>
<div id="test14">
<button onclick="test14()">Run Test 14</button>
</div>
<script>
function test14() {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', 'data:text/plain,test', true);
  xhr.onload = function() { console.log('loaded'); };
  xhr.send();
  xhr = null;
}
</script>

<hr>

<h2>Test 15: MutationObserver UAF</h2>
<div id="test15">
<button onclick="test15()">Run Test 15</button>
</div>
<script>
function test15() {
  var div = document.createElement('div');
  document.body.appendChild(div);
  var obs = new MutationObserver(function(muts) { console.log(muts); });
  obs.observe(div, {childList: true});
  document.body.removeChild(div);
  div.appendChild(document.createTextNode('test'));
}
</script>

<hr>

<h2>Test 16: Audio Element UAF</h2>
<div id="test16">
<button onclick="test16()">Run Test 16</button>
</div>
<script>
function test16() {
  var audio = new Audio();
  audio.onended = function() { console.log('ended'); };
  document.body.appendChild(audio);
  var ref = audio;
  document.body.removeChild(audio);
  ref.play();
}
</script>

<hr>

<h2>Test 17: Video Element UAF</h2>
<div id="test17">
<button onclick="test17()">Run Test 17</button>
</div>
<script>
function test17() {
  var video = document.createElement('video');
  document.body.appendChild(video);
  var ref = video;
  document.body.removeChild(video);
  ref.play();
}
</script>

<hr>

<h2>Test 18: Race Condition - Rapid Attribute Changes</h2>
<div id="test18">
<button onclick="test18()">Run Test 18</button>
</div>
<script>
function test18() {
  var div = document.createElement('div');
  document.body.appendChild(div);
  for(var i = 0; i < 1000; i++) {
    div.setAttribute('data-test', i.toString());
    div.removeAttribute('data-test');
  }
}
</script>

<hr>

<h2>Test 19: Comment Node UAF</h2>
<div id="test19">
<button onclick="test19()">Run Test 19</button>
</div>
<script>
function test19() {
  var comment = document.createComment('test comment');
  var div = document.createElement('div');
  div.appendChild(comment);
  document.body.appendChild(div);
  var ref = comment;
  div.removeChild(comment);
  ref.nodeValue = 'modified';
}
</script>

<hr>

<h2>Test 20: TreeWalker UAF</h2>
<div id="test20">
<button onclick="test20()">Run Test 20</button>
<div id="walker-target"><span>Test</span></div>
</div>
<script>
function test20() {
  var target = document.getElementById('walker-target');
  var walker = document.createTreeWalker(target, NodeFilter.SHOW_ALL);
  target.parentNode.removeChild(target);
  walker.nextNode();
}
</script>

<hr>

<h2>Test 21: NodeIterator UAF</h2>
<div id="test21">
<button onclick="test21()">Run Test 21</button>
<div id="iterator-target"><span>Test</span></div>
</div>
<script>
function test21() {
  var target = document.getElementById('iterator-target');
  var iter = document.createNodeIterator(target, NodeFilter.SHOW_ALL);
  target.parentNode.removeChild(target);
  iter.nextNode();
}
</script>

<hr>

<h2>Test 22: Race Condition - Nested appendChild/removeChild</h2>
<div id="test22">
<button onclick="test22()">Run Test 22</button>
</div>
<script>
function test22() {
  var parent = document.createElement('div');
  var child = document.createElement('div');
  document.body.appendChild(parent);
  for(var i = 0; i < 500; i++) {
    parent.appendChild(child);
    setTimeout(function() { parent.removeChild(child); }, 0);
  }
}
</script>

<hr>

<h2>Test 23: DOMParser UAF</h2>
<div id="test23">
<button onclick="test23()">Run Test 23</button>
</div>
<script>
function test23() {
  var parser = new DOMParser();
  var doc = parser.parseFromString('<div>test</div>', 'text/html');
  var elem = doc.body.firstChild;
  doc.body.removeChild(elem);
  elem.innerHTML = 'modified';
}
</script>

<hr>

<h2>Test 24: Race Condition - Parallel Range Operations</h2>
<div id="test24">
<button onclick="test24()">Run Test 24</button>
<p id="range-target24">Range race test</p>
</div>
<script>
function test24() {
  var p = document.getElementById('range-target24');
  var r1 = document.createRange();
  var r2 = document.createRange();
  r1.selectNode(p);
  r2.selectNode(p);
  setTimeout(function() { r1.deleteContents(); }, 0);
  setTimeout(function() { r2.extractContents(); }, 0);
}
</script>

<hr>

<h2>Test 25: Worker UAF</h2>
<div id="test25">
<button onclick="test25()">Run Test 25</button>
</div>
<script>
function test25() {
  try {
    var blob = new Blob(['self.postMessage("test");'], {type: 'application/javascript'});
    var worker = new Worker(URL.createObjectURL(blob));
    worker.onmessage = function(e) { console.log(e.data); };
    worker.terminate();
    worker.postMessage('after terminate');
  } catch(e) {
    console.log('Worker not supported or error:', e);
  }
}
</script>

<hr>

<h2>Test 26: MessageChannel UAF</h2>
<div id="test26">
<button onclick="test26()">Run Test 26</button>
</div>
<script>
function test26() {
  var channel = new MessageChannel();
  var port = channel.port1;
  channel.port1.onmessage = function(e) { console.log(e.data); };
  channel.port2.postMessage('test');
  port.close();
  port.postMessage('after close');
}
</script>

<hr>

<h2>Test 27: Race Condition - Rapid Element Creation/Destruction</h2>
<div id="test27">
<button onclick="test27()">Run Test 27</button>
</div>
<script>
function test27() {
  for(var i = 0; i < 1000; i++) {
    var div = document.createElement('div');
    document.body.appendChild(div);
    document.body.removeChild(div);
  }
}
</script>

<hr>

<h2>Test 28: CustomEvent UAF</h2>
<div id="test28">
<button onclick="test28()">Run Test 28</button>
</div>
<script>
function test28() {
  var div = document.createElement('div');
  document.body.appendChild(div);
  var evt = new CustomEvent('test', {detail: 'data'});
  div.addEventListener('test', function(e) { console.log(e.detail); });
  document.body.removeChild(div);
  div.dispatchEvent(evt);
}
</script>

<hr>

<h2>Test 29: Race Condition - Concurrent innerHTML Updates</h2>
<div id="test29">
<button onclick="test29()">Run Test 29</button>
</div>
<script>
function test29() {
  var div = document.createElement('div');
  document.body.appendChild(div);
  for(var i = 0; i < 100; i++) {
    setTimeout(function(n) { div.innerHTML = 'Update ' + n; }, 0, i);
  }
}
</script>

<hr>

<h2>Test 30: StyleSheet UAF</h2>
<div id="test30">
<button onclick="test30()">Run Test 30</button>
</div>
<script>
function test30() {
  var style = document.createElement('style');
  document.head.appendChild(style);
  var sheet = style.sheet;
  document.head.removeChild(style);
  sheet.insertRule('body { }', 0);
}
</script>

<hr>

<h2>Test 31: Race Condition - Event Dispatching During Removal</h2>
<div id="test31">
<button onclick="test31()">Run Test 31</button>
</div>
<script>
function test31() {
  var div = document.createElement('div');
  document.body.appendChild(div);
  div.addEventListener('custom', function() { console.log('event'); });
  setTimeout(function() { document.body.removeChild(div); }, 0);
  setTimeout(function() { div.dispatchEvent(new Event('custom')); }, 0);
}
</script>

<hr>

<h2>Test 32: FileReader UAF</h2>
<div id="test32">
<button onclick="test32()">Run Test 32</button>
</div>
<script>
function test32() {
  var reader = new FileReader();
  var blob = new Blob(['test data'], {type: 'text/plain'});
  reader.onload = function() { console.log('loaded'); };
  reader.readAsText(blob);
  reader = null;
}
</script>

<hr>

<h2>Test 33: Race Condition - Multiple Range Modifications</h2>
<div id="test33">
<button onclick="test33()">Run Test 33</button>
<p id="range-target33">Multiple range test</p>
</div>
<script>
function test33() {
  var p = document.getElementById('range-target33');
  var ranges = [];
  for(var i = 0; i < 10; i++) {
    var r = document.createRange();
    r.selectNode(p);
    ranges.push(r);
  }
  ranges.forEach(function(r, i) {
    setTimeout(function() { r.deleteContents(); }, i);
  });
}
</script>

<hr>

<h2>Test 34: IntersectionObserver UAF</h2>
<div id="test34">
<button onclick="test34()">Run Test 34</button>
</div>
<script>
function test34() {
  try {
    var div = document.createElement('div');
    document.body.appendChild(div);
    var obs = new IntersectionObserver(function(entries) { console.log(entries); });
    obs.observe(div);
    document.body.removeChild(div);
    obs.disconnect();
  } catch(e) {
    console.log('IntersectionObserver not supported or error:', e);
  }
}
</script>

<hr>

<h2>Test 35: Race Condition - Rapid Style Changes</h2>
<div id="test35">
<button onclick="test35()">Run Test 35</button>
</div>
<script>
function test35() {
  var div = document.createElement('div');
  document.body.appendChild(div);
  for(var i = 0; i < 1000; i++) {
    div.setAttribute('class', 'cls' + i);
    div.removeAttribute('class');
  }
}
</script>

<hr>

<h2>Test 36: Shadow DOM UAF</h2>
<div id="test36">
<button onclick="test36()">Run Test 36</button>
</div>
<script>
function test36() {
  try {
    var div = document.createElement('div');
    document.body.appendChild(div);
    var shadow = div.attachShadow({mode: 'open'});
    shadow.innerHTML = '<span>shadow content</span>';
    document.body.removeChild(div);
    shadow.innerHTML = 'modified';
  } catch(e) {
    console.log('Shadow DOM not supported or error:', e);
  }
}
</script>

<hr>

<h2>Test 37: Race Condition - Nested Event Handlers</h2>
<div id="test37">
<button onclick="test37()">Run Test 37</button>
</div>
<script>
function test37() {
  var div = document.createElement('div');
  document.body.appendChild(div);
  div.addEventListener('click', function() {
    document.body.removeChild(div);
    div.click();
  });
  div.click();
}
</script>

<hr>

<h2>Test 38: Clipboard UAF</h2>
<div id="test38">
<button onclick="test38()">Run Test 38</button>
</div>
<script>
function test38() {
  var div = document.createElement('div');
  div.innerHTML = 'Copy this text';
  document.body.appendChild(div);
  var sel = window.getSelection();
  sel.selectAllChildren(div);
  document.execCommand('copy');
  document.body.removeChild(div);
}
</script>

<hr>

<h2>Test 39: Race Condition - Promise Chain with DOM</h2>
<div id="test39">
<button onclick="test39()">Run Test 39</button>
</div>
<script>
function test39() {
  var div = document.createElement('div');
  document.body.appendChild(div);
  Promise.resolve()
    .then(function() { div.innerHTML = 'Step 1'; })
    .then(function() { document.body.removeChild(div); })
    .then(function() { div.innerHTML = 'Step 3'; });
}
</script>

<hr>

<h2>Test 40: DataTransfer UAF</h2>
<div id="test40">
<button onclick="test40()">Run Test 40</button>
</div>
<script>
function test40() {
  var div = document.createElement('div');
  div.draggable = true;
  document.body.appendChild(div);
  var dt = null;
  div.addEventListener('dragstart', function(e) { dt = e.dataTransfer; });
  var evt = new DragEvent('dragstart', {dataTransfer: new DataTransfer()});
  div.dispatchEvent(evt);
  document.body.removeChild(div);
}
</script>

<hr>

<h2>Test 41: Race Condition - Rapid Form Submissions</h2>
<div id="test41">
<button onclick="test41()">Run Test 41</button>
</div>
<script>
function test41() {
  var form = document.createElement('form');
  form.action = 'about:blank';
  document.body.appendChild(form);
  for(var i = 0; i < 100; i++) {
    setTimeout(function() { 
      try { form.submit(); } catch(e) {}
    }, i);
  }
  setTimeout(function() { document.body.removeChild(form); }, 50);
}
</script>

<hr>

<h2>Test 42: FontFace UAF</h2>
<div id="test42">
<button onclick="test42()">Run Test 42</button>
</div>
<script>
function test42() {
  try {
    var font = new FontFace('TestFont', 'url(data:font/woff2;base64,d09GMgABAAAAAADAAA==)');
    font.load();
    font = null;
  } catch(e) {
    console.log('FontFace not supported or error:', e);
  }
}
</script>

<hr>

<h2>Test 43: Race Condition - Animation Frame Callbacks</h2>
<div id="test43">
<button onclick="test43()">Run Test 43</button>
</div>
<script>
function test43() {
  var div = document.createElement('div');
  document.body.appendChild(div);
  var id1 = requestAnimationFrame(function() { div.innerHTML = 'Frame 1'; });
  var id2 = requestAnimationFrame(function() { document.body.removeChild(div); });
  var id3 = requestAnimationFrame(function() { div.innerHTML = 'Frame 3'; });
}
</script>

<hr>

<h2>Test 44: Notification UAF</h2>
<div id="test44">
<button onclick="test44()">Run Test 44</button>
</div>
<script>
function test44() {
  try {
    if('Notification' in window) {
      var notif = new Notification('Test', {body: 'Test notification'});
      notif.close();
      notif.onclick = function() { console.log('clicked'); };
    }
  } catch(e) {
    console.log('Notification not supported or error:', e);
  }
}
</script>

<hr>

<h2>Test 45: Race Condition - Multiple XHR Aborts</h2>
<div id="test45">
<button onclick="test45()">Run Test 45</button>
</div>
<script>
function test45() {
  var xhrs = [];
  for(var i = 0; i < 10; i++) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', 'data:text/plain,test' + i, true);
    xhr.send();
    xhrs.push(xhr);
  }
  setTimeout(function() {
    xhrs.forEach(function(x) { x.abort(); });
  }, 10);
}
</script>

<hr>

<h2>Test 46: WebSocket UAF</h2>
<div id="test46">
<button onclick="test46()">Run Test 46</button>
</div>
<script>
function test46() {
  try {
    var ws = new WebSocket('ws://localhost:9999');
    ws.onopen = function() { console.log('opened'); };
    ws.close();
    ws.send('test message');
  } catch(e) {
    console.log('WebSocket error (expected):', e);
  }
}
</script>

<hr>

<h2>Test 47: Race Condition - Concurrent Canvas Operations</h2>
<div id="test47">
<button onclick="test47()">Run Test 47</button>
</div>
<script>
function test47() {
  var canvas = document.createElement('canvas');
  document.body.appendChild(canvas);
  var ctx = canvas.getContext('2d');
  for(var i = 0; i < 100; i++) {
    setTimeout(function(n) {
      ctx.fillRect(n, n, 10, 10);
    }, 0, i);
  }
  setTimeout(function() { document.body.removeChild(canvas); }, 50);
}
</script>

<hr>

<h2>Test 48: IndexedDB UAF</h2>
<div id="test48">
<button onclick="test48()">Run Test 48</button>
</div>
<script>
function test48() {
  try {
    var req = indexedDB.open('testdb', 1);
    req.onsuccess = function(e) {
      var db = e.target.result;
      db.close();
      db.transaction(['store'], 'readonly');
    };
  } catch(e) {
    console.log('IndexedDB error:', e);
  }
}
</script>

<hr>

<h2>Test 49: Race Condition - MediaStream Tracks</h2>
<div id="test49">
<button onclick="test49()">Run Test 49</button>
</div>
<script>
function test49() {
  try {
    navigator.mediaDevices.getUserMedia({audio: true})
      .then(function(stream) {
        var tracks = stream.getTracks();
        tracks.forEach(function(t) { t.stop(); });
        stream.addTrack(tracks[0]);
      })
      .catch(function(e) { console.log('Media error:', e); });
  } catch(e) {
    console.log('getUserMedia not supported or error:', e);
  }
}
</script>

<hr>

<h2>Test 50: Crypto SubtleCrypto UAF</h2>
<div id="test50">
<button onclick="test50()">Run Test 50</button>
</div>
<script>
function test50() {
  try {
    if(window.crypto && window.crypto.subtle) {
      crypto.subtle.generateKey(
        {name: 'AES-GCM', length: 256},
        true,
        ['encrypt', 'decrypt']
      ).then(function(key) {
        return crypto.subtle.exportKey('jwk', key);
      }).then(function() {
        console.log('Crypto operation completed');
      });
    }
  } catch(e) {
    console.log('SubtleCrypto error:', e);
  }
}
</script>

<hr>

<p>Total: 50 Tests - UAF (Use-After-Free) and Race Condition scenarios</p>
<p>Target: PlayStation 4 Browser (WebKit 605.1.15)</p>
<p>Purpose: Security research and responsible disclosure via HackerOne</p>

</body>
</html>
