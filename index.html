<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Iso-Diagnostic: Pthread Panic</title>
<style>
    body { background: #111; color: #fff; font-family: sans-serif; padding: 20px; }
    .panel { display: flex; flex-direction: column; gap: 10px; max-width: 600px; }
    button { padding: 15px; font-size: 16px; cursor: pointer; font-weight: bold; border: none; }
    
    .btn-fill { background: #d4ac0d; color: #000; } /* Amarelo */
    .btn-ping { background: #2e86c1; color: #fff; } /* Azul */
    .btn-kill { background: #c0392b; color: #fff; } /* Vermelho */
    
    #log { margin-top: 20px; background: #000; border: 1px solid #444; height: 300px; overflow-y: scroll; padding: 10px; font-family: monospace; color: #0f0; }
</style>
</head>
<body>

<h1>DIAGNÓSTICO DE KERNEL PANIC</h1>
<p>Vamos descobrir o gatilho exato.</p>

<div class="panel">
    <button class="btn-fill" onclick="step1_Fill()">PASSO 1: Encher Memória (Fill)</button>
    <button class="btn-ping" onclick="step2_Ping()">PASSO 2: Estressar Comunicação (Ping)</button>
    <button class="btn-kill" onclick="step3_Kill()">PASSO 3: Matar Todos (Purge)</button>
    <br>
    <button onclick="resetTest()">Resetar Teste</button>
</div>

<div id="log">Console pronto. Aguardando comandos...</div>

<script>
    let workers = [];
    const blobUrl = URL.createObjectURL(new Blob([`
        onmessage = function(e) {
            // Apenas responde para confirmar vida
            if(e.data === 'ping') postMessage('pong');
            // Aloca um pouco de pilha
            let x = new Uint8Array(1024);
        }
    `], {type: 'application/javascript'}));

    function log(msg) {
        const l = document.getElementById('log');
        l.innerText += "\n> " + msg;
        l.scrollTop = l.scrollHeight;
    }

    // PASSO 1: Descobrir o limite exato sem matar
    function step1_Fill() {
        log("Iniciando Alocação (Spawn)...");
        let count = 0;
        
        // Tenta criar um por vez com delay mínimo para não travar a UI do navegador
        // mas rápido o suficiente para estressar o kernel
        const interval = setInterval(() => {
            try {
                const w = new Worker(blobUrl);
                workers.push(w);
                count++;
                
                // Feedback visual a cada 50
                if(count % 50 === 0) log(`Workers ativos: ${count}`);
                
                // Limite de segurança do script (o sistema deve falhar antes disso)
                if(count >= 1000) {
                    clearInterval(interval);
                    log("Script parou em 1000 (Limite de segurança).");
                }
            } catch(e) {
                clearInterval(interval);
                log("ERRO DE ALOCAÇÃO ATINGIDO!");
                log(`Limite do Sistema: ${count} threads.`);
                log(`Erro retornado: ${e.message}`);
                log("SISTEMA ESTÁVEL? Se sim, o crash não é na criação.");
            }
        }, 5);
    }

    // PASSO 2: Verificar se manter eles vivos causa o crash
    function step2_Ping() {
        if(workers.length === 0) return log("Nenhum worker para pingar.");
        log(`Enviando mensagens para ${workers.length} threads...`);
        
        // Broadcast
        workers.forEach(w => w.postMessage('ping'));
        log("Mensagens enviadas. Se o console travar agora, o problema é IPC/Scheduler.");
    }

    // PASSO 3: O Gatilho mais provável (Mass Destruction)
    function step3_Kill() {
        if(workers.length === 0) return log("Nada para matar.");
        log("INICIANDO PURGE (TERMINATE ALL)...");
        log("Prepare-se para possível Kernel Panic.");
        
        // Aqui está a chave: Matamos todos em um loop síncrono apertado
        // Isso dispara centenas de interrupções de hardware para a CPU
        const total = workers.length;
        for(let i=0; i < total; i++) {
            workers[i].terminate();
        }
        workers = []; // Limpa array JS
        
        log("Comando enviado. Se você está lendo isso, o console sobreviveu (por enquanto).");
    }

    function resetTest() {
        workers.forEach(w => w.terminate());
        workers = [];
        log("Reset efetuado.");
    }
</script>

</body>
</html>
