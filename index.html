<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – History Lifecycle Crash Locator</title>
</head>
<body>

<h1>PS4 WebKit – Passo 4: Crash Locator</h1>
<p>Objetivo: identificar a transição exata que dispara o crash</p>

<button onclick="run()">RUN TEST</button>

<pre id="log"></pre>

<script>
const logEl = document.getElementById("log");
function log(m) {
    logEl.textContent += m + "\n";
}

/*
 * CONFIGURAÇÃO CRÍTICA
 * NÃO alterar estes valores inicialmente
 */
const BASE_SIZE = 978;
const DELTA = 14461;
const ITERATIONS = 30;

function run() {
    log("[*] Teste iniciado");

    let size = BASE_SIZE;

    try {
        for (let i = 0; i < ITERATIONS; i++) {

            log("\n[ITER " + i + "] size = " + size);

            const payload = "A".repeat(size);

            log("  -> pushState");
            history.pushState({i}, "", "#" + payload);

            log("  -> replaceState (half)");
            history.replaceState(
                {i},
                "",
                "#" + payload.slice(0, payload.length >> 1)
            );

            if (i % 5 === 0) {
                log("  -> history.back()");
                history.back();
            }

            log("  -> end iteration");

            size += DELTA;
        }

        log("\n[*] Loop finalizado sem crash");

    } catch (e) {
        log("[!] JS Exception: " + e);
    }
}

log("Loaded.");
</script>

</body>
</html>
