<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – Async History Crash Locator</title>
</head>
<body>

<h1>PS4 WebKit – Passo 4 (Async)</h1>
<button onclick="start()">RUN TEST</button>

<pre id="log"></pre>

<script>
const logEl = document.getElementById("log");
function log(m) {
    logEl.textContent += m + "\n";
}

const BASE = 977;
const DELTA = 14461;
const MAX = 50;

let i = 0;
let size = BASE;

function step() {
    if (i >= MAX) {
        log("[*] Finalizado sem crash");
        return;
    }

    log("\n[ITER " + i + "] size=" + size);

    const payload = "A".repeat(size);

    log(" pushState");
    history.pushState({i}, "", "#" + payload);

    log(" replaceState");
    history.replaceState({}, "", "#" + payload.slice(0, payload.length >> 1));

    if (i % 5 === 0) {
        log(" history.back (async)");
        history.back();
    }

    i++;
    size += DELTA;

    // CRÍTICO: permite o WebKit processar navegação
    setTimeout(step, 0);
}

function start() {
    log("[*] Teste iniciado");
    i = 0;
    size = BASE;
    step();
}

log("Loaded.");
</script>

</body>
</html>

