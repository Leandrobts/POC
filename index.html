<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit Fullscreen Blur – Tests E/F/G (Stable)</title>
<style>
body { background:#000; color:#0f0; font-family:monospace; }
button { font-size:16px; margin:5px; padding:6px 10px; }
#log { white-space:pre-wrap; border:1px solid #0f0; padding:8px; height:280px; overflow:auto; }
#wrap { margin-top:10px; border:1px solid #0f0; padding:6px; }
iframe { width:100%; height:320px; border:1px solid #0f0; }
</style>
</head>
<body>

<h3>PARENT LOGGER</h3>

<button onclick="run('E')">TEST E – No document.write</button>
<button onclick="run('F')">TEST F – Delayed document.write</button>
<button onclick="run('G')">TEST G – Array AFTER blur</button>

<div id="log"></div>

<div id="wrap">
  <div>[IFRAME AREA]</div>
  <div id="slot"></div>
</div>

<script>
function plog(m) {
  var el = document.getElementById('log');
  el.textContent += m + "\n";
  el.scrollTop = el.scrollHeight;
}

plog("[PARENT] Loaded");

window.addEventListener("message", function(e) {
  try {
    if (e && e.data && e.data.log) plog("[MSG] " + e.data.log);
    else plog("[MSG] " + e.data);
  } catch (err) {
    plog("[MSG] (parse error)");
  }
}, false);

function rebuildIframe(testId) {
  var slot = document.getElementById("slot");
  slot.innerHTML = ""; // remove old iframe completely (prevents "2 iframes")
  var fr = document.createElement("iframe");
  fr.id = "frame";
  fr.src = "about:blank";
  slot.appendChild(fr);

  fr.onload = function() {
    try {
      fr.contentWindow.name = testId; // pass test id safely
      var d = fr.contentDocument;
      d.open();
      d.write(IFRAME_HTML);
      d.close();
      plog("[PARENT] iframe injected ok (test=" + testId + ")");
    } catch (e) {
      plog("[PARENT] iframe inject failed: " + e);
    }
  };
}

function run(testId) {
  document.getElementById('log').textContent = "";
  plog("=== START TEST " + testId + " ===");
  rebuildIframe(testId);
}

/* IFRAME HTML (no backticks, no arrow, no srcdoc) */
var IFRAME_HTML =
'<!DOCTYPE html><html><head><meta charset="UTF-8"></head>' +
'<body style="background:black;color:#0f0;font-family:monospace;">' +
'<div style="margin:8px 0;">IFRAME TEST – Press START, then enter Fullscreen, then press OPTIONS.</div>' +
'<button id="start" style="font-size:18px;padding:8px 14px;">START</button>' +
'<pre id="ilog" style="white-space:pre-wrap;margin-top:10px;border:1px solid #0f0;padding:8px;height:200px;overflow:auto;"></pre>' +

'<script>' +
'function send(m){ try{ parent.postMessage({log:m},"*"); }catch(e){} }' +
'function ilog(m){ try{ var el=document.getElementById("ilog"); el.textContent += m+"\\n"; el.scrollTop = el.scrollHeight; }catch(e){} }' +

'var testId = window.name;' +
'var f64 = null;' +
'var buffer = null;' +
'var spray = [];' +

'send("[IFRAME] Loaded test="+testId);' +
'ilog("[IFRAME] Loaded test="+testId);' +

'function snapshot(tag){' +
'  send("[SNAPSHOT] "+tag);' +
'  try {' +
'    send(" f64.length=" + (f64?f64.length:"null"));' +
'    send(" f64[0]=" + (f64?f64[0]:"null"));' +
'    send(" buffer.byteLength=" + (buffer?buffer.byteLength:"null"));' +
'    send(" spray.alive=" + (spray?spray.length:0));' +
'  } catch(e) { send(" snapshot exception"); }' +
'}' +

'function allocPreBlur(){' +
'  buffer = new ArrayBuffer(64);' +
'  f64 = new Float64Array(buffer);' +
'  f64[0] = 13.37;' +
'  for (var i=0;i<500;i++) spray.push(new Float64Array(8));' +
'  send("[ALLOC] PRE-BLUR Float64Array length="+f64.length+" spray="+spray.length);' +
'}' +

'function allocAfterBlur(){' +
'  buffer = new ArrayBuffer(64);' +
'  f64 = new Float64Array(buffer);' +
'  f64[0] = 13.37;' +
'  for (var i=0;i<500;i++) spray.push(new Float64Array(8));' +
'  send("[ALLOC] AFTER-BLUR Float64Array length="+f64.length+" spray="+spray.length);' +
'}' +

'function doFullscreen(){' +
'  send("[STATE] requesting fullscreen");' +
'  try {' +
'    document.documentElement.webkitRequestFullscreen();' +
'  } catch(e) {' +
'    send("[ERROR] fullscreen request failed");' +
'  }' +
'}' +

'function onStart(){' +
'  send("[START] clicked");' +
'  if (testId !== "G") {' +
'    allocPreBlur();' +
'  } else {' +
'    send("[G] will allocate AFTER blur");' +
'  }' +
'  snapshot("before fullscreen");' +
'  doFullscreen();' +
'}' +

'// IMPORTANT: install click handler reliably on PS4 WebKit' +
'setTimeout(function(){' +
'  var b = document.getElementById("start");' +
'  if (b) {' +
'    b.onclick = onStart;' +
'    send("[READY] START handler installed");' +
'    ilog("[READY] START handler installed");' +
'  } else {' +
'    send("[ERROR] START button not found");' +
'  }' +
'}, 0);' +

'window.onblur = function(){' +
'  send("[EVENT] blur detected");' +
'  if (testId === "G") {' +
'    allocAfterBlur();' +
'  }' +
'  snapshot("after blur");' +

'  if (testId === "E") {' +
'    send("[TEST E] keeping iframe alive (NO document.write)");' +
'    return;' +
'  }' +

'  if (testId === "F") {' +
'    send("[TEST F] scheduling document.write in 150ms");' +
'    setTimeout(function(){' +
'      send("[TEARDOWN] document.write iframe");' +
'      try { document.open(); document.write("<h3>teardown</h3>"); document.close(); } catch(e) {}' +
'    }, 150);' +
'    return;' +
'  }' +
'};' +
'<\/script>' +
'</body></html>';
</script>

</body>
</html>
