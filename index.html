<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit - Single Float64Array Teardown Test</title>
<style>
body {
    font-family: monospace;
    background: #000;
    color: #0f0;
    padding: 20px;
}
button, select {
    font-size: 16px;
    padding: 6px;
    margin: 5px 0;
}
.warn { color: #ff0; }
.danger { color: #f00; font-weight: bold; }
</style>
</head>
<body>

<h1>Single Float64Array — Teardown Isolation Test</h1>

<p>
Fluxo obrigatório:<br>
RUN TEST → OPTIONS → REFRESH
</p>

<label>Modo de Teste:</label><br>
<select id="mode">
    <option value="full">FULL Float64Array (JSCell + BackingStore)</option>
    <option value="detach">DETACH Backing Store (JSCell apenas)</option>
</select>

<br>
<button onclick="fire()">RUN TEST</button>

<p id="status" class="warn"></p>

<script>
let victim = null;
let keepAlive = null;

function fire() {
    victim = null;
    keepAlive = null;

    document.getElementById("status").innerText =
        "Fullscreen ativo. Aperte OPTIONS e depois REFRESH.";

    // Criar o Float64Array ÚNICO
    victim = new Float64Array(8);
    victim[0] = 13.37;

    // Modo selecionado
    const mode = document.getElementById("mode").value;

    // Request Fullscreen
    const el = document.documentElement;
    if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
    else if (el.requestFullscreen) el.requestFullscreen();

    window.onblur = function () {
        console.log("[*] Blur detected");

        try {
            if (mode === "detach") {
                // === TESTE JSCell ONLY ===
                // Solta o backing store, mantém o JSCell vivo
                const buf = victim.buffer;
                victim = null;           // remove ref direta
                keepAlive = buf.slice(0); // força detach + nova alocação
            } else {
                // === TESTE FULL ===
                // Mantém Float64Array totalmente vivo
                keepAlive = victim;
            }
        } catch (e) {
            console.log("Error:", e);
        }

        document.getElementById("status").innerHTML =
            "<span class='danger'>AGORA: escolha REFRESH no menu OPTIONS</span>";
    };
}
</script>

</body>
</html>
