<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – E/F/G (Buttons in Iframe, Log in Parent) FIX</title>
<style>
  body { background:#000; color:#0f0; font-family:monospace; margin:0; padding:10px; }
  #log { white-space:pre-wrap; border:1px solid #0f0; padding:10px; height:320px; overflow:auto; }
  iframe { width:100%; height:420px; border:1px solid #0f0; margin-top:10px; background:#000; }
</style>
</head>
<body>

<h3>PARENT LOGGER (only log stays outside)</h3>
<div id="log"></div>

<iframe id="frame"></iframe>

<script>
function plog(m) {
  var el = document.getElementById('log');
  el.textContent += m + "\n";
  el.scrollTop = el.scrollHeight;
}

plog("[PARENT] Loaded");

window.addEventListener("message", function(e) {
  try {
    if (e && e.data && e.data.log) plog("[MSG] " + e.data.log);
    else plog("[MSG] " + e.data);
  } catch (err) {
    plog("[MSG] (parse error)");
  }
}, false);

function writeIntoIframe(fr) {
  try {
    var d = fr.contentDocument || fr.contentWindow.document;
    d.open();
    d.write(IFRAME_HTML);
    d.close();
    plog("[PARENT] iframe content written");
  } catch (e) {
    plog("[PARENT] iframe write failed: " + e);
  }
}

function injectIframe() {
  var fr = document.getElementById("frame");

  // Força um "load real" (mudando a URL) para o onload disparar no PS4
  fr.onload = function() {
    plog("[PARENT] iframe onload fired");
    writeIntoIframe(fr);
  };

  // Mude a URL sempre para garantir load (hash rand já basta)
  fr.src = "about:blank#" + (new Date().getTime());

  // Fallback: se onload não disparar, escreve mesmo assim
  setTimeout(function() {
    plog("[PARENT] fallback write attempt");
    writeIntoIframe(fr);
  }, 200);
}

var IFRAME_HTML =
'<!DOCTYPE html><html><head><meta charset="UTF-8"></head>' +
'<body style="background:#000;color:#0f0;font-family:monospace;margin:0;padding:12px;">' +

'<h3 style="margin:0 0 10px 0;">IFRAME – Select Test, then press OPTIONS after fullscreen</h3>' +

'<div style="margin-bottom:10px;">' +
'  <button onclick="startTest(\\'E\\')" style="font-size:16px;padding:8px 12px;margin-right:6px;">TEST E (no document.write)</button>' +
'  <button onclick="startTest(\\'F\\')" style="font-size:16px;padding:8px 12px;margin-right:6px;">TEST F (delayed document.write)</button>' +
'  <button onclick="startTest(\\'G\\')" style="font-size:16px;padding:8px 12px;">TEST G (array AFTER blur)</button>' +
'</div>' +

'<div style="border:1px solid #0f0;padding:10px;">' +
'  <div><b>Sequence:</b> click a test → fullscreen → press OPTIONS (blur) → observe parent log.</div>' +
'  <div style="margin-top:8px;color:#aaa;font-size:13px;">(Iframe may be torn down in F; E keeps it alive.)</div>' +
'</div>' +

'<script>' +
'function send(m){ try{ parent.postMessage({log:m},"*"); }catch(e){} }' +

'var currentTest = null;' +
'var f64 = null;' +
'var buffer = null;' +
'var spray = [];' +
'var started = false;' +

'send("[IFRAME] Loaded (buttons should be visible)");' +

'function snapshot(tag){' +
'  send("[SNAPSHOT] " + tag);' +
'  try {' +
'    send(" f64.length=" + (f64 ? f64.length : "null"));' +
'    send(" f64[0]=" + (f64 ? f64[0] : "null"));' +
'    send(" buffer.byteLength=" + (buffer ? buffer.byteLength : "null"));' +
'    send(" spray.alive=" + (spray ? spray.length : 0));' +
'  } catch(e) {' +
'    send(" snapshot exception");' +
'  }' +
'}' +

'function allocPreBlur(){' +
'  buffer = new ArrayBuffer(64);' +
'  f64 = new Float64Array(buffer);' +
'  f64[0] = 13.37;' +
'  for (var i=0;i<500;i++) spray.push(new Float64Array(8));' +
'  send("[ALLOC] PRE-BLUR Float64Array length=" + f64.length + " spray=" + spray.length);' +
'}' +

'function allocAfterBlur(){' +
'  buffer = new ArrayBuffer(64);' +
'  f64 = new Float64Array(buffer);' +
'  f64[0] = 13.37;' +
'  for (var i=0;i<500;i++) spray.push(new Float64Array(8));' +
'  send("[ALLOC] AFTER-BLUR Float64Array length=" + f64.length + " spray=" + spray.length);' +
'}' +

'function startTest(t){' +
'  if (started) { send("[WARN] already started; reload page to re-run cleanly"); return; }' +
'  started = true;' +
'  currentTest = t;' +
'  send("=== START TEST " + t + " ===");' +

'  if (t !== "G") {' +
'    allocPreBlur();' +
'  } else {' +
'    send("[G] will allocate AFTER blur");' +
'  }' +

'  snapshot("before fullscreen");' +
'  send("[STATE] requesting fullscreen");' +
'  try { document.documentElement.webkitRequestFullscreen(); } catch(e) { send("[ERROR] fullscreen request failed"); }' +
'}' +

'window.onblur = function(){' +
'  if (!started) { send("[EVENT] blur detected (but not started)"); return; }' +
'  send("[EVENT] blur detected");' +

'  if (currentTest === "G") {' +
'    allocAfterBlur();' +
'  }' +

'  snapshot("after blur");' +

'  if (currentTest === "E") {' +
'    send("[TEST E] keeping iframe alive (NO document.write)");' +
'    return;' +
'  }' +

'  if (currentTest === "F") {' +
'    send("[TEST F] scheduling document.write in 150ms");' +
'    setTimeout(function(){' +
'      send("[TEARDOWN] document.write iframe");' +
'      try { document.open(); document.write("<h3>teardown</h3>"); document.close(); } catch(e) {}' +
'    }, 150);' +
'    return;' +
'  }' +
'};' +
'<\/script>' +

'</body></html>';

injectIframe();
</script>

</body>
</html>
