<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit Lifecycle + Array Pressure</title>
<style>
body { font-family: monospace; }
iframe { width:100%; height:320px; border:1px solid #000; }
pre { background:#eee; padding:10px; }
</style>
</head>
<body>

<h2>PARENT LOGGER</h2>
<pre id="log"></pre>

<iframe id="f"></iframe>

<script>
const log = m => logEl.textContent += m + "\n";
const logEl = document.getElementById("log");
log("[PARENT] Loaded");

window.addEventListener("message", e => log("[MSG] " + e.data));

document.getElementById("f").srcdoc = `
<!DOCTYPE html>
<html>
<body>
<button onclick="start(false)">START (no arrays)</button>
<button onclick="start(true)">START (with arrays)</button>
<pre></pre>

<script>
let arrays = [];
let counts = { blur:0, visibility:0, fullscreen:0 };

function send(m){ parent.postMessage(m, "*"); }

function start(useArrays){
  send("[START] useArrays=" + useArrays);

  if(useArrays){
    for(let i=0;i<5000;i++){
      arrays.push(new Array(1000).fill(i));
    }
    send("[ARRAYS] allocated: " + arrays.length);
  }

  document.addEventListener("visibilitychange", () => {
    counts.visibility++;
    send("[EVENT] visibilitychange -> " + document.visibilityState);
  });

  document.addEventListener("fullscreenchange", () => {
    counts.fullscreen++;
    send("[EVENT] fullscreenchange active=" + !!document.fullscreenElement);
  });

  window.addEventListener("blur", () => {
    counts.blur++;
    send("[EVENT] blur #" + counts.blur);
    send("[COUNTS] " + JSON.stringify(counts));
    teardown();
  });

  document.documentElement.webkitRequestFullscreen();
  send("[STATE] fullscreen requested");
}

function teardown(){
  send("[TEARDOWN] document.write");
  send("[ARRAYS] still alive: " + arrays.length);
  document.open();
  document.write("<html><body>teardown</body></html>");
  document.close();
}
<\/script>
</body>
</html>
`;
</script>

</body>
</html>
