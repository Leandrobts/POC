<!doctype html>
<meta charset="utf-8">
<title>PS4 RenderLayer candidate - ancestors + overflow truncation</title>

<button id="run">RUN 50x</button>
<button id="reset">RESET</button>
<button id="clear">CLEAR LOG</button>
<pre id="log" style="height:260px;overflow:auto;border:1px solid #ccc;padding:8px;"></pre>

<div id="root" style="
  position:relative;
  width:95vw;height:60vh;
  overflow:hidden;
  border:2px solid #444;
">
  <div id="scroller" style="
    position:relative;
    width:120%;height:120%;
    overflow:hidden;
    transform: translateZ(0);
  ">
    <div id="container" style="
      position:relative;
      width:100%;height:100%;
      overflow:hidden;
    "></div>
  </div>
</div>

<script>
const logEl = document.getElementById('log');
function log(s){ logEl.textContent += `[${new Date().toLocaleTimeString()}] ${s}\n`; logEl.scrollTop = logEl.scrollHeight; }

const root = document.getElementById('root');
const scroller = document.getElementById('scroller');
const container = document.getElementById('container');

function setCV(el, v){
  el.style.contentVisibility = v;
  el.style.webkitContentVisibility = v;
}

function forceReflow(){
  void root.offsetHeight; void scroller.offsetHeight; void container.offsetHeight;
}

function makeChildren(){
  container.textContent = "";
  // cria múltiplos filhos para gerar z-order lists
  for(let i=0;i<12;i++){
    const d = document.createElement('div');
    d.className = 'child';
    d.style.position = 'absolute';
    d.style.width = '120px';
    d.style.height = '120px';
    d.style.background = (i===0) ? '#09f' : '#ccc';
    d.style.left = (20 + i*10) + 'px';
    d.style.top  = (20 + i*6) + 'px';
    d.style.zIndex = String(100 + i);
    d.style.transform = 'translateZ(0)';
    // joga parte para fora do container para ativar truncation
    if(i===0){ d.style.left = '85%'; d.style.top = '70%'; }
    if(i===1){ d.style.left = '-40px'; }
    container.appendChild(d);
  }
}

function getBlue(){
  // primeiro filho é o azul
  return container.firstElementChild;
}

function raf(){ return new Promise(r => requestAnimationFrame(() => r())); }

async function oneIter(i){
  makeChildren();
  forceReflow();

  log(`iter ${i}: set content-visibility=hidden on ROOT`);
  setCV(root, 'hidden');
  await raf();
  forceReflow();

  const blue = getBlue();
  log(`iter ${i}: remove BLUE child`);
  blue.remove();
  forceReflow();

  // duas frames para aumentar chance de recompute em árvore de layers
  await raf();
  await raf();

  log(`iter ${i}: set content-visibility=auto on ROOT`);
  setCV(root, 'auto');
  forceReflow();

  // mexe em overflow (ligado ao fix citado)
  root.style.overflow = (i % 2) ? 'hidden' : 'clip';
  scroller.style.overflow = (i % 3) ? 'hidden' : 'clip';
  forceReflow();
}

let running = false;

document.getElementById('run').onclick = async () => {
  if (running) return;
  running = true;
  log("UA: " + navigator.userAgent);
  log("Starting 50 iterations...");

  try{
    for(let i=1;i<=50;i++){
      await oneIter(i);
      // pequena pausa para evitar travar o PS4
      await new Promise(r => setTimeout(r, 20));
    }
  } catch(e){
    log("JS exception: " + (e && e.message ? e.message : e));
  } finally {
    log("Done.");
    running = false;
  }
};

document.getElementById('reset').onclick = () => { makeChildren(); setCV(root,'auto'); forceReflow(); log("RESET"); };
document.getElementById('clear').onclick = () => { logEl.textContent = ""; };
makeChildren();
</script>
