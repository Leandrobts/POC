<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>WebKit Sanity Verification Suite</title>
<style>
body {
  background:#000;
  color:#0f0;
  font-family:monospace;
}
button {
  margin: 6px;
  padding: 6px 10px;
  background:#111;
  color:#0f0;
  border:1px solid #0f0;
}
button:hover { background:#030; }
.pass { color:#0f0; }
.warn { color:#ff0; }
.fail { color:#f00; }
pre { white-space: pre-wrap; }
</style>
</head>

<body>

<h2>WebKit Sanity & Verification Suite</h2>

<button onclick="test24()">TEST 24 – Range on Removed Node</button>
<button onclick="test39()">TEST 39 – Shadow DOM After Removal</button>
<button onclick="test46()">TEST 46 – TreeWalker Detached</button>
<button onclick="test42()">TEST 42 – String Boundary</button>

<pre id="log"></pre>

<script>
const logEl = document.getElementById("log");
function log(msg, cls="pass") {
  logEl.innerHTML += msg + "\n";
  console.log(msg);
}

/* GC LEVE – SEM OOM */
function forceGCSoft() {
  const a = [];
  for (let i = 0; i < 300; i++)
    a.push(new ArrayBuffer(64 * 1024));
}

/* ================= TESTE 24 ================= */
function test24() {
  log("\n[TEST 24] Range on Removed Node");

  const el = document.createElement("div");
  el.textContent = "X";
  document.body.appendChild(el);
  document.body.removeChild(el);

  try {
    const r = document.createRange();
    r.selectNode(el);
    log("Range.selectNode ACEITOU nó removido", "fail");
  } catch(e) {
    log("Range.selectNode rejeitou nó removido (OK)", "pass");
  }

  forceGCSoft();
}

/* ================= TESTE 39 ================= */
function test39() {
  log("\n[TEST 39] Shadow DOM After Host Removal");

  const host = document.createElement("div");
  const shadow = host.attachShadow({mode:"open"});
  shadow.innerHTML = "<span>test</span>";

  document.body.appendChild(host);
  document.body.removeChild(host);

  try {
    const s = shadow.querySelector("span");
    if (s) {
      log("Shadow DOM ainda acessível após remoção", "warn");
    }
  } catch(e) {
    log("Shadow DOM inacessível (OK)", "pass");
  }

  forceGCSoft();
}

/* ================= TESTE 46 ================= */
function test46() {
  log("\n[TEST 46] TreeWalker Detached Tree");

  const root = document.createElement("div");
  root.innerHTML = "<span></span><span></span>";

  document.body.appendChild(root);
  document.body.removeChild(root);

  try {
    const w = document.createTreeWalker(root, NodeFilter.SHOW_ELEMENT);
    const n = w.nextNode();
    if (n) {
      log("TreeWalker navegou em árvore removida", "warn");
    }
  } catch(e) {
    log("TreeWalker falhou corretamente", "pass");
  }

  forceGCSoft();
}

/* ================= TESTE 42 ================= */
function test42() {
  log("\n[TEST 42] String Boundary");

  try {
    const s = "A".repeat(0x8000);
    const t = s + "B";

    if (t.length !== s.length + 1) {
      log("Comprimento inconsistente (POTENCIAL BUG)", "fail");
    } else {
      log("Concatenação consistente (OK)", "pass");
    }
  } catch(e) {
    log("Exceção em concatenação (SUSPEITO)", "warn");
  }
}

</script>
</body>
</html>

