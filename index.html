<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>UAF Sanity & Verification Test</title>
<style>
  body { font-family: monospace; }
  .ok { color: green; }
  .fail { color: red; }
</style>
</head>
<body>

<h2>UAF Sanity & Verification Test</h2>
<button onclick="runTest()">RUN VERIFICATION</button>
<pre id="log"></pre>

<script>
const logEl = document.getElementById('log');
function log(msg, cls="") {
  logEl.innerHTML += (cls ? `[${cls}] ` : "") + msg + "\n";
}

function forceHeapPressure() {
  const junk = [];
  for (let i = 0; i < 2000; i++) {
    junk.push(new ArrayBuffer(1024 * 32));
  }
}

function runTest() {
  logEl.textContent = "";
  log("Starting UAF verification...\n");

  // === SETUP DOM ===
  const container = document.createElement("div");
  for (let i = 0; i < 5; i++) {
    const s = document.createElement("span");
    s.textContent = "X" + i;
    container.appendChild(s);
  }
  document.body.appendChild(container);

  // SNAPSHOT STRONG REF
  const snapshot = document.evaluate(
    "//span",
    container,
    null,
    XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,
    null
  );

  const victim = snapshot.snapshotItem(0);

  // IDENTITY BASELINE
  const baseline = {
    type: victim.nodeType,
    ctor: victim.constructor.name,
    proto: Object.getPrototypeOf(victim)
  };

  // REMOVE + GC PRESSURE
  document.body.removeChild(container);
  forceHeapPressure();

  // === CHECK 1: IDENTITY VIOLATION ===
  try {
    if (
      victim.nodeType !== baseline.type ||
      victim.constructor.name !== baseline.ctor ||
      Object.getPrototypeOf(victim) !== baseline.proto
    ) {
      log("IDENTITY VIOLATION detected", "FAIL");
      log("UAF REAL (identity corrupted)", "FAIL");
      return;
    } else {
      log("Identity stable (expected)", "ok");
    }
  } catch (e) {
    log("Exception during identity check", "FAIL");
    log("UAF REAL (invalid access)", "FAIL");
    return;
  }

  // === CHECK 2: VIRTUAL METHOD CONSISTENCY ===
  try {
    const pos = victim.compareDocumentPosition(document.body);
    if (typeof pos !== "number" || pos < 0 || pos > 0x40) {
      log("Invalid compareDocumentPosition result", "FAIL");
      log("UAF REAL (virtual method corrupted)", "FAIL");
      return;
    } else {
      log("Virtual methods consistent", "ok");
    }
  } catch (e) {
    log("Exception in virtual method", "FAIL");
    log("UAF REAL (method after free)", "FAIL");
    return;
  }

  // === CHECK 3: BACKING STORE REUSE ===
  try {
    victim.textContent = "MARKER";
    forceHeapPressure();

    const span = document.createElement("span");
    span.textContent = "NEW";
    document.body.appendChild(span);

    if (span.textContent === "MARKER") {
      log("Backing store reused across objects", "FAIL");
      log("UAF REAL (memory reuse)", "FAIL");
      return;
    } else {
      log("No backing store reuse", "ok");
    }
  } catch (e) {
    log("Exception during backing store test", "FAIL");
    log("UAF REAL", "FAIL");
    return;
  }

  // === FINAL VERDICT ===
  log("\nFINAL RESULT:", "ok");
  log("No UAF detected", "ok");
  log("Behavior = detached DOM object with live JS reference");
}
</script>

</body>
</html>

