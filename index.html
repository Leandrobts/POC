<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <title>PS4 VULN SCOUT V33 (API SURFACER)</title>
    <style>
        :root { --bg: #050505; --panel: #111; --text: #ddd; --accent: #ff3366; --evt: #00ffcc; --api: #ffff00; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Consolas', monospace; display: flex; flex-direction: column; align-items: center; padding: 20px; height: 100vh; margin: 0; }
        
        .container { width: 95%; max-width: 1200px; display: flex; flex-direction: column; gap: 15px; height: 100%; }
        h1 { color: var(--accent); margin: 0; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        .controls { background: var(--panel); padding: 15px; border: 1px solid #333; display: flex; gap: 15px; align-items: center; }
        
        .progress-bar { width: 100%; height: 5px; background: #333; margin-top: 10px; }
        .fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.1s; }
        
        .grid { display: grid; grid-template-columns: 2fr 1fr; gap: 15px; flex: 1; overflow: hidden; }
        .log-box { background: #000; border: 1px solid #333; padding: 10px; overflow-y: scroll; font-size: 12px; }
        
        .entry { border-bottom: 1px solid #1a1a1a; padding: 2px 0; display: flex; justify-content: space-between; }
        .tag-evt { color: var(--evt); font-weight: bold; } /* Eventos */
        .tag-api { color: var(--api); } /* APIs */
        .tag-dang { color: #ff5555; font-weight: bold; background: #220000; } /* Perigo */
        
        .btn { background: #222; color: #fff; border: 1px solid var(--accent); padding: 10px 20px; cursor: pointer; }
        .btn:hover { background: var(--accent); color: #000; }
        .btn:disabled { border-color: #444; color: #555; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="container">
    <h1>PS4 VULN SCOUT <span style="font-size:0.6em; color:#666">V33 (Attack Vector Mapper)</span></h1>
    
    <div class="controls">
        <input type="file" id="fileInput">
        <button id="btnScan" class="btn" disabled onclick="startScan()">1. MAPEAMENTO DE VULNERABILIDADES</button>
        <button id="btnExport" class="btn" disabled onclick="exportData()">2. EXPORTAR VETORES</button>
    </div>
    
    <div class="progress-bar"><div id="prog" class="fill"></div></div>

    <div class="grid">
        <div class="log-box" id="mainLog">
            <div style="color:#666">Carregue o WebKit (.elf) para mapear eventos e APIs...</div>
        </div>
        <div class="log-box" id="riskLog">
            <h3 style="color:#fff; margin-top:0; border-bottom:1px solid #333">ALVOS DE ALTO RISCO</h3>
            <div style="color:#666; font-size:0.9em">APIs perto de 'Free/Destroy'...</div>
        </div>
    </div>
</div>

<script>
    const CHUNK_SIZE = 1024 * 1024; // 1MB chunks
    
    // DICIONÁRIOS DE ATAQUE
    const TARGETS = {
        // Eventos são a porta de entrada para Race Conditions
        EVENTS: [
            "onblur", "onfocus", "onresize", "onscroll", "onpagehide", 
            "onunload", "onabort", "onerror", "onclose", "ondrag", 
            "ontouchstart", "ontouchend", "onpointerdown", "onpointerup",
            "onwebkitfullscreenchange", "onwebkitfullscreenerror",
            "onpopstate", "onhashchange", "onmessage", "onstorage"
        ],
        // APIs complexas que gerem memória nativa
        APIS: [
            "requestFullscreen", "exitFullscreen", "pointerLock",
            "createBuffer", "createTexture", "bufferData", // WebGL
            "postMessage", "terminate", // Workers
            "FileReader", "readAsArrayBuffer", 
            "WebSocket", "close",
            "AudioContext", "decodeAudioData",
            "SubtleCrypto", "importKey"
        ],
        // Palavras que indicam gestão de memória (Perigo se perto de APIs)
        DANGER: [
            "free", "delete", "destroy", "detach", "release", "cleanup", "shutdown", "reset"
        ]
    };

    let STATE = { file: null, fileSize: 0, results: [], risks: [] };

    document.getElementById('fileInput').addEventListener('change', (e) => {
        if(e.target.files[0]) document.getElementById('btnScan').disabled = false;
    });

    function startScan() {
        STATE.file = document.getElementById('fileInput').files[0];
        STATE.fileSize = STATE.file.size;
        STATE.results = [];
        STATE.risks = [];
        
        document.getElementById('btnScan').disabled = true;
        document.getElementById('mainLog').innerHTML = '';
        document.getElementById('riskLog').innerHTML = '';
        
        processChunk(0);
    }

    function processChunk(offset) {
        if (offset >= STATE.fileSize) {
            finishScan();
            return;
        }

        const end = Math.min(offset + CHUNK_SIZE, STATE.fileSize);
        const reader = new FileReader();
        
        reader.onload = (e) => {
            const u8 = new Uint8Array(e.target.result);
            analyzeBuffer(u8, offset);
            
            // UI Update
            const pct = (end / STATE.fileSize) * 100;
            document.getElementById('prog').style.width = pct + '%';
            
            setTimeout(() => processChunk(end), 5); // Non-blocking
        };
        
        reader.readAsArrayBuffer(STATE.file.slice(offset, end));
    }

    function analyzeBuffer(u8, baseOff) {
        let str = "";
        let start = 0;
        
        // Extração de Strings Rápida
        for(let i=0; i<u8.length; i++) {
            if(u8[i] >= 32 && u8[i] <= 126) {
                if(!str) start = i;
                str += String.fromCharCode(u8[i]);
            } else {
                if(str.length > 4) {
                    checkString(str, baseOff + start);
                }
                str = "";
            }
        }
    }

    function checkString(s, absOffset) {
        let type = null;
        
        // 1. É um Event Handler? (Vetor de Ataque #1)
        if (s.startsWith("on") && TARGETS.EVENTS.some(ev => s.includes(ev))) {
            type = "EVENT";
            logEntry(s, absOffset, "tag-evt");
        }
        
        // 2. É uma API de Risco? (Vetor de Ataque #2)
        else if (TARGETS.APIS.some(api => s.includes(api))) {
            type = "API";
            logEntry(s, absOffset, "tag-api");
        }
        
        // 3. Detetor de Use-After-Free (Proximidade)
        // Se encontrarmos "Destroy" ou "Free" perto de coisas como "Fullscreen", "Worker", "Audio"
        // Marcamos como ALTO RISCO.
        if (TARGETS.DANGER.some(d => s.toLowerCase().includes(d))) {
            // Verifica se tem contexto interessante (ex: "TextureDestroy", "FrameDetach")
            if (s.length < 30) { 
                addToRiskLog(s, absOffset);
            }
        }

        if (type) {
            STATE.results.push({ type: type, name: s, offset: "0x"+absOffset.toString(16) });
        }
    }

    function logEntry(name, off, cssClass) {
        const box = document.getElementById('mainLog');
        if (box.children.length > 300) return; // Limite de render
        
        const div = document.createElement('div');
        div.className = 'entry';
        div.innerHTML = `<span class="${cssClass}">${name}</span> <span style="color:#555">0x${off.toString(16).toUpperCase()}</span>`;
        box.appendChild(div);
    }

    function addToRiskLog(name, off) {
        const box = document.getElementById('riskLog');
        // Só queremos coisas que pareçam métodos C++ (ex: "detachFrame", "destroyContext")
        if (!/[A-Z]/.test(name) && !name.includes("::")) return; 
        
        // Evita duplicados
        if (STATE.risks.length > 100) return;
        
        STATE.risks.push({ name: name, offset: off });
        
        const div = document.createElement('div');
        div.style.borderBottom = "1px solid #222";
        div.style.padding = "2px";
        div.innerHTML = `<span class="tag-dang">${name}</span>`;
        box.appendChild(div);
    }

    function finishScan() {
        document.getElementById('prog').style.background = "#00ff00";
        document.getElementById('btnExport').disabled = false;
        
        const box = document.getElementById('mainLog');
        box.innerHTML = `<div style="padding:10px; color:#fff; border:1px solid #00ffcc; text-align:center">
            SCAN COMPLETO.<br>
            Encontrados: ${STATE.results.length} vetores de API.<br>
            Identificados: ${STATE.risks.length} pontos críticos de memória.
        </div>` + box.innerHTML;
    }

    function exportData() {
        const report = {
            target: STATE.file.name,
            vectors: STATE.results,
            critical_memory_ops: STATE.risks
        };
        
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(report, null, 4));
        const node = document.createElement('a');
        node.setAttribute("href", dataStr);
        node.setAttribute("download", "PS4_ATTACK_VECTORS.json");
        document.body.appendChild(node);
        node.click();
        node.remove();
    }
</script>
</body>
</html>
