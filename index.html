<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit Float64Array Forced Release Test</title>
<style>
body { font-family: monospace; }
iframe { width: 100%; height: 320px; border: 1px solid #000; }
pre { background: #eee; padding: 10px; }
</style>
</head>
<body>

<h2>PARENT LOGGER</h2>
<pre id="parentlog"></pre>

<iframe id="f"></iframe>

<script>
const log = m => parentlog.textContent += m + "\n";
const parentlog = document.getElementById("parentlog");

window.addEventListener("message", e => log("[MSG] " + e.data));

log("[PARENT] Loaded");

document.getElementById("f").srcdoc = `
<!DOCTYPE html>
<html>
<body>
<h3>IFRAME</h3>
<button onclick="start()">START</button>
<pre id="log"></pre>

<script>
let f64;
let buf;

function send(m){ parent.postMessage(m, "*"); }

function dump(tag){
    try {
        send(tag);
        send("  f64.length = " + f64.length);
        send("  f64.byteLength = " + f64.byteLength);
        send("  buffer.byteLength = " + f64.buffer.byteLength);
        send("  f64[0] = " + f64[0]);
    } catch(e){
        send("  EXCEPTION: " + e);
    }
}

function start(){
    send("[START]");

    buf = new ArrayBuffer(0x40);
    f64 = new Float64Array(buf);
    f64[0] = 13.37;

    dump("[BEFORE TRANSFER]");

    /* REAL backing-store release */
    try {
        window.postMessage("neuter", "*", [buf]);
        send("[TRANSFER] ArrayBuffer transferred (neutered)");
    } catch(e){
        send("[TRANSFER ERROR] " + e);
    }

    dump("[AFTER TRANSFER]");

    document.documentElement.webkitRequestFullscreen();

    window.onblur = () => {
        send("[EVENT] blur");

        dump("[AFTER BLUR]");

        send("[TEARDOWN] document.write");

        document.open();
        document.write("<html><body>teardown</body></html>");
        document.close();
    };
}
<\/script>
</body>
</html>
`;
</script>

</body>
</html>
