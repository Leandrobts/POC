<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 Memory Fragmentation</title>
    <style>
        body { background-color: #000; color: #fff; font-family: monospace; padding: 20px; }
        button { 
            background: #fff; color: #000; border: 1px solid #aaa; 
            padding: 20px; width: 100%; margin-bottom: 15px; 
            font-size: 18px; font-weight: bold; cursor: pointer; 
        }
        button:hover { background: #ddd; }
        #log { border: 1px solid #fff; padding: 10px; margin-top: 20px; height: 200px; overflow: auto; }
    </style>
</head>
<body>

    <h1>HEAP FRAGMENTATION SUITE</h1>
    <p>Target: Bypass OOM Killer via Allocator Stress</p>

    <button onclick="runSwissCheese()">TEST 1: Swiss Cheese (Fragmentation)</button>
    <button onclick="runHandleLeak()">TEST 2: Kernel Handle Leak (Blob URLs)</button>
    <button onclick="runIframeStorm()">TEST 3: Iframe Recursion (Process Limit)</button>

    <div id="log">Status: Aguardando...</div>

    <script>
        function log(msg) { 
            document.getElementById('log').innerText = `> ${msg}\n` + document.getElementById('log').innerText;
        }

        // VETOR 1: Fragmentação "Queijo Suíço"
        // Tenta confundir o gerenciador de memória (bmalloc)
        function runSwissCheese() {
            log("Iniciando fragmentação...");
            setTimeout(() => {
                try {
                    const holes = [];
                    const count = 50000;
                    
                    // Fase 1: Alocação Contígua
                    log("Alocando blocos...");
                    for(let i=0; i<count; i++) {
                        // ArrayBuffer de 4KB (tamanho de página comum)
                        holes.push(new ArrayBuffer(4096));
                    }

                    // Fase 2: Criar Buracos (Deletar alternados)
                    log("Criando buracos na memória...");
                    for(let i=0; i<count; i+=2) {
                        holes[i] = null; // Libera memória
                    }

                    // Fase 3: Preencher com tamanho incompatível
                    // Tenta colocar 6KB onde cabiam 4KB
                    log("Forçando realocação incompatível...");
                    const fillers = [];
                    for(let i=0; i<count/2; i++) {
                        fillers.push(new ArrayBuffer(6144)); 
                    }
                    
                    log("Ciclo concluído. Verifique instabilidade.");
                } catch(e) { log("Erro: " + e.message); }
            }, 100);
        }

        // VETOR 2: Esgotamento de Handles (Kernel)
        // A RAM pode estar livre, mas o Kernel tem um limite de "referências"
        function runHandleLeak() {
            log("Iniciando vazamento de Handles (Blob URLs)...");
            let count = 0;
            const content = new Blob(["PS4_KERNEL_STRESS_TEST"], {type: 'text/plain'});
            
            const interval = setInterval(() => {
                try {
                    // Cria URLs mas NUNCA as revoga (revokeObjectURL)
                    // O navegador precisa manter uma tabela de tradução para cada um
                    for(let i=0; i<100; i++) {
                        URL.createObjectURL(content);
                        count++;
                    }
                    if(count % 1000 === 0) log(`Handles criados: ${count}`);
                    
                    if(count > 200000) {
                        clearInterval(interval);
                        log("Limite atingido. O navegador deve começar a falhar agora.");
                    }
                } catch(e) {
                    log("Falha na criação de Handle: " + e.message);
                    clearInterval(interval);
                }
            }, 10);
        }

        // VETOR 3: Iframe Storm
        // Cada Iframe pode exigir um novo contexto de segurança
        function runIframeStorm() {
            log("Iniciando Iframe Storm...");
            document.body.innerHTML = ""; // Limpa a tela
            
            function addFrame() {
                const ifr = document.createElement('iframe');
                // Carrega uma página vazia para ser rápido
                ifr.src = "about:blank"; 
                ifr.style.width = "10px";
                ifr.style.height = "10px";
                document.body.appendChild(ifr);
                
                // Recursão rápida
                setTimeout(addFrame, 5); 
                setTimeout(addFrame, 5); 
            }
            addFrame();
        }

    </script>
</body>
</html>
