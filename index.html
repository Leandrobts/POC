<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 Fullscreen Blur â€“ Iframe Teardown Audit</title>
</head>
<body>

<h1>Parent Logger</h1>
<pre id="log"></pre>
<button onclick="start()">START TEST</button>

<script>
const log = m => {
  document.getElementById("log").textContent += m + "\n";
};

function start() {
  log("[PARENT] Creating iframe");

  const iframe = document.createElement("iframe");
  iframe.style.width = "1px";
  iframe.style.height = "1px";
  iframe.style.border = "0";

  document.body.appendChild(iframe);

  const doc = iframe.contentDocument;
  const win = iframe.contentWindow;

  doc.open();
  doc.write(`
    <!DOCTYPE html>
    <html>
    <body>
    <script>
      let arr = new Float64Array(8);
      for (let i = 0; i < arr.length; i++) arr[i] = 0x1337 + i;

      const el = document.documentElement;
      if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();

      window.onblur = function () {
        // LAST SAFE POINT
        parent.postMessage("IFRAME: onblur reached", "*");

        // trigger teardown
        document.open();
        document.write("<html><body>teardown</body></html>");
        document.close();
      };
    <\/script>
    </body>
    </html>
  `);
  doc.close();
}

window.addEventListener("message", e => {
  log("[MESSAGE] " + e.data);
});
</script>

</body>
</html>
