<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TEST 07 – DOM Node UAF Verification</title>
</head>
<body>

<button onclick="runTest07()">Executar TESTE 07 Refinado</button>
<pre id="log"></pre>

<script>
function log(msg) {
    document.getElementById('log').textContent += msg + "\n";
}

function heapPressure() {
    const trash = [];
    for (let i = 0; i < 2000; i++) {
        trash.push(new ArrayBuffer(4096));
    }
}

function runTest07() {
    log("=== TESTE 07 – DOM UAF (Refinado) ===");

    const container = document.createElement("div");
    document.body.appendChild(container);

    const victim = document.createElement("span");
    victim.textContent = "VICTIM";
    container.appendChild(victim);

    // Garantia de estado inicial
    if (victim.parentNode !== container || !victim.isConnected) {
        log("Estado inicial inválido");
        return;
    }

    // Remoção real do DOM
    container.remove();
    log("Nó removido do DOM");

    // Pressão de heap + yield
    heapPressure();

    queueMicrotask(() => {
        let findings = 0;

        // Verificação 1: parentNode
        if (victim.parentNode !== null) {
            log("[FAIL] parentNode resurrected");
            findings++;
        }

        // Verificação 2: isConnected
        if (victim.isConnected === true) {
            log("[FAIL] isConnected true after removal");
            findings++;
        }

        // Verificação 3: Range API
        try {
            const range = document.createRange();
            range.selectNode(victim);
            log("[FAIL] Range.selectNode succeeded on removed node");
            findings++;
        } catch(e) {
            log("[OK] Range.selectNode threw exception");
        }

        // Verificação 4: NodeIterator
        try {
            const iter = document.createNodeIterator(
                document,
                NodeFilter.SHOW_ELEMENT
            );
            let node;
            while ((node = iter.nextNode())) {
                if (node === victim) {
                    log("[FAIL] NodeIterator reached removed node");
                    findings++;
                    break;
                }
            }
        } catch(e) {}

        // Resultado final
        if (findings > 0) {
            log("=== RESULTADO: CORRUPÇÃO REAL DETECTADA ===");
        } else {
            log("=== RESULTADO: comportamento consistente ===");
        }
    });
}
</script>

</body>
</html>

