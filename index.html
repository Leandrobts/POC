<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>PS4 WebKit – JSON.stringify Replacer Mutation Test</title>

</head>
<body>

<h1>JSON.stringify – Replacer Mutation (Isolated)</h1>
<p>Objetivo: verificar comportamento inconsistente quando o <code>replacer</code> (array) é mutado via <code>Proxy</code> durante a serialização.</p>

<button onclick="runTest()">Executar teste</button>
<div id="log">Aguardando execução…</div>

<script>
  const LOG = document.getElementById('log');
  function log(msg, cls='ok') {
    const d = document.createElement('div');
    d.className = cls;
    d.textContent = `[${new Date().toLocaleTimeString().split(' ')[0]}] ${msg}`;
    LOG.appendChild(d);
    LOG.scrollTop = LOG.scrollHeight;
  }

  function runTest() {
    LOG.textContent = '';
    log('Iniciando JSON.stringify com replacer mutável…');

    const target = { a: 1, b: 2, c: 3 };
    const replacer = [0, 1, 2];

    // Proxy intercepta leitura dos índices do replacer
    const p = new Proxy(replacer, {
      get(t, k) {
        if (k === '1') {
          // Mutação estrutural DURANTE a serialização
          t.length = 0;
        }
        return Reflect.get(t, k);
      }
    });

    try {
      const json = JSON.stringify(target, p);
      log('Resultado JSON: ' + json);

      // Detecção de anomalia semântica (não é OOB / não é info leak)
      if (json.includes('undefined') || json.length < 5) {
        log('Anomalia de comportamento detectada (inconsistência de serialização).', 'bad');
      } else {
        log('Comportamento consistente com a especificação.', 'warn');
      }
    } catch (e) {
      log('Exceção lançada: ' + e.message, 'warn');
    }
  }
</script>

</body>
</html>
