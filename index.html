<!doctype html>
<meta charset="utf-8">
<title>PS4 normalize() ramp test</title>
<pre id="log"></pre>
<button id="go">Run</button>

<script>
const logEl = document.getElementById('log');
function log(s){ logEl.textContent += s + "\n"; }

function now(){ return (performance && performance.now) ? performance.now() : Date.now(); }

document.getElementById('go').onclick = async () => {
  log("UA: " + navigator.userAgent);
  log("Starting ramp...");

  // Caractere que tende a mudar sob NFKC (ex.: diaeresis etc.)
  const expandChar = "\u00A8";
  const fillChar = "a";

  // Ajuste o teto. No PS4, valores grandes demais podem congelar.
  // Comece conservador (ex.: 16MB) e suba se estiver estável.
  const maxBytesApprox = 512 * 1024 * 1024; // 16MB "aprox"
  const stepBytesApprox = 2 * 1024 * 1024; // 2MB

  for (let bytes = stepBytesApprox; bytes <= maxBytesApprox; bytes += stepBytesApprox) {
    try {
      // JS strings são UTF-16 internamente: 2 bytes por code unit (aprox)
      const units = (bytes / 2) | 0;

      const head = expandChar.repeat(32);
      const tail = fillChar.repeat(Math.max(0, units - head.length));
      const s = head + tail;

      const t0 = now();
      const out = s.normalize('NFKC');
      const t1 = now();

      log(`OK bytes≈${bytes} in=${s.length} out=${out.length} dt=${(t1-t0).toFixed(1)}ms`);
      await new Promise(r => setTimeout(r, 50));
    } catch (e) {
      log(`FAIL bytes≈${bytes} err=${e && e.name ? e.name : e} msg=${e && e.message ? e.message : ""}`);
      break;
    }
  }

  log("Done.");
};
</script>
