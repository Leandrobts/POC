<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – Advanced History Engine Tests</title>

</head>
<body>

<h2>PS4 WebKit – History Engine Stress (Step 9)</h2>

<button onclick="tech1()">[1] History Reentrancy</button>
<button onclick="tech2()">[2] BFCache Abuse</button>
<button onclick="tech3()">[3] Fragment + Layout Thrash</button>
<button onclick="tech4()">[4] GC During Navigation</button>
<button onclick="tech5()">[5] Cross-Document History</button>
<button onclick="clearLog()">Clear Log</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m){
  logEl.textContent += `[${new Date().toLocaleTimeString()}] ${m}\n`;
  logEl.scrollTop = logEl.scrollHeight;
}

const BASE = 977;
const STEP = 14461;
let iter = 0;

function nextPayload(){
  const size = BASE + (STEP * iter);
  log(`ITER ${iter} | payload size=${size}`);
  iter++;
  return "A".repeat(size);
}

/* ============================================================
 * TECH 1 — HISTORY REENTRANCY
 * ============================================================ */
function tech1(){
  log("=== TECH 1: History Reentrancy ===");
  iter = 0;

  window.onpopstate = function(){
    log("popstate fired → pushState INSIDE handler");
    try {
      history.pushState({r:true,i:iter},"","#reent"+iter);
    } catch(e){ log("popstate exception: "+e); }
  };

  for(let i=0;i<50;i++){
    const p = nextPayload();
    history.pushState({i},"","#"+p);
    history.replaceState({i},"","#"+p.slice(0, p.length/2));
    if(i % 5 === 0){
      log("calling history.back()");
      setTimeout(()=>history.back(),0);
    }
  }
}

/* ============================================================
 * TECH 2 — BFCACHE ABUSE
 * ============================================================ */
function tech2(){
  log("=== TECH 2: BFCache Abuse ===");
  iter = 0;

  let iframe = document.createElement("iframe");
  iframe.src = "about:blank";
  document.body.appendChild(iframe);

  iframe.onload = function(){
    log("iframe loaded");
    for(let i=0;i<40;i++){
      const p = nextPayload();
      iframe.contentWindow.history.pushState({i},"","#"+p);
    }
    log("navigating back (iframe + top)");
    iframe.contentWindow.history.back();
    setTimeout(()=>history.back(),50);
  };
}

/* ============================================================
 * TECH 3 — FRAGMENT + LAYOUT THRASH
 * ============================================================ */
function tech3(){
  log("=== TECH 3: Fragment + Layout Thrash ===");
  iter = 0;

  for(let i=0;i<50;i++){
    const p = nextPayload();
    history.pushState({i},"","#"+p);
    document.body.getBoundingClientRect();
    window.scrollTo(0, i*10);
    if(i % 6 === 0){
      log("async back during layout");
      setTimeout(()=>history.back(),0);
    }
  }
}

/* ============================================================
 * TECH 4 — GC DURING NAVIGATION
 * ============================================================ */
function tech4(){
  log("=== TECH 4: GC During Navigation ===");
  iter = 0;
  let trash = [];

  for(let i=0;i<50;i++){
    const p = nextPayload();
    history.pushState({i},"","#"+p);

    // force allocation
    for(let j=0;j<200;j++){
      trash.push(new Uint8Array(1024));
    }

    if(i % 5 === 0){
      log("dropping allocations + back()");
      trash = null;
      setTimeout(()=>history.back(),0);
    }
  }
}

/* ============================================================
 * TECH 5 — CROSS-DOCUMENT HISTORY POLLUTION
 * ============================================================ */
function tech5(){
  log("=== TECH 5: Cross-Document History ===");
  iter = 0;

  let iframe = document.createElement("iframe");
  iframe.src = "about:blank";
  document.body.appendChild(iframe);

  iframe.onload = function(){
    for(let i=0;i<50;i++){
      const p = nextPayload();
      history.pushState({top:i},"","#top"+i);
      iframe.contentWindow.history.pushState({sub:i},"","#"+p);

      if(i % 7 === 0){
        log("cross back()");
        setTimeout(()=>{
          iframe.contentWindow.history.back();
          history.back();
        },0);
      }
    }
  };
}

function clearLog(){
  logEl.textContent = "";
}
</script>

</body>
</html>

