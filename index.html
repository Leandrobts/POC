<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit - Popup Fullscreen Tests</title>
</head>
<body>

<h1>PS4 WebKit - Popup + Fullscreen Tests</h1>

<p><strong>Objetivo:</strong> Testar race conditions entre popups JavaScript e Fullscreen API</p>

<h2>Testes Individuais</h2>

<button onclick="test1()">Teste 1: Alert -> Fullscreen Simples</button><br>
<button onclick="test2()">Teste 2: Confirm -> Fullscreen</button><br>
<button onclick="test3()">Teste 3: Prompt -> Fullscreen</button><br>
<button onclick="test4()">Teste 4: Alert Rápido + Fullscreen Imediato</button><br>
<button onclick="test5()">Teste 5: Fullscreen -> Alert Durante Transição</button><br>
<button onclick="test6()">Teste 6: Loop de Alerts + Fullscreen</button><br>
<button onclick="test7()">Teste 7: Fullscreen -> Exit -> Alert -> Fullscreen</button><br>
<button onclick="test8()">Teste 8: Multiple Popups em Sequência</button><br>
<button onclick="test9()">Teste 9: Timeout Alert + Fullscreen Race</button><br>
<button onclick="test10()">Teste 10: Nested Popups + Fullscreen</button><br>

<h2>Execução Automática</h2>
<button onclick="runAllTests()">Executar TODOS os Testes Automaticamente</button>
<button onclick="runAggressiveTest()">Modo Agressivo (Loop Infinito)</button>
<button onclick="stopTests()">Parar Testes</button>

<h2>Log de Execução</h2>
<pre id="log"></pre>

<script>
let running = false;
let testCount = 0;

function log(msg) {
    const logEl = document.getElementById('log');
    const timestamp = new Date().toLocaleTimeString();
    logEl.textContent += `[${timestamp}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
}

function stopTests() {
    running = false;
    log('TESTES INTERROMPIDOS');
}

// ============================================
// TESTE 1: Alert -> Fullscreen Simples
// ============================================
function test1() {
    log('--- TESTE 1: Alert -> Fullscreen Simples ---');
    
    alert('Clique OK para entrar em fullscreen');
    
    try {
        document.documentElement.requestFullscreen();
        log('[OK] Fullscreen ativado');
    } catch(e) {
        log('[ERRO] ' + e.message);
    }
}

// ============================================
// TESTE 2: Confirm -> Fullscreen
// ============================================
function test2() {
    log('--- TESTE 2: Confirm -> Fullscreen ---');
    
    const result = confirm('Deseja entrar em fullscreen?');
    
    if (result) {
        try {
            document.documentElement.requestFullscreen();
            log('[OK] Fullscreen ativado (usuário confirmou)');
        } catch(e) {
            log('[ERRO] ' + e.message);
        }
    } else {
        log('[INFO] Usuário cancelou');
    }
}

// ============================================
// TESTE 3: Prompt -> Fullscreen
// ============================================
function test3() {
    log('--- TESTE 3: Prompt -> Fullscreen ---');
    
    const input = prompt('Digite "fullscreen" para ativar:');
    
    if (input === 'fullscreen') {
        try {
            document.documentElement.requestFullscreen();
            log('[OK] Fullscreen ativado (input correto)');
        } catch(e) {
            log('[ERRO] ' + e.message);
        }
    } else {
        log('[INFO] Input incorreto: ' + input);
    }
}

// ============================================
// TESTE 4: Alert Rápido + Fullscreen Imediato
// ============================================
function test4() {
    log('--- TESTE 4: Alert Rápido + Fullscreen Imediato ---');
    
    // Tentar ativar fullscreen ANTES do alert fechar
    setTimeout(() => {
        try {
            document.documentElement.requestFullscreen();
            log('[TENTATIVA] Fullscreen durante alert aberto');
        } catch(e) {
            log('[ERRO DURANTE ALERT] ' + e.message);
        }
    }, 10);
    
    alert('Alert aberto - fullscreen tentando ativar em background');
    
    log('[OK] Alert fechado');
}

// ============================================
// TESTE 5: Fullscreen -> Alert Durante Transição
// ============================================
function test5() {
    log('--- TESTE 5: Fullscreen -> Alert Durante Transição ---');
    
    try {
        document.documentElement.requestFullscreen();
        log('[OK] Fullscreen solicitado');
        
        // Alert durante animação de fullscreen
        setTimeout(() => {
            alert('Alert durante transição de fullscreen!');
            log('[OK] Alert durante transição fechado');
        }, 100);
        
    } catch(e) {
        log('[ERRO] ' + e.message);
    }
}

// ============================================
// TESTE 6: Loop de Alerts + Fullscreen
// ============================================
function test6() {
    log('--- TESTE 6: Loop de Alerts + Fullscreen ---');
    
    for (let i = 0; i < 3; i++) {
        alert('Alert ' + (i+1) + ' de 3');
        log('[INFO] Alert ' + (i+1) + ' fechado');
    }
    
    try {
        document.documentElement.requestFullscreen();
        log('[OK] Fullscreen após 3 alerts');
    } catch(e) {
        log('[ERRO] ' + e.message);
    }
}

// ============================================
// TESTE 7: Fullscreen -> Exit -> Alert -> Fullscreen
// ============================================
async function test7() {
    log('--- TESTE 7: Fullscreen -> Exit -> Alert -> Fullscreen ---');
    
    try {
        // Entrar em fullscreen
        await document.documentElement.requestFullscreen();
        log('[OK] Fullscreen ativado');
        
        // Aguardar 1 segundo
        await new Promise(r => setTimeout(r, 1000));
        
        // Sair de fullscreen
        await document.exitFullscreen();
        log('[OK] Fullscreen desativado');
        
        // Alert
        alert('Saiu de fullscreen. Entrando novamente...');
        
        // Entrar novamente
        await document.documentElement.requestFullscreen();
        log('[OK] Fullscreen reativado');
        
    } catch(e) {
        log('[ERRO] ' + e.message);
    }
}

// ============================================
// TESTE 8: Multiple Popups em Sequência
// ============================================
function test8() {
    log('--- TESTE 8: Multiple Popups em Sequência ---');
    
    alert('Popup 1: Alert');
    log('[INFO] Alert fechado');
    
    const c = confirm('Popup 2: Confirm?');
    log('[INFO] Confirm: ' + c);
    
    const p = prompt('Popup 3: Prompt');
    log('[INFO] Prompt: ' + p);
    
    try {
        document.documentElement.requestFullscreen();
        log('[OK] Fullscreen após 3 popups diferentes');
    } catch(e) {
        log('[ERRO] ' + e.message);
    }
}

// ============================================
// TESTE 9: Timeout Alert + Fullscreen Race
// ============================================
function test9() {
    log('--- TESTE 9: Timeout Alert + Fullscreen Race ---');
    
    // Agendar alert
    setTimeout(() => {
        alert('Alert atrasado!');
        log('[INFO] Alert atrasado fechado');
    }, 500);
    
    // Tentar fullscreen imediatamente
    try {
        document.documentElement.requestFullscreen();
        log('[OK] Fullscreen antes do alert atrasado');
    } catch(e) {
        log('[ERRO] ' + e.message);
    }
}

// ============================================
// TESTE 10: Nested Popups + Fullscreen
// ============================================
function test10() {
    log('--- TESTE 10: Nested Popups + Fullscreen ---');
    
    const result1 = confirm('Popup 1: Continuar?');
    
    if (result1) {
        const result2 = confirm('Popup 2 (nested): Realmente continuar?');
        
        if (result2) {
            alert('Popup 3 (nested): Entrando em fullscreen!');
            
            try {
                document.documentElement.requestFullscreen();
                log('[OK] Fullscreen após popups aninhados');
            } catch(e) {
                log('[ERRO] ' + e.message);
            }
        }
    }
}

// ============================================
// EXECUTAR TODOS OS TESTES
// ============================================
async function runAllTests() {
    log('=== INICIANDO TODOS OS TESTES ===');
    running = true;
    
    const tests = [test1, test2, test3, test4, test5, test6, test7, test8, test9, test10];
    
    for (let i = 0; i < tests.length; i++) {
        if (!running) {
            log('=== TESTES INTERROMPIDOS ===');
            return;
        }
        
        log(`\nExecutando teste ${i+1}/${tests.length}...`);
        
        try {
            await tests[i]();
        } catch(e) {
            log('[CRASH] ' + e.message);
        }
        
        // Aguardar 2 segundos entre testes
        await new Promise(r => setTimeout(r, 2000));
        
        // Sair de fullscreen se ainda estiver ativo
        try {
            if (document.fullscreenElement) {
                await document.exitFullscreen();
                log('[CLEANUP] Fullscreen desativado');
            }
        } catch(e) {}
    }
    
    log('\n=== TODOS OS TESTES CONCLUÍDOS ===');
    running = false;
}

// ============================================
// MODO AGRESSIVO
// ============================================
async function runAggressiveTest() {
    if (!confirm('AVISO: Modo agressivo pode travar o navegador!\n\nContinuar?')) {
        return;
    }
    
    log('=== MODO AGRESSIVO ATIVADO ===');
    running = true;
    testCount = 0;
    
    while (running) {
        testCount++;
        log(`\n[ITERAÇÃO ${testCount}]`);
        
        try {
            // Sequência rápida: Alert -> Fullscreen -> Exit
            alert('Iteração ' + testCount);
            
            await document.documentElement.requestFullscreen();
            log('[OK] Fullscreen ativado');
            
            await new Promise(r => setTimeout(r, 100));
            
            await document.exitFullscreen();
            log('[OK] Fullscreen desativado');
            
        } catch(e) {
            log('[CRASH] ' + e.message);
            
            // Se crashou, salvar informação
            localStorage.setItem('ps4_popup_crash', JSON.stringify({
                iteration: testCount,
                error: e.message,
                timestamp: new Date().toISOString()
            }));
        }
        
        // Pequeno delay para não sobrecarregar
        await new Promise(r => setTimeout(r, 200));
    }
    
    log('=== MODO AGRESSIVO PARADO ===');
}

// ============================================
// INIT
// ============================================
log('PS4 WebKit - Popup + Fullscreen Tests carregado');
log('Clique em um teste individual ou execute todos automaticamente');
log('');
log('IMPORTANTE: Pressione ESC para sair do fullscreen a qualquer momento');
log('');

// Detectar suporte a fullscreen
if (!document.documentElement.requestFullscreen) {
    log('[AVISO] Fullscreen API não disponível neste navegador!');
} else {
    log('[OK] Fullscreen API detectada');
}

// Carregar crash anterior se existir
const previousCrash = localStorage.getItem('ps4_popup_crash');
if (previousCrash) {
    log('[AVISO] Crash anterior detectado:');
    log(previousCrash);
}
</script>

</body>
</html>
