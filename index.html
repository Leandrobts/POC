<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 Investigation: Heap Shift Test</title>
<style>
    body { background: #000; color: #0f0; font-family: monospace; text-align: center; padding: 20px; }
    button { padding: 15px; font-size: 1.2em; cursor: pointer; background: #333; color: #fff; border: 1px solid #0f0; }
    .stat { margin: 10px; padding: 10px; border: 1px solid #444; }
</style>
</head>
<body>

<h1>INVESTIGAÇÃO DE MEMÓRIA</h1>
<p>Objetivo: Provar dependência de memória (Memory Dependency).</p>

<div class="stat" id="status">Aguardando comando...</div>

<button onclick="runTest(0)">1. Teste SEM Shift (Padrão)</button><br><br>
<button onclick="runTest(100)">2. Shift LEVE (100MB)</button><br><br>
<button onclick="runTest(500)">3. Shift PESADO (500MB)</button><br><br>

<div id="log"></div>

<script>
    const Status = document.getElementById('status');
    let shift_storage = [];

    // Função para encher a memória com Strings (Padding inerte)
    // Strings são boas porque não contêm ponteiros perigosos, apenas texto.
    function shiftHeap(mb) {
        Status.innerText = "Alocando " + mb + "MB de padding...";
        shift_storage = []; // Limpa anterior
        
        // Uma string de aprox 1MB
        const bigStr = new Array(1024 * 1024).join("A");
        
        try {
            for(let i=0; i < mb; i++) {
                shift_storage.push(bigStr + i); // +i para evitar deduplicação do motor JS
            }
            Status.innerText = "Heap Deslocado (" + mb + "MB). Pressione OPTIONS agora.";
        } catch(e) {
            Status.innerText = "Memória cheia antes de terminar! Tente um valor menor.";
        }
    }

    function runTest(mode) {
        // 1. Shift da Memória
        if (mode > 0) {
            // Dá um tempo para a UI atualizar antes de travar no loop
            setTimeout(() => shiftHeap(mode), 100);
        } else {
            Status.innerText = "Modo Padrão. Pressione OPTIONS agora.";
        }

        // 2. O Gatilho (Trigger)
        const doc = document.documentElement;
        if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
        else if (doc.requestFullscreen) doc.requestFullscreen();

        window.onblur = function() {
            console.log("Blur!");
            document.body.style.background = "#500";
            
            // Aqui NÃO fazemos spray de objetos perigosos.
            // Apenas observamos se o "Shift" mudou o resultado do Refresh.
            Status.innerText = ">>> CLIQUE EM ATUALIZAR AGORA <<<";
        };
    }
</script>
</body>
</html>
