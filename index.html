<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 Thread Recycler Test</title>
    <style>
        body { background-color: #111; color: #fff; font-family: monospace; padding: 20px; text-align: center; }
        #counter { font-size: 100px; font-weight: bold; color: #0f0; margin: 20px 0; }
        #status { font-size: 24px; color: #ff0; }
        button { font-size: 24px; padding: 15px; width: 100%; cursor: pointer; margin-top: 20px; }
        .danger { background-color: #500; color: #fff; }
    </style>
</head>
<body>

    <h1>Teste de Reciclagem de Threads</h1>
    <p>Objetivo: Encher até 400 -> Matar 100 -> Criar mais 100.</p>
    
    <div id="status">Parado.</div>
    <div id="counter">0</div>
    
    <button onclick="runRecycleTest()">INICIAR TESTE</button>

    <script>
        // Armazena referências para podermos matar as threads
        let workers = []; 
        const LIMIT_SAFE = 400; // Chegamos perto do crash (418) mas paramos antes
        const KILL_COUNT = 100; // Quantas vamos matar para liberar espaço

        const workerCode = `
            function deep(n) {
                const v = new Float64Array(128);
                if (n > 0) deep(n-1);
            }
            deep(10); 
            postMessage("Alive"); 
        `;
        const url = URL.createObjectURL(new Blob([workerCode], {type:"text/javascript"}));

        function updateDisplay() {
            document.getElementById('counter').innerText = workers.length;
        }

        function setStatus(msg) {
            document.getElementById('status').innerText = msg;
        }

        function runRecycleTest() {
            setStatus("FASE 1: Enchendo até " + LIMIT_SAFE + "...");
            
            let fillInterval = setInterval(() => {
                // Cria thread e guarda no array
                let w = new Worker(url);
                w.onmessage = () => {}; // Mantém viva
                workers.push(w);
                updateDisplay();

                if (workers.length >= LIMIT_SAFE) {
                    clearInterval(fillInterval);
                    startPurgePhase();
                }
            }, 20); // Rápido
        }

        function startPurgePhase() {
            setStatus("FASE 2: PAUSA... Preparando para matar " + KILL_COUNT + " threads.");
            document.body.style.backgroundColor = "#003366"; // Azul

            setTimeout(() => {
                setStatus("FASE 2: MATANDO THREADS ANTIGAS...");
                
                // Mata as primeiras 100 threads do array
                for (let i = 0; i < KILL_COUNT; i++) {
                    if(workers[i]) {
                        workers[i].terminate(); // Mata explicitamente
                    }
                }
                
                // Remove do array (logicamente)
                workers.splice(0, KILL_COUNT);
                updateDisplay();

                setStatus("Aguardando Garbage Collector (2s)...");
                
                // Espera 2 segundos para o Kernel ter chance de limpar
                setTimeout(startRefillPhase, 2000);
            }, 1000);
        }

        function startRefillPhase() {
            setStatus("FASE 3: RECRIANDO... (Se travar aqui, é EXPLOIT!)");
            document.body.style.backgroundColor = "#660000"; // Vermelho

            let refillCount = 0;
            let refillInterval = setInterval(() => {
                let w = new Worker(url);
                w.onmessage = () => {};
                workers.push(w);
                updateDisplay();
                refillCount++;

                // Tenta voltar ao limite original
                if (refillCount >= KILL_COUNT + 20) { // Tenta passar um pouco do que liberou
                    clearInterval(refillInterval);
                    setStatus("SUCESSO: O sistema reciclou as threads corretamente.");
                    document.body.style.backgroundColor = "#006600"; // Verde
                    alert("Teste passou sem crash. É apenas um limite de recursos.");
                }
            }, 50); // Cria devagar
        }
    </script>
</body>
</html>
