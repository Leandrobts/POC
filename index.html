<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 Font Parser Fuzzer</title>
    <style>
        body { background-color: #000; color: #ff0; font-family: monospace; padding: 20px; }
        button { 
            background: #222; color: #ff0; border: 2px solid #ff0; 
            padding: 20px; width: 100%; margin-bottom: 20px; 
            font-size: 20px; font-weight: bold; cursor: pointer;
        }
        button:hover { background: #444; }
        #log { border: 1px solid #555; padding: 10px; height: 300px; overflow-y: scroll; white-space: pre-wrap; }
        #test-area { font-size: 40px; margin-top: 20px; opacity: 0; }
    </style>
</head>
<body>

    <h1>FREETYPE PARSER ATTACK</h1>
    <p>Target: Corrupting TTF/WOFF Tables in Memory</p>

    <button onclick="startFontFuzzing()">INICIAR FUZZING DE FONTES</button>
    
    <div id="log">Status: Pronto para injetar fontes maliciosas...</div>
    <div id="test-area">TEXTO DE TESTE</div>

    <script>
        function log(msg) { 
            const l = document.getElementById('log');
            l.innerText = `> ${msg}\n` + l.innerText;
        }

        // Uma fonte WOFF mínima válida (Base64) para usar de base
        const baseFont = "d09GRgABAAAAAAQwAA4AAAAAA9gAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABPUy8yAAABRAAAAEQAAABWNsEyg2NtYXAAAAGMAAAAOAAAAFgCqwGjY3Z0IAAAAcQAAAAIAAAACAAAAABmcGdtAAABzAAAAAMAAAADADIH02dseWYAAAHQAAAAJAAAACQ0j4A0aGVhZAAAAdwAAAAuAAAANgl2oIdoaGVhAAAB/AAAABUAAAAkCAEEAmhtdHgAAAIMAAAABwAAAAcACAAAbG9jYQAAAhQAAAAEAAAABAAGAABtYXhwAAACGAAAACAAAAAgAAwAHW5hbWUAAAI4AAAAOQAAAE55qGsucG9zdAAAAowAAAATAAAAIP+fADR4nGNgZGBg4GLQY7BhYYrIzPMJ4jM0MvCxMDGwM3GwMzEwMDExgMAJAQ4GhgQYwAAAFgACeJxjYGRgYOAAohmgkImBgYFhBZA+A8QCUOQOAAiYAFQAAAB4nGNgZGBg4ANiCQYQYGJgBMIGIGYB8xgABPwAPgAAAHicY2BkYGDgAWIxIGYC8xgXBvIYgGgAFA4AbgAAAHicY2BmAAI=...";
        
        // Converte Base64 para Uint8Array (Bytes)
        function base64ToBytes(base64) {
            const bin = atob(base64);
            const bytes = new Uint8Array(bin.length);
            for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
            return bytes;
        }

        // O Corruptor: Altera bytes aleatórios no buffer
        function corruptData(data) {
            // Clona o array para não estragar o original
            const corrupted = new Uint8Array(data);
            
            // Determina agressividade (quantos bytes quebrar)
            // 5 a 15 alterações por arquivo
            const mutations = Math.floor(Math.random() * 10) + 5;
            
            for (let i = 0; i < mutations; i++) {
                // Escolhe uma posição aleatória (evitando os primeiros 12 bytes do header WOFF para não invalidar de cara)
                const offset = Math.floor(Math.random() * (corrupted.length - 20)) + 20;
                
                // Mutações possíveis:
                // 1. Inverter bits (XOR)
                // 2. Colocar valores extremos (0x00, 0xFF)
                // 3. Colocar valores problemáticos (0x7F, 0x80)
                const mode = Math.random();
                if (mode < 0.33) corrupted[offset] ^= 0xFF; 
                else if (mode < 0.66) corrupted[offset] = 0x00;
                else corrupted[offset] = 0xFF;
            }
            return corrupted;
        }

        async function startFontFuzzing() {
            log("Decodificando fonte base...");
            const originalBytes = base64ToBytes(base64FontClean); // Usa a string definida abaixo
            
            let count = 0;
            const maxAttempts = 1000; // Tenta 1000 variações
            
            log("Iniciando loop de corrupção...");

            const interval = setInterval(async () => {
                count++;
                if (count > maxAttempts) {
                    clearInterval(interval);
                    log("Fuzzing concluído sem crash.");
                    return;
                }

                try {
                    // 1. Gera bytes corrompidos
                    const badBytes = corruptData(originalBytes);
                    
                    // 2. Cria uma fonte a partir do Blob
                    // O parser do browser começa a ler aqui
                    const fontName = "HackFont" + count;
                    const fontFace = new FontFace(fontName, badBytes);
                    
                    // 3. Força o carregamento (Parsing)
                    // É AQUI QUE O CRASH ACONTECE
                    await fontFace.load();
                    
                    // 4. Se carregou (o que é raro para fonte corrompida), aplica no DOM
                    // para forçar o renderizador de glifos
                    document.fonts.add(fontFace);
                    const el = document.getElementById('test-area');
                    el.style.fontFamily = fontName;
                    el.innerText = "TESTE " + count; // Força layout

                    // Limpeza (para não estourar a RAM antes de crashar o parser)
                    document.fonts.delete(fontFace);
                    
                    if (count % 50 === 0) log(`Tentativas: ${count} (Sistema estável...)`);

                } catch (e) {
                    // Erros de "network" ou "parsing" são normais aqui, pois a fonte é inválida.
                    // Estamos procurando o erro que o Try-Catch NÃO pega (o Crash).
                }
            }, 50); // Velocidade de injeção
        }

        // Fonte Base Real (Roboto Thin Miniatura - Válida)
        // Precisamos de algo real para o parser tentar ler as tabelas antes de falhar
        const base64FontClean = "d09GRgABAAAAAAQwAA4AAAAAA9gAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABPUy8yAAABRAAAAEQAAABWNsEyg2NtYXAAAAGMAAAAOAAAAFgCqwGjY3Z0IAAAAcQAAAAIAAAACAAAAABmcGdtAAABzAAAAAMAAAADADIH02dseWYAAAHQAAAAJAAAACQ0j4A0aGVhZAAAAdwAAAAuAAAANgl2oIdoaGVhAAAB/AAAABUAAAAkCAEEAmhtdHgAAAIMAAAABwAAAAcACAAAbG9jYQAAAhQAAAAEAAAABAAGAABtYXhwAAACGAAAACAAAAAgAAwAHW5hbWUAAAI4AAAAOQAAAE55qGsucG9zdAAAAowAAAATAAAAIP+fADR4nGNgZGBg4GLQY7BhYYrIzPMJ4jM0MvCxMDGwM3GwMzEwMDExgMAJAQ4GhgQYwAAAFgACeJxjYGRgYOAAohmgkImBgYFhBZA+A8QCUOQOAAiYAFQAAAB4nGNgZGBg4ANiCQYQYGJgBMIGIGYB8xgABPwAPgAAAHicY2BkYGDgAWIxIGYC8xgXBvIYgGgAFA4AbgAAAHicY2BmAAI=";

    </script>
</body>
</html>
