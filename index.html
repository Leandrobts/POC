<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit UAF Sanity Check</title>
<style>
body { font-family: monospace; background:#111; color:#0f0; }
button { font-size:18px; padding:10px; margin:10px 0; }
#log { white-space: pre-wrap; }
</style>
</head>
<body>

<h2>PS4 WebKit – UAF Absolute Sanity Check</h2>

<button onclick="start()">INICIAR SANITY CHECK</button>

<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(msg) {
    logEl.textContent += msg + "\n";
    console.log(msg);
}

/* ===============================
   GLOBAL STATE
================================*/
let heartbeat = 0;
let heartbeatTimer = null;

let victim = null;
let victimRef = null;
let invariantBefore = {};
let invariantAfter = {};

let blurTime = 0;
let postBlurChecks = 0;

/* ===============================
   HEARTBEAT (SC-1)
================================*/
function startHeartbeat() {
    heartbeatTimer = setInterval(() => {
        heartbeat++;
    }, 100);
}

/* ===============================
   INVARIANT SNAPSHOT
================================*/
function snapshot(obj) {
    return {
        isArray: Array.isArray(obj),
        type: typeof obj,
        tag: Object.prototype.toString.call(obj),
        length: obj.length,
        proto: Object.getPrototypeOf(obj)
    };
}

/* ===============================
   START
================================*/
function start() {
    log("=== SANITY CHECK INICIADO ===");

    // SC-1: Liveness baseline
    startHeartbeat();

    // Criamos um objeto simples (NÃO explorável)
    victim = new Float64Array(16);
    for (let i = 0; i < victim.length; i++) victim[i] = i + 0.5;

    victimRef = victim;

    invariantBefore = snapshot(victim);

    log("[PRE] Invariantes capturadas");
    log(JSON.stringify(invariantBefore, null, 2));

    // Fullscreen (necessário para OPTIONS no PS4)
    const doc = document.documentElement;
    if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
    else if (doc.requestFullscreen) doc.requestFullscreen();

    log(">>> Aperte OPTIONS agora <<<");

    window.onblur = onBlurHandler;
}

/* ===============================
   BLUR HANDLER
================================*/
function onBlurHandler() {
    blurTime = performance.now();
    log("=== BLUR DETECTADO ===");

    // NÃO liberamos nada ainda (SC-2 control)
    log("[BLUR] Nenhum free executado");

    // Pós-blur checks (SC-3)
    postBlurCheck();
}

/* ===============================
   POST-BLUR CHECK LOOP
================================*/
function postBlurCheck() {
    setTimeout(() => {
        postBlurChecks++;

        // SC-1: heartbeat continua?
        log(`[CHECK ${postBlurChecks}] Heartbeat=${heartbeat}`);

        // SC-4: invariantes
        try {
            invariantAfter = snapshot(victimRef);
            log(`[CHECK ${postBlurChecks}] Invariantes atuais:`);
            log(JSON.stringify(invariantAfter, null, 2));
        } catch (e) {
            log(`[CHECK ${postBlurChecks}] EXCEPTION ao acessar vítima: ${e}`);
        }

        // SC-3: executa várias vezes ANTES de refresh
        if (postBlurChecks < 5) {
            postBlurCheck();
        } else {
            finalize();
        }

    }, 0);
}

/* ===============================
   FINAL ANALYSIS
================================*/
function finalize() {
    log("=== FINALIZANDO SANITY CHECK ===");

    // SC-1
    if (heartbeat > 0) {
        log("[SC-1] JS continua vivo após blur ✅");
    } else {
        log("[SC-1] JS NÃO está vivo ❌ (contexto suspenso)");
    }

    // SC-4: invariantes
    const invariantChanged =
        invariantBefore.isArray !== invariantAfter.isArray ||
        invariantBefore.tag !== invariantAfter.tag ||
        invariantBefore.length !== invariantAfter.length ||
        invariantBefore.proto !== invariantAfter.proto;

    if (invariantChanged) {
        log("[SC-4] Invariantes mudaram ANTES do refresh ⚠️");
    } else {
        log("[SC-4] Invariantes intactos (comportamento normal)");
    }

    log("=== INTERPRETAÇÃO ===");

    if (!invariantChanged) {
        log("✔ Nenhuma evidência de UAF vivo.");
        log("✔ Qualquer crash posterior indica TEARDOWN / SHUTDOWN BUG.");
    } else {
        log("⚠ POSSÍVEL bug lógico.");
        log("⚠ Necessário confirmar SEM refresh.");
    }

    log("=== NÃO ATUALIZE AINDA ===");
    log("Se só crashar AO ATUALIZAR → NÃO é UAF vivo.");
}
</script>

</body>
</html>

