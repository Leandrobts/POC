
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit Advanced Bug Surface Tests</title>
<style>
body { font-family: monospace; background:#000; color:#0f0; }
button { margin:4px; padding:6px; }
#log { margin-top:10px; white-space:pre-wrap; }
</style>
</head>
<body>

<h2>PS4 WebKit – Advanced Bug Surface Tests (A–F)</h2>
<p>Objetivo: crash real / freeze / abort (não DoS lógico)</p>

<button onclick="testA()">TEST A – History Navigation Pressure</button>
<button onclick="testB()">TEST B – Iframe Detach + document.write</button>
<button onclick="testC()">TEST C – SVG Layout After Removal</button>
<button onclick="testD()">TEST D – Canvas Resize + ImageData</button>
<button onclick="testE()">TEST E – Worker Structured Clone Stress</button>
<button onclick="testF()">TEST F – Fullscreen + Resize + History</button>

<div id="log"></div>

<script>
function log(m){ logEl.textContent += m + "\n"; }
const logEl = document.getElementById("log");

/* ============================================================
   TEST A — History Navigation Pressure
   ============================================================ */
function testA(){
    log("[A] History Navigation Pressure");
    let size = 100000;
    try {
        for(let i=0;i<50;i++){
            const payload = "A".repeat(size);
            history.pushState({}, "", "#"+payload);
            history.replaceState({}, "", "#"+payload.slice(0, payload.length/2));
            if(i % 5 === 0) history.back();
            size += 25000;
        }
        log("[A] Completed without crash (try increasing iterations)");
    } catch(e){
        log("[A] Exception: "+e);
    }
}

/* ============================================================
   TEST B — Iframe Detach + document.write
   ============================================================ */
function testB(){
    log("[B] Iframe Detach + document.write");
    try {
        const iframe = document.createElement("iframe");
        document.body.appendChild(iframe);

        const doc = iframe.contentDocument;
        doc.open();
        doc.write("<h1>TEST</h1>");
        doc.close();

        document.body.removeChild(iframe);

        for(let i=0;i<50;i++){
            doc.open();
            doc.write("X".repeat(50000));
            doc.close();
        }
        log("[B] document.write on detached document executed");
    } catch(e){
        log("[B] Exception: "+e);
    }
}

/* ============================================================
   TEST C — SVG Layout After Removal
   ============================================================ */
function testC(){
    log("[C] SVG Layout After Removal");
    try {
        const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
        svg.setAttribute("width","800");
        svg.setAttribute("height","600");

        const rect = document.createElementNS(svg.namespaceURI,"rect");
        rect.setAttribute("width","400");
        rect.setAttribute("height","300");
        svg.appendChild(rect);
        document.body.appendChild(svg);

        document.body.removeChild(svg);

        for(let i=0;i<200;i++){
            rect.getBBox();
            rect.getCTM();
        }
        log("[C] SVG layout methods executed after removal");
    } catch(e){
        log("[C] Exception: "+e);
    }
}

/* ============================================================
   TEST D — Canvas Resize + ImageData
   ============================================================ */
function testD(){
    log("[D] Canvas Resize + ImageData");
    try {
        const canvas = document.createElement("canvas");
        canvas.width = 1024;
        canvas.height = 1024;
        const ctx = canvas.getContext("2d");
        document.body.appendChild(canvas);

        const img = ctx.getImageData(0,0,1024,1024);

        for(let i=0;i<50;i++){
            canvas.width = 512;
            canvas.height = 512;
            canvas.width = 1024;
            canvas.height = 1024;
            ctx.putImageData(img,0,0);
        }
        log("[D] ImageData reused after multiple resizes");
    } catch(e){
        log("[D] Exception: "+e);
    }
}

/* ============================================================
   TEST E — Worker Structured Clone Stress
   ============================================================ */
function testE(){
    log("[E] Worker Structured Clone Stress");
    const code = `
        onmessage = function(e){
            let arr = [];
            for(let i=0;i<200;i++){
                arr.push(new ArrayBuffer(1024*1024));
            }
            postMessage(arr);
        };
    `;
    try {
        const w = new Worker(URL.createObjectURL(new Blob([code])));
        w.onmessage = ()=>{};
        for(let i=0;i<20;i++){
            w.postMessage({});
        }
        setTimeout(()=>w.terminate(),200);
        log("[E] Worker clone storm executed");
    } catch(e){
        log("[E] Exception: "+e);
    }
}

/* ============================================================
   TEST F — Fullscreen + Resize + History
   ============================================================ */
function testF(){
    log("[F] Fullscreen + Resize + History");
    try {
        document.documentElement.requestFullscreen();

        let size = 50000;
        for(let i=0;i<20;i++){
            history.pushState({}, "", "#"+("F".repeat(size)));
            document.body.style.width = (300+i*10)+"px";
            document.body.style.height = (300+i*10)+"px";
            size += 20000;
        }

        document.exitFullscreen();
        log("[F] Fullscreen transitions completed");
    } catch(e){
        log("[F] Exception: "+e);
    }
}

log("Loaded. Execute ONE test at a time.");
</script>
</body>
</html>
