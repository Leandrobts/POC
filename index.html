<!DOCTYPE html>
<html>
<head>
    <title>PS4 Fuzzer (REFINAMENTO)</title>
    <style>
        body { background-color: #000; color: #00ffcc; font-family: monospace; padding: 20px; font-size: 24px; }
        .box { border: 2px solid #005544; padding: 20px; margin-bottom: 20px; }
        button { font-size: 24px; padding: 15px; cursor: pointer; background: #111; color: #fff; width: 100%; border: 1px solid #00ffcc; }
        .danger { color: #ff3333; font-weight: bold; font-size: 32px; }
        .highlight { color: yellow; }
    </style>
</head>
<body>

    <h3>PS4 Fuzzer - Fase de Refinamento</h3>
    <p>Buscando offset exato entre 650k e 705k...</p>

    <div class="box">
        <div>Testando agora: <span id="current-display" class="highlight">---</span></div>
        <div id="log">Pronto para iniciar.</div>
    </div>

    <div class="box" style="border-color: #ff3333;">
        <strong>ALVO LOCALIZADO (CRASH):</strong><br>
        <span id="last-attempt" class="danger">Nenhum</span>
    </div>

    <button onclick="startFuzz()">INICIAR REFINAMENTO</button>
    <button onclick="resetData()">RESETAR</button>

    <script>
        // --- CONFIGURAÇÕES DE PRECISÃO ---
        
        // Começa um pouco antes da zona de perigo (650KB)
        const START_SIZE = 650000; 
        
        // Avança de 128 em 128 bytes para achar o ponto exato
        const STEP_SIZE = 128; 
        
        const DELAY_MS = 800; 
        const ORIGINAL_URL = window.location.href.split('?')[0].split('#')[0];

        // Elementos
        const logEl = document.getElementById('log');
        const currDisplay = document.getElementById('current-display');
        const lastEl = document.getElementById('last-attempt');

        // Dados
        let currentSize = parseInt(localStorage.getItem('fuzz_refine_size')) || START_SIZE;
        let lastCrash = localStorage.getItem('fuzz_refine_crash');
        let isRunning = localStorage.getItem('fuzz_refine_active') === 'true';

        if (lastCrash) {
            lastEl.innerText = lastCrash + " bytes";
            lastEl.innerHTML += "<br><small>(Valor exato do último crash)</small>";
        }

        currDisplay.innerText = currentSize + " bytes";

        if (isRunning) {
            runTest();
        }

        function startFuzz() {
            localStorage.setItem('fuzz_refine_active', 'true');
            window.location.href = ORIGINAL_URL;
        }

        function resetData() {
            localStorage.removeItem('fuzz_refine_size');
            localStorage.removeItem('fuzz_refine_crash');
            localStorage.removeItem('fuzz_refine_active');
            location.reload();
        }

        function runTest() {
            // Salva o suspeito ATUAL
            localStorage.setItem('fuzz_refine_crash', currentSize);
            
            // Prepara o PRÓXIMO
            localStorage.setItem('fuzz_refine_size', currentSize + STEP_SIZE);

            logEl.innerText = "Injetando " + currentSize + "...";

            window.fuzzTimer = setTimeout(() => {
                try {
                    const payload = "/" + "A".repeat(currentSize);

                    history.pushState({}, "crash", payload);
                    
                    // Se não travou:
                    history.replaceState({}, "clean", "clean"); 
                    window.location.href = ORIGINAL_URL;

                } catch (e) {
                    console.log(e);
                    window.location.href = ORIGINAL_URL;
                }
            }, DELAY_MS);
        }
    </script>
</body>
</html>
