<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PS4 12.00 MEMORY X-RAY</title>
    
</head>
<body>

    <h1>MEMORY X-RAY (Timing Analysis)</h1>
    <h3>Analisando comportamento do Free/Alloc no Worker 404</h3>
    
    <button onclick="startXray()">INICIAR RAIO-X</button>
    
    <div id="chart"></div>
    <div id="log">Logs...</div>

    <script>
        function log(msg) {
            var d = document.getElementById("log");
            d.innerHTML += `<div>${msg}</div>`;
            d.scrollTop = d.scrollHeight;
        }

        // Função de medição de alta precisão
        function timeAlloc(size) {
            var t0 = performance.now();
            var arr = new ArrayBuffer(size);
            var t1 = performance.now();
            return { time: t1 - t0, obj: arr };
        }

        var workers = [];
        var probes = [];

        async function startXray() {
            document.getElementById("chart").innerHTML = "";
            log("1. Grooming (380)...");
            
            // Enche a base
            for(let i=0; i<380; i++) {
                try { workers.push(new SharedWorker("data:text,1", "g"+i)); } catch(e){}
            }

            // Chega perto do limite
            log("2. Aproximando do 404...");
            var p_count = 0;
            
            var it = setInterval(() => {
                if (p_count >= 24) { // 380 + 24 = 404
                    clearInterval(it);
                    performAnalysis();
                    return;
                }
                try {
                    let w = new SharedWorker("data:text,1", "v"+p_count);
                    w.port.start();
                    workers.push(w);
                } catch(e){}
                p_count++;
            }, 50);
        }

        function performAnalysis() {
            log("!!! ANALISANDO O MOMENTO DA MORTE (404) !!!");
            
            // Pega a vítima
            var victim = workers.pop();
            
            // T0: Antes do Free
            var t_pre = performance.now();
            
            // AÇÃO: FECHAR A PORTA (O suposto Free)
            victim.port.close();
            
            // T1: Depois do Free
            var t_post = performance.now();
            log(`Tempo para .close(): ${(t_post - t_pre).toFixed(4)}ms`);

            // AGORA: Tentar alocar 500 objetos de tamanhos variados e medir o tempo
            // Se houver um buraco, uma dessas alocações será anormalmente rápida ou lenta.
            
            log("Escaneando Heap com micro-alocações...");
            
            var results = [];
            // Testa tamanhos ao redor de 0xA0 (160)
            var target_sizes = [0x80, 0x90, 0xA0, 0xB0, 0xC0, 0x100, 0x140];
            
            // Fazemos 100 rodadas de alocação rápida
            for(let i=0; i<100; i++) {
                for(let s of target_sizes) {
                    let res = timeAlloc(s);
                    results.push({ id: i, size: s, time: res.time });
                    probes.push(res.obj); // Mantém vivo
                }
            }

            // Desenhar Gráfico
            drawChart(results);
            analyzeResults(results);
        }

        function drawChart(data) {
            var chart = document.getElementById("chart");
            var maxTime = 0;
            data.forEach(d => { if(d.time > maxTime) maxTime = d.time; });

            data.forEach(d => {
                var bar = document.createElement("div");
                bar.className = "bar";
                // Altura baseada no tempo (normalizado)
                var h = (d.time / maxTime) * 100;
                if(h < 5) h = 5; // Mínimo visível
                bar.style.height = h + "%";
                
                // Cor baseada no tamanho
                if (d.size === 0xA0) bar.style.backgroundColor = "red"; // Nosso alvo
                else if (d.size === 0xC0) bar.style.backgroundColor = "yellow";
                
                bar.title = `Size: 0x${d.size.toString(16)}, Time: ${d.time.toFixed(3)}ms`;
                chart.appendChild(bar);
            });
        }

        function analyzeResults(data) {
            // Procura anomalias (Spikes de tempo)
            // Um tempo muito alto significa que o OS teve que trabalhar duro (Talvez GC ou Page Fault)
            // Um tempo muito baixo logo depois significa que ele achou um buraco pronto.
            
            log("--- RESULTADOS ---");
            
            // Média
            var sum = 0;
            data.forEach(d => sum += d.time);
            var avg = sum / data.length;
            log(`Tempo médio de alocação: ${avg.toFixed(4)}ms`);

            // Acha picos
            var spikes = data.filter(d => d.time > avg * 5); // 5x mais lento que a média
            if (spikes.length > 0) {
                log(`DETECTADOS ${spikes.length} PICOS DE LATÊNCIA!`);
                spikes.forEach(s => {
                    log(`-> Pico no tamanho 0x${s.size.toString(16)}: ${s.time.toFixed(3)}ms`);
                });
                log("DICA: O tamanho onde ocorre o pico (ou logo após ele) é o tamanho real do buraco.");
            } else {
                log("Nenhuma anomalia temporal detectada. O Free pode ter sido adiado (Lazy GC).");
            }
        }
    </script>
</body>
</html>
