<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 WebKit Backing Store Canvas Test</title>
<style>
body { font-family: monospace; }
iframe { width: 100%; height: 320px; border: 1px solid #000; }
button { margin: 4px; }
</style>
</head>
<body>

<h2>PARENT LOGGER</h2>
<pre id="log"></pre>

<button onclick="runTest()">START CANVAS / IMAGEDATA TEST</button>

<div id="holder"></div>

<script>
var logEl = document.getElementById("log");
function log(m){ logEl.textContent += m + "\n"; }
log("[PARENT] Loaded");

function runTest() {
  log("\n=== START CANVAS TEST ===");

  var holder = document.getElementById("holder");
  holder.innerHTML = "";

  var iframe = document.createElement("iframe");
  holder.appendChild(iframe);

  var win = iframe.contentWindow;
  var doc = win.document;

  doc.open();
  doc.write(
    '<!DOCTYPE html><html><body>' +
    '<button id="start">RUN TEST</button>' +
    '<canvas id="cv" width="16" height="16"></canvas>' +

    '<script>' +
    'var send = function(m){ parent.postMessage("[MSG] "+m,"*"); };' +
    'var f64, u8, img, ctx;' +

    'document.getElementById("start").onclick = function(){' +

      'send("[ALLOC] Float64Array length=8");' +
      'f64 = new Float64Array(8);' +
      'f64[0] = 13.37;' +

      'send("[BACKING] buffer.byteLength=" + f64.buffer.byteLength);' +

      'send("[ALIAS] Uint8ClampedArray over same buffer");' +
      'u8 = new Uint8ClampedArray(f64.buffer);' +

      'send("[IMAGEDATA] creating ImageData from same buffer");' +
      'img = new ImageData(u8, 4, 4);' +

      'ctx = document.getElementById("cv").getContext("2d");' +
      'ctx.putImageData(img, 0, 0);' +
      'send("[CANVAS] putImageData done");' +

      'send("[SNAPSHOT] before fullscreen");' +
      'send(" f64.length=" + f64.length);' +
      'send(" f64[0]=" + f64[0]);' +

      'document.documentElement.webkitRequestFullscreen();' +
      'send("[STATE] fullscreen requested");' +
    '};' +

    'window.onblur = function(){' +
      'send("[EVENT] blur detected");' +
      'try{' +
        'send("[SNAPSHOT] after blur");' +
        'send(" f64.length=" + f64.length);' +
        'send(" f64[0]=" + f64[0]);' +
        'send(" buffer.byteLength=" + f64.buffer.byteLength);' +
      '}catch(e){ send("[ERROR] access failed"); }' +

      'send("[TEARDOWN] document.write iframe");' +
      'document.open(); document.write("<h1>teardown</h1>"); document.close();' +
    '};' +

    '<\/script>' +
    '</body></html>'
  );
  doc.close();
}

window.addEventListener("message", function(e){
  log(e.data);
});
</script>

</body>
</html>
